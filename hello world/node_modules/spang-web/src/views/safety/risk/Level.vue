<template>
  <page-container :title="false">
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{height: `calc(100vh - 156px)`}"
      class="table-card"
    >
      <a-button @click="addRow(record)" v-if="false">新建</a-button>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :showPagination="false"
      >
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="editRow(record)" v-if="permission.risk_level_edit">修改</a>

          </template>
        </span>
      </s-table>
      <common-form-modal
        ref="modal"
        :modal-title="title"
        :visible.sync="visible"
        :disabled="modalDisabled"
        :model="modalData"
        :rule="rules"
        @ok="submitFormData"
      />
    </a-card>
  </page-container>
</template>
<script>
  import { STable } from '@/components'
  import { riskLevelColumns } from '@/views/safety/table'
  import { mapGetters } from 'vuex'
  import ApiURLs from '@/api/urls'
  import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
  import { getDict } from '@/api/system'

  function formRegistry (dictKey, optionKey) {
    // eslint-disable-next-line no-undef
    formCreate.register({
      name: optionKey + 'Options',
      init ({ val }, rule) {
        getDict(dictKey).then(({ data, success }) => {
          if (success) {
            rule.options = data.map(row => {
              return {
                label: row.dictValue,
                value: row.id,
                dictKey: row.dictKey
              }
            })
          }
        })
      }
    })
  }

  formRegistry('RISK_LEVEL', 'riskLevel')
  formRegistry('RISK_COLOUR', 'riskColour')
  formRegistry('RISK_CONTROL', 'riskControl')
  export default {
    components: {
      STable,
      CommonFormModal
    },
    data () {
      return {
        loadData: parameter => {
          return this.getList(ApiURLs.levelList).then(res => {
            return {
              data: res.data
            }
          })
        },
        // modal
        visible: false,
        title: '',
        modalData: {},
        modalDisabled: false,
        rules: [
          {
            'type': 'select',
            'field': 'riskLevelId',
            'title': '风险级别',
            'props': {
              'noDataText': '风险级别'
            },
            'options': [],
            effect: {
              riskLevelOptions: ''
            },
            'validate': [
              {
                'trigger': 'blur',
                'mode': 'required',
                'message': '请选择风险级别',
                'required': true,
                'type': 'string'
              }
            ],
            on: {
              change: (id) => {
                const options = this.$refs.modal.fApi.getRule('riskLevelId').options
                const option = options.find(item => item.value === id)
                this.$set(this.modalData, 'riskLevelName',option.label)
                this.$set(this.modalData, 'riskLevelValue', option.dictKey)
              }
            }
          },
          {
            'type': 'select',
            'field': 'riskColourId',
            'title': '风险颜色',
            'props': {
              'noDataText': '风险颜色'
            },
            'options': [],
            effect: {
              riskColourOptions: ''
            },
            'validate': [
              {
                'trigger': 'blur',
                'mode': 'required',
                'message': '请选择风险颜色',
                'required': true,
                'type': 'string'
              }
            ],
            on: {
              change: (id) => {
                const options = this.$refs.modal.fApi.getRule('riskColourId').options
                this.$set(this.modalData, 'riskColourName', options.find(item => item.value === id).label)
              }
            }
          },
          {
            'type': 'select',
            'field': 'riskControlId',
            'title': '管控层级',
            'props': {
              'noDataText': '管控层级'
            },
            'options': [],
            effect: {
              riskControlOptions: ''
            },
            'validate': [
              {
                'trigger': 'blur',
                'mode': 'required',
                'message': '请选择管控层级',
                'required': true,
                'type': 'string'
              }
            ],
            on: {
              change: (id) => {
                const options = this.$refs.modal.fApi.getRule('riskControlId').options
                const option = options.find(item => item.value === id)
                this.$set(this.modalData, 'riskControlName', option.label)
                this.$set(this.modalData, 'riskControlValue', option.dictKey)
              }
            }
          }
        ]
      }
    },
    computed: {
      ...mapGetters(['permission']),
      columns: () => riskLevelColumns
    },
    methods: {
      initFormData () {
        this.modalData = {
          riskColourId: undefined,
          riskColourName: undefined,
          riskControlId: undefined,
          riskControlName: undefined,
          riskControlValue: undefined,
          riskLevelId: undefined,
          riskLevelName: undefined,
          riskLevelValue: undefined
        }
      },
      modalInit () {
        this.visible = false
        this.modalDisabled = false
        this.initFormData()
      },
      editRow (record) {
        this.title = '修改数据'
        this.modalData = { ...record }
        this.visible = true
      },
      addRow () {
        this.commonTitle = '新增数据'
        this.initFormData()
        this.visible = true
        this.commonDisabled = false
      },
      submitFormData ({ formData }) {
        const params = {
          ...formData,
          riskLevelName: this.modalData.riskLevelName,
          riskControlName: this.modalData.riskControlName,
          riskColourName: this.modalData.riskColourName,
          riskControlValue: this.modalData.riskControlValue,
          riskLevelValue: this.modalData.riskLevelValue,
          id: this.modalData.id
        }
        this.submitForm(ApiURLs.level, params, params.id ? 'put' : 'post').then(res => {
          if (res.success) {
            this.$message.success(`${res.msg}`)
            this.modalInit()
            this.$refs.table.refresh()
            this.$refs.table.clearSelected()
          }
        }).catch((err) => {
          this.$message.error(`${err.response.data.msg}`)
        })
      }
    }
  }
</script>
<style lang="less" scoped>
  /deep/ .ant-table {
    height: calc(100vh - 290px) !important;
  }
</style>
