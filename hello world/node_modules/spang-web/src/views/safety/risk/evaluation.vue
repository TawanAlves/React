<template>
  <page-container :title="false">
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ height: `calc(100vh - 156px)` }"
      class="table-card"
    >
      <div class="evaluation">
        <a-button-group disabled>
          <!-- <a-button>LS评价法设置</a-button>
          <a-button>XXX评价法设置</a-button> -->
          <div class="evaluation-title">LS评价法设置</div>
        </a-button-group>

        <a-collapse v-model="activeKey" accordion>
          <a-collapse-panel key="1" header="事故发生的可能性（L）判定准则">
            <a-button slot="extra" type="primary" size="small" icon="plus" @click="addAccident(1)">添加</a-button>
            <a-modal
              :title="title"
              :visible="accident1"
              :confirm-loading="confirmLoading"
              :maskClosable="false"
              width="900px"
              @ok="handleOk(1)"
              @cancel="handleCancel(1)"
              :keyboard="false"
            >
              <a-form-model
                ref="ruleForm1"
                :model="form1"
                :rules="rules1"
                :label-col="labelCol"
                :wrapper-col="wrapperCol"
              >
                <a-form-model-item ref="scores" label="分数" prop="scores">
                  <a-select v-model="form1.scores" placeholder="请选择分数" @change="scoresChange">
                    <a-select-option v-for="item in riskScoers" :key="item.dictKey">{{
                      item.dictValue
                    }}</a-select-option
                    >>
                  </a-select>
                </a-form-model-item>
                <a-form-model-item ref="securityCheck" label="安全检查" prop="securityCheck">
                  <a-input
                    v-model="form1.securityCheck"
                    @blur="
                      () => {
                        $refs.securityCheck.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item ref="happenFrequency" label="事件发生频率" prop="happenFrequency">
                  <a-input
                    v-model="form1.happenFrequency"
                    @blur="
                      () => {
                        $refs.happenFrequency.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item label="操作规程" prop="workRule">
                  <a-input v-model="form1.workRule" type="textarea" :max-length="256" />
                </a-form-model-item>
                <a-form-model-item label="员工胜任程度" prop="employeeCompetency">
                  <a-input v-model="form1.employeeCompetency" type="textarea" :max-length="256" />
                </a-form-model-item>
                <a-form-model-item label="防范、控制措施" prop="controlMeasures">
                  <a-input v-model="form1.controlMeasures" type="textarea" :max-length="256" />
                </a-form-model-item>
              </a-form-model>
            </a-modal>
            <s-table
              ref="table1"
              size="default"
              :rowKey="(record) => record.id"
              :columns="columns1"
              :data="loadData1"
              :alert="false"
              :showPagination="'false'"
              :pagination="false"
            >
              <span slot="action" slot-scope="text, record">
                <template>
                  <a @click="editRow1(record)">编辑</a>
                  <a-divider type="vertical" />
                  <a @click="removeRow1(record)">删除</a>
                </template>
              </span>
            </s-table>
          </a-collapse-panel>
          <a-collapse-panel key="2" header="事故后果严重性（S）判定准则">
            <a-button slot="extra" type="primary" size="small" icon="plus" @click="addAccident(2)">添加</a-button>
            <a-modal
              :title="title"
              :visible="accident2"
              :confirm-loading="confirmLoading"
              :maskClosable="false"
              width="900px"
              @ok="handleOk(2)"
              @cancel="handleCancel(2)"
              :keyboard="false"
            >
              <a-form-model
                ref="ruleForm2"
                :model="form2"
                :rules="rules2"
                :label-col="labelCol"
                :wrapper-col="wrapperCol"
              >
                <a-form-model-item ref="scores" label="分数" prop="scores">
                  <a-select v-model="form2.scores" placeholder="请选择分数" @change="handleSelectChange">
                    <a-select-option v-for="item in riskScoers" :key="item.dictKey">{{
                      item.dictValue
                    }}</a-select-option
                    >>
                  </a-select>
                </a-form-model-item>
                <a-form-model-item ref="casualties" label="人员伤亡程度" prop="casualties">
                  <a-input
                    v-model="form2.casualties"
                    @blur="
                      () => {
                        $refs.casualties.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item label="直接财产损失" prop="propertyLoss">
                  <a-input v-model="form2.propertyLoss" type="textarea" :max-length="256" />
                </a-form-model-item>
                <a-form-model-item label="停工时间" prop="downtime">
                  <a-input v-model="form2.downtime" type="textarea" :max-length="256" />
                </a-form-model-item>
                <a-form-model-item label="对声誉的影响" prop="reputationImpact">
                  <a-input v-model="form2.reputationImpact" type="textarea" :max-length="256" />
                </a-form-model-item>
              </a-form-model>
            </a-modal>
            <s-table
              ref="table2"
              size="default"
              :rowKey="(record) => record.id"
              :columns="columns2"
              :data="loadData2"
              :alert="false"
              showPagination="false"
            >
              <span slot="action" slot-scope="text, record">
                <template>
                  <a @click="editRow2(record)">编辑</a>
                  <a-divider type="vertical" />
                  <a @click="removeRow2(record)">删除</a>
                </template>
              </span>
            </s-table>
          </a-collapse-panel>
          <a-collapse-panel key="3" header="安全风险等级判定准则（R）控制措施">
            <a-button slot="extra" type="primary" size="small" icon="plus" @click="addAccident(3)">添加</a-button>
            <a-modal
              :title="title"
              :visible="accident3"
              :confirm-loading="confirmLoading"
              :maskClosable="false"
              width="900px"
              @ok="handleOk(3)"
              @cancel="handleCancel(3)"
              :keyboard="false"
            >
              <a-form-model
                ref="ruleForm3"
                :model="form3"
                :rules="rules3"
                :label-col="labelCol"
                :wrapper-col="wrapperCol"
              >
                <a-form-model-item ref="judgeMin" label="最小风险值" prop="judgeMin">
                  <a-input
                    v-model="form3.judgeMin"
                    @blur="
                      () => {
                        $refs.judgeMin.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item ref="judgeMax" label="最大风险值" prop="judgeMax">
                  <a-input
                    v-model="form3.judgeMax"
                    @blur="
                      () => {
                        $refs.judgeMax.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item ref="riskLevelId" label="风险等级" prop="riskLevelId">
                  <a-select v-model="form3.riskLevelId" placeholder="请选择风险等级" @change="handleSelectChange">
                    <a-select-option v-for="item in riskLevel" :key="item.id">{{ item.dictValue }}</a-select-option
                    >>
                  </a-select>
                </a-form-model-item>
                <a-form-model-item ref="controlMeasures" label="应采取的行动/控制措施" prop="controlMeasures">
                  <a-input
                    v-model="form3.controlMeasures"
                    @blur="
                      () => {
                        $refs.controlMeasures.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item ref="timeLimit" label="实施期限" prop="timeLimit">
                  <a-input
                    v-model="form3.timeLimit"
                    @blur="
                      () => {
                        $refs.timeLimit.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
              </a-form-model>
            </a-modal>
            <s-table
              ref="table3"
              size="default"
              :rowKey="(record) => record.id"
              :columns="columns3"
              :data="loadData3"
              :alert="false"
              showPagination="false"
            >
              <span slot="action" slot-scope="text, record">
                <template>
                  <a @click="editRow3(record)">编辑</a>
                  <a-divider type="vertical" />
                  <a @click="removeRow3(record)">删除</a>
                </template>
              </span>
            </s-table>
          </a-collapse-panel>
          <a-collapse-panel key="4" header="风险级别设置">
            <a-modal
              :title="title"
              :visible="accident4"
              :confirm-loading="confirmLoading"
              :maskClosable="false"
              width="900px"
              @ok="handleOk(4)"
              @cancel="handleCancel(4)"
              :keyboard="false"
            >
              <a-form-model
                ref="ruleForm4"
                :model="form4"
                :rules="rules4"
                :label-col="labelCol"
                :wrapper-col="wrapperCol"
              >
                <a-form-model-item ref="riskBgScore" label="最小风险值" prop="riskBgScore">
                  <a-input
                    v-model="form4.riskBgScore"
                    @blur="
                      () => {
                        $refs.riskBgScore.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
                <a-form-model-item ref="riskEndScore" label="最大风险值" prop="riskEndScore">
                  <a-input
                    v-model="form4.riskEndScore"
                    @blur="
                      () => {
                        $refs.riskEndScore.onFieldBlur()
                      }
                    "
                  />
                </a-form-model-item>
              </a-form-model>
            </a-modal>
            <s-table
              ref="table4"
              size="default"
              :rowKey="(record) => record.id"
              :columns="columns4"
              :data="loadData4"
              :alert="false"
              showPagination="false"
            >
              <span slot="action" slot-scope="text, record">
                <template>
                  <a @click="editRow4(record)">编辑</a>
                </template>
              </span>
            </s-table>
          </a-collapse-panel>
        </a-collapse>
      </div>
    </a-card>
  </page-container>
</template>
<script>
import { mapGetters } from 'vuex'
import { STable } from '@/components'
import {
  riskEvaluationColumns1,
  riskEvaluationColumns2,
  riskEvaluationColumns3,
  riskEvaluationColumns4,
} from '@/views/safety/table'
import ApiURLs from '@/api/urls'
import {
  submitEvaluationList1,
  removeEvaluationList1,
  submitEvaluationList2,
  removeEvaluationList2,
  submitEvaluationList3,
  removeEvaluationList3,
  submitEvaluationList4,
} from '@/api/safety'
import { getDict, getUserAuth } from '@/api/system'

function formRegistry(dictKey, optionKey) {
  // eslint-disable-next-line no-undef
  formCreate.register({
    name: optionKey + 'Options',
    init({ val }, rule) {
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          rule.options = data.map((row) => {
            return {
              label: row.name,
              value: row.id,
            }
          })
        }
      })
    },
  })
}

formRegistry('RISK_LEVEL', 'riskLevel')
formRegistry('RISK_COLOUR', 'riskColour')
formRegistry('RISK_CONTROL', 'riskControl')
export default {
  components: {
    STable,
  },
  data() {
    let checkJudgeMin = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请填写最小风险值'))
      } else if (/^[1-9]\d*|0$/.test(value)) {
        callback()
      } else {
        callback(new Error('请输入非负整数'))
      }
    }
    let checkJudgeMax = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请填写最大风险值'))
      } else if (/^[1-9]\d*|0$/.test(value)) {
        callback()
      } else {
        callback(new Error('请输入非负整数'))
      }
    }
    let checkRiskBgScore = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请填写最小风险值'))
      } else if (/^[1-9]\d*|0$/.test(value)) {
        callback()
      } else {
        callback(new Error('请输入非负整数'))
      }
    }
    let checRriskEndScore = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请填写最大风险值'))
      } else if (/^[1-9]\d*|0$/.test(value)) {
        callback()
      } else {
        callback(new Error('请输入非负整数'))
      }
    }
    this.columns1 = riskEvaluationColumns1
    this.columns2 = riskEvaluationColumns2
    this.columns3 = riskEvaluationColumns3
    this.columns4 = riskEvaluationColumns4

    return {
      loadData1: (parameter) => {
        return this.getList(ApiURLs.evaluationList1).then((res) => {
          return {
            data: res.data,
          }
        })
      },
      loadData2: (parameter) => {
        return this.getList(ApiURLs.evaluationList2).then((res) => {
          return {
            data: res.data,
          }
        })
      },
      loadData3: (parameter) => {
        return this.getList(ApiURLs.evaluationList3).then((res) => {
          return {
            data: res.data,
          }
        })
      },
      loadData4: (parameter) => {
        return this.getList(ApiURLs.evaluationList4).then((res) => {
          return {
            data: res.data,
          }
        })
      },
      labelCol: { span: 8 },
      wrapperCol: { span: 14 },
      activeKey: ['1'],
      accident1: false,
      accident2: false,
      accident3: false,
      accident4: false,
      riskScoers: [],
      riskLevel: [],
      title: '新增数据',
      confirmLoading: false,
      commonData1: '',
      commonData2: '',
      commonData3: '',
      commonData4: '',
      form1: {
        scores: undefined,
        securityCheck: '',
        happenFrequency:'',
        workRule: '',
        employeeCompetency: '',
        controlMeasures: '',
      },
      form2: {
        scores: undefined,
        casualties: '',
        propertyLoss: '',
        downtime: '',
        reputationImpact: '',
      },
      form3: {
        judgeMin: '',
        judgeMax: '',
        riskLevelId: undefined,
        riskLevelName: undefined,
        controlMeasures: '',
        timeLimit: '',
      },
      form4: {
        riskBgScore: '',
        riskEndScore: '',
      },
      rules1: {
        scores: [{ required: true, message: '请选择分数', trigger: 'blur' }],
        securityCheck: [{ max: 32, message: '最多32个汉字', trigger: 'blur' }],
        happenFrequency: [{ max: 32, message: '最多32个汉字', trigger: 'blur' }],
        workRule: [{ max: 256, message: '最多256个汉字', trigger: 'blur' }],
        employeeCompetency: [{ max: 256, message: '最多256个汉字', trigger: 'blur' }],
        controlMeasures: [{ max: 256, message: '最多256个汉字', trigger: 'blur' }],
      },
      rules2: {
        scores: [{ required: true, message: '请选择分数', trigger: 'blur' }],
        casualties: [{ max: 32, message: '最多32个汉字', trigger: 'blur' }],
        propertyLoss: [{ max: 256, message: '最多256个汉字', trigger: 'blur' }],
        downtime: [{ max: 256, message: '最多256个汉字', trigger: 'blur' }],
        reputationImpact: [{ max: 256, message: '最多256个汉字', trigger: 'blur' }],
      },
      rules3: {
        riskLevelId: [{ required: true, message: '请选择风险等级', trigger: 'blur' }],
        controlMeasures: [{ max: 32, message: '最多32个汉字', trigger: 'blur' }],
        timeLimit: [{ max: 32, message: '最多32个汉字', trigger: 'blur' }],
        judgeMin: [{ required: true, validator: checkJudgeMin, trigger: 'blur' }],
        judgeMax: [{ required: true, validator: checkJudgeMax, trigger: 'blur' }],
      },
      rules4: {
        riskBgScore: [{ required: true, validator: checkRiskBgScore, trigger: 'blur' }],
        riskEndScore: [{ required: true, validator: checRriskEndScore, trigger: 'blur' }],
      },
    }
  },
  watch: {
    activeKey(key) {},
    accident1(val, newVal) {
      if (val) {
        try {
          this.$refs['ruleForm1'].resetFields()
        } catch (e) {}
      }
    },
    accident2(val, newVal) {
      if (val) {
        try {
          this.$refs['ruleForm2'].resetFields()
        } catch (e) {}
      }
    },
    accident3(val, newVal) {
      if (val) {
        try {
          this.$refs['ruleForm3'].resetFields()
        } catch (e) {}
      }
    },
    accident4(val, newVal) {
      if (val) {
        try {
          this.$refs['ruleForm4'].resetFields()
        } catch (e) {}
      }
    },
  },
  computed: {},
  methods: {
    //点击添加
    addAccident(data) {
      event.stopPropagation()
      this.title = '新增数据'
      this.confirmLoading = false
      if (data === 1) {
        this.accident1 = true
      } else if (data === 2) {
        this.accident2 = true
      } else if (data === 3) {
        this.accident3 = true
      }
    },
    //点击确定
    handleOk(data) {
      // this.confirmLoading = true
      let method = ''
      if (data === 1) {
        if (this.isNotNullOrUndefined(this.commonData1.id)) {
          method = 'put'
        } else {
          method = 'post'
        }
        this.$refs.ruleForm1.validate((valid) => {
          if (valid) {
            let formData1 = this.form1
            const params = {
              ...formData1,
            }
            submitEvaluationList1(params, method, {}).then((res) => {
              if (res.data.isSumbit === false) {
                this.$message.error(res.msg)
                this.confirmLoading = false
              } else {
                this.$message.success(`操作成功`)
                this.accident1 = false
                this.confirmLoading = false
                this.form1 = {}
                this.$refs.table1.refresh()
              }
            })
          } else {
            return false
          }
        })
      } else if (data === 2) {
        if (this.isNotNullOrUndefined(this.commonData2.id)) {
          method = 'put'
        } else {
          method = 'post'
        }
        this.$refs.ruleForm2.validate((valid) => {
          if (valid) {
            let formData2 = this.form2
            const params = {
              ...formData2,
            }
            submitEvaluationList2(params, method, {}).then((res) => {
              if (res.data.isSumbit === false) {
                this.$message.error(res.msg)
                this.confirmLoading = false
              } else {
                this.$message.success(`操作成功`)
                this.accident2 = false
                this.confirmLoading = false
                this.form2 = {}
                this.$refs.table2.refresh()
              }
            })
          } else {
            return false
          }
        })
      } else if (data === 3) {
        if (this.isNotNullOrUndefined(this.commonData3.id)) {
          method = 'put'
        } else {
          method = 'post'
        }
        this.$refs.ruleForm3.validate((valid) => {
          if (valid) {
            this.riskLevel.forEach((item) => {
              if (this.form3.riskLevelId === item.id) {
                this.form3.riskLevelName = item.dictValue
              }
            })
            let formData3 = this.form3
            const params = {
              ...formData3,
            }
            submitEvaluationList3(params, method, {}).then((res) => {
              if (res.data.isSumbit === false) {
                this.$message.error(res.msg)
                this.confirmLoading = false
              } else {
                this.$message.success(`操作成功`)
                this.accident3 = false
                this.confirmLoading = false
                this.form3 = {}
                this.$refs.table3.refresh()
              }
            })
          } else {
            return false
          }
        })
      } else if (data === 4) {
        method = 'put'
        this.$refs.ruleForm4.validate((valid) => {
          if (valid) {
            let formData4 = this.form4
            const params = {
              ...formData4,
            }
            submitEvaluationList4(params, method, {}).then((res) => {
              if (res.data.isSumbit === false) {
                this.$message.error(res.msg)
                this.confirmLoading = false
              } else {
                this.$message.success(`操作成功`)
                this.accident4 = false
                this.confirmLoading = false
                this.form4 = {}
                this.$refs.table4.refresh()
              }
            })
          } else {
            return false
          }
        })
      }
    },
    //点击取消
    handleCancel(data) {
      if (data === 1) {
        this.accident1 = false
        this.form1 = {
          scores: undefined,
          securityCheck: '',
          workRule: '',
          employeeCompetency: '',
          controlMeasures: '',
        }
      } else if (data === 2) {
        this.accident2 = false
        this.form2 = {
          scores: undefined,
          casualties: '',
          propertyLoss: '',
          downtime: '',
          reputationImpact: '',
        }
      } else if (data === 3) {
        this.accident3 = false
        this.form3 = {
          judgeMin: '',
          judgeMax: '',
          riskLevelId: undefined,
          riskLevelName: undefined,
          controlMeasures: '',
          timeLimit: '',
        }
      } else if (data === 4) {
        this.accident4 = false
        this.form4 = {
          riskBgScore: '',
          riskEndScore: '',
        }
      }
    },
    //点击编辑
    editRow1(data) {
      this.getById(ApiURLs.evaluation1, data.id).then(({ data, success }) => {
        if (success) {
          this.form1 = data
        }
      })
      this.commonData1 = { ...data }
      this.title = '编辑数据'
      this.accident1 = true
      this.confirmLoading = false
    },
    editRow2(data) {
      this.getById(ApiURLs.evaluation2, data.id).then(({ data, success }) => {
        if (success) {
          this.form2 = data
        }
      })
      this.commonData2 = { ...data }
      this.title = '编辑数据'
      this.accident2 = true
      this.confirmLoading = false
    },
    editRow3(data) {
      this.getById(ApiURLs.evaluation3, data.id).then(({ data, success }) => {
        if (success) {
          this.form3 = data
        }
      })
      this.commonData3 = { ...data }
      this.title = '编辑数据'
      this.accident3 = true
      this.confirmLoading = false
    },
    editRow4(data) {
      this.getById(ApiURLs.evaluation4, data.id).then(({ data, success }) => {
        if (success) {
          this.form4 = data
        }
      })
      this.commonData4 = { ...data }
      this.title = '编辑数据'
      this.accident4 = true
      this.confirmLoading = false
    },
    //分数改变
    scoresChange(data) {
      this.form1.scores = data
    },
    //点击删除
    removeRow1(data) {
      this.showDeleteConfirm({ id: [data.id], type: 1 })
    },
    removeRow2(data) {
      this.showDeleteConfirm({ id: [data.id], type: 2 })
    },
    removeRow3(data) {
      this.showDeleteConfirm({ id: [data.id], type: 3 })
    },
    showDeleteConfirm(data) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          if (data.type === 1) {
            removeEvaluationList1(data.id).then((res) => {
              if (res.code === 200) {
                _this.$message.success('删除成功')
                _this.$refs.table1.refresh()
              } else {
                _this.$message.error('删除失败')
              }
            })
          }
          if (data.type === 2) {
            removeEvaluationList2(data.id).then((res) => {
              if (res.code === 200) {
                _this.$message.success('删除成功')
                _this.$refs.table2.refresh()
              } else {
                _this.$message.error('删除失败')
              }
            })
          }
          if (data.type === 3) {
            removeEvaluationList3(data.id).then((res) => {
              if (res.code === 200) {
                _this.$message.success('删除成功')
                _this.$refs.table3.refresh()
              } else {
                _this.$message.error('删除失败')
              }
            })
          }
        },
        onCancel() {
          console.log('Cancel')
        },
      })
    },
  },
  created() {
    //分数
    getDict('RISK_SCORES').then(({ data }) => {
      this.riskScoers = data
    })
    //风险等级
    getDict('RISK_RANK').then(({ data }) => {
      this.riskLevel = data
    })
  },
  mounted() {},
}
</script>
<style lang="less" scoped>
.evaluation {
  width: 80%;
  margin: 0 auto;
  .evaluation-title {
    border: 1px solid transparent;
    background-color: #fff;
    border-color: #d9d9d9;
    color: rgba(0, 0, 0, 0.65);
    height: 32px;
    line-height: 32px;
    padding: 0 15px;
    cursor: default;
  }
  .ant-btn-group {
    display: flex;
    flex-direction: row;
    justify-content: end;
  }
  /deep/.ant-pagination,
  /deep/.ant-table-pagination {
    display: none !important;
  }
  .ant-collapse {
    margin-top: 20px;
  }
  /deep/ .ant-table {
    height: auto !important;
  }
}
</style>
