<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="活动类型">
                <a-select v-model="queryParam.activityTypeId" placeholder="活动类型">
                  <a-select-option v-for="val in riskTypeOptions " :key="val.id">
                    {{ val.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="风险级别">
                <a-select v-model="queryParam.riskLevelId" placeholder="风险级别">
                  <a-select-option v-for="val in riskLevelOptions" :key="val.riskLevelId">
                    {{ val.riskLevelName }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="区域/位置">
                <a-input v-model="queryParam.areaLocation" placeholder="区域/位置"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="equipmentResearch">查询</a-button>
                <a-button type="second" @click="equipmentRefresh">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card table-card-wrapper"
    >
      <template #title>
        <div class="text-right">
          <a-space>
            <a-button type="primary" icon="plus" @click="equipmentAdd" v-if="permission.risk_activity_add">
              新建
            </a-button>
            <a-button icon="delete" :disabled="!hasSelected" @click="equipmentRemove" v-if="permission.risk_activity_delete">删除</a-button>
            <a-button :disabled="!hasSelected" @click="approveTask">审核</a-button>
          </a-space>

        </div>
      </template>
      <s-table
        ref="equipmentTable"
        size="default"
        :scroll="{y: `calc(100vh - 435px)`, x: 1470}"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="rowSelection"
        showPagination="false"
        :pagination="pagination"
      >
        <span slot="serial" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <span slot="status" slot-scope="text, record">
          <a-tag v-if="record.status === 0" color="orange">未提交</a-tag>
          <a-tag v-if="record.status === 1" color="green">已提交</a-tag>
          <a-tag v-if="record.status === 2" color="blue">已审批</a-tag>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
             <a @click="equipmentCheck(record)" v-if=" record.status !== 0">查看</a>
            <a-divider type="vertical" v-if="((record.status === 1 && userInfo.id === record.gmtCreateId) || (record.status !== 0 && permission.risk_activity_recall))"/>
            <a @click="submitRecord(record, 0)" v-if="((record.status === 1 && userInfo.id === record.gmtCreateId) || (record.status !== 0 && permission.risk_activity_recall))">撤回</a>
            <a @click="equipmentEdit(record)" v-if="record.status === 0 && (permission.risk_activity_edit || userInfo.id === record.gmtCreateId)">编辑</a>
            <a-divider type="vertical" v-if="record.status === 0 && (permission.risk_activity_submit || userInfo.id === record.gmtCreateId)"/>
            <a @click="submitRecord(record, 1)" v-if="record.status === 0 && (userInfo.id === record.gmtCreateId || permission.risk_activity_submit)">提交</a>
            <a-divider type="vertical" v-if="record.status === 0 && (userInfo.id === record.gmtCreateId || permission.risk_activity_delete)"/>
            <a @click="removeRecord(record)" v-if="record.status === 0 && (userInfo.id === record.gmtCreateId || permission.risk_activity_delete)">删除</a>
          </template>
        </span>
      </s-table>
      <risk-modal
        ref="modal"
        :modal-title="title"
        :visible.sync="visible"
        :disabled="modalDisabled"
        :activityTypeOptions="riskTypeOptions"
        :model="modalData"
        @cancel="equipmentCancel"
        @ok="equipmentOk"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { activityRiskColumns } from './columns'
import URLS from '@/api/risk-urls'
import AreaUrl from '@/api/urls'
import RiskModal from '@/views/safety/risk/component/ActivityRiskModal'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'
export default {
  components: {
    STable,
    RiskModal
  },
  data () {
    return {
      pagination: {
        pageSize: 10,
        current: 1,
        showSizeChanger: true
      },
      userInfo: getStore({ name: 'info' }),
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(URLS.activityList, requestParameters).then(res => {
          this.pagination = { ...this.pagination, pageSize: res.data.size, current: res.data.current }
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      riskTypeOptions: [],
      riskLevelOptions: [],
      // modal
      title: '',
      visible: false,
      modalData: {},
      modalDisabled: false
    }
  },
  created () {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => activityRiskColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectOptionsInit () {
      this.getList(AreaUrl.levelList).then(({ data, success }) => {
        if (success) {
          this.riskLevelOptions = data
        }
      })
      this.getDict('RISK_ACTIVITY').then(({ data, success }) => {
        if (success) {
          this.riskTypeOptions = data
        }
      })
    },
    modalInit () {
      this.visible = false
      this.modalData = {}
      this.modalDisabled = false
      // const form = this.$refs.modal.$refs.ruleForm
      // form.resetFields()
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    equipmentResearch () {
      this.$refs.equipmentTable.refresh(true)
      this.$refs.equipmentTable.clearSelected()
    },
    equipmentRefresh () {
      this.queryParam = {}
      this.$refs.equipmentTable.refresh(true)
      this.$refs.equipmentTable.clearSelected()
    },
    equipmentAdd () {
      this.visible = true
      this.title = '新增数据'
      this.modalData = {}
      this.modalDisabled = false
    },
    equipmentRemove () {
      const ids = this.selectedRows.map(item => {
        return item.id
      })
      this.removeConfirm(ids)
    },
    removeConfirm (ids) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将要删除选中数据，是否确认',
        okText: '确认',
        okType: 'danger',
        cancelText: '取消',
        onOk () {
          _this.deleteByIds(URLS.activity, ids).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${ res.msg }`)
              _this.modalInit()
              _this.$refs.equipmentTable.refresh(true)
              _this.$refs.equipmentTable.clearSelected()
            } else {
              _this.$message.error(`${ res.msg }`)
            }
          })
        }
      })
    },
    equipmentCheck (record) {
      this.title = '查看数据'
      this.loadRowData(record.id, () => {
        this.visible = true
        this.modalDisabled = true
      })
    },
    equipmentEdit (record) {
      this.title = '编辑数据'
      this.loadRowData(record.id, () => {
        this.visible = true
        this.modalDisabled = false
      })
    },
    loadRowData (id, callback) {
      this.getById(URLS.activity, id).then(({ data, success }) => {
        if (success) {
          if (data.approveId === -1) {
            data.approveId = undefined
          }
          if (!data.chargerIds) {
            data.chargerIds = undefined
          } else {
            data.chargerIds = data.chargerIds.split(',')
            data.chargerNames = data.chargerNames.split(',')
          }
          this.modalData = data
          callback()
        }
      })
    },
    equipmentCancel () {
      this.modalInit()
    },
    equipmentOk ({ formData }) {
       let method = ''
        if (this.isNotNullOrUndefined(this.modalData.id)) {
          method = 'put'
          formData.id = this.modalData.id
        } else {
          method = 'post'
          formData.status = 0
        }
        this.submitForm(URLS.activity, formData, method, {
          // headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
          this.$refs.equipmentTable.refresh()
          this.$refs.equipmentTable.clearSelected()
          this.modalInit()
        })
    },
    submitRecord (record, status) {
      if (!record.approveId || record.approveId === -1) {
        this.$message.error('提交时审批人不能为空')
      } else if (!record.chargerIds || record.chargerIds === -1) {
        this.$message.error('责任单位及责任人不能为空')
      } else if (!record.riskLevelId || record.riskLevelId === -1) {
        this.$message.error('风险级别、风险管控措施不能为空')
      } else {
        this.updateStatus([record.id], status)
      }
    },
    removeRecord (record) {
      this.removeConfirm([record.id])
    },
    approveTask () {
      const submitList = this.selectedRows.filter(item => item.status === 1)
      if (submitList.length < 1) {
        this.$message.error('只能审核已提交的记录')
        return
      }
      const approveIds = this.selectedRows.filter(item => item.approveId === this.userInfo.id)
      if (approveIds.length < 1) {
        this.$message.error('只能审核审批人为自己的记录')
        return
      }
      const ids = submitList.map(item => (item.id))
      this.updateStatus(ids, 2)
    },
    updateStatus (ids, status) {
      this.submitForm(URLS.updateActivityStatus, ids, 'put', { params: { status } }).then(({ success }) => {
        if (success) {
          this.$message.success('操作成功')
          this.$refs.equipmentTable.refresh()
            this.$refs.equipmentTable.clearSelected()
        }
      }).catch(() => {
        this.$message.success('操作失败')
      })
    }
  }
}
</script>
<style lang="less" scoped>

/deep/ .ant-table{
  height: auto;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 77px;
}
</style>
