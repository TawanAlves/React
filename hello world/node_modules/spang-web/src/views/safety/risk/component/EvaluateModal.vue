<template>
  <div>
    <a-modal
      :title="modalTitle"
      width="70%"
      :visible="visible"
      :confirmLoading="loading"
      @cancel="closeForm"
      :bodyStyle="{maxHeight: '700px', overflowY: 'auto'}"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-spin :spinning="loading">
        <div class="header-title">管控措施</div>
        <a-divider/>

        <fieldset v-for="(item, measuresType) in equipmentMeasures" :key="item.measuresType">
          <legend>{{ measuresType | measureTypeFilter }}</legend>
          <template v-for="(record, index) in item">
            <a-row type="flex" :key="index" style="margin-top: 10px;">
              <a-col flex="40px" style="text-align: right; margin-right: 10px;">{{ index + 1 }}</a-col>
              <a-col flex="auto">
                <a-input v-model="record.measuresDetails" :disabled="disabled" :max-length="256" :title="record.measuresDetails"></a-input>
              </a-col>
              <a-col flex="150px" style="margin-left: 10px;">
                <a-button
                  type="primary"
                  shape="circle"
                  icon="plus"
                  style="margin-right: 5px;"
                  @click="addRow(item, index, record)"
                  v-if="!disabled"/>
                <a-button type="primary" shape="circle" icon="minus" v-if="item.length > 1 && !disabled" @click="deleteRow(item, index)"/>
              </a-col>

            </a-row>
          </template>

        </fieldset>

        <div class="header-title">
          <span>风险评价</span>
          <a-button type="primary" @click="evaluteManual">直接判定</a-button>
          <a-button @click="cancelEvaluteManual" style="margin-left: 10px;">取消直接判定</a-button>
        </div>
        <a-divider/>
        <div v-if="tabKey === 1">
          <form>
            <fieldset>
              <legend>事故发生的可能性（L）判定准则</legend>
              <a-button type="primary" @click="selectLS('L')" v-if="!disabled"> 选择</a-button>
              <a-table
                size="default"
                :data-source="[form[mode + 'Judge']]"
                :pagination="false"
                :rowKey="(record) => (record.id)"
              >
                <a-table-column key="happenScores" data-index="happenScores" title="等级" align="center">
                  <template slot-scope="text, record">
                    {{ record.happenScores == -1 ? '' : record.happenScores }}
                  </template>
                </a-table-column>
                <a-table-column key="happenDetails" data-index="happenDetails" title="描述" align="center">
                </a-table-column>
              </a-table>
            </fieldset>
            <fieldset>
              <legend>事件后果严重性（S）判定准则</legend>
              <a-button type="primary" @click="selectLS('S')" v-if="!disabled">选择</a-button>
              <a-table
                size="default"
                :data-source="[form[mode + 'Judge']]"
                :pagination="false"
                :rowKey="(record) => (record.id)"
              >
                <a-table-column key="seriousScores" data-index="seriousScores" title="等级" align="center">
                  <template slot-scope="text, record">
                    {{ record.seriousScores == -1 ? '' : record.seriousScores }}
                  </template>
                </a-table-column>
                <a-table-column key="seriousDetails" data-index="seriousDetails" title="描述" align="center">
                </a-table-column>
              </a-table>
            </fieldset>
            <fieldset>
              <legend>安全风险等级判定准则及控制措施R</legend>
              <a-table
                size="default"
                :data-source="[accidentJudge]"
                :pagination="false"
                :columns="rCoumns"
                :rowKey="(index) => (index)"
              >
              </a-table>
            </fieldset>
            <a-row type="flex" justify="center" style="margin-top: 10px;">
              <a-col :span="4">
                <div class="risk-label">风险值:</div>
                <a-tag class="risk-tag">{{ controlLevel.resultScore == -1 ? '' : controlLevel.resultScore }}</a-tag>
              </a-col>
              <a-col :span="4">
                <div class="risk-label">评价级别:</div>
                <a-tag class="risk-tag">{{ accidentJudge.judgeLevelName }}</a-tag>
              </a-col>
              <a-col :span="4">
                <div class="risk-label">风险级别:</div>
                <a-tag class="risk-tag">{{ controlLevel.riskLevelName }}</a-tag>
              </a-col>
              <a-col :span="4">
                <div class="risk-label">风险色:</div>
                <a-tag class="risk-tag">{{ controlLevel.riskColourName }}</a-tag>
              </a-col>
              <a-col :span="4">
                <div class="risk-label">管控层级:</div>
                <a-tag class="risk-tag">{{ controlLevel.riskControlName }}</a-tag>
              </a-col>
            </a-row>
          </form>
        </div>
        <div v-if="tabKey === 2">
          <a-form-model :model="form[mode + 'Judge']">
            <a-row :gutter="24">
              <a-col :span="8">
                <a-form-model-item label="风险级别" prop="riskLevelId">
                  <a-select v-model="judgeLevel.riskLevelId" placeholder="风险级别" @change="riskLevelChange" :disabled="disabled">
                    <a-select-option v-for="val in riskLevelOptions " :key="val.riskLevelId">
                      {{ val.riskLevelName }}
                    </a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="8">
                <a-form-model-item label="风险色" prop="riskColourName">
                  <a-input :value="judgeLevel.riskColourName" disabled />
                </a-form-model-item>
              </a-col>
              <a-col :span="8">
                <a-form-model-item label="管控层级" prop="riskControlName">
                  <a-input :value="judgeLevel.riskControlName" disabled />
                </a-form-model-item>
              </a-col>
            </a-row>
          </a-form-model>
        </div>
      </a-spin>
      <template slot="footer">
        <a-button type="primary" @click="submitForm" v-if="!disabled">确定</a-button>
        <a-button @click="closeForm">取消</a-button>
      </template>
    </a-modal>
    <l-s-select-modal
      :disabled="disabled"
      :modal-title="lsModalTitle"
      :mode="lsModalMode"
      :visible.sync="lsModalVisible"
      @ok="setLS"
    />

  </div>

</template>

<script>
  import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
  import PersonListSelect from '../../components/PersonListSelect'
  import { RColumns } from '../columns'
  import SafetyURLs from '@/api/urls'
  import cloneDeep from 'lodash.clonedeep'
  import LSSelectModal from './LSSelectModal'
  export default {
    name: 'EvaluateModal',
    components: {
      DepartmentSelect,
      PersonListSelect,
      LSSelectModal
    },
    props: {
      visible: {
        type: Boolean,
        required: true
      },
      loading: {
        type: Boolean,
        default: () => false
      },
      model: {
        type: Object,
        default: () => null
      },
      modalTitle: {
        type: String,
        default: ''
      },
      mode: {
        type: String,
        default: () => undefined
      },
      disabled: {
        type: Boolean,
        default: () => false
      },
      checkId: {
        type: String,
        default: ''
      },
      mainId: {
        type: String,
        default: ''
      }
    },
    data () {
      return {
        controlLevel: {},
        accidentJudge: {},
        judgeLevel: {},
        lsModalTitle: '',
        lsModalMode: '',
        lsModalVisible: false,
        form: Object.assign({ [this.mode + 'Judge']: {}, [this.mode + 'MeasuresList']: [] }, cloneDeep(this.model)),
        tabKey: 1,
        riskLevelOptions: [],
        equipmentMeasures: {}
      }
    },
    computed: {
      rCoumns: () => RColumns
    },
    filters: {
      measureTypeFilter (value) {
        const measureTypeMap = { '1': '工程技术措施', '2': '管理措施', '3': '教育培训措施', '4': '个体防护措施', '5': '应急处置措施' }
        return measureTypeMap[value]
      }
    },
    watch: {
      model: function (model) {
        const modelData = Object.assign({
          [this.mode + 'Judge']: {},
          [this.mode + 'MeasuresList']: []
        }, cloneDeep(model))
        let equipmentMeasures = {}
        modelData[this.mode + 'MeasuresList'].forEach(item => {
          if (!equipmentMeasures[item.measuresType] || equipmentMeasures[item.measuresType].length === 0) {
            equipmentMeasures[item.measuresType] = [item]
          } else {
            equipmentMeasures[item.measuresType].push(item)
          }
        })
        modelData[this.mode + 'Judge'].checkId = this.checkId
        modelData[this.mode + 'Judge'].mainId = this.mainId
        if (Object.keys(equipmentMeasures).length === 0) {
          equipmentMeasures = {
            '1': [{ measuresType: '1', checkId: this.checkId, mainId: this.mainId }],
            '2': [{ measuresType: '2', checkId: this.checkId, mainId: this.mainId }],
            '3': [{ measuresType: '3', checkId: this.checkId, mainId: this.mainId }],
            '4': [{ measuresType: '4', checkId: this.checkId, mainId: this.mainId }],
            '5': [{ measuresType: '5', checkId: this.checkId, mainId: this.mainId }]
          }
        }
        this.form = modelData
        this.equipmentMeasures = equipmentMeasures
        this.controlLevel = {}
        this.accidentJudge = {}
        this.judgeLevel = {}
        if (!modelData[this.mode + 'Judge'].isDirect) {
          this.tabKey = 1
          this.controlLevel = Object.assign(modelData[this.mode + 'Judge'], { resultScore: modelData[this.mode + 'Judge'].resultScores })
          this.accidentJudge = {
            ...modelData[this.mode + 'Judge']
          }
        } else {
          this.tabKey = 2
          this.judgeLevel = modelData[this.mode + 'Judge']
        }
      }
    },
    methods: {
      initSelect () {
        this.getList(SafetyURLs.levelList).then(({ data, success }) => {
          if (success) {
            this.riskLevelOptions = data
          }
        })
      },
      riskLevelChange (riskLevelId) {
        const data = this.riskLevelOptions.find(item => item.riskLevelId === riskLevelId)
        this.judgeLevel.riskLevelId = data.riskLevelId
        this.judgeLevel.riskLevelName = data.riskLevelName
        this.judgeLevel.riskControlId = data.riskControlId
        this.judgeLevel.riskControlName = data.riskControlName
        this.judgeLevel.riskColourId = data.riskColourId
        this.judgeLevel.riskColourName = data.riskColourName
        this.judgeLevel.riskLevelValue = data.riskLevelValue
      },
      evaluteManual () {
        this.tabKey = 2
      },
      cancelEvaluteManual () {
        this.tabKey = 1
      },
      selectLS (type) {
        if (type === 'L') {
          this.lsModalTitle = '事故发生的可能性（L）判定准则'
        } else {
          this.lsModalTitle = '事件后果严重性（S）'
        }
        this.lsModalMode = type
        this.lsModalVisible = true
      },
      setLS (data) {
        if (this.lsModalMode === 'L') {
          this.form[this.mode + 'Judge'].happenId = data.id
          this.form[this.mode + 'Judge'].happenScores = data.scores
          const details = [data.happenFrequency, data.securityCheck, data.workRule, data.employeeCompetency, data.controlMeasures].filter(item => this.isNotNullOrUndefined(item)).join(';')
          this.form[this.mode + 'Judge'].happenDetails = details
        } else {
          this.form[this.mode + 'Judge'].seriousId = data.id
          this.form[this.mode + 'Judge'].seriousScores = data.scores
          const details = [data.casualties, data.downtime, data.reputationImpact].filter(item => this.isNotNullOrUndefined(item)).join(';')
          this.form[this.mode + 'Judge'].seriousDetails = details
        }
        if (this.form[this.mode + 'Judge'].happenId && this.form[this.mode + 'Judge'].seriousId) {
          const params = {
            lScores: this.form[this.mode + 'Judge'].happenScores,
            sScores: this.form[this.mode + 'Judge'].seriousScores
          }
          this.getList(SafetyURLs.getRiskLevelByScore, params).then(({ success, data }) => {
            if (success) {
              delete data.controlLevel.id
              delete data.accidentJudge.id
              this.controlLevel = { ...data.controlLevel, resultScore: data.resultScore }
              this.accidentJudge = { ...data.accidentJudge, judgeLevelName: data.accidentJudge.riskLevelName, judgeLevelId: data.accidentJudge.riskLevelId }
            }
          })
        }
      },
      closeForm () {
        this.$emit('update:visible', false)
        this.$emit('cancel')
      },
      submitForm () {
        const data = { ...this.form }
        const measures = Object.values(this.equipmentMeasures)
        let result = []
        measures.forEach(item => {
          result = [...result, ...item]
        })
        data[this.mode + 'MeasuresList'] = result
        if (this.tabKey === 1) {
          data[this.mode + 'Judge'] = Object.assign({}, data[this.mode + 'Judge'], this.controlLevel, {
            resultScores: this.controlLevel.resultScore,
            judgeMax: this.accidentJudge.judgeMax,
            judgeMin: this.accidentJudge.judgeMin,
            controlMeasures: this.accidentJudge.controlMeasures,
            timeLimit: this.accidentJudge.timeLimit,
            judgeLevelName: this.accidentJudge.judgeLevelName,
            judgeLevelId: this.accidentJudge.judgeLevelId,
            isDirect: 0
          })
        } else {
          data[this.mode + 'Judge'] = Object.assign({}, data[this.mode + 'Judge'], this.judgeLevel, {
            resultScores: null,
            timeLimit: null,
            judgeMax: null,
            judgeMin: null,
            judgeLevelName: '',
            judgeLevelId: null,
            happenDetails: null,
            happenId: null,
            happenScores: null,
            seriousDetails: null,
            seriousId: null,
            seriousScores: null,
            isDirect: 1
          })
        }
        this.$emit('ok', { formData: data })
      },
      addRow (item, index, record) {
        item.push({ measuresType: record.measuresType, checkId: record.checkId, mainId: record.mainId, orderIndex: index + 1 })
      },
      deleteRow (item, index) {
        item.splice(index, 1)
      }
    },
    created () {
      this.initSelect()
    }
  }
</script>
<style lang="less" scoped>
  .header-title {
    font-size: 16px;
    color: blue;
    margin-top: 10px;
    span {
      margin-right: 10px;
    }
  }

  /deep/ .ant-divider-horizontal {
    margin: 7px 0;
  }

  /deep/ .ant-table {
    height: auto !important;
  }
  fieldset {
    border: 1px solid #ccc;
    padding : 10px;
    legend {
      width: auto;
      font-size: 14px;
    }
  }
  .risk-label {
    font-weight: 600;
  }
  .risk-tag {
    min-height: 20px;
    min-width: 50px;
    margin-top: 4px;
  }
</style>
