<template>
  <div>
    <a-modal
      :title="modalTitle"
      width="70%"
      :visible="visible"
      :confirmLoading="loading"
      @cancel="() => { $emit('update:visible', false); $emit('cancel') }"
      :bodyStyle="{maxHeight: '700px', overflowY: 'auto'}"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-spin :spinning="loading">
        <div class="header-title">基础信息</div>
        <a-divider/>
        <a-form-model :model="form" ref="ruleForm" :rules="rules" :label-col="{span: 7}" :wrapper-col="{span:12}">
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-model-item label="设备设施名称" prop="equipmentName" :disabled="disabled">
                <a-input v-model="form.equipmentName" :disabled="disabled" placeholder="请输入设备设施名称" :max-length="32"/>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="编号" prop="equipmentCode" :disabled="disabled">
                <a-input v-model="form.equipmentCode" :disabled="disabled" placeholder="请输入编号" :max-length="32"/>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="设施设备类型" prop="equipmentTypeId" :disabled="disabled">
                <a-select
                  v-model="form.equipmentTypeId"
                  :disabled="disabled"
                  @change="equipmentTypeChange"
                  placeholder="请选择设施设备类型">
                  <a-select-option v-for="val in equipmentTypeOptions" :key="val.id">
                    {{ val.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="规格型号" prop="specification" :disabled="disabled">
                <a-input v-model="form.specification" :disabled="disabled" placeholder="请输入规格型号" :max-length="32"/>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="区域/位置" prop="areaLocationId" :disabled="disabled">
                <div class="flex-input-button">
                  <a-input :value="form.areaLocation" disabled style="margin-right: 5px;"/>
                  <a-button :disabled="disabled" @click="areaModalVisible = true">选择</a-button>
                </div>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="管辖部门/单位" prop="deptId" >
                <department-select
                  v-model="form.deptId"
                  @change="handleDeptChange"
                  placeholder="请选择管辖部门/单位"
                  :disabled="disabled"></department-select>
              </a-form-model-item>
            </a-col>
          </a-row>
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-model-item label="是否特种设备" prop="isSpecial">
                <a-select
                  v-model="form.isSpecial"
                  placeholder="请选择是否特种设备"
                  :disabled="disabled">
                  <a-select-option :key="0">
                    是
                  </a-select-option>
                  <a-select-option :key="1">
                    否
                  </a-select-option>
                </a-select>
              </a-form-model-item>
              <a-form-model-item label="风险类型" prop="riskTypeId">
                <a-select
                  v-model="form.riskTypeId"
                  @change="riskTypeChanged"
                  placeholder="请选择风险类型"
                  :disabled="disabled">
                  <a-select-option v-for="val in riskTypeOptions" :key="val.id">
                    {{ val.dictValue }}
                  </a-select-option>

                </a-select>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="备注" prop="remark">
                <a-input
                  type="textarea"
                  v-model="form.remark"
                  :disabled="disabled"
                  placeholder="请输入备注"
                  :rows="4"
                  :max-length="256"/>
              </a-form-model-item>
            </a-col>
          </a-row>
          <a-row :gutter="24" v-if="form.id">
            <a-col :span="12">
              <a-form-model-item label="风险级别" prop="remark">
                {{ form.equipmentJudgeVO.riskLevelName || '-' }}
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-row :gutter="24">
                <a-col :span="12">
                  <a-form-model-item label="风险色" prop="remark">
                    {{ form.equipmentJudgeVO.riskColourName || '-' }}
                  </a-form-model-item>
                </a-col>
                <a-col :span="12">
                  <a-form-model-item label="管控层级" prop="remark">
                    {{ form.equipmentJudgeVO.riskControlName || '-' }}
                  </a-form-model-item>
                </a-col>
              </a-row>
            </a-col>
          </a-row>
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-model-item label="责任单位及责任人" prop="chargerIds">
                <person-list-select
                  v-model="form.chargerIds"
                  @change="chargeChanged"
                  multiple="multiple"
                  placeholder="请选择责任单位及责任人"
                  :disabled="disabled"
                  :showDept="true"
                />
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="审批人" prop="approveId">
                <person-list-select v-model="form.approveId" @change="approveChanged" placeholder="请选择审批人" :disabled="disabled" :showDept="true"/>
              </a-form-model-item>
            </a-col>
          </a-row>
        </a-form-model>
        <div class="header-title">
          <span>检查项</span>
          <a-button type="primary" @click="addRow" v-if="!disabled">添加</a-button>
        </div>
        <a-divider/>
        <a-table
          ref="check-table"
          size="default"
          :columns="columns"
          :data-source="form.equipmentCheckList"
          :pagination="false"
          class="check-table"
          :rowKey="(record, index) => (record.id + index)"
        >
          <template slot="checkName" slot-scope="text, record">
            <a-input v-model="record.checkName" :disabled="disabled" @blur.native="saveCheckData(record, false)" :max-length="32"></a-input>
          </template>
          <template slot="checkStandard" slot-scope="text, record">
            <a-input v-model="record.checkStandard" :disabled="disabled" @blur.native="saveCheckData(record, false)" :max-length="32"></a-input>
          </template>
          <template slot="nonCompliance" slot-scope="text, record">
            <a-input v-model="record.nonCompliance" :disabled="disabled" @blur.native="saveCheckData(record, false)" :max-length="32"></a-input>
          </template>
          <template slot="mainConsequence" slot-scope="text, record">
            <a-input v-model="record.mainConsequence" :disabled="disabled" @blur.native="saveCheckData(record, false)" :max-length="32"></a-input>
          </template>
          <template slot="action" slot-scope="text, record, index">
            <a type="primary" @click="evaluate(record)" v-if="form.id">风险评价</a>
            <a type="primary" @click="deleteRow(record, index)" style="margin-left: 15px" v-if="!disabled">删除</a>
          </template>
        </a-table>
      </a-spin>
      <template slot="footer">
        <a-button type="primary" @click="submitModalForm" v-if="!disabled">确定</a-button>
        <a-button @click="$emit('update:visible', false); $emit('cancel')">取消</a-button>
      </template>
    </a-modal>
    <evaluate-modal
      :disabled="disabled"
      :visible.sync="evaluateModalVisible"
      :model="evaluateModalData"
      @ok="submitEvaluateModal"
      :checkId="checkId"
      :mainId="form.id"
      mode="equipment"
    />
    <area-select-modal
      title="选择区域/位置"
      :visible.sync="areaModalVisible"
      @ok="areaLocationChange"
      :defaultSelect="[form.areaLocationId]"
    />
  </div>

</template>

<script>
  import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
  import PersonListSelect from '../../components/PersonListSelect'
  import cloneDeep from 'lodash.clonedeep'
  import { equipmentCheckColumns } from '../columns'
  import EvaluateModal from './EvaluateModal'
  import URLS from '@/api/risk-urls'
  import AreaSelectModal from '@/views/safety/components/AreaSelectModal'

  export default {
    name: 'RiskModal',
    components: {
      DepartmentSelect,
      PersonListSelect,
      EvaluateModal,
      AreaSelectModal
    },
    props: {
      visible: {
        type: Boolean,
        required: true
      },
      loading: {
        type: Boolean,
        default: () => false
      },
      model: {
        type: Object,
        default: () => null
      },
      modalTitle: {
        type: String,
        default: '操作'
      },
      mode: {
        type: String,
        default: () => undefined
      },
      disabled: {
        type: Boolean,
        default: () => false
      },
      areaOptions: {
        type: Array,
        default: () => []
      },
      riskTypeOptions: {
        type: Array,
        default: () => []
      }
    },
    data () {
      return {
        areaModalVisible: false,
        editRow: null,
        checkId: null,
        evaluateModalVisible: false,
        evaluateModalData: {},
        equipmentCheckList: [],
        form: Object.assign({ equipmentCheckList: [] }, cloneDeep(this.model)),
        equipmentTypeOptions: [],
        rules: {
          equipmentName: [
            { required: true, message: '请输入设备设施名称', trigger: 'blur' }
          ],
          equipmentTypeId: [
            { required: true, message: '请选择设备设施类型', trigger: 'blur' }
          ],
          areaLocationId: [
            { required: true, message: '请选择区域/位置', trigger: 'blur' }
          ],
          deptId: [
            { required: true, message: '请选择管辖部门/单位', trigger: 'blur' }
          ],
          isSpecial: [
            {
              required: true,
              trigger: 'blur',
              validator: (rule, value, callback) => {
                if (!this.isNotNullOrUndefined(value)) {
                  callback(new Error('请选择是否特种设备'))
                } else {
                  callback()
                }
              }
            }
          ],
          riskTypeId: [
            {
              required: true,
              trigger: 'blur',
              validator: (rule, value, callback) => {
                if (!this.isNotNullOrUndefined(value)) {
                  callback(new Error('请选择风险类型'))
                } else {
                  callback()
                }
              }
            }
          ]
        }
      }
    },
    computed: {
      columns: () => equipmentCheckColumns
    },
    watch: {
      model: function (val) {
        this.form = Object.assign({
          equipmentCheckList: [],
          equipmentTypeName: undefined,
          areaLocation: undefined,
          deptName: undefined,
          riskType: undefined,
          approveName: undefined,
          chargerNames: undefined,
          areaLocationId: undefined
        }, cloneDeep(val))
      }
    },
    methods: {
      saveCheckData (record, reload) {
        this.saveCheck(record, reload)
      },
      saveCheck: function (record, reload) {
        const method = record.id ? 'put' : 'post'
        const params = {
          ...record,
          mainId: this.form.id
        }
        this.submitForm(URLS.equipmentCheck, params, method).then(({ success }) => {
          if (success && reload !== false) {
            this.reloadForm()
          }
        })
      },
      addRow () {
        if (this.form.id) {
          this.saveCheckData({ orderIndex: this.form.equipmentCheckList.length })
        } else {
          this.form.equipmentCheckList.push(
            {
              orderIndex: this.form.equipmentCheckList.length,
              checkName: '',
              checkStandard: '',
              nonCompliance: '',
              mainConsequence: ''
            }
          )
        }
      },
      deleteRow (record, index) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            if (record.id) {
              _this.deleteByIds(URLS.equipmentCheck, [record.id]).then(res => {
                if (res.code === 200) {
                  _this.$message.success('删除成功')
                  _this.reloadForm()
                } else {
                  _this.$message.error('删除失败')
                }
              })
            } else {
              _this.form.equipmentCheckList.splice(index, 1)
              _this.$message.success('删除成功')
            }
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      },
      initSelect () {
        this.getDict('RISK_EQUIP').then(({ success, data }) => {
          if (success) {
            this.equipmentTypeOptions = data
          }
        })
      },
      submitModalForm () {
        this.$refs.ruleForm.validate((valid, errorProp) => {
          if (valid) {
            if (this.form.equipmentCheckList < 1) {
              this.$message.error('操作失败，请确保至少有一条检查项')
              return false
            }
            this.$emit('ok', {
              formData: {
                ...this.form,
                chargerIds: this.form.chargerIds ? this.form.chargerIds.join(',') : undefined,
                chargerNames: this.form.chargerNames ? this.form.chargerNames.join(',') : undefined
              }
            })
          } else {
            console.error(errorProp)
            this.$message.error('操作失败，请重新检查表单')
            return false
          }
        })
      },
      equipmentTypeChange (value) {
        this.form.equipmentTypeName = this.equipmentTypeOptions.find(item => item.id === value).dictValue
      },
      areaLocationChange (area) {
        if (area) {
          this.form.areaLocationId = area.id
          this.form.areaLocation = area.areaLocation
        }
      },
      handleDeptChange ({ label }) {
        this.form.deptName = label
      },
      riskTypeChanged (value) {
        this.form.riskType = this.riskTypeOptions.find(item => item.id === value).dictValue
      },
      approveChanged ({ person }) {
        this.form.approveName = person.realName
      },
      chargeChanged ({ person }) {
        this.form.chargerIds = person.map(item => item.id)
        this.form.chargerNames = person.map(item => item.realName)
      },
      evaluate (record) {
        this.checkId = record.id
        if (this.isNotNullOrUndefined(record.checkName) || this.disabled) {
          this.getById(URLS.equipmentCheck, record.id).then(({ data, success }) => {
            if (success) {
              this.evaluateModalVisible = true
              this.evaluateModalData = data
            }
          })
        } else {
          this.$message.error('请先填写检查项目后再进行风险评价')
        }
      },
      reloadForm (callback) {
        this.getById(URLS.equipment, this.form.id).then(({ data, success }) => {
          if (success) {
            this.form.equipmentJudgeVO = { ...this.form.equipmentJudgeVO, ...data.equipmentJudgeVO }
            this.form.equipmentCheckList = data.equipmentCheckList
            callback && callback()
          }
        })
      },
      submitEvaluateModal ({ formData }) {
        this.submitForm(URLS.checkUpdate, formData, 'put').then(({ data, success }) => {
          if (success) {
            this.reloadForm(() => {
              this.evaluateModalVisible = false
            })
          }
        })
      }
    },
    created () {
      this.initSelect()
    }
  }
</script>
<style lang="less" scoped>
  .header-title {
    font-size: 16px;
    color: blue;

    span {
      margin-right: 10px;
    }
  }

  /deep/ .ant-divider-horizontal {
    margin: 7px 0;
  }

  /deep/ .check-table .ant-table {
    height: auto !important;
  }

  .flex-input-button {
    display: flex;
    justify-content: space-between;
  }
</style>
