<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{padding: '0px'}">
      <a-row :gutter="12">
        <a-col :span="4" style="padding-right: 1px!important;">
          <a-card
            :bordered="false"
            :body-style="{paddingRight: '5px','padding-top': '0', 'margin-top': '24px', 'border-right': '1px solid #e8e8e8'}"
          >
            <a-button type="primary" style="margin-left: 23px;" @click="addNode">添加节点</a-button>
            <a-tree
              class="left-tree"
              :tree-data="treeData"
              :expanded-keys="expandedKeys"
              :auto-expand-parent="autoExpandParent"
              @expand="onExpand"
              @select="OnSelect"
              :replaceFields="replaceFields"
            >
              <template #title="{ id: treeKey, mainName }">
                <a-dropdown :trigger="['contextmenu']">
                  <span>{{ mainName }}</span>
                  <template #overlay>
                    <a-menu
                      @click="({ key: menuKey }) => onContextMenuClick(treeKey, menuKey, mainName)"
                    >
                      <a-menu-item key="add">添加</a-menu-item>
                      <a-menu-item key="delete" v-if="treeKey !== 0">删除</a-menu-item>
                    </a-menu>
                  </template>
                </a-dropdown>
              </template>
            </a-tree>
          </a-card>
        </a-col>
        <a-col :span="20" style="padding-left: 1px!important;">
          <a-card :bordered="false" :body-style="{'padding-bottom': '0px'}">
            <div class="table-page-search-wrapper" style="margin-bottom: 10px;">
              <a-form layout="inline">
                <a-row :gutter="24">
                  <a-col :md="8" :sm="12" :xs="24">
                    <a-form-item label="单位/部门">
                      <department-select v-model="queryParam.deptId" placeholder="单位/部门"></department-select>
                    </a-form-item>
                  </a-col>
                  <a-col  :md="8" :sm="12" :xs="24">
                    <a-form-item label="区域/位置名称">
                      <a-input v-model="queryParam.areaLocation" placeholder="区域/位置名称" />
                    </a-form-item>
                  </a-col>
                  <a-col  :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
                    <a-space>
                      <a-button
                        type="primary"
                        @click="personnelResearch()"
                      >查询</a-button>
                      <a-button @click="personnelRefresh()">重置</a-button>
                    </a-space>
                  </a-col>
                </a-row>
                <a-row :gutter="24" class="text-right">
                  <a-col>
                    <a-button type="primary" icon="plus" @click="addTableData">新建</a-button>
                  </a-col>
                </a-row>
              </a-form>
            </div>
            <s-table
              ref="personnelTable"
              size="default"
              :rowKey="record => record.id"
              :columns="columns"
              :data="loadData"
              :alert="false"
              :rowSelection="false"
              showPagination="true"
              :scroll="{y:`calc(100vh - 400px)`, x: 1100}"
              :pagination="pagination"
            >
              <span
                slot="serial"
                slot-scope="text, record, index"
              >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
              <span slot="action" slot-scope="text, record">
                <template>
                  <a @click="personnelCheck(record)" style="margin-right: 10px;">修改</a>
                  <a @click="deleteTableRow(record)">删除</a>
                </template>
              </span>
            </s-table>
          </a-card>
        </a-col>
      </a-row>
    </a-card>
    <common-form-modal
      ref="treeModal"
      modal-title
      :visible.sync="treeModalVisible"
      :model="treeModalData"
      :rule="treeModalRules"
      @ok="submitTreeNode"
    />
    <common-form-modal
      ref="tableModal"
      :visible.sync="tableModalVisible"
      :model="tableModalData"
      :rule="tableModalRules"
      @ok="submitAddTableData"
      :modal-title="tableModalTitle"
    />
  </page-container>
</template>

<script>
import { STable } from '@/components'
import { areaColumns } from '@/views/safety/table'
import STree from '@/components/Tree/Tree'
import ApiURLs from '@/api/urls'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import DepartmentSelect from '../components/DepartmentSelect'
import { getNodeLevel, getChildNodesIds } from '@/utils/util'

const MAIN_NAME = '神木天元化工有限公司'
export default {
  name: 'Area',
  components: {
    STable,
    STree,
    CommonFormModal,
    DepartmentSelect
  },
  data() {
    return {
      pagination: {
        pageSize: 10,
        current: 1,
        showSizeChanger: true
      },
      tableModalTitle: '',
      tableModalVisible: false,
      tableModalData: {
        deptId: undefined,
        deptName: undefined,
        areaCode: undefined,
        areaLocation: undefined,
        id: null
      },
      treeModalVisible: false,
      replaceFields: Object.freeze({
        title: 'mainName',
        key: 'id',
        children: 'children',
        value: 'id'
      }),
      parentNodeName: MAIN_NAME,
      treeModalData: {
        mainName: '',
        parentMainName: MAIN_NAME
      },
      treeData: [],
      expandedKeys: [],
      autoExpandParent: true,
      queryParam: { nodeId: 0 },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        let mainIds
        if (this.queryParam.nodeId !== 0) {
          mainIds = getChildNodesIds(this.treeData, this.queryParam.nodeId)
        }
        Object.assign(requestParameters, this.queryParam, { mainIds: mainIds || undefined })
        delete requestParameters['nodeId']
        return this.getList(ApiURLs.areaPageList, requestParameters).then(res => {
          this.pagination = { ...this.pagination, pageSize: res.data.size, current: res.data.current }
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      selectedRowKeys: [],
      selectedRows: [],
      treeModalRules: [
        {
          type: 'input',
          title: '上级节点',
          field: 'parentMainName',
          props: {
            type: 'text',
            disabled: true
          }
        },
        {
          type: 'input',
          title: '节点名称',
          field: 'mainName',
          props: {
            type: 'text',
            placeholder: '请输入节点名称'
          },
          validate: [
            {
              required: true,
              message: '请输入节点名称',
              trigger: 'blur'
            }
          ]
        }
      ],
      tableModalRules: [
        {
          type: 'input',
          title: '区域/位置名称',
          field: 'areaLocation',
          props: {
            type: 'text',
            placeholder: '请输入区域/位置名称',
            maxLength: 32
          },
          validate: [
            {
              required: true,
              message: '请输入区域/位置名称',
              trigger: 'blur'
            }
          ]
        },
        {
          type: 'DepartmentSelect',
          title: '单位',
          field: 'deptId',
          props: {
            placeholder: '请选择单位'
          },
          on: {
            change: ({ label }) => {
              this.tableModalData.deptName = label
            }
          },
          validate: [
            {
              required: true,
              message: '请选择单位',
              trigger: 'blur'
            }
          ]
        },
        {
          type: 'input',
          title: '区域编号',
          field: 'areaCode',
          props: {
            type: 'text',
            placeholder: '请输入区域编号',
            maxLength: 32
          }
        }
      ]
    }
  },
  created() {
    this.getTreeData()
  },
  computed: {
    columns: () => areaColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    /**
     * 右键树节点
     */
    onContextMenuClick(treeKey, menuKey, mainName) {
      console.log(`treeKey: ${treeKey}, menuKey: ${menuKey}, mainName: ${mainName}`)
      if (menuKey === 'add') {
        this.parentNodeName = mainName
        this.queryParam.nodeId = treeKey
        this.addNode()
      } else if (menuKey === 'delete') {
        const _this = this
        this.$confirm({
          title: '提示',
          content: '将要删除选中数据，是否确认',
          okText: '确认',
          okType: 'danger',
          cancelText: '取消',
          onOk() {
            _this.deleteByIds(ApiURLs.areaTree, [treeKey]).then(res => {
              if (res.code === 200) {
                _this.$message.success(`${res.msg}`)
                if (treeKey === _this.queryParam.nodeId) {
                  _this.queryParam.nodeId = 0
                }
                _this.getTreeData()
                _this.$refs.personnelTable.refresh(true)
              } else {
                _this.$message.error(`${res.msg}`)
              }
            })
          }
        })
      }
    },
    /**
     * 点击添加树节点
     */
    addNode() {
      if (getNodeLevel(this.treeData, this.queryParam.nodeId) !== 4) {
        this.treeModalData = {
          mainName: '',
          parentMainName: this.parentNodeName
        }
        this.treeModalVisible = true
      } else {
        this.$message.error('节点选中错误，请确认')
      }
    },
    submitTreeNode({ formData }) {
      const params = {
        mainName: formData.mainName,
        parentId: this.queryParam.nodeId
      }
      this.submitForm(ApiURLs.areaTree, params, 'post')
        .then(res => {
          if (res.success) {
            this.$message.success(`${res.msg}`)
            this.treeModalVisible = false
            this.getTreeData()
          }
        })
        .catch(err => {
          this.$message.error(`${err.response.data.msg}`)
        })
    },
    OnSelect(selectedKeys, info) {
      this.queryParam.nodeId = selectedKeys[0]
      this.parentNodeName = info.node.dataRef.mainName
      this.$refs.personnelTable.refresh(true)
      this.expandedKeys = [...this.expandedKeys, ...selectedKeys]
    },
    getTreeData() {
      this.getList(ApiURLs.areaTreeList, 0).then(res => {
        if (res.success) {
          res.data = [
            {
              id: 0,
              children: res.data,
              parentId: -1,
              mainName: MAIN_NAME
            }
          ]
          this.treeData = res.data
          if (this.expandedKeys.length === 0) {
            this.expandedKeys.push(this.treeData[0].id)
          }
        }
      })
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    personnelCheck(record) {
      this.tableModalData = { ...record }
      this.tableModalTitle = '修改数据'
      this.tableModalVisible = true
    },
    personnelResearch() {
      this.$refs.personnelTable.refresh(true)
    },
    personnelRefresh() {
      this.queryParam = {}
      this.$refs.personnelTable.refresh(true)
    },
    onExpand(expandedKeys) {
      console.log('onExpand', expandedKeys)
      // if not set autoExpandParent to false, if children expanded, parent can not collapse.
      // or, you can remove all expanded children keys.
      this.expandedKeys = expandedKeys
      this.autoExpandParent = false
    },
    /**
     * 点击新建区域
     */
    addTableData() {
      this.tableModalData = {
        deptId: undefined,
        deptName: undefined,
        areaCode: undefined,
        areaLocation: undefined,
        id: null
      }
      this.tableModalTitle = '新增数据'
      this.tableModalVisible = true
    },
    /**
     * 增加表格数据
     */
    submitAddTableData({ formData }) {
      let method = ''
      if (this.isNotNullOrUndefined(this.tableModalData.id)) {
        method = 'put'
        formData.id = this.tableModalData.id
      } else {
        method = 'post'
      }
      const params = {
        ...formData,
        deptName: this.tableModalData.deptName,
        mainIds: this.queryParam.nodeId
      }
      this.submitForm(ApiURLs.areaTable, params, method)
        .then(res => {
          if (res.success) {
            this.tableModalVisible = false
            this.$message.success(`${res.msg}`)
            this.$refs.personnelTable.refresh()
          }
        })
        .catch(err => {
          this.$message.error(`${err.response.data.msg}`)
        })
    },
    deleteTableRow(record) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将要删除选中数据，是否确认',
        okText: '确认',
        okType: 'danger',
        cancelText: '取消',
        onOk() {
          _this.deleteByIds(ApiURLs.areaTable, [record.id]).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.$refs.personnelTable.refresh(true)
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    }
  }
}
</script>
<style lang="less" scoped>
.right-header {
  font-size: 16px;
  font-weight: 500;
}

.table-header {
  font-size: 20px;
  font-weight: 500;
  //line-height: 30px;
  //margin-bottom: 10px;
}

.ant-table-thead > tr > th {
  //color: #00A0E9;
  font-size: 16px;
  font-weight: bold;
  //align-items: center;
  //background-color: #e6f7ff;
}

.left-tree {
  height: calc(100vh - 245px);
  overflow-y: auto;
  overflow-x: hidden;
  /*min-height: 700px;*/

  &::-webkit-scrollbar {
    width: 5px;
    height: 1px;
  }

  &::-webkit-scrollbar-thumb {
    border-radius: 3px;
    //background: @primary-color;
    background-color: #fff;
  }

  &::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 1px rgba(0, 0, 0, 0);
    border-radius: 3px;
    //background: @primary-3;
    //background-color: #077ae8;
  }
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 102px;
}
</style>
