<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8" :sm="12" :xs="24">
              <a-form-item label="报告名称">
                <a-input v-model="queryParam.reportName" placeholder="报告名称"/>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="12" :xs="24">
              <a-form-item label="评估机构">
                <a-input v-model="queryParam.assessOrgName" placeholder="评估机构"/>
              </a-form-item>
            </a-col>
             <a-col :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="hazopResearch">查询</a-button>
                <a-button type="second" @click="hazopRefresh">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card table-card-wrapper"
    >
      <template #title>
        <div class="text-right">
          <a-space>
            <a-button type="primary" icon="plus" @click="hazopAdd" v-if="permission.risk_hazop_add" style="float:right">
              新建
            </a-button>
            <a-button
              icon="delete"
              :disabled="!hasSelected"
              @click="hazopRemove"
              v-if="permission.risk_hazop_delete"
              style="float:left">
              删除
            </a-button>

          </a-space>

        </div>
      </template>
      <s-table
        ref="hazopTable"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="rowSelection"
        showPagination="true"
        :scroll="{y: `calc(100vh - 450px)`, x: 1020}"
        :pagination="pagination"
      >
        <span slot="serial" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <span slot="status" slot-scope="text, record">
          <a-tag :color="record.status ?'green':'orange'">{{ record.status ? '已发布' : '未发布' }}</a-tag>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="publishRecord(record, 1)" v-if="record.status !== 1 && permission.risk_hazop_publish">发布</a>
            <a @click="publishRecord(record, 0)" v-if="record.status === 1 && permission.risk_hazop_recall">撤回</a>
            <a-divider type="vertical" v-if="record.status === 1 && permission.risk_hazop_recall"/>
            <a @click="hazopCheck(record)" v-if=" record.status === 1">查看</a>
            <a-divider type="vertical" v-if="record.status !== 1 && permission.risk_hazop_edit"/>
            <a @click="hazopEdit(record)" v-if=" record.status !== 1 && permission.risk_hazop_edit">编辑</a>
            <a-divider type="vertical" v-if="record.status !== 1 &&  permission.risk_hazop_delete"/>
            <a @click="removeRecord(record)" v-if=" record.status !== 1 && permission.risk_hazop_delete">删除</a>

          </template>
        </span>
      </s-table>
      <common-form-modal
        ref="modal"
        :modal-title="title"
        :visible.sync="visible"
        :disabled="modalDisabled"
        :model="modalData"
        :rule="rules"
        @ok="hazopOk"
        :customCallback="customCallback"
      />
    </a-card>
  </page-container>
</template>
<script>
  import { STable } from '@/components'
  import { hazopColumns } from '@/views/safety/table'
  import { mapGetters } from 'vuex'
  import ApiURLs from '@/api/urls'
  import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
  import moment from 'moment'
  export default {
    components: {
      STable,
      CommonFormModal
    },
    data () {
      return {
        pagination: {
          pageSize: 10,
          current: 1,
          showSizeChanger: true
        },
        queryParam: {},
        selectedRowKeys: [],
        selectedRows: [],
        loadData: parameter => {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          Object.assign(requestParameters, this.queryParam)
          return this.getList(ApiURLs.hazopList, requestParameters).then(res => {
            this.pagination = { ...this.pagination, pageSize: res.data.size, current: res.data.current }
            return {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: res.data.records
            }
          })
        },
        // modal
        visible: false,
        title: '',
        modalData: {},
        modalDisabled: false,
        rules: [
          {
            type: 'input',
            title: '报告名称',
            field: 'reportName',
            props: {
              type: 'text',
              placeholder: '请输入报告名称',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入报告名称',
              trigger: 'blur'
            }]
          },
          {
            type: 'DatePicker',
            title: '报告日期',
            field: 'reportDate',
            style: {
              width: '100%'
            },
            props: {
              showTime: false,
              format: 'YYYY-MM-DD',
              placeholder: '请选择报告日期'
            },
            validate: [{
              required: true,
              message: '请选择报告日期',
              trigger: 'blur'
            }]
          },
          {
            type: 'input',
            title: '评估机构',
            field: 'assessOrgName',
            props: {
              type: 'text',
              placeholder: '请输入评估机构',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入评估机构',
              trigger: 'blur'
            }]
          },
          {
            type: 'input',
            title: '参与单位',
            field: 'participatoryUnit',
            props: {
              type: 'text',
              placeholder: '请输入参与单位',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入参与单位',
              trigger: 'blur'
            }]
          },
          {
            type: 'input',
            title: '报告简介',
            field: 'reportDetails',
            props: {
              type: 'textarea',
              autoSize: { minRows: 3, maxRows: 5 },
              placeholder: '请输入报告简介',
              maxLength: 256
            }
          },
          {
            type: 'input',
            title: '创建人',
            field: 'gmtCreateName',
            props: {
              type: 'text',
              placeholder: '请输入创建人',
              disabled: true,
              maxLength: 32
            }
          },
          {
            type: 'input',
            title: '创建日期',
            field: 'gmtCreate',
            props: {
              type: 'text',
              placeholder: '请输入创建日期',
              disabled: true,
              maxLength: 32
            }
          }
        ]
      }
    },
    computed: {
      ...mapGetters(['permission', 'userInfo']),
      columns: () => hazopColumns,
      hasSelected () {
        return this.selectedRowKeys.length > 0
      },
      rowSelection () {
        return {
          selectedRowKeys: this.selectedRowKeys,
          onChange: this.onSelectChange
        }
      }
    },
    methods: {
      customCallback (fApi) {
        fApi.disabled(true, 'gmtCreateName')
        fApi.disabled(true, 'gmtCreate')
      },
      initFormData () {
        this.modalData = {
          reportDetails: null,
          reportName: null,
          reportDate: null,
          participatoryUnit: null,
          assessOrgName: null,
          gmtCreateName: this.userInfo.realName,
          gmtCreateId: this.userInfo.id,
          gmtCreate: moment(new Date()).format('YYYY-MM-DD')
        }
      },
      modalInit () {
        // this.title = ''
        this.visible = false
        this.modalDisabled = false
        this.initFormData()
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      hazopResearch () {
        this.$refs.hazopTable.refresh(true)
        this.$refs.hazopTable.clearSelected()
      },
      hazopRefresh () {
        this.queryParam = {}
        this.$refs.hazopTable.refresh(true)
        this.$refs.hazopTable.clearSelected()
      },
      hazopAdd () {
        this.title = '新增数据'
        this.visible = true
        this.modalDisabled = false
        this.initFormData()
      },
      hazopRemove () {
        const ids = this.selectedRows.map(item => (item.id))
        this.removeConfirm(ids)
      },
      removeRecord (record) {
        this.removeConfirm([record.id])
      },
      removeConfirm (ids) {
        const _this = this
        this.$confirm({
          title: '提示',
          content: '将要删除选中数据，是否确认',
          okText: '确认',
          okType: 'danger',
          cancelText: '取消',
          onOk () {
            _this.deleteByIds(ApiURLs.hazop, ids).then(res => {
              if (res.code === 200) {
                _this.$message.success(`${res.msg}`)
                _this.modalInit()
                _this.$refs.hazopTable.refresh(true)
                _this.$refs.hazopTable.clearSelected()
              } else {
                _this.$message.error(`${res.msg}`)
              }
            })
          }
        })
      },
      publishRecord (record, status) {
        const url = `${ApiURLs.hazopStatusUpdate}?id=${record.id}&status=${status}`
        this.submitForm(url, null, 'put').then(res => {
          if (res.success) {
            this.$message.success(`操作成功`)
            this.$refs.hazopTable.refresh()
            this.$refs.hazopTable.clearSelected()
          }
        })
      },
      hazopCheck (record) {
        this.modalData = { ...record, gmtCreate: moment(record.gmtCreate).format('YYYY-MM-DD') }
        this.modalDisabled = true
        this.visible = true
        this.title = '查看数据'
      },
      hazopEdit (record) {
        this.title = '编辑数据'
        this.modalData = { ...record, gmtCreate: moment(record.gmtCreate).format('YYYY-MM-DD') }
        this.visible = true
        this.modalDisabled = false
      },
      hazopOk ({ formData }) {
        let method = ''
        if (this.isNotNullOrUndefined(this.modalData.id)) {
          method = 'put'
          formData.id = this.modalData.id
          formData.status = this.status
        } else {
          method = 'post'
          formData.status = 0
        }
        formData.gmtCreate = moment(formData.gmtCreate).format('YYYY-MM-DD HH:mm:ss')
        this.submitForm(ApiURLs.hazop, formData, method).then(res => {
          if (res.success) {
            this.$message.success(`${res.msg}`)
            this.modalInit()
            this.$refs.hazopTable.refresh()
            this.$refs.hazopTable.clearSelected()
          }
        }).catch((err) => {
          this.$message.error(`${err.response.data.msg}`)
        })
      }
    }
  }
</script>
<style lang="less" scoped>

  /deep/ .ant-table {
    height: auto;
  }
</style>
