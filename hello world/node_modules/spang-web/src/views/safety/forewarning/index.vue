<template>
  <page-container :title="false">
    <a-card :bordered="false" v-if="!detailKey">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :span="4">
              <a-form-item label="报警级别">
                <a-select v-model="queryParam.alarmLevel">
                  <a-select-option v-for="d in alarmLevelOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item label="报警类型">
                <a-select v-model="queryParam.alarmType">
                  <a-select-option v-for="d in alarmTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item label="报警子类型">
                <a-select v-model="queryParam.alarmSubtype">
                  <a-select-option v-for="d in alarmSubTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="6">
              <a-form-item label="起始时间">
                <a-range-picker v-model="queryParam.time" valueFormat="YYYY-MM-DD HH:mm:ss"/>
              </a-form-item>
            </a-col>
            <!--            <a-col :span="1">-->
            <!--              <a-button type="link" @click="show">{{ hasShow ? '收起' : '展开' }} </a-button>-->
            <!--            </a-col>-->
            <a-col :span="4">
              <a-button type="primary" @click="warningResearch" style="margin-right: 10px">搜索</a-button>
              <a-button type="second" @click="warningRefresh">重置</a-button>
            </a-col>
          </a-row>
          <a-row :gutter="24" v-show="true">
            <a-col :span="4">
              <a-form-item label="状态">
                <a-select v-model="queryParam.status">
                  <a-select-option v-for="d in alarmStatusOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item label="阈值类型">
                <a-select v-model="queryParam.threshold">
                  <a-select-option v-for="d in alarmThresholdOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="4">
              <a-form-item label="是否有效">
                <a-select v-model="queryParam.isEffective">
                  <a-select-option v-for="d in alarmEffectiveOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
          </a-row>
          <a-row v-if="false">
            <a-col>
              <a-form-item label="批量修改是否有效">
                <a-button-group>
                  <a-button @click="positive" :disabled="!hasSelected">有效</a-button>
                  <a-button @click="negative" :disabled="!hasSelected">无效</a-button>
                </a-button-group>
              </a-form-item>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <s-table
        ref="warningTable"
        size="default"
        :scroll="{y: `calc(100vh - 440px)`}"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="false"
        showPagination="true"
      >
        <span slot="alarmLevel" slot-scope="text, record">
          <a-tag :color="detailTitleColor[text]">{{ text }}</a-tag>
        </span>
        <span slot="status" slot-scope="text, record">
          <!--          <a-tag :color="text==='已处理'? '#08EC58':'#EC0808'">{{ text }}</a-tag>-->
          <a-tag :color="text==='已处理'? 'green':'red'">{{ text }}</a-tag>
        </span>
        <span slot="isEffective" slot-scope="text, record">
          <a-switch checked-children="是" un-checked-children="否" :checked="record.isEffective === 0" @change="effectiveChange(record)"/>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="warningDetail(record)">详情</a>
            <!--            <a-divider type="vertical"/>-->
            <!--            <a @click="warningHistory(record)" disabled="true">历史记录</a>-->
          </template>
        </span>
      </s-table>
    </a-card>
    <div :bordered="false" v-else-if="detailKey">
      <a-card>
        <a-row type="flex" justify="space-between">
          <a-col :span="1">
            <a-button @click="detailKey = false" size="large" shape="circle" icon="left"></a-button>
          </a-col>
          <a-col :span="22">
            <a-form layout="inline" style="font-weight: bold">
              <a-row>
                <a-col>
                  <a-form-item label="">
                    <p style="font-size: 20px;font-weight: bold">{{ detailForm.alarmName }}
                      <a-tag :color="detailTitleColor[detailForm.alarmLevel]">{{ detailForm.alarmLevel }}</a-tag>
                      <a-tag :color="detailForm.status==='已处理'?'green':'red'">{{ detailForm.status }}</a-tag></p>
                  </a-form-item>
                </a-col>
              </a-row>
              <a-row :gutter="24">
                <a-col :span="6">
                  <a-form-item label="报警时间">
                    <p>{{ detailForm.alarmTime }}</p>
                  </a-form-item>
                </a-col>
                <a-col :span="6">
                  <a-form-item label="报警类型">
                    <p>{{ detailForm.alarmType }}</p>
                  </a-form-item>
                </a-col>
              </a-row>
              <a-row :gutter="24">
                <a-col :span="6">
                  <a-form-item label="报警子类型">
                    <p>{{ detailForm.alarmSubtype }}</p>
                  </a-form-item>
                </a-col>
              </a-row>
              <a-row :gutter="24">
                <a-col :span="24">
                  <a-form-item label="报警描述">
                    <p>{{ detailForm.description }}</p>
                  </a-form-item>
                </a-col>
              </a-row>
              <div v-show="mark">
                <a-row>
                  <p>消息推送列表:</p>
                </a-row>
                <a-row>
                  <div style="width: 80%">
                    <a-descriptions
                      title=""
                      bordered
                      size="middle"
                      layout="vertical"
                      :column="{ xxl: 4}"
                    >
                      <a-descriptions-item label="类型" :span="1">
                        {{ detailForm.messagePushVO.type }}
                      </a-descriptions-item>
                      <a-descriptions-item label="内容" :span="1">
                        {{ detailForm.messagePushVO.description }}
                      </a-descriptions-item>
                      <a-descriptions-item label="时间" :span="1">
                        {{ detailForm.messagePushVO.pushTime }}
                      </a-descriptions-item>
                      <a-descriptions-item label="人员" :span="1">
                        {{ detailForm.messagePushVO.person }}
                      </a-descriptions-item>
                    </a-descriptions>
                  </div>
                </a-row>
                <a-row>
                  <a-col>
                    <a-form-item label="历史报警">
                      <p>{{ detailForm.messagePushVO.hisAlarm }}</p>
                    </a-form-item>
                  </a-col>
                </a-row>
              </div>
            </a-form>
          </a-col>
          <a-col>
            <a-button @click="mark=!mark" size="large" shape="circle" :icon="mark?'up':'down'"></a-button>
          </a-col>
        </a-row>
      </a-card>
      <a-card>
        <a-row>
          <a-col :offset="1">
            <a-timeline>
              <a-timeline-item v-for="d in detailForm.alarmCommunicationVOList" :key="d.key">
                <p>{{ d.mode }}</p>
                <p>{{ d.createTime }}</p>
                <p>{{ d.content }}</p>
              </a-timeline-item>
            </a-timeline>
          </a-col>
        </a-row>
      </a-card>
      <a-card>
        <a-row type="flex" justify="center">
          <a-col>
            <a-button style="margin-right: 12px" @click="recordAdd">添加沟通记录</a-button>
            <a-button style="margin-right: 12px" @click="eventLoop" :disabled="endLoop">事件闭环</a-button>
          </a-col>
        </a-row>
      </a-card>
    </div>
    <detail-modal
      ref="foreModal"
      :title="modalTitle"
      :visible="visible"
      :confirm-loading="confirmLoading"
      :modal-mode="modalMode"
      @ok="modalOk"
      @cancel="modalCancel"/>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import { forewarningColumns } from '@/views/safety/table'
import { foreWarning, alarmSelectOptions } from '@/api/safety'
import DetailModal from './DdtailModal'

// const detailTitleColor = {
//   A级告警: '#EC0808',
//   B级告警: '#08EC58',
//   C级告警: '#FBE400',
//   D级告警: '#002AFB'
// }
const detailTitleColor = {
  A级告警: 'red',
  B级告警: 'orange',
  C级告警: 'yellow',
  D级告警: 'blue'
}

export default {
  name: 'Index',
  components: {
    STable,
    DetailModal
  },
  data () {
    return {
      endLoop: false,
      mark: false,
      detailKey: false,
      hasShow: false,
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = {
          current: parameter.pageNo,
          size: parameter.pageSize
        }
        Object.assign(requestParameters, this.queryParam)
        return foreWarning.getForewarningList(requestParameters).then(res => {
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      detailForm: {},
      timelineData: [],
      // modal
      visible: false,
      modalTitle: '',
      confirmLoading: false,
      modalMode: true,
      // select options
      alarmTypeOptions: [],
      alarmStatusOptions: [],
      alarmSubTypeOptions: [],
      alarmLevelOptions: [],
      alarmEffectiveOptions: [],
      alarmThresholdOptions: [],
      alarmEndReasonOptions: [],
      alarmEndModeOptions: [],
      alarmCommunicationOptions: []
    }
  },
  created () {
    this.selectOptionsInit()
  },
  computed: {
    detailTitleColor: () => detailTitleColor,
    columns: () => forewarningColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectOptionsInit () {
      alarmSelectOptions.getAlarmType().then(res => {
        this.alarmTypeOptions = res.data
      })
      alarmSelectOptions.getAlarmSubType().then(res => {
        this.alarmSubTypeOptions = res.data
      })
      alarmSelectOptions.getAlarmStatus().then(res => {
        this.alarmStatusOptions = res.data
      })
      alarmSelectOptions.getAlarmLevel().then(res => {
        this.alarmLevelOptions = res.data
      })
      alarmSelectOptions.getAlarmEffective().then(res => {
        this.alarmEffectiveOptions = res.data
      })
      alarmSelectOptions.getAlarmThreshold().then(res => {
        this.alarmThresholdOptions = res.data
      })
      alarmSelectOptions.getAlarmEndMode().then(res => {
        this.alarmEndModeOptions = res.data
      })
      alarmSelectOptions.getAlarmEndReason().then(res => {
        this.alarmEndReasonOptions = res.data
      })
      alarmSelectOptions.getAlarmCommunicationMode().then(res => {
        this.alarmCommunicationOptions = res.data
      })
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    show () {
      this.hasShow = !this.hasShow
    },
    positive () {
      this.$message.success('有效')
    },
    negative () {
      this.$message.success('无效')
    },
    effectiveChange (record) {
      const effective = record.isEffective ? 0 : 1
      const parameter = { id: record.id, isEffective: effective }
      foreWarning.changeIsEffective(parameter).then(() => {
        this.$refs.warningTable.refresh(true)
        this.$refs.warningTable.clearSelected()
      })
    },
    warningDetail (record) {
      foreWarning.getForewarningListDetail(record.id).then(res => {
        this.detailForm = res.data
        this.detailKey = true
        this.endLoop = res.data.status === '已处理'
      })
    },
    warningHistory (record) {
      this.$message.success('历史记录')
    },
    warningResearch () {
      this.$refs.warningTable.refresh(true)
      this.$refs.warningTable.clearSelected()
    },
    warningRefresh () {
      this.queryParam = {}
      this.$refs.warningTable.refresh(true)
      this.$refs.warningTable.clearSelected()
    },
    recordAdd () {
      this.visible = true
      this.modalTitle = '沟通记录'
      this.modalMode = true
    },
    eventLoop () {
      this.visible = true
      this.modalTitle = '事件闭环'
      this.modalMode = false
    },
    modalOk () {
      const _this = this
      const form = this.$refs.foreModal.form
      form.validateFields((errors, values) => {
        console.log(values)
        if (!errors) {
          const params = { ...values, alarmId: _this.detailForm.id }
          if (_this.modalMode) {
            foreWarning.submitCommunication(params).then((res) => {
              res.success && this.$message.success('添加沟通记录成功')
              foreWarning.getForewarningListDetail(_this.detailForm.id).then((res) => {
                _this.detailForm = res.data
              })
              this.visible = false
            })
          } else {
            foreWarning.submitClosedLoop(params).then(res => {
              res.succees && _this.$message.success('事件闭环提交成功')
            })
            this.visible = false
          }
        }
      })
    },
    modalCancel () {
      this.visible = false
      const form = this.$refs.foreModal.form
      form.resetFields()
    }
 }
}
</script>
<style lang="less" scoped>
/deep/.ant-table {
  height: calc(100vh - 295px)!important;
}
/deep/ .ant-card-body {
  .ant-table-wrapper{
    min-height:calc(100vh - 230px);
  }
}
</style>
