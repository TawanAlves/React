<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col  :md="8" :sm="12" :xs="24">
              <a-form-item label="消防器材名称">
                <a-input v-model="queryParam.equipmentName" maxlength="32"  placeholder="消防器材名称"/>
              </a-form-item>
            </a-col>
            <a-col  :md="8" :sm="12" :xs="24">
              <a-form-item label="上报日期">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
            <a-col  :md="8" :sm="24" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none'}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 394px)`, x: 1440}"
        showPagination="true"
      >
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <template slot="action" slot-scope="text, record">
          <a @click="handleRecord(record)" v-if="record.status === 0">处理</a>
          <a @click="viewRecord(record)" v-if="record.status === 1">查看</a>
        </template>
        <template slot="status" slot-scope="text, record">
          <a-tag
            :color="record.status | colorFilter"
            style="margin-right: 0!important;"
          >{{record.status | textFilter}}</a-tag>
        </template>
      </s-table>
    </a-card>
    <!--异常处理modal-->
    <a-modal
      :title="modalTitle"
      :bodyStyle="{maxHeight:'700px',overflow:'auto'}"
      :width="700"
      :visible="visible"
      :maskClosable="false"
      @cancel="() => {this.visible = false}"
      :keyboard="false"
    >
      <template slot="footer">
        <a-button @click="() => {this.visible = false}">取消</a-button>
        <a-button type="primary" @click="handleSubmit(0)" v-if="!disabled">暂存</a-button>
        <a-button type="primary" @click="handleSubmit(1)" v-if="!disabled">处理</a-button>
      </template>
      <div class="info-title">
        <span>登记信息</span>
      </div>
      <a-divider />
      <a-card :bordered="false">
        <a-descriptions :column="1" style :colon="true">
          <a-descriptions-item label="消防器材名称">{{ modalData.name || ' - ' }}</a-descriptions-item>
          <a-descriptions-item label="器材编号">{{ modalData.number || ' - ' }}</a-descriptions-item>
          <a-descriptions-item label="规格型号">{{ modalData.models || ' - ' }}</a-descriptions-item>
          <a-descriptions-item label="异常描述">{{ modalData.description || ' - ' }}</a-descriptions-item>
          <a-descriptions-item label="登记人">{{ modalData.registrantName || ' - ' }}</a-descriptions-item>
          <a-descriptions-item label="部门">{{ modalData.registrantDeptName || ' - ' }}</a-descriptions-item>
          <a-descriptions-item label="附件" :key="index">
            <a-row v-if="modalData.files && modalData.files.length > 0" style>
              <a-col
                v-for="file in modalData.files"
                :key="file.id"
                :span="24"
                style="margin-bottom: 4px;"
              >
                <a
                  size="small"
                  @click="fileDownLoad(file.id, file.fileName)"
                  :disabled="file.fileName===''"
                >
                  <span
                    style="word-break: break-all;font-weight: normal!important;"
                  >{{ file.fileName }}</span>
                </a>
              </a-col>
            </a-row>
            <template v-else>{{ '-' }}</template>
          </a-descriptions-item>
        </a-descriptions>
      </a-card>
      <div class="info-title">
        <span>处理信息</span>
      </div>
      <a-divider />
      <a-card :bordered="false">
        <a-form :form="form" :label-col="{ span: 6 }" :wrapper-col="{ span: 16 }">
          <a-form-item label="确认消防器材状态">
            <a-select
              v-decorator="['confirmStatus',{ rules:[{ required: true, message: '请选择消防器材状态' }]}]"
              :disabled="disabled"
            >
              <a-select-option
                v-for="item in equipmentStatusOptions"
                :key="item.dictKey"
              >{{ item.dictValue }}</a-select-option>
            </a-select>
          </a-form-item>
          <a-form-item label="说明">
            <a-input
              type="textarea"
              maxlength="256"
              :autoSize="{minRows: 4,maxRows: 8}"
              v-decorator="['processDescription',{ rules:[{ required: true, message: '请填写说明' }]}]"
              :disabled="disabled"
            />
          </a-form-item>
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-item label="处理人" :label-col="{ span: 13 }" :wrapper-col="{ span: 4 }">
                <span>{{modalData.processorName}}</span>
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="处理日期" :label-col="{ span: 9 }" :wrapper-col="{ span: 14}">
                <span>{{modalData.processDate}}</span>
              </a-form-item>
            </a-col>
          </a-row>
          <!--          <a-form-item label="处理人" :label-col="{ span: 4 }" :wrapper-col="{ span: 16 }">-->
          <!--            <span>{{modalData.processorName}}</span>-->
          <!--          </a-form-item>-->
          <!--          <a-form-item label="处理日期">-->
          <!--            <span>{{modalData.processDate}}</span>-->
          <!--          </a-form-item>-->
        </a-form>
      </a-card>
    </a-modal>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import { getStore } from '@/utils/store'
import { fireEquipmentAbnormalityColumns } from '@/views/safety/fire/columns'
import FireApi from '@/api/fire'
import { downloadFile } from '@/api/common'
import { dateUtil } from '@/utils/dateUtil'
import { getDict } from '@/api/system'

const fields = ['confirmStatus', 'processDescription']

export default {
  name: 'fireEquipmentAbnormality',
  components: {
    STable
  },
  data() {
    return {
      queryParam: {},
      userInfo: getStore({ name: 'info' }),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(FireApi.fireEquipmentAbnormalityList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      searchTime: '',
      visible: false,
      disabled: false,
      modalData: [],
      form: this.$form.createForm(this),
      equipmentStatusOptions: [],
      modalTitle: ''
    }
  },
  created() {
    getDict('FIRE_STATUS').then(({ data, success }) => {
      if (success) {
        this.equipmentStatusOptions = data
      }
    })
    fields.forEach(v => this.form.getFieldDecorator(v))
  },
  computed: {
    columns: () => fireEquipmentAbnormalityColumns
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['orange', 'green']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['未处理', '已处理']
      return textList[value]
    }
  },
  methods: {
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    onTimeChange(value, dateString) {
      this.queryParam.startTime = dateString[0]
      this.queryParam.endTime = dateString[1]
    },
    initQueryParam() {
      this.queryParam = {
        equipmentName: '',
        endTime: '',
        startTime: ''
      }
      this.searchTime = ''
    },
    viewRecord(record) {
      this.disabled = true
      this.getById(FireApi.fireEquipmentAbnormality, record.id).then(({ data, success }) => {
        if (success) {
          this.modalData = data
          this.form.setFieldsValue({
            confirmStatus: data.confirmStatus + '',
            processDescription: data.processDescription
          })
          this.modalTitle = '查看数据'
          this.visible = true
        }
      })
    },
    handleRecord(record) {
      this.disabled = false
      this.getById(FireApi.fireEquipmentAbnormality, record.id).then(({ data, success }) => {
        if (success) {
          const date = new Date().getTime()
          this.modalData = {
            ...data,
            processorId: this.userInfo.id,
            processorName: this.userInfo.realName,
            processorDeptName: this.userInfo.deptName,
            processorDeptId: this.userInfo.deptId,
            processDate: dateUtil.formatDateTime(date, true)
          }
          this.form.setFieldsValue({
            confirmStatus: data.confirmStatus < 0 ? null : data.confirmStatus + '',
            processDescription: data.confirmStatus < 0 ? null : data.processDescription
          })
          this.modalTitle = '处理异常'
          this.visible = true
        }
      })
    },
    fileDownLoad(id, name) {
      downloadFile(id, name)
    },
    handleSubmit(status) {
      const that = this
      const form = this.form
      form.validateFields((errors, values) => {
        if (!errors) {
          const params = {
            ...that.modalData,
            ...values,
            status: status
          }
          that.submitForm(FireApi.fireEquipmentAbnormality, params, 'put').then(({ data, success }) => {
            if (success) {
              that.$message.success('操作成功')
              that.initQueryParam()
              this.initQueryParam()
              this.$refs.table.refresh()
              this.$refs.table.clearSelected()
              that.visible = false
              that.form.setFieldsValue({
                confirmStatus: '1',
                processDescription: null
              })
            }
          })
        }
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  //padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}

.info-title {
  font-size: 16px;
  color: blue;

  span {
    margin-right: 10px;
  }
}
/deep/ .ant-divider-horizontal {
  margin: 7px 0;
}

///deep/ .ant-card-head-title {
//  font-weight: bolder;
//  padding: 0!important;
//}

/deep/ .ant-descriptions-item-label {
  //width: 170px;
  font-size: 15px;
  //font-weight: bolder;
  text-align: right;
  margin-right: 5px;
  //margin-left: 40px;
  flex: 3;
}

/deep/ .ant-descriptions-item-content {
  font-size: 15px;
  font-weight: normal;
  word-break: break-all;
  flex: 9;
}

/deep/.ant-descriptions-item {
  display: flex;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 106px;
}
</style>
