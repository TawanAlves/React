<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="排查状态">
                <a-select
                  show-search
                  v-model="queryParam.status"
                  style="width: 100%"
                  :filter-option="filterOption"
                  option-filter-prop="children"
                   placeholder="排查状态"
                >
                  <a-select-option v-for="d in checkTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6"  :md="8" :sm="12" :xs="24">
              <a-form-item label="计划名称">
                <a-input v-model="queryParam.planName" maxLength="32" placeholder="计划名称"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="时间">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 394px)`, x: 1440}"
        showPagination="true"
      >
        <span slot="number" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <template slot="type" slot-scope="text, record">
          <span>{{planTypeList[record.type].dictValue}}</span>
        </template>
        <template slot="action" slot-scope="text, record">
          <a @click="checkRecord(record)" v-if="record.status === 1">排查</a>
          <a @click="viewRecord(record)" v-if="record.status === 2">查看</a>
        </template>
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | pageColorFilter" style="margin-right: 0!important;">{{record.statusName}}</a-tag>
        </template>
      </s-table>
    </a-card>
    <common-form-modal
      ref="modal"
      :visible.sync="commonVisible"
      :loading="confirmLoading"
      :model="commonData"
      :modal-title="commonTitle"
      :disabled="commonDisabled"
      :rule="rules"
      width="700px"
      @ok="modalOk"
    />
    <!--排查信息modal-->
    <a-modal
      title="排查信息"
      :visible="checkVisible"
      :footer="null"
      :maskClosable="false"
      :body-style="{maxHeight: '700px', overflowY: 'auto'}"
      width="70%"
      @cancel="()=>{this.checkVisible = false}"
      :keyboard="false"
    >
      <a-table
        bordered
        size="small"
        class="equipmentTable"
        :pagination="false"
        :columns="checkColumns"
        :data-source="checkData"
      >
        <template slot="action" slot-scope="text, record">
          <template v-if="isAdd">
            <a @click="normalRecord(record)" :disabled="record.checkResult === 0 && record.status === 1" v-if="record.checkResult ===0">正常</a>
            <a-divider type="vertical" v-if="record.status === 0"/>
            <a @click="addUnusualRecord(record)" v-if="record.status === 0">异常登记</a>
            <a @click="viewUnusualRecord(record)" v-if="record.status === 1 && record.checkResult !== 0">查看异常</a>
            <a-divider type="vertical" v-if="record.status === 1"/>
            <a @click="recallRecord(record)" :disabled="record.checkResult === 2 && record.status === 1" v-if="record.status === 1" >撤回</a>
          </template>
          <template v-if="!isAdd">
            <a @click="" :disabled="record.checkResult === 0 && record.status === 1" v-if="record.checkResult ===0">正常</a>
            <a @click="viewUnusualRecord(record)" v-if="record.status === 1 && record.checkResult !== 0">查看异常</a>
          </template>
        </template>
        <template slot="status" slot-scope="text, record" style="text-align: left">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0!important;">{{record.status | textFilter}}</a-tag>
        </template>
        <template slot="planCheckPersonList" slot-scope="text,record,index" style="display: flex;justify-content: start">
          <a-tag color="blue" style="margin: 2px" v-for="item in record.planCheckPersonList" :key="item.checkPersonId">{{item.checkPerson}}</a-tag>
        </template>
      </a-table>
    </a-modal>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import { getStore } from '@/utils/store'
import FireApi from '@/api/fire'
import DescriptionsModal from '@/views/safety/components/DescriptionsModal'
import { firePlanExecuteCheckColumns, firePlanExecuteColumns } from '@/views/safety/fire/columns'

export default {
  name: 'firePlanExecute',
  components: {
    STable,
    CommonFormModal,
    DescriptionsModal
  },
  data () {
    return {
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
      },
      searchTime: '',
      selectedRowKeys: [],
      selectedRows: [],
      userInfo: getStore({ name: 'info'}),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true,
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(FireApi.firePlanExecuteList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true,
          }
          return data
        })
      },
      rules: [
        {
          type: 'span',
          title: '消防器材名称',
          field: 'name',
          children: []
        },
        {
          type: 'span',
          title: '器材编号',
          field: 'number',
          children: []
        },
        {
          type: 'span',
          title: '规格型号',
          field: 'type',
          children: []
        },
        {
          type: 'input',
          title: '异常描述',
          field: 'description',
          props: {
            type: 'textarea',
            autoSize: {
              minRows: 4,
              maxRows: 8
            },
            maxLength: 255
          },
          validate: {
            required: true,
            message: '请输入异常描述'
          }
        },
        {
          type: 'DepartmentSelect',
          title: '处理部门',
          field: 'processorDeptId',
          props: {
            placeholder: '请选择处理部门'
          },
          on: {
            change: ({ label }) => {
              this.commonData.processorDeptName = label
            }
          },
          validate: [{
            required: true,
            message: '请选择处理部门',
            trigger: true
          }]
        },
        {
          type: 'span',
          title: '登记人',
          field: 'registrantId',
          children: [],
          col: {
            span: 8,
            offset: 4
          }
        },
        {
          type: 'span',
          title: '登记部门',
          field: 'registrantDeptId',
          children: [],
          col: {
            span: 12
          }
          // props: {
          //   placeholder: '请选择登记部门'
          // },
          // on: {
          //   change: ({ label }) => {
          //     this.commonData.registrantDeptName = label
          //   }
          // },
          // validate: [{
          //   required: true,
          //   message: '请选择登记部门',
          //   trigger: true
          // }]
        },
        {
          type: 'UploadFile',
          field: 'accessory',
          title: '附件',
          props: {
            fileList: []
          },
          validate: [
            {
              required: true,
              validator: (rule, value, callback) => {
                console.log(value)
                const fileList = this.$refs.modal.fApi.getRule('accessory').props.fileList
                if(fileList.length) {
                  callback()
                } else {
                  callback(new Error('请上传附件'))
                }
              },
              trigger: 'change'
            }
          ]
        }
      ],
      checkTypeOptions: [],
      checkData: [],
      checkVisible: false,
      planTypeList: [], // 计划类型
      isAdd: false,
      currentRecordId: 0, //主表单条记录Id
    }
  },
  created () {
    this.getDict('FIRE_CHECK_PLAN_TYPE').then(({ data, success}) => {
      if(success) {
        this.planTypeList = data
      }
    })
    this.getDict('FIRE_CHECK_PLAN_STATUS').then(({ data, success}) => {
      if(success) {
        this.checkTypeOptions = data
      }
    })
  },
  computed: {
    columns: () => firePlanExecuteColumns,
    checkColumns: () => firePlanExecuteCheckColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function (value) {
      const colorList = ['orange', 'green']
      if(value < 0) {
        return 'red'
      } else {
        return colorList[value]
      }
    },
    textFilter: function (value) {
      const textList = ['待排查', '已排查']
      if(value < 0) {
        return '未知状态'
      } else {
        return textList[value]
      }
    },
    pageColorFilter: function (value) {
      const colorList = ['red', 'orange', 'green']
      return colorList[value]
    },
  },
  methods: {
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    search () {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset () {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    onTimeChange (value, dateString) {
      this.queryParam.planStartDate = dateString[0]
      this.queryParam.planEndDate = dateString[1]
    },
    initQueryParam () {
      this.queryParam = {
        name: '',
        status: '',
        planStartDate: '',
        planEndDate: ''
      }
      this.searchTime = ''
    },
    commonInit () {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      // this.initFormData()
    },
    initFormData () {
      this.commonData = {
        description: null,
        processorDeptId: null,
        models: null,
      }
    },
    checkRecord (record) {
      this.currentRecordId = record.id
      this.getById(FireApi.firePlanExecute,record.id).then(({ data, success}) => {
        if(success) {
          this.isAdd = true
          this.checkData = data
          this.checkVisible = true
          console.log(this.isAdd)
        }
      })
    },
    viewRecord (record) {
      this.getById(FireApi.firePlanExecute,record.id).then(({ data, success}) => {
        if(success) {
          this.isAdd = false
          this.checkData = data
          this.checkVisible = true
        }
      })
    },
    loadCheckData () {
      this.getById(FireApi.firePlanExecute,this.currentRecordId).then(({ data, success}) => {
        if(success) {
          this.checkData = data
        }
      })
    },
    normalRecord (record) {
      this.submitForm(FireApi.firePlanExecuteNormal + `?planEquipmentId=${record.id}`, null, 'put').then(({ data, success}) => {
        if(success) {
          this.$message.success('操作成功')
          this.loadCheckData()
        }
      })
    },
    recallRecord (record) {
      this.submitForm(FireApi.firePlanExecuteRecall + `?planEquipmentId=${record.id}`, null, 'put').then(({ data, success}) => {
        if(success) {
          this.$message.success('操作成功')
          this.loadCheckData()
        }
      })
    },
    addUnusualRecord (record) {
      this.rules[0].children.pop()
      this.rules[1].children.pop()
      this.rules[2].children.pop()
      this.rules[5].children.pop()
      this.rules[6].children.pop()
      this.rules[0].children.push(record.name)
      this.rules[1].children.push(record.number)
      this.rules[2].children.push(record.models)
      this.rules[5].children.push(this.userInfo.realName)
      this.rules[6].children.push(this.userInfo.deptName)
      this.commonData = {
        address: record.address,
        planEquipmentId: record.id,
        name: record.name,
        number: record.number,
        models: record.models,
        description: '',
        registrantId: this.userInfo.id,
        registrantName: this.userInfo.realName,
        registrantDeptId: this.userInfo.deptId,
        registrantDeptName: this.userInfo.deptName,
        processorDeptId: '1413010638438846465',
        processorDeptName: '消防保卫部',
        accessory: []
      }
      this.setFileList([])
      this.commonDisabled = false
      this.commonTitle = '异常登记'
      this.commonVisible = true
    },
    setFileList (fileList) {
      if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
        this.$refs.modal.fApi.getRule('accessory').props.fileList = fileList
      } else {
        this.rules[7].props.fileList = fileList
      }
    },
    modalOk({ formData }) {
      console.log(formData)
      const params = {
        ...this.commonData,
        ...formData,
        accessory: this.$refs.modal.fApi.getRule('accessory').props.fileList.map(item => ({
          id: item.id,
          fileUrlPath: item.filePath,
          originalFileName: item.name
        }))
      }
      this.submitForm(FireApi.firePlanExecuteAbnormal, params, 'put').then(({ success }) => {
        if(success) {
          this.$message.success('操作成功')
          this.commonInit()
          this.loadCheckData()
        }
      })
    },
    viewUnusualRecord (record) {
      this.commonTitle = '查看数据'
      this.getById(FireApi.firePlanExecuteAbnormal,record.id).then(({ data, success}) => {
        if(success) {
          this.rules[0].children.pop()
          this.rules[1].children.pop()
          this.rules[2].children.pop()
          this.rules[5].children.pop()
          this.rules[6].children.pop()
          this.rules[0].children.push(data.name)
          this.rules[1].children.push(data.number)
          this.rules[2].children.push(data.models)
          this.rules[5].children.push(data.registrantName)
          this.rules[6].children.push(data.registrantDeptName)
          this.commonData = data
          this.commonDisabled = true
          this.commonVisible = true
          const files = data.files.map(item => ({
            uid: item.id,
            name: item.fileName,
            status: 'done',
            id: item.id,
            filePath: item.fileUrlPath
          }))
          this.setFileList(files)
        }
      })
    },
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  //padding-top: 0;
  padding-bottom: 15px;
}

.info-title {
  font-size: 16px;
  color: blue;

  span {
    margin-right: 10px;
  }
}
/deep/ .ant-divider-horizontal {
  margin: 7px 0;
}

.card-title {
  display: flex;
  justify-content: space-between;
}

.info-title {
  padding: 5px;
  border-bottom: 1px solid #e5e3e3;
  font-size: 16px;
  color: #00A0E9;
  //font-weight: bold;
}
.historyTable {
  /deep/.ant-table-body {
    margin: 0!important;
  }
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 77px;
}
</style>
