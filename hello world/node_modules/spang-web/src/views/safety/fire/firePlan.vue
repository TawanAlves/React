<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" v-if="!isItemShow" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="计划名称">
                <a-input v-model="queryParam.planName" maxLength="32" placeholder="计划名称"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="计划类型">
                <a-select
                  show-search
                  v-model="queryParam.planType"
                  placeholder="计划类型"
                  style="width: 100%"
                >
                  <a-select-option v-for="d in planTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="检查日期">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
             <a-col :lg="6"  :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      style="margin: 15px;"
      class="table-card"
      :bordered="false"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      v-if="!isItemShow"
    >
      <template #extra>
        <a-button type="primary" icon="plus" @click="addRecord" v-if="permission.fire_plan_add">
          新建
        </a-button>
      </template>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 432px)`, x: 1280}"
        showPagination="true"
      >
        <span slot="number" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <span slot="action" slot-scope="text, record">
          <template v-if="record.status === 0">
            <a @click="editRecord(record)" v-if="permission.fire_plan_edit">编辑</a>
            <a-divider type="vertical" v-if="permission.fire_plan_edit"/>
            <a @click="publishRecord(record,1)" v-if="permission.fire_plan_publish">派发</a>
            <a-divider type="vertical" v-if="permission.fire_plan_publish"/>
            <a @click="removeRecord(record)" v-if="permission.fire_plan_delete">删除</a>
          </template>
          <template v-if="record.status === 1">
            <a @click="publishRecord(record,0)" v-if="userInfo.id === record.chargerId || permission.fire_plan_recall">撤回</a>
            <a-divider type="vertical" v-if="userInfo.id === record.chargerId || permission.fire_plan_recall"/>
            <a @click="viewRecord(record)">查看</a>
          </template>
        </span>
        <template slot="type" slot-scope="text, record">
          <span>{{planTypeOptions[record.type].dictValue}}</span>
        </template>
        <template slot="statusName" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0!important;">{{record.status | textFilter}}</a-tag>
        </template>
      </s-table>
    </a-card>
    <fire-plan-modal
      :title="planModalTitle"
      :visible.sync="planModalVisible"
      :is-edit="isEdit"
      :equipment-param="equipmentData"
      :query-param="queryParamItem"
      @ok="modalOk"
    >
    </fire-plan-modal>
    <a-card :bordered="false" style="margin: 15px" v-if="false" :bodyStyle="{padding: 0}">
      <fire-plan-item
        :is-edit="isEdit"
        :equipment-param="equipmentData"
        :query-param="queryParamItem"
        @cancel="() => {this.isItemShow = false}"
        @ok="createdOk"
      ></fire-plan-item>
    </a-card>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import { getStore } from '@/utils/store'
import { firePlanColumns } from '@/views/safety/fire/columns'
import FireApi from '@/api/fire'
import FirePlanItem from '@/views/safety/fire/FirePlanItem'
import Technology from '@/views/emergency/agency/technology'
import FirePlanModal from '@/views/safety/fire/FirePlanModal'
import { mapGetters } from 'vuex'

export default {
  name: 'firePlan',
  components: {
    Technology,
    STable,
    FirePlanItem,
    FirePlanModal
  },
  data () {
    return {
      queryParam: {
        planName: '',
        planType: undefined,
        planStartDate: '',
        planEndDate: ''
      },
      searchTime: '',
      selectedRowKeys: [],
      selectedRows: [],
      userInfo: getStore({ name: 'info'}),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true,
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(FireApi.firePlanList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true,
          }
          return data
        })
      },
      planTypeOptions: [],
      isItemShow: false,
      queryParamItem: {},
      equipmentData: [],
      isEdit: true,
      planModalVisible: false,
      planModalTitle: ''
    }
  },
  created () {
    this.getDict('FIRE_CHECK_PLAN_TYPE').then(({ data, success}) => {
      if(success) {
        this.planTypeOptions = data
      }
    })
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => firePlanColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function (value) {
      const colorList = ['orange', 'green']
      return colorList[value]
    },
    textFilter: function (value) {
      const textList = ['待派发', '已派发']
      return textList[value]
    }
  },
  methods: {
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    onTimeChange (value, dateString) {
      this.queryParam.planStartDate = dateString[0]
      this.queryParam.planEndDate = dateString[1]
    },
    search () {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset () {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam () {
      this.queryParam = {
        planName: '',
        planType: '',
        planStartDate: '',
        planEndDate: ''
      }
      this.searchTime = ''
    },
    addRecord () {
      this.queryParamItem = {
        organizationalUnitId: this.userInfo.deptId,
        organizationalUnit: this.userInfo.deptName,
        checkUnitId: this.userInfo.deptId,
        checkUnit: this.userInfo.deptName,
        name: null,
        type: undefined,
        searchTime: null,
        chargerId: undefined
      }
      this.equipmentData = []
      this.isEdit = false
      this.planModalTitle = '新增数据'
      this.planModalVisible = true
      // this.isItemShow = true
    },
    editRecord (record) {
      this.isEdit = false
      this.getById(FireApi.firePlan, record.id).then(({ data, success}) => {
        if(success) {
          data.type = data.type + ''
          this.equipmentData = data.planEquipmentList
          data.searchTime = [data.startDate,data.endDate]
          delete data.planEquipmentList
          delete data.startDate
          delete data.endDate
          this.queryParamItem = data
          this.planModalTitle = '编辑数据'
          this.planModalVisible = true
          // this.isItemShow = true
        }
      })
    },
    viewRecord (record) {
      this.isEdit = true
      this.getById(FireApi.firePlan, record.id).then(({ data, success}) => {
        if(success) {
          data.type = data.type + ''
          this.equipmentData = data.planEquipmentList
          data.searchTime = [data.startDate,data.endDate]
          delete data.planEquipmentList
          delete data.startDate
          delete data.endDate
          this.queryParamItem = data
          this.planModalTitle = '查看数据'
          this.planModalVisible = true
          // this.isItemShow = true
        }
      })
    },
    removeRecord (record) {
      this.showDeleteConfirm(record.id)
    },
    showDeleteConfirm (params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk () {
          _this.deleteByIds(FireApi.firePlan + `?id=${params}`, null).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.table.refresh()
              _this.$refs.table.clearSelected()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel () {
          console.log('Cancel')
        }
      })
    },
    publishRecord (record, status) {
      const params = {
        id: record.id,
        status: status
      }
      this.submitForm(FireApi.firePlan, params, 'put').then(({ success }) => {
        if(success) {
          this.$message.success('操作成功')
          this.initQueryParam()
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
        }
      })
    },
    async createdOk () {
      await this.$refs.plan.save()
    },
    modalOk () {
      this.planModalVisible = false
      this.initQueryParam()
      this.$refs.table.refresh()
      this.$refs.table.clearSelected()
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
</style>
