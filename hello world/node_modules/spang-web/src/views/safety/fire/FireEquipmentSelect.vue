<template>
  <a-modal
    :title="title"
    :bodyStyle="{maxHeight:'600px',overflow:'auto',paddingTop: '5px'}"
    width="70%"
    :visible="visible"
    @cancel="modalCancel"
    :keyboard="false"
    :maskClosable="false"
  >
    <template slot="footer">
      <a-button @click="modalCancel">取消</a-button>
      <a-button type="primary" @click="modalOk" :disabled="!selectedRowKeys.length">确认</a-button>
    </template>
    <div class="table-page-search-wrapper" style="margin: 10px 0 20px">
      <a-form layout="inline">
        <a-row :gutter="24">
          <a-col :md="6">
            <a-form-item label="消防器材名称">
              <a-input v-model="queryParam.name"/>
            </a-form-item>
          </a-col>
          <a-col :md="6">
            <a-form-item label="类型">
              <a-select
                show-search
                v-model="queryParam.type"
                style="width: 100%"
                :filter-option="filterOption"
                option-filter-prop="children"
              >
                <a-select-option v-for="d in equipmentTypeOptions" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset" style="margin-left: 10px">重置</a-button>
              </span>
          </a-col>
        </a-row>
      </a-form>
    </div>
    <div>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :rowSelection="rowSelection"
      >
        <span slot="number" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <template slot="statusName" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0!important;">{{text}}</a-tag>
        </template>
      </s-table>
    </div>
  </a-modal>
</template>

<script>
import FireApi from '@/api/fire'
import { STable } from '@/components'

export default {
  name: 'FireEquipmentSelect',
  components: {
    STable
  },
  data () {
    return {
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true,
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(FireApi.fireEquipmentList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true,
          }
          return data
        })
      },
      columns:[
        {
          title: '序号',
          dataIndex: 'number',
          width: '60px',
          align: 'center',
          scopedSlots: { customRender: 'number' }
        },
        {
          title: '编号',
          dataIndex: 'number',
          width: '140px',
          align: 'center',
          ellipsis: true
        },
        {
          title: '消防器材名称',
          dataIndex: 'name',
          width: '150px',
          align: 'center',
          ellipsis: true
        },
        {
          title: '规格型号',
          dataIndex: 'models',
          width: '150px',
          align: 'center',
          ellipsis: true
        },
        {
          title: '位置',
          dataIndex: 'address',
          width: '180px',
          align: 'center',
          ellipsis: true
        },
        {
          title: '有效截止日期',
          dataIndex: 'expirationDate',
          width: '150px',
          align: 'center'
        },
        {
          title: '状态',
          dataIndex: 'statusName',
          width: '80px',
          align: 'center',
          scopedSlots: { customRender: 'statusName' }
        }
      ],
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      equipmentTypeOptions: []
    }
  },
  props: {
    visible: {
      type: Boolean,
      default: false
    },
    title: {
      type: String,
      default: '消防器材列表'
    }
  },
  created () {
    this.getDict('FIRE_TYPE').then(({ data, success}) => {
      if(success) {
        this.equipmentTypeOptions = data
      }
    })
  },
  filters: {
    colorFilter: function (value) {
      const colorList = ['green', 'orange']
      return colorList[value]
    }
  },
  watch: {
    visible: {
      handler: function (value) {
        if(value) {
          this.queryParam = {}
          this.$refs.table.refresh(true)
          this.$refs.table.clearSelected()
          // this.loadData()
        }
      }
    }
  },
  computed: {
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    search () {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset () {
      this.queryParam = {}
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    modalOk () {
      this.$emit('ok', { values: this.selectedRows})
    },
    modalCancel () {
      this.$emit('cancel')
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-card-head-title {
  font-weight: bolder;
  padding: 0 !important;
}

/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
</style>
