<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8" :sm="12" :xs="24">
              <a-form-item label="消防器材名称">
                <a-input v-model="queryParam.name" maxlength="32" placeholder="消防器材名称" />
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="12" :xs="24">
              <a-form-item label="类型">
                <a-select
                  show-search
                  v-model="queryParam.type"
                  style="width: 100%"
                  :filter-option="filterOption"
                  option-filter-prop="children"
                   placeholder="类型"
                >
                  <a-select-option
                    v-for="d in equipmentTypeOptions"
                    :key="d.dictKey"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #extra>
        <a-button
          type="primary"
          icon="plus"
          @click="addRecord"
          v-if="permission.fire_equipment_add"
        >新建</a-button>
      </template>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{ y: `calc(100vh - 432px)`, x: 1230 }"
        showPagination="true"
      >
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="editRecord(record)" v-if="permission.fire_equipment_edit">编辑</a>
            <a-divider type="vertical" v-if="permission.fire_equipment_edit" />
            <a @click="viewRecord(record)">查看</a>
            <a-divider type="vertical" v-if="permission.fire_equipment_delete" />
            <a @click="removeRecord(record)" v-if="permission.fire_equipment_delete">删除</a>
          </template>
        </span>
        <template slot="statusName" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">{{ text }}</a-tag>
        </template>
      </s-table>
      <common-form-modal
        ref="modal"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        width="700px"
        @ok="modalOk"
      />
    </a-card>
    <descriptions-modal :title="查看数据" :visible.sync="detailVisible" :records="detailData">
      <template slot="basicInfo-head">
        <div class="info-title">
          <span>器材基本信息</span>
        </div>
        <a-divider />
      </template>
      <template slot="extra-content">
        <div class="info-title">
          <span>检查历史</span>
        </div>
        <a-divider />
        <div style="margin-top: 10px">
          <a-table
            bordered
            :pagination="false"
            size="small"
            class="historyTable"
            :data-source="dataSource"
            :columns="historyColumns"
          ></a-table>
        </div>
      </template>
    </descriptions-modal>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import { getStore } from '@/utils/store'
import { getDict } from '@/api/system'
import { fireEquipmentColumns } from '@/views/safety/fire/columns'
import FireApi from '@/api/fire'
import DescriptionsModal from '@/views/safety/components/DescriptionsModal'
import { mapGetters } from 'vuex'

export default {
  name: 'fireEquipment',
  components: {
    STable,
    CommonFormModal,
    DescriptionsModal
  },
  data() {
    return {
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
        name: '',
        type: undefined
      },
      selectedRowKeys: [],
      selectedRows: [],
      userInfo: getStore({ name: 'info' }),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(FireApi.fireEquipmentList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      rules: [
        {
          type: 'input',
          title: '器材名称',
          field: 'name',
          props: {
            maxLength: 32,
            placeholder: '请输入器材名称'
          },
          validate: [
            {
              required: true,
              message: '请输入器材名称',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          title: '器材编号',
          field: 'number',
          props: {
            maxLength: 32,
            placeholder: '请输入器材编号'
          },
          validate: [
            {
              required: true,
              message: '请输入器材编号',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'select',
          title: '器材类型',
          field: 'type',
          options: [],
          props: {
            placeholder: '请选择器材类型'
          },
          validate: [
            {
              required: true,
              message: '请选择器材类型',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          title: '位置信息',
          field: 'address',
          props: {
            maxLength: 32,
            placeholder: '请输入位置信息'
          },
          validate: [
            {
              required: true,
              message: '请输入位置信息',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          title: '规格型号',
          field: 'models',
          props: {
            maxLength: 32,
            placeholder: '请输入规格型号'
          },
          validate: [
            {
              required: true,
              message: '请输入规格型号',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          title: '数量',
          field: 'quantity',
          props: {
            min: 0,
            max: 1,
            type: 'number',
            placeholder: '请输入数量'
          },
          validate: [
            {
              required: true,
              message: '请输入数量',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'PersonListSelect',
          title: '责任人',
          field: 'chargePersonId',
          props: {
            placeholder: '请选择责任人'
          },
          on: {
            change: ({ person }) => {
              this.commonData.chargePerson = person.realName
            }
          },
          validate: [
            {
              required: true,
              message: '请选择责任人',
              trigger: true
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'DatePicker',
          title: '有效截止日期',
          field: 'expirationDate',
          props: {
            showTime: true,
            format: 'YYYY-MM-DD HH:mm:ss',
            placeholder: '有效截止日期'
          },
          validate: [
            {
              required: true,
              message: '请选择有效截止日期'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'select',
          title: '状态',
          field: 'status',
          options: [],
          props: {
            placeholder: '请选择状态'
          },
          validate: [
            {
              required: true,
              message: '请选择状态'
            }
          ],
          on: {
            change: value => {
              console.log(value)
              this.commonData.statusName = this.equipmentStatusOptions[value - 1].dictValue
            }
          },
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          title: '说明',
          field: 'explain',
          props: {
            maxLength: 255,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          validate: [
            {
              required: false,
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        }
      ],
      equipmentTypeOptions: [],
      equipmentStatusOptions: [],
      equipmentHistoryList: [],
      detailVisible: false,
      detailData: [],
      dataSource: [
        {
          time: '2021-09-02 11:32:40',
          result: '正常',
          explain: ''
        },
        {
          time: '2021-09-03 15:32:10',
          result: '正常',
          explain: ''
        },
        {
          time: '2021-09-04 16:52:50',
          result: '异常',
          explain: '丢失'
        }
      ],
      historyColumns: [
        {
          title: '检查日期',
          dataIndex: 'examineTime',
          width: '30%',
          align: 'center'
        },
        {
          title: '检查结果',
          dataIndex: 'examineResult',
          align: 'center'
        },
        {
          title: '检查说明',
          dataIndex: 'description',
          align: 'center'
        }
      ]
    }
  },
  created() {
    getDict('FIRE_TYPE').then(({ data, success }) => {
      if (success) {
        this.equipmentTypeOptions = data
        this.rules[2].options = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
      }
    })
    getDict('FIRE_STATUS').then(({ data, success }) => {
      if (success) {
        this.equipmentStatusOptions = data
        this.rules[8].options = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
      }
    })
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => fireEquipmentColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['green', 'orange']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['已处理', '待处理']
      return textList[value]
    }
  },
  methods: {
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam() {
      this.queryParam = {
        name: '',
        type: ''
      }
    },
    commonInit() {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      this.initFormData()
    },
    initFormData() {
      this.commonData = {
        address: null,
        chargePersonId: undefined,
        expirationDate: null,
        explain: null,
        models: null,
        name: null,
        number: null,
        quantity: undefined,
        status: undefined,
        type: undefined
      }
    },
    addRecord(record) {
      this.commonTitle = '新增数据'
      this.initFormData()
      this.commonVisible = true
      this.commonDisabled = false
      this.$refs.modal.fApi.disabled(true, 'reportPerson')
    },
    modalOk({ formData }) {
      let method = ''
      if (this.isNotNullOrUndefined(this.commonData.id)) {
        method = 'put'
        formData.id = this.commonData.id
      } else {
        method = 'post'
      }
      const params = {
        ...this.commonData,
        ...formData
      }
      this.submitForm(FireApi.fireEquipment, params, method).then(({ success }) => {
        if (success) {
          this.$message.success('操作成功')
          this.initQueryParam()
          this.commonInit()
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
        }
      })
    },
    editRecord(record) {
      this.commonTitle = '编辑数据'
      this.getById(FireApi.fireEquipment, record.id).then(({ data, success }) => {
        if (success) {
          data.type = data.type + ''
          data.status = data.status + ''
          delete data.examineRecordList
          this.commonData = data
          this.commonVisible = true
        }
      })
    },
    viewRecord(record) {
      this.commonTitle = '查看数据'
      this.getById(FireApi.fireEquipment, record.id).then(({ data, success }) => {
        if (success) {
          this.detailData = [
            {
              label: '器材名称',
              value: data.name
            },
            {
              label: '器材编号',
              value: data.number
            },
            {
              label: '器材类型',
              value: data.typeName
            },
            {
              label: '位置信息',
              value: data.address
            },
            {
              label: '规格型号',
              value: data.models
            },
            {
              label: '数量',
              value: data.quantity
            },
            {
              label: '责任人',
              value: data.chargePerson
            },
            {
              label: '有效截止日期',
              value: data.expirationDate
            },
            {
              label: '状态',
              value: data.statusName
            },
            {
              label: '说明',
              value: data.explain
            }
          ]
          this.dataSource = data.examineRecordList
          this.detailVisible = true
        }
      })
    },
    removeRecord(record) {
      this.showDeleteConfirm(record.id)
    },
    showDeleteConfirm(params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.deleteByIds(FireApi.fireEquipment + `?id=${params}`, null).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.table.refresh()
              _this.$refs.table.clearSelected()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}

.info-title {
  font-size: 16px;
  color: blue;

  span {
    margin-right: 10px;
  }
}

/deep/ .ant-divider-horizontal {
  margin: 7px 0;
}

.historyTable {
  /deep/.ant-table-body {
    margin: 0 !important;
  }
}

/deep/.ant-calendar-picker {
  width: 100%;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 106px;
}
</style>
