<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :bodyStyle="{height: `calc(100vh - 156px)`}">
      <form-create
        v-model="fapi"
        :rule="rule"
        :option="option"
        :value="formData"
      >

      </form-create>
      <div style="text-align: right">
        <a-button type="primary" @click="onSubmit" v-if="permission.company_info_save">保存</a-button>
      </div>
    </a-card>
  </page-container>
</template>

<script>
  import PROVINCE_CITY from './province-city'
  import ApiURLs from '@/api/urls'
  import { isPhone, isvalidatemobile } from '@/utils/validate'
  import { mapGetters } from 'vuex'
  export default {
    name: 'CompanyInfo',
    data () {
      return {
        formData: {},
        fapi: null,
        rule: [
          {
            'type': 'FcRow',
            'children': [
              {
                'type': 'col',
                'props': {
                  'span': 24,
                  'offset': 0,
                  'push': 0,
                  'pull': 0
                },
                'children': [
                  {
                    'type': 'input',
                    'field': 'companyName',
                    'title': ' 企业名称',
                    'info': '',
                    'props': {
                      'placeholder': ' 请输入企业名称',
                      maxLength: 32
                    },
                    'validate': [
                      {
                        'trigger': 'blur',
                        'mode': 'required',
                        'message': ' 请输入企业名称',
                        'required': true,
                        'type': 'string'
                      }
                    ]
                  }
                ]
              },
              {
                'type': 'col',
                'props': {
                  'span': 24,
                  'offset': 0,
                  'push': 0,
                  'pull': 0
                },
                'children': [
                  {
                    'type': 'input',
                    'field': 'socialCode',
                    'title': '统一社会信用代码',
                    'info': '',
                    'props': {
                      'placeholder': '请输入统一社会信用代码',
                      maxLength: 32
                    },
                    'validate': [
                      {
                        'trigger': 'blur',
                        'mode': 'required',
                        'message': '请输入统一社会信用代码',
                        'required': true,
                        'type': 'string'
                      }
                    ]
                  }
                ]
              },
              {
                'type': 'col',
                'props': {
                  'span': 24,
                  'offset': 0,
                  'push': 0,
                  'pull': 0
                },
                'children': [
                  {
                    'type': 'cascader',
                    'field': 'provincesCities',
                    'title': '省市',
                    'props': {
                      placeholder: '请选择省市',
                      'options': PROVINCE_CITY
                    },
                    'validate': [
                      {
                        'trigger': 'blur',
                        'mode': 'required',
                        'message': '请选择省市',
                        'required': true,
                        'type': 'array'
                      }
                    ]
                  }
                ]
              },
              {
                'type': 'col',
                'props': {
                  'span': 24,
                  'offset': 0,
                  'push': 0,
                  'pull': 0
                },
                'children': [
                  {
                    'type': 'input',
                    'field': 'address',
                    'title': '详细地址',
                    'info': '',
                    'props': {
                      'placeholder': '请输入详细地址',
                      maxLength: 32
                    },
                    'validate': [
                      {
                        'trigger': 'blur',
                        'mode': 'required',
                        'message': '请输入详细地址',
                        'required': true,
                        'type': 'string'
                      }
                    ]
                  }
                ]
              },
              {
                'type': 'col',
                'props': {
                  'span': 12,
                  'offset': 0,
                  'push': 0,
                  'pull': 0
                },
                'children': [
                  {
                    'type': 'input',
                    'field': 'legalPerson',
                    'title': '法人名称',
                    'info': '',
                    'props': {
                      'placeholder': '请输入法人名称',
                      maxLength: 32
                    },
                    'validate': [
                      {
                        'trigger': 'blur',
                        'mode': 'required',
                        'message': '请输入法人名称',
                        'required': true,
                        'type': 'string'
                      }
                    ],
                    wrap: {
                      labelCol: { span: 6 },
                      wrapperCol: { span: 16 }
                    }
                  }
                ]
              },
              {
                'type': 'col',
                'props': {
                  'span': 12
                },
                'children': [
                  {
                    'type': 'input',
                    'field': 'legalPersonContact',
                    'title': '法人联系方式',
                    'info': '',
                    'props': {
                      'placeholder': '请输入法人联系方式',
                      maxLength: 32
                    },
                    'validate': [
                      {
                        required: false,
                        validator: (rule, value, callback) => {
                          if (!value) {
                            callback(new Error('请输入联系电话'))
                          } else if (!isPhone(value) && (isvalidatemobile(value)[0])) {
                            callback(new Error('请输入正确的联系电话'))
                          } else {
                            callback()
                          }
                        },
                        trigger: 'change'
                      }
                    ]
                  }
                ]
              },
              {
                'type': 'col',
                'props': {
                  'span': 24,
                  'offset': 0,
                  'push': 0,
                  'pull': 0
                },
                'children': [
                  {
                    'type': 'input',
                    'field': 'companyProfile',
                    'title': '企业简介',
                    'info': '',
                    'props': {
                      'type': 'textarea',
                        autoSize: { minRows: 5, maxRows: 10 },
                      'placeholder': '请输入企业简介',
                      maxLength: 256
                    },
                    'validate': [
                      {
                        'trigger': 'blur',
                        'mode': 'required',
                        'message': '请输入企业简介',
                        'required': true,
                        'type': 'string'
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    },
    computed: {
      ...mapGetters(['permission']),
      option () {
        return {
          submitBtn: false,
          resetBtn: false,
          global: {
            '*': {
              props: {
                disabled: !this.permission.company_info_save
              }
            }
          }
        }
      }
    },
    methods: {
      onSubmit () {
        this.fapi.submit((formData, fApi) => {
          const method = this.formData.id ? 'put' : 'post'
          const params = {
            id: this.formData.id,
            ...formData,
            provincesCities: formData.provincesCities.join(',')
          }
          this.submitForm(ApiURLs.companyInfo, params, method).then(({ success }) => {
            this.$message.success('保存成功')
          })
        })
      }
    },
    created () {
      this.getList(ApiURLs.companyInfo).then(({ data, success }) => {
        if (success) {
          data.provincesCities = data.provincesCities.split(',')
          this.formData = data
        }
      })
    }
  }
</script>

<style scoped lang="less">
/deep/.ant-card-body {
  height: calc(100vh - 300px);
}
</style>
