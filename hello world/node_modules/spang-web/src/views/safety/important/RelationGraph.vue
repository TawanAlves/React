<template>
  <div style="padding-top: 10px;">
    <a-row :gutter="16">
      <a-col :span="12">
        <a-card :bordered="true">
          <div id="container" style="width: 100%; height: 100%"></div>
          <div class="g6-tooltip" id="g6Tooltip"></div>
        </a-card>
      </a-col>
      <a-col :span="12">
        <a-card :bordered="true">

          <a-descriptions title="企业信息" bordered :column="2" style="height: 100%; overflow-y: auto">
            <a-descriptions-item label="企业名称">
              {{ detailInfo.companyName }}
            </a-descriptions-item>
            <a-descriptions-item label="统一社会信用代码">
              {{ detailInfo.socialCode }}
            </a-descriptions-item>
            <a-descriptions-item label="省市">
              {{ detailInfo.provincesCities }}
            </a-descriptions-item>
            <a-descriptions-item label="详细地址">
              {{ detailInfo.address }}
            </a-descriptions-item>
            <a-descriptions-item label="法人名称">
              {{ detailInfo.legalPerson }}
            </a-descriptions-item>
            <a-descriptions-item label="法人联系方式">
              {{ detailInfo.legalPersonContact }}
            </a-descriptions-item>
            <a-descriptions-item label="企业简介">
              <div class="company-profile" :title="detailInfo.companyProfile">
                {{ detailInfo.companyProfile }}
              </div>

            </a-descriptions-item>
          </a-descriptions>

        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script>
  import G6 from '@antv/g6'
  import ApiURLs from '@/api/urls'

  const globalFontSize = 12

  /**
   * format the string
   * @param {string} str The origin string
   * @param {number} maxWidth max width
   * @param {number} fontSize font size
   * @return {string} the processed result
   */
  const fittingString = (str, maxWidth, fontSize) => {
    const ellipsis = '...'
    const ellipsisLength = G6.Util.getTextSize(ellipsis, fontSize)[0]
    let currentWidth = 0
    let res = str
    const pattern = new RegExp('[\u4E00-\u9FA5]+') // distinguish the Chinese charactors and letters
    str.split('').forEach((letter, i) => {
      if (currentWidth > maxWidth - ellipsisLength) return
      if (pattern.test(letter)) {
        // Chinese charactors
        currentWidth += fontSize
      } else {
        // get the width of single letter according to the fontSize
        currentWidth += G6.Util.getLetterWidth(letter, fontSize)
      }
      if (currentWidth > maxWidth - ellipsisLength) {
        res = `${str.substr(0, i)}${ellipsis}`
      }
    })
    return res
  }

  export default {
    name: 'RelationGraph',
    components: {},
    props: {
      id: {
        type: String,
        default: null
      },
      detailType: {
        type: Number,
        default: 3
      }
    },
    data () {
      return {
        detailInfo: {},
        g6Chart: null
      }
    },
    created () {
      this.getList(ApiURLs.companyInfo).then(({ data, success }) => {
        if (success) {
          data.provincesCities = data.provincesCities.split(',').join('-')
          this.detailInfo = data
        }
      })
    },
    mounted () {
      this.initG6Chart()
      this.setG6ChartData()
    },
    beforeDestory () {
      this.g6Chart.destroy()
      this.g6Chart = null
    },
    methods: {
      initG6Chart () {
        const width = document.getElementById('container').scrollWidth || 700
        const height = document.getElementById('container').scrollHeight || 700
        this.g6Chart = new G6.TreeGraph({
          container: 'container',
          width,
          height,
          linkCenter: true,
          fitView: true,
          modes: {
            default: [
              'drag-canvas',
              'zoom-canvas',
              {
                type: 'tooltip',
                 formatText: (model) => {
                    if (model.depth !== 2) {
                      return model.mainName
                    }
                    return null
                 }
              }
            ]
          },
          defaultNode: {
            size: 26,
            style: {
              fill: '#C6E5FF',
              stroke: '#fff'
            }
          },
          defaultEdge: {
            style: {
              stroke: '#d9d9d9',
              lineWidth: 1
            }
          },
          layout: {
            type: 'dendrogram',
            direction: 'LR',
            nodeSep: 20,
            rankSep: 150,
            radial: true,
            preventOverlap: true
          },
          // 节点不同状态下的样式集合
          nodeStateStyles: {
            // 鼠标 hover 上节点，即 hover 状态为 true 时的样式
            hover: {
              // fill: 'lightsteelblue'
              stroke: '#1890FF',
              lineWidth: 2
            },
            // 鼠标点击节点，即 click 状态为 true 时的样式
            click: {
              stroke: '#1890FF',
              lineWidth: 2
            }
          },
          // 边不同状态下的样式集合
          edgeStateStyles: {
            // 鼠标点击边，即 click 状态为 true 时的样式
            click: {
              stroke: 'steelblue'
            }
          }
        })
        const data = {
          id: 0,
          mainName: '天元化工'
        }

        this.g6Chart.node(function (node) {
          var color, size
          if (node.depth === 0) {
            color = '#e37832'
            size = 120
          }
          if (node.depth === 1) {
            size = 80
            if (node.id === 1) {
               color = '#f3cd52'
            } else if (node.id === 2) {
              color = '#4886e0'
            } else if (node.id === 3) {
              color = '#49a360'
            }
          }
          if (node.depth === 2) {
            size = 70
            if (node.parentId === 1) {
               color = '#f9dfba'
            } else if (node.parentId === 2) {
              color = '#9ccef4'
            } else if (node.parentId === 3) {
              color = '#87E897'
            }
          }
          return {
            label: fittingString(node.mainName, size, globalFontSize),
            labelCfg: {
              // position: 'bottom',
              offset: 10,
              style: {
                // fill: '#666',
                fill: '#000',
                fontSize: globalFontSize,
                fontWeight: 10
              }
            },
            style: { fill: color, stroke: null },
            size: size
          }
        })
        this.g6Chart.data(data)
        this.g6Chart.render()
        this.g6Chart.on('node:mouseenter', e => {
          const nodeItem = e.item
          const tooltip = document.getElementById('g6Tooltip')
          if (nodeItem._cfg.model.depth === 0 || nodeItem._cfg.model.depth === 1) {
            tooltip.style.display = 'none'
          } else {
            this.getById(ApiURLs.important, nodeItem._cfg.model.id).then(({ success, data }) => {
              let tooltipContent = `<div><span>名称:</span>${nodeItem._cfg.model.mainName}</div>`
              if (success) {
                tooltipContent = `
                                <div><span>名称:</span>${nodeItem._cfg.model.mainName}</div>
                                <div><span>类型:</span>${data.typeName}</div>
                                <div><span>级别:</span>${data.levelName}</div>
                                <div><span>区域位置:</span>${data.areaLocation}</div>
                                <div><span>档案信息:</span>${data.archvieInfo}</div>
                              `
              }
              tooltip.style.left = (e.canvasX + 35) + 'px'
              tooltip.style.top = (e.canvasY + 35) + 'px'
              tooltip.innerHTML = tooltipContent
              tooltip.style.display = 'block'
            })
          }
        })
        this.g6Chart.on('node:mouseleave', e => {
          const tooltip = document.getElementById('g6Tooltip')
          tooltip.style.display = 'none'
        })
      },
      setG6ChartData () {
        this.getList(ApiURLs.importantTree).then(({ data, success }) => {
          if (success) {
            const treeData = {
              id: 0,
              mainName: '天元化工',
              children: data
            }
            this.g6Chart.changeData(treeData)
          }
        })
      }
    }
  }
</script>

<style lang="less" scoped>
  .g6-tooltip {
    /*width: 500px;*/
    /*height: 500px;*/
    position: absolute;
    display: none;
    border: 1px solid #e2e2e2;
    border-radius: 4px;
    font-size: 12px;
    color: #545454;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px 8px;
    box-shadow: rgb(174, 174, 174) 0px 0px 10px;
  }

  /deep/ .g6-tooltip span {
    font-weight: 600;
    margin-right: 3px;
  }

  /deep/ .ant-card-body {
    height: calc(100vh - 249px);
  }

  /deep/ .ant-descriptions-bordered .ant-descriptions-item-label {
    width: 163px;
  }

  .company-profile {
    /*overflow-y: auto;*/
    /*max-height: 284px;*/
    white-space: break-spaces;
  }
</style>
