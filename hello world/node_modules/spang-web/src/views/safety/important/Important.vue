<template>
  <div>
    <a-row :gutter="12" style="margin-top: 2px">
      <a-col :span="4" style="padding-right: 1px!important;">
        <a-card
          :bordered="false"
          :body-style="{'padding-bottom': '0px', 'padding-top': '0', 'margin-top': '24px', 'border-right': '1px solid #e8e8e8'}"
        >
          <a-button type="primary" style="margin-left: 23px;" @click="addNode" v-if="false">添加节点</a-button>
          <a-tree
            class="left-tree"
            :tree-data="treeData"
            :expanded-keys="expandedKeys"
            :auto-expand-parent="autoExpandParent"
            :default-expand-all="true"
            @expand="onExpand"
            @select="OnSelect"
            :replaceFields="replaceFields"
          ></a-tree>
        </a-card>
      </a-col>
      <a-col :span="20" style="padding-left: 1px!important;">
        <a-card :bordered="false" :body-style="{'padding-bottom': '0px'}">
          <div class="table-page-search-wrapper" style="margin-bottom: 10px;">
            <a-form layout="inline">
              <a-row :gutter="24">
                <a-col :md="12" :sm="24" :xs="24">
                  <a-form-item label="名称">
                    <a-input v-model="queryParam.mainName" placeholder="名称" />
                  </a-form-item>
                </a-col>
                <a-col :md="12" :sm="24" :xs="24" class="table-page-search-submitButtons">
                  <a-space>
                    <a-button
                      type="primary"
                      style="margin-right: 4px;"
                      @click="personnelResearch()"
                    >查询</a-button>
                    <a-button @click="personnelRefresh()">重置</a-button>
                  </a-space>
                </a-col>
              </a-row>

            </a-form>
          </div>
            <a-row :gutter="24" class="text-right" style="margin-bottom: 15px;">
                <a-col>
                  <a-button
                    type="primary"
                    @click="addTableData"
                    icon="plus"
                    v-if="permission.important_add"
                  >新建</a-button>
                </a-col>
              </a-row>
          <s-table
            ref="personnelTable"
            size="default"
            :rowKey="record => record.id"
            :columns="columns"
            :data="loadData"
            :alert="false"
            :rowSelection="false"
            showPagination="true"
            :scroll="{y:`calc(100vh - 495px)`, x: 940}"
            :pagination="pagination"
          >
            <span
              slot="serial"
              slot-scope="text, record, index"
            >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
            <span slot="action" slot-scope="text, record">
              <template>
                <a
                  @click="publishRecord(record, 1)"
                  v-if="record.status !== 1 && permission.important_publish"
                >发布</a>
                <a
                  @click="publishRecord(record, 0)"
                  v-if="record.status === 1 && permission.important_recall"
                >撤回</a>
                <a-divider
                  type="vertical"
                  v-if="record.status === 1 && permission.important_recall"
                />
                <a @click="checkRecord(record)" v-if=" record.status === 1">查看</a>
                <a-divider
                  type="vertical"
                  v-if="record.status !== 1 && permission.important_edit "
                />
                <a
                  @click="personnelCheck(record)"
                  v-if=" record.status !== 1 && permission.important_edit"
                >编辑</a>
                <a-divider
                  type="vertical"
                  v-if="record.status !== 1 && permission.important_delete"
                />
                <a
                  @click="deleteTableRow(record)"
                  v-if=" record.status !== 1 && permission.important_delete"
                >删除</a>
              </template>
            </span>
          </s-table>
        </a-card>
      </a-col>
    </a-row>
    <common-form-modal
      ref="tableModal"
      width="700px"
      :modal-title="tableModalTitle"
      :visible.sync="tableModalVisible"
      :model="tableModalData"
      :rule="tableModalRules"
      :disabled="tableModalDisabled"
      @ok="submitAddTableData"
      :customCallback="customCallback"
    />
    <descriptions-modal :visible.sync="detailVisible" :records="detailDatas" title />
    <area-select-modal
      title="选择区域/位置"
      :visible.sync="areaModalVisible"
      @ok="selectArea"
      :defaultSelect="[tableModalData.areaLocationId]"
    />
  </div>
</template>

<script>
import { STable } from '@/components'
import { riskImportant } from '@/views/safety/table'
import STree from '@/components/Tree/Tree'
import ApiURLs from '@/api/urls'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import DepartmentSelect from '../components/DepartmentSelect'
import { mapGetters } from 'vuex'
import DescriptionsModal from '../components/DescriptionsModal'
import { isNotNullOrUndefined } from '@/utils/util'
import AreaSelectModal from '@/views/safety/components/AreaSelectModal'

const levelOptions = [
  {
    value: 1,
    label: '一级'
  },
  {
    value: 2,
    label: '二级'
  },
  {
    value: 3,
    label: '三级'
  },
  {
    value: 4,
    label: '四级'
  }
]
export default {
  name: 'Important',
  components: {
    STable,
    STree,
    CommonFormModal,
    DepartmentSelect,
    DescriptionsModal,
    AreaSelectModal
  },
  data() {
    return {
      pagination: {
        pageSize: 10,
        current: 1,
        showSizeChanger: true
      },
      areaModalVisible: false,
      onlyReloadTable: false,
      detailVisible: false,
      detailDatas: [],
      tableModalVisible: false,
      tableModalDisabled: false,
      tableModalData: {},
      tableModalTitle: '',
      replaceFields: Object.freeze({
        title: 'mainName',
        key: 'id',
        children: 'children',
        value: 'id'
      }),
      parentNodeName: '',
      treeData: [],
      expandedKeys: [],
      autoExpandParent: true,
      queryParam: { nodeId: undefined, parentType: undefined, mainName: undefined },
      loadData: parameter => {
        if (!this.onlyReloadTable) {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          Object.assign(requestParameters, this.queryParam)
          return this.getList(ApiURLs.importantAll, requestParameters).then(res => {
            const data = {}
            data.totalCount = res.data.twoAndOnePage.total
            data.totalPage = res.data.twoAndOnePage.pages
            data.pageNo = res.data.twoAndOnePage.current
            data.pageSize = res.data.twoAndOnePage.size
            data.data = res.data.twoAndOnePage.records
            this.treeData = res.data.twoAndOneTreeVOList
            this.expandedKeys = res.data.twoAndOneTreeVOList.map(item => item.id)
            this.pagination = { ...this.pagination, pageSize: data.pageSize, current: data.pageNo }
            return data
          })
        } else {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          Object.assign(requestParameters, this.queryParam, { id: this.queryParam.nodeId })
          if (!isNotNullOrUndefined(requestParameters.id)) {
            requestParameters.parentType = 1
          }
          delete requestParameters['nodeId']
          return this.getList(ApiURLs.importantTable, requestParameters).then(res => {
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            this.pagination = { ...this.pagination, pageSize: data.pageSize, current: data.pageNo }
            return data
          })
        }
      },
      selectedRowKeys: [],
      selectedRows: [],
      tableModalRules: [
        {
          type: 'FcRow',
          children: [
            {
              type: 'col',
              props: {
                span: 12,
                offset: 0,
                push: 0,
                pull: 0
              },
              children: [
                {
                  type: 'input',
                  field: 'mainName',
                  title: '名称',
                  info: '',
                  props: {
                    type: 'text',
                    placeholder: '请输入名称',
                    maxLength: 32
                  },
                  validate: [
                    {
                      trigger: 'blur',
                      mode: 'required',
                      message: '请输入名称',
                      required: true,
                      type: 'string'
                    }
                  ]
                }
              ]
            },
            {
              type: 'col',
              props: {
                span: 12,
                offset: 0,
                push: 0,
                pull: 0
              },
              children: [
                {
                  type: 'select',
                  field: 'typeId',
                  title: '类型',
                  info: '',
                  props: {
                    placeholder: '请选择类型'
                  },
                  options: [],
                  on: {
                    change: id => {
                      const options = this.$refs.tableModal.fApi.getRule('typeId').options
                      this.tableModalData.typeName = options.find(item => item.value === id).label
                    }
                  },
                  validate: [
                    {
                      trigger: 'blur',
                      message: '请选择类型',
                      required: true
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          type: 'FcRow',
          children: [
            {
              type: 'col',
              props: {
                span: 12,
                offset: 0,
                push: 0,
                pull: 0
              },
              children: [
                {
                  type: 'select',
                  field: 'levelId',
                  title: '级别',
                  props: {
                    placeholder: '请选择级别'
                  },
                  options: levelOptions,
                  on: {
                    change: id => {
                      const options = this.$refs.tableModal.fApi.getRule('levelId').options
                      this.tableModalData.levelName = options.find(item => item.value === id).label
                    }
                  }
                }
              ]
            },
            {
              type: 'col',
              props: {
                span: 12,
                offset: 0,
                push: 0,
                pull: 0
              },
              children: [
                {
                  type: 'col',
                  props: {
                    span: 20,
                    offset: 0,
                    push: 0,
                    pull: 0
                  },
                  children: [
                    {
                      type: 'input',
                      field: 'areaLocation',
                      title: '区域位置',
                      props: {
                        placeholder: '请选择区域位置',
                        disabled: true
                      },
                      wrap: {
                        labelCol: { span: 9 },
                        wrapperCol: { span: 14 }
                      },
                      validate: [
                        {
                          trigger: 'blur',
                          required: true,
                          validator: (rule, value, callback) => {
                            if (!this.isNotNullOrUndefined(value)) {
                              callback(new Error('请选择区域位置'))
                            } else {
                              callback()
                            }
                          }
                        }
                      ]
                    }
                  ]
                },
                {
                  type: 'col',
                  props: {
                    span: 4,
                    offset: 0,
                    push: 0,
                    pull: 0
                  },
                  children: [
                    {
                      type: 'a-button',
                      children: ['选择'],
                      props: {
                        type: 'primary'
                      },
                      on: {
                        click: () => {
                          this.areaModalVisible = true
                        }
                      },
                      style: {
                        marginTop: '3px'
                      }
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          type: 'PersonListSelect',
          field: 'dutyUserId',
          title: '安全管理责任人',
          options: [],
          on: {
            change: ({ person }) => {
              this.tableModalData.dutyUserName = person.realName
            }
          },
          props: {
            placeholder: '请选择安全管理责任人'
          },
          validate: [
            {
              trigger: 'blur',
              mode: 'required',
              message: '请选择安全管理责任人',
              required: true,
              type: 'string'
            }
          ]
        },
        {
          type: 'input',
          field: 'archvieInfo',
          title: '档案信息',
          props: {
            placeholder: '请输入档案信息',
            type: 'textarea',
            rows: 4,
            resize: 'none',
            maxLength: 256
          }
        }
      ]
    }
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => riskImportant,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectArea(row) {
      if (row) {
        this.tableModalData.areaLocationId = row.id
        this.tableModalData.areaLocation = row.areaLocation
        this.$refs.tableModal.fApi.setValue('areaLocation', row.areaLocation)
      }
    },
    customCallback(fApi) {
      fApi.disabled(true, 'areaLocation')
      fApi.getRule('typeId').options = this.treeData.map(item => ({
        label: item.mainName,
        value: item.id
      }))
    },
    OnSelect(selectedKeys, info) {
      this.queryParam.nodeId = selectedKeys[0]
      this.parentNodeName = info.node.dataRef.mainName
      this.onlyReloadTable = true
      this.expandedKeys = [...this.expandedKeys, ...selectedKeys]
      if (info.node.dataRef.children && info.node.dataRef.children.length > 0) {
        this.queryParam.parentType = 0
      } else {
        this.queryParam.parentType = 1
      }

      this.$refs.personnelTable.refresh(true)
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    personnelCheck(record) {
      this.tableModalData = { ...record }
      this.tableModalDisabled = false
      this.tableModalTitle = '编辑数据'
      this.tableModalVisible = true
    },
    checkRecord(record) {
      this.tableModalData = { ...record }
      this.tableModalDisabled = true
      this.tableModalTitle = '查看数据'
      this.tableModalVisible = true
    },
    personnelResearch() {
      this.onlyReloadTable = true
      this.$refs.personnelTable.refresh(true)
    },
    personnelRefresh() {
      this.onlyReloadTable = true
      this.queryParam.mainName = undefined
      this.$refs.personnelTable.refresh(true)
    },
    onExpand(expandedKeys) {
      // console.log('onExpand', expandedKeys)
      // if not set autoExpandParent to false, if children expanded, parent can not collapse.
      // or, you can remove all expanded children keys.
      this.expandedKeys = expandedKeys
      this.autoExpandParent = false
    },
    /**
     * 点击新建区域
     */
    addTableData() {
      // if (!this.isNotNullOrUndefined(this.queryParam.nodeId)) {
      //   this.$message.error('请先选择左侧树结点')
      //   return
      // }
      this.initTableModal()
      this.tableModalTitle = '新增数据'
      this.tableModalDisabled = false
      this.tableModalVisible = true
    },
    initTableModal() {
      this.tableModalData = {
        mainName: undefined,
        typeId: this.queryParam.nodeId,
        typeName: this.parentNodeName,
        levelId: undefined,
        levelName: undefined,
        areaLocation: undefined,
        areaLocationId: undefined,
        dutyUserId: undefined,
        dutyUserName: undefined,
        archvieInfo: undefined,
        id: undefined
      }
    },
    /**
     * 增加表格数据
     */
    submitAddTableData({ formData }) {
      let method = ''
      if (this.isNotNullOrUndefined(this.tableModalData.id)) {
        method = 'put'
        formData.id = this.tableModalData.id
      } else {
        method = 'post'
        formData.status = 0
      }
      const params = {
        ...formData,
        levelName: this.tableModalData.levelName,
        typeName: this.tableModalData.typeName,
        dutyUserName: this.tableModalData.dutyUserName,
        areaLocation: this.tableModalData.areaLocation,
        areaLocationId: this.tableModalData.areaLocationId,
        parentId: formData.typeId,
        parentType: 1
      }
      this.submitForm(ApiURLs.important, params, method)
        .then(res => {
          if (res.success) {
            this.onlyReloadTable = false
            this.tableModalVisible = false
            this.$message.success(`${res.msg}`)
            this.$refs.personnelTable.refresh()
          }
        })
        .catch(err => {
          this.$message.error(`${err.response.data.msg}`)
        })
    },
    deleteTableRow(record) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将要删除选中数据，是否确认',
        okText: '确认',
        okType: 'danger',
        cancelText: '取消',
        onOk() {
          _this.deleteByIds(ApiURLs.important, [record.id]).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.onlyReloadTable = true
              _this.$refs.personnelTable.refresh(true)
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    publishRecord(record, status) {
      const params = {
        id: record.id,
        status
      }
      this.submitForm(ApiURLs.importantUpdateStatus, null, 'put', { params: params }).then(({ success, data }) => {
        if (success) {
          this.$message.success('操作成功')
          this.onlyReloadTable = true
          this.$refs.personnelTable.refresh()
        }
      })
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  /*height: calc(100vh - 477px) !important;*/
  max-height: 700px;
  height: auto;
  overflow-y: auto;
}

.right-header {
  font-size: 16px;
  font-weight: 500;
}

.table-header {
  font-size: 20px;
  font-weight: 500;
  //line-height: 30px;
  //margin-bottom: 10px;
}

.ant-table-thead > tr > th {
  //color: #00A0E9;
  font-size: 16px;
  font-weight: bold;
  //align-items: center;
  //background-color: #e6f7ff;
}

.left-tree {
  height: calc(100vh - 314px);
  overflow-y: auto;
  overflow-x: hidden;

  &::-webkit-scrollbar {
    width: 5px;
    height: 1px;
  }

  &::-webkit-scrollbar-thumb {
    border-radius: 3px;
    //background: @primary-color;
    background-color: #fff;
  }

  &::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 1px rgba(0, 0, 0, 0);
    border-radius: 3px;
    //background: @primary-3;
    //background-color: #077ae8;
  }
}
</style>
