<template>
  <!-- 隐患排查管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="排查状态">
                <a-select style="width: 100%" v-model="queryParam.status" placeholder="排查状态">
                  <a-select-option v-for="s in checkStatusOptions" :key="s.value">
                    {{ s.label }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="计划名称">
                <a-input v-model="queryParam.name" placeholder="计划名称"></a-input>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="时间">
                <a-range-picker
                  v-model="dateOfInvestigation"
                  :valueFormat="dateFormat"
                  @change="dataChange"
                  style="width: 100%; min-width: 110px;"
                /> </a-form-item
            >
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="queryFormData"> 查询 </a-button>
                <a-button type="reset" @click="resetQueryForm"> 重置 </a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :scroll="{ x: 1230, y: `calc(100vh - 395px)` }"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :showIndexColumn="true"
      >
        <!-- 排查开始日期 -->
        <span slot="startTime" slot-scope="text, record">
          <template>
            {{ getTime(record.startTime) }}
          </template>
        </span>
        <!-- 排查结束日期 -->
        <span slot="endTime" slot-scope="text, record">
          <template>
            {{ getTime(record.endTime) }}
          </template>
        </span>
        <!-- 创建时间 -->
        <span slot="distributeTime" slot-scope="text, record">
          <template>
            {{ getTime(record.distributeTime) }}
          </template>
        </span>
        <!-- 状态  -->
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">
            {{ record.status | textFilter }}
          </a-tag>
        </template>
        <!-- 状态 end -->
        <!-- 排查人 checkPlanCheckPersonList -->
        <span slot="checkPlanCheckPersonList" slot-scope="text, record, index">
          <div v-for="(item, i) in record.checkPlanCheckPersonList" :key="index + item.checkPersonId + i">
            {{ item.checkPersonName }}
          </div>
        </span>
        <!-- 排查人 end -->
        <span slot="action" slot-scope="text, record">
          <template>
<!--            <a @click="view(record)" v-if="record.status == 1 && permission.checkoutManage_view">查看</a>-->
<!--            <a @click="check(record)" v-if="record.status == 0 && permission.checkoutManage_check">排查</a>-->
            <a @click="view(record)" v-if="record.status === 1">查看</a>
            <a @click="check(record)" v-if="record.status === 0">排查</a>
          </template>
        </span>
      </s-table>
    </a-card>

    <!-- 设备设施类 列表检查项 -->
    <a-modal
      :visible="facilityModalVisible"
      title="检查项"
      :width="900"
      @cancel="hidefacilityModal"
      :keyboard="false"
      :maskClosable="false"
      :scroll="{ y: `450px` }"
    >
      <template slot="footer">
        <a-button @click="hidefacilityModal">关闭</a-button>
      </template>
      <div style="height: 450px; overflow: auto">
        <a-table :columns="facilityColumns" :data-source="facilityModalData" bordered :pagination="false"> </a-table>
      </div>
    </a-modal>
    <!-- / 列表检查项 -->

    <!-- 打开作业活动类检 列表检查项 -->
    <a-modal
      :visible="opentaskModalVisible"
      title="检查项"
      :width="900"
      @cancel="hidetaskModal"
      :keyboard="false"
      :maskClosable="false"
      :scroll="{ y: `450px` }"
    >
      <template slot="footer">
        <a-button @click="hidetaskModal">关闭</a-button>
      </template>
      <div style="height: 450px; overflow: auto">
        <a-table :columns="taskColumns" :data-source="opentaskModalData" bordered :pagination="false"> </a-table>
      </div>
    </a-modal>
    <!-- / 列表检查项 -->

    <!-- 风险点选择 -->
    <risk-checkin-modal
      :model="checkinModel"
      :isNewReport="isNewReport"
      :visible="checkinModelVisible"
      @ok="okcheckinModel"
      @cancel="hidecheckinModel"
      :modalTitle="checkinModel && checkinModel.id ? '查看' : '登记'"
    />
    <!-- / 风险点选择 -->

    <!--  计划详情弹框 -->
    <a-modal
      :visible="modalVisible"
      :width="1100"
      :title="modalDisabled ? '查看数据' : '排查数据'"
      @ok="savePlan"
      @cancel="closeModal"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="closeModal">取消</a-button>
      </template>
      <div>
        <s-table
          ref="planDetailTable"
          :rowKey="(record) => record.id"
          :columns="columnsPotentialFactor"
          :data="loadDataPotential"
          :alert="false"
          :showPagination="false"
          style="height: 300px"
        >
          <span slot="checkItems" slot-scope="text, record">
            <a @click="viewCheckItems(record)">查看</a>
          </span>

          <!-- 排查人 checkPerson -->
          <span slot="checkPerson" slot-scope="text, record, index">
            <div v-for="(item, i) in record.checkPlanCheckPersonList" :key="index + item.checkPersonId + i">
              {{ item.checkPersonName }}
            </div>
          </span>

          <!-- 状态  -->
          <template slot="status" slot-scope="text, record">
            <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">
              {{ record.status | checktextFilter }}
            </a-tag>
          </template>
          <!-- 状态 end -->
          <span slot="action" slot-scope="text, record">
            <!-- 0未排查 -->
            <a-space v-if="record.status === 0 && !isAchieved">
              <a @click="doNormalPotentialRisk(record)">正常</a>
              <a-divider type="vertical" />
              <a @click="checkinPotentailRisk(record)">隐患登记</a>
            </a-space>
            <!-- 1已排查 -->
            <a-space v-if="record.status === 1 && !isAchieved">
              <!-- 正常 -->
              <template v-if="record.hasPeril === 0">
                <a :class="{ aDisbale: record.hasPeril === 0 }" @click="doNormalPotentialRisk(record)">正常</a>
                <a-divider type="vertical" />
                <a :class="{ aDisbale: record.perilStatus == 1 }" @click="withdrawPotentailRisk(record)">撤回</a>
              </template>
              <!-- 隐患登记 -->
              <template v-else>
                <a @click="viewPotentialRisk(record)">查看隐患</a>
                <a-divider type="vertical" />
                <a :class="{ aDisbale: record.perilStatus == 1 }" @click="withdrawPotentailRisk(record)">撤回</a>
              </template>
            </a-space>
            <a-space v-if="isAchieved">
              <a :class="{ aDisbale: record.hasPeril === 0 }" @click="doNormalPotentialRisk(record)" v-if="record.hasPeril === 0">正常</a>
              <a @click="viewPotentialRisk(record)" v-if="record.hasPeril === 1">查看隐患</a>
            </a-space>
          </span>
        </s-table>
      </div>
    </a-modal>
    <!-- / 计划详情弹框 -->
  </page-container>
</template>

<script>
import { STable } from '@/components'

import { getDict } from '@/api/system'

import RiskCheckinModal from './checkoutManageMgr/riskCheckinModal'
import moment from 'moment'
import { mapGetters } from 'vuex'

import {
  potentialPlanColumns,
  columnsPotentialFactor,
  columnsFacility,
  columnsTask,
} from './checkoutManageMgr/table.js'

import checkoutManageApi from '@/api/checkoutManage'
import { getStore } from '@/utils/store'

export default {
  name: 'SpangWebCheckoutmanage',
  components: { STable, RiskCheckinModal },
  // directives: { DirectiveName },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      dateOfInvestigation: [],
      previewVisible: false,
      previewImage: '',
      checkinModelVisible: false,
      checkinModel: { id: 0 },
      checkStatusOptions: [],
      modalVisible: false,
      modalDisabled: false,
      potentialRiskVisible: false,
      queryParam: {
        name: '',
        endTime: '',
        startTime: '',
        status: undefined,
      },
      loadData: (parameter) => {
        let requesturl = checkoutManageApi.checkoutManageList
        let method = 'GET'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize, ...this.queryParam },
          data: {},
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;',
          },
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      dataList: [],

      planData: {},

      // 设备设施类检查项弹窗
      facilityModalVisible: false,
      facilityModalData: [],

      // 打开作业活动类检查项弹窗
      opentaskModalVisible: false,
      opentaskModalData: [],

      userInfo: getStore({ name: 'info' }),
      currentRecordId: null,
      isAchieved: false // 计划是否完成
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => potentialPlanColumns,
    columnsPotentialFactor: () => columnsPotentialFactor,
    facilityColumns: () => columnsFacility, // 设备设施类
    taskColumns: () => columnsTask, // 作业活动类
  },
  filters: {
    colorFilter: function (value) {
      if (value == 1) {
        return 'green'
      } else {
        return 'orange'
      }
    },
    textFilter: function (value) {
      if (value == 1) {
        return '已完成'
      } else {
        return '未完成'
      }
    },
    checktextFilter: function (value) {
      if (value == 1) {
        return '已排查'
      } else {
        return '未排查'
      }
    },
  },
  methods: {
    getTime(time) {
      let dateFormat = 'YYYY-MM-DD'
      if (time) {
        return moment(time).format(dateFormat)
      } else {
        return ''
      }
    },
    selectOptionsInit() {
      const dictKey = 'PERIL_CHECK_STATUS'
      let options = []
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          options = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
          this.checkStatusOptions = options
        }
      })
    },
    dataChange() {
      this.queryParam.startTime = this.dateOfInvestigation[0] + ' 00:00:00' // 计划开始时间
      this.queryParam.endTime = this.dateOfInvestigation[1] + ' 23:59:59' // 计划结束时间
    },
    handleCancel() {
      this.previewVisible = false
    },
    checkinPotentailRisk(record) {
      if (record.hasPeril === 1) {
        return
      }
      this.checkinModelVisible = true
      this.isNewReport = true

      this.checkinModel = { planPointId: record.id, pointName: record.perilPointName, pointType: record.type }
    },
    // 隐患登记
    okcheckinModel(formData) {
      this.editPlanRequest(formData)
    },
    // 隐患登记弹框取消
    hidecheckinModel() {
      this.checkinModelVisible = false
    },
    // 隐患登记
    editPlanRequest(formData) {
      console.log('formData', formData)
      let requesturl = checkoutManageApi.setcheckoutcheck
      let method = 'POST'
      let requestparams = {
        params: {},
        data: formData,
      }
      let config = {
        headers: {
          'Content-Type': 'application/json',
        },
      }

      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        this.$message.success('操作成功')
        this.hidecheckinModel()
        this.getcheckRisk(false)
        this.$refs.planDetailTable.refresh(true)
        this.$refs.planDetailTable.clearSelected()
        // this.closeModal()
      })
    },

    queryFormData() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    resetQueryForm(type = true) {
      this.queryParam = {
        name: '',
        endTime: '',
        startTime: '',
        status: undefined,
      }
      this.dateOfInvestigation = []
      this.$refs.table.refresh(type)
      this.$refs.table.clearSelected()
    },
    openModal(record = {}, disabled = false) {
      this.modalDisabled = disabled
      this.modalVisible = true
      this.planData = record
      this.$nextTick(() => {
        this.$refs.planDetailTable.refresh(true)
        this.$refs.planDetailTable.clearSelected()
      })
    },
    closeModal() {
      this.modalDisabled = false
      this.modalVisible = false
      this.planData = []
      this.resetQueryForm(false)
    },
    view(record) {
      this.currentRecordId = record.id
      this.isAchieved = true
      this.getcheckRisk()
    },
    check(record) {
      this.currentRecordId = record.id
      this.isAchieved = false
      this.getcheckRisk()
    },
    getcheckRisk(type=true) {
      this.getById(checkoutManageApi.checkoutManageByid + `?checkPlanId=${this.currentRecordId}`, null).then(({ data, success }) => {
        if(success) {
          this.checkPlanData = []
          this.checkPlanData = data
          if(type) {
            this.openModal()
          } else {
            this.$refs.planDetailTable.refresh(true)
          }
        }
      })
    },
    viewCheckItems(record) {
      let { typeKey } = record
      switch (typeKey) {
        case 1:
          // 打开设备设施类检查项弹窗
          this.openfacilityModal(record)
          break
        case 2:
          // 打开作业活动类检查项弹窗
          this.opentaskModal(record)
          break
        default:
          break
      }
    },
    openfacilityModal(record) {
      let requesturl = checkoutManageApi.facility
      let method = 'get'
      let requestparams = {
        params: {
          id: record.perilPointId,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/json',
        },
      }

      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        let data = res.data
        this.facilityModalData = data.equipmentCheckList
        this.facilityModalVisible = true
      })
    },
    hidefacilityModal() {
      this.facilityModalVisible = false
      this.facilityModalData = []
    },
    opentaskModal(record) {
      let requesturl = checkoutManageApi.task
      let method = 'get'
      let requestparams = {
        params: {
          id: record.perilPointId,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/json',
        },
      }

      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        let data = res.data
        this.opentaskModalData = data.workActivityCheckList
        this.opentaskModalVisible = true
      })
    },
    hidetaskModal() {
      this.opentaskModalVisible = false
      this.opentaskModalData = []
    },
    doNormalPotentialRisk(record) {
      let requesturl = checkoutManageApi.setcheckoutnormal
      let method = 'put'
      let requestparams = {
        params: {
          perilPointId: record.id,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
      }

      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        this.$message.success(`${res.msg}`)
        this.getcheckRisk(false)
        // this.closeModal()
      })
    },

    // 隐患登记撤回
    withdrawPotentailRisk(record) {
      let _this = this
      if (record.perilStatus == 1) {
        return
      }
      this.$confirm({
        title: '你确定要撤回吗？',
        onOk() {
          _this.setcheckoutwithdraw(record)
        },
        onCancel() {},
      })
    },
    setcheckoutwithdraw(record) {
      let requesturl = checkoutManageApi.setcheckoutwithdraw
      let method = 'put'
      let requestparams = {
        params: {
          perilPointId: record.id,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
      }

      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        this.$message.success('操作成功')
        this.getcheckRisk(false)
        // this.closeModal()
      })
    },
    // 查看隐患
    viewPotentialRisk(record) {
      if (record.hasPeril === 0) {
        return
      }
      this.checkinModelVisible = true
      let requesturl = checkoutManageApi.getcheckoutcheck
      let method = 'GET'
      let requestparams = {
        params: {
          id: record.id,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
      }
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        this.checkinModel = res.data
      })
    },

    loadDataPotential() {
      return new Promise((resolve, reject) => {
        const data = {
          totalCount: this.checkPlanData.length,
          totalPage: 10,
          pageNo: 1,
          pageSize: 10,
          data: this.checkPlanData,
        }
        resolve(data)
      })
    },
  },
}
</script>

<style lang="less" scoped>
/* you can make up upload button and sample style by using stylesheets */
.ant-upload-select-picture-card i {
  font-size: 32px;
  color: #999;
}

.ant-upload-select-picture-card .ant-upload-text {
  margin-top: 8px;
  color: #666;
}

/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
  .aDisbale {
    cursor: not-allowed;
    color: rgba(0, 0, 0, 0.25);
  }
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>
