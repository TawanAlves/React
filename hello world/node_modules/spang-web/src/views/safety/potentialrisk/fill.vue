<template>
  <a-card :bordered="false" title="隐患信息填报">
    <a-form :form="form" :label-col="{ span: 6 }" :wrapper-col="{ span: 12 }" style="margin-top: 40px;width: 80%">
      <a-row :gutter="24">
        <a-col :span="12">
          <department-select label-name="填报单位" decorator-name="importUnitId" :disabled="disabled"/>
          <a-form-item label="隐患描述">
            <a-textarea :rows="4" v-decorator="['note', { rules: [{ required: true, message: '请填写隐患描述' }] }]"/>
          </a-form-item>
          <a-form-item label="隐患地点">
            <a-input v-decorator="['perilAddress', { rules: [{ required: true, message: '请填写隐患描述' }] }]"/>
          </a-form-item>
          <a-form-item label="级别">
            <a-select v-decorator="['level', { rules: [{ required: true, message: '请选择隐患级别' }] }]">
              <a-select-option v-for="d in riskLevelOptions" :key="d.dictKey">
                {{ d.dictValue }}
              </a-select-option>
            </a-select>
          </a-form-item>
          <a-form-item label="类别">
            <a-select v-decorator="['type', { rules: [{ required: true, message: '请选择隐患类别' }] }]">
              <a-select-opt-group v-for="item in riskTypeOptions" :key="item.dictValue">
                <a-select-option v-for="d in item.children" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select-opt-group>
            </a-select>
          </a-form-item>
          <a-form-item label="检查时间">
            <a-date-picker v-decorator="['checkTime', { rules: [{ required: true, message: '请选择发现时间' }] }]" style="width: 60%"/>
          </a-form-item>
          <person-select label-name="填报人" decorator-name="informantId" />
          <!--          <a-form-item label="填报人">-->
          <!--            <PersonInfo-->
          <!--              @click="parentFn"-->
          <!--              v-decorator="['informantId', { rules: [{ required: true, message: '请选择发现时间' }] }]"-->
          <!--              :id="informantId"/>-->
          <!--&lt;!&ndash;            <a-input v-decorator="['informantId', { rules: [{ required: true, message: '请选择发现时间' }] }]"/>&ndash;&gt;-->
          <!--          </a-form-item>-->
        </a-col>
        <a-col :span="12">
          <department-select label-name="责任单位" decorator-name="dutyUnitId" :disabled="disabled"/>
          <a-form-item label="整改类型">
            <a-select v-decorator="['abarbeitungType', { rules: [{ required: true, message: '请选择隐患级别' }] }]">
              <a-select-option v-for="d in abarbeitungTypeOptions" :key="d.dictKey">
                {{ d.dictValue }}
              </a-select-option>
            </a-select>
          </a-form-item>
          <person-select label-name="整改责任人" decorator-name="dutyPersonId"/>
          <a-form-item label="整改期限">
            <a-date-picker v-decorator="['createTime', { rules: [{ required: true, message: '请选择发现时间' }] }]" style="width: 60%"/>
          </a-form-item>
          <a-form-item label="整改要求">
            <a-textarea :rows="4" v-decorator="['abarbeitungDemand', { rules: [{ required: true, message: '请填写整改要求' }] }]"/>
          </a-form-item>
          <person-select label-name="复查人" decorator-name="reviewPersonId"/>
          <a-form-item label="是否通知">
            <a-radio-group v-decorator="['isAdvice', { rules: [{ required: false}]}]">
              <a-radio-button value="0">
                是
              </a-radio-button>
              <a-radio-button value="1">
                否
              </a-radio-button>
            </a-radio-group>
          </a-form-item>
        </a-col>
      </a-row>
      <a-form-item :wrapper-col="{ span: 12, offset: 11 }">
        <a-button @click="cancel" style="margin-right: 12px">
          返回
        </a-button>
        <a-button @click="submit" style="margin-right: 12px">
          提交
        </a-button>
      </a-form-item>
    </a-form>
  </a-card>
</template>

<script>
import { getPotentialRiskLevel, getPotentialRiskType, getAbarbeitungType, reform } from '@/api/safety'
import PersonInfo from '@/views/safety/potentialrisk/PersonInfo'
import pick from 'lodash.pick'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelect from '@/views/safety/components/PersonSelect'

const fields = ['importUnitId', 'perilDescription', 'perilAddress', 'level', 'type', 'createTime', 'informantId', 'dutyUnitId',
  'abarbeitungType', 'dutyPersonId', 'createTime', 'abarbeitungDemand', 'reviewPersonId', 'isAdvice']

export default {
  name: 'Fill',
  components: {
    PersonInfo,
    DepartmentSelect,
    PersonSelect
  },
  inject: {
    modal: {
      type: Object,
      default: () => null
    }
  },
  props: {
    model: {
      type: Object,
      default: () => null
    }
  },
  // provide () {
  //   return {
  //     test: this
  //   }
  // },
  data () {
    return {
      formLayout: 'horizontal',
      form: this.$form.createForm(this),
      // select options
      importUnitOptions: [],
      riskTypeOptions: [],
      riskLevelOptions: [],
      abarbeitungTypeOptions: [],
      informantId: ''
    }
  },
  created () {
    this.selectOptionsInit()
    // fields.forEach(v => this.form.getFieldDecorator(v))
    // 当 model 发生改变时，为表单设置值
    // this.$watch('model', () => {
    //   console.log('监听数据')
    //   this.model && this.form.setFieldsValue(pick(this.model, fields))
    // })
  },
  watch: {
    'model': {
      handler (newVal) {
        console.log(newVal)
        fields.forEach(v => this.form.getFieldDecorator(v))
        if (Object.keys(this.model).length > 0) {
          this.model.level = typeof this.model.level === 'string' ? this.model.level : this.model.level.toString()
          this.model.isAdvice = typeof this.model.isAdvice === 'string' ? this.model.isAdvice : this.model.isAdvice.toString()
          this.model.abarbeitungType = typeof this.model.abarbeitungType === 'string' ? this.model.abarbeitungType : this.model.abarbeitungType.toString()
        }
        this.model && this.form.setFieldsValue(pick(newVal, fields))
      },
      deep: true,
      immediate: true
    }
  },
  methods: {
    selectOptionsInit () {
      getPotentialRiskType().then(res => {
        this.riskTypeOptions = res.data
      })
      getPotentialRiskLevel().then(res => {
        this.riskLevelOptions = res.data
      })
      getAbarbeitungType().then(res => {
        this.abarbeitungTypeOptions = res.data
      })
    },
    parentFn (value) {
      this.informantId = value.id
    },
    cancel () {
      this.$emit('childFn', { show: false, data: '11111' })
    },
    submit () {
      this.form.validateFields((errors, values) => {
        // values.informantId = this.informantId
        console.log(values)
        if (!errors) {
          console.log(values)
        }
      })
      // e.preventDefault()
      // this.form.validateFields((err, values) => {
      //   if (!err) {
      //     console.log('Received values of form: ', values)
      //   }
      // })
    },
    handleSelectChange (value) {
      this.form.setFieldsValue({
        note: `Hi, ${value === 'male' ? 'man' : 'lady'}!`
      })
    }
  }
}
</script>
