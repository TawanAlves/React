<template>
  <div>
    <!-- 隐患详情 -- 风险评价方法 -->
    <l-s-select-modal :modal-title="lsModalTitle" :mode="lsModalMode" :visible.sync="lsModalVisible" @ok="setLS" />
    <!-- 隐患详情 -->
    <a-modal
      :visible.sync="visible"
      :title="`隐患详情 - ${modalTitle}`"
      :width="900"
      @cancel="cancelModal"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="cancelModal">取消</a-button>
        <a-button type="primary" @click="okModal('stash')" v-if="!disabled">暂存</a-button>
        <a-button type="primary" @click="okModal('submit')" v-if="!disabled">提交</a-button>
      </template>
      <!-- 基础信息、评估信息、整改信息、验收信息 -->
      <div class="risk-detail">
        <!-- 头部标识 -->
        <div class="risk-detail-info-name"></div>
        <section class="risk-detial-header">
          <div class="info-block" :class="{ active: model.process == 1 }">
            <div class="info-block-name">上报</div>
            <div class="info-block-person">{{ basicInfomodel.registrantName }}</div>
            <div class="info-block-time">{{ basicInfomodel.registerTime }}</div>
          </div>
          <a-icon class="arrow-right" type="arrow-right" />
          <div class="info-block" :class="{ active: model.process == 2 }">
            <div class="info-block-name">评估</div>
          </div>
          <a-icon class="arrow-right" type="arrow-right" />
          <div class="info-block" :class="{ active: model.process > 3 }">
            <div class="info-block-name">待整改</div>
          </div>
          <a-icon class="arrow-right" type="arrow-right" />
          <div class="info-block" :class="{ active: model.process > 4 }">
            <div class="info-block-name">验收</div>
          </div>
        </section>
        <!-- / 头部标识 -->

        <!-- 基础信息 Basic information-->
        <section class="risk-detail-info report-base">
          <div class="risk-detail-info-name">1. 基础信息</div>
          <a-form :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
            <a-form-item label="隐患名称" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }">
              <a-input v-model="basicInfomodel.name" :disabled="basicInfomodelDisable"></a-input>
            </a-form-item>
            <a-row>
              <a-col :span="12">
                <a-form-item label="风险点">
                  <a-input v-model="basicInfomodel.pointName" :disabled="basicInfomodelDisable"></a-input>
                </a-form-item>
                <a-form-item label="隐患级别">
                  <a-select v-model="basicInfomodel.levelName" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item label="隐患地点">
                  <a-input v-model="basicInfomodel.address" :disabled="basicInfomodelDisable"></a-input>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="风险类型">
                  <a-select v-model="basicInfomodel.pointType" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item label="隐患类别">
                  <a-select v-model="basicInfomodel.typeName" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item label="责任部门">
                  <a-select v-model="basicInfomodel.dutyDeptName" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="24">
                <a-form-item :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" label="隐患描述">
                  <a-textarea v-model="basicInfomodel.description" :disabled="basicInfomodelDisable"></a-textarea>
                </a-form-item>
              </a-col>
            </a-row>
            <!-- <a-row gutter="24">
              <a-col :span="12">
                <a-form-item label="登记时间">
                  <span>{{ basicInfomodel.registerTime }}</span>
                </a-form-item>
                <a-form-item label="提报人">
                  <span>{{ basicInfomodel.registrantDept }}</span>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="部门">
                  <span>{{ basicInfomodel.registrantDept }}</span>
                </a-form-item>
              </a-col>
            </a-row> -->
            <a-row gutter="24" style="margin-bottom: 8px;color: #0c0f1a;">
              <a-col :span="8" style="margin-left: 29px;"> 登记时间：{{ basicInfomodel.registerTime }} </a-col>
              <a-col :span="7"> 提报人：{{ basicInfomodel.registrantName }} </a-col>
              <a-col :span="7"> 部门：{{ basicInfomodel.registrantDept }} </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="24">
                <a-form-item label="整改前照片" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" style="margin-bottom: 0!important;">
                  <upload-file
                    accept=".jpg, .jpeg, .png"
                    :fileList="basicInfoImgList"
                    :showUploadList="{ showPreviewIcon: true, showRemoveIcon: false }"
                    listType="picture-card"
                    :previewEnabled="true"
                    disabled="true"
                    preview-mode="fullscreen"
                  />
                </a-form-item>
              </a-col>
            </a-row>
          </a-form>
        </section>
        <!-- / 基础信息 -->

        <!-- 评估信息 -->
        <section class="risk-detail-info report-assess">
          <div class="risk-detail-info-name">2. 评估信息</div>
          <div>
            <fieldset>
              <legend>事故发生的可能性（L）判定准则</legend>

              <a-table size="small" :data-source="[LJudge]" :pagination="false" :rowKey="(record) => record.id">
                <a-table-column key="happenScores" data-index="happenScores" title="等级" align="center" width="100px">
                </a-table-column>
                <a-table-column key="happenDetails" data-index="happenDetails" title="描述" align="center">
                </a-table-column>
                <a-table-column key="action" data-index="action" title="" align="center" width="100px">
                  <template slot-scope="text, record">
                    <a @click="selectLS('L')">选择</a>
                  </template>
                </a-table-column>
              </a-table>
            </fieldset>
            <fieldset>
              <legend>事故发生后果严重性（S）判定准则</legend>

              <a-table size="small" :data-source="[SJudge]" :pagination="false" :rowKey="(record) => record.id">
                <a-table-column
                  key="seriousScores"
                  data-index="seriousScores"
                  title="等级"
                  align="center"
                  width="100px"
                >
                </a-table-column>
                <a-table-column key="seriousDetails" data-index="seriousDetails" title="描述" align="center">
                </a-table-column>
                <a-table-column key="action" data-index="action" title="" align="center" width="100px">
                  <template slot-scope="text, record">
                    <a @click="selectLS('S')">选择</a>
                  </template>
                </a-table-column>
              </a-table>
            </fieldset>

            <fieldset>
              <legend>安全风险等级判定准则及控制措施R</legend>
              <a-table
                size="small"
                :data-source="[accidentJudge]"
                :pagination="false"
                :columns="rCoumns"
                :rowKey="(index) => index"
              >
              </a-table>
            </fieldset>

            <div class="risk-score">
              <a-row type="flex" justify="space-between" style="margin: 15px 0">
                <a-col :span="3" offset="1">
                  <div class="risk-label">风险值:</div>
                  <a-tag class="risk-tag">{{ controlLevel.resultScore == -1 ? '' : controlLevel.resultScore }}</a-tag>
                </a-col>
                <a-col :span="3">
                  <div class="risk-label">评价级别:</div>
                  <a-tag class="risk-tag">{{ accidentJudge.judgeLevelName }}</a-tag>
                </a-col>
                <a-col :span="3">
                  <div class="risk-label">风险级别:</div>
                  <a-tag class="risk-tag">{{ controlLevel.riskLevelName }}</a-tag>
                </a-col>
                <a-col :span="3">
                  <div class="risk-label">风险色:</div>
                  <a-tag class="risk-tag">{{ controlLevel.riskColourName }}</a-tag>
                </a-col>
                <a-col :span="3">
                  <div class="risk-label">管控层级:</div>
                  <a-tag class="risk-tag">{{ controlLevel.riskControlName }}</a-tag>
                </a-col>
              </a-row>
            </div>
            <div>
              <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
                <a-form-model-item
                  label="评估意见"
                  :label-col="{ span: 3 }"
                  :wrapper-col="{ span: 21 }"
                  prop="assessment"
                >
                  <a-input v-model="form.assessment" :disabled="evaluationInfomodelDisable"></a-input>
                </a-form-model-item>
                <a-form-model-item label="评估结果" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" prop="result">
                  <a-select v-model="form.result" :disabled="evaluationInfomodelDisable">
                    <a-select-option v-for="d in resultOptions" :key="d.value">
                      {{ d.label }}
                    </a-select-option>
                  </a-select>
                </a-form-model-item>

                <a-col :span="12">
                  <a-form-model-item label="整改责任单位" prop="abarbeitungUnitId">
                    <department-select :value="form.abarbeitungUnitId" @change="organizeChange" :disabled="disabled" />
                  </a-form-model-item>
                  <a-form-model-item label="整改类型" prop="type">
                    <a-select v-model="form.type" :disabled="evaluationInfomodelDisable">
                      <a-select-option v-for="d in typeOptions" :key="d.value">
                        {{ d.label }}
                      </a-select-option>
                    </a-select>
                  </a-form-model-item>
                  <!-- <a-form-item label="评估时间">
                    <a-input v-model="form.address" :disabled="evaluationInfomodelDisable"></a-input>
                  </a-form-item> -->
                </a-col>
                <a-col :span="12">
                  <a-form-model-item label="整改负责人" prop="principalId">
                    <PersonListSelect
                      :value="form.principalId"
                      @change="personChange"
                      :disabled="disabled"
                      placeholder="请选择负责人"
                    ></PersonListSelect>
                  </a-form-model-item>
                  <a-form-model-item label="整改完成日期">
                    <a-date-picker
                      v-model="form.accomplishTime"
                      :valueFormat="dateFormat"
                      style="width: 100%"
                      :disabled="evaluationInfomodelDisable"
                    ></a-date-picker>
                  </a-form-model-item>
                  <!-- <a-form-item label="评估人">
                    <a-input v-model="model.address" :disabled="evaluationInfomodelDisable"></a-input>
                  </a-form-item> -->
                </a-col>
              </a-form-model>
            </div>
          </div>
        </section>
        <!-- / 评估信息 -->
      </div>
    </a-modal>
  </div>
</template>

<script>
import LSSelectModal from '../components/LSSelectModal.vue'
import SafetyURLs from '@/api/urls'
import { RColumns } from '../components/table'
import { getDict } from '@/api/system'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
import URLS from '@/api/risk-urls'
export default {
  // name: 'SpangWebRiskdetail',

  components: { LSSelectModal, DepartmentSelect, PersonSelectModal },

  // directives: { DirectiveName },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    isNewReport: {
      type: Boolean,
      default: () => false,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {
        return {}
      },
    },
    modalTitle: {
      type: String,
      default: '',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      assessModalVisibile: false,
      model: {},
      basicInfomodel: {}, // 基础信息
      basicInfoImgList: [],
      basicInfomodelDisable: false,

      evaluationInfomodel: {
        abarbeitungUnitId: '', //	整改责任单位id	integer(int64)
        abarbeitungUnitName: '', //		整改责任单位名称	string
        accomplishTime: '', //		整改完成日期	string(date-time)
        assessTime: '', //		评估时间	string(date-time)
        assessment: '', //		评估意见	string
        assessorName: '', //		评估人姓名	string

        ponderanceScore: '', //		严重性判定准则分数	integer(int32)
        possibilityScore: '', //		可能性判定准则分数	integer(int32)
        principalId: '', //		整改负责人id	integer(int64)
        principalName: '', //		整改负责人名称	string
        reportInformationId: '', //		隐患上报表id	integer(int64)
        result: '', //		隐患评估结果	integer(int32)
        status: '', //		状态(0暂存 1提交)	integer(int32)
        type: '', //		整改类型	integer(int32)
        typeName: '', //		整改类型名称
      }, // 评估信息
      evaluationInfomodelDisable: false,

      lsModalTitle: '',
      lsModalMode: '',
      lsModalVisible: false,
      LJudge: { happenScores: '', happenDetails: '' },
      SJudge: { seriousScores: '', seriousDetails: '' },
      controlLevel: {},
      accidentJudge: {
        gmtCreate: '',
        gmtModified: '',
        gmtCreateId: '',
        gmtCreateName: '',
        gmtCreateDeptId: '',
        gmtModifiedId: '',
        gmtModifiedName: '',
        isDeleted: '',
        judgeMin: '',
        judgeMax: '',
        riskLevelId: '',
        riskLevelName: '',
        controlMeasures: '',
        timeLimit: '',
        judgeLevelName: '',
        judgeLevelId: '',
      },
      resultOptions: [], // 隐患评估结果
      abarbeitungUnitOptions: [],

      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      form: {
        assessment: '', // 评估意见
        result: undefined, // 隐患评估结果
        abarbeitungUnitId: undefined, // 整改责任单位id
        abarbeitungUnitName: '', // 整改责任单位名称

        principalId: undefined, //	整改负责人id
        principalName: '', //	整改负责人名称

        status: '', //		状态(0暂存 1提交)	integer(int32)

        ponderanceScore: '', // 严重性判定准则分数
        possibilityScore: '', // 可能性判定准则分数

        reportInformationId: '', // 隐患上报表id
      },
      rules: {
        assessment: [{ required: true, message: '请输入评估意见', trigger: 'blur' }],
        result: [{ required: true, message: '请选择评估结果', trigger: 'blur' }],
        abarbeitungUnitId: [{ required: true, message: '请选择整改责任单位', trigger: 'blur' }],
        principalId: [{ required: true, message: '请选择负责人', trigger: 'blur' }],
        type: [{ required: true, message: '请选择检查类型', trigger: 'blur' }],
      },
    }
  },

  computed: {
    rCoumns: () => RColumns,
  },
  created() {
    this.selectOptionsInit()
  },
  mounted() {},
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },

  methods: {
    selectOptionsInit() {

      //
      const dictKey = 'PERIL_ACCEPT_RESULT'
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.resultOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })

      getDict('PERIL_ASSESS_TYPE').then(({ data, success }) => {
        if (success) {
          this.typeOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })
    },
   async setFormData(model) {
      let data = JSON.parse(JSON.stringify(model))
      let { process, reportInformationVO, assessInformationVO } = data
      if (process <= 2) {
        this.basicInfomodelDisable = true
      }
      this.basicInfoImgList = this.getImgUrlList(reportInformationVO.files)
      this.basicInfomodel = reportInformationVO
      this.form = assessInformationVO
      this.form.reportInformationId = this.basicInfomodel.id
      if(JSON.stringify(assessInformationVO) !== '{}') {
        this.form.result = this.form.result.toString()
        this.form.type = this.form.type.toString()
        Promise.all([this.getLData(this.form.ponderanceScore),this.getSData(this.form.possibilityScore)]).then((res) => {
          this.setR()
        })
      }
    },
    getImgUrlList(fileList) {
      let photoList = []
      fileList.forEach((element) => {
        let { id, fileName, filePath } = element
        if (id) {
          photoList.push({
            uid: id,
            name: fileName,
            status: 'done',
            id: id,
            url: this.BASE_URL + '/spang-safety/file' + filePath,
          })
        }
      })
      return photoList
    },
    selectLS(type) {
      if (type === 'L') {
        this.lsModalTitle = '事故发生的可能性（L）判定准则'
      } else {
        this.lsModalTitle = '事件后果严重性（S）'
      }
      this.lsModalMode = type
      this.lsModalVisible = true
    },
    setLS(data) {
      if (this.lsModalMode === 'L') {
        const details = [
          data.happenFrequency,
          data.securityCheck,
          data.workRule,
          data.employeeCompetency,
          data.controlMeasures,
        ]
          .filter((item) => this.isNotNullOrUndefined(item))
          .join(';')
        this.LJudge = { happenId: data.id, happenScores: data.scores, happenDetails: details }
      } else {
        const details = [data.casualties, data.downtime, data.reputationImpact]
          .filter((item) => this.isNotNullOrUndefined(item))
          .join(';')

        this.SJudge = { seriousId: data.id, seriousScores: data.scores, seriousDetails: details }
      }

      if (this.LJudge.happenId && this.SJudge.seriousId) {
        const params = {
          lScores: this.LJudge.happenScores,
          sScores: this.SJudge.seriousScores,
        }
        this.getList(SafetyURLs.getRiskLevelByScore, params).then(({ success, data }) => {
          if (success) {
            delete data.controlLevel.id
            delete data.accidentJudge.id
            this.controlLevel = { ...data.controlLevel, resultScore: data.resultScore }
            this.accidentJudge = {
              ...data.accidentJudge,
              judgeLevelName: data.accidentJudge.riskLevelName,
              judgeLevelId: data.accidentJudge.riskLevelId,
            }
          }
        })
      }
    },
    personChange(val) {
      this.form.principalName = val.person.name
      this.form.principalId = val.id
    },
    organizeChange(val) {
      this.form.abarbeitungUnitId = val.id
      this.form.abarbeitungUnitName = val.label
    },
    okModal(key) {
      if (this.LJudge.happenScores && this.SJudge.seriousScores) {
        this.$refs.ruleForm.validate((valid) => {
          if (valid) {
            this.form.ponderanceScore = this.LJudge.happenScores // 严重性判定准则分数
            this.form.possibilityScore = this.SJudge.seriousScores // 可能性判定准则分数

            if (key == 'submit') {
              this.form.status = 1
              this.$emit('submitok', this.form)
            } else {
              this.form.status = 0
              this.$emit('stashok', this.form)
            }
            this.visible = false
          } else {
            return false
          }
        })
      } else {
        let message = '请选择安全风险等级判定准则及控制措施'
        this.$message.error(message)
      }
    },
    cancelModal() {
      this.visible = false
      this.$emit('cancel', this.model)
      this.$refs.ruleForm.resetFields()
    },
    // 获取事故发生的可能性（L）判定准则
    getLData(SourceKey) {
      return new Promise((resolve) => {
        this.getList(URLS.lList).then(({ data, success }) => {
          if (success) {
            data.forEach((element) => {
              let { scores } = element
              if (scores == SourceKey.toString()) {
                const details = [
                  element.happenFrequency,
                  element.securityCheck,
                  element.workRule,
                  element.employeeCompetency,
                  element.controlMeasures,
                ]
                  .filter((item) => this.isNotNullOrUndefined(item))
                  .join(';')
                this.LJudge = { happenId: element.id, happenScores: element.scores, happenDetails: details }
                resolve(true)
              }
            })
          }
        })
      })
    },
    // 事故发生后果严重性（S）判定准则
    getSData(SourceKey) {
      return new Promise((resolve) => {
        this.getList(URLS.sList).then(({ data, success }) => {
          if (success) {
            data.forEach((element) => {
              let { scores } = element
              if (scores == SourceKey.toString()) {
                const details = [element.casualties, element.downtime, element.reputationImpact]
                  .filter((item) => this.isNotNullOrUndefined(item))
                  .join(';')
                this.SJudge = { seriousId: element.id, seriousScores: element.scores, seriousDetails: details }
                resolve(true)
              }
            })
          }
        })
      })
    },
    setR() {
      if (this.LJudge.happenId && this.SJudge.seriousId) {
        const params = {
          lScores: this.LJudge.happenScores,
          sScores: this.SJudge.seriousScores,
        }
        this.getList(SafetyURLs.getRiskLevelByScore, params).then(({ success, data }) => {
          if (success) {
            delete data.controlLevel.id
            delete data.accidentJudge.id
            this.controlLevel = { ...data.controlLevel, resultScore: data.resultScore }
            this.accidentJudge = {
              ...data.accidentJudge,
              judgeLevelName: data.accidentJudge.riskLevelName,
              judgeLevelId: data.accidentJudge.riskLevelId,
            }
          }
        })
      }
    },
  },
}
</script>

<style lang="less" scoped>
.risk-detail {
  /deep/.ant-upload-disabled {
    display: none !important;
  }

  height: calc(100vh - 350px) !important;
  overflow: auto;
  & > .risk-detial-header {
    display: flex;
    justify-content: space-around;
    text-align: center;
    .arrow-right {
      height: 100px;
      line-height: 50px;
      font-size: 24px;
      color: #797979;
    }
    & > .info-block {
      .info-block-name {
        background: #008080;
        width: 50px;
        height: 50px;
        margin: 0 auto;
        line-height: 50px;
        border-radius: 50%;
        color: #fff;
      }
      .info-block-person {
        margin-top: 5px;
      }
      &.active > .info-block-name {
        background: #70b603;
      }
    }
  }
  & > .risk-detail-info {
    padding: 0 25px;
    .risk-detail-info-name {
      color: #0000ff;
      margin: 15px -15px 10px;
      border-bottom: 1px solid #333;
      font-size: 16px;
    }
  }
}
/deep/ .ant-table {
  height: auto !important;
}
.report-base {
  .ant-form-item {
    margin-bottom: 0;
  }
}
fieldset {
  border: 1px solid #ccc;
  padding: 10px;
  legend {
    width: auto;
    font-size: 14px;
  }
}
.risk-label {
  font-weight: 600;
}
.risk-tag {
  min-height: 20px;
  min-width: 60px;
  margin-top: 4px;
  text-align: center;
}
/deep/.ant-table-body {
  margin: 0!important;
}
/deep/.ant-table-thead {
  background-color: #fafafa!important;
}

</style>