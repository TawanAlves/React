
  <template>
  <!-- 隐患整改管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24" >
              <a-form-item label="隐患名称">
                <a-input v-model="queryParam.name" placeholder="隐患名称"></a-input>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24" >
              <a-form-item label="上报日期">
                <a-range-picker
                  v-model="dateOfInvestigation"
                  :valueFormat="dateFormat"
                  @change="dataChange"
                  style="width: 100%; min-width: 110px;"
                />
              </a-form-item>
            </a-col>
            <a-col  :lg="6" :md="8" :sm="12" :xs="24" >
              <a-form-item label="状态">
                <a-select style="width: 100%" v-model="queryParam.status" placeholder="状态">
                  <a-select-option v-for="d in inspectionStatusOptions" :key="d.value">
                    {{ d.label }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
             <a-col :lg="6" :md="24" :sm="12" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="queryFormData"> 查询 </a-button>
                <a-button type="reset" @click="resetQueryForm"> 重置 </a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <s-table
        style="
           {
            word-break: break-all;
          }
        "
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: `calc(100vh - 395px)`, x: 1230 }"
        :showIndexColumn="true"
      >
        <!-- 状态  -->
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">
            {{ record.status | textFilter }}
          </a-tag>
        </template>
        <!-- 状态 end -->

        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="viewReport(record)" v-if="record.status >= 3">查看</a>
            <a-divider type="vertical" v-if="record.status == 3" />
            <a @click="revertReport(record)" v-if="record.status == 3">撤回</a>
            <a @click="editReport(record)" v-if="record.status == 2 ">整改</a>
          </template>
        </span>
      </s-table>
    </a-card>

    <!-- 弹出整改信息窗 -->
    <reformViewModal
      :visible.sync="reformViewModalVisible"
      :model="reformViewModal"
      :modalTitle="'整改信息'"
      @cancel="reformViewcancel"
      @submitok="reformViewsubmit"
    ></reformViewModal>

    <!-- 隐患详情查看弹窗弹框 -->
    <assessDetailView
      :visible.sync="riskViewModalVisible"
      :model="reportViewData"
      :isNewReport="true"
      :modalTitle="''"
      @cancel="cancelView"
    ></assessDetailView>
    <!-- / 隐患详情查看弹窗弹框 -->
  </page-container>
</template>

<script>
import { STable } from '@/components'
import RiskDetailModal from '@/views/safety/potentialrisk/components/riskDetail'
import { getDict } from '@/api/system'

import reformViewApi from '@/api/reformView'
import { potentialPlanColumns } from './reformViewMgr/table'
import reformViewModal from './reformViewMgr/reformViewModal.vue'

import assessDetailView from './assessMgr/assessDetailView'
import { mapGetters } from 'vuex'

export default {
  components: { STable, RiskDetailModal, reformViewModal, assessDetailView },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD',
      dateOfInvestigation: [],
      inspectionOptions: [],
      inspectionStatusOptions: [],
      modalTitle: '',
      isView: false,
      checkinModalVisible: false,
      planDisabled: false,
      potentialRiskVisible: false,
      queryParam: {
        name: '',
        endTime: '',
        startTime: '',
        status: undefined,
      },
      loadData: (parameter) => {
        let requesturl = reformViewApi.reformViewList
        let method = 'GET'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize, ...this.queryParam },
          data: {},
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;',
          },
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      reportData: {},

      // 整改信息
      reformViewModalVisible: false,
      reformViewModal: {},

      // 隐患详情查看弹窗弹框
      riskViewModalVisible: false,
      reportViewData: {},
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => potentialPlanColumns,
  },
  filters: {
    colorFilter: function (value) {
      let key = value
      let color = ''
      switch (key) {
        case 2:
          color = 'orange'
          break
        case 5:
          color = 'green'
          break
        default:
          color = 'green'
          break
      }
      return color
    },
    textFilter: function (value) {
      let key = value
      let desc = ''
      switch (key) {
        case 2:
          desc = '未整改'
          break
        case 5:
          desc = '验收未通过'
          break
        default:
          desc = '已整改'
          break
      }
      return desc
    },
  },
  methods: {
    selectOptionsInit() {
      getDict('PERIL_ABARBEITUNG_STATUS').then(({ data, success }) => {
        if (success) {
          this.inspectionStatusOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })
    },
    dataChange() {
      this.queryParam.startTime = this.dateOfInvestigation[0] + ' 00:00:00' // 计划开始时间
      this.queryParam.endTime = this.dateOfInvestigation[1] + ' 23:59:59' // 计划结束时间
    },
    queryFormData() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    resetQueryForm() {
      this.queryParam = {
        name: '',
        endTime: '',
        startTime: '',
        status: undefined,
      }
      this.dateOfInvestigation = []
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },

    viewReport(record) {
      this.getreportEditByid(record, 'viewReport')
    },
    openViewModal(data) {
      this.riskViewModalVisible = true
      this.reportViewData = {
        process: 3,
        ...data,
      }
    },
    getreportEditByid(record, key) {
      let requesturl = reformViewApi.reformViewEditByid
      let method = 'get'
      let requestparams = {
        params: {
          id: record.id,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;',
        },
      }
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        let data = res.data
        this.openViewModal(data, true)
      })
    },
    editReport(record) {
      this.getById(reformViewApi.reformViewEditByid,record.id).then(({ data,success }) => {
        if(success) {
          if(Object.keys(data.abarbeitungInformationVO).length> 1) {
            this.reformViewModal = data.abarbeitungInformationVO
          } else {
            this.reformViewModal = {
              reportInformationId: record.id,
            }
          }
          console.log(this.reformViewModal)
          this.reformViewModalVisible = true
        }
      })
    },
    reformViewcancel() {
      this.reformViewModalVisible = false
    },
    cancelView() {
      this.riskViewModalVisible = false
    },
    reformViewsubmit(formData) {
      let requesturl = reformViewApi.reformViewsubmit
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData,
      }
      let config = {
        headers: {
          'Content-Type': 'application/json',
        },
      }
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        this.$message.success(`${res.msg}`)
        this.reformViewModalVisible = false
        this.resetQueryForm()
      })
    },
    // 撤回
    revertReport(record) {
      let _this = this
      this.$confirm({
        title: '你确定要撤回吗？',
        // content: 'When clicked the OK button, this dialog will be closed after 1 second',
        onOk() {
          _this.revertRequest(record)
        },
        onCancel() {},
      })
    },
    revertRequest(record) {
      let requesturl = reformViewApi.reformViewrevert
      let method = 'put'
      let requestparams = {
        params: {},
        data: {
          reportInformationId: record.id,
          status: 0,
        },
      }
      let config = {
        headers: {
          'Content-Type': 'application/json',
        },
      }
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        this.$message.success(`${res.msg}`)
        this.reformViewModalVisible = false
        this.resetQueryForm()
      })
    },
  },
}
</script>


<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  //padding-top: 15px;
  padding-bottom: 15px;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>