<template>
  <!-- 隐患详情 -->
  <a-modal
    :visible="visible"
    :title="`隐患详情 - ${modalTitle}`"
    :width="900"
    @cancel="cancelModal"
    :keyboard="false"
    :maskClosable="false"
  >
    <template slot="footer">
      <a-button @click="cancelModal">取消</a-button>
      <a-button type="primary" @click="okModal('stash')" v-if="!disabled">暂存</a-button>
      <a-button type="primary" @click="okModal('submit')" v-if="!disabled">提交</a-button>
    </template>

    <a-form-model ref="ruleForm" :model="form" :rules="rules">
      <a-row :gutter="24">
        <a-col :span="24">
          <a-form-model-item :label-col="{ span: 4 }" :wrapper-col="{ span: 20 }" label="整改意见" prop="opinion">
            <a-input v-model="form.opinion" :disabled="disabled" placeholder="请输入整改意见"></a-input>
          </a-form-model-item>
        </a-col>
      </a-row>
      <a-row :gutter="24">
        <a-col :span="12">
          <a-form-model-item
            :label-col="{ span: 8 }"
            :wrapper-col="{ span: 16 }"
            label="整改作业人"
            prop="workingPeopleName"
          >
            <a-input v-model="form.workingPeopleName" disabled="true" placeholder="整改作业人"></a-input>
          </a-form-model-item>
        </a-col>
        <a-col :span="12">
          <a-form-model-item :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }" label="整改部门" prop="deptName">
            <a-input v-model="form.deptName" disabled="true" placeholder="整改部门"></a-input>
          </a-form-model-item>
        </a-col>
      </a-row>
      <a-row :gutter="24">
        <a-col :span="24">
          <a-form-model-item :label-col="{ span: 4 }" :wrapper-col="{ span: 20 }" label="整改措施" prop="measure">
            <a-input v-model="form.measure" :disabled="disabled" placeholder="请输入整改措施"></a-input>
          </a-form-model-item>
        </a-col>
      </a-row>
      <a-row :gutter="24">
        <a-col :span="12">
          <a-form-model-item :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }" label="整改结果" prop="result">
            <a-select v-model="form.result" :disabled="evaluationInfomodelDisable">
              <a-select-option v-for="d in resultOptions" :key="d.value">
                {{ d.label }}
              </a-select-option>
            </a-select>
          </a-form-model-item>
        </a-col>
        <a-col :span="12">
          <a-form-model-item :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }" label="验收人" prop="acceptorId">
            <PersonListSelect
              :value="form.acceptorId"
              @change="acceptorpersonChange"
              :disabled="disabled"
              placeholder="请选择验收人"
            ></PersonListSelect>
          </a-form-model-item>
        </a-col>
      </a-row>
      <a-row :gutter="24">
        <a-col :span="24">
          <a-form-model-item :label-col="{ span: 4 }" :wrapper-col="{ span: 20 }" label="相关附件">
            <upload-file
              accept=".jpg, .jpeg, .png"
              :fileList="localePhotos"
              :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'files')"
              :removePro="(file) => removeFile(file, 'files')"
              listType="picture-card"
              :previewEnabled="true"
              preview-mode="fullscreen"
            />
          </a-form-model-item>
        </a-col>
      </a-row>
    </a-form-model>
  </a-modal>
</template>

<script>
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
import { getDict } from '@/api/system'
import { mapGetters } from 'vuex'
export default {
  components: { DepartmentSelect, PersonSelectModal },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    model: {
      type: Object,
      default: () => {
        return { id: 0 }
      },
    },
    modalTitle: {
      type: String,
      default: '',
    },
  },
  data() {
    return {
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      resultOptions: [],
      localePhotos: [],
      form: {
        opinion: '', // 整改意见
        workingPeopleId: '', // 整改作业人id
        workingPeopleName: '', // 作业人名称

        deptId: '', // 整改部门id
        deptName: '', // 整改部门名称

        measure: '', // 整改措施

        result: undefined, // 整改结果

        acceptorId: undefined, //	验收人id
        acceptorName: '', //	验收人名称

        files: [],
        id: '',
      },
      rules: {
        opinion: [{ required: true, message: '请输入评估意见', trigger: 'blur' }],
        measure: [{ required: true, message: '请输入整改措施', trigger: 'blur' }],
        workingPeopleId: [{ required: true, message: '请选择整改作业人', trigger: 'blur' }],
        deptId: [{ required: true, message: '请选择整改部门', trigger: 'blur' }],
        result: [{ required: true, message: '请选择整改结果', trigger: 'blur' }],
        acceptorId: [{ required: true, message: '请选择整验收人', trigger: 'blur' }],
      },
    }
  },

  computed: {
    ...mapGetters(['permission', 'userInfo']),
    rCoumns: () => RColumns,
  },
  created() {
    this.selectOptionsInit()
  },
  mounted() {},
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },

  methods: {
    selectOptionsInit() {
      const dictKey = 'PERIL_ABARBEITUNG_RESULT'
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.resultOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })
    },
    setFormData(model) {
      console.log('userInfo', model)
      if(Object.keys(model).length<2) {
        let { id, name, deptId, deptName } = this.userInfo
        this.form.workingPeopleId = id //	整改作业人id
        this.form.workingPeopleName = name // 作业人名称
        this.form.deptId = deptId //	整改部门id
        this.form.deptName = deptName // 整改部门名称
        this.form.reportInformationId = model.reportInformationId
      } else {
        let fileList = model.files
        let photoList = []
        fileList.forEach((element) => {
          let { id, fileName, filePath } = element
          if (id) {
            photoList.push({
              uid: id,
              name: fileName,
              status: 'done',
              id: id,
              url: this.BASE_URL + '/spang-safety/file' + filePath,
            })
          }
        })
        this.localePhotos = photoList
        delete model.files
        model.result = model.result.toString()
        this.form = model
        console.log(this.form,this.localePhotos)
      }
    },
    personChange(val) {
      this.form.workingPeopleName = val.person.name
      this.form.workingPeopleId = val.id
    },
    acceptorpersonChange(val) {
      this.form.acceptorName = val.person.name
      this.form.acceptorId = val.id
    },
    organizeChange(val) {
      this.form.deptId = val.id
      this.form.deptName = val.label
    },
    handleUpload(fileJson, resp, field) {
      if (fileJson.status === 'done' && resp.success) {
        this.form[field].push({
          originalFileName: resp.data.originalFileName,
          fileUrlPath: resp.data.urlPath,
          id: resp.data.id,
        })
      }
    },
    removeFile(file, field) {
      const index = this.form[field].findIndex((item) => item.id === file.id)
      if (index > -1) {
        this.form[field].splice(index, 1)
      }
      const fileIndex = this.localePhotos.findIndex((item) => item.uid === file.uid)
      if (fileIndex > -1) {
        this.localePhotos.splice(fileIndex, 1)
      }
    },
    okModal(key) {
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          if (key == 'submit') {
            this.form.status = 1
          } else {
            this.form.status = 0
          }
          this.$emit('submitok', this.form)
        } else {
          return false
        }
      })
    },
    cancelModal() {
      this.visible = false
      this.$emit('cancel', this.model)
      this.$refs.ruleForm.resetFields()
    },
  },
}
</script>

<style lang="less" scoped>
.ant-row {
  /deep/.ant-col.ant-col-12:first-child {
    padding-right: 0px !important;
  }
}
</style>