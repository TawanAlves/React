<template>
  <!-- 隐患详情 -->
  <a-modal
    :visible="visible"
    :title="`隐患详情 - ${modalTitle}`"
    :width="900"
    @cancel="cancelModal"
    :keyboard="false"
    :maskClosable="false"
  >
    <template slot="footer">
      <a-button @click="cancelModal">取消</a-button>
      <a-button type="primary" @click="okModal('stash')" v-if="!disabled">暂存</a-button>
      <a-button type="primary" @click="okModal('submit')" v-if="!disabled">提交</a-button>
    </template>

    <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
      <a-form-model-item label="验收结果" prop="result">
        <a-select v-model="form.result" @change="levelChange" placeholder="请选择验收结果">
          <a-select-option v-for="d in resultOptions" :key="d.value">
            {{ d.label }}
          </a-select-option>
        </a-select>
      </a-form-model-item>
      <a-form-model-item label="验收说明" prop="description">
        <a-textarea v-model="form.description" placeholder="请输入验收说明"></a-textarea>
      </a-form-model-item>

      <a-form-model-item label="相关附件">
        <upload-file
          accept=".jpg, .jpeg, .png"
          :fileList="localePhotos"
          :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'files')"
          :removePro="(file) => removeFile(file, 'files')"
          listType="picture-card"
          :previewEnabled="true"
          preview-mode="fullscreen"
        />
      </a-form-model-item>
    </a-form-model>
  </a-modal>
</template>

<script>
import { getDict } from '@/api/system'
export default {
  components: {},
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    model: {
      type: Object,
      default: () => {
        return {}
      },
    },
    modalTitle: {
      type: String,
      default: '',
    },
  },
  data() {
    return {
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      localePhotos: [],
      form: {
        result: undefined, // 验收结果
        description: '', //  验收说明
        files: [],
      },
      rules: {
        result: [{ required: true, message: '请选择验收结果', trigger: 'blur' }],
        description: [{ required: true, message: '请输入验收说明', trigger: 'blur' }],
      },
    }
  },

  computed: {
    rCoumns: () => RColumns,
  },
  created() {
    this.selectOptionsInit()
  },
  mounted() {},
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },

  methods: {
    selectOptionsInit() {
      const dictKey = 'PERIL_ACCEPT_RESULT'
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.resultOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })
    },
    setFormData(model) {
      if(Object.keys(model).length<2) {
        this.form.reportInformationId = model.reportInformationId
      } else {
        let fileList = model.files
        let photoList = []
        fileList.forEach((element) => {
          let { id, fileName, filePath } = element
          if (id) {
            photoList.push({
              uid: id,
              name: fileName,
              status: 'done',
              id: id,
              url: this.BASE_URL + '/spang-safety/file' + filePath,
            })
          }
        })
        this.localePhotos = photoList
        delete model.files
        model.result = model.result.toString()
        this.form = model
      }
    },

    okModal(key) {
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          if (key == 'submit') {
            this.form.status = 1
          } else {
            this.form.status = 0
          }
          this.$emit('submitok', this.form)
        } else {
          return false
        }
      })
    },
    handleUpload(fileJson, resp, field) {
      if (fileJson.status === 'done' && resp.success) {
        this.form[field].push({
          originalFileName: resp.data.originalFileName,
          fileUrlPath: resp.data.urlPath,
          id: resp.data.id,
        })
      }
    },
    removeFile(file, field) {
      const index = this.form[field].findIndex((item) => item.id === file.id)
      if (index > -1) {
        this.form[field].splice(index, 1)
      }
      const fileIndex = this.localePhotos.findIndex((item) => item.uid === file.uid)
      if (fileIndex > -1) {
        this.localePhotos.splice(fileIndex, 1)
      }
    },
    cancelModal() {
      this.visible = false
      this.$emit('cancel', this.model)
    },
  },
}
</script>

<style lang="less" scoped>
</style>