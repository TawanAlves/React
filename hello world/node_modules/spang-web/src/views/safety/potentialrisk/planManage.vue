<template>
  <!-- 隐患排查计划管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="计划名称">
                <a-input v-model="queryParam.name" placeholder="计划名称" :maxLength="32"></a-input>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="排查日期">
                <a-range-picker
                  v-model="dateOfInvestigation"
                  :valueFormat="dateFormat"
                  @change="dataChange"
                  style="width: 100%;min-width: 110px;"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="检查类型">
                <a-select style="width: 100%" v-model="queryParam.type" placeholder="检查类型">
                  <a-select-option v-for="d in inspectionOptions" :key="d.value">
                    {{ d.label }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
             <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="queryFormData"> 查询 </a-button>
                <a-button type="reset" @click="resetQueryForm"> 重置 </a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
           <a-button
            type="primary"
            icon="plus"
            @click="addPlan"
            style="margin-left: 10px"
            v-if="permission.planManage_add"
          >
            新建
          </a-button>
<!--          <a-button type="primary" icon="plus" @click="addPlan" style="margin-left: 10px"> 新建 </a-button>-->
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: scrollY, x: 1300 }"
        :showIndexColumn="true"
      >
        <!-- 排查开始日期 -->
        <span slot="startTime" slot-scope="text, record">
          <template>
            {{ getTime(record.startTime) }}
          </template>
        </span>
        <!-- 排查结束日期 -->
        <span slot="endTime" slot-scope="text, record">
          <template>
            {{ getTime(record.endTime) }}
          </template>
        </span>
        <!-- 创建时间 -->
        <span slot="createTime" slot-scope="text, record">
          <template>
            {{ getTime(record.createTime) }}
          </template>
        </span>
        <!-- 状态  0未开始 1未完成 2已完成 -->
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">{{
            record.status | textFilter
          }}</a-tag>
        </template>
        <!-- 状态(0未发布 1已派发 2已完成) end -->
        <span slot="action" slot-scope="text, record">
          <template v-if="record.status === 0">
            <a @click="assignPlan(record)" v-if="userInfo.id === record.gmtCreateId || permission.planManage_publish">派发</a>
            <a-divider type="vertical" v-if="userInfo.id === record.gmtCreateId || (permission.planManage_publish && permission.planManage_edit)"/>
            <a @click="editPlan(record)" v-if="userInfo.id === record.gmtCreateId || permission.planManage_edit">编辑</a>
            <a-divider type="vertical" v-if="userInfo.id === record.gmtCreateId || (permission.planManage_edit && permission.planManage_delete)"/>
            <a @click="deletePlan(record)" v-if="userInfo.id === record.gmtCreateId || permission.planManage_delete">删除</a>
          </template>
          <template v-if="record.status !== 0">
            <a @click="viewPlan(record)">查看</a>
          </template>
        </span>
        <!--<span slot="action" slot-scope="text, record">
          <template v-if="record.status === 0 && userInfo.id === record.gmtCreateId">
            <a @click="assignPlan(record)">派发</a>
            <a-divider type="vertical"/>
            <a @click="editPlan(record)">编辑</a>
            <a-divider type="vertical"/>
            <a @click="deletePlan(record)" >删除</a>
          </template>
          <template v-if="record.status !== 0">
            <a @click="viewPlan(record)">查看</a>
          </template>
        </span>-->
      </s-table>
    </a-card>

    <!-- 计划详情弹框 -->
    <plan-modal
      ref="planModal"
      :visible="planVisible"
      :disabled="planDisabled"
      :model="planData"
      :type-options="inspectionOptions"
      :modalTitle="modalTitle"
      @ok="savePlan"
      @cancel="cancelPlan"
    />
    <!-- / 计划详情弹框 -->
    <!-- 计划详情弹框--查看 -->
    <planModalView
      ref="planModalView"
      :visible="planViewVisible"
      :disabled="planViewDisabled"
      :model="planViewData"
      :type-options="inspectionOptions"
      :modalTitle="planModalViewTitle"
      @cancel="cancelPlanView"
    />
    <!-- / 计划详情弹框 -->
  </page-container>
</template>

<script>
import { STable } from '@/components'
import perilPlanApi from '@/api/checkPlandto'
import PlanModal from './planManageMgr/planManageModal.vue'
import planModalView from './planManageMgr/planManageViewModal.vue'
import { potentialPlanColumns } from './planManageMgr/table.js'
import { getDict } from '@/api/system'
import moment from 'moment'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'
export default {
  components: { STable, PlanModal, planModalView },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD',
      dateOfInvestigation: [],
      inspectionOptions: [],
      modalTitle: '',
      scrollY: ``,
      planVisible: false,
      planDisabled: false,
      potentialRiskVisible: false,
      queryParam: {
        name: '',
        endTime: '',
        startTime: '',
        type: undefined,
      },
      loadData: (parameter) => {
        let requesturl = perilPlanApi.planEditByList
        let method = 'GET'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize, ...this.queryParam },
          data: {},
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;',
          },
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          if (res.data.records.length > 0) {
            this.scrollY = `calc(100vh - 434px)`
          } else {
            this.scrollY = ``
          }
          data.data = res.data.records
          return data
        })
      },
      planData: {},

      // 隐患排查计划查看
      planViewDisabled: false,
      planViewVisible: false,
      planViewData: {},
      planModalViewTitle: '查看数据',
      userInfo: getStore({ name: 'info' }),
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => potentialPlanColumns,
  },

  filters: {
    colorFilter: function (value) {
      const colorList = ['orange', 'green', 'green']
      return colorList[value]
    },
    textFilter: function (value) {
      const textList = ['未发布', '已派发', '已完成']
      return textList[value]
    },
  },
  methods: {
    getTime(time) {
      let dateFormat = 'YYYY-MM-DD'
      if (time) {
        return moment(time).format(dateFormat)
      } else {
        return ''
      }
    },
    selectOptionsInit() {
      const dictKey = 'PERIL_CHECK_PLAN_TYPE'
      let options = []
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          options = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
          this.inspectionOptions = options
        }
      })
    },
    dataChange() {
      this.queryParam.startTime = this.dateOfInvestigation[0] + ' 00:00:00' // 计划开始时间
      this.queryParam.endTime = this.dateOfInvestigation[1] + ' 00:00:00' // 计划结束时间
    },
    queryFormData() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    resetQueryForm() {
      this.queryParam = {
        name: '',
        endTime: '',
        startTime: '',
        type: undefined,
      }
      this.dateOfInvestigation = []
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    openPlanViewModal(record) {
      this.planViewDisabled = true
      this.planViewVisible = true
      this.planViewData = record
      this.planModalViewTitle = '查看数据'
    },
    cancelPlanView() {
      this.planViewDisabled = false
      this.planViewVisible = false
      this.planViewData = {}
      this.planModalViewTitle = '查看数据'
    },
    openPlanModal(record = {}, disabled = false) {
      this.planData = record
      this.modalTitle = record && record.id ? '编辑数据' : '新增数据'
      this.planDisabled = disabled
      this.planVisible = true
    },
    closePlanModal() {
      this.planDisabled = false
      this.planVisible = false
      this.planData = {}
    },
    addPlan() {
      this.openPlanModal()
    },
    viewPlan(record) {
      // this.openPlanModal(record, true)
      this.getPlanRequest(record, true)
    },
    editPlan(record) {
      this.getPlanRequest(record, false)
    },
    savePlan(formData) {
      console.log('==== savePlan', formData)
      if (formData.id) {
        // 编辑排查计划
        this.editPlanRequest(formData,1)
      } else {
        // 新增排查计划
        this.addPlanRequest(formData)
      }
    },
    // 新建
    addPlanRequest(formData) {
      let requesturl = perilPlanApi.planEdit
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData,
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;',
        },
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
        _this.closePlanModal()
      })
    },
    // 派发/编辑
    editPlanRequest(formData,type) {
      let requesturl = perilPlanApi.planAdd
      let method = 'put'
      let requestparams = {
        params: {}
      }
      if(type === 1) {
        delete formData.status
        requestparams.data = formData
      } else {
        requestparams.data = {
          status: 1,
          id: formData.id
        }
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;',
        },
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
        _this.closePlanModal()
      })
    },
    // 删除
    deletePlanRequest(record) {
      let requesturl = perilPlanApi.planEelete
      let method = 'delete'
      let requestparams = {
        params: {
          id: record.id,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;',
        },
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
        _this.closePlanModal()
      })
    },
    // 根据id获取排查计划信息
    getPlanRequest(record, flag) {
      let requesturl = perilPlanApi.planEditByid
      let method = 'get'
      let requestparams = {
        params: {
          id: record.id,
        },
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;',
        },
      }

      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        if (flag) {
          this.openPlanViewModal(res.data)
        } else {
          this.openPlanModal(res.data)
        }
      })
    },
    cancelPlan() {
      this.closePlanModal()
    },
    assignPlan(record) {
      this.editPlanRequest(record,0)
    },
    deletePlan(record) {
      let _this = this
      this.$confirm({
        title: '你确定要删除吗？',
        // content: 'When clicked the OK button, this dialog will be closed after 1 second',
        onOk() {
          _this.deletePlanRequest(record)
        },
        onCancel() {},
      })
    },
  },
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}
</style>