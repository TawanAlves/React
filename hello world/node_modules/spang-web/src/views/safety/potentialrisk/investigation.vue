<template>
  <page-container :title="false">
    <a-card :bordered="false">
      <div class="table-page-search-wrapper" :body-style="{'padding-bottom': '0px'}">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="关键字">
                <a-input v-model="queryParam.blurry" placeholder="关键字"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="隐患级别">
                <a-select v-model="queryParam.level">
                  <a-select-option v-for="d in riskLevelOptions" :key="d.dictKey">{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="类别">
                <a-select v-model="queryParam.type">
                  <a-select-opt-group v-for="item in riskTypeOptions" :key="item.dictValue">
                    <a-select-option v-for="d in item.children" :key="d.dictKey">{{ d.dictValue }}</a-select-option>
                  </a-select-opt-group>
                </a-select>
              </a-form-item>
            </a-col>
          </a-row>
          <a-row>
            <a-col :lg="6" :md="8" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="investResearch">查询</a-button>
                <a-button type="second" @click="investRefresh">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
          <a-row :gutter="24">
            <a-col :md="6">
              <a-form-item label="整改期限">
                <a-range-picker v-model="queryParam.abarbeitungDeadline" :valueFormat="dateFormat" />
              </a-form-item>
            </a-col>
            <a-col :md="6">
              <a-form-item label="检查时间">
                <a-range-picker v-model="queryParam.checkTime" :valueFormat="dateFormat" />
              </a-form-item>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <div class="table-operator" v-if="false">
        <a-button type="primary" icon="plus" @click="investAdd">新增</a-button>
        <a-button icon="delete" :disabled="!hasSelected" @click="investRemove">删除</a-button>
        <a-button icon="download" :disabled="!hasSelected" @click="fileDownload">导出当前</a-button>
        <a-button icon="download" @click="filesDownload">导出所有</a-button>
        <a-button icon="upload" @click="fileUpload">导入</a-button>
      </div>
      <s-table
        ref="investTable"
        size="default"
        :rowKey="(record) => record.id"
        :scroll="{ x: 1000, y: `calc(100vh - 360px)` }"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="false"
        showPagination="true"
      >
        <span slot="statusName" slot-scope="text, record">
          <a-tag :color="[4].includes(record.status) ? 'red' : 'green'">{{ text }}</a-tag>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="investCheck(record)">编辑</a>
            <!--            <a-divider type="vertical"/>-->
            <!--            <a @click="investRemove(record)">删除</a>-->
            <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-right: 4px;margin-left: 4px">-->
            <!--              <a-button type="primary" size="small" @click="investCheck(record)"><a-icon type="file-search"/> 查看</a-button>-->
            <!--            </a-config-provider>-->
            <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-right: 4px;margin-left: 4px">-->
            <!--              <a-button type="primary" size="small" @click="investRemove(record)"><a-icon type="delete"/>删除</a-button>-->
            <!--            </a-config-provider>-->
            <!--            <a @click="investCheck(record)">查看</a>-->
            <!--            <a-divider type="vertical"/>-->
            <!--            <a @click="investRemove(record)">删除</a>-->
          </template>
        </span>
      </s-table>
      <detail-modal
        ref="detailModal"
        :basic-info="detailInfo"
        :visible="detailVisible"
        @cancel="detailCancel"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { invest, getPotentialRiskType, getPotentialRiskLevel } from '@/api/safety'
import { investColumns } from '@/views/safety/table'
import DetailModal from '@/views/safety/potentialrisk/components/DetailModal'

export default {
  components: {
    STable,
    DetailModal
  },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return invest.getInvestList(requestParameters).then(res => {
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      // select options
      riskLevelOptions: [],
      riskTypeOptions: [],
      // detail modal
      // detailId: '',
      detailVisible: false,
      detailInfo: {}
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    columns: () => investColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectOptionsInit() {
      getPotentialRiskType().then(res => {
        this.riskTypeOptions = res.data
      })
      getPotentialRiskLevel().then(res => {
        this.riskLevelOptions = res.data
      })
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    investResearch() {
      this.$refs.investTable.refresh(true)
      this.$refs.investTable.clearSelected()
    },
    investRefresh() {
      this.queryParam = {}
      this.$refs.investTable.refresh(true)
      this.$refs.investTable.clearSelected()
    },
    investAdd() {
      // this.$message.success('新增')
    },
    investRemove() {
      this.$message.success('删除')
    },
    investCheck(record) {
      // this.detailId = record.id
      this.detailInfo = { ...record }
      this.detailVisible = true
      // this.$message.success('查看')
    },
    investEdit(record) {
      // this.$message.success('编辑')
    },
    fileDownload() {
      this.$message.success('导出当前文件')
    },
    filesDownload() {
      this.$message.success('导出所有文件')
    },
    fileUpload() {
      this.$message.success('上传文件')
    },
    detailCancel() {
      this.detailId = ''
      this.detailVisible = false
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: calc(100vh - 295px);
}
/deep/ .ant-card-body {
  .ant-table-wrapper {
    min-height: calc(100vh - 235px);
  }
}
</style>
