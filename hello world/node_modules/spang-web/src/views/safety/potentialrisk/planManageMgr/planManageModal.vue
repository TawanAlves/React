<template>
  <div>
    <a-modal
      :visible="visible"
      :width="900"
      :title="modalTitle"
      :confirmLoading="loading"
      ok-text="确定"
      cancel-text="取消"
      @ok="savePlan"
      @cancel="cancelPlan"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="cancelPlan">取消</a-button>
        <a-button type="primary" @click="savePlan">确定</a-button>
      </template>
      <div>
        <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-model-item label="计划名称" prop="name">
                <a-input
                  v-model="form.name"
                  :disabled="disabled"
                  placeholder="请输入计划名称"
                  :maxLength="32"
                ></a-input>
              </a-form-model-item>

              <a-form-model-item label="排查日期" prop="startTime">
                <a-range-picker
                  v-model="dateOfInvestigation"
                  :valueFormat="dateFormat"
                  @change="dataChange"
                  style="width: 100%"
                  :disabled="disabled"
                />
              </a-form-model-item>
              <a-form-model-item label="负责人" prop="principalId">
                <PersonListSelect
                  :value="form.principalId"
                  @change="personChange"
                  :disabled="disabled"
                  placeholder="请选择负责人"
                ></PersonListSelect>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="检查类型" prop="type">
                <a-select v-model="form.type" :disabled="disabled" placeholder="请选择检查类型">
                  <a-select-option v-for="s in typeOptions" :key="s.value">
                    {{ s.label }}
                  </a-select-option>
                </a-select>
              </a-form-model-item>

              <a-form-model-item label="组织单位" prop="organizeUnitId">
                <department-select :value="form.organizeUnitId" @change="organizeChange" :disabled="disabled" />
              </a-form-model-item>
              <a-form-model-item label="排查单位" prop="checkUnitId">
                <department-select :value="form.checkUnitId" @change="checkUnitChange" :disabled="disabled" />
              </a-form-model-item>
            </a-col>
          </a-row>
        </a-form-model>
        <div style="margin-bottom: 25px">
          <a-row>
            <a-col :span="2"><b>风险点</b></a-col>
            <a-col :span="22">
              <a-space v-if="!disabled">
                <a-button type="primary" @click="selectRiskPoint">添加</a-button>
                <a-button type="primary" @click="selectPerson" :disabled="selectedRowKeys.length > 0 ? false : true">
                  批量选择联系人
                </a-button>
              </a-space>
            </a-col>
          </a-row>
        </div>

        <s-table
          ref="reformTable"
          :rowKey="(record) => record.id"
          :columns="columnsPotentialFactorAdd"
          :data="loadRiskPointListData"
          :alert="false"
          :showPagination="false"
          :scroll="{ y: `300px` }"
          :row-selection="{
            selectedRowKeys: selectedRowKeys,
            onChange: onSelectChange,
            type: rowSelectMode,
          }"
        >
          <span slot="planCheckPerson" slot-scope="text, record, index">
            <div v-for="(item, i) in record.checkPlanCheckPersonList" :key="index + item.checkPersonId + i">
              {{ item.checkPersonName }}
            </div>
          </span>
          <span slot="action" slot-scope="text, record">
            <a-space>
              <a-button type="link" shape="round" size="small" @click="editPlan(record)">选择</a-button>
            </a-space>
          </span>
        </s-table>
      </div>
    </a-modal>

    <plan-risK-point-modal
      v-if="visible"
      :visible="potentialRiskVisible"
      title="选择风险点"
      width="80%"
      :pointSelectedList="pointSelectedList"
      @ok="reCallSelectRiskPoint"
      @cancel="potentialRiskVisible = false"
    ></plan-risK-point-modal>
    <person-select-modal
      :visible.sync="peopleVisible"
      :loading="confirmLoadingPeople"
      @ok="submitPeople"
      title="添加人员"
      :multiple="true"
    />
  </div>
</template>

<script>
import { STable } from '@/components'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
import PlanRisKPointModal from './planRiskPointModal'
import { columnsPotentialFactorNew } from './table'

export default {
  name: 'planModal',
  components: {
    DepartmentSelect,
    PersonSelectModal,
    PlanRisKPointModal,
    STable,
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {},
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    typeOptions: {
      type: Array,
      default: [],
    },
  },
  computed: {
    columnsPotentialFactorAdd: () => columnsPotentialFactorNew,
  },
  data() {
    return {
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      form: {
        name: '', // 计划名称
        startTime: '', // 计划开始时间
        endTime: '', // 计划结束时间
        principalId: undefined, // 负责人id
        principalName: '', // 负责人名称
        type: undefined, // 检查类型
        organizeUnitId: undefined, // 组织单位id
        organizeUnitName: '', // 组织单位名称
        checkUnitId: undefined, // 排查单位id
        checkUnitName: '', // 排查单位名称
        checkPlanPerilPointList: [],
      },
      dateOfInvestigation: [],
      rules: {
        name: [{ required: true, message: '请输入计划名称', trigger: 'blur' }],
        startTime: [{ required: true, message: '请选择排查日期', trigger: 'blur' }],
        principalId: [{ required: true, message: '请选择负责人', trigger: 'blur' }],
        type: [{ required: true, message: '请选择检查类型', trigger: 'blur' }],
        organizeUnitId: [{ required: true, message: '请选择组织单位', trigger: 'blur' }],
        checkUnitId: [{ required: true, message: '请选择排查单位', trigger: 'blur' }],
      },
      riskListData: [],
      potentialRiskVisible: false,
      selectedRiskPoint: [],

      peopleVisible: false,
      confirmLoadingPeople: false,
      userListTarget: '',
      userList: [],

      rowSelectMode: 'checkbox',
      selectedRowKeys: [],
      selectedRows: [],

      pointSelectedList: [], // 风险点
    }
  },
  created() {
    this.potentialRiskVisible = false
  },
  mounted() {},
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  methods: {
    setFormData(model) {
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()

      if (model && model.id) {
        this.form = JSON.parse(JSON.stringify(model))
        this.form.type = this.form.type.toString()
        this.pointSelectedList = this.form.checkPlanPerilPointList
        this.selectedRiskPoint = this.form.checkPlanPerilPointList
        this.dateOfInvestigation = [this.form.startTime, this.form.endTime]
      } else {
        this.form = {
          name: '', // 计划名称
          startTime: '', // 计划开始时间
          endTime: '', // 计划结束时间
          principalId: undefined, // 负责人id
          principalName: '', // 负责人名称
          type: undefined, // 检查类型
          organizeUnitId: undefined, // 组织单位id
          organizeUnitName: '', // 组织单位名称
          checkUnitId: undefined, // 排查单位id
          checkUnitName: '', // 排查单位名称
          checkPlanPerilPointList: [],
        }

        this.selectedRiskPoint = []
        this.pointSelectedList = []
      }

      this.$nextTick(() => {
        this.$refs.reformTable.refresh(true)
      })

      this.dateOfInvestigation = [this.form.startTime, this.form.endTime]
    },
    dataChange() {
      this.form.startTime = this.dateOfInvestigation[0] // 计划开始时间
      this.form.endTime = this.dateOfInvestigation[1] // 计划结束时间
    },
    personChange(val) {
      this.form.principalName = val.person.name
      this.form.principalId = val.id
    },
    organizeChange(val) {
      this.form.organizeUnitId = val.id
      this.form.organizeUnitName = val.label
    },
    checkUnitChange(val) {
      this.form.checkUnitId = val.id
      this.form.checkUnitName = val.label
    },
    reCallSelectRiskPoint(selectItems) {
      let list = []
      selectItems.forEach((element) => {
        let { areaLocation, riskLevelName, id, riskName, typeName, typeId } = element
        list.push({
          address: areaLocation, // 位置/区域
          controlLevel: riskLevelName, //	管控级别
          perilPointId: id, // 风险点id
          perilPointName: riskName, // 风险点名称
          type: typeName, //类型
          typeKey: typeId,
          checkPlanCheckPersonList: [],
        })
      })
      let oriselectedRiskPoint = JSON.parse(JSON.stringify(this.selectedRiskPoint))
      let newselectedRiskPoint = []
      let newlist = JSON.parse(JSON.stringify(list))
      newlist.forEach((element, index) => {
        oriselectedRiskPoint.forEach((item, k) => {
          if (element.perilPointId == item.perilPointId) {
            newlist[index] = item
          }
        })
      })
      newselectedRiskPoint = newlist
      this.selectedRiskPoint = JSON.parse(JSON.stringify(newselectedRiskPoint))
      this.pointSelectedList = JSON.parse(JSON.stringify(newselectedRiskPoint))
      this.potentialRiskVisible = false
      this.$refs.reformTable.refresh(true)
    },
    loadRiskPointListData() {
      return new Promise((reslove, reject) => {
        const data = this.selectedRiskPoint
        const list = {
          // totalCount: data.length,
          // totalPage: data.length,
          // pageNo: 1,
          // pageSize: data.length,
          data: data,
        }
        return reslove(list)
      })
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    selectRiskPoint() {
      this.potentialRiskVisible = true
    },
    selectPerson() {
      this.userListTarget = ''
      this.peopleVisible = true
    },
    editPlan(record) {
      this.userListTarget = record.perilPointId
      this.peopleVisible = true
    },
    // 校验校验表单数据
    submitForm() {
      let flag = false
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          flag = true
        } else {
          flag = false
        }
      })
      return flag
    },
    // 校验风险点
    perilPointsubmitForm(list) {
      let flag = false
      if (list.length > 0) {
        flag = true
      } else {
        flag = false
      }
      return flag
    },
    checkPersonListsubmitForm(list) {
      let flag = false
      if (list.length > 0) {
        for (let index = 0; index < list.length; index++) {
          const element = list[index]
          if (element.checkPlanCheckPersonList.length == 0) {
            flag = false
            break
          } else {
            flag = true
          }
        }
      } else {
        flag = false
      }
      return flag
    },
    // 校验风险点
    savePlan() {
      // 校验表单数据
      this.submitForm()
      // 校验风险点
      this.perilPointsubmitForm(this.selectedRiskPoint)
      // 校验选择排查人
      this.checkPersonListsubmitForm(this.selectedRiskPoint)

      if (!this.submitForm()) {
        return false
      }
      if (!this.perilPointsubmitForm(this.selectedRiskPoint)) {
        let message = '请选择风险点'
        this.$message.error(message)
        return false
      }
      if (!this.checkPersonListsubmitForm(this.selectedRiskPoint)) {
        let message = '请选择风险排查人'
        this.$message.error(message)
        return false
      }

      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          this.form.checkPlanPerilPointList = JSON.parse(JSON.stringify(this.selectedRiskPoint))
          let formData = JSON.parse(JSON.stringify(this.form))
          this.$emit('ok', formData)
          this.resetPage()
        } else {
          return false
        }
      })
    },
    resetPage() {
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
      this.selectedRowKeys = []
      this.selectedRows = []
    },
    cancelPlan() {
      this.$refs.ruleForm.resetFields()
      this.potentialRiskVisible = false
      this.$emit('cancel')
    },

    //点击添加人员
    addPeople() {
      this.peopleVisible = true
    },
    //添加人员确定
    submitPeople(data) {
      let arrs = [...data]
      //根据id去重
      let map = new Map()
      let list = []
      for (let item of arrs) {
        // item.checkPersonId = item.userId
        // item.checkPersonName = item.userName
        if (!map.has(item.userId)) {
          list.push({
            checkPersonId: item.userId,
            checkPersonName: item.userName,
          })
          map.set(item.userId, item)
        }
      }

      this.setFormdatacheckPeople(list)
    },
    setFormdatacheckPeople(newArr) {
      if (this.userListTarget) {
        let list = JSON.parse(JSON.stringify(this.selectedRiskPoint))
        list.forEach((element, index) => {
          let { perilPointId } = element
          if (perilPointId == this.userListTarget) {
            let oriList = JSON.parse(JSON.stringify(this.selectedRiskPoint[index].checkPlanCheckPersonList))
            let newList = oriList.concat(newArr)
            this.selectedRiskPoint[index].checkPlanCheckPersonList = this.arraydeduplication(newList, 'checkPersonId')
          }
        })
      } else {
        let list = JSON.parse(JSON.stringify(this.selectedRows))
        list.forEach((element, index) => {
          let oriList = JSON.parse(JSON.stringify(this.selectedRows[index].checkPlanCheckPersonList))
          let newList = oriList.concat(newArr)
          this.selectedRows[index].checkPlanCheckPersonList = this.arraydeduplication(newList, 'checkPersonId')
        })
        this.selectedRiskPoint.forEach((element1, index1) => {
          this.selectedRows.forEach((element2, index2) => {
            if (element1.perilPointId == element2.perilPointId) {
              this.selectedRiskPoint[index1].checkPlanCheckPersonList = element2.checkPlanCheckPersonList
            }
          })
        })
      }

      this.$refs.reformTable.refresh(true)
    },
    // 数组去重
    arraydeduplication(arr, key) {
      var result = []
      var obj = {}
      for (var i = 0; i < arr.length; i++) {
        if (!obj[arr[i][key]]) {
          result.push(arr[i])
          obj[arr[i][key]] = true
        }
      }
      return result
    },
  },
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
}
</style>
