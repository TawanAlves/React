<template>
  <div>
    <a-modal
      :visible="visible"
      title="选择风险点"
      :width="900"
      @ok="doneRiskPoint"
      @cancel="cancelRiskPoint"
      :keyboard="false"
      :maskClosable="false"
    >
      <div>
        <a-row style="min-height: 500px">
          <a-col :span="5">
            <a-tree
              class="left-tree"
              :tree-data="treeData"
              :expanded-keys="expandedKeys"
              :auto-expand-parent="autoExpandParent"
              @expand="onExpand"
              @select="onSelectBranch"
              :replaceFields="replaceFields"
              :default-selected-keys="['0-0-0']"
            >
              <a-icon slot="switcherIcon" type="down" />
              <a-icon slot="smile" type="smile-o" />
              <a-icon slot="meh" type="smile-o" />
              <template slot="custom" slot-scope="{ selected }">
                <a-icon :type="selected ? 'frown' : 'frown-o'" />
              </template>
            </a-tree>
          </a-col>
          <a-col :span="14" :gutter="20">
            <a-form layout="inline">
              <a-row>
                <a-col :span="9">
                  <a-form-item label="风险类型">
                    <a-select v-model="queryParam.riskTypeId" size="small" style="width: 100px">
                      <a-select-option v-for="d in riskTypeOptions" :key="d.value">
                        {{ d.label }}
                      </a-select-option>
                    </a-select>
                  </a-form-item>
                </a-col>
                <a-col :span="9">
                  <a-form-item label="风险级别">
                    <a-select v-model="queryParam.riskLevelId" size="small" style="width: 100px">
                      <a-select-option v-for="d in riskLevelOptions" :key="d.value">
                        {{ d.label }}
                      </a-select-option>
                    </a-select>
                  </a-form-item>
                </a-col>
                <a-col :span="6">
                  <a-form-item>
                    <a-space align="end">
                      <a-button type="primary" size="small" @click="searchData()">查询</a-button>
                      <a-button type="normal" size="small" @click="searchData(true)">重置</a-button>
                    </a-space></a-form-item
                  ></a-col
                >
              </a-row>

              <s-table
                ref="formTable"
                size="small"
                :rowKey="(record) => record.id"
                :columns="columnsPotentialFactor"
                :data="loadData"
                :alert="false"
                :showPagination="true"
                :scroll="{ y: `350px` }"
                :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
                :pagination="true"
                style="margin-top: 10px"
                :showIndexColumn="true"
              >
              </s-table>
            </a-form>
          </a-col>
          <a-col :span="5">
            <div style="margin-top: 5px">
              <h3>已选择</h3>
              <div v-for="(item, index) in selectRiskPoint" :key="item.id">
                <div @click="unSelectPoint(index, item)" style="margin: 0 0 10px 15px; cursor: pointer">
                  <a-checkbox checked=""> </a-checkbox> <span>{{ item.riskName }}</span>
                </div>
              </div>
            </div>
          </a-col>
        </a-row>
      </div>
    </a-modal>
  </div>
</template>

<script>
import { getDict } from '@/api/system'
import ApiURLs from '@/api/urls'
import { STable } from '@/components'
import { getRiskPointListData } from '@/api/safety'
import Area from '@/views/safety/risk/Area.vue'
import { getChildNodesIds } from '@/utils/util'
import { columnsPotentialFactor } from './table'

const MAIN_NAME = '神木天元化工有限公司'
export default {
  name: 'SpangWebPlanriskpointselect',

  components: { Area, STable },

  // directives: { DirectiveName },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {},
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    rowSelectMode: {
      type: String,
      default: 'checkbox',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    typeOptions: {
      type: Array,
      default: [],
    },
    pointSelectedList: {
      type: Object,
      default: () => {},
      // type: Array,
      // default: function () {
      //   return []
      // },
    },
  },
  data() {
    return {
      treeData: [],
      replaceFields: Object.freeze({
        title: 'mainName',
        key: 'id',
        children: 'children',
        value: 'id',
      }),
      expandedKeys: [],
      autoExpandParent: true,
      riskLevelOptions: [],
      riskTypeOptions: [],
      queryParam: {},
      selectRiskPoint: [],
      tableData: { data: [] },

      selectedRowKeys: [],
      selectedRows: [],
      loadData: (parameter) => {
        const postData = { ...this.queryParam }
        let mainIds
        if (this.queryParam.nodeId !== 0) {
          mainIds = getChildNodesIds(this.treeData, this.queryParam.nodeId)
          if (mainIds) {
            postData.areaLocationIds = mainIds
          }
        }
        postData.current = parameter.pageNo
        postData.size = parameter.pageSize
        delete postData.nodeId
        delete postData.type
        // debugger;
        return getRiskPointListData(postData).then((res) => {
          if (res.success && res.code === 200) {
            const list = {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: res.data.records,
            }
            this.tableData = list
            return list
          }
        })
      },
    }
  },
  created() {
    this.selectOptionsInit()
    this.getTreeData()
  },
  mounted() {},

  computed: {
    columnsPotentialFactor: () => columnsPotentialFactor,
  },
  watch: {
    visible: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        if (newV) {
          this.setselectedRowKeys(this.pointSelectedList)
        }
      },
    },
    pointSelectedList: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        // if (newV) {
        //   this.setselectedRowKeys(this.pointSelectedList)
        // }
      },
    },
  },

  methods: {
    setselectedRowKeys(list) {
      let newList = []
      let selectRiskPointList = []

      list.forEach((element) => {
        let { perilPointId, perilPointName, address, controlLevel, type, typeKey } = element
        newList.push(perilPointId)
        selectRiskPointList.push({
          areaLocation: address,
          riskLevelName: controlLevel,
          id: perilPointId,
          riskName: perilPointName,
          typeName: type,
          typeId: typeKey,
        })
      })
      this.selectedRowKeys = newList
      this.selectRiskPoint = selectRiskPointList
    },
    onSelectChange(selectedRowKeys, selectedRow) {
      this.selectedRowKeys = selectedRowKeys
      let outsideArr = JSON.parse(JSON.stringify(this.selectedRows))
      let insideArr = JSON.parse(JSON.stringify(selectedRow))
      let newArr = outsideArr.concat(insideArr)
      let list = this.getSelectList(newArr, selectedRowKeys)

      this.selectedRows = list
      this.selectRiskPoint = JSON.parse(JSON.stringify(this.selectedRows))
    },
    getSelectList(arr, rowKeys) {
      let listout = []
      let listin = []
      for (let index = 0; index < arr.length; index++) {
        const element = arr[index]
        if (rowKeys.indexOf(element.id) > -1) {
          listout.push(element)
        }
      }
      listin = this.arraydeduplication(listout, 'id')
      return listin
    },
    // 数组去重
    arraydeduplication(arr, key) {
      var result = []
      var obj = {}
      for (var i = 0; i < arr.length; i++) {
        if (!obj[arr[i][key]]) {
          result.push(arr[i])
          obj[arr[i][key]] = true
        }
      }
      return result
    },
    unSelectPoint(index, item) {
      this.selectRiskPoint.splice(index, 1)
      this.selectedRowKeys.splice(index, 1)
    },
    searchData(isreset = false) {
      if (isreset) {
        this.queryParam = {}
      }

      this.selectedRows = []
      this.$refs.formTable.refresh(true)
      this.$refs.formTable.clearSelected()
    },
    doneRiskPoint() {
      this.potentialRiskVisible = false
      this.$emit('ok', [...this.selectRiskPoint])

      // this.pointSelectedList = []
    },
    cancelRiskPoint() {
      this.potentialRiskVisible = false
      this.$emit('cancel', { ...{}, ...this.queryParam })
      // this.pointSelectedList = []
    },
    selectOptionsInit() {
      const dictKey = 'RISK_LEVEL'
      let options = []
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.riskLevelOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.id,
            }
          })
          options = this.riskLevelOptions
        }
      })

      getDict('RISK_TYPE').then(({ data, success }) => {
        if (success) {
          this.riskTypeOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.id,
            }
          })
          options = this.riskTypeOptions
        }
      })
    },
    onSelectBranch(selectedKeys, info) {
      this.queryParam.nodeId = selectedKeys[0]
      this.parentNodeName = info.node.dataRef.mainName
      this.$refs.formTable.refresh()
      this.expandedKeys = [...this.expandedKeys, ...selectedKeys]
    },
    onExpand(expandedKeys) {
      this.expandedKeys = expandedKeys
      this.autoExpandParent = false
    },
    getTreeData() {
      this.getList(ApiURLs.areaTreeList, 0).then((res) => {
        if (res.success) {
          res.data = [
            {
              id: 0,
              children: res.data,
              parentId: -1,
              mainName: MAIN_NAME,
            },
          ]
          this.treeData = res.data
          if (this.expandedKeys.length === 0) {
            this.expandedKeys.push(this.treeData[0].id)
          }
        }
      })
    },
  },
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
  padding: 12px;
}
</style>