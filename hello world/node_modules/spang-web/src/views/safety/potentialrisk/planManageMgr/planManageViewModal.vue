<template>
  <div>
    <a-modal
      :visible="visible"
      :width="900"
      :title="modalTitle"
      :confirmLoading="loading"
      cancel-text="取消"
      @cancel="cancelPlan"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="cancelPlan">取消</a-button>
      </template>
      <div>
        <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-model-item label="计划名称" prop="name">
                <a-input v-model="form.name" :disabled="disabled" placeholder="请输入计划名称"></a-input>
              </a-form-model-item>

              <a-form-model-item label="排查日期" prop="startTime">
                <a-range-picker
                  v-model="dateOfInvestigation"
                  :valueFormat="dateFormat"
                  @change="dataChange"
                  style="width: 100%"
                  :disabled="disabled"
                />
              </a-form-model-item>
              <a-form-model-item label="负责人" prop="principalId">
                <PersonListSelect
                  :value="form.principalId"
                  @change="personChange"
                  :disabled="disabled"
                  placeholder="请选择负责人"
                ></PersonListSelect>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="检查类型" prop="type">
                <a-select v-model="form.type" :disabled="disabled" placeholder="请选择检查类型">
                  <a-select-option v-for="s in typeOptions" :key="s.value">
                    {{ s.label }}
                  </a-select-option>
                </a-select>
              </a-form-model-item>

              <a-form-model-item label="组织单位" prop="organizeUnitId">
                <department-select :value="form.organizeUnitId" @change="organizeChange" :disabled="disabled" />
              </a-form-model-item>
              <a-form-model-item label="排查单位" prop="checkUnitId">
                <department-select :value="form.checkUnitId" @change="checkUnitChange" :disabled="disabled" />
              </a-form-model-item>
            </a-col>
          </a-row>
        </a-form-model>
        <div style="margin-bottom: 25px">
          <a-row>
            <a-col :span="2"><b>风险点</b></a-col>
          </a-row>
        </div>

        <s-table
          ref="reformTable"
          :rowKey="(record) => record.id"
          :columns="columnsPotentialFactorView"
          :data="loadRiskPointListData"
          :alert="false"
          :showPagination="false"
          :scroll="{ y: `300px` }"
        >
          <span slot="planCheckPerson" slot-scope="text, record, index">
            <div v-for="(item, i) in record.checkPlanCheckPersonList" :key="index + item.checkPersonId + i">
              {{ item.checkPersonName }}
            </div>
          </span>
        </s-table>
      </div>
    </a-modal>
  </div>
</template>

<script>
import { STable } from '@/components'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import { columnsPotentialFactorView } from './table'

export default {
  name: 'planModal',
  components: {
    DepartmentSelect,
    STable,
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {},
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    typeOptions: {
      type: Array,
      default: [],
    },
  },
  computed: {
    columnsPotentialFactorView: () => columnsPotentialFactorView,
  },
  data() {
    return {
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      form: {
        name: '', // 计划名称
        startTime: '', // 计划开始时间
        endTime: '', // 计划结束时间
        principalId: undefined, // 负责人id
        principalName: '', // 负责人名称
        type: undefined, // 检查类型
        organizeUnitId: undefined, // 组织单位id
        organizeUnitName: '', // 组织单位名称
        checkUnitId: undefined, // 排查单位id
        checkUnitName: '', // 排查单位名称
        checkPlanPerilPointList: [],
      },
      dateOfInvestigation: [],
      rules: {
        name: [{ required: true, message: '请输入计划名称', trigger: 'blur' }],
        startTime: [{ required: true, message: '请选择排查日期', trigger: 'blur' }],
        principalId: [{ required: true, message: '请选择负责人', trigger: 'blur' }],
        type: [{ required: true, message: '请选择检查类型', trigger: 'blur' }],
        organizeUnitId: [{ required: true, message: '请选择组织单位', trigger: 'blur' }],
        checkUnitId: [{ required: true, message: '请选择排查单位', trigger: 'blur' }],
      },
      riskListData: [],
      selectedRiskPoint: [],

      pointSelectedList: [], // 风险点
    }
  },
  created() {},
  mounted() {},
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  methods: {
    setFormData(model) {
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
      if (model && model.id) {
        this.form = JSON.parse(JSON.stringify(model))
        this.form.type = this.form.type.toString()
        this.pointSelectedList = this.form.checkPlanPerilPointList
        this.selectedRiskPoint = this.form.checkPlanPerilPointList
        this.dateOfInvestigation = [this.form.startTime, this.form.endTime]
      } else {
        this.form = {
          name: '', // 计划名称
          startTime: '', // 计划开始时间
          endTime: '', // 计划结束时间
          principalId: undefined, // 负责人id
          principalName: '', // 负责人名称
          type: undefined, // 检查类型
          organizeUnitId: undefined, // 组织单位id
          organizeUnitName: '', // 组织单位名称
          checkUnitId: undefined, // 排查单位id
          checkUnitName: '', // 排查单位名称
          checkPlanPerilPointList: [],
        }

        this.selectedRiskPoint = []
        this.pointSelectedList = []
      }

      this.$nextTick(() => {
        this.$refs.reformTable.refresh(true)
      })

      this.dateOfInvestigation = [this.form.startTime, this.form.endTime]
    },
    dataChange() {
      this.form.startTime = this.dateOfInvestigation[0] // 计划开始时间
      this.form.endTime = this.dateOfInvestigation[1] // 计划结束时间
    },
    personChange(val) {
      this.form.principalName = val.person.name
      this.form.principalId = val.id
    },
    organizeChange(val) {
      this.form.organizeUnitId = val.id
      this.form.organizeUnitName = val.label
    },
    checkUnitChange(val) {
      this.form.checkUnitId = val.id
      this.form.checkUnitName = val.label
    },
    loadRiskPointListData() {
      return new Promise((reslove, reject) => {
        const data = this.selectedRiskPoint
        const list = {
          // totalCount: data.length,
          // totalPage: data.length,
          // pageNo: 1,
          // pageSize: data.length,
          data: data,
        }
        return reslove(list)
      })
    },
    cancelPlan() {
      this.$refs.ruleForm.resetFields()
      this.potentialRiskVisible = false
      this.$emit('cancel')
    },
  },
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
}
</style>
