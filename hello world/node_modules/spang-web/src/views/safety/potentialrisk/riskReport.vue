<template>
  <!-- 隐患上报管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="12" :sm="12" :xs="24" >
              <a-form-item label="隐患名称">
                <a-input v-model="queryParam.name" placeholder="隐患名称"></a-input>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="12" :sm="12" :xs="24" >
              <a-form-item label="上报日期">
                <a-range-picker
                  v-model="dateOfInvestigation"
                  :valueFormat="dateFormat"
                  @change="dataChange"
                  style="width: 100%; min-width: 110px;"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="12" :sm="12" :xs="24" >
              <a-form-item label="排查类型">
                <a-select style="width: 100%" v-model="queryParam.type" placeholder="排查类型">
                  <a-select-option v-for="d in inspectionOptions" :key="d.value">{{ d.label }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="12" :sm="12" :xs="24" >
              <a-form-item label="状态">
                <a-select style="width: 100%" v-model="queryParam.status" placeholder="状态">
                  <a-select-option v-for="d in inspectionStatusOptions" :key="d.value">{{ d.label }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col  :lg="24" :md="24" :sm="24" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="queryFormData">查询</a-button>
                <a-button type="reset" @click="resetQueryForm">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button
            type="primary"
            icon="plus"
            @click="addReport"
            style="margin-left: 10px"
            v-if="permission.riskReport_add"
          >新建</a-button>
        </div>
      </template>
      <s-table
        style="
           {
            word-break: break-all;
          }
        "
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :scroll="{ y: `calc(100vh - 500px)`, x: 1330 }"
        :showIndexColumn="true"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
      >
        <!-- 状态  -->
        <template slot="status" slot-scope="text, record">
          <a-tag
            :color="record.status | colorFilter"
            style="margin-right: 0 !important"
          >{{ record.status | textFilter }}</a-tag>
        </template>
        <!-- 状态 end -->

        <span slot="action" slot-scope="text, record">
          <template v-if="record.status === 0 && userInfo.id === record.gmtCreateId">
            <a @click="reportRisk(record)">提交</a>
            <a-divider type="vertical" />
            <a @click="editReport(record)">编辑</a>
            <a-divider type="vertical" />
            <a @click="deleteReport(record)">删除</a>
          </template>
          <template v-if="record.status !==0">
            <a @click="viewReport(record)">查看</a>
            <a-divider
              type="vertical"
              v-if="record.status === 1 && userInfo.id === record.gmtCreateId"
            />
            <a
              @click="revert(record)"
              v-if="record.status === 1 && userInfo.id === record.gmtCreateId"
            >撤回</a>
          </template>
        </span>
      </s-table>
    </a-card>
    <!-- 隐患上报弹窗弹框 -->
    <risk-checkin-modal
      :visible="checkinModalVisible"
      :model="reportData"
      :isNewReport="true"
      :disabled="isView"
      :modalTitle="modalTitle"
      @ok="savePlan"
      @cancel="cancelPlan"
      :multiple="false"
    />
    <!-- / 隐患上报弹窗弹框 -->

    <!-- 隐患详情查看弹窗弹框 -->
    <assessDetailView
      :visible.sync="riskDetailModalVisible"
      :model="reportdetailData"
      :isNewReport="true"
      :modalTitle="''"
      @cancel="cancelRiskDetail"
    ></assessDetailView>
    <!-- / 隐患详情查看弹窗弹框 -->
  </page-container>
</template>

<script>
import { STable } from '@/components'
import RiskCheckinModal from '@/views/safety/potentialrisk/components/riskCheckinModal'
import RiskDetailModal from '@/views/safety/potentialrisk/components/riskDetail'
import assessDetailView from './assessMgr/assessDetailView'
import { getDict } from '@/api/system'

import riskReportApi from '@/api/riskReport'

import { potentialPlanColumns } from './riskReportMgr/table'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'

export default {
  components: { STable, RiskCheckinModal, RiskDetailModal, assessDetailView },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD',
      dateOfInvestigation: [],

      inspectionOptions: [],
      inspectionStatusOptions: [],
      modalTitle: '',
      isView: false,

      riskDetailModalVisible: false,
      checkinModalVisible: false,
      planDisabled: false,
      potentialRiskVisible: false,
      queryParam: {
        name: '',
        endTime: '',
        startTime: '',
        type: undefined,
        status: undefined
      },
      loadData: parameter => {
        let requesturl = riskReportApi.reportList
        let method = 'GET'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize, ...this.queryParam },
          data: {}
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;'
          }
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      dataList: [],

      reportData: {}, // 编辑弹框数据
      reportdetailData: {}, // 查看弹框数据

      userInfo: getStore({ name: 'info' })
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => potentialPlanColumns
  },
  filters: {
    colorFilter: function(value) {
      let key = value
      let color = ''
      switch (key) {
        case 0:
          color = 'orange'
          break
        case 5:
          color = 'green'
          break
        default:
          color = 'green'
          break
      }
      return color
    },
    textFilter: function(value) {
      let key = value
      let desc = ''
      switch (key) {
        case 0:
          desc = '未提交'
          break
        case 5:
          desc = '验收未通过'
          break
        default:
          desc = '已提交'
          break
      }
      return desc
    }
  },
  methods: {
    okRiskDetail() {
      this.riskDetailModalVisible = false
    },
    cancelRiskDetail() {
      this.riskDetailModalVisible = false
    },
    selectOptionsInit() {
      const dictKey = 'PERIL_CHECK_PLAN_TYPE'
      // 排查类型
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.inspectionOptions = data.map(row => {
            return {
              label: row.dictValue,
              value: row.dictKey
            }
          })
        }
      })
      // 状态
      getDict('PERIL_REPORT_STATUS').then(({ data, success }) => {
        if (success) {
          this.inspectionStatusOptions = data.map(row => {
            return {
              label: row.dictValue,
              value: row.dictKey
            }
          })
        }
      })
    },
    dataChange() {
      this.queryParam.startTime = this.dateOfInvestigation[0] + ' 00:00:00' // 计划开始时间
      this.queryParam.endTime = this.dateOfInvestigation[1] + ' 23:59:59' // 计划结束时间
    },
    queryFormData() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    resetQueryForm() {
      this.queryParam = {
        name: '',
        endTime: '',
        startTime: '',
        type: undefined,
        status: undefined
      }
      this.dateOfInvestigation = []
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    openriskDetailModal(record) {
      this.riskDetailModalVisible = true
      this.reportdetailData = {
        process: 1,
        ...record
      }
    },
    openReportModal(record = { id: 0 }, disabled = false) {
      this.modalTitle = record && record.id ? (disabled ? '查看数据' : '编辑数据') : '新增数据'
      this.planDisabled = disabled
      this.checkinModalVisible = true
      this.reportData = record
    },
    closePlanModal() {
      this.planDisabled = false
      this.checkinModalVisible = false
      this.reportData = {}
    },
    addReport() {
      this.isView = false
      this.openReportModal()
    },
    viewReport(record) {
      this.isView = true
      this.getreportEditByid(record, 'viewReport')
    },
    editReport(record) {
      this.isView = false
      this.getreportEditByid(record, 'editReport')
    },
    getreportEditByid(record, key) {
      let requesturl = riskReportApi.reportEditByid
      let method = 'get'
      let requestparams = {
        params: {
          id: record.id
        },
        data: {}
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }

      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        let data = res.data
        if (key == 'viewReport') {
          this.openriskDetailModal(data)
        } else {
          this.openReportModal(data.reportInformationVO)
        }
      })
    },

    savePlan(formData) {
      console.log('==== savePlan', formData)
      if (formData.id) {
        delete formData.status
        this.editPlanRequest(formData)
      } else {
        // 新增排查计划
        this.addPlanRequest(formData)
      }
    },
    // 新建
    addPlanRequest(formData) {
      let requesturl = riskReportApi.reportAdd
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
        _this.closePlanModal()
      })
    },
    cancelPlan() {
      this.closePlanModal()
    },
    // 提交
    reportRisk(formData) {
      let _this = this
      this.$confirm({
        title: '你确定要提交吗？',
        onOk() {
          formData.status = 1
          _this.editPlanRequest(formData)
        },
        onCancel() {}
      })
    },
    // 撤回
    revert(formData) {
      let _this = this
      this.$confirm({
        title: '你确定要撤回吗？',
        onOk() {
          let param = {
            id: formData.id,
            status: 0
          }
          _this.editPlanRequest(param)
        },
        onCancel() {}
      })
    },
    editPlanRequest(formData) {
      let requesturl = riskReportApi.reportEdit
      let method = 'put'
      let requestparams = {
        params: {},
        data: formData
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
        _this.closePlanModal()
      })
    },

    deleteReport(record) {
      let _this = this
      this.$confirm({
        title: '你确定要删除吗？',
        onOk() {
          _this.deletePlanRequest(record)
        },
        onCancel() {}
      })
    },
    // 删除
    deletePlanRequest(record) {
      let requesturl = riskReportApi.reportEelete
      let method = 'delete'
      let requestparams = {
        params: {
          id: record.id
        },
        data: {}
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
        _this.closePlanModal()
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>