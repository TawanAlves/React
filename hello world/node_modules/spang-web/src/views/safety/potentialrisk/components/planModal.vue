<template>
  <div>
    <a-modal
      :visible="visible"
      width="60%"
      :title="modalTitle"
      :confirmLoading="loading"
      ok-text="确定"
      cancel-text="取消"
      @ok="savePlan"
      @cancel="cancelPlan"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="cancelPlan">取消</a-button>
        <a-button type="primary" @click="savePlan" v-if="!disabled">确定</a-button>
      </template>
      <div>
        <a-form :form="form" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }" style="">
          <a-row :gutter="0">
            <a-col :span="12">
              <a-form-item label="计划名称" style="">
                <a-input v-model="model.name" :disabled="disabled"></a-input>
              </a-form-item>

              <a-form-item label="排查日期">
                <a-range-picker v-model="model.period" :valueFormat="dateFormat" style="" :disabled="disabled" />
              </a-form-item>

              <a-form-item label="负责人">
                <a-input v-model="model.name" :disabled="disabled"></a-input>
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="检查类型">
                <a-select v-model="model.organizeUnitId" :disabled="disabled">
                  <a-select-option v-for="s in typeOptions" :key="s.value">
                    {{ s.label }}
                  </a-select-option>
                </a-select>
              </a-form-item>

              <a-form-item label="组织单位">
                <department-select
                  label-name="组织单位"
                  decorator-name="organizeUnitId"
                  required
                  :disabled="disabled"
                />
              </a-form-item>
              <a-form-item label="排查单位">
                <department-select label-name="排查单位" decorator-name="checkUnitId" required :disabled="disabled" />
              </a-form-item>
            </a-col>
          </a-row>
        </a-form>
        <div style="margin-bottom: 25px">
          <a-row>
            <a-col :span="2"><b>风险点</b></a-col>
            <a-col :span="22">
              <a-space v-if="!disabled">
                <a-button type="primary" shape="round" size="small" @click="selectRiskPoint">添加</a-button>
                <a-button type="primary" shape="round" size="small" @click="selectPerson">批量选择联系人</a-button>
              </a-space>
            </a-col>
          </a-row>
        </div>

        <s-table
          ref="reformTable"
          :row-selection="rowSelection"
          :expanded-row-keys.sync="expandedRowKeys"
          :rowKey="(record) => record.id"
          :columns="columnsPotentialFactor"
          :data="loadRiskPointListData"
          :alert="false"
          :showPagination="false"
          style="height: 300px"
        >
          <span slot="checkers" slot-scope="text, record">
            {{ record.checkPlanCheckPersonList ? record.checkPlanCheckPersonList.toString() : '' }}
          </span>
          <!-- <span slot="action" slot-scope="text, record">
            <a-space>
              <a-button type="link" shape="round" size="small" @click="editPlan(record)">选择</a-button>
            </a-space>
          </span> -->
        </s-table>
      </div>
    </a-modal>

    <plan-risK-point-modal
      v-if="visible"
      :visible="potentialRiskVisible"
      title="选择风险点"
      width="80%"
      @ok="reCallSelectRiskPoint"
      @cancel="potentialRiskVisible = false"
    ></plan-risK-point-modal>
  </div>
</template>

<script>
import pick from 'lodash.pick'
import { STable } from '@/components'
import { getRiskPointListData } from '@/api/safety'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PlanRisKPointModal from '@/views/safety/potentialrisk/components/planRiskPointModal'

const columnsPotentialFactor = [
  {
    title: '',
    dataIndex: 'selectColumn',
    width: '65px',
    align: 'center',
    scopedSlots: { customRender: 'selectColumn' },
  },
  {
    title: '风险点',
    dataIndex: 'riskName',
    align: 'left',
  },
  {
    title: '管控层级',
    dataIndex: 'riskLevelName',
    align: 'left',
  },
  {
    title: '位置/区域',
    dataIndex: 'areaLocation',
    align: 'left',
  },
  {
    title: '类型',
    dataIndex: 'riskType',
    align: 'left',
  },
  {
    title: '',
    dataIndex: 'action',
    align: 'left',
    fixed: 'right',
    scopedSlots: { customRender: 'action' },
  },
]

export default {
  name: 'planModal',
  components: {
    DepartmentSelect,
    PlanRisKPointModal,
    STable,
    // PersonSelect,
    // TypeSelect
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {},
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    typeOptions: {
      type: Array,
      default: [],
    },
  },
  computed: {
    columnsPotentialFactor: () => columnsPotentialFactor,
  },
  data() {
    return {
      form: this.$form.createForm(this),
      dateFormat: 'YYYY-MM-DD',
      riskListData: [],
      potentialRiskVisible: false,
      selectedRiskPoint: [],
      rowSelection: {
        onChange: (selectedRowKeys, selectedRows) => {
          console.log(`selectedRowKeys: ${selectedRowKeys}`, 'selectedRows: ', selectedRows)
        },
        onSelect: (record, selected, selectedRows) => {
          console.log(record, selected, selectedRows)
        },
        onSelectAll: (selected, selectedRows, changeRows) => {
          console.log(selected, selectedRows, changeRows)
        },
      },
    }
  },
  created() {
    // this.getRiskPointListData()
    this.potentialRiskVisible = false
    // 防止表单未注册
    // fields.forEach((v) => this.form.getFieldDecorator(v))
    // 当 model 发生改变时，为表单设置值
    this.$watch('model', () => {
      this.potentialRiskVisible = false
      if (!this.model.organizeUnitId && this.typeOptions && this.typeOptions.length > 0) {
        this.model.organizeUnitId = this.typeOptions[0].value
      }
      console.log('监听model')
      if (Object.keys(this.model).length > 0) {
        // this.model.level = typeof this.model.level === 'string' ? this.model.level : this.model.level.toString()
        // this.model.isAdvice = typeof this.model.isAdvice === 'string' ? this.model.isAdvice : this.model.isAdvice.toString()
        // this.model.abarbeitungType = typeof this.model.abarbeitungType === 'string' ? this.model.abarbeitungType : this.model.abarbeitungType.toString()
      }
      // this.model && this.form.setFieldsValue(pick(this.model, fields))
    })
  },
  mounted() {},
  methods: {
    reCallSelectRiskPoint(selectItems) {
      this.selectedRiskPoint = selectItems
      this.potentialRiskVisible = false
      this.$refs.reformTable.refresh(true)
    },
    loadRiskPointListData() {
      return new Promise((reslove, reject) => {
        const data = this.selectedRiskPoint
        const list = {
          // totalCount: data.length,
          // totalPage: data.length,
          // pageNo: 1,
          // pageSize: data.length,
          data: data,
        }
        return reslove(list)
      })
    },
    selectRiskPoint() {
      this.potentialRiskVisible = true
    },
    selectPerson() {
      this.potentialRiskVisible = true
    },
    savePlan() {
      this.potentialRiskVisible = false
      this.$emit('ok')
    },
    cancelPlan() {
      this.potentialRiskVisible = false
      this.$emit('cancel')
    },
  },
}
</script>
