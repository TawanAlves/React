<template>
  <div>
    <!-- 隐患详情 -- 风险评价方法 -->
    <l-s-select-modal :modal-title="lsModalTitle" :mode="lsModalMode" :visible.sync="lsModalVisible" @ok="setLS" />
    <!-- 隐患详情 -->
    <a-modal
      :visible="visible"
      :title="`隐患详情 - ${modalTitle}`"
      :width="900"
      @cancel="okModal"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="cancelModal">取消</a-button>
        <a-button type="primary" @click="okModal" v-if="!disabled">暂存</a-button>
        <a-button type="primary" @click="okModal" v-if="!disabled">提交</a-button>
      </template>
      <!-- 基础信息、评估信息、整改信息、验收信息 -->
      <div class="risk-detail">
        <!-- 头部标识 -->
        <div class="risk-detail-info-name"></div>
        <section class="risk-detial-header">
          <div class="info-block" :class="{ active: model.process == 1 }">
            <div class="info-block-name">上报</div>
            <div class="info-block-person">{{ basicInfomodel.register }}</div>
            <div class="info-block-time">{{ basicInfomodel.registerTime }}</div>
          </div>
          <a-icon class="arrow-right" type="arrow-right" />
          <div class="info-block" :class="{ active: model.process == 2 }">
            <div class="info-block-name">评估</div>
            <div class="info-block-person">【韩君】</div>
            <div class="info-block-time">2021-07-13 13:12</div>
          </div>
          <a-icon class="arrow-right" type="arrow-right" />
          <div class="info-block" :class="{ active: model.process > 3 }">
            <div class="info-block-name">整改</div>
            <div class="info-block-person">【韩君】</div>
            <div class="info-block-time">2021-07-13 13:12</div>
          </div>
          <a-icon class="arrow-right" type="arrow-right" />
          <div class="info-block" :class="{ active: model.process > 4 }">
            <div class="info-block-name">验收</div>
            <div class="info-block-person">【韩君】</div>
            <div class="info-block-time">2021-07-13 13:12</div>
          </div>
        </section>
        <!-- / 头部标识 -->

        <!-- 基础信息 Basic information-->
        <section class="risk-detail-info report-base">
          <div class="risk-detail-info-name">1. 基础信息</div>
          <a-form :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
            <a-form-item label="隐患名称" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }">
              <a-input v-model="basicInfomodel.name" :disabled="basicInfomodelDisable"></a-input>
            </a-form-item>
            <a-row>
              <a-col :span="12">
                <a-form-item label="风险点">
                  <a-input v-model="basicInfomodel.pointName" :disabled="basicInfomodelDisable"></a-input>
                </a-form-item>
                <a-form-item label="隐患级别">
                  <a-select v-model="basicInfomodel.levelName" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item label="隐患地点">
                  <a-input v-model="basicInfomodel.address" :disabled="basicInfomodelDisable"></a-input>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="风险类型">
                  <a-select v-model="basicInfomodel.pointType" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item label="隐患类别">
                  <a-select v-model="basicInfomodel.typeName" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
                <a-form-item label="责任部门">
                  <a-select v-model="basicInfomodel.dutyDeptName" :disabled="basicInfomodelDisable">
                    <a-select-option value="1">1</a-select-option>
                  </a-select>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="24">
                <a-form-item :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" label="隐患描述">
                  <a-textarea v-model="basicInfomodel.description" :disabled="basicInfomodelDisable"></a-textarea>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row gutter="24">
              <a-col :span="10"> 登记时间: {{ basicInfomodel.registerTime }} </a-col>
              <a-col :span="6"> 提报人: {{ basicInfomodel.registrantDept }} </a-col>
              <a-col :span="6"> 部门: {{ basicInfomodel.registrantDept }} </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="24" class="img">
                <a-form-item label="整改前照片" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }">
                  <div class="img-box" v-for="(item, index) in basicInfoImgList" :key="'basicInfoImgList' + index">
                    <img style="" :src="item.url" alt="隐患整改前照片" />
                  </div>
                </a-form-item>
              </a-col>
            </a-row>
          </a-form>
        </section>
        <!-- / 基础信息 -->

        <!-- 评估信息 -->
        <section class="risk-detail-info report-assess" v-if="model.process >= 2">
          <div class="risk-detail-info-name">2. 评估信息</div>
          <div>
            <fieldset>
              <legend>事故发生的可能性（L）判定准则</legend>

              <a-table size="default" :data-source="LJudge" :pagination="false" :rowKey="(record) => record.id">
                <a-table-column key="happenScores" data-index="happenScores" title="等级" align="center">
                </a-table-column>
                <a-table-column key="happenDetails" data-index="happenDetails" title="描述" align="center">
                </a-table-column>
                <a-table-column key="action" data-index="action" title="" align="center">
                  <template slot-scope="text, record">
                    <a-button type="primary" @click="selectLS('L')"> 选择</a-button>
                  </template>
                </a-table-column>
              </a-table>
            </fieldset>
            <fieldset>
              <legend>事故发生后果严重性（S）判定准则</legend>

              <a-table size="default" :data-source="SJudge" :pagination="false" :rowKey="(record) => record.id">
                <a-table-column key="seriousScores" data-index="seriousScores" title="等级" align="center">
                </a-table-column>
                <a-table-column key="seriousDetails" data-index="seriousDetails" title="描述" align="center">
                </a-table-column>
                <a-table-column key="action" data-index="action" title="" align="center">
                  <template slot-scope="text, record">
                    <a-button type="primary" @click="selectLS('S')"> 选择</a-button>
                  </template>
                </a-table-column>
              </a-table>
            </fieldset>

            <fieldset>
              <legend>安全风险等级判定准则及控制措施R</legend>
              <a-table
                size="default"
                :data-source="[accidentJudge]"
                :pagination="false"
                :columns="rCoumns"
                :rowKey="(index) => index"
              >
              </a-table>
            </fieldset>

            <div class="risk-score">
              <a-row type="flex" justify="center" style="margin-top: 10px">
                <a-col :span="4">
                  <div class="risk-label">风险值:</div>
                  <a-tag class="risk-tag">{{ controlLevel.resultScore == -1 ? '' : controlLevel.resultScore }}</a-tag>
                </a-col>
                <a-col :span="4">
                  <div class="risk-label">评价级别:</div>
                  <a-tag class="risk-tag">{{ accidentJudge.judgeLevelName }}</a-tag>
                </a-col>
                <a-col :span="4">
                  <div class="risk-label">风险级别:</div>
                  <a-tag class="risk-tag">{{ controlLevel.riskLevelName }}</a-tag>
                </a-col>
                <a-col :span="4">
                  <div class="risk-label">风险色:</div>
                  <a-tag class="risk-tag">{{ controlLevel.riskColourName }}</a-tag>
                </a-col>
                <a-col :span="4">
                  <div class="risk-label">管控层级:</div>
                  <a-tag class="risk-tag">{{ controlLevel.riskControlName }}</a-tag>
                </a-col>
              </a-row>
            </div>
            <div>
              <a-form :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                <a-row gutter="20">
                  <a-col :span="24">
                    <a-form-item label="评估意见" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }">
                      <a-input v-model="model.assess" :disabled="evaluationInfomodelDisable"></a-input>
                    </a-form-item>
                    <a-form-item label="评估结果" :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }">
                      <a-input v-model="model.assess" :disabled="evaluationInfomodelDisable"></a-input> </a-form-item
                  ></a-col>
                </a-row>

                <a-row gutter="20">
                  <a-col :span="12">
                    <a-form-item label="整改责任单位">
                      <a-select v-model="model.level" :disabled="evaluationInfomodelDisable">
                        <a-select-option value="1">1</a-select-option>
                      </a-select>
                    </a-form-item>
                    <a-form-item label="整改类型">
                      <a-select v-model="model.level" :disabled="evaluationInfomodelDisable">
                        <a-select-option value="1">1</a-select-option>
                      </a-select>
                    </a-form-item>
                    <a-form-item label="评估时间">
                      <a-input v-model="model.address" :disabled="evaluationInfomodelDisable"></a-input>
                    </a-form-item>
                  </a-col>
                  <a-col :span="12">
                    <a-form-item label="整改负责人">
                      <a-input v-model="model.assess" :disabled="evaluationInfomodelDisable"></a-input>
                    </a-form-item>
                    <a-form-item label="整改完成日期">
                      <a-date-picker
                        v-model="model.completeDate"
                        style="width: 100%"
                        :disabled="evaluationInfomodelDisable"
                      ></a-date-picker>
                    </a-form-item>
                    <a-form-item label="评估人">
                      <a-input v-model="model.address" :disabled="evaluationInfomodelDisable"></a-input>
                    </a-form-item>
                  </a-col>
                </a-row>
              </a-form>
            </div>
          </div>
        </section>
        <!-- / 评估信息 -->

        <!-- 整改信息 -->
        <section class="risk-detail-info report-reform" v-if="model.process >= 3">
          <div class="risk-detail-info-name">3. 整改信息</div>
          <a-form :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
            <a-row gutter="0">
              <a-col :span="24">
                <a-form-item :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" label="整改意见">
                  <a-input v-model="model.name" :disabled="disabled || model.process > 3"></a-input> </a-form-item
              ></a-col>
            </a-row>

            <a-row gutter="20">
              <a-col :span="12">
                <a-form-item label="整改作业人">
                  <a-input v-model="model.pointName" :disabled="disabled || model.process > 3"></a-input>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="整改部门">
                  <a-input v-model="model.pointName" :disabled="disabled || model.process > 3"></a-input>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="12">
                <a-form-item label="整改结果">
                  <a-input v-model="model.pointName" :disabled="disabled || model.process > 3"></a-input>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="验收人">
                  <a-input v-model="model.pointName" :disabled="disabled || model.process > 3"></a-input>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="24">
                <a-form-item
                  :label-col="{ span: 3 }"
                  :wrapper-col="{ span: 21 }"
                  :disabled="disabled || model.process > 3"
                  label="整改措施"
                >
                  <a-textarea
                    v-model="model.description"
                    :disabled="disabled || model.process > 3"
                  ></a-textarea> </a-form-item
              ></a-col>
            </a-row>

            <a-row gutter="20">
              <a-col :span="24" class="img">
                <a-form-item :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" label="相关附件">
                  <img
                    style=""
                    src="https://d1icd6shlvmxi6.cloudfront.net/gsc/9LMQJE/2b/eb/c9/2bebc940d5004a82aa51a07f5eb4895c/images/详情ok/u3890.png?token=1495ef39f91a7c4f7218ff93fc741f3d63711fbc1f51792f45dc173b63d1291a"
                    alt="相关附件1"
                  />
                </a-form-item>
              </a-col>
            </a-row>
          </a-form>
        </section>
        <!-- / 整改信息 -->

        <!-- 验收信息 -->
        <section class="risk-detail-info report-acceptance" v-if="model.process >= 4">
          <div class="risk-detail-info-name">4. 验收信息</div>
          <a-form :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
            <a-row gutter="0">
              <a-col :span="12">
                <a-form-item label="验收结果">
                  <a-input v-model="model.name" :disabled="disabled"></a-input> </a-form-item
              ></a-col>
            </a-row>

            <a-row gutter="20">
              <a-col :span="24">
                <a-form-item :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" label="验收说明">
                  <a-input v-model="model.pointName" :disabled="disabled"></a-input>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row gutter="20">
              <a-col :span="24" class="img">
                <a-form-item :label-col="{ span: 3 }" :wrapper-col="{ span: 21 }" label="相关附件">
                  <img
                    style=""
                    src="https://d1icd6shlvmxi6.cloudfront.net/gsc/9LMQJE/2b/eb/c9/2bebc940d5004a82aa51a07f5eb4895c/images/详情ok/u3890.png?token=1495ef39f91a7c4f7218ff93fc741f3d63711fbc1f51792f45dc173b63d1291a"
                    alt="相关附件1"
                  />
                </a-form-item>
              </a-col>
            </a-row>
          </a-form>
        </section>
        <!-- / 验收信息 -->
      </div>
    </a-modal>
  </div>
</template>

<script>
import LSSelectModal from './LSSelectModal'
import SafetyURLs from '@/api/urls'
import { RColumns } from './table'
export default {
  // name: 'SpangWebRiskdetail',

  components: { LSSelectModal },

  // directives: { DirectiveName },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    isNewReport: {
      type: Boolean,
      default: () => false,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {
        return {}
      },
    },
    modalTitle: {
      type: String,
      default: '',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    typeOptions: {
      type: Array,
      default: [],
    },
  },
  data() {
    return {
      assessModalVisibile: false,
      model: {},
      basicInfomodel: {}, // 基础信息
      basicInfoImgList: [],
      basicInfomodelDisable: false,

      evaluationInfomodel: {
        abarbeitungUnitId: '', //	整改责任单位id	integer(int64)
        abarbeitungUnitName: '', //		整改责任单位名称	string
        accomplishTime: '', //		整改完成日期	string(date-time)
        assessTime: '', //		评估时间	string(date-time)
        assessment: '', //		评估意见	string
        assessorName: '', //		评估人姓名	string
        id: '', //		id	integer(int64)
        ponderanceScore: '', //		严重性判定准则分数	integer(int32)
        possibilityScore: '', //		可能性判定准则分数	integer(int32)
        principalId: '', //		整改负责人id	integer(int64)
        principalName: '', //		整改负责人名称	string
        reportInformationId: '', //		隐患上报表id	integer(int64)
        result: '', //		隐患评估结果	integer(int32)
        status: '', //		状态(0暂存 1提交)	integer(int32)
        type: '', //		整改类型	integer(int32)
        typeName: '', //		整改类型名称
      }, // 评估信息
      evaluationInfomodelDisable: false,

      lsModalTitle: '',
      lsModalMode: '',
      lsModalVisible: false,
      LJudge: [{ happenScores: '', happenDetails: '' }],
      SJudge: [{ seriousScores: '', seriousDetails: '' }],
      controlLevel: {},
      accidentJudge: {
        gmtCreate: '',
        gmtModified: '',
        gmtCreateId: '',
        gmtCreateName: '',
        gmtCreateDeptId: '',
        gmtModifiedId: '',
        gmtModifiedName: '',
        isDeleted: '',
        judgeMin: '',
        judgeMax: '',
        riskLevelId: '',
        riskLevelName: '',
        controlMeasures: '',
        timeLimit: '',
        judgeLevelName: '',
        judgeLevelId: '',
      },
    }
  },

  computed: {
    rCoumns: () => RColumns,
  },
  mounted() {},
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },

  methods: {
    setFormData(model) {
      console.log('reportInformationVO', model)
      let data = JSON.parse(JSON.stringify(model))
      let { process, reportInformationVO, assessInformationVO } = data
      if (process <= 2) {
        this.basicInfomodelDisable = true
      }
      this.basicInfoImgList = this.getImgUrlList(reportInformationVO.files)
      this.basicInfomodel = reportInformationVO

      this.evaluationInfomodel = assessInformationVO
    },
    getImgUrlList(fileList) {
      let photoList = []
      fileList.forEach((element) => {
        let { id, fileName, filePath } = element
        if (id) {
          photoList.push({
            uid: id,
            name: fileName,
            status: 'done',
            id: id,
            url: this.BASE_URL + '/spang-safety/file' + filePath,
          })
        }
      })
      return photoList
    },
    selectLS(type) {
      if (type === 'L') {
        this.lsModalTitle = '事故发生的可能性（L）判定准则'
      } else {
        this.lsModalTitle = '事件后果严重性（S）'
      }
      this.lsModalMode = type
      this.lsModalVisible = true
    },
    setLS(data) {
      if (this.lsModalMode === 'L') {
        const details = [
          data.happenFrequency,
          data.securityCheck,
          data.workRule,
          data.employeeCompetency,
          data.controlMeasures,
        ]
          .filter((item) => this.isNotNullOrUndefined(item))
          .join(';')
        this.LJudge = [{ happenId: data.id, happenScores: data.scores, happenDetails: details }]
      } else {
        const details = [data.casualties, data.downtime, data.reputationImpact]
          .filter((item) => this.isNotNullOrUndefined(item))
          .join(';')

        this.SJudge = [{ seriousId: data.id, seriousScores: data.scores, seriousDetails: details }]
      }

      if (this.LJudge[0].happenId && this.SJudge[0].seriousId) {
        const params = {
          lScores: this.LJudge[0].happenScores,
          sScores: this.SJudge[0].seriousScores,
        }
        this.getList(SafetyURLs.getRiskLevelByScore, params).then(({ success, data }) => {
          if (success) {
            delete data.controlLevel.id
            delete data.accidentJudge.id
            this.controlLevel = { ...data.controlLevel, resultScore: data.resultScore }
            this.accidentJudge = {
              ...data.accidentJudge,
              judgeLevelName: data.accidentJudge.riskLevelName,
              judgeLevelId: data.accidentJudge.riskLevelId,
            }
          }
        })
      }
    },
    okModal() {
      this.visible = false
      this.assessModalVisibile = false
      this.$emit('ok', this.model)
    },
    cancelModal() {
      this.visible = false
      this.assessModalVisibile = false
      this.$emit('cancel', this.model)
    },
    selectTab() {
      this.assessModalVisibile = true
    },
    hideAssessModal() {
      this.assessModalVisibile = false
    },
  },
}
</script>

<style lang="less" scoped>
.risk-detail {
  .img-box {
    width: 120px;
    height: 90px;
    overflow: hidden;
    margin: 5px;
    display: inline-flex;
  }
  img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  height: calc(100vh - 350px) !important;
  overflow: auto;
  .ant-form-item {
    margin-bottom: 0;
  }
  & > .risk-detial-header {
    display: flex;
    justify-content: space-around;
    text-align: center;
    .arrow-right {
      height: 100px;
      line-height: 50px;
      font-size: 24px;
      color: #797979;
    }
    & > .info-block {
      .info-block-name {
        background: #008080;
        width: 50px;
        height: 50px;
        margin: 0 auto;
        line-height: 50px;
        border-radius: 50%;
        color: #fff;
      }
      .info-block-person {
        margin-top: 5px;
      }
      &.active > .info-block-name {
        background: #70b603;
      }
    }
  }
  & > .risk-detail-info {
    padding: 0 25px;
    .risk-detail-info-name {
      color: #0000ff;
      margin: 15px -15px 10px;
      border-bottom: 1px solid #333;
    }
  }
}
/deep/ .ant-table {
  height: auto !important;
}
fieldset {
  border: 1px solid #ccc;
  padding: 10px;
  legend {
    width: auto;
    font-size: 14px;
  }
}
.risk-label {
  font-weight: 600;
}
.risk-tag {
  min-height: 20px;
  min-width: 50px;
  margin-top: 4px;
}
</style>