<template>
  <a-modal
    :title="modalTitle"
    :width="1000"
    :visible="visible"
    :confirmLoading="loading"
    @ok="() => { $emit('ok') }"
    @cancel="() => { $emit('cancel') }"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form :form="form" :label-col="{ span: 6 }" :wrapper-col="{ span: 14 }" style="margin-top: 40px;width: 100%">
        <a-row :gutter="24">
          <a-col :span="12">
            <!-- <a-form-item label="填报单位">
              <a-select v-decorator="['importUnitId', { rules: [{ required: true, message: '请选择填报单位' }] }]">
                <a-select-option v-for="d in importUnitOptions" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item> -->
            <department-select decorator-name="importUnitId" labelName="填报单位" :disabled="disabled"/>
            <a-form-item label="隐患描述">
              <a-textarea :rows="4" v-decorator="['perilDescription', { rules: [{ required: true, message: '请填写隐患描述' }] }]" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="隐患地点">
              <a-input v-decorator="['perilAddress', { rules: [{ required: true, message: '请填写隐患描述' }] }]" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="级别">
              <a-select v-decorator="['level', { rules: [{ required: true, message: '请选择隐患级别' }] }]" :disabled="disabled">
                <a-select-option v-for="d in level" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <!-- <a-form-item label="类别">
              <a-tree-select
                v-decorator="['type',{ rules:[{ required: true, message: '请输入类别' }]}]"
                :disabled="disabled"
                style="width: 100%"
                :tree-data="riskType"
                :load-data="onLoadData"
                placeholder="请选择类别"
                :replaceFields="{children:'children', title:'dictValue', key:'dictKey', value: 'dictKey' }"
              />
            </a-form-item> -->
            <type-select decorator-name="type" labelName="类别" :disabled="disabled"/>
            <a-form-item label="检查时间">
              <a-date-picker v-decorator="['checkTime', { rules: [{ required: true, message: '请选择检查时间' }] }]" style="width: 60%" valueFormat="YYYY-MM-DD HH:mm:ss" :disabled="disabled"/>
            </a-form-item>
            <!-- <a-form-item label="填报人">
              <a-input v-decorator="['informantId', { rules: [{ required: true, message: '请填写填报人' }] }]"/>
            </a-form-item> -->
            <person-select decorator-name="informantId" labelName="填报人" :disabled="disabled" :initial-model="model?{id:model.informantId,name:model.informantName}:null"/>
          </a-col>
          <a-col :span="12">
            <!-- <a-form-item label="责任单位">
              <a-select v-decorator="['importUnitId', { rules: [{ required: true, message: '请填写责任单位' }] }]">
                <a-select-option v-for="d in importUnitOptions" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item> -->
            <department-select decorator-name="dutyUnitId" labelName="责任单位" :disabled="disabled"/>
            <a-form-item label="整改类型">
              <a-select v-decorator="['abarbeitungType', { rules: [{ required: true, message: '请选择整改类型' }] }]" :disabled="disabled">
                <a-select-option v-for="d in reformType" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <!-- <a-form-item label="整改责任人">
              <a-input v-decorator="['dutyPersonId', { rules: [{ required: false, message: '请填写整改责任人' }] }]"/>
            </a-form-item> -->
            <person-select decorator-name="dutyPersonId" labelName="整改责任人" :disabled="disabled" :initial-model="model?{id:model.dutyPersonId,name:model.dutyPersonName}:null"/>
            <a-form-item label="整改期限">
              <a-date-picker v-decorator="['abarbeitungDeadline', { rules: [{ required: true, message: '请选择整改期限' }] }]" style="width: 60%" valueFormat="YYYY-MM-DD HH:mm:ss" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="整改要求">
              <a-textarea :rows="4" v-decorator="['abarbeitungDemand', { rules: [{ required: true, message: '请填写整改要求' }] }]" :disabled="disabled"/>
            </a-form-item>
            <!-- <a-form-item label="复查人">
              <a-input v-decorator="['reviewPersonId', { rules: [{ required: false, message: '请填写复查人'}]}]"/>
            </a-form-item> -->
            <person-select decorator-name="reviewPersonId" labelName="复查人" :disabled="disabled" :initial-model="model?{id:model.reviewPersonId,name:model.reviewPersonName}:null"/>
            <a-form-item label="是否通知">
              <a-radio-group v-decorator="['isAdvice', { rules: [{ required: false}]}]" :disabled="disabled">
                <a-radio-button value="0">
                  是
                </a-radio-button>
                <a-radio-button value="1">
                  否
                </a-radio-button>
              </a-radio-group>
            </a-form-item>
          </a-col>
        </a-row>
      </a-form>
    </a-spin>
  </a-modal>
</template>

<script>
import pick from 'lodash.pick'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelect from '@/views/safety/components/PersonSelect'
import TypeSelect from '@/views/safety/potentialrisk/TypeSelect'

const fields = ['importUnitId', 'perilDescription', 'perilAddress', 'level', 'type', 'createTime', 'informantId', 'dutyUnitId',
  'abarbeitungType', 'dutyPersonId', 'checkTime', 'abarbeitungDemand', 'reviewPersonId', 'isAdvice', 'abarbeitungDeadline' ]

export default {
  name: 'ReformModal',
  components: {
    DepartmentSelect,
    PersonSelect,
    TypeSelect
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    level: {
      type: Object,
      default: () => null
    },
    riskType: {
      type: Object,
      default: () => null
    },
    reformType: {
      type: Object,
      default: () => null
    },
    model: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      form: this.$form.createForm(this)
    }
  },
  created () {
    // 防止表单未注册
    fields.forEach(v => this.form.getFieldDecorator(v))
    // 当 model 发生改变时，为表单设置值
    this.$watch('model', () => {
      console.log('监听model')
      if (Object.keys(this.model).length > 0) {
        this.model.level = typeof this.model.level === 'string' ? this.model.level : this.model.level.toString()
        this.model.isAdvice = typeof this.model.isAdvice === 'string' ? this.model.isAdvice : this.model.isAdvice.toString()
        this.model.abarbeitungType = typeof this.model.abarbeitungType === 'string' ? this.model.abarbeitungType : this.model.abarbeitungType.toString()
      }
      this.model && this.form.setFieldsValue(pick(this.model, fields))
    })
  }
}
</script>
