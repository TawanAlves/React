<template>
  <div>
    <a-modal
      :visible="visible"
      :width="900"
      :title="modalTitle"
      @cancel="cancelModal"
      :keyboard="false"
      :maskClosable="false"
    >
      <template slot="footer">
        <a-button @click="cancelModal">取消</a-button>
        <a-button type="primary" @click="okModal">确定</a-button>
      </template>
      <div>
        <a-form-model
          ref="ruleForm"
          class="tiny-form"
          :model="form"
          :rules="rules"
          :label-col="labelCol"
          :wrapper-col="wrapperCol"
        >
          <a-form-model-item v-if="isNewReport" label="风险点">
            <a-row :gutter="24">
              <a-col :span="20"> <a-input disabled="true" v-model="form.pointName"></a-input></a-col>
              <a-col :span="2">
                <a-button type="primary" size="small" shape="round" @click="selectRiskPoint"> 选择 </a-button>
              </a-col>
            </a-row>
          </a-form-model-item>
          <a-form-model-item label="风险类型">
            <a-input disabled="true" v-model="form.pointType"></a-input>
          </a-form-model-item>
          <a-form-model-item label="隐患名称" prop="name">
            <a-input v-model="form.name"></a-input>
          </a-form-model-item>

          <a-form-model-item label="隐患表述">
            <a-textarea v-model="form.description"></a-textarea>
          </a-form-model-item>

          <a-form-model-item label="风险级别" prop="level">
            <a-select v-model="form.level" @change="levelChange">
              <a-select-option v-for="d in riskLevelOptions" :key="d.value">
                {{ d.label }}
              </a-select-option>
            </a-select>
          </a-form-model-item>

          <a-form-model-item label="隐患类别" prop="type">
            <a-select v-model="form.type" @change="typeChange">
              <a-select-option v-for="d in riskTypeOptions" :key="d.value">
                {{ d.label }}
              </a-select-option>
            </a-select>
          </a-form-model-item>

          <a-form-model-item label="隐患地点" prop="address">
            <a-input v-model="form.address"></a-input>
          </a-form-model-item>
          <a-form-model-item label="隐患责任部门" prop="dutyDeptId">
            <department-select :value="form.dutyDeptId" @change="dutyDeptChange" />
          </a-form-model-item>
          <a-form-model-item label="登记时间" v-if="disabled">
            <a-date-picker style="width: 100%" v-model="form.registerTime" disabled="true"></a-date-picker>
          </a-form-model-item>
          <a-form-model-item label="隐患整改前照片">
            <upload-file
              accept=".jpg, .jpeg, .png"
              :fileList="localePhotos"
              :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'files')"
              :removePro="(file) => removeFile(file, 'files')"
              listType="picture-card"
              :previewEnabled="true"
              preview-mode="fullscreen"
            />
          </a-form-model-item>
          <a-form-model-item label="评估人" prop="evaluatorName">
            <a-row :gutter="24">
              <a-col :span="20"> <a-input disabled="true" v-model="form.evaluatorName"></a-input></a-col>
              <a-col :span="2">
                <a-button type="primary" size="small" shape="round" @click="selectPerson"> 选择 </a-button>
              </a-col>
            </a-row>
          </a-form-model-item>
        </a-form-model>
        <a-row style="margin-top: 10px">
          <a-col :span="6" offset="6">登记人: {{ form.registrantName }}</a-col>
          <a-col :span="6">部门: {{ form.registrantDept }}</a-col>
        </a-row>
      </div>
    </a-modal>
    <person-select-modal
      :visible.sync="personSelectModalVisible"
      :loading="confirmLoading"
      @ok="changeOtherPerson"
      title="评估人"
      :multiple="multiple"
    />
    <!-- 选择风险点 -->
    <plan-risK-point-modal
      :visible="potentialRiskVisible"
      title="选择风险点2222"
      width="80%"
      rowSelectMode="radio"
      :pointSelectedList="pointSelectedList"
      @ok="changeRiskPoint"
      @cancel="potentialRiskVisible = false"
    ></plan-risK-point-modal>
  </div>
</template>

<script>
import moment from 'moment'
import { getDict } from '@/api/system'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
import PlanRisKPointModal from '../planManageMgr/planRiskPointModal.vue'
import { mapGetters } from 'vuex'
export default {
  components: { DepartmentSelect, PersonSelectModal, PlanRisKPointModal },

  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    isNewReport: {
      type: Boolean,
      default: () => false,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {
        return { createTime: moment(), id: 0 }
      },
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    typeOptions: {
      type: Array,
      default: [],
    },
    multiple: {
      type: Boolean,
      required: true,
    },
  },
  data() {
    return {
      previewVisible: false,
      potentialRiskVisible: false,
      previewImage: '',
      personSelectModalVisible: false,
      localePhotos: [],
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      dateFormat: 'YYYY-MM-DD HH:mm:ss',

      form: {
        planPonitId: '', //检查计划关联风险点表
        pointName: '', //风险点名称
        pointType: '', //风险类型

        name: '', // 隐患名称
        description: '', //描述
        level: '', // 隐患级别
        levelName: '', // 	隐患级别名称

        type: '', // 隐患类别
        typeName: '', // 隐患类别名称

        address: '', // 隐患地点

        dutyDeptId: '', //	隐患责任部门id
        dutyDeptName: '', //隐患责任部门名称
        files: [],
        evaluatorId: '', // 评估人id
        evaluatorName: '', // 评估人名称

        registerTime: '', // 登记时间
        registrantDept: '',
        registrantName: '',
      },
      rules: {
        name: [{ required: true, message: '请输入隐患名称', trigger: 'blur' }],
        level: [{ required: true, message: '请选择隐患级别', trigger: 'blur' }],
        type: [{ required: true, message: '请选择隐患类别', trigger: 'blur' }],
        address: [{ required: true, message: '请输入隐患地点', trigger: 'blur' }],
        dutyDeptId: [{ required: true, message: '请选择隐患责任部门', trigger: 'blur' }],
        principalId: [{ required: true, message: '请选择负责人', trigger: 'blur' }],

        organizeUnitId: [{ required: true, message: '请选择组织单位', trigger: 'blur' }],
        checkUnitId: [{ required: true, message: '请选择排查单位', trigger: 'blur' }],
        evaluatorName: [{ required: true, message: '请选择评估人', trigger: 'blur' }],
      },

      pointSelectedList: [],
      disabled: false,
    }
  },
  created() {
    this.selectOptionsInit()
  },
  mounted() {},
  computed: {
    ...mapGetters(['permission', 'userInfo']),
  },
  watch: {
    model: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  methods: {
    setFormData(model) {
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
      if (model && model.id) {
        this.form = JSON.parse(JSON.stringify(model))
        this.form.level = this.form.level.toString()
        this.form.type = this.form.type.toString()
        this.form.pointType = this.form.pointType.toString()
        let fileList = this.form.files
        let photoList = []
        fileList.forEach((element) => {
          let { id, fileName, filePath } = element
          if (id) {
            photoList.push({
              uid: id,
              name: fileName,
              status: 'done',
              id: id,
              url: this.BASE_URL + '/spang-safety/file' + filePath,
            })
          }
        })
        this.localePhotos = photoList

        this.pointSelectedList = [
          {
            perilPointId: this.form.planPonitId,
            perilPointName: this.form.pointName,
            address: '',
            controlLevel: '',
            type: this.form.pointType,
          },
        ]
        this.disabled = true
      } else {
        this.form = {
          planPonitId: '', //检查计划关联风险点表
          pointName: '', //风险点名称
          pointType: '', //风险类型

          name: '', // 隐患名称
          description: '', //描述
          level: '', // 隐患级别
          levelName: '', // 	隐患级别名称

          type: '', // 隐患类别
          typeName: '', // 隐患类别名称

          address: '', // 隐患地点

          dutyDeptId: '', //	隐患责任部门id
          dutyDeptName: '', //隐患责任部门名称
          files: [],
          evaluatorId: '', // 评估人id
          evaluatorName: '', // 评估人名称

          registerTime: null, // 登记时间
          registrantDept: this.userInfo.deptName,
          registrantName: this.userInfo.name,
        }
        this.localePhotos = []
        this.pointSelectedList = []
        this.disabled = false
      }
    },
    handleUpload(fileJson, resp, field) {
      if (fileJson.status === 'done' && resp.success) {
        this.form[field].push({
          originalFileName: resp.data.originalFileName,
          fileUrlPath: resp.data.urlPath,
          id: resp.data.id,
        })
      }
    },
    removeFile(file, field) {
      const index = this.form[field].findIndex((item) => item.id === file.id)
      if (index > -1) {
        this.form[field].splice(index, 1)
      }
      const fileIndex = this.localePhotos.findIndex((item) => item.uid === file.uid)
      if (fileIndex > -1) {
        this.localePhotos.splice(fileIndex, 1)
      }
    },
    levelChange(key) {
      this.form.level = key
      this.form.levelName = this.getkeyDesc(key, this.riskLevelOptions)
    },
    typeChange(key) {
      this.form.type = key
      this.form.typeName = this.getkeyDesc(key, this.riskTypeOptions)
    },
    dutyDeptChange(val) {
      this.form.dutyDeptId = val.id
      this.form.dutyDeptName = val.label
    },
    getkeyDesc(key, keyOptions) {
      let array = keyOptions
      let desc = ''
      for (let index = 0; index < array.length; index++) {
        const element = array[index]
        if (key.toString() == element.value) {
          desc = element.label
        }
      }
      return desc
    },
    okModal() {
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          this.$emit('ok', this.form)
          this.potentialRiskVisible = false
        } else {
          return false
        }
      })
    },
    cancelModal() {
      this.$refs.ruleForm.resetFields()
      this.potentialRiskVisible = false
      this.$emit('cancel')
    },
    selectRiskPoint() {
      this.potentialRiskVisible = true
    },
    changeRiskPoint(risk) {
      let riskobj = risk[0]
      this.form.planPonitId = riskobj.id //检查计划关联风险点表
      this.form.pointName = riskobj.riskName //风险点名称
      this.form.pointType = riskobj.riskType //风险类型
      this.pointSelectedList = [
        {
          perilPointId: riskobj.id,
          perilPointName: riskobj.riskName,
          address: '',
          controlLevel: '',
          type: riskobj.riskType,
        },
      ]

      this.potentialRiskVisible = false
    },
    selectPerson() {
      this.personSelectModalVisible = true
    },
    changeOtherPerson(users) {
      if (users && users.length > 0) {
        const p = users[0]
        this.form.evaluatorId = p.userId
        this.form.evaluatorName = p.userName
      }

      this.personSelectModalVisible = false
    },
    selectOptionsInit() {
      const dictKey = 'RISK_LEVEL'
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.riskLevelOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })

      getDict('PERIL_TYPE').then(({ data, success }) => {
        if (success) {
          this.riskTypeOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
        }
      })
    },
  },
}
</script>

<style lang="less" scoped>
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
}
</style>