<template>
  <div>
    <a-modal
      :visible="visible"
      title="选择风险点"
      width="80%"
      @ok="doneRiskPoint"
      @cancel="cancelRiskPoint"
      :keyboard="false"
      :maskClosable="false"
    >
      <div>
        <a-row style="min-height: 300px">
          <a-col :span="5">
            <a-tree
              class="left-tree"
              :tree-data="treeData"
              :expanded-keys="expandedKeys"
              :auto-expand-parent="autoExpandParent"
              @expand="onExpand"
              @select="onSelectBranch"
              :replaceFields="replaceFields"
              :default-selected-keys="['0-0-0']"
            >
              <a-icon slot="switcherIcon" type="down" />
              <a-icon slot="smile" type="smile-o" />
              <a-icon slot="meh" type="smile-o" />
              <template slot="custom" slot-scope="{ selected }">
                <a-icon :type="selected ? 'frown' : 'frown-o'" />
              </template>
            </a-tree>
          </a-col>
          <a-col :span="14" :gutter="20">
            <a-form layout="inline">
              <a-row>
                <a-col :span="9">
                  <a-form-item label="风险类型">
                    <a-select v-model="queryParam.riskTypeId" size="small" style="width: 100px">
                      <a-select-option v-for="d in riskTypeOptions" :key="d.value">
                        {{ d.label }}
                      </a-select-option>
                    </a-select>
                  </a-form-item>
                </a-col>
                <a-col :span="9">
                  <a-form-item label="风险级别ccc">
                    <a-select v-model="queryParam.riskLevelId" size="small" style="width: 100px">
                      <a-select-option v-for="d in riskLevelOptions" :key="d.value">
                        {{ d.label }}
                      </a-select-option>
                    </a-select>
                  </a-form-item>
                </a-col>
                <a-col :span="6">
                  <a-form-item>
                    <a-space align="end">
                      <a-button type="primary" size="small" @click="searchData()">查询</a-button>
                      <a-button type="normal" size="small" @click="searchData(true)">重置</a-button>
                    </a-space></a-form-item
                  ></a-col
                >
              </a-row>

              <div style="height: 240px; overflow: auto">
                <s-table
                  ref="formTable"
                  size="small"
                  :row-selection="rowSelection"
                  :expanded-row-keys.sync="expandedRowKeys"
                  :rowKey="(record) => record.id"
                  :columns="columnsPotentialFactor"
                  :data="loadData"
                  :alert="false"
                  :showPagination="true"
                  style="height: 150px"
                >
                  <span slot="selectColumn" slot-scope="text, record">
                    <a-checkbox v-model="record.selected" @click="selectPoint(record)"></a-checkbox>
                  </span>
                  <!-- <span slot="action" slot-scope="text, record">
                    <a-space>
                      <a-button type="link" shape="round" size="small" @click="selectPoint(record)">选择</a-button>
                    </a-space>
                  </span> -->
                </s-table>
              </div>
            </a-form>
          </a-col>
          <a-col :span="5">
            <div style="margin-top: 5px">
              <h3>已选择</h3>
              <div v-for="(item, index) in selectRiskPoint" :key="item.id">
                <div @click="unSelectPoint(index, item)" style="margin: 0 0 10px 15px; cursor: pointer">
                  <a-checkbox checked=""> </a-checkbox> <span>{{ item.riskName }}</span>
                </div>
              </div>
            </div>
          </a-col>
        </a-row>
      </div>
    </a-modal>
  </div>
</template>

<script>
import { getDict } from '@/api/system'
import ApiURLs from '@/api/urls'
import { STable } from '@/components'
import { getRiskPointListData } from '@/api/safety'
import Area from '@/views/safety/risk/Area.vue'
import { getChildNodesIds } from '@/utils/util'

const columnsPotentialFactor = [
  {
    title: '',
    dataIndex: 'selectColumn',
    width: '65px',
    align: 'center',
    scopedSlots: { customRender: 'selectColumn' },
  },
  {
    title: '风险点',
    dataIndex: 'riskName',
    align: 'left',
  },
  {
    title: '管控层级',
    dataIndex: 'riskLevelName',
    align: 'left',
  },
  {
    title: '位置/区域',
    dataIndex: 'areaLocation',
    align: 'left',
  },
  {
    title: '类型',
    dataIndex: 'riskType',
    align: 'left',
  },
  {
    title: '',
    dataIndex: 'action',
    align: 'left',
    fixed: 'right',
    scopedSlots: { customRender: 'action' },
  },
]
const MAIN_NAME = '神木天元化工有限公司'
export default {
  name: 'SpangWebPlanriskpointselect',

  components: { Area, STable },

  // directives: { DirectiveName },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => {},
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    typeOptions: {
      type: Array,
      default: [],
    },
  },
  data() {
    return {
      treeData: [],
      replaceFields: Object.freeze({
        title: 'mainName',
        key: 'id',
        children: 'children',
        value: 'id',
      }),
      expandedKeys: [],
      autoExpandParent: true,
      riskLevelOptions: [],
      riskTypeOptions: [],
      queryParam: {},
      selectRiskPoint: [],
      tableData: { data: [] },
      // rowSelection: {
      //   onChange: (selectedRowKeys, selectedRows) => {
      //     console.log(`selectedRowKeys: ${selectedRowKeys}`, 'selectedRows: ', selectedRows)
      //   },
      //   onSelect: (record, selected, selectedRows) => {
      //     console.log(record, selected, selectedRows)
      //     // record.selected = !record.selected;
      //     this.selectPoint(record);
      //   },
      //   onSelectAll: (selected, selectedRows, changeRows) => {
      //     console.log(selected, selectedRows, changeRows)
      //   },
      // },
    }
  },
  created() {
    this.selectOptionsInit()
    this.getTreeData()
  },
  mounted() {},

  computed: {
    columnsPotentialFactor: () => columnsPotentialFactor,
  },
  methods: {
    selectPoint(record) {
      record.selected = !record.selected
      this.selectRiskPoint = this.tableData.data.filter((x) => x.selected)
    },
    unSelectPoint(index, item) {
      this.selectRiskPoint.splice(index, 1)
      item.selected = false
    },
    searchData(isreset = false) {
      if (isreset) {
        this.queryParam = {}
      }
      this.$refs.formTable.refresh(true)
      this.$refs.formTable.clearSelected()
    },
    doneRiskPoint() {
      this.potentialRiskVisible = false
      this.$emit('ok', [...this.selectRiskPoint])
    },
    cancelRiskPoint() {
      this.potentialRiskVisible = false
      this.$emit('cancel', { ...{}, ...this.queryParam })
    },
    selectOptionsInit() {
      const dictKey = 'RISK_LEVEL'
      let options = []
      getDict(dictKey).then(({ data, success }) => {
        if (success) {
          this.riskLevelOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
          options = this.riskLevelOptions
        }
      })

      getDict('RISK_TYPE').then(({ data, success }) => {
        if (success) {
          this.riskTypeOptions = data.map((row) => {
            return {
              label: row.dictValue,
              value: row.dictKey,
            }
          })
          options = this.riskTypeOptions
        }
      })
    },
    onSelectBranch(selectedKeys, info) {
      this.queryParam.nodeId = selectedKeys[0]
      this.parentNodeName = info.node.dataRef.mainName
      this.expandedKeys = [...this.expandedKeys, ...selectedKeys]
    },
    onExpand(expandedKeys) {
      console.log('onExpand', expandedKeys)
      // if not set autoExpandParent to false, if children expanded, parent can not collapse.
      // or, you can remove all expanded children keys.
      this.expandedKeys = expandedKeys
      this.autoExpandParent = false
    },
    getTreeData() {
      this.getList(ApiURLs.areaTreeList, 0).then((res) => {
        if (res.success) {
          res.data = [
            {
              id: 0,
              children: res.data,
              parentId: -1,
              mainName: MAIN_NAME,
            },
          ]
          this.treeData = res.data
          console.log('==== res.data', res.data)
          if (this.expandedKeys.length === 0) {
            this.expandedKeys.push(this.treeData[0].id)
          }
        }
      })
    },
    loadData() {
      const postData = { ...this.queryParam }
      let mainIds
      if (this.queryParam.nodeId !== 0) {
        mainIds = getChildNodesIds(this.treeData, this.queryParam.nodeId)
        if (mainIds) {
          postData.areaLocationIds = mainIds
        }
      }
      postData.current = 1
      postData.size = 1000
      delete postData.nodeId
      delete postData.type
      // debugger;
      return getRiskPointListData(postData).then((res) => {
        if (res.success && res.code === 200) {
          const list = {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records,
          }
          this.tableData = list
          console.log('==== this.tableData', this.tableData)
          return list
        }
      })
    },
  },
}
</script>

<style lang="scss" scoped>
</style>