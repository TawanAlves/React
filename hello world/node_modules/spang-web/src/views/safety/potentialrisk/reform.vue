<template>
  <page-container :title="false">
    <a-card :bordered="false" v-if="!editShow">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="4">
              <a-form-item label="关键字">
                <a-input v-model="queryParam.blurry" />
              </a-form-item>
            </a-col>
            <a-col :md="4">
              <a-form-item label="隐患级别">
                <a-select v-model="queryParam.level">
                  <a-select-option v-for="d in riskLevelOptions" :key="d.dictKey">{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="4">
              <!-- <a-form-item label="类别">
                <a-select v-model="queryParam.type">
                  <a-select-opt-group v-for="item in riskTypeOptions" :key="item.dictValue">
                    <a-select-option v-for="d in item.children" :key="d.id">
                      {{ d.dictValue }}
                    </a-select-option>
                  </a-select-opt-group>
                </a-select>
              </a-form-item>-->
              <type-select decorator-name="type" labelName="类别" />
            </a-col>
            <a-col :md="5">
              <a-form-item label="整改期限">
                <a-range-picker v-model="queryParam.abarbeitungDeadline" :valueFormat="dateFormat" />
              </a-form-item>
            </a-col>
            <a-col :md="5">
              <a-form-item label="检查时间">
                <a-range-picker v-model="queryParam.checkTime" :valueFormat="dateFormat" />
              </a-form-item>
            </a-col>
          </a-row>
          <a-row>
            <a-col :md="24" style="padding: 0 !important">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="reformResearch">查询</a-button>
                <a-button
                  type="second"
                  style="margin-left: 10px; margin-right: 5px"
                  @click="reformRefresh"
                >重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <div class="table-operator" v-if="true">
        <a-button type="primary" icon="plus" @click="reformAdd">新增</a-button>
        <!--        <a-button icon="delete" :disabled="!hasSelected" @click="reformRemove">删除</a-button>-->
        <a-radio-group
          button-style="solid"
          v-model="tableType"
          @change="reformRefresh"
          style="float: right"
        >
          <a-radio-button value="all">查看全部</a-radio-button>
          <a-radio-button value="todo">待办任务</a-radio-button>
          <!-- <a-radio-button value="send">已发任务</a-radio-button> -->
        </a-radio-group>
      </div>
      <s-table
        ref="reformTable"
        size="default"
        :rowKey="(record) => record.id"
        :scroll="{ x: 1000, y: `calc(100vh - 360px)` }"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="false"
        showPagination="true"
      >
        <span slot="statusName" slot-scope="text, record">
          <a-tag :color="[4].includes(record.status) ? 'red' : 'green'">{{ text }}</a-tag>
        </span>
        <span slot="action1" slot-scope="text, record" style="margin-right: 18px">
          <a @click="reformCheck(record)">查看</a>
        </span>
        <span slot="action2" slot-scope="text, record">
          <a @click="reformCheck(record)">查看</a>
          <a-divider type="vertical" />
          <a @click="reformApprove(record)" v-if="[1].includes(record.status)">审批</a>
          <a-divider type="vertical" v-if="[1].includes(record.status)" />
          <a
            @click="reformRectify(record)"
            v-if="userInfo.id === record.dutyPersonId && [0].includes(record.status)"
          >整改</a>
          <a-divider
            type="vertical"
            v-if="userInfo.id === record.dutyPersonId && [0].includes(record.status)"
          />
          <a
            @click="reformDelay(record)"
            v-if="userInfo.id === record.dutyPersonId && [0, -1].includes(record.status)"
          >延期</a>
          <a-divider
            type="vertical"
            v-if="userInfo.id === record.dutyPersonId && [0, -1].includes(record.status)"
          />
          <a
            @click="reformRecheck(record)"
            v-if="userInfo.id === record.reviewPersonId && [2].includes(record.status)"
          >复查</a>
          <a-divider
            type="vertical"
            v-if="userInfo.id === record.reviewPersonId && [2].includes(record.status)"
          />
          <a @click="flowchartShow(record)">流程示意</a>
        </span>
      </s-table>
      <reform-modal
        ref="reformModal"
        :modal-title="title"
        :visible="visible"
        :disabled="modalDisabled"
        :model="modalData"
        :level="riskLevelOptions"
        :risk-type="riskTypeOptions"
        :reform-type="abarbeitungTypeOptions"
        @cancel="addModalCancel"
        @ok="addModalOk"
      />
      <delay-modal
        ref="delayModal"
        :model="delayData"
        :visible="delayVisible"
        @cancel="delayCancel"
        @ok="delayOk"
      />
      <flow-chart
        ref="flowchart"
        :model="modalData"
        :visible="flowChartVisible"
        @cancel="flowchartCancel"
      ></flow-chart>
      <approve-modal
        ref="approveModal"
        :mode="'delay'"
        :delay-info="modalData"
        :visible="approveVisible"
        @cancel="approveCancel"
        @ok="approveOk"
      />
      <rectify-modal
        ref="rectifyModal"
        :visible="rectifyVisible"
        @cancel="rectifyCancel"
        @ok="rectifyOk"
      />
      <recheck-modal
        ref="recheckModal"
        :visible="recheckVisible"
        @cancel="recheckCancel"
        @ok="recheckOk"
      />
      <detail-modal
        ref="detailModal"
        :basic-info="detailInfo"
        :visible="detailVisible"
        @cancel="detailCancel"
      />
    </a-card>
    <fill v-else-if="editShow" @childFn="parentFn" :model="modalData" />
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { reform, getPotentialRiskType, getPotentialRiskLevel, getAbarbeitungType } from '@/api/safety'
import { reformColumns } from '@/views/safety/table'
import ReformModal from '@/views/safety/potentialrisk/components/ReformModal'
import fill from '@/views/safety/potentialrisk/fill'
import TypeSelect from '@/views/safety/potentialrisk/TypeSelect'
import { getStore } from '@/utils/store'
import DelayModal from '@/views/safety/potentialrisk/components/DelayModal'
import FlowChart from '@/views/safety/schedule/component/FlowChart'
import ApproveModal from '@/views/safety/schedule/component/ApproveModal'
import DetailModal from '@/views/safety/potentialrisk/components/DetailModal'
import RectifyModal from '@/views/safety/potentialrisk/components/RectifyModal'
import RecheckModal from '@/views/safety/potentialrisk/components/RecheckModal'

export default {
  components: {
    STable,
    ReformModal,
    fill,
    TypeSelect,
    DelayModal,
    FlowChart,
    ApproveModal,
    DetailModal,
    RectifyModal,
    RecheckModal
  },
  data() {
    return {
      editShow: false,
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        if (this.tableType === 'all') {
          return reform.getReformList(requestParameters).then(res => {
            this.columns.pop()
            this.columns.push({
              title: '操作',
              dataIndex: 'action1',
              width: '120px',
              align: 'center',
              scopedSlots: { customRender: 'action1' }
            })
            return {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: res.data.records
            }
          })
        } else if (this.tableType === 'todo') {
          return reform.getReformTodoList(requestParameters).then(res => {
            if (Object.keys(res.data).length === 0) {
              return { data: [] }
            }
            this.columns.pop()
            this.columns.push({
              title: '操作',
              dataIndex: 'action',
              width: '200px',
              align: 'center',
              fixed: 'right',
              scopedSlots: { customRender: 'action2' }
            })
            return {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: res.data.records
            }
          })
        }
      },
      // select options
      riskLevelOptions: [],
      riskTypeOptions: [],
      abarbeitungTypeOptions: [],
      // add modal
      title: '',
      visible: false,
      modalData: {},
      modalDisabled: false,
      userInfo: getStore({ name: 'info' }),
      isAdmin: getStore({ name: 'info' }).roleId === '1330762984195112961',
      // delayModal
      delayVisible: false,
      delayData: {},
      // flowchart
      flowChartVisible: false,
      // approve modal
      approveVisible: false,
      rectifyVisible: false,
      recheckVisible: false,
      // detail modal
      detailVisible: false,
      detailInfo: {},
      // detailId: '',
      tableType: 'all'
    }
  },
  provide() {
    return {
      modal: this
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    columns: () => reformColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    parentFn(edit) {
      this.editShow = edit.show
      this.modalData = {}
    },
    selectOptionsInit() {
      getPotentialRiskType().then(res => {
        this.riskTypeOptions = res.data
      })
      getPotentialRiskLevel().then(res => {
        this.riskLevelOptions = res.data
      })
      getAbarbeitungType().then(res => {
        this.abarbeitungTypeOptions = res.data
      })
    },
    modalInit() {
      this.visible = false
      this.modalDisabled = false
      this.approveVisible = false
      this.delayVisible = false
      this.rectifyVisible = false
      this.recheckVisible = false
      this.modalData = {}
      this.$refs.reformModal.form.resetFields()
      this.$refs.approveModal.form.resetFields()
      this.$refs.rectifyModal.form.resetFields()
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    reformResearch() {
      this.$refs.reformTable.refresh(true)
      this.$refs.reformTable.clearSelected()
    },
    reformRefresh() {
      this.queryParam = {}
      this.$refs.reformTable.refresh(true)
      this.$refs.reformTable.clearSelected()
    },
    reformAdd() {
      this.visible = true
      this.title = '隐患信息填报'
      // this.editShow = true
    },
    reformCheck(record) {
      // this.visible = true
      // this.title = '隐患信息查看'
      // this.modalData = { ...record }
      // this.modalDisabled = true
      // this.detailId = record.id
      this.detailInfo = { ...record }
      this.detailVisible = true
    },
    reformEdit(record) {
      this.visible = true
      this.title = '隐患信息编辑'
      this.modalData = { ...record }
      // this.model = { ...record }
      // this.editShow = true
    },
    reformRemove() {
      const ids = this.selectedRows.map(item => {
        return item.id
      })
      this.removeConfirm(ids)
    },
    removeConfirm(ids) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将要删除选中数据，是否确认',
        okText: '确认',
        okType: 'danger',
        cancelText: '取消',
        onOk() {
          reform.removeReformList(ids).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.reformTable.refresh(true)
              _this.$refs.reformTable.clearSelected()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    addModalCancel() {
      this.modalInit()
    },
    addModalOk() {
      if (this.modalDisabled) {
        this.modalInit()
        return
      }
      const _this = this
      const form = this.$refs.reformModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          values.id = this.modalData.id
          reform.submitReformList(values).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.reformTable.refresh(true)
              _this.$refs.reformTable.clearSelected()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        } else {
          _this.$message.error('请检查表单格式后重试')
        }
      })
    },
    reformDelay(record) {
      this.delayData = { ...record }
      this.delayVisible = true
    },
    delayCancel() {
      this.delayVisible = false
      this.delayData = {}
    },
    delayOk() {
      const _this = this
      const form = this.$refs.delayModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          console.log(values)
          values.perilId = this.delayData.id
          values.abarbeitungDeadline = this.delayData.abarbeitungDeadline
          values.isReject = -1
          values.accessory = 'test'
          reform.delayReformItem(values).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.reformTable.refresh(true)
              _this.$refs.reformTable.clearSelected()
              _this.delayVisible = false
              _this.delayData = {}
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    flowchartShow(record) {
      this.flowChartVisible = true
      this.modalData = record
    },
    flowchartCancel() {
      this.flowChartVisible = false
    },
    reformApprove(record) {
      const _this = this
      reform.getDelayInfo({ perilId: record.id }).then(res => {
        _this.modalData = res.data // 延期信息作为modalData
        _this.approveVisible = true
      })
      reform.getApproveInfo({ perilId: record.id }).then(res => {
        _this.modalData.approveInfoId = res.data.id // 延期信息作为modalData
      })
    },
    approveCancel() {
      this.modalData = {}
      this.approveVisible = false
    },
    approveOk() {
      const _this = this
      const form = this.$refs.approveModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          console.log(values)
          var params = {}
          params.id = this.modalData.approveInfoId
          params.perilId = this.modalData.perilId
          params.delayInfoId = this.modalData.id
          params.isAgree = Number(values.status)
          params.delayOpinion = values.comment
          params.accessory = 'test'
          reform.approveReformDelay(params).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.reformTable.refresh(true)
              _this.$refs.reformTable.clearSelected()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    reformRectify(record) {
      this.modalData = record
      this.rectifyVisible = true
    },
    rectifyCancel() {
      this.modalData = {}
      this.rectifyVisible = false
    },
    rectifyOk() {
      const _this = this
      const form = this.$refs.rectifyModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          values.perilId = this.modalData.id
          values.isReject = -1
          values.accessory = 'test'
          reform.rectifyReformItem(values).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.reformTable.refresh(true)
              _this.$refs.reformTable.clearSelected()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    reformRecheck(record) {
      this.modalData = record
      this.recheckVisible = true
      // const _this = this
      // reform.getDelayInfo({perilId:record.id}).then(res => {
      //   _this.modalData = res.data //延期信息作为modalData
      //   _this.recheckVisible = true
      // })
      // reform.getApproveInfo({perilId:record.id}).then(res => {
      //   _this.modalData.approveInfoId = res.data.id //延期信息作为modalData
      // })
    },
    recheckCancel() {
      this.modalData = {}
      this.recheckVisible = false
    },
    recheckOk() {
      const _this = this
      const form = this.$refs.recheckModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          console.log(values)
          var params = {}
          params.perilId = this.modalData.id
          params.isAgree = Number(values.status)
          params.reviewOpinion = values.reviewOpinion
          params.accessory = 'test'
          reform.recheckReformItem(params).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.reformTable.refresh(true)
              _this.$refs.reformTable.clearSelected()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    detailCancel() {
      this.detailVisible = false
    }
  }
}
</script>

<style lang="less" scoped>
.operation-btn {
  margin: 2px 4px;
}

/deep/ .ant-table {
  height: calc(100vh - 290px);
}

/deep/ .ant-card-body {
  .ant-table-wrapper {
    min-height: calc(100vh - 225px);
  }
}
</style>
