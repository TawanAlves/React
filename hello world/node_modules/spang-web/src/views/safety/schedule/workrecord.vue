<template>
  <page-container :title="false">
    <a-card :bordered="false">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="4">
              <a-form-item label="关键字">
                <a-input v-model="queryParam.blurry"/>
              </a-form-item>
            </a-col>
            <a-col :md="4">
              <a-form-item label="工作类型">
                <a-select v-model="queryParam.workType">
                  <a-select-option v-for="d in workTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="6">
              <a-form-item label="创建时间">
                <a-range-picker v-model="queryParam.startTimeList" valueFormat="YYYY-MM-DD HH:mm:ss"/>
              </a-form-item>
            </a-col>
            <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="workRecordResearch">查询</a-button>
                <a-button type="second" style="margin-left: 10px" @click="workRecordRefresh">重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <div class="table-operator">
        <a-button type="primary" icon="plus" @click="workRecordAdd">新增</a-button>
        <!--        <a-button icon="delete" :disabled="!hasSelected" @click="workRecordRemove">删除</a-button>-->
      </div>
      <s-table
        ref="workRecordTable"
        size="default"
        :scroll="{y: 'calc(100vh - 360px)',x:1000}"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="false"
        showPagination="true"
      >
        <span slot="action" slot-scope="text, record">
          <template>
            <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin:0 4px">-->
            <!--              <a-button type="primary" size="small" @click="workRecordCheck(record)"><a-icon type="file-search"/> 查看</a-button>-->
            <!--            </a-config-provider>-->
            <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin:0 4px">-->
            <!--              <a-button type="primary" size="small" @click="workRecordEdit(record)"><a-icon type="edit"/>编辑</a-button>-->
            <!--            </a-config-provider>-->
            <a @click="workRecordCheck(record)">查看</a>
            <a-divider type="vertical"/>
            <a @click="workRecordEdit(record)" style="margin-right:15px;">编辑</a>
          </template>
        </span>
      </s-table>
      <record-modal
        ref="recordModal"
        mode="work"
        :model="recordData"
        :modal-title="recordTitle"
        :visible="recordVisible"
        :disabled="disabled"
        :work-type-options="workTypeOptions"
        @cancel="recordCancel"
        @ok="recordOk"
      ></record-modal>
      <detail-modal
        ref="detailModal"
        mode="workRecord"
        :visible="detailVisible"
        :basic-info="detailBasicInfo"
        @cancel="detailCancel"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { getWorkType, workRecord } from '@/api/safety'
import { workRecordColumns } from '@/views/safety/table'
import RecordModal from '@/views/safety/schedule/component/RecordModal'
import DetailModal from '@/views/safety/schedule/component/DetailModal'

export default {
  components: {
    STable,
    RecordModal,
    DetailModal
  },
  data () {
    return {
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        this.queryParam.startTimeList && (this.startTimeList = typeof this.queryParam.startTimeList === 'string' ? this.queryParam.startTimeList : this.queryParam.startTimeList.join())
        Object.assign(requestParameters, this.queryParam)
        return workRecord.getWorkRecordList(requestParameters).then(res => {
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      // select options
      workTypeOptions: [],
      // record modal
      recordVisible: false,
      recordTitle: '',
      recordData: '',
      disabled: false,
      // detail modal
      detailVisible: false,
      detailBasicInfo: {}
    }
  },
  created () {
    this.selectOptionsInit()
  },
  computed: {
    columns: () => workRecordColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectOptionsInit () {
      getWorkType().then(res => {
        this.workTypeOptions = res.data
      })
    },
    recordModalInit () {
      this.recordVisible = false
      this.recordData = {}
      this.recordTitle = ''
      this.disabled = false
      this.$refs.recordModal.form.resetFields()
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    workRecordResearch () {
      this.$refs.workRecordTable.refresh(true)
      this.$refs.workRecordTable.clearSelected()
    },
    workRecordRefresh () {
      this.queryParam = {}
      this.$refs.workRecordTable.refresh(true)
      this.$refs.workRecordTable.clearSelected()
    },
    workRecordAdd () {
      this.recordTitle = '记录填报'
      this.recordVisible = true
    },
    workRecordRemove () {
      const ids = this.selectedRows.map(item => {
        return item.id
      })
      this.removeConfirm(ids)
    },
    removeConfirm (ids) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将删除选中数据，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk () {
          workRecord.removeWorkRecordList(ids).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.workRecordTable.refresh(true)
              _this.$refs.workRecordTable.clearSelected()
            } else {
              _this.$message.success('删除失败')
            }
          })
        }
      })
    },
    workRecordCheck (record) {
      // this.recordTitle =  '查看记录'
      // this.recordData = { ...record }
      // this.disabled = true
      // this.recordVisible = true
      this.detailBasicInfo = { ...record }
      this.detailVisible = true
      // workRecord.detailWorkRecordList(record.id).then(res => {
      //   this.detailBasicInfo = { ...res.data }
      //   this.detailVisible = true
      //   console.log(res.data)
      // })
    },
    workRecordEdit (record) {
      this.recordTitle = '修改记录'
      this.recordData = { ...record }
      this.recordVisible = true
    },
    recordOk () {
      const _this = this
      const form = this.$refs.recordModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          values.id = this.recordData.id
          workRecord.submitWorkRecordList(values).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.recordModalInit()
              _this.$refs.workRecordTable.refresh()
              _this.$refs.workRecordTable.clearSelected()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    recordCancel () {
      this.recordModalInit()
    },
    detailCancel () {
      this.detailVisible = false
      this.detailBasicInfo = {}
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: calc(100vh - 288px);
}
/deep/ .ant-card-body {
  .ant-table-wrapper {
    min-height: calc(100vh - 225px)
  }
}
</style>
