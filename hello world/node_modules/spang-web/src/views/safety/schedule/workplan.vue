<template>
  <page-container :title="false">
    <a-card :bordered="false">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="4">
              <a-form-item label="关键字">
                <a-input v-model="queryParam.blurry"/>
              </a-form-item>
            </a-col>
            <a-col :md="4">
              <a-form-item label="工作类型">
                <a-select v-model="queryParam.workType">
                  <a-select-option v-for="d in workTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="6">
              <a-form-item label="创建时间">
                <a-range-picker v-model="queryParam.createTimeList" valueFormat="YYYY-MM-DD HH:mm:ss"/>
              </a-form-item>
            </a-col>
            <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="workPlanResearch">查询</a-button>
                <a-button type="second" style="margin-left: 10px" @click="workPlanRefresh">重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <div class="table-operator">
        <a-row>
          <a-col :span="4">
            <a-button type="primary" icon="plus" @click="workPlanAdd">新增</a-button>
            <!--            <a-button icon="delete" :disabled="!hasSelected" @click="workPlanRemove">删除</a-button>-->
          </a-col>
          <a-col :offset="20">
            <a-radio-group button-style="solid" v-model="tableType" @change="$refs.workPlanTable.refresh(true)">
              <a-radio-button value="all">查看全部</a-radio-button>
              <a-radio-button value="todo">待办任务</a-radio-button>
              <!-- <a-radio-button value="send">已发任务</a-radio-button> -->
            </a-radio-group>
          </a-col>
        </a-row>
      </div>
      <s-table
        ref="workPlanTable"
        size="default"
        :scroll="{y: 'calc(100vh - 360px)',x:500}"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="false"
        showPagination="true"
      >
        <span slot="statusName" slot-scope="text, record">
          <a-tag :color="record.status===2 || record.status===5?'red':'green'">{{ text }}</a-tag>
        </span>
        <span slot="action1" slot-scope="text, record, index" style="margin-right: 15px;">
          <a @click="workPlanCheck(record)">查看</a>
          <a-divider type="vertical" v-if="userInfo.id === record.chargerId && [1].includes(record.status)"/>
          <a @click="workPlanRecord(record)" v-if="userInfo.id === record.chargerId && [1].includes(record.status)">记录</a>
        </span>
        <span slot="action2" slot-scope="text, record, index">
          <a @click="workPlanApprove(record, index)" v-if="[0].includes(record.status)">审批</a>
          <a-divider type="vertical" v-if="[0].includes(record.status)"/>
          <a @click="workPlanRevoke(record, index)" v-if="userInfo.id === record.creatorId && [0].includes(record.status)">撤回</a>
          <a-divider type="vertical" v-if="userInfo.id === record.creatorId && [0].includes(record.status)"/>
          <a @click="workPlanEdit(record, index)" v-if="[2,6].includes(record.status)">编辑</a>
          <a-divider type="vertical" v-if="[2,6].includes(record.status)"/>
          <a @click="workPlanCheck(record)">查看</a>
          <a-divider type="vertical"/>
          <a @click="flowchartShow(record, index)">流程示意</a>
          <a-divider type="vertical"/>
        </span>
        <span slot="action3" slot-scope="text, record, index">
          <a @click="workPlanCheck(record)">查看</a>
          <a-divider type="vertical" v-if="userInfo.id === record.creatorId && [0].includes(record.status)"/>
          <a @click="workPlanRevoke(record, index)" v-if="userInfo.id === record.creatorId && [0].includes(record.status)">撤回</a>
          <a-divider type="vertical"/>
        </span>
        <!--        <span slot="action" slot-scope="text, record, index" v-else-if="tableType === 'todo1'">-->
        <!--          <template>-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px" v-if="[0].includes(record.status)">-->
        <!--              <a-button type="danger" size="small" @click="workPlanApprove(record, index)"><a-icon type="user"/>审批</a-button>-->
        <!--            </a-config-provider>-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px" v-if="userInfo.id === record.creatorId && [0].includes(record.status)">-->
        <!--              <a-button type="danger" size="small" @click="workPlanRevoke(record, index)"><a-icon type="file-text"/>撤回</a-button>-->
        <!--            </a-config-provider>-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px" v-if="[2,6].includes(record.status)">-->
        <!--              <a-button type="primary" size="small" @click="workPlanEdit(record, index)"><a-icon type="edit"/>编辑</a-button>-->
        <!--            </a-config-provider>-->
        <!--            &lt;!&ndash; <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px" v-if="[1].includes(record.status)">-->
        <!--              <a-button type="danger" size="small" @click="workPlanRecord(record)"><a-icon type="file-text"/>记录</a-button>-->
        <!--            </a-config-provider> &ndash;&gt;-->
        <!--            &lt;!&ndash; <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px" v-if="[2,3,4].includes(record.status)">-->
        <!--              <a-button type="danger" size="small" @click="workPlanStop(record)"><a-icon type="file-text"/>停用</a-button>-->
        <!--            </a-config-provider> &ndash;&gt;-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px">-->
        <!--              <a-button type="primary" size="small" @click="workPlanCheck(record)"><a-icon type="file-search"/> 查看</a-button>-->
        <!--            </a-config-provider>-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px">-->
        <!--              <a-button style="background-color: #0BB7AF;color: #fdfdfd" size="small" @click="flowchartShow(record, index)"><a-icon type="share-alt"/>流程示意</a-button>-->
        <!--            </a-config-provider>-->
        <!--          </template>-->
        <!--        </span>-->
        <!--        <span slot="action" slot-scope="text, record, index" v-else>-->
        <!--          <template>-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px">-->
        <!--              <a-button type="primary" size="small" @click="workPlanCheck(record)"><a-icon type="file-search"/> 查看</a-button>-->
        <!--            </a-config-provider>-->
        <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px" v-if="userInfo.id === record.creatorId && [0].includes(record.status)">-->
        <!--              <a-button type="danger" size="small" @click="workPlanRevoke(record, index)"><a-icon type="file-text"/>撤回</a-button>-->
        <!--            </a-config-provider>-->
        <!--          </template>-->
        <!--        </span>-->
      </s-table>
      <work-plan-modal
        ref="workPlanModal"
        mode="work"
        :modal-title="commonTitle"
        :visible="commonVisible"
        :disabled="commonDisabled"
        :model="commonData"
        :work-type-options="workTypeOptions"
        :execute-type-options="executeTypeOptions"
        @cancel="workPlanCancel"
        @ok="workPlanOk"
      />
      <flow-chart
        ref="flowchart"
        :model="processDataList[processDataIndex]"
        :visible="flowChartVisible"
        @cancel="flowchartCancel"
      ></flow-chart>
      <approve-modal
        ref="approveModal"
        :visible="approveVisible"
        @cancel="approveCancel"
        @ok="approveOk"
      >
      </approve-modal>
      <record-modal
        ref="recordModal"
        modal-title="执行记录填报"
        mode="work"
        :visible="recordVisible"
        :work-type-options="workTypeOptions"
        @ok="recordOk"
        @cancel="recordCancel"
      ></record-modal>
      <detail-modal
        ref="detailModal"
        mode="workPlan"
        :basic-info="detailBasicInfo"
        :visible="detailVisible"
        @cancel="detailCancel"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { workPlan, getWorkType, getOriPlanExecuteType, submitWorkRecordList } from '@/api/safety'
import { workPlanColumns } from '@/views/safety/table'
import WorkPlanModal from '@/views/safety/schedule/component/PlanModal'
import FlowChart from '@/views/safety/schedule/component/FlowChart'
import ApproveModal from '@/views/safety/schedule/component/ApproveModal'
import RecordModal from '@/views/safety/schedule/component/RecordModal'
import { getStore } from '@/utils/store'
import DetailModal from '@/views/safety/schedule/component/DetailModal'

export default {
  components: {
    STable,
    WorkPlanModal,
    FlowChart,
    ApproveModal,
    RecordModal,
    DetailModal
  },
  data () {
    return {
      switchShow: true,
      selectedRowKeys: [],
      selectedRows: [],
      queryParam: {},
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        this.queryParam.createTimeList && (this.queryParam.createTimeList = typeof this.queryParam.createTimeList === 'string' ? this.queryParam.createTimeList : this.queryParam.createTimeList.join())
        Object.assign(requestParameters, this.queryParam)
        if (this.tableType === 'all') {
          return workPlan.getWorkPlanList(requestParameters).then(res => {
            this.columns.pop()
            this.columns.push({
              title: '操作',
              dataIndex: 'action1',
              width: '120px',
              align: 'center',
              scopedSlots: { customRender: 'action1' }
            })
            return {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: res.data.records
            }
          })
        } else if (this.tableType === 'todo') {
          return workPlan.getWorkPlanTodoList({ processId: this.processId }).then(res => {
            // if (Object.keys(res.data).length===0) {
            //   return {data: []}
            // }
            this.columns.pop()
            this.columns.push({
              title: '操作',
              dataIndex: 'action2',
              width: '200px',
              align: 'center',
              scopedSlots: { customRender: 'action2' }
            })
            this.processDataList = res.data
            const workPlanData = res.data.map(item => {
              return item.workPlanVO
            })
            return {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: workPlanData
            }
          })
        } else {
          return workPlan.getWorkPlanSendList(requestParameters).then(res => {
            this.columns.pop()
            this.columns.push({
              title: '操作',
              dataIndex: 'action3',
              width: '120px',
              align: 'center',
              scopedSlots: { customRender: 'action3' }
            })
            this.processDataList = res.data
            const workPlanData = res.data.map(item => {
              return item.workPlanVO
            })
            return {
              totalCount: res.data.total,
              totalPage: res.data.pages,
              pageNo: res.data.current,
              pageSize: res.data.size,
              data: workPlanData
            }
          })
        }
      },
      // select options
      workTypeOptions: [],
      executeTypeOptions: [],
      // modal
      commonDisabled: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonMode: true, // add：true edit：false
      // flowchart
      flowChartVisible: false,
      // approve
      approveVisible: false,
      // record
      recordVisible: false,
      tableType: 'all',
      processDataList: [], // 记录工作流相关信息
      processDataIndex: 0, // 记录要操作的工作流index
      userInfo: getStore({ name: 'info' }),
      isAdmin: getStore({ name: 'info' }).roleId === '1330762984195112961',
      // detail
      detailVisible: false,
      detailBasicInfo: {},
      detailMode: 'workPlan',
      processId: ''
    }
  },
  created () {
    this.selectOptionsInit()

    workPlan.getWorkPlanService().then(res => {
      var service = res.data
      workPlan.getFlowTypeList({ service: service }).then(res => {
        var typeList = res.data
        const item = typeList.find(item => item.name === '安全计划')
        if (item) {
          workPlan.getWorkPlanProcessList({ service: service, type: item.id }).then(res => {
            var process = res.data.slice(-1)
            this.processId = process[0].id
            console.log('!!!!!!', this.processId)
          })
        }
      })
    })
  },
  computed: {
    columns: () => workPlanColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectOptionsInit () {
      getWorkType().then(res => {
        this.workTypeOptions = res.data
      })
      getOriPlanExecuteType().then(res => {
        this.executeTypeOptions = res.data
      })
    },
    modalInit () {
      this.commonTitle = ''
      this.commonDisabled = false
      this.commonData = {}
      this.commonVisible = false
      this.recordVisible = false
      // this.$refs.workPlanModal.form.resetFields()
      this.$refs.recordModal.form.resetFields()
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    workPlanResearch () {
      this.$refs.workPlanTable.refresh(true)
      this.$refs.workPlanTable.clearSelected()
    },
    workPlanRefresh () {
      this.queryParam = {}
      this.$refs.workPlanTable.refresh(true)
      this.$refs.workPlanTable.clearSelected()
    },
    workPlanAdd () {
      this.commonTitle = '新增计划'
      this.commonVisible = true
      this.commonMode = true
    },
    workPlanRemove () {
      const ids = this.selectedRows.map(item => {
        return item.id
      })
      this.removeConfirm(ids)
    },
    removeConfirm (ids) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将删除选中数据，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk () {
          workPlan.removeWorkPlanList(ids).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.workPlanTable.refresh(true)
              _this.$refs.workPlanTable.clearSelected()
            } else {
              _this.$message.success('删除失败')
            }
          })
        }
      })
    },
    workPlanCheck (record) {
      // this.commonTitle = '查看计划'
      // this.commonData = { ...record }
      // this.commonDisabled = true
      // this.commonVisible = true
      this.detailBasicInfo = { ...record }
      this.detailVisible = true
      // workPlan.detailWorkPlanList(record.id).then(res => {
      //   if (res.code === 200) {
      //     this.detailBasicInfo = { ...res.data }
      //     this.detailVisible = true
      //   }
      // })
    },
    workPlanEdit (record, index) {
      this.commonTitle = '编辑'
      this.commonData = record
      this.processDataIndex = index
      this.commonVisible = true
      this.commonMode = false
    },
    workPlanCancel () {
      this.modalInit()
      this.$refs.workPlanTable.refresh(true)
      this.$refs.workPlanTable.clearSelected()
    },
    workPlanOk () {
      if (this.commonDisabled) {
        this.$message.success('查看返回')
        this.commonInit()
        return
      }
      const _this = this
      const form = this.$refs.workPlanModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          if (!_this.commonMode) {
            //  编辑接口
            values.id = _this.commonData.id
            var params = {}
            var processData = this.processDataList[this.processDataIndex]
            params.businessId = _this.commonData.id
            params.taskId = processData.taskId
            params.processInstanceId = processData.processInstanceId
            params.variables = { status: 0 }
            params.workPlan = values
            workPlan.approveWorkPlan(params).then(res => {
              if (res.code === 200) {
                _this.$message.success(`${res.msg}`)
                _this.modalInit()
                _this.$refs.workPlanTable.refresh(true)
              } else {
                _this.$message.error(`${res.msg}`)
              }
            }).catch(error => {
              _this.$message.error(`${error.response.data.msg}`)
            })
          } else {
            var requestForm = {}
            requestForm.processDefinitionKey = 'work_plan' // 新增工作计划并工作流字段
            requestForm.workPlan = values
            requestForm.workPlan.workType = 1
            requestForm.workPlan.executePeriod = 2
            workPlan.submitWorkPlanList(requestForm).then(res => {
              if (res.code === 200) {
                _this.$message.success(`${res.msg}`)
                _this.modalInit()
                _this.$refs.workPlanTable.refresh(true)
                _this.$refs.workPlanTable.clearSelected()
              } else {
                _this.$message.error(`${res.msg}`)
              }
            })
          }
        }
      })
    },
    flowchartShow (record, index) {
      this.flowChartVisible = true
      this.processDataIndex = index
    },
    flowchartCancel () {
      this.flowChartVisible = false
    },
    workPlanRecord (record) {
      this.commonData = record
      this.recordVisible = true
    },
    recordOk () {
      const _this = this
      const form = this.$refs.recordModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          values.workId = this.commonData.id
          submitWorkRecordList(values).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              this.modalInit()
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    recordCancel () {
      this.modalInit()
    },
    workPlanApprove (record, index) {
      this.processDataIndex = index
      this.approveVisible = true
      this.commonData = { ...record }
    },
    approveCancel () {
      this.$refs.approveModal.form.resetFields()
      this.approveVisible = false
    },
    approveOk () {
      const _this = this
      const form = this.$refs.approveModal.form
      form.validateFields((errors, values) => {
        if (!errors) {
          var params = {}
          var processData = this.processDataList[this.processDataIndex]
          params.businessId = this.commonData.id
          params.taskId = processData.taskId
          // params.processInstanceId = processData.processInstanceId
          params.comment = values.comment
          params.variables = { status: Number(values.status) }
          if (values.status === '2') {
            params.variables.skip = false
          }
          workPlan.approveWorkPlan(params).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.workPlanTable.refresh(true)
              _this.$refs.approveModal.form.resetFields()
              _this.approveVisible = false
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    workPlanRevoke (record, index) {
      this.commonData = { ...record }
      var processData = this.processDataList[index]
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将撤回该工作计划，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk () {
          var params = {}
          params.businessId = _this.commonData.id
          params.taskId = processData.taskId
          params.processInstanceId = processData.processInstanceId
          params.comment = '撤回申请'
          workPlan.revokeWorkPlan(params).then(res => {
            if (res.code === 200) {
              _this.$message.success(`${res.msg}`)
              _this.modalInit()
              _this.$refs.workPlanTable.refresh(true)
              _this.$refs.approveModal.form.resetFields()
              _this.approveVisible = false
            } else {
              _this.$message.error(`${res.msg}`)
            }
          })
        }
      })
    },
    workPlanStop () {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将停用该工作计划并送审，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk () {
          // workPlan.removeWorkPlanList(ids).then(res => {
          //   if (res.code === 200) {
          //     _this.$message.success('删除成功')
          //     _this.$refs.workPlanTable.refresh(true)
          //     _this.$refs.workPlanTable.clearSelected()
          //   } else {
          //     _this.$message.success('删除失败')
          //   }
          // })
        }
      })
    },
    detailCancel () {
      this.detailVisible = false
      this.detailBasicInfo = {}
    }
  }
}
</script>
<style lang="less" scoped>
.operation-btn {
  margin: 2px 4px;
}
/deep/ .ant-table {
  height: calc(100vh - 288px);
}
/deep/ .ant-card-body {
  .ant-table-wrapper {
    min-height: calc(100vh - 225px);
  }
}
</style>
