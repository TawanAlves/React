<template>
  <a-modal
    :title="modalTitle"
    :width="700"
    :visible="visible"
    :confirmLoading="loading"
    @ok="() => { $emit('ok') }"
    @cancel="() => { $emit('cancel') }"
    ok-text="提交"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <div style="height: 600px;">
        <a-form :form="form" :label-col="{ span: 6 }" :wrapper-col="{ span: 14 }">
          <department-select label-name="责任单位" decorator-name="dutyUnitId" :disabled="disabled"/>
          <person-select label-name="责任人" decorator-name="chargerId" required :disabled="disabled"/>
          <div v-if="mode==='work'">
            <a-form-item label="工作名称">
              <a-input v-decorator="['workName',{ rules:[{ required: true, message: '请输入项目名称' }]}]" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="工作类型">
              <a-select v-decorator="['workType',{ rules:[{ required: false, message: '请选择文件有效性' }]}]" :disabled="disabled">
                <a-select-option v-for="val in workTypeOptions" :key="val.dictKey">
                  {{ val.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item label="工作内容">
              <a-textarea :rows="4" v-decorator="['workContent',{ rules:[{ required: true, message: '请输入项目名称' }]}]" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="工作时间" style="margin-bottom:0;">
              <a-form-item
                :style="{ display: 'inline-block', width: 'calc(50% - 12px)' }"
              >
                <a-date-picker
                  style="width: 100%"
                  v-decorator="['startTime',{ rules:[{ required: false, message: '请选择开始时间' }]}]"
                  :disabled="disabled"
                  :valueFormat="dateFormat"/>
              </a-form-item>
              <span :style="{ display: 'inline-block', width: '24px', textAlign: 'center' }">至</span>
              <a-form-item :style="{ display: 'inline-block', width: 'calc(50% - 12px)' }">
                <a-date-picker
                  style="width: 100%"
                  v-decorator="['endTime',{ rules:[{ required: false, message: '请选择结束时间' }]}]"
                  :disabled="disabled"
                  :valueFormat="dateFormat"/>
              </a-form-item>
            </a-form-item>
          </div>
          <div v-if="mode==='inspection'">
            <a-form-item label="检查名称">
              <a-input v-decorator="['examinePlanName',{ rules:[{ required: true, message: '请输入项目名称' }]}]" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="检查类型">
              <a-select v-decorator="['examineType',{ rules:[{ required: false, message: '请选择文件有效性' }]}]" :disabled="disabled">
                <a-select-option v-for="val in inspectionTypeOptions" :key="val.dictKey">
                  {{ val.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item label="检查内容">
              <a-textarea :rows="4" v-decorator="['examineContent',{ rules:[{ required: true, message: '请输入项目名称' }]}]" :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="检查时间" style="margin-bottom:0;">
              <a-form-item
                :style="{ display: 'inline-block', width: 'calc(50% - 12px)' }"
              >
                <a-date-picker
                  style="width: 100%"
                  v-decorator="['startTime',{ rules:[{ required: false, message: '请选择开始时间' }]}]"
                  :disabled="disabled"
                  :valueFormat="dateFormat"/>
              </a-form-item>
              <span :style="{ display: 'inline-block', width: '24px', textAlign: 'center' }">至</span>
              <a-form-item :style="{ display: 'inline-block', width: 'calc(50% - 12px)' }">
                <a-date-picker
                  style="width: 100%"
                  v-decorator="['endTime',{ rules:[{ required: false, message: '请选择结束时间' }]}]"
                  :disabled="disabled"
                  :valueFormat="dateFormat"/>
              </a-form-item>
            </a-form-item>
          </div>
          <!-- <a-form-item label="记录整理人">
            <a-input v-decorator="['recordTidyPerson',{ rules:[{ required: true, message: '请输入记录整理人' }]}]" :disabled="disabled"/>
          </a-form-item> -->
          <person-select decorator-name="recordTidyPerson" labelName="记录整理人" :disabled="disabled" :initial-model="model?{id:model.recordTidyId,name:model.recordTidyPerson}:null"/>
          <a-form-item label="备注">
            <a-textarea :rows="4" v-decorator="['remark',{ rules:[{ required: true, message: '请输入备注' }]}]" :disabled="disabled"/>
          </a-form-item>
        </a-form>
      </div>
    </a-spin>
  </a-modal>
</template>

<script>
import pick from 'lodash.pick'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import AreaSelect from '@/views/safety/components/AreaSelect'
import PersonSelect from '@/views/safety/components/PersonSelect'

const fields = ['workContent', 'workType', 'workName', 'chargerId', 'dutyUnitId', 'time', 'remark', 'recordTidyPerson',
'examineContent', 'examineType', 'examinePlanName'] // 字段

export default {
  name: 'PlanModal',
  components: {
    DepartmentSelect,
    AreaSelect,
    PersonSelect
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    model: {
      type: Object,
      default: () => null
    },
    workTypeOptions: {
      type: Object,
      default: () => null
    },
    inspectionTypeOptions: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    },
    mode: {
      type: String,
      default: undefined
    }
  },
  data () {
    return {
      form: this.$form.createForm(this),
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      dutyUnitOptions: [
        {
          dictKey: 1322081524858347521,
          dictValue: '安环部'
        }
      ],
      chargerOptions: [
        {
          dictKey: 1324295948541186049,
          dictValue: '李四'
        }
      ]
    }
  },
  created () {
    // 防止表单未注册
    fields.forEach(v => this.form.getFieldDecorator(v))
    // 当 model 发生改变时，为表单设置值
    this.$watch('model', () => {
      if (Object.keys(this.model).length > 0) {
        if ('workType' in this.model) {
          this.model.workType = typeof this.model.workType === 'string' ? this.model.workType : this.model.workType.toString()
        }
        if ('examineType' in this.model) {
          this.model.examineType = typeof this.model.examineType === 'string' ? this.model.examineType : this.model.examineType.toString()
        }
      }
      this.model && this.form.setFieldsValue(pick(this.model, fields))
    })
  }
}
</script>
