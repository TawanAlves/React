<template>
  <!-- 安全教育线上考试管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline" :label-col="{ span: 7 }" :wrapper-col="{ span: 15 }">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="考试名称">
                <a-input v-model="queryParam.examName" placeholder="考试名称" :max-length="32"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="考试类型">
                <a-select
                  v-model="queryParam.examType"
                  placeholder="考试类型">
                  <a-select-option v-for="val in examTypeOptions" :key="val.id">
                    {{ val.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="考试时间">
                <a-range-picker
                  valueFormat="YYYY-MM-DD HH:mm:ss"
                  format="YYYY-MM-DD HH:mm"
                  :showTime="{format: 'HH:mm'}"
                  style="width: 100%; min-width: 110px;"
                  v-model="queryParam.time"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button type="primary" icon="plus" @click="addRecord" v-if="permission.online_exam_add">
            新建
          </a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :showIndexColumn="true"
        :scroll="{y: 'calc(100vh - 432px)', x: 1360}"
      >
        <span slot="examType" slot-scope="text, record">
          {{ examTypeOptions.find(item => item.id === record.examType).dictValue }}
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="publishRecord(record, 0)" v-if="record.status !== 0 && userInfo.id === record.gmtCreateId">发布</a>
            <a @click="publishRecord(record, 1)" v-if="record.status === 0 && userInfo.id === record.gmtCreateId">撤回</a>
            <a-divider type="vertical" v-if="record.status === 0  && userInfo.id === record.gmtCreateId"/>
            <a @click="checkRecord(record)" v-if="record.status === 0">查看</a>
            <a-divider type="vertical" v-if="record.status !== 0  && userInfo.id === record.gmtCreateId"/>
            <a @click="editRecord(record)" v-if=" record.status !== 0  && userInfo.id === record.gmtCreateId ">编辑</a>
            <a-divider type="vertical" v-if="record.status !== 0  && userInfo.id === record.gmtCreateId"/>
            <a @click="removeRecord(record, 2)" v-if=" record.status !== 0  && userInfo.id === record.gmtCreateId">删除</a>
          </template>
        </span>
      </s-table>
    </a-card>
    <online-exam-modal
      :visible.sync="commonVisible"
      :disabled="commonDisabled"
      :model="commonData"
      :loading="confirmLoading"
      :examTypeOptions="examTypeOptions"
      :modal-title="commonTitle"
      @ok="modalOk"
    />
  </page-container>
</template>
<script>
  import { STable } from '@/components'
  import { OnlineExamColumns } from './columns'
  import { mapGetters } from 'vuex'
  import OnlineExamModal from './component/OnlineExamModal'
  import URLS from '@/api/exam-url'
  import { getMinutesByDateRange } from '@/utils/util'

  export default {
    components: {
      STable,
      OnlineExamModal
    },
    data () {
      return {
        confirmLoading: false,
        commonTitle: '',
        commonVisible: false,
        commonData: {},
        commonDisabled: false,
        examTypeOptions: [],
        queryParam: {
          isOnline: 0,
          examStartTime: '',
          examEndTime: ''
        },
        selectedRowKeys: [],
        selectedRows: [],
        loadData: parameter => {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          const params = { ...this.queryParam }
          if (params.time && params.time.length > 0) {
            params.examStartTime = params.time[0]
            params.examEndTime = params.time[1]
            delete params.time
          }
          return this.submitForm(URLS.examList, params, 'post', { params: requestParameters }).then(res => {
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          })
        }
      }
    },
    computed: {
      ...mapGetters(['permission', 'userInfo']),
      columns: () => OnlineExamColumns
    },
    methods: {
      initFormData () {
        this.commonData = {
          userList: [],
          gmtCreateId: this.userInfo.id,
          createName: this.userInfo.realName,
          deptId: this.userInfo.deptId,
          deptName: this.userInfo.deptName
        }
      },
      commonInit () {
        this.commonVisible = false
        this.commonDisabled = false
        this.commonTitle = ''
        this.confirmLoading = false
        this.initFormData()
      },
      searchReset () {
        this.queryParam = {
          examStartTime: '',
          examEndTime: '',
          isOnline: 0
        }
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      addRecord () {
        this.commonTitle = '新增数据'
        this.initFormData()
        this.commonVisible = true
        this.commonDisabled = false
      },
      checkRecord (record) {
        this.commonTitle = '查看数据'
        this.loadRecordData((record.id), () => {
            this.commonVisible = true
            this.commonDisabled = true
        })
      },
      editRecord (record) {
        this.commonTitle = '编辑数据'
        this.loadRecordData((record.id), () => {
          this.commonVisible = true
          this.commonDisabled = false
        })
      },
      loadRecordData (id, callback) {
        this.getById(URLS.examDetail, id).then(({ data, success }) => {
          if (success) {
            this.commonData = data
            this.commonData.examDuration = getMinutesByDateRange(data.examStartTime, data.examEndTime)
            callback && callback()
          }
        })
      },
      removeRecord (record, status) {
        this.showDeleteConfirm(record, status)
      },
      modalCancel () {
        this.commonInit()
      },
      modalOk ({ formData }) {
        let url = ''
        if (this.isNotNullOrUndefined(this.commonData.id)) {
          formData.id = this.commonData.id
          formData.status = this.commonData.status
          url = URLS.examUpdate
        } else {
          formData.status = 1
          url = URLS.examAdd
        }
        const params = {
          ...formData,
          isOnline: 0
        }
        this.submitForm(url, params, 'post', {
          // headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
          this.commonInit()
        })
      },
      publishRecord (record, status) {
        const url = `${URLS.examStatus}?id=${record.id}&status=${status}`
        this.getList(url).then(({ success, msg }) => {
          if (success) {
            this.$message.success(`操作成功`)
            this.$refs.table.refresh()
            this.$refs.table.clearSelected()
          } else {
            this.$message.error(`${msg}`)
          }
        })
      },
      showDeleteConfirm (record, status) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            _this.publishRecord(record, status)
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      },
      initSelect () {
        this.examTypeOptions = [
          {
            id: 1,
            dictValue: '正式考试'
          },
          {
            id: 2,
            dictValue: '模拟考试'
          }
        ]
      }
    },
    created () {
      this.initSelect()
    }
  }
</script>
<style lang="less" scoped>
  /deep/ .ant-table {
    height: auto;
  }

  /deep/ .table-card .ant-card-body {
    padding-top: 0;
    padding-bottom: 15px;
  }

  .card-title {
    display: flex;
    justify-content: space-between;
  }

</style>
