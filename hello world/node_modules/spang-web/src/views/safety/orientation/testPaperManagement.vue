<template>
  <!-- 安全教育试卷管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px"  :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col  :md="8" :sm="24" :xs="24">
              <a-form-item label="试卷名称">
                <a-input v-model="queryParam.paperName" placeholder="试卷名称" :maxlength="32" />
              </a-form-item>
            </a-col>

            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="状态">
                <a-select v-model="queryParam.status" placeholder="状态" style="width: 100%">
                  <a-select-option
                    v-for="d in testPapertypeOptions"
                    :key="d.dictKey"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <!-- table -->

    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <!-- <div>会议列表</div> -->
          <a-button
            type="primary"
            icon="plus"
            @click="addRecord"
            style="float: right"
            v-if="permission.testPaperManagement_add"
          >新建</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        showPagination="true"
        :alert="false"
        :scroll="{ y: `calc(100vh - 432px)`, x: 900 }"
        :showIndexColumn="true"
      >
        <!-- status  0已启用 1未启用 2删除 3停用 -->
        <template slot="action" slot-scope="text, record">
          <a @click="checkRecord(record)">查看</a>

          <a-divider
            type="vertical"
            v-if="record.status == 1 && permission.testPaperManagement_edit"
          />
          <a
            @click="editRecord(record)"
            v-if="record.status == 1 && permission.testPaperManagement_edit"
          >编辑</a>

          <a-divider
            type="vertical"
            v-if="(record.status == 1 || record.status == 3) && permission.testPaperManagement_publish"
          />
          <a
            @click="publishRecord(record, 0)"
            v-if="(record.status == 1 || record.status == 3) && permission.testPaperManagement_publish"
          >启用</a>

          <a-divider
            type="vertical"
            v-if="(record.status == 1 || record.status == 3) && permission.testPaperManagement_delete"
          />
          <a
            @click="removeRecord(record)"
            v-if="(record.status == 1 || record.status == 3) && permission.testPaperManagement_delete"
          >删除</a>

          <a-divider
            type="vertical"
            v-if="record.status == 0 && permission.testPaperManagement_stopusing"
          />
          <a
            @click="publishRecord(record, 3)"
            v-if="record.status == 0 && permission.testPaperManagement_stopusing"
          >停用</a>
        </template>
        <!-- 状态  0已启用 1未启用 2删除 3停用 -->
        <template slot="status" slot-scope="text, record">
          <a-tag
            :color="record.status | colorFilter"
            style="margin-right: 0 !important"
          >{{ getStatusDesc(record.status) }}</a-tag>
        </template>
      </s-table>
      <!-- 新增数据 -->
      <testPaperDetail
        :visible.sync="detailVisible"
        :modal-title="commonTitle"
        :defaultForm="defaultForm"
        :isEdit="isEdit"
        @ok="testPaperok"
        @cancel="testPapercancel"
      ></testPaperDetail>
      <!-- 试卷预览 -->
      <testpaperPreview
        :visible.sync="previewVisible"
        :modal-title="previewTitle"
        :questionAnsVisit="questionAnsVisit"
        @ok="testpreviewPaperok"
        @cancel="testpreviewPapercancel"
      ></testpaperPreview>
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { CourseWareColumns } from './testPaper/testPaperBankTable'

import testPaperDetail from '@/views/safety/orientation/testPaper/testPaperDetail'
import testpaperPreview from '@/views/safety/orientation/testPaper/testpaperPreview'

import testPaperApi from '@/api/testPaper'
import { mapGetters } from 'vuex'

// status  0已启用 1未启用 2删除 3停用
const testPapertypeOptions = [
  {
    dictValue: '已启用',
    dictKey: '0'
  },
  {
    dictValue: '未启用',
    dictKey: '1'
  },
  {
    dictValue: '停用',
    dictKey: '3'
  }
]
export default {
  components: { STable, testPaperDetail, testpaperPreview },
  data() {
    return {
      testPapertypeOptions: testPapertypeOptions,
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
        paperName: '',
        status: undefined
      },
      loadData: parameter => {
        let requesturl = testPaperApi.querytestPaperList
        let method = 'post'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize },
          data: JSON.stringify(this.queryParam)
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;'
          }
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      detailVisible: false,
      detailDatas: [],
      isEdit: false,
      defaultForm: {},
      editInfoDetail: {},
      questionAnsVisit: [],

      previewVisible: false
    }
  },
  created() {},
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => CourseWareColumns
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['green', 'orange', '', 'red']
      return colorList[value]
    }
  },
  methods: {
    getStatusDesc(key) {
      return this.getkeyDesc(key, this.testPapertypeOptions)
    },
    getkeyDesc(key, keyOptions) {
      let array = keyOptions
      let desc = ''
      for (let index = 0; index < array.length; index++) {
        const element = array[index]
        if (key.toString() == element.dictKey) {
          desc = element.dictValue
        }
      }
      return desc
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.queryParam = {
        paperName: '',
        status: undefined
      }
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    addRecord() {
      this.isEdit = false
      this.commonTitle = '新增数据'
      this.detailVisible = true
    },
    testPaperok(formData) {
      this.detailVisible = false
      if (this.isEdit) {
        this.updateRecordInfo(formData)
      } else {
        this.addRecordInfo(formData)
      }
    },
    // 新增数据
    addRecordInfo(formData) {
      let params = formData

      let requesturl = testPaperApi.addtestPaper
      let method = 'post'
      let requestparams = {
        params: {},
        data: params
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
      })
    },
    updateRecordInfo(formData) {
      let params = formData

      let requesturl = testPaperApi.updatetestPaper
      let method = 'post'
      let requestparams = {
        params: {},
        data: params
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
      })
    },
    testPapercancel() {
      this.detailVisible = false
    },
    publishRecord(record, status) {
      this.setStatusInfo(record, status)
    },
    checkRecord(record) {
      this.previewTitle = '预览试卷'
      let requesturl = testPaperApi.previewtestPaperDetail
      let method = 'get'
      let requestparams = {
        params: { id: record.id },
        data: {}
      }
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        let data = res.data
        this.questionAnsVisit = JSON.parse(JSON.stringify(data))
        this.previewVisible = true
      })
    },
    testpreviewPaperok() {
      this.previewVisible = false
    },
    testpreviewPapercancel() {
      this.previewVisible = false
    },
    editRecord(record) {
      this.isEdit = true
      this.commonTitle = '编辑数据'

      let requesturl = testPaperApi.querytestPaperDetail
      let method = 'get'
      let requestparams = {
        params: { id: record.id },
        data: {}
      }
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        let data = res.data
        this.editInfoDetail = JSON.parse(JSON.stringify(data))
        this.defaultForm = JSON.parse(JSON.stringify(data))
        this.detailVisible = true
      })
    },
    removeRecord(record, status) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.setStatusInfo(record, 2)
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    },
    setStatusInfo(record, status) {
      let { id } = record
      let params = {}

      let requesturl = testPaperApi.updatetestPaperStatus
      let method = 'post'
      let requestparams = {
        params: { id: id, status: status },
        data: params
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
      })
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
  margin: 0 !important;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
/deep/.ant-table-body-inner {
  overflow: unset;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>
