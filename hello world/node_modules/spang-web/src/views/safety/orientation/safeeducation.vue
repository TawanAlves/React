<template>
  <!-- 三级安全教育 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px"  :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="姓名">
                <a-input v-model="queryParam.userName" placeholder="姓名" :maxLength="32" />
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="教育类型">
                <a-select v-model="queryParam.eduTypeId" placeholder="教育类型">
                  <a-select-option
                    v-for="d in educateTypeOptions"
                    :key="d.dictKey"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="educateResearch">查询</a-button>
                <a-button type="second" @click="educateRefresh">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button
            type="primary"
            icon="plus"
            @click="educateAdd"
            style="float: right"
            v-if="permission.safetyeducation_add"
          >新建</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: `calc(100vh - 435px)`, x: 1350 }"
        :showIndexColumn="true"
      >
        <span slot="action" slot-scope="text, record">
          <template v-if="record.status === 1 && userInfo.id === record.gmtCreateId">
            <a @click="publishRecord(record, 0)">发布</a>
            <a-divider type="vertical" />
            <a @click="educateEdit(record)">编辑</a>
            <a-divider type="vertical" />
            <a @click="educateCheck(record)">查看</a>
            <a-divider type="vertical" />
            <a @click="educateRemove(record)">删除</a>
          </template>
          <template v-if="record.status === 0">
            <a @click="educateCheck(record)">查看</a>
            <a-divider type="vertical" v-if="userInfo.id === record.gmtCreateId" />
            <a @click="publishRecord(record, 1)" v-if="userInfo.id === record.gmtCreateId">撤回</a>
          </template>
        </span>
        <template slot="examResult" slot-scope="text, record">
          <div v-if="record.examResult == 0">未通过</div>
          <div v-else-if="record.examResult == 1">通过</div>
          <div v-else></div>
        </template>
        <!-- 状态  状态(0正常1冻结2删除)     0就是已发布  1就是未发布  2是删除 -->
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">
            {{
            record.status | textFilter
            }}
          </a-tag>
        </template>
      </s-table>
    </a-card>
    <threeSafeEduModal
      ref="educateModal"
      :modal-title="commonTitle"
      :visible="commonVisible"
      :disabled="commonDisabled"
      :defaultForm="defaultForm"
      :educate-type-options="educateTypeOptions"
      @cancel="educateCancel"
      @ok="educateOk"
    />
    <threeSafeEduDetails
      mode="safetyeducation"
      :visible="detailVisible"
      :info="detailInfo"
      @cancel="
        () => {
          this.detailVisible = false
        }
      "
    />
  </page-container>
</template>
<script>
import { STable } from '@/components'
import SafeEduApi from '@/api/threelevsafedu'
import { educationColumns } from './threeSafeEdu/table'
import threeSafeEduDetails from './threeSafeEdu/threeSafeEduDetails.vue'
import threeSafeEduModal from './threeSafeEdu/threeSafeEduModal.vue'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'

export default {
  components: {
    STable,
    threeSafeEduModal,
    threeSafeEduDetails
  },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        let requesturl = SafeEduApi.threeLevSafeEduList
        let method = 'post'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize },
          data: JSON.stringify(this.queryParam)
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;'
          }
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },

      queryParam: { userName: '', eduTypeId: undefined },
      // select options
      educateTypeOptions: [],
      // modal
      commonDisabled: false,
      commonTitle: '',
      commonVisible: false,
      // detail modal
      detailVisible: false,
      detailInfo: {},
      // 默认表单数据
      defaultForm: {},

      isEdit: false,
      editInfoDetail: {},
      userInfo: getStore({ name: 'info' })
    }
  },
  created() {
    this.selectOptionsInit()
  },
  mounted() {},
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => educationColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['green', 'orange']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['已发布', '未发布']
      return textList[value]
    }
  },
  methods: {
    selectOptionsInit() {
      //教育类型
      this.getDict('edu_type').then(({ data, success }) => {
        if (success) {
          this.educateTypeOptions = data
        }
      })
    },
    educateModalInit() {
      this.commonVisible = false
      this.commonTitle = ''
      this.commonDisabled = false
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    educateResearch() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    educateRefresh() {
      this.queryParam = { userName: '', eduTypeId: undefined }
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    educateAdd() {
      this.isEdit = false
      this.commonTitle = '新增数据'
      this.commonVisible = true
    },
    educateRemove(record) {
      this.removeConfirm(record)
    },
    removeConfirm(record) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将删除选中数据，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk() {
          _this.setStatusInfo(record, 2)
        }
      })
    },
    educateCheck(record) {
      this.getById(SafeEduApi.threeLevSafeEduByid, record.id).then(({ data, success }) => {
        if (success) {
          this.defaultForm = data
          this.commonTitle = '编辑数据'
          this.commonVisible = true
          this.commonDisabled = true
        }
      })
    },
    educateEdit(record) {
      this.isEdit = true
      this.commonTitle = '编辑数据'
      let url = SafeEduApi.threeLevSafeEduByid + '?id=' + record.id
      let requestParameters = {}
      this.submitForm(url, requestParameters, 'get').then(res => {
        let data = JSON.parse(JSON.stringify(res.data))
        this.editInfoDetail = data
        this.defaultForm = data
        this.commonVisible = true
      })
    },
    educateCancel() {
      this.educateModalInit()
    },
    educateOk(formData) {
      if (this.isEdit) {
        // 编辑数据
        this.editRecordInfo(formData)
      } else {
        // 新增数据
        this.addRecordInfo(formData)
      }
    },
    addRecordInfo(formData) {
      let requesturl = SafeEduApi.threeLevSafeEduAdd
      let method = 'post'
      let requestparams = {
        params: {},
        data: JSON.stringify(formData)
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
        this.commonVisible = false
      })
    },
    editRecordInfo(formData) {
      let requesturl = SafeEduApi.updateInfoSafeEduByid
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
        this.commonVisible = false
      })
    },
    publishRecord(record, status) {
      this.setStatusInfo(record, status)
    },
    setStatusInfo(record, status) {
      let { id } = record

      let requesturl = SafeEduApi.updatethreeLevSafeEduByid
      let method = 'get'
      let requestparams = {
        params: { id: id, status: status }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
      })
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
///deep/ .ant-table-body {
//  overflow-y: auto !important;
//}
</style>
