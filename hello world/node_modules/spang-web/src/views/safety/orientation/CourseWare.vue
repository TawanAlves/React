<template>
  <!-- 安全教育课件管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="课件名称">
                <a-input v-model="queryParam.coursewareName" placeholder="课件名称" :maxLength="32" />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="课件类型">
                <a-select
                  v-model="queryParam.coursewareTypeId"
                  :disabled="disabled"
                  placeholder="课件类型"
                >
                  <a-select-option
                    v-for="d in coursewareTypeOptions"
                    :key="d.dictKey"
                    style="width: 100%"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="公布范围">
                <a-select
                  show-search
                  v-model="queryParam.publishRange"
                  placeholder="公布范围"
                  style="width: 100%"
                >
                  <a-select-option
                    v-for="d in publishRangeOptions"
                    :key="d.dictKey"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col  :lg="6" :md="24" :sm="12" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <!-- <div>会议列表</div> -->
          <a-button
            type="primary"
            icon="plus"
            @click="addRecord"
            style="float: right"
            v-if="permission.courseware_add"
          >新建</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: `calc(100vh - 435px)`, x: 1090 }"
        :showIndexColumn="true"
      >
        <!-- 状态  状态(0正常1冻结2删除)     0就是已发布  1就是未发布  2是删除 -->
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">
            {{
            record.status | textFilter
            }}
          </a-tag>
        </template>
        <!-- 发布范围  发布范围(0私密1公开)-->
        <template slot="publishRange" slot-scope="text, record">
          <div>{{ getpublishRangeDesc(record.publishRange) }}</div>
        </template>

        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="checkRecord(record)">查看</a>
            <a-divider type="vertical" v-if="record.status === 1 && permission.courseware_publish" />
            <a
              @click="publishRecord(record, 0)"
              v-if="record.status == 1 && permission.courseware_publish"
            >发布</a>
            <a-divider type="vertical" v-if="permission.courseware_publish" />
            <a @click="removeRecord(record)" v-if="permission.courseware_publish">删除</a>

            <!-- <a-divider type="vertical" v-if="record.status === 0 && permission.courseware_recall" />
            <a @click="publishRecord(record, 1)" v-if="record.status === 0 && permission.courseware_recall">撤回</a>-->

            <!-- <a-divider type="vertical" v-if="record.status == 1 && permission.courseware_edit" />
            <a @click="editRecord(record)" v-if="record.status == 1 && permission.courseware_edit">编辑</a>-->
          </template>
        </span>
      </s-table>
      <courseWareModal
        ref="educateModal"
        :modal-title="commonTitle"
        :visible="commonVisible"
        :disabled="commonDisabled"
        :defaultForm="commonData"
        :publishRangeOptions="publishRangeOptions"
        :coursewareTypeOptions="coursewareTypeOptions"
        @cancel="educateCancel"
        @ok="modalOk"
      ></courseWareModal>
      <descriptions-modal :visible.sync="detailVisible" :records="detailDatas" title="查看课件" />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { CourseWareColumns } from './courseWareMgr/table'
import { mapGetters } from 'vuex'
import DescriptionsModal from '@/views/safety/components/DescriptionsModal'
import courseWareModal from './courseWareMgr/courseWareModal.vue'
import CoursewareEduApi from '@/api/courseWareMgr'

export default {
  components: {
    STable,
    DescriptionsModal,
    courseWareModal
  },
  data() {
    return {
      coursewareTypeOptions: [
        // { dictKey: '0', dictValue: '培训手册' },
        // { dictKey: '1', dictValue: '操作手册' },
        // { dictKey: '2', dictValue: '其他' },
      ],
      publishRangeOptions: [
        { dictKey: 0, dictValue: '公开' },
        { dictKey: 1, dictValue: '私密' }
      ],
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
        coursewareName: '', // 课件名称
        coursewareTypeId: undefined, // 课件类型
        publishRange: undefined // 公开范围
      },
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        let requesturl = CoursewareEduApi.queryCoursewareList
        let method = 'post'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize },
          data: JSON.stringify(this.queryParam)
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;'
          }
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      // detail modal
      detailVisible: false,
      detailDatas: [],
      isEdit: false,
      editInfoDetail: {}
    }
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => CourseWareColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['green', 'orange']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['已发布', '未发布']
      return textList[value]
    }
  },
  methods: {
    commonInit() {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.isEdit = false
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },

    initQueryParam() {
      this.queryParam = {
        coursewareName: '', // 课件名称
        coursewareType: undefined, // 课件类型
        publishRange: undefined // 公开范围
      }
    },
    addRecord() {
      this.isEdit = false
      this.commonTitle = '新增数据'
      this.commonVisible = true
    },
    removeRecords() {
      const ids = this.selectedRows.map(item => item.id)
      this.showDeleteConfirm(ids)
    },
    checkRecord(record) {
      this.commonInit()
      this.getById(CoursewareEduApi.queryCoursewareDeiail, record.id).then(({ data, success }) => {
        if (success) {
          this.commonData = data
          this.commonTitle = '查看数据'
          this.commonDisabled = true
          this.commonVisible = true
        }
      })
      /*let requesturl = CoursewareEduApi.queryCoursewareDeiail
      let method = 'get'
      let requestparams = {
        params: { id: record.id },
        data: {},
      }
      this.submitFormPost(requesturl, requestparams, method).then((res) => {
        let data = res.data
        this.detailDatas = [
          {
            label: '课件名称',
            value: data.coursewareName,
          },
          {
            label: '课件类型',
            value: data.coursewareTypeName,
          },
          {
            label: '课程描述',
            value: data.coursewareDesc,
          },
          {
            label: '发布范围',
            value: this.getpublishRangeDesc(data.publishRange),
          },
          {
            label: '附件',
            value: [
              {
                originalFileName: data.fileName,
                id: data.fileId,
              },
            ],
            type: 'file',
          },
        ]
        this.detailVisible = true
      })*/
    },
    getpublishRangeDesc(publishRange) {
      let desc = ''
      this.publishRangeOptions.forEach(element => {
        if (element.dictKey == publishRange) {
          desc = element.dictValue
        }
      })
      return desc
    },

    editRecord(record) {
      let requesturl = CoursewareEduApi.queryCoursewareDeiail
      let method = 'get'
      let requestparams = {
        params: { id: record.id },
        data: {}
      }
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        let data = res.data
        this.editInfoDetail = JSON.parse(JSON.stringify(data))
        this.defaultForm = JSON.parse(JSON.stringify(data))
        this.isEdit = true
        this.commonTitle = '编辑数据'
        this.commonVisible = true
      })
    },
    // 删除数据
    removeRecord(record) {
      this.showDeleteConfirm(record)
    },
    educateCancel() {
      this.commonInit()
    },
    modalCancel() {
      this.commonInit()
    },
    modalOk(formData) {
      // 新增课件
      if (this.isEdit) {
        this.editRecordInfo(formData)
      } else {
        this.addRecordInfo(formData)
      }
    },
    editRecordInfo(formData) {
      let requesturl = CoursewareEduApi.updateCoursewareDeiail
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
        _this.commonInit()
      })
    },
    addRecordInfo(formData) {
      let {
        coursewareName,
        coursewareTypeId,
        coursewareTypeName,
        coursewareDesc,
        publishRange,
        fileId,
        fileName,
        filePath
      } = formData
      let params = {
        coursewareName: coursewareName, // 课件名称
        coursewareTypeId: coursewareTypeId,
        coursewareTypeName: coursewareTypeName,
        coursewareDesc: coursewareDesc,
        publishRange: publishRange,
        fileId: fileId,
        fileName: fileName,
        filePath: filePath
      }

      let requesturl = CoursewareEduApi.addCourseware
      let method = 'post'
      let requestparams = {
        params: {},
        data: params
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
        _this.commonInit()
      })
    },
    publishRecord(record, status) {
      this.setStatusInfo(record, status)
    },
    showDeleteConfirm(params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.setStatusInfo(params, 2)
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    },
    setStatusInfo(deleteparams, status) {
      let { id } = deleteparams
      let params = {}

      let requesturl = CoursewareEduApi.updateCoursewareStatus
      let method = 'get'
      let requestparams = {
        params: { id: id, status: status },
        data: params
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh()
        _this.$refs.table.clearSelected()
        _this.commonInit()
      })
    },
    selectOptionsInit() {
      // 课件类型
      this.getDict('courseware_type').then(({ data, success }) => {
        if (success) {
          this.coursewareTypeOptions = data
        }
      })
    }
  },
  created() {
    this.selectOptionsInit()
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
  margin: 0 !important;
}
/deep/.ant-table-body-inner {
  overflow: unset;
}
</style>
