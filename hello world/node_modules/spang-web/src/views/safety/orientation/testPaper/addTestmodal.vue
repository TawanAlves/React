<template>
  <a-modal
    :title="title"
    :width="900"
    :visible="visible"
    :confirmLoading="loading"
    @ok="confirmSubmit"
    @cancel="confirmSubmitcancel"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="6">
              <a-form-item label="问题">
                <a-input v-model="queryParam.questionContent" placeholder="问题" />
              </a-form-item>
            </a-col>
            <a-col :md="6">
              <a-form-item label="类型">
                <a-select
                  show-search
                  v-model="queryParam.questionCategoryId"
                  placeholder="请选择类型"
                  style="width: 100%"
                  @change="questionCategoryChange"
                >
                  <a-select-option v-for="d in typeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="6">
              <a-form-item label="题型">
                <a-select show-search v-model="queryParam.questionType" placeholder="请选择题型" style="width: 100%">
                  <a-select-option v-for="d in questiontypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset" style="margin-left: 10px">重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{ y: 350 }"
        :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
        :pagination="true"
        style="margin-top: 10px"
        :showIndexColumn="true"
      >
        <span slot="questionType" slot-scope="text, record">
          <template>
            <div>{{ slectRecord(record.questionType) }}</div>
          </template>
        </span>
      </s-table>
    </a-spin>
  </a-modal>
</template>

<script>
import { addTestpaperColumns } from './addTestTable'
import { STable } from '@/components'

import SafeduQuestionBankApi from '@/api/safeduQuestionBank'

export default {
  name: 'PaperSelectModal',
  components: {
    STable,
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    model: {
      type: Object,
      default: () => null,
    },

    title: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    isEdit: {
      type: Boolean,
      required: false,
    },
    defaultpaperlist: {
      type: Object,
      default: () => null,
    },
  },
  data() {
    return {
      typeOptions: [],
      // 题型 0单选1多选2判断3填空
      questiontypeOptions: [
        { dictKey: '0', dictValue: '单选' },
        { dictKey: '1', dictValue: '多选' },
        { dictKey: '2', dictValue: '判断' },
        // { dictKey: '3', dictValue: '填空' },
      ],
      rowSelectMode: 'checkbox',
      selectedRowKeys: [],
      selectedRows: [],
      currentselectedRows: [],
      // 档期按
      queryParam: {
        questionCategoryId: undefined,
        questionCategoryName: undefined,
        questionContent: '',
        questionType: undefined,
      },
      loadData: (parameter) => {
        let requesturl = SafeduQuestionBankApi.querySafeduQuestionList
        let method = 'post'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize },
          data: JSON.stringify(this.queryParam),
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;',
          },
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
    }
  },
  computed: {
    columns: () => addTestpaperColumns,
  },
  created() {
    this.selectOptionsInit()
  },
  watch: {
    visible: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setDefaultSelectedList(this.defaultpaperlist)
      },
    },
    defaultpaperlist: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setDefaultSelectedList(newV)
      },
    },
  },

  methods: {
    setDefaultSelectedList(defaultSelectedList) {
      let currentKeys = []
      let currentRows = []
      defaultSelectedList.forEach((element) => {
        let { id } = element
        currentKeys.push(id)
        currentRows.push(element)
      })

      this.selectedRowKeys = JSON.parse(JSON.stringify(currentKeys))
      this.selectedRows = JSON.parse(JSON.stringify(currentRows))
    },
    selectOptionsInit() {
      // 获取题库类型
      let requesturl = SafeduQuestionBankApi.getquestionTypelist
      let method = 'get'
      let requestparams = {
        params: {},
        data: {},
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;',
        },
      }
      this.submitFormPost(requesturl, requestparams, method, config).then((res) => {
        let data = res.data
        let list = []
        data.forEach((element) => {
          let { id, repoName } = element
          list.push({
            dictKey: id,
            dictValue: repoName,
          })
        })
        this.typeOptions = list
      })
    },
    questionCategoryChange(key) {
      this.queryParam.questionCategoryId = key
      this.queryParam.questionCategoryName = this.getkeyDesc(key, this.typeOptions)
    },
    getkeyDesc(key, keyOptions) {
      let array = keyOptions
      let desc = ''
      for (let index = 0; index < array.length; index++) {
        const element = array[index]
        if (key.toString() == element.dictKey) {
          desc = element.dictValue
        }
      }
      return desc
    },
    slectRecord(key) {
      return this.getkeyDesc(key, this.questiontypeOptions)
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      let outsideArr = JSON.parse(JSON.stringify(this.selectedRows))
      let insideArr = JSON.parse(JSON.stringify(selectedRows))
      let newArr = outsideArr.concat(insideArr)

      this.selectedRows = this.arraydeduplication(JSON.parse(JSON.stringify(newArr)), 'id')
    },
    // 数组去重
    arraydeduplication(arr, key) {
      var result = []
      var obj = {}
      for (var i = 0; i < arr.length; i++) {
        if (!obj[arr[i][key]]) {
          result.push(arr[i])
          obj[arr[i][key]] = true
        }
      }
      return result
    },

    confirmSubmitcancel() {
      this.searchReset()
      this.$emit('update:visible', false)
    },
    confirmSubmit() {
      if (this.selectedRowKeys.length === 0) {
        this.$message.error('请先选择一道试题')
      } else {
        // 题型 0单选1多选2判断3填空
        // 支持添加试题，添加试题后按试题分类排序（排序顺序为单选、多选、判断）
        let list = JSON.parse(JSON.stringify(this.selectedRows))
        let singleChoice = []
        let multipleChoice = []
        let judgeQuestion = []
        list.forEach((element) => {
          let { questionType } = element
          switch (questionType) {
            case 0:
              singleChoice.push(element)
              break
            case 1:
              multipleChoice.push(element)
              break
            case 2:
              judgeQuestion.push(element)
              break
            default:
              break
          }
        })
        this.searchReset()
        this.$emit('ok', [...singleChoice, ...multipleChoice, ...judgeQuestion])
        this.$emit('update:visible', false)
      }
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.queryParam = {
        questionCategoryId: undefined,
        questionCategoryName: undefined,
        questionContent: '',
        questionType: undefined,
      }
      this.selectedRowKeys = []
      this.selectedRows = []
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
  },
}
</script>

<style scoped>
</style>
