<template>
  <div>
    <a-modal
      :title="modalTitle"
      :width="900"
      :visible="visible"
      :confirmLoading="loading"
      @ok="modalOk()"
      @cancel="modalCancel()"
      ok-text="确定"
      cancel-text="取消"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-spin :spinning="loading">
        <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
          <a-form-model-item label="试卷名称" prop="paperName">
            <a-input v-model="form.paperName" :maxLength="32" placeholder="请输入试卷名称" />
          </a-form-model-item>

          <a-form-model-item label="注意事项" prop="remark">
            <a-input v-model="form.remark" type="textarea" :maxLength="256" placeholder="请输入注意事项" />
          </a-form-model-item>
          <!-- 试题分值设置 -->
          <div class="testPaper-model">
            <div class="testPaper-model-top">
              <div class="testPaper-model-title">试题分值设置</div>
            </div>
            <testScoreSetting
              ref="testScoreSetting"
              :defaultSetForm="defaultSetForm"
              :isEdit="isEdit"
            ></testScoreSetting>
          </div>

          <div class="testPaper-model">
            <div class="testPaper-model-top">
              <div class="testPaper-model-title">试题</div>
              <div>
                <a-button type="primary" @click="addTestQuestions" style="margin-left: 10px">添加</a-button>
                <a-button type="second" @click="deleteTestQuestions" style="margin-left: 10px">删除</a-button>
              </div>
            </div>
            <div class="testPaper-model-bottom">
              <a-table
                ref="table"
                size="default"
                :rowKey="(record) => record.id"
                :columns="columns"
                :dataSource="testPaperList"
                :alert="false"
                :scroll="{ y: 200 }"
                :pagination="false"
                :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
              >
                <span slot="questionType" slot-scope="text, record">
                  <template>
                    <div>{{ getquestionTypeDesc(record.questionType) }}</div>
                  </template>
                </span>
                <span slot="action" slot-scope="text, record, index">
                  <template>
                    <a @click="removeRecord(record)">删除</a>
                    <a-divider type="vertical" />
                    <a @click="clickUp(record, index)">上移</a>
                    <a-divider type="vertical" />
                    <a @click="clickDown(record, index)">下移</a>
                  </template>
                </span>
              </a-table>
            </div>
          </div>
        </a-form-model>
      </a-spin>
      <!-- addTestQuestions -->
    </a-modal>

    <addTestmodal
      :visible.sync="addTestmodalVis"
      @ok="choosePaper"
      title="选择试题"
      :isEdit="isEdit"
      :defaultpaperlist="testPaperList"
    ></addTestmodal>
  </div>
</template>

<script>
import { STable } from '@/components'
import testScoreSetting from './testScoreSetting'
import { CourseWareColumns } from './testPaperTable'
import addTestmodal from './addTestmodal'
import { forEach } from 'store/storages/all'
export default {
  name: 'LawModal',
  components: { STable, testScoreSetting, addTestmodal },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    modalTitle: {
      type: String,
      default: '操作',
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    isEdit: {
      type: Boolean,
      required: false,
    },
    defaultForm: {
      type: Object, // 默认表单数据
      default: () => null,
    },
  },
  computed: {
    columns: () => CourseWareColumns,
  },
  data() {
    return {
      addTestmodalVis: false,
      testPaperList: [],
      rowSelectMode: 'checkbox',
      selectedRowKeys: [],
      selectedRows: [],
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      form: {
        paperName: undefined,
        remark: '',
      },
      fileList: [],
      rules: {
        paperName: [{ required: true, message: '请输入试卷名称', trigger: 'blur' }],
      },
      defaultSetForm: {},
      // 题型 0单选1多选2判断3填空
      questiontypeOptions: [
        { dictKey: '0', dictValue: '单选' },
        { dictKey: '1', dictValue: '多选' },
        { dictKey: '2', dictValue: '判断' },
        // { dictKey: '3', dictValue: '填空' },
      ],
    }
  },
  created() {},

  watch: {
    defaultForm: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  mounted() {},
  methods: {
    getkeyDesc(key, keyOptions) {
      let array = keyOptions
      let desc = ''
      for (let index = 0; index < array.length; index++) {
        const element = array[index]
        if (key.toString() == element.dictKey) {
          desc = element.dictValue
        }
      }
      return desc
    },
    getquestionTypeDesc(questionType) {
      return this.getkeyDesc(questionType, this.questiontypeOptions)
    },

    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    addTestQuestions() {
      this.addTestmodalVis = true
    },
    deleteTestQuestions() {
      if (this.selectedRows.length > 0) {
        this.showDeleteConfirm(() => {
          const ids = this.selectedRows.map((item) => item.id)
          this.testPaperList = this.testPaperList.filter((item) => !ids.includes(item.id))
        })
      } else {
        this.$message.warning('请先选择一道试题！')
      }
    },
    showDeleteConfirm(okFun) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          okFun && okFun()
          _this.selectedRows = []
          _this.selectedRowKeys = []
          // _this.loadData()
        },
        onCancel() {
          console.log('Cancel')
        },
      })
    },
    setFormData(newFormData) {
      if (this.isEdit) {
        this.form = JSON.parse(JSON.stringify(newFormData))
        this.defaultSetForm = {
          singleChoiceScore: this.form.singleChoiceScore, // 单选题每题分值
          multipleChoiceScore: this.form.multipleChoiceScore, // 多选题每题分值
          judgeNumberScore: this.form.judgeNumberScore, // 判断题每题分值
          passScore: this.form.passScore, // 及格分值
        }
        this.testPaperList = this.form.paperQuestionList
      } else {
        this.resetForm()
      }
    },
    removeRecord(record) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.deleteRecord(record)
        },
        onCancel() {
          console.log('Cancel')
        },
      })
    },
    deleteRecord(record) {
      let oriList = JSON.parse(JSON.stringify(this.testPaperList))
      const dataSource = [...oriList]
      let id = record.id
      let dataSourceNew = dataSource.filter((item) => item.id !== id)
      this.testPaperList = JSON.parse(JSON.stringify(dataSourceNew))
    },
    //点击上移
    clickUp(record, index) {
      if (index === 0) {
        return
      }
      let oriList = JSON.parse(JSON.stringify(this.testPaperList))
      if (oriList[index - 1].questionType.toString() !== oriList[index].questionType.toString()) {
        return
      }
      let dataSourceNew = this.swapArray(oriList, index - 1, index)
      this.testPaperList = JSON.parse(JSON.stringify(dataSourceNew))
    },
    //点击下移
    clickDown(record, index) {
      if (index === this.testPaperList.length - 1) {
        return
      }
      let oriList = JSON.parse(JSON.stringify(this.testPaperList))
      if (oriList[index].questionType.toString() !== oriList[index + 1].questionType.toString()) {
        return
      }
      let dataSourceNew = this.swapArray(oriList, index, index + 1)
      this.testPaperList = JSON.parse(JSON.stringify(dataSourceNew))
    },
    //数组元素互换位置
    swapArray(arr, index1, index2) {
      arr[index1] = arr.splice(index2, 1, arr[index1])[0]
      return arr
    },
    submitForm() {
      let flag = false
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          flag = true
        } else {
          flag = false
        }
      })
      return flag
    },
    modalOk() {
      let validOk = false
      this.submitForm()
      this.$refs.testScoreSetting.submitForm()
      validOk = this.submitForm() && this.$refs.testScoreSetting.submitForm()
      let questionList = JSON.parse(JSON.stringify(this.testPaperList))
      let requestionList = []
      questionList.forEach((element, index) => {
        let { id, questionType } = element
        requestionList.push({
          questionId: id,
          questionOrder: index + 1,
          questionType: questionType,
        })
      })
      if (validOk) {
        let newForm = this.$refs.testScoreSetting.form
        let okform = {
          ...this.form,
          ...newForm,
          paperQuestionList: requestionList,
        }
        let formData = JSON.parse(JSON.stringify(okform))
        this.$emit('ok', formData)
        this.resetForm()
      } else {
        return false
      }
    },
    modalCancel() {
      this.resetForm()
      this.$emit('cancel')
    },
    resetForm() {
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
      this.form = { paperName: '', remark: '' }
      this.defaultSetForm = {
        singleChoiceScore: '', // 单选题每题分值
        multipleChoiceScore: '', // 多选题每题分值
        judgeNumberScore: '', // 判断题每题分值
        passScore: '', // 及格分值
      }
      this.testPaperList = []
      this.selectedRowKeys = []
      this.selectedRows = []
    },
    choosePaper(selectRows) {
      selectRows.forEach((element) => {
        element.questionId = element.id
      })
      this.testPaperList = JSON.parse(JSON.stringify(selectRows))
    },
  },
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.testPaper-model {
  .testPaper-model-top {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin: 10px 0;
  }
  .testPaper-model-title {
    font-weight: bolder;
  }
}
</style>
