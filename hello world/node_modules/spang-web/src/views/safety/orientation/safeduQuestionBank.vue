<template>
  <!-- 安全教育题库 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col  :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="问题">
                <a-input v-model="queryParam.questionContent" placeholder="问题" :maxLength="32" />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="类型">
                <a-select
                  v-model="queryParam.questionCategoryId"
                  placeholder="类型"
                  style="width: 100%"
                  @change="questionCategoryChange"
                >
                  <a-select-option v-for="d in typeOptions" :key="d.dictKey">{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="题型">
                <a-select v-model="queryParam.questionType" placeholder="题型" style="width: 100%">
                  <a-select-option
                    v-for="d in questiontypeOptions"
                    :key="d.dictKey"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <!-- table -->

    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right card-title">
          <a-button
            type="primary"
            icon="plus"
            @click="addRecord"
            style="margin-left: 10px"
            v-if="permission.safeduQuestionBank_add"
          >新建</a-button>
          <a-upload
            :showUploadList="false"
            :customRequest="customRequest"
            style="margin-left: 10px"
            v-if="permission.safeduQuestionBank_add"
          >
            <a-button type="primary">批量导入</a-button>
          </a-upload>
          <a-button
            type="second"
            @click="templateDownload"
            style="margin-left: 10px"
            v-if="permission.safeduQuestionBank_add"
          >模板下载</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{ y: `calc(100vh - 432px)`, x: 750 }"
        showPagination="true"
        :showIndexColumn="true"
      >
        <span slot="questionType" slot-scope="text, record">
          <template>
            <div>{{ getquestionTypeDesc(record.questionType) }}</div>
          </template>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="editRecord(record)" v-if="permission.safeduQuestionBank_edit">编辑</a>
            <a-divider type="vertical" />
            <a @click="removeRecord(record)" v-if="permission.safeduQuestionBank_delete">删除</a>
          </template>
        </span>
      </s-table>
      <!-- 新增数据 -->
      <QuesBankDetail
        :visible.sync="detailVisible"
        :modalTitle="modalTitle"
        :defaultForm="defaultForm"
        :isEdit="isEdit"
        :questiontypeOptions="questiontypeOptions"
        :typeOptions="typeOptions"
        @ok="quesBankok"
        @cancel="quesBankcancel"
      ></QuesBankDetail>
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { CourseWareColumns } from '@/views/safety/orientation/quesBankComponent/table'
import QuesBankDetail from '@/views/safety/orientation/quesBankComponent/QuesBankDetail'
import SafeduQuestionBankApi from '@/api/safeduQuestionBank'
import { mapGetters } from 'vuex'

export default {
  components: { STable, QuesBankDetail },
  data() {
    return {
      fileList: [],
      typeOptions: [],
      // 题型 0单选1多选2判断3填空
      questiontypeOptions: [
        { dictKey: '0', dictValue: '单选' },
        { dictKey: '1', dictValue: '多选' },
        { dictKey: '2', dictValue: '判断' }
        // { dictKey: '3', dictValue: '填空' },
      ],
      confirmLoading: false,
      modalTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
        questionCategoryId: undefined,
        questionCategoryName: undefined,
        questionContent: '',
        questionType: undefined
      },
      loadData: parameter => {
        let requesturl = SafeduQuestionBankApi.querySafeduQuestionList
        let method = 'post'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize },
          data: JSON.stringify(this.queryParam)
        }
        let config = {
          headers: {
            'Content-Type': 'application/json;'
          }
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      detailVisible: false,
      detailDatas: [],
      isEdit: false,
      editInfoDetail: {},
      uploadaction: this.BASE_URL + '/spang-edu/admin/question/info/upload'
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => CourseWareColumns
  },
  methods: {
    selectOptionsInit() {
      // 获取题库类型
      let requesturl = SafeduQuestionBankApi.getquestionTypelist
      let method = 'get'
      let requestparams = {
        params: {},
        data: {}
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        let data = res.data
        let list = []
        data.forEach(element => {
          let { id, repoName } = element
          list.push({
            dictKey: id,
            dictValue: repoName
          })
        })
        this.typeOptions = list
      })
    },
    questionCategoryChange(key) {
      this.queryParam.questionCategoryId = key
      this.queryParam.questionCategoryName = this.getkeyDesc(key, this.typeOptions)
    },
    getkeyDesc(key, keyOptions) {
      let array = keyOptions
      let desc = ''
      for (let index = 0; index < array.length; index++) {
        const element = array[index]
        if (key.toString() == element.dictKey) {
          desc = element.dictValue
        }
      }
      return desc
    },
    getquestionTypeDesc(questionType) {
      return this.getkeyDesc(questionType, this.questiontypeOptions)
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.queryParam = {
        questionCategoryId: undefined,
        questionCategoryName: undefined,
        questionContent: '',
        questionType: undefined
      }
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    addRecord() {
      this.editInfoDetail = {}
      this.defaultForm = {}
      this.isEdit = false
      this.modalTitle = '新增数据'
      this.detailVisible = true
    },
    customRequest(data) {
      const formData = new FormData()
      formData.append('file', data.file)
      this.saveFile(formData)
    },
    saveFile(formData) {
      // 试题批量导入
      let requesturl = SafeduQuestionBankApi.uploadSafeduQuestion
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData
      }
      let config = {
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config)
        .then(res => {
          if (res.code == 200) {
            _this.$message.success(`${res.msg}`)
            _this.searchReset()
          } else {
            _this.$message.error(`${res.msg}`)
          }
        })
        .catch(err => {
          _this.$message.error('导入失败')
        })
    },
    templateDownload() {
      const url = '/download/智慧安监试题导入模板V1.0.xlsx'
      const name = '智慧安监试题导入模板V1.0.xlsx'
      var newA = document.createElement('a')
      newA.setAttribute('href', url)
      newA.setAttribute('download', name)
      newA.style.display = 'none'
      document.body.appendChild(newA)
      newA.click()
      document.body.removeChild(newA)
    },
    quesBankcancel() {
      this.detailVisible = false
    },
    quesBankok(formData) {
      this.detailVisible = false

      if (this.isEdit) {
        this.editRecordInfo(formData)
      } else {
        this.addRecordInfo(formData)
      }
    },
    // 添加
    addRecordInfo(formData) {
      let { questionType, questionRepoId, questionRepoName, questionContent, analysis, answerList } = formData
      let params = formData

      let requesturl = SafeduQuestionBankApi.addSafeduQuestion
      let method = 'post'
      let requestparams = {
        params: {},
        data: params
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.searchReset()
      })
    },
    // 编辑(查询详情)
    editRecord(record) {
      this.isEdit = true
      this.editInfoDetail = {}
      this.defaultForm = {}
      let requesturl = SafeduQuestionBankApi.querySafeduQuestionDeiail
      let method = 'get'
      let requestparams = {
        params: { id: record.id },
        data: {}
      }
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        let data = res.data
        this.editInfoDetail = JSON.parse(JSON.stringify(data))

        this.defaultForm = this.editInfoDetail

        this.modalTitle = '编辑数据'
        this.detailVisible = true
      })
    },
    // 编辑(修改详情)
    editRecordInfo(formData) {
      let requesturl = SafeduQuestionBankApi.updateSafeduQuestion
      let method = 'post'
      let requestparams = {
        params: {},
        data: formData
      }
      let config = {
        headers: {
          'Content-Type': 'application/json;'
        }
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
      })
    },
    // 删除试题
    removeRecord(record) {
      this.removeConfirm(record)
    },
    removeConfirm(record) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将删除选中数据，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk() {
          _this.deleteRecord(record)
        }
      })
    },
    deleteRecord(record) {
      let requesturl = SafeduQuestionBankApi.deleteSafeduQuestion
      let method = 'post'
      let requestparams = {
        params: { id: record.id },
        data: {}
      }
      let _this = this
      this.submitFormPost(requesturl, requestparams, method).then(res => {
        _this.$message.success(`${res.msg}`)
        _this.$refs.table.refresh(true)
        _this.$refs.table.clearSelected()
      })
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: flex-end;
}
/deep/.ant-table-body-inner {
  overflow: unset;
}
</style>
