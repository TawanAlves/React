<template>
  <a-modal
    :title="modalTitle"
    :width="900"
    :visible="visible"
    :confirmLoading="loading"
    @ok="modalOk"
    @cancel="modalCancel"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <template slot="footer">
      <a-button @click="modalCancel" v-if="disabled">取消</a-button>
    </template>
    <a-spin :spinning="loading">
      <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
        <a-form-model-item ref="coursewareName" label="课件名称" prop="coursewareName">
          <a-input v-model="form.coursewareName" :maxLength="32" placeholder="请输入课件名称" :disabled="disabled"/>
        </a-form-model-item>
        <a-form-model-item label="课件类型" prop="coursewareTypeId">
          <a-select v-model="form.coursewareTypeId" @change="coursewareTypechange" placeholder="请选择课件类型" :disabled="disabled">
            <a-select-option v-for="d in coursewareTypeOptions" :key="d.dictKey" style="width: 100%">
              {{ d.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
        <a-form-model-item ref="coursewareDesc" label="课件描述" prop="coursewareDesc">
          <a-input v-model="form.coursewareDesc" type="textarea" :maxLength="256" placeholder="请输入课件描述" :disabled="disabled"/>
        </a-form-model-item>

        <a-form-model-item label="上传文件" prop="files">
          <upload-file
            accept=""
            :fileList="files"
            :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'files')"
            :removePro="(file) => removeFile(file, 'files')"
            :disabled="disabled"
            :multiple="false"
            :fileNumber="1"
            fileNumberError="一个课件只允许上传一个附件"
          />
        </a-form-model-item>
        <a-form-model-item label="发布范围" prop="publishRange">
          <a-select v-model="form.publishRange" :disabled="disabled" placeholder="请选择发布范围">
            <a-select-option v-for="d in releaseScopeOptions" :key="d.dictKey" style="width: 100%">
              {{ d.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
      </a-form-model>
    </a-spin>
  </a-modal>
</template>

<script>
import UploadFile from '@/components/UploadFile'

export default {
  name: '',
  components: {
    UploadFile,
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },

    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    defaultForm: {
      type: Object, // 默认表单数据
      default: () => null,
    },
    coursewareTypeOptions: {
      type: Object, // 课件类型
      default: () => null,
    },
    publishRangeOptions: {
      type: Object, // 公布范围
      default: () => null,
    },
  },
  data() {
    return {
      releaseScopeOptions: [
        { dictKey: 0, dictValue: '公开' },
        { dictKey: 1, dictValue: '私密' },
      ],
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      form: {
        coursewareName: '',
        coursewareTypeId: undefined,
        coursewareTypeName: '',
        coursewareDesc: '',
        publishRange: undefined,
        fileId: '',
        fileName: '',
        filePath: '',
      },
      files: [],
      rules: {
        coursewareName: [{ required: true, message: '请输入课件名称', trigger: 'blur' }],
        coursewareTypeId: [{ required: true, message: '请选择课件类型', trigger: 'blur' }],
        publishRange: [{ required: true, message: '请选择发布范围', trigger: 'blur' }],
        files: [
          {
            required: true,
            validator: (rule, value, callback) => {
              if (this.files.length === 0) {
                callback(new Error('需上传一个附件'))
              } else {
                callback()
              }
            },
            trigger: 'changed',
          },
        ],
      },
    }
  },
  created() {},
  mounted() {
    this.resetForm()
  },
  watch: {
    defaultForm: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  methods: {
    coursewareTypechange(val) {
      let list = this.coursewareTypeOptions
      for (let index = 0; index < list.length; index++) {
        const element = list[index]
        if (val == element.dictKey) {
          this.form.coursewareTypeId = element.dictKey
          this.form.coursewareTypeName = element.dictValue
        }
      }
    },
    setFormData(newFormData) {
      this.resetForm()
      this.form = JSON.parse(JSON.stringify(newFormData))
      let { fileId, fileName, filePath } = this.form
      if (fileId) {
        this.files = [
          {
            uid: fileId,
            name: fileName,
            status: 'done',
            id: fileId,
            url: this.BASE_URL + '/spang-safety/file' + filePath,
          },
        ]
      } else {
        this.files = []
      }
    },

    handleUpload(fileJson, resp, field) {
      if (fileJson.status === 'done' && resp.success) {
        this.form.fileId = resp.data.id
        this.form.fileName = resp.data.originalFileName
        this.form.filePath = resp.data.urlPath

        this.files = [
          {
            uid: this.form.fileId,
            name: this.form.fileName,
            status: 'done',
            id: this.form.fileId,
            url: this.form.filePath,
          },
        ]
      }
    },
    removeFile(file, field) {
      const index = this.files.findIndex((item) => item.id === file.uid)
      if (index > -1) {
        this.files.splice(index, 1)
        this.form.fileId = ''
        this.form.fileName = ''
        this.form.filePath = ''
      }
    },
    modalOk() {
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          this.$emit('ok', this.form)
          this.resetForm()
        } else {
          return false
        }
      })
    },
    modalCancel() {
      this.$emit('cancel')
      this.resetForm()
    },
    resetForm() {
      this.form = {
        coursewareName: '',
        coursewareTypeId: undefined,
        coursewareTypeName: '',
        coursewareDesc: '',
        publishRange: undefined,
        fileId: '',
        fileName: '',
        filePath: '',
      }
      this.files = []
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
    },
  },
}
</script>
