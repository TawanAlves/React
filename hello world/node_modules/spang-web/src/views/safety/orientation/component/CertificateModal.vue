<template>
  <a-modal
    :title="modalTitle"
    width="60%"
    :visible="visible"
    :confirmLoading="loading"
    @cancel="$emit('cancel')"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form-model :model="form" ref="ruleForm" :rules="rules" :label-col="{span: 7}" :wrapper-col="{span:12}">
        <a-row :gutter="24">
          <a-col :span="12">
            <a-form-model-item label="人员类型" disabled prop="userType">
              <a-select disabled v-model="form.userType">
                <a-select-option key="1">
                  内部员工
                </a-select-option>
              </a-select>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="部门" prop="deptId">
              <department-select v-model="form.deptId" @change="handleDeptChange" placeholder="请选择部门" :disabled="disabled"></department-select>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-row :gutter="24">
              <a-col :span="13">
                <a-form-model-item label="姓名" prop="userId" :label-col="{span: 13}" :wrapper-col="{ span: 10 }">
                  <person-list-select v-model="form.userId" @change="userChanged" :deptId="form.deptId" placeholder="请选择姓名" :disabled="disabled"/>
                </a-form-model-item>
              </a-col>
              <a-col :span="8" style="position: absolute; right: 92px;">
                <a-form-model-item label="性别" prop="sex" :wrapper-col="{ span: 14 }">
                  <a-select
                    v-model="form.sex"
                    :disabled="disabled"
                    placeholder="请选择性别">
                    <a-select-option :key="1">
                      男
                    </a-select-option>
                    <a-select-option :key="0">
                      女
                    </a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
            </a-row>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="身份证" prop="idCard">
              <a-input v-model="form.idCard" :disabled="disabled" placeholder="请输入身份证" :max-length="32"/>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="证书名称" prop="certName">
              <a-input v-model="form.certName" :disabled="disabled" placeholder="请输入证书名称" :max-length="32"/>
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="发证机关" prop="issuingOffice">
              <a-input v-model="form.issuingOffice" :disabled="disabled" placeholder="请输入发证机关" :max-length="32"/>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="证书编号" prop="certCode">
              <a-input v-model="form.certCode" :disabled="disabled" placeholder="请输入证书编号" :max-length="32"/>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="有效开始日期" prop="certStartDate">
              <a-date-picker
                :valueFormat="dateFormat"
                v-model="form.certStartDate"
                :disabled="disabled"
                style="width: 100%"
                placeholder="请选择有效开始日期"
              />
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="有效结束日期" prop="certEndDate">
              <a-date-picker
                :valueFormat="dateFormat"
                v-model="form.certEndDate"
                :disabled="disabled"
                style="width: 100%"
                placeholder="请有效结束日期"
              />
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="复审日期" prop="recheckDate">
              <a-date-picker
                :valueFormat="dateFormat"
                v-model="form.recheckDate"
                :disabled="disabled"
                style="width: 100%"
                placeholder="请选择复审日期"
              />
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="特种作业种类" prop="workTypeId">
              <a-select
                v-model="form.workTypeId"
                @change="certificateTypeChanged"
                :disabled="disabled"
                placeholder="请选择特种作业种类">
                <a-select-option v-for="val in certificateTypeOptions" :key="val.dictKey">
                  {{ val.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="适用的作业票" prop="ticketsTypeId">
              <a-select
                v-model="form.ticketsTypeId"
                @change="workTicketChanged"
                :disabled="disabled"
                placeholder="请选择适用的作业票">
                <a-select-option v-for="val in ticketTypeOptions" :key="val.dictKey">
                  {{ val.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-model-item>
          </a-col>
          <a-col :span="12">
            <a-form-model-item label="原件存放" prop="originalRepo">
              <a-input v-model="form.originalRepo" :disabled="disabled" placeholder="请输入原件存放" :max-length="32"/>
            </a-form-model-item>
          </a-col>
          <a-col :span="12" >
            <a-form-model-item label="附件" prop="fileId">
              <upload-file
                :fileList="files"
                :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'files')"
                :removePro="(file) => removeFile(file, 'files')"
                :disabled="disabled"
                :multiple="false"
                :fileNumber="1"
                fileNumberError="一个作业证只允许上传一个附件"
              />
            </a-form-model-item>
          </a-col>
          <a-col :span="21" >
            <a-form-model-item label="备注" prop="remark" :label-col="{span: 4}" :wrapper-col="{span:20}">
              <a-input type="textarea" v-model="form.remark" :disabled="disabled" placeholder="请输入备注" :max-length="256"/>
            </a-form-model-item>
          </a-col>

        </a-row>

      </a-form-model>
    </a-spin>
    <template slot="footer">
      <a-button key="back" @click="$emit('cancel')">
        取消
      </a-button>
      <a-button key="save" type="primary" @click="saveForm(1)" v-show="!disabled">
        确定
      </a-button>
      <a-button key="submit" type="primary" @click="saveForm(0)" v-if="false">
        发布
      </a-button>
    </template>
  </a-modal>
</template>

<script>
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import { getDict } from '@/api/system'
import { cardid } from '@/utils/validate'
import PersonListSelect from '@/views/safety/components/PersonListSelect'
import UploadFile from '@/components/UploadFile'
import cloneDeep from 'lodash.clonedeep'
export default {
  name: 'CertificateModal',
  components: {
    PersonListSelect,
    DepartmentSelect,
    UploadFile
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    model: {
      type: Object,
      default: () => null
    },
    certificateTypeOptions: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    }
  },
  watch: {
    model: function (val) {
      this.form = Object.assign(
        {
          sex: undefined,
          deptId: undefined,
          userId: undefined,
          userType: '1',
          fileId: undefined,
          fileName: undefined,
          filePath: undefined,
          idCard: undefined,
          issuingOffice: undefined,
          originalRepo: undefined,
          recheckDate: undefined,
          remark: undefined,
          ticketsTypeId: undefined,
          ticketsTypeName: undefined,
          userName: undefined,
          workTypeId: undefined,
          workTypeName: undefined,
          deptName: undefined,
          certEndDate: undefined,
          certName: undefined,
          certStartDate: undefined,
          certCode: undefined
        }, cloneDeep(val))
      if (this.form.fileId) {
        this.files = [
          {
            uid: this.form.fileId,
            name: this.form.fileName,
            status: 'done',
            id: this.form.fileId
          }
        ]
      } else {
        this.files = []
      }

    }
  },
  data () {
    const checkIdCard = (rule, value, callback) => {
      const isValid = cardid(value)
      if (!isValid[0]) {
        callback()
      } else {
        callback(new Error('请输入正确的身份证'))
      }
    }
    return {
      files: [],
      dateFormat: 'YYYY-MM-DD',
      form: cloneDeep(this.model),
      ticketTypeOptions: [],
      rules: {
        deptId: [
          { required: true, message: '请选择部门', trigger: 'blur' }
        ],
        userId: [{ required: true, message: '请选择姓名', trigger: 'blur' }],
        sex: [{ required: true, message: '请选择性别', trigger: 'blur' }],
        idCard: [
          { required: true, message: '请输入身份证', trigger: 'blur' },
          { validator: checkIdCard, trigger: 'change' }
        ],
        certName: [{ required: true, message: '请输入证书名称', trigger: 'blur' }],
        issuingOffice: [
          { required: true, message: '请输入发证机关', trigger: 'change' }
        ],
        certCode: [
          { required: true, message: '请输入证书编号', trigger: 'change' }
        ],
        certStartDate: [
          { required: true, message: '请选择有效开始日期', trigger: 'change' }
        ],
        certEndDate: [
          { required: true, message: '请选择有效结束日期', trigger: 'change' },
          {
            validator: (rule, value, callback) => {
              if (new Date(value).getTime() < new Date(this.form.certStartDate).getTime()) {
                callback(new Error('结束时间不可早于开始时间'))
              } else {
                callback()
              }
            },
            trigger: 'changed'
          }
        ],
        recheckDate: [{ required: true, message: '请选择复审日期', trigger: 'change' }],
        fileId: [
          {
            required: true,
            validator: (rule, value, callback) => {
              if (!value) {
                callback(new Error('需上传一个附件'))
              } else {
                callback()
              }
            },
            trigger: 'changed'
          }
        ]
      }
    }
  },
  methods: {
    getDict () {
      getDict('SPECIAL_CERTIFICATE_TICKETS').then(({ data }) => {
        this.ticketTypeOptions = data
      })
    },
    handleDeptChange (data) {
      const { id, label } = data
      this.form.deptName = label
      this.form.userId = undefined
      this.form.sex = undefined
    },
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
    userChanged ({ id, person }) {
      this.form.userName = person.realName
      if (person.sex === 1) {
        this.form.sex = 1
        // this.sexChanged(1)
      } else {
        this.form.sex = 0
        // this.sexChanged(0)
      }
    },
    // sexChanged (value) {
    //   this.form.sex = value === 1 ? '男' : '女'
    // },
    certificateTypeChanged (key) {
      const certificate = this.certificateTypeOptions.find(item => item.dictKey === key)
      this.form.workTypeName = certificate.dictValue
    },
    workTicketChanged (key) {
      const ticket = this.ticketTypeOptions.find(item => item.dictKey === key)
      this.form.ticketsTypeName = ticket.dictValue
    },
    saveForm (status) {
      this.$refs.ruleForm.validate((valid, errorProp) => {
        if (valid) {
          this.$emit('ok', { formData: this.form, status: status })
        } else {
          console.error(errorProp)
          this.$message.error('操作失败，请重新检查表单')
          return false
        }
      })
    },
    handleUpload (fileJson, resp, field) {
       if (fileJson.status === 'done' && resp.success) {
         this.form.fileId = resp.data.id
         this.form.fileName = resp.data.originalFileName
         this.form.filePath = resp.data.urlPath
       }
    },
    removeFile (file, field) {
      this.form.fileId = undefined
      this.form.fileName = undefined
      this.form.filePath = undefined
      const fileIndex = this.files.findIndex(item => item.uid === file.uid)
      if (fileIndex > -1) {
        this.files.splice(fileIndex, 1)
      }
    }
  },
  created () {
    if (!this.disabled) {
      this.getDict()
    }
  }
}
</script>
