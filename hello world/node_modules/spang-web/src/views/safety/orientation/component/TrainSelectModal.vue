<template>
  <a-modal
    :title="title"
    :width="1000"
    :visible="visible"
    :confirmLoading="loading"
    @ok="confirmSubmit"
    @cancel="() => { $emit('update:visible', false) }"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :span="8">
              <a-form-item label="名称">
                <a-input v-model="queryParam.trainName" placeholder="请输入名称"  :max-length="32"/>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="培训日期">
                <a-range-picker
                  valueFormat="YYYY-MM-DD HH:mm:ss"
                  v-model="queryParam.time"
                  showTime
                  style="width: 100%"
                  placeholder="请选择培训日期"/>
              </a-form-item>
            </a-col>
            <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="researchRecord">查询</a-button>
                <a-button type="second" @click="resetRecord" style="margin-left: 10px">重置</a-button>
              </span>
            </a-col>
          </a-row>

        </a-form>
      </div>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{ y: 350 }"
        :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
        showPagination="true"
        :showIndexColumn="true"
        style="margin-top: 10px;"
      >
      </s-table>
    </a-spin>
  </a-modal>
</template>

<script>
  import { TrainSelectColumns } from '../columns'
  import URLS from '@/api/exam-url'
  import { STable } from '@/components'

  export default {
    name: 'TrainSelectModal',
    components: {
      STable
    },
    props: {
      visible: {
        type: Boolean,
        required: true
      },
      loading: {
        type: Boolean,
        default: () => false
      },
      model: {
        type: Object,
        default: () => null
      },
      title: {
        type: String,
        default: '操作'
      },
      disabled: {
        type: Boolean,
        default: false
      },
      defaultSelect: {
        type: Array,
        default: () => []
      }
    },
    data () {
      return {
        rowSelectMode: 'radio',
        selectedRowKeys: [],
        selectedRows: [],
        queryParam: {
        },
        loadData: (parameter) => {
          const queryParams = { current: parameter.pageNo, size: parameter.pageSize }
          const requestParams = { ...this.queryParam, status: 0, planStatus: 2 }
          if (this.queryParam.time && this.queryParam.time.length > 0) {
            requestParams.trainStartDate = this.queryParam.time[0]
            requestParams.trainEndDate = this.queryParam.time[1]
          }
          delete requestParams.time
          return this.submitForm(URLS.trainList, requestParams, 'post', { params: queryParams }).then((res) => {
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          })
        }
      }
    },
    computed: {
      columns: () => (TrainSelectColumns)
    },
    watch: {
      defaultSelect: {
        handler: function (val) {
          this.selectedRowKeys = val
        }
      }
    },
    methods: {
      initSelect () {
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      resetRecord () {
        this.queryParam = { }
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      confirmSubmit () {
        if (this.selectedRowKeys.length === 0) {
          this.$message.error('请先选择培训计划')
          return
        }
        this.$emit('ok', this.selectedRows[0])
        this.$emit('update:visible', false)
        this.$refs.table.clearSelected()
      },
      researchRecord () {
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      }
    },
    created () {
      this.initSelect()
    }
  }
</script>

<style scoped>

</style>
