<template>
  <a-modal
    :title="modalTitle"
    :width="800"
    :visible="visible"
    :confirmLoading="loading"
    @ok="() => { $emit('ok') }"
    @cancel="() => { $emit('cancel') }"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form :form="form" :label-col="{ span: 7 }" :wrapper-col="{ span: 12 }">
        <department-select label-name="培训主管单位" decorator-name="competentUnitId" :disabled="disabled"/>
        <person-select label-name="审批人" decorator-name="taskUserId" :disabled="disabled" :initial-model="Object.keys(model).length>0?{id:model.taskUserId,name:model.taskUserName}:null"/>
        <department-select label-name="责任单位" decorator-name="dutyUnitId" :disabled="disabled"/>
        <person-select label-name="责任人" decorator-name="chargerId" :disabled="disabled" :initial-model="Object.keys(model).length>0?{id:model.chargerId,name:model.chargerName}:null"/>
        <a-form-item label="培训名称">
          <a-input
            v-decorator="['trainingName',{ rules:[{ required: true, message: '请填写培训名称' }]}]"
            :disabled="disabled"/>
        </a-form-item>
        <a-form-item label="培训对象">
          <a-input
            v-decorator="['trainingOnject',{ rules:[{ required: true, message: '请填写培训对象' }]}]"
            :disabled="disabled"/>
        </a-form-item>
        <a-form-item label="培训内容">
          <a-textarea
            :rows="4"
            v-decorator="['trainingContent',{ rules:[{ required: true, message: '请填写培训内容' }]}]"
            :disabled="disabled"/>
        </a-form-item>
        <a-form-item label="执行周期">
          <a-select v-decorator="['executeType',{ rules:[{ required: true, message: '请选择执行周期' }]}]" :disabled="disabled">
            <a-select-option v-for="val in executeTypeOptions" :key="val.dictKey">
              {{ val.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-item>
        <a-form-item label="培训起始时间">
          <a-date-picker v-decorator="['startTime',{ rules:[{ required: true }]}]" :disabled="disabled" :valueFormat="dateFormat"/>
        </a-form-item>
        <a-form-item label="培训周期">
          <a-form-item :style="{ display: 'inline-block', width: 'calc(30% - 12px)' }">
            <a-input-number
              :min="1"
              v-decorator="['trainingDays',{ rules:[{ required: true, message: '请输入天数' }], initialValue: '1'}]"
              :disabled="disabled"/>
          </a-form-item>
          <span :style="{ display: 'inline-block', width: '24px', textAlign: 'center' }" class="ant-form-text"> 天</span>
          <a-form-item
            label="培训提醒提前"
            :style="{ display: 'inline-block', width: 'calc(50% - 12px)' }"
            :label-col="{ span: 17}"
            :wrapper-col="{ span: 3 }">
            <a-input-number
              :min="0"
              v-decorator="['remindDays',{ rules:[{ required: true }], initialValue: '0'}]"
              :disabled="disabled"/>
          </a-form-item>
          <span
            :style="{ display: 'inline-block', width: '24px', textAlign: 'center', marginLeft:'50px' }"
            class="ant-form-text">天</span>
        </a-form-item>
        <file-upload
          docName="docName"
          docUrl="docUrl"
          labelName="附件"
          required
          :disabled="disabled"
          :form="form"/>
      </a-form>
    </a-spin>
  </a-modal>
</template>

<script>
import pick from 'lodash.pick'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelect from '@/views/safety/components/PersonSelect'
import FileUpload from '@/views/safety/components/FileUpload'

const fields = ['remindDays', 'trainingDays', 'startTime', 'executeType', 'trainingContent', 'trainingOnject', 'trainingName', 'chargerId', 'dutyUnitId', 'taskUserId', 'competentUnitId', 'docName', 'docUrl'] // 字段

export default {
  name: 'PlanModal',
  components: {
    PersonSelect,
    DepartmentSelect,
    FileUpload
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    model: {
      type: Object,
      default: () => null
    },
    executeTypeOptions: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      form: this.$form.createForm(this)
    }
  },
  created () {
    // 防止表单未注册
    fields.forEach(v => this.form.getFieldDecorator(v))
    // 当 model 发生改变时，为表单设置值
    this.$watch('model', () => {
      if (Object.keys(this.model).length > 0) {
        this.model.executeType = typeof this.executeType === 'string' ? this.model.executeType : this.model.executeType.toString()
      }
      // this.model.trainingDays = typeof this.model.trainingDays === 'string'? this.model.trainingDays.toInteger() : this.model.trainingDays
      this.model && this.form.setFieldsValue(pick(this.model, fields))
    })
  },
  methods: {

  }
}
</script>
