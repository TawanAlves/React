<template>
  <a-modal
    :title="modalTitle"
    :width="650"
    :visible="visible"
    :confirmLoading="loading"
    @ok="modalOk()"
    @cancel="modalCancel()"
    ok-text="提交"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
        <a-form-model-item ref="createBy" label="员工" prop="createBy">
          <PersonListSelect @change="personChange"></PersonListSelect>
        </a-form-model-item>
        <a-form-model-item label="教育类型" prop="eduType">
          <a-select
            v-decorator="['eduType', { rules: [{ required: true, message: '请选择教育类型' }] }]"
            v-model="form.eduType"
            :disabled="disabled"
          >
            <a-select-option v-for="d in educateTypeOptions" :key="d.dictKey" style="width: 100%">
              {{ d.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
        <a-form-model-item label="培训部门" prop="trainDept">
          <trainDept-select @change="departmentchange"></trainDept-select>
        </a-form-model-item>

        <a-form-model-item label="培训课时" prop="trainPeriod">
          <!-- <a-input v-model="form.trainPeriod" /> -->
          <a-input-number v-model="form.trainPeriod" :min="1" :max="100000" :default-value="0" />
        </a-form-model-item>

        <a-form-model-item label="考试成绩" prop="examScore">
          <!-- <a-input v-model="form.examScore" /> -->

          <a-input-number v-model="form.examScore" :min="1" :max="100000" :default-value="0" />
        </a-form-model-item>
        <a-form-model-item label="考试结果" prop="examResult">
          <a-select v-model="form.examResult" :disabled="disabled">
            <a-select-option v-for="d in examResultOptions" :key="d.dictKey" style="width: 100%">
              {{ d.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
        <a-form-model-item label="授课人" prop="teacherName">
          <a-input v-model="form.teacherName" />
        </a-form-model-item>
        <a-form-model-item label="授课开始日期" prop="teachStartDate">
          <a-date-picker
            style="width: 100%"
            :valueFormat="dateFormat"
            :disabled="disabled"
            v-model="form.teachStartDate"
          ></a-date-picker>
        </a-form-model-item>
        <a-form-model-item label="请选择授课结束日期" prop="teachEndDate">
          <a-date-picker
            style="width: 100%"
            :valueFormat="dateFormat"
            :disabled="disabled"
            v-model="form.teachEndDate"
          ></a-date-picker>
        </a-form-model-item>

        <a-form-model-item label="附件" prop="file">
          <upload-file
            accept=""
            :fileList="fileList"
            :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'fileList')"
            :removePro="(file) => removeFile(file, 'fileList')"
            listType="text"
            :disabled="disabled"
          />
        </a-form-model-item>
      </a-form-model>
    </a-spin>
  </a-modal>
</template>

<script>
import PersonListSelect from '@/views/safety/components/PersonListSelect'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import UploadFile from '@/components/UploadFile'

export default {
  createBy: '',
  components: {
    PersonListSelect,
    DepartmentSelect,
    UploadFile,
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },

    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    educateTypeOptions: {
      type: Object, // 教育类型
      default: () => null,
    },
    defaultForm: {
      type: Object, // 表单默认值
      default: () => null,
    },
  },
  data() {
    return {
      examResultOptions: [
        { dictKey: 0, dictValue: '未通过' },
        { dictKey: 1, dictValue: '通过' },
      ],
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      form: {
        createBy: '',
        eduType: '',
        trainDept: '',
        trainPeriod: '',
        examScore: '',
        examResult: '',
        teacherName: '',
        teachStartDate: '',
        teachEndDate: '',
        fileList: [],
      },
      fileList: [],
      rules: {
        createBy: [{ required: true, message: '请选择教责任人', trigger: 'blur' }],
        eduType: [{ required: true, message: '请选择教育类型', trigger: 'blur' }],
        trainDept: [{ required: true, message: '请选择培训部门', trigger: 'blur' }],
        trainPeriod: [{ required: true, message: '请输入培训课时', trigger: 'blur' }],
        examScore: [{ required: true, message: '请输入考试成绩', trigger: 'blur' }],
        examResult: [{ required: true, message: '请选择考试结果', trigger: 'blur' }],
        teacherName: [{ required: true, message: '请输入授课人', trigger: 'blur' }],
        teachStartDate: [{ required: true, message: '请选择授课开始日期', trigger: 'blur' }],
        teachEndDate: [{ required: true, message: '请选择授课结束日期', trigger: 'blur' }],
      },
    }
  },
  created() {},
  mounted() {
    this.resetForm()
    console.log('this.defaultForm.ddddddddddd', this.defaultForm)
    if (this.defaultForm) {
      this.form = JSON.parse(JSON.stringify(this.defaultForm))
    }
  },
  methods: {
    departmentchange(val) {
      this.form.trainDept = val.id
    },
    personChange(val) {
      this.form.createBy = val.id
    },

    handleUpload(fileJson, resp, field) {
      if (fileJson.status === 'done' && resp.success) {
        this.form[field].push({
          originalFileName: resp.data.originalFileName,
          fileUrlPath: resp.data.urlPath,
          id: resp.data.id,
        })
      }
      console.log(this.form)
    },
    removeFile(file, field) {
      const index = this.form[field].findIndex((item) => item.id === file.uid)
      if (index > -1) {
        this.form[field].splice(index, 1)
      }
      const fileIndex = this.localePhotos.findIndex((item) => item.uid === file.uid)
      if (fileIndex > -1) {
        this.localePhotos.splice(fileIndex, 1)
      }
    },
    modalOk() {
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          this.$emit('ok', this.form)
        } else {
          console.log('error submit!!')
          return false
        }
      })
    },
    modalCancel() {
      this.resetForm()
      this.$emit('cancel')
    },
    resetForm() {
      this.$refs.ruleForm.resetFields()
    },
  },
}
</script>
