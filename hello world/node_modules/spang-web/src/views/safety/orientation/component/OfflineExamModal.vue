<template>
  <div>
    <a-modal
      :title="modalTitle"
      width="60%"
      :visible="visible"
      :confirmLoading="loading"
      @cancel="() => { $emit('update:visible', false); filterType = undefined}"
      :bodyStyle="{maxHeight: '700px', overflowY: 'auto'}"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-spin :spinning="loading">
        <a-form-model
          :model="form"
          ref="ruleForm"
          :rules="rules"
          :label-col="{span: 7}"
          :wrapper-col="{span:17}"
          class="custom-form">
          <a-row :gutter="24">
            <a-col :span="24">
              <a-form-model-item label="选择培训计划" prop="certificateType">
                <div class="flex-input-button" v-if="!disabled">
                  <a-input :value="form.trainName" disabled style="margin-right: 5px;"/>
                  <a-button :disabled="disabled" @click="trainSelectModalVisible = true">选择</a-button>
                </div>
                <div v-else>
                  <a-input v-model="form.trainName" disabled/>
                </div>
              </a-form-model-item>
            </a-col>
            <a-col :span="24">
              <a-form-model-item label="考试名称" prop="examName" :disabled="disabled">
                <a-input v-model="form.examName" :disabled="disabled" placeholder="请输入考试名称" :max-length="32"/>
              </a-form-model-item>
            </a-col>
          </a-row>
          <a-row :gutter="24">
            <a-col :span="8">
              <a-form-model-item label="考试日期" prop="examStartTime" :wrapper-col="{span:10}">
                <a-date-picker
                  :valueFormat="dateFormat"
                  v-model="form.examStartTime"
                  :disabled="disabled"
                  placeholder="请选择考试日期"
                />
              </a-form-model-item>
            </a-col>
            <a-col :span="8">
              <a-form-model-item label="创建人" :wrapper-col="{span:10}">
                {{ form.createName }}
              </a-form-model-item>
            </a-col>
            <a-col :span="8">
              <a-form-model-item label="创建日期" :wrapper-col="{span:10}">
                {{ form.createTime }}
              </a-form-model-item>
            </a-col>
          </a-row>
          <a-row :gutter="24">
            <a-col :span="8" v-show="!disabled">
              <a-form-model-item label="上传考试成绩" :wrapper-col="{span:13}">
                <div class="flex-start-input-button">
                  <a-upload
                    :showUploadList="false"
                    accept=".xlsx, .xls"
                    name="file"
                    :multiple="false"
                    :customRequest="importExcel"
                    :disabled="disabled"
                  >
                    <a-button :disabled="disabled"> <a-icon type="upload" /> 点击上传 </a-button>
                  </a-upload>
                  <a @click="downloadTemplate" v-if="!disabled" style="margin-left: 10px;">下载模板</a>
                </div>

              </a-form-model-item>
            </a-col>
            <a-col :span="8">
              <a-form-model-item label="单位" :wrapper-col="{span:10}">
                {{ form.deptName }}
              </a-form-model-item>
            </a-col>
            <a-col :span="21" v-if="disabled">
              <a-row type="flex">
                <a-col :span="2"></a-col>
                <a-col :span="4">
                  <a-form-model-item label="人数" class="label-auto-width" :wrapper-col="{span:10}">
                    {{ form.userCount }}
                  </a-form-model-item>
                </a-col>
                <a-col :span="4">
                  <a-form-model-item label="及格" class="label-auto-width" :wrapper-col="{span:10}">
                    {{ form.passCount }}
                  </a-form-model-item>
                </a-col>
                <a-col :span="4">
                  <a-form-model-item label="不及格" class="label-auto-width" :wrapper-col="{span:10}">
                    {{ form.noPassCount }}
                  </a-form-model-item>
                </a-col>
                <a-col :span="4">
                  <a-form-model-item label="通过率" class="label-auto-width" :wrapper-col="{span:10}">
                    {{ form.passProb }}
                  </a-form-model-item>
                </a-col>
              </a-row>
            </a-col>
          </a-row>

        </a-form-model>
        <a-row :gutter="24" type="flex" justify="left" align="middle">
          <a-col :span="2">
            <span class="op-title">成绩列表</span>
          </a-col>
          <a-col :span="22" v-if="disabled">
            <a-space>
              <a-button type="primary" @click="filterTable(2)">及格</a-button>
              <a-button type="primary" @click="filterTable(1)">不及格</a-button>
              <!--              <a-button type="primary" @click="filterTable(0)">未考试</a-button>-->
            </a-space>
          </a-col>
        </a-row>
        <a-divider/>
        <a-table
          ref="table"
          size="default"
          :rowKey="record => record.userId"
          :columns="columns"
          :dataSource="tableDatas"
          :alert="false"
          :pagination="pagination"
          @change="handleTableChange"
        >
          <span slot="series" slot-scope="text, record, index">
            {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
          </span>
          <span slot="action" slot-scope="text, record, index">
            <template>
              <a @click="removeRecord(record, index)" >删除</a>
            </template>
          </span>
          <span slot="examResult" slot-scope="text, record">
            <template v-if="record.examResult == 1">
              <a-tag color="red">不及格</a-tag>
            </template>
            <template v-if="record.examResult == 2">
              及格
            </template>
          </span>
        </a-table>
      </a-spin>
      <template slot="footer">
        <a-button key="back" @click="$emit('update:visible', false);filterType = undefined">
          取消
        </a-button>
        <a-button key="save" type="primary" @click="saveForm()" v-if="!disabled">
          确定
        </a-button>
      </template>
    </a-modal>
    <train-select-modal
      :visible.sync="trainSelectModalVisible"
      @ok="chooseTrain"
      title="选择培训计划"
    />
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import { STable } from '@/components'
  import { offlineExamPersonColumns, viewOfflineExamColumns } from '../columns'
  import { getTableData } from '@/utils/util'
  import TrainSelectModal from './TrainSelectModal'
  import URLS from '@/api/exam-url'
  import uniqBy from 'lodash.uniqby'

  export default {
    name: 'OfflineExamModal',
    components: {
      STable,
      TrainSelectModal
    },
    props: {
      visible: {
        type: Boolean,
        required: true
      },
      loading: {
        type: Boolean,
        default: () => false
      },
      model: {
        type: Object,
        default: () => null
      },
      examTypeOptions: {
        type: Array,
        default: () => []
      },
      modalTitle: {
        type: String,
        default: '操作'
      },
      disabled: {
        type: Boolean,
        default: false
      }
    },
    computed: {
      ...mapGetters(['userInfo']),
      columns () {
        if (this.disabled) {
          return viewOfflineExamColumns
        }
        return offlineExamPersonColumns
      },
      hasSelected () {
        return this.selectedRowKeys.length > 0
      },
      rowSelection () {
        return {
          selectedRowKeys: this.selectedRowKeys,
          onChange: this.onSelectChange
        }
      }
    },
    watch: {
      model: function (val) {
        this.form = Object.assign({}, val)
        this.loadData()
      }
    },
    data () {
      return {
        trainSelectModalVisible: false,
        tableDatas: [],
        selectedRowKeys: [],
        selectedRows: [],
        dateFormat: 'YYYY-MM-DD',
        form: Object.assign({}, this.model),
        rules: {
          examName: [
            { required: true, message: '请输入考试名称', trigger: 'blur' }
          ],
          examStartTime: [
            { required: true, message: '请选择考试日期', trigger: 'blur' }
          ]
        },
        countOptions: [],
        pagination: {
          pageSize: 10,
          current: 1,
          showSizeChanger: true
        },
        filterType: undefined
      }
    },
    methods: {
      filterOption (input, option) {
        return (
          option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
        )
      },
      saveForm () {
        this.$refs.ruleForm.validate((valid, errorProp) => {
          this.filterType = undefined
          if (valid) {
            this.$emit('ok', { formData: this.form })
            this.$emit('update:visible', false)
          } else {
            console.error(errorProp)
            this.$message.error('操作失败，请重新检查表单')
            return false
          }
        })
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      initSelect () {

      },
      handleTableChange (pagination) {
        const pager = { ...this.pagination }
        pager.current = pagination.current
        pager.pageSize = pagination.pageSize
        this.pagination = pager
        if (this.isNotNullOrUndefined(this.filterType)) {
          this.filterTable(this.filterType, true)
        } else {
          this.loadData()
        }
      },
      loadData () {
        const pagination = { ...this.pagination }
        pagination.total = this.form.userList.length
        this.pagination = pagination
        const tableData = getTableData(this.pagination.current, this.pagination.pageSize, this.form.userList)
        this.tableDatas = tableData.data
        this.pagination.current = tableData.page
      },
      chooseTrain (train) {
        this.form.trainId = train.id
        this.form.trainName = train.trainName
      },
      removeRecord (record) {
        this.showDeleteConfirm(() => {
          this.form.userList = this.form.userList.filter(item => item.userId !== record.userId)
        })
      },
      removeRows () {
        this.showDeleteConfirm(() => {
          const ids = this.selectedRows.map(item => (item.userId))
          this.form.userList = this.form.userList.filter(item => !ids.includes(item.userId))
        })
      },
      showDeleteConfirm (okFun) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            okFun && okFun()
            _this.selectedRows = []
            _this.selectedRowKeys = []
            _this.loadData()
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      },
      filterTable (status, remainPage) {
        this.filterType = status
        let pagination = {}
        if (remainPage) {
          pagination = { ...this.pagination }
        } else {
           pagination = { current: 1, pageSize: 10 }
        }
        const datas = this.form.userList.filter(item => item.examResult === status)
        pagination.total = datas.length
        this.pagination = pagination
        const tableData = getTableData(this.pagination.current, this.pagination.pageSize, datas)
        this.tableDatas = tableData.data
        this.pagination.current = tableData.page
      },
      importExcel (data) {
        const formData = new FormData()
        formData.append('file', data.file)
        this.submitForm(URLS.importScores, formData, 'post', {
              headers: { 'Content-Type': 'multipart/form-data' }
        }).then(({ data, success, msg }) => {
          if (success) {
            const users = [...this.form.userList, ...data.successList]
            this.form.userList = uniqBy(users, 'userId')
            this.loadData()
            if (data.errorList.length > 0) {
              const errorMsg = data.errorList.map(item =>
                (` ${item.userCode}  ${item.userName} ${item.deptName} ${item.postName} ${item.examScore} ${item.examResult} ${item.errorMsg}`)
              )
              this.$error({
                okText: '关闭',
                okType: 'default',
                title: ' ',
                width: 550,
                content: h => (
                  errorMsg.map(item => (
                     <div>{item}</div>
                  ))
                )
              })
            }
          } else {
             this.$message.error(msg)
          }
        }).catch(error => {
          this.$message.error('导入成绩失败')
        })
      },
      downloadTemplate () {
        window.location.href = '/download/线下考试成绩导入模板.xlsx'
      }
    },
    created () {
      if (!this.disabled) {
        this.initSelect()
      }
    }
  }
</script>
<style lang="less" scoped>
  .flex-input-button {
    display: flex;
    justify-content: space-between;
  }
  .flex-start-input-button {
    display: flex;
    justify-content: flex-start;
  }

  /deep/ .ant-table {
    height: auto;
  }

  /deep/ .custom-form .ant-form-item-label {
    width: 138px;
  }
  /deep/ .custom-form .label-auto-width .ant-form-item-label {
    width: 50px;
  }
  .op-title {
    font-size: 16px;
    color: blue;
  }
  /deep/ .ant-divider-horizontal {
    margin: 7px 0;
  }
</style>
