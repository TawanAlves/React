<template>
  <div>
    <a-modal
      :title="modalTitle"
      width="60%"
      :visible="visible"
      :confirmLoading="loading"
      @cancel="() => { $emit('update:visible', false) }"
      :bodyStyle="{maxHeight: '700px', overflowY: 'auto'}"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-spin :spinning="loading">
        <a-form-model
          :model="form"
          ref="ruleForm"
          :rules="rules"
          :label-col="{span: 7}"
          :wrapper-col="{span:12}"
          class="custom-form">
          <a-row :gutter="24">
            <a-col :span="12">
              <a-form-model-item label="考试名称" prop="examName" :disabled="disabled">
                <a-input v-model="form.examName" :disabled="disabled" placeholder="请输入考试名称" :max-length="32"/>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="考试类型" prop="examType" :disabled="disabled">
                <a-select
                  v-model="form.examType"
                  @change="examTypeChanged"
                  :disabled="disabled"
                  placeholder="请选择考试类型">
                  <a-select-option v-for="val in examTypeOptions" :key="val.id">
                    {{ val.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-model-item>
            </a-col>
            <a-col :span="24">
              <a-form-model-item label="考试须知" prop="examExplain" :label-col="{span: 3}" :wrapper-col="{span:18}" class="custom-wrapper-width">
                <a-input
                  type="textarea"
                  v-model="form.examExplain"
                  :disabled="disabled"
                  placeholder="请输入考试须知"
                  :rows="3"
                  :max-length="256"/>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="考试次数" prop="count">
                <a-select
                  v-model="form.count"
                  @change="countChanged"
                  :disabled="disabled"
                  placeholder="请选择考试次数">
                  <a-select-option v-for="val in countOptions" :key="val.id">
                    {{ val.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-item label="考试时长" prop="examDuration">
                <a-input v-model="form.examDuration" disabled addon-after="分钟" placeholder="请输入考试时长"/>
              </a-form-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="考试开始时间" prop="examStartTime">
                <a-date-picker
                  :showTime="{format: 'HH:mm'}"
                  :valueFormat="dateFormat"
                  :format="dateFormat"
                  v-model="form.examStartTime"
                  :disabled="disabled"
                  style="width: 100%"
                  placeholder="请选择考试开始时间"
                  @change="timeChanged"
                />
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="考试结束时间" prop="examEndTime">
                <a-date-picker
                  :showTime="{format: 'HH:mm'}"
                  :valueFormat="dateFormat"
                  :format="dateFormat"
                  v-model="form.examEndTime"
                  :disabled="disabled"
                  style="width: 100%"
                  placeholder="请选择考试结束时间"
                  @change="timeChanged"
                />
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="选择试卷" prop="examPaperName">
                <div class="flex-input-button" v-if="!disabled">
                  <a-input :value="form.examPaperName" disabled style="margin-right: 5px;"/>
                  <a-button :disabled="disabled" @click="paperSelectModalVisible = true">选择</a-button>
                </div>
                <div v-else>
                  {{ form.examPaperName }}
                </div>
              </a-form-model-item>
            </a-col>
            <a-col :span="12">
              <a-form-model-item label="选择培训计划" prop="trainName">
                <div class="flex-input-button" v-if="!disabled">
                  <a-input :value="form.trainName" disabled style="margin-right: 5px;"/>
                  <a-button :disabled="disabled" @click="trainSelectModalVisible = true">选择</a-button>
                </div>
                <div v-else>
                  <a-input v-model="form.trainName" disabled/>
                </div>
              </a-form-model-item>
            </a-col>
            <a-col :span="8">
              <a-form-model-item label="及格分数" prop="passScore">
                <a-input
                  v-model="form.passScore"
                  placeholder="请输入及格分数"
                  :disabled="disabled"
                  :max-length="32"
                  type="number"
                  min="0"/>
              </a-form-model-item>
            </a-col>
            <a-col :span="8">
              <a-form-model-item label="创建人">
                {{ form.createName }}
              </a-form-model-item>
            </a-col>
            <a-col :span="8">
              <a-form-model-item label="单位">
                {{ form.deptName }}
              </a-form-model-item>
            </a-col>
            <a-col :span="21" v-if="!disabled">
              <a-form-model-item label="选择人员" :label-col="{span: 4}" :wrapper-col="{span:20}">
                <a-space>
                  <a-button type="primary" @click="openPersonModal">添加人员</a-button>
                  <a-button type="primary" @click="loadFromTrain">从培训计划中引入</a-button>
                  <a-button @click="removeRows" :disabled="selectedRows.length < 1">删除</a-button>
                </a-space>

              </a-form-model-item>
            </a-col>
            <a-col :span="21" v-if="disabled">
              <a-row type="flex">
                <a-col :span="2"></a-col>
                <a-col :span="4"><a-form-model-item label="人数" class="label-auto-width">{{ form.userList.length }}</a-form-model-item></a-col>
                <a-col :span="4"><a-form-model-item label="及格" class="label-auto-width">{{ form.passCount }}</a-form-model-item></a-col>
                <a-col :span="4"><a-form-model-item label="不及格" class="label-auto-width">{{ form.noPassCount }}</a-form-model-item></a-col>
                <a-col :span="4"> <a-form-model-item label="未考试" class="label-auto-width">{{ form.noJoinCount }}</a-form-model-item></a-col>
                <a-col :span="4"><a-form-model-item label="通过率" class="label-auto-width">{{ form.passProb }}</a-form-model-item></a-col>
              </a-row>
            </a-col>
            <a-col :span="21" v-if="disabled">
              <a-form-model-item label="考试人员" :label-col="{span: 4}" :wrapper-col="{span:20}">
                <a-space>
                  <a-button type="primary" @click="filterTable(2)">及格</a-button>
                  <a-button type="primary" @click="filterTable(1)">不及格</a-button>
                  <a-button type="primary" @click="filterTable(0)">未考试</a-button>
                </a-space>

              </a-form-model-item>
            </a-col>
          </a-row>

        </a-form-model>
        <a-divider/>
        <a-table
          ref="table"
          size="default"
          :rowKey="record => record.userId + record.id"
          :columns="columns"
          :dataSource="tableDatas"
          :rowSelection="rowSelection"
          :alert="false"
          :pagination="pagination"
          @change="handleTableChange"
        >
          <span slot="series" slot-scope="text, record, index">
            {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
          </span>
          <span slot="action" slot-scope="text, record, index">
            <template>
              <a @click="removeRecord(record, index)" >删除</a>
            </template>
          </span>
          <span slot="examResult" slot-scope="text, record">
            <template v-if="record.examResult === 0">
              未考试
            </template>
            <template v-if="record.examResult === 1">
              <a-tag color="red">不及格</a-tag>
            </template>
            <template v-if="record.examResult === 2">
              及格
            </template>
          </span>
        </a-table>
      </a-spin>
      <template slot="footer">
        <a-button key="back" @click="$emit('update:visible', false)">
          取消
        </a-button>
        <a-button key="save" type="primary" @click="saveForm()" v-if="!disabled">
          确定
        </a-button>
      </template>
    </a-modal>
    <person-select-modal
      :visible.sync="personSelectModalVisible"
      @ok="addPerson"
      title="添加人员"
      :multiple="true"
    />
    <paper-select-modal
      :visible.sync="paperSelectModalVisible"
      @ok="choosePaper"
      title="选择试卷"
      :defaultSelect="form.examPaperId ? [form.examPaperId] : []"
    />
    <train-select-modal
      :visible.sync="trainSelectModalVisible"
      @ok="chooseTrain"
      title="选择培训计划"
      :defaultSelect="form.trainId ? [form.trainId] : []"
    />
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import { STable } from '@/components'
  import { onlineExamPersonColumns, viewOnlineExamColumns } from '../columns'
  import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
  import PaperSelectModal from './PaperSelectModal'
  import { getTableData, getMinutesByDateRange } from '@/utils/util'
  import TrainSelectModal from './TrainSelectModal'
  import URLS from '@/api/exam-url'
  import uniqBy from 'lodash.uniqby'

  export default {
    name: 'OnlineExamModal',
    components: {
      STable,
      PersonSelectModal,
      PaperSelectModal,
      TrainSelectModal
    },
    props: {
      visible: {
        type: Boolean,
        required: true
      },
      loading: {
        type: Boolean,
        default: () => false
      },
      model: {
        type: Object,
        default: () => null
      },
      examTypeOptions: {
        type: Array,
        default: () => []
      },
      modalTitle: {
        type: String,
        default: '操作'
      },
      disabled: {
        type: Boolean,
        default: false
      }
    },
    computed: {
      ...mapGetters(['userInfo']),
      columns () {
        if (this.disabled) {
          return viewOnlineExamColumns
        }
        return onlineExamPersonColumns
      },
      hasSelected () {
        return this.selectedRowKeys.length > 0
      },
      rowSelection () {
        if (this.disabled) {
          return null
        }
        return {
          selectedRowKeys: this.selectedRowKeys,
          onChange: this.onSelectChange
        }
      }
    },
    watch: {
      model: function (val) {
        this.form = Object.assign({ examPaperName: null }, val)
        this.loadData()
      },
      'form.examStartTime': function () {
        if (this.form.examStartTime && this.form.examEndTime) {
          this.form.examDuration = getMinutesByDateRange(this.form.examStartTime, this.form.examEndTime)
        }
      },
      'form.examEndTime': function () {
        if (this.form.examStartTime && this.form.examEndTime) {
          this.form.examDuration = getMinutesByDateRange(this.form.examStartTime, this.form.examEndTime)
        }
      }
    },
    data () {
      return {
        emptyTrainFirst: false,
        trainSelectModalVisible: false,
        tableDatas: [],
        paperSelectModalVisible: false,
        personSelectModalVisible: false,
        selectedRowKeys: [],
        selectedRows: [],
        dateFormat: 'YYYY-MM-DD HH:mm',
        form: Object.assign({}, this.model),
        rules: {
          examName: [
            { required: true, message: '请输入考试名称', trigger: 'blur' }
          ],
          examType: [{ required: true, message: '请选择考试类型', trigger: 'blur' }],
          count: [{ required: true, message: '请选择考试次数', trigger: 'blur' }],
          examStartTime: [
            { required: true, message: '请选择考试开始时间', trigger: 'blur' }
          ],
          examEndTime: [
            { required: true, message: '请选择考试结束时间', trigger: 'blur' },
            {
              validator: (rule, value, callback) => {
                if (new Date(value).getTime() <= new Date(this.form.examStartTime).getTime()) {
                  callback(new Error('结束时间不可早于开始时间'))
                } else {
                  callback()
                }
              },
              trigger: 'changed'
            }
          ],
          examPaperName: [
            { required: true, message: '请选择试卷', trigger: 'change' }
          ],
          passScore: [
            { required: true, message: '请输入及格分数', trigger: 'blur' }
          ]
        },
        countOptions: [],
        pagination: {
          pageSize: 10,
          current: 1,
          showSizeChanger: true
        }
      }
    },
    methods: {
      filterOption (input, option) {
        return (
          option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
        )
      },
      saveForm () {
        this.$refs.ruleForm.validate((valid, errorProp) => {
          if (valid) {
            this.$emit('ok', { formData: this.form })
            this.$emit('update:visible', false)
          } else {
            console.error(errorProp)
            this.$message.error('操作失败，请重新检查表单')
            return false
          }
        })
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      initSelect () {
        this.countOptions = [
          {
            id: 1,
            dictValue: '1次'
          },
          {
            id: 2,
            dictValue: '2次'
          },
          {
            id: 3,
            dictValue: '3次'
          },
          {
            id: -1,
            dictValue: '不限次数'
          }
        ]
      },
      choosePaper (paper) {
        this.form.examPaperId = paper.id
        this.form.examPaperName = paper.paperName
      },
      handleTableChange (pagination) {
        const pager = { ...this.pagination }
        pager.current = pagination.current
        pager.pageSize = pagination.pageSize
        this.pagination = pager
        this.loadData()
      },
      loadData () {
        const pagination = { ...this.pagination }
        pagination.total = this.form.userList.length
        this.pagination = pagination
        const tableData = getTableData(this.pagination.current, this.pagination.pageSize, this.form.userList)
        this.tableDatas = tableData.data
        this.pagination.current = tableData.page
      },
      countChanged (id) {

      },
      examTypeChanged (id) {

      },
      chooseTrain (train) {
        this.form.trainId = train.id
        this.form.trainName = train.trainName
        if (this.emptyTrainFirst) {
          this.loadFromTrain()
          this.emptyTrainFirst = false
        }
      },
      loadFromTrain () {
        if (this.form.trainId) {
          this.getList(URLS.trainUsers, { trainId: this.form.trainId }, 'post').then(({ success, data }) => {
            if (success) {
              const users = [...this.form.userList, ...data]
              this.form.userList = uniqBy(users, 'userId')
              this.loadData()
            }
          })
        } else {
          this.trainSelectModalVisible = true
          this.emptyTrainFirst = true
        }
      },
      openPersonModal () {
        this.personSelectModalVisible = true
      },
      addPerson (users) {
        const usersList = [...this.form.userList, ...users]
        this.form.userList = uniqBy(usersList, 'userId')
        this.personSelectModalVisible = false
        this.loadData()
      },
      removeRecord (record) {
        this.showDeleteConfirm(() => {
          this.form.userList = this.form.userList.filter(item => item.userId !== record.userId)
        })
      },
      removeRows () {
        this.showDeleteConfirm(() => {
          const ids = this.selectedRows.map(item => (item.userId))
          this.form.userList = this.form.userList.filter(item => !ids.includes(item.userId))
        })
      },
      showDeleteConfirm (okFun) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            okFun && okFun()
            _this.selectedRows = []
            _this.selectedRowKeys = []
            _this.loadData()
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      },
      filterTable (status) {
        const pagination = { current: 1, pageSize: 10 }
        pagination.total = this.form.userList.length
        this.pagination = pagination
        const datas = this.form.userList.filter(item => item.examResult === status)
        const tableData = getTableData(this.pagination.current, this.pagination.pageSize, datas)
        this.tableDatas = tableData.data
        this.pagination.current = tableData.page
      }
    },
    created () {
      if (!this.disabled) {
        this.initSelect()
      }
    }
  }
</script>
<style lang="less" scoped>
  .flex-input-button {
    display: flex;
    justify-content: space-between;
  }

  /deep/ .ant-table {
    height: auto;
  }

  /deep/ .custom-form .ant-form-item-label {
    width: 138px;
  }
  /deep/ .custom-form .label-auto-width .ant-form-item-label {
    width: 50px;
  }
  /deep/ .custom-wrapper-width .ant-form-item-control-wrapper {
    width: 75.5%;
  }
</style>
