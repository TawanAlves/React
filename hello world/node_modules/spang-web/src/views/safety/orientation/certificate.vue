<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :bodyStyle="{ paddingBottom: 0 }">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="证书名称">
                <a-input v-model="queryParam.certName" placeholder="证书名称"/>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="有效日期">
                <a-range-picker v-model="queryParam.validateDateRange" :valueFormat="dateFormat" style="width: 100%;min-width: 110px;"/>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="certificateResearch">查询</a-button>
                <a-button type="second" @click="certificateRefresh">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card table-card-wrapper"
    >
      <template #title>
        <div class="text-right">
          <a-space>
            <a-button
              type="primary"
              icon="plus"
              @click="certificateAdd"
              v-if="permission.certificate_add"
            >新建</a-button>
            <a-button
              icon="delete"
              :disabled="!hasSelected"
              @click="certificateRemoves"
              v-if="permission.certificate_delete && false"
            >批量删除</a-button>
          </a-space>
        </div>
      </template>
      <s-table
        ref="certificateTable"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :showIndexColumn="true"
        :scroll="{y: 'calc(100vh - 432px)', x: 1450}"
      >
        <span slot="action" slot-scope="text, record">
          <template>
            <a
              @click="certificatePublish(record, 0)"
              v-if="permission.certificate_publish && record.status !== 0"
            >发布</a>
            <a
              @click="certificatePublish(record, 1)"
              v-if="permission.certificate_recall && record.status === 0"
            >撤回</a>
            <a-divider type="vertical" v-if="permission.certificate_recall && record.status === 0" />
            <a @click="certificateView(record)" v-if=" record.status === 0">查看</a>
            <a-divider type="vertical" v-if="permission.certificate_edit && record.status !== 0" />
            <a
              @click="certificateEdit(record)"
              v-if="permission.certificate_edit && record.status !== 0"
            >编辑</a>
            <a-divider type="vertical" v-if="permission.certificate_delete && record.status !== 0" />
            <a
              @click="certificateRemove(record)"
              v-if="permission.certificate_delete && record.status !== 0"
            >删除</a>
          </template>
        </span>
      </s-table>
      <certificate-modal
        ref="certificateModal"
        :modal-title="commonTitle"
        :visible="commonVisible"
        :model="commonData"
        :disabled="commonDisabled"
        :certificate-type-options="certificateTypeOptions"
        @cancel="certificateCancel"
        @ok="certificateOk"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { certificateColumns } from '@/views/safety/table'
import CertificateModal from '@/views/safety/orientation/component/CertificateModal'
import { mapGetters } from 'vuex'
import { getDict } from '@/api/system'
import URLs from '@/api/urls'
export default {
  components: {
    STable,
    CertificateModal
  },
  data() {
    return {
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = {
          certName: this.queryParam.certName
        }
        const config = {
          params: {
            current: parameter.pageNo,
            size: parameter.pageSize
          }
        }
        if (this.queryParam.validateDateRange) {
          Object.assign(requestParameters, {
            certStartDate: this.queryParam.validateDateRange[0],
            certEndDate: this.queryParam.validateDateRange[1]
          })
        }
        return this.submitForm(URLs.certificate, requestParameters, 'post', config).then(res => {
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      // select options
      certificateTypeOptions: [],
      queryParam: {},
      // modal
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false
    }
  },
  created() {
    this.selectOptionsInit()
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => certificateColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    selectOptionsInit() {
      getDict('SPECIAL_CERTIFICATE').then(({ data }) => {
        this.certificateTypeOptions = data
      })
    },
    modalInit() {
      this.commonTitle = ''
      this.commonData = {}
      this.commonVisible = false
      // const form = this.$refs.certificateModal.$refs.ruleForm
      // form.resetFields()
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    certificateResearch() {
      this.$refs.certificateTable.refresh(true)
      this.$refs.certificateTable.clearSelected()
    },
    certificateRefresh() {
      this.queryParam = {}
      this.certificateResearch()
    },
    certificateAdd() {
      this.commonTitle = '新增数据'
      this.commonVisible = true
      this.commonData = {}
      this.commonDisabled = false
    },
    certificateRemoves() {
      const ids = this.selectedRows.map(item => {
        return item.id
      })
      this.removeConfirm(ids)
    },
    certificateRemove(record) {
      this.removeConfirm([record.id])
    },
    removeConfirm(ids) {
      const _this = this
      this.$confirm({
        title: '提示',
        content: '将删除选中数据，是否确认？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk() {
          _this.submitForm(URLs.certificateDelete, ids, 'post').then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.certificateTable.refresh()
              _this.$refs.certificateTable.clearSelected()
            } else {
              _this.$message.success('删除失败')
            }
          })
        }
      })
    },
    certificateView(record) {
      this.commonTitle = '查看数据'
      this.getById(URLs.certificateById, record.id).then(res => {
        this.commonData = { ...record }
        this.commonVisible = true
        this.commonDisabled = true
      })
    },
    certificateEdit(record) {
      this.commonTitle = '编辑数据'
      this.getById(URLs.certificateById, record.id).then(res => {
        if (res.code === 200) {
          this.commonData = { ...res.data }
          this.commonVisible = true
          this.commonDisabled = false
        }
      })
    },
    certificateCancel() {
      this.modalInit()
    },
    certificateOk(emitData) {
      const datas = Object.assign({}, emitData.formData, {
        id: this.commonData.id,
        status: emitData.status
      })
      let url = ''
      if (this.isNotNullOrUndefined(this.commonData.id)) {
        url = URLs.certificateUpdate
      } else {
        url = URLs.certificateAdd
      }
      this.submitForm(url, datas, 'post').then(res => {
        if (res.code === 200) {
          this.$message.success(`${res.msg}`)
          this.modalInit()
          this.$refs.certificateTable.refresh()
          this.$refs.certificateTable.clearSelected()
        }
      })
    },
    certificatePublish(record, isIssue) {
      this.submitForm(URLs.certificateStatus, null, 'get', { params: { id: record.id, status: isIssue } }).then(res => {
        if (res.code === 200) {
          this.$message.success(`操作成功`)
          this.$refs.certificateTable.refresh()
        }
      })
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}
</style>
