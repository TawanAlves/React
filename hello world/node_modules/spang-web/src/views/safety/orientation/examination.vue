<template>
  <page-container :title="false">
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="card-right">
          <a-button @click="dealWidthRecord(0)" style="float:right;">一键驳回</a-button>
          <a-button
            type="primary"
            @click="dealWidthRecord(1)"
            style="float:right;margin-right:10px;"
          >一键审批</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="rowSelection"
        showPagination="true"
        :scroll="{y: 'calc(100vh - 342px)', x: 1260}"
      >
        <!-- 序号 -->
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <!-- 序号 end -->
        <template slot="planStatus" slot-scope="text, record">
          <a-tag :color="record.planStatus | colorFilter" style="margin-right: 0 !important">
            {{
            record.planStatus | textFilter
            }}
          </a-tag>
        </template>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="checkRecord(record)">查看</a>
          </template>
        </span>
      </s-table>
      <a-modal
        :title="commonTitle"
        :visible="commonVisible"
        :confirm-loading="confirmLoading"
        width="900px"
        height="600px"
        :ok-button-props="{ props: { disabled: commonDisabled } }"
        @ok="modalOk(commonData)"
        @cancel="handleCancel"
        :keyboard="false"
        :maskClosable="false"
      >
        <a-form-model
          ref="ruleForm"
          :model="commonData"
          :rules="rules"
          :label-col="labelCol"
          :wrapper-col="wrapperCol"
        >
          <div>
            <a-row :gutter="24">
              <a-col :span="24">
                <a-form-model-item
                  ref="trainName"
                  label="培训名称"
                  prop="trainName"
                  :label-col="{ span: 4 }"
                  :wrapper-col="{ span: 19 }"
                >
                  <a-input
                    :disabled="commonDisabled"
                    v-model="commonData.trainName"
                    @blur="() => {$refs.trainName.onFieldBlur();}"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainTypeId" label="培训类型" prop="trainTypeId">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.trainTypeId"
                    placeholder="培训类型"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in trainTypeNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="orgUnitId" label="培训组织单位" prop="orgUnitId">
                  <a-tree-select
                    :disabled="commonDisabled"
                    v-model="commonData.orgUnitId"
                    show-search
                    style="width: 100%"
                    :dropdown-style="{ maxHeight: '400px', overflow: 'auto' }"
                    :tree-data="torgUnitNameOptions"
                    placeholder="培训组织单位"
                    allow-clear
                    tree-default-expand-all
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainLevelId" label="培训级别" prop="trainLevelId">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.trainLevelId"
                    placeholder="培训级别"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in trainLeveNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainWay" label="培训形式" prop="trainWay">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.trainWay"
                    placeholder="培训形式"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in trainWayNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainPeriod" label="学时" prop="trainPeriod">
                  <a-input
                    :disabled="commonDisabled"
                    v-model="commonData.trainPeriod"
                    @blur="() => {$refs.trainPeriod.onFieldBlur();}"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="isExam" label="是否需要考试" prop="isExam">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.isExam"
                    placeholder="是否需要考试"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in isExamNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainStartDate" label="培训开始日期" prop="trainStartDate">
                  <a-date-picker
                    :disabled="commonDisabled"
                    show-time
                    v-model="commonData.trainStartDate"
                    format="YYYY-MM-DD HH:mm"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainEndDate" label="培训结束日期" prop="trainEndDate">
                  <a-date-picker
                    :disabled="commonDisabled"
                    show-time
                    v-model="commonData.trainEndDate"
                    format="YYYY-MM-DD HH:mm"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="24">
                <a-form-model-item
                  ref="trainDesc"
                  label="培训介绍"
                  prop="trainDesc"
                  :label-col="{ span: 4 }"
                  :wrapper-col="{ span: 19 }"
                >
                  <a-textarea
                    :disabled="commonDisabled"
                    placeholder="培训介绍"
                    v-model="commonData.trainDesc"
                    :rows="4"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="24">
                <a-form-model-item
                  ref="roleId"
                  label="审批人"
                  prop="roleId"
                  :label-col="{ span: 4 }"
                  :wrapper-col="{ span: 19 }"
                >
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.roleId"
                    placeholder="审批人"
                    style="width: 100%"
                  >
                    <a-select-option v-for="d in postNameOptions" :key="d.id">{{ d.realName }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
            </a-row>
            <a-row>
              <a-col :span="24" class>
                <div>
                  <span>培训内容</span>
                  <a-button type="primary" @click="addCourseware" :disabled="commonDisabled">添加课件</a-button>
                </div>
                <a-table
                  :columns="coursewareColumns"
                  :pagination="false"
                  :data-source="coursewareList"
                >
                  <span slot="speakId" slot-scope="text, record" style="width:100%;">
                    <PersonListSelect
                      @change="personChange"
                      v-model="record.speakId"
                      :disabled="commonDisabled"
                    ></PersonListSelect>
                  </span>
                  <span slot="coursewareDate" slot-scope="text, record">
                    <a-range-picker
                      show-time
                      :disabled="commonDisabled"
                      format="YYYY-MM-DD HH:mm:ss"
                      v-model="record.coursewareDate"
                    />
                  </span>
                  <span slot="action" slot-scope="text, record">
                    <a @click="deleteCourseware(record)">删除</a>
                  </span>
                </a-table>
              </a-col>
              <a-col :span="24">
                <div>
                  <span>培训对象</span>
                  <a-button type="primary" @click="addPeople" :disabled="commonDisabled">添加人员</a-button>
                </div>
                <a-table :columns="userColumns" :pagination="false" :data-source="userList">
                  <span slot="action" slot-scope="text, record">
                    <a @click="deletePeople(record)">删除</a>
                  </span>
                </a-table>
              </a-col>
            </a-row>
          </div>
        </a-form-model>
      </a-modal>
      <CoursewareSelectModal
        :visible.sync="coursewareVisible"
        :loading="confirmLoadingCourseware"
        @ok="submitCourseware"
        title="添加课件"
        :dept-id="workUnitId"
        :multiple="true"
      />
      <person-select-modal
        :visible.sync="peopleVisible"
        :loading="confirmLoadingPeople"
        @ok="submitPeople"
        title="添加人员"
        :dept-id="workUnitId"
        :multiple="true"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { examination } from '@/views/safety/table'
import ApiURLs from '@/api/urls'
import URLS from '@/api/exam-url'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'
import { getDict } from '@/api/system'
import { getPersonnelTree } from '@/api/safety'
import { getUsers } from '@/api/system'
import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
import CoursewareSelectModal from '@/views/safety/task/component/CoursewareSelectModal'
import PersonListSelect from '@/views/safety/components/PersonListSelect'

export default {
  name: 'examination',
  components: {
    STable,
    PersonSelectModal,
    CoursewareSelectModal,
    PersonListSelect
  },
  data() {
    return {
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      coursewareColumns: [
        {
          title: '课件名称',
          dataIndex: 'coursewareName',
          key: 'coursewareName',
          align: 'center'
        },
        {
          title: '授课人',
          dataIndex: 'speakId',
          key: 'speakId',
          scopedSlots: { customRender: 'speakId' },
          align: 'center',
          width: 200
        },
        {
          title: '培训时间',
          dataIndex: 'coursewareDate',
          key: 'coursewareDate',
          scopedSlots: { customRender: 'coursewareDate' },
          align: 'center'
        },
        {
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        }
      ],
      userColumns: [
        {
          title: '姓名',
          dataIndex: 'userName',
          key: 'realName',
          align: 'center'
        },
        {
          title: '岗位',
          dataIndex: 'deptName',
          key: 'deptName',
          align: 'center'
        },
        {
          title: '部门',
          dataIndex: 'deptName',
          key: 'deptName',
          align: 'center'
        },
        {
          title: '签到时间',
          dataIndex: 'signTime',
          key: 'signTime',
          align: 'center'
        },
        {
          title: '是否参与',
          dataIndex: 'isJoin',
          key: 'isJoin',
          align: 'center',
          scopedSlots: {
            customRender: 'isJoin'
          },
          customRender: text => {
            if (text == 0) {
              return '否'
            }
            if (text == 1) {
              return '是'
            }
          }
        },
        {
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        }
      ],
      peopleVisible: false,
      confirmLoadingPeople: false,
      coursewareVisible: false,
      confirmLoadingCourseware: false,

      planStatusNameOptions: [],
      trainTypeNameOptions: [],
      torgUnitNameOptions: [],
      trainLeveNameOptions: [],
      trainWayNameOptions: [
        {
          dictKey: 0,
          id: '',
          dictValue: '线上培训'
        },
        {
          dictKey: 1,
          id: '',
          dictValue: '线下培训'
        }
      ],
      postNameOptions: [],
      isExamNameOptions: [
        {
          dictKey: 0,
          id: '',
          dictValue: '否'
        },
        {
          dictKey: 1,
          id: '',
          dictValue: '是'
        }
      ],

      labelCol: { span: 8 },
      wrapperCol: { span: 14 },
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonDisabled: false,
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      userInfo: getStore({ name: 'info' }),
      rules: {
        trainName: [{ required: true, message: '请填写培训名称', trigger: 'blur' }],
        trainTypeId: [{ required: true, message: '请选择培训类型', trigger: 'change' }],
        orgUnitId: [{ required: true, message: '请选择培训组织单位', trigger: 'change' }],
        trainLevelId: [{ required: true, message: '请选择培训级别', trigger: 'change' }],
        trainWay: [{ required: true, message: '请选择培训形式', trigger: 'change' }],
        trainPeriod: [{ required: false, message: '请填写学时', trigger: 'blur' }],
        isExam: [{ required: true, message: '请选择是否需要考试', trigger: 'change' }],
        trainStartDate: [{ required: true, message: '请选择培训开始日期', trigger: 'change' }],
        trainEndDate: [{ required: true, message: '请选择培训结束日期', trigger: 'change' }],
        roleId: [{ required: true, message: '请选择审批人', trigger: 'change' }]
      },
      coursewareList: [],
      userList: [],
      commonData: {
        roleId: '',
        roleName: '',
        coursewareList: [],
        gmtCreateId: '',
        createTime: '',
        creditHour: '',
        examId: '',
        id: '',
        isExam: '',
        orgUnitId: '',
        orgUnitName: '',
        planStatus: '',
        status: '',
        trainDesc: '',
        trainEndDate: '',
        trainLevelId: '',
        trainLevelName: '',
        trainName: '',
        trainPeriod: '',
        trainStartDate: '',
        trainTypeId: '',
        trainTypeName: '',
        trainWay: '',
        updateBy: '',
        updateTime: '',
        userList: []
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        return this.submitForm(ApiURLs.examinationList, this.queryParam, 'post', { params: requestParameters }).then(
          res => {
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          }
        )
      }
    }
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => examination,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['', 'orange']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['', '待审批']
      return textList[value]
    }
  },
  methods: {
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    //审批/驳回
    dealWidthRecord(data) {
      const ids = this.selectedRows.map(item => {
        return item.id
      })
      var approveResult = data === 1 ? 1 : 0
      if (ids.length === 0) {
        this.$message.warning('请至少选择一个需要操作的选项')
      } else {
        this.axios.post('/spang-edu/train/plan/approve/approve' + `?approveResult=${approveResult}`, ids).then(rs => {
          if (rs.code === 200) {
            this.$message.success('操作完成')
            this.$refs.table.refresh()
          }
        })
      }
    },

    //关闭弹框
    handleCancel() {
      this.commonVisible = false
    },
    //关闭人员选择弹框
    closePeopleModel() {
      this.peopleVisible = false
    },
    //签到
    signInRecord(data) {},
    //查看
    checkRecord(data) {
      this.commonTitle = '查看数据'
      this.commonDisabled = true
      this.getDetails(data)
      this.coursewareColumns = this.coursewareColumns.filter(item => item.title !== '操作')
      this.userColumns = this.userColumns.filter(item => item.title !== '操作')
    },
    //详情
    getDetails(data) {
      this.commonVisible = true
      this.axios
        .get('/spang-edu/admin/train/plan/selectBase', {
          params: {
            id: data.id
          }
        })
        .then(rs => {
          if (rs.code === 200) {
            this.commonData = rs.data
            this.commonData.roleId = this.commonData.approveList[0].roleId
            this.commonData.trainWay = this.commonData.trainWay == 0 ? '线上' : '线下'
            this.coursewareList = rs.data.coursewareList
            this.coursewareList.forEach(item => {
              var arr = []
              arr[0] = item.coursewareStartDate
              arr[1] = item.coursewareEndDate
              item.coursewareDate = arr
            })
            this.userList = rs.data.trainUserList
          }
        })
    }
  },
  created() {
    //状态
    this.getDict('plan_status').then(({ data, success }) => {
      if (success) {
        this.planStatusNameOptions = data
      }
    })
    //培训类型
    this.getDict('train_type').then(({ data, success }) => {
      if (success) {
        this.trainTypeNameOptions = data
      }
    })
    //培训级别
    this.getDict('train_level').then(({ data, success }) => {
      if (success) {
        this.trainLeveNameOptions = data
      }
    })
    //培训形式
    // this.getDict('train_way').then(({ data, success }) => {
    //   if (success) {
    //     this.trainWayNameOptions = data;
    //   }
    // })
    //培训组织单位
    getPersonnelTree(0).then(res => {
      this.torgUnitNameOptions = res.data
    })
    //审批人
    getUsers().then(res => {
      this.postNameOptions = res.data
    })
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}
/deep/ .ant-calendar-picker {
  width: 100%;
}
/deep/.ant-btn-primary[disabled] {
  display: none !important;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
.quill-editor {
  height: 200px;
}
.ant-col-24 {
  > div {
    margin-top: 10px;
  }
  span {
    display: inline-block;
    margin-right: 10px;
  }
}
</style>
