<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;">
      <div class="paper-title">{{ examInfo.examName }}</div>
      <a-descriptions :column="3" :colon="true">
        <a-descriptions-item label="注意事项" :span="3">  {{ examInfo.examExplain }}</a-descriptions-item>
        <a-descriptions-item label="考试次数">第{{ examInfo.count }}次</a-descriptions-item>
        <a-descriptions-item label="考试时长"> {{ examInfo.examDuration }}分钟</a-descriptions-item>
        <a-descriptions-item label="剩余时间"> {{ examRemainTime }}</a-descriptions-item>
      </a-descriptions>
      <paper-preview
        :disabled="!canSubmit"
        :checkboxScore="examQuestions.checkboxScore"
        :raidoScore="examQuestions.raidoScore"
        :judgeScore="examQuestions.judgeScore"
        :radioQuestions="examQuestions.radioQuestions"
        :checkboxQuestions="examQuestions.checkboxQuestions"
        :judgeQuestions="examQuestions.judgeQuestions"
      />
      <a-row type="flex" justify="center">
        <a-space>
          <a-button type="primary" @click="submitPaper" :disabled="!canSubmit">提交</a-button>
          <a-button @click="goBack">返回</a-button>
        </a-space>

      </a-row>
    </a-card>
  </page-container>
</template>

<script>
  import ExamURls from '@/api/exam-url'
  import PaperPreview from './PaperPreview'
  import { formatTimeBySeconds } from '@/utils/util'
  export default {
    name: 'TakeExam',
    components: { PaperPreview },
    computed: {
      examId () {
        return this.$route.params.id
      }
    },
    data () {
      return {
        canSubmit: true,
        examInfo: {},
        examQuestions: {},
        studentExamTimer: null,
        studentExamTime: 0,
        examRemainTime: 0
      }
    },
    methods: {
      startCountStudentExamTime () {
			  this.studentExamTime--
        this.examRemainTime = formatTimeBySeconds(this.studentExamTime)
        this.studentTimeCount++
        if (this.studentExamTime === 0) {
          const _this = this
          this.$confirm({
            class: 'custom-modal',
            title: '',
            content: h => <div style="text-align: center;"><h3>考试结束</h3><h3>请确认是否提交试卷</h3></div>,
            okText: '确认提交',
            cancelText: '放弃',
            onOk () {
              _this.submitPaper()
            },
            onCancel () {
              _this.goBack()
            }
          })
        }
			},
      transformToArray (item) {
        if (item && Array.isArray(item)) {
          return item
        } else if (item) {
          return item.split(',')
        } else {
          return []
        }
      },
      submitPaper () {
        const questions = [...this.examQuestions.radioQuestions, ...this.examQuestions.checkboxQuestions, ...this.examQuestions.judgeQuestions]
        const params = {
          examId: this.examId,
          examTime: this.examInfo.examDuration * 60 - this.studentExamTime,
          recordList: questions.map(item => ({
            questionId: item.id,
            questionType: item.questionType,
            userAnswerList: this.transformToArray(item.userAnswer)
          }))
        }
        this.submitForm(ExamURls.submitPaper, params, 'post').then(({ data, success }) => {
          if (success) {
            const that = this
            this.canSubmit = false
            if (data.examResult === 2) {
              this.$info({
                title: '',
                class: 'custom-modal',
                okText: '关闭',
                okType: 'default',
                content: h => (
                  <div>
                    <h3 style="text-align: center">考试通过</h3>
                    <h3 style="display: flex;"><span style="width: 50%; text-align:right; margin-right: 3px;">成绩:</span> <span style="color: red">{data.examScore}分</span></h3>
                    <h3 style="display: flex;"><span style="width: 50%; text-align:right; margin-right: 3px;">考试结果:</span> <span style="color: red">及格</span></h3>
                  </div>
                ),
                onOk () {
                    that.goBack()
                }
              })
            } else {
              const examEndTime = new Date(this.examInfo.examEndTime).getTime()
              const now = new Date().getTime()
              if (now < examEndTime && (data.residueCount > 0 || data.residueCount ==-1)) {
               this.$confirm({
                title: '',
                class: 'custom-modal',
                  content: h => (
                    <div>
                      <h3 style="display: flex;"><span style="width: 50%; text-align:right; margin-right: 3px;">成绩:</span> <span style="color: red">{data.examScore}分</span></h3>
                      <h3 style="display: flex;"><span style="width: 50%; text-align:right; margin-right: 3px;">考试结果: </span><span style="color: red">{data.examResult === 1 ? '不及格' : '及格'}</span></h3>
                      <div v-show={data.residueCount!=-1} style="text-align: center;">您还有{data.residueCount}次机会</div>
                    </div>
                  ),
                  okText: '重新开始考试',
                  onOk () {
                    that.$router.go(0)
                  },
                  onCancel () {
                    that.goBack()
                  }
                })
              } else {
                this.$info({
                title: '',
                class: 'custom-modal',
                okText: '关闭',
                okType: 'default',
                content: h => (
                  <div>
                    <h3 style="text-align: center">考试结束</h3>
                    <h3 style="display: flex;"><span style="width: 50%; text-align:right; margin-right: 3px;">成绩:</span> <span style="color: red">{data.examScore}分</span></h3>
                    <h3 style="display: flex;"><span style="width: 50%; text-align:right; margin-right: 3px;">考试结果: </span> <span style="color: red">{data.examResult === 1 ? '不及格' : '及格'}</span></h3>
                  </div>
                ),
                onOk () {
                    that.goBack()
                }
              })
              }
            }
          }
        })
        this.submitForm(ExamURls.savePaperRecord, params, 'post')
      },
      goBack () {
        this.$router.push('/safety/orientation/personalExam')
      }
    },
    created () {
      const params = { examId: this.examId }
      this.getList(ExamURls.startExam, params).then(({ success, data }) => {
        if (success) {
          this.examInfo = data
          this.studentExamTime = data.examDuration * 60
          this.examRemainTime = formatTimeBySeconds(data.examDuration * 60)
          this.studentExamTimer = setInterval(() => {
              this.startCountStudentExamTime() // 开始计算考试时间
          }, 1000)
          this.examQuestions = {
            raidoScore: data.singleChoiceScore,
            checkboxScore: data.multipleChoiceScore,
            judgeScore: data.judgeNumberScore,
            radioQuestions: data.questionAnswerVos.filter(item => item.questionType === 0),
            checkboxQuestions: data.questionAnswerVos.filter(item => item.questionType === 1).map(item => {
              return {
                ...item,
                userAnswer: this.transformToArray(item.userAnswer)
              }
            }),
            judgeQuestions: data.questionAnswerVos.filter(item => item.questionType === 2)
          }
        }
      })
    },
		destroyed () {
			clearInterval(this.studentExamTimer)
		}
  }
</script>

<style scoped lang="less">
  .paper-title {
    text-align: center;
    font-size: 30px;
    font-weight: bolder;
  }
  /deep/ .custom-inline-form .ant-form-item-label {
    width: 80px;
  }
  /deep/ .custom-inline-form .ant-form-item {
    width: 100%;
    display: flex;
    .ant-form-item-control-wrapper {
      flex: 1;
    }
  }
  /deep/ .ant-descriptions-item-label {
    vertical-align: top;
  }
  /deep/ .ant-descriptions-item-content {
   width: calc(100% - 83px);
  }
</style>
