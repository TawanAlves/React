<template>
  <a-modal
    :title="modalTitle"
    :width="900"
    :visible="visible"
    :confirmLoading="loading"
    @ok="modalOk()"
    @cancel="modalCancel()"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
        <a-form-model-item label="员工" prop="userName">
          <PersonListSelect :value="form.userId" @change="personChange" placeholder="请选择员工" :disabled="disabled"></PersonListSelect>
        </a-form-model-item>
        <a-form-model-item label="教育类型" prop="eduTypeId">
          <a-select
            v-model="form.eduTypeId"
            :disabled="disabled"
            @change="eduTypeNamechange"
            placeholder="请选择教育类型"
          >
            <a-select-option v-for="d in educateTypeOptions" :key="d.dictKey" style="width: 100%">
              {{ d.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
        <a-form-model-item label="培训部门" prop="trainDeptName">
          <department-select :value="form.trainDeptId" @change="departmentchange" :disabled="disabled"></department-select>
        </a-form-model-item>

        <a-form-model-item label="培训课时" prop="trainPeriod">
          <a-input-number
            v-model="form.trainPeriod"
            :min="0"
            :max="1000"
            :default-value="0"
            :disabled="disabled"
            placeholder="请输入培训课时"
          />
        </a-form-model-item>

        <a-form-model-item label="考试成绩" prop="examScore">
          <a-input-number
            v-model="form.examScore"
            :min="0"
            :max="1000"
            :step="0.01"
            :default-value="0"
            :disabled="disabled"
            placeholder="请输入考试成绩"
          />
        </a-form-model-item>
        <a-form-model-item label="考试结果" prop="examResult">
          <a-select v-model="form.examResult" :disabled="disabled" placeholder="请选择考试结果">
            <a-select-option v-for="d in examResultOptions" :key="d.dictKey" style="width: 100%">
              {{ d.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
        <a-form-model-item label="授课人" prop="teacherName">
          <a-input v-model="form.teacherName" :maxLength="32" placeholder="请输入授课人" :disabled="disabled" />
        </a-form-model-item>
        <a-form-model-item label="授课开始日期" prop="teachStartDate">
          <a-date-picker
            style="width: 100%"
            :valueFormat="dateFormat"
            :disabled="disabled"
            v-model="form.teachStartDate"
          ></a-date-picker>
        </a-form-model-item>
        <a-form-model-item label="授课结束日期" prop="teachEndDate">
          <a-date-picker
            style="width: 100%"
            :valueFormat="dateFormat"
            :disabled="disabled"
            v-model="form.teachEndDate"
          ></a-date-picker>
        </a-form-model-item>

        <a-form-model-item label="附件" prop="file">
          <upload-file
            accept=""
            :fileList="fileList"
            :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'accessoryList')"
            :removePro="(file) => removeFile(file, 'accessoryList')"
            listType="text"
            :disabled="disabled"
          />
        </a-form-model-item>
      </a-form-model>
    </a-spin>
  </a-modal>
</template>

<script>
import PersonListSelect from '@/views/safety/components/PersonListSelect'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import UploadFile from '@/components/UploadFile'
import moment from 'moment'
export default {
  name: '',
  components: {
    PersonListSelect,
    DepartmentSelect,
    UploadFile,
  },
  props: {
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },

    modalTitle: {
      type: String,
      default: '操作',
    },
    disabled: {
      type: Boolean,
      default: false,
    },
    educateTypeOptions: {
      type: Object, // 教育类型
      default: () => null,
    },
    defaultForm: {
      type: Object, // 默认表单数据
      default: () => null,
    },
  },
  data() {
    return {
      examResultOptions: [
        { dictKey: 0, dictValue: '未通过' },
        { dictKey: 1, dictValue: '通过' },
      ],
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },

      form: {
        userId: undefined,
        userName: '',
        eduTypeId: undefined,
        eduTypeName: '',
        trainDeptId: undefined,
        trainDeptName: '',
        trainPeriod: '',
        examScore: '',
        examResult: undefined,
        teacherName: '',
        teachStartDate: '',
        teachEndDate: '',
        accessoryList: [],
      },
      fileList: [],
      rules: {
        userName: [{ required: true, message: '请选择员工', trigger: 'blur' }],
        eduTypeId: [{ required: true, message: '请选择教育类型', trigger: 'blur' }],
        trainDeptName: [{ required: true, message: '请选择培训部门', trigger: 'blur' }],
        trainPeriod: [{ required: true, message: '请输入培训课时', trigger: 'blur' }],
        examScore: [{ required: true, message: '请输入考试成绩', trigger: 'blur' }],
        examResult: [{ required: true, message: '请选择考试结果', trigger: 'blur' }],
        teacherName: [{ required: true, message: '请输入授课人', trigger: 'blur' }],
        teachStartDate: [{
          required: true,
          // message: '请选择授课开始日期1',
          // trigger: 'blur',
          validator: (rule, value, callback) => {
            if(value) {
              const startDate = new Date(value).getTime()
              const endDate = new Date(this.form.teachEndDate).getTime()
              if(startDate - endDate < 0 || !this.form.teachEndDate) {
                callback()
              } else {
                callback(new Error('授课开始日期不能晚于授课结束日期'))
              }
            } else {
              callback(new Error('请选择授课开始日期'))
            }
          }
        }],
        teachEndDate: [{
          required: true,
          // message: '请选择授课结束日期1',
          // trigger: 'blur',
          validator: (rule, value, callback) => {
            console.log(value)
            if(value) {
              const startDate = new Date(this.form.teachStartDate).getTime()
              const endDate = new Date(value).getTime()
              if(startDate - endDate < 0 || !this.form.teachStartDate) {
                callback()
              } else {
                callback(new Error('授课结束日期不能早于授课开始日期'))
              }
            } else {
              callback(new Error('请选择授课结束日期'))
            }
          }
        }],
      },
    }
  },
  created() {},
  mounted() {
    this.resetForm()
    // this.setFormData(this.defaultForm)
  },
  watch: {
    defaultForm: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  methods: {
    setFormData(newFormData) {
      this.form = JSON.parse(JSON.stringify(newFormData))
      console.log('this.form', this.form)
      this.fileList = this.form.accessoryList.map((item) => ({
        uid: item.fileId,
        name: item.fileName,
        status: 'done',
        id: item.fileId,
        url: this.BASE_URL + '/spang-safety/file' + item.filePath,
      }))
    },
    departmentchange(val) {
      this.form.trainDeptName = val.label
      this.form.trainDeptId = val.id
    },
    personChange(val) {
      if (val.person && val.person.name) {
        this.form.userName = val.person.name
        this.form.userId = val.id
      } else {
        this.form.userName = ''
        this.form.userId = ''
      }
    },
    eduTypeNamechange(val) {
      let list = this.educateTypeOptions
      for (let index = 0; index < list.length; index++) {
        const element = list[index]
        if (val.toString() == element.dictKey.toString()) {
          this.form.eduTypeId = element.dictKey
          this.form.eduTypeName = element.dictValue
        }
      }
    },
    handleUpload(fileJson, resp, field) {
      if (fileJson.status === 'done' && resp.success) {
        this.form[field].push({
          fileName: resp.data.originalFileName,
          filePath: resp.data.urlPath,
          fileId: resp.data.id,
        })
      }
    },
    removeFile(file, field) {
      const index = this.form[field].findIndex((item) => item.fileId === file.id)
      if (index > -1) {
        this.form[field].splice(index, 1)
        this.fileList.splice(index, 1)
      }
    },
    // 校验表格
    submitForm() {
      let flag = false
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          flag = true
        } else {
          flag = false
        }
      })
      return flag
    },
    // 校验时间
    submitFormDate() {
      let formData = JSON.parse(JSON.stringify(this.form))
      let { teachStartDate, teachEndDate } = formData
      if (teachStartDate && teachEndDate) {
        let end = parseInt(moment(teachEndDate).format('x'))
        let start = parseInt(moment(teachStartDate).format('x'))
        if (end > start) {
          return true
        } else {
          let message = '培训结束时间应大于培训开始时间'
          this.$message.destroy()
          this.$message.error(message)
          return false
        }
      } else {
        return true
      }
    },
    modalOk() {
      this.submitForm()
      // this.submitFormDate()
      let formData = JSON.parse(JSON.stringify(this.form))
      if (this.submitForm()) {
        this.$emit('ok', formData)
        this.resetForm()
      } else {
        return false
      }
      // if (this.submitForm() && this.submitFormDate()) {
      //   this.$emit('ok', formData)
      //   this.resetForm()
      // } else {
      //   return false
      // }
    },
    modalCancel() {
      this.resetForm()
      this.$emit('cancel')
    },
    resetForm() {
      this.form = {
        userId: undefined,
        userName: '',
        eduTypeId: undefined,
        eduTypeName: '',
        trainDeptId: undefined,
        trainDeptName: '',
        trainPeriod: '',
        examScore: '',
        examResult: undefined,
        teacherName: '',
        teachStartDate: '',
        teachEndDate: '',
        accessoryList: [],
      }
      this.fileList = []
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
    },
  },
}
</script>
<style lang="less" scoped>
/deep/.ant-input-number {
  width: 100% !important;
}
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
}
</style>
