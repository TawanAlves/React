<template>
  <a-modal
    :title="modalTitle"
    :width="900"
    :visible="visible"
    :confirmLoading="loading"
    @ok="modalOk()"
    @cancel="modalCancel()"
    ok-text="确定"
    cancel-text="取消"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form-model ref="ruleForm" :model="form" :rules="rules" :label-col="labelCol" :wrapper-col="wrapperCol">
        <a-form-model-item label="类别" prop="questionCategoryId">
          <a-select v-model="form.questionCategoryId" @change="questionCategoryChange" placeholder="请选择类别">
            <a-select-option v-for="val in typeOptions" :key="val.dictKey">
              {{ val.dictValue }}
            </a-select-option>
          </a-select>
        </a-form-model-item>
        <a-form-model-item label="题型" prop="questionType">
          <a-radio-group :disabled="isEdit" v-model="form.questionType">
            <a-radio v-for="(item, index) in questiontypeOptions" :key="'questionType' + index" :value="item.dictKey">
              {{ item.dictValue }}
            </a-radio>
          </a-radio-group>
        </a-form-model-item>
        <a-form-model-item label="名称" prop="questionContent">
          <a-input v-model="form.questionContent" placeholder="请输入名称" />
        </a-form-model-item>
        <!-- 单选组件 0 -->
        <radioComponent
          ref="radioComponent"
          v-if="form.questionType == '0'"
          :defaultAnsList="defaultAnsList"
          :isEdit="isEdit"
        ></radioComponent>
        <!-- 多选组件 1 -->
        <MultselectComponents
          ref="multselectComponents"
          v-if="form.questionType == '1'"
          :defaultAnsList="defaultAnsList"
          :isEdit="isEdit"
        ></MultselectComponents>
        <!-- 判断组件 2 -->
        <JudgmentComponent
          ref="JudgmentComponent"
          v-if="form.questionType == '2'"
          :defaultAnsList="defaultAnsList"
          :isEdit="isEdit"
        ></JudgmentComponent>

        <a-form-model-item label="题目解析" prop="analysis">
          <a-input v-model="form.analysis" placeholder="请输入题目解析" />
          注：单选题需勾选一个正确选项，多选题需要勾选两个以上正确选项，判断选对错。
          <div></div>
          <span v-if="form.createBy">创建人：{{ form.createName }}</span>
          <span v-if="form.createTime" style="margin-left: 10px">创建日期：{{ form.createTime }}</span>
        </a-form-model-item>
      </a-form-model>
    </a-spin>
  </a-modal>
</template>

<script>
import radioComponent from './radioComponent'
import MultselectComponents from './MultselectComponents'
import JudgmentComponent from './JudgmentComponent'

export default {
  name: 'LawModal',
  components: {
    radioComponent,
    MultselectComponents,
    JudgmentComponent,
  },
  props: {
    isEdit: {
      type: Boolean,
      required: true,
    },
    visible: {
      type: Boolean,
      required: true,
    },
    loading: {
      type: Boolean,
      default: () => false,
    },
    modalTitle: {
      type: String,
      default: '操作',
    },

    defaultForm: {
      type: Object, // 默认表单数据
      default: () => null,
    },
    questiontypeOptions: {
      type: Object, // 默认表单数据
      default: () => null,
    },
    typeOptions: {
      type: Object, // 默认表单数据
      default: () => null,
    },
  },
  data() {
    return {
      labelCol: { span: 6 },
      wrapperCol: { span: 14 },
      questionTypeOptions: [
        {
          label: '单选',
          value: 0,
        },
        {
          label: '多选',
          value: 1,
        },
        {
          label: '判断',
          value: 2,
        },
      ],
      form: {
        questionCategoryId: undefined,
        questionCategoryName: undefined,
        questionType: undefined,
        questionContent: undefined,
        analysis: '',
      },
      rules: {
        questionCategoryId: [{ required: true, message: '请选择类别', trigger: 'blur' }],
        questionType: [{ required: true, message: '请选择题型', trigger: 'blur' }],
        questionContent: [{ required: true, message: '请输入名称', trigger: 'blur' }],
      },
      defaultAnsList: [],
    }
  },
  created() {},
  watch: {
    defaultForm: {
      //监听的对象
      deep: true, //深度监听设置为 true
      handler: function (newV, oldV) {
        this.setFormData(newV)
      },
    },
  },
  mounted() {
    // this.setFormData(this.defaultForm)
  },
  methods: {
    questionCategoryChange(key) {
      this.form.questionCategoryId = key
      this.form.questionCategoryName = this.getkeyDesc(key, this.typeOptions)
    },
    getkeyDesc(key, keyOptions) {
      let array = keyOptions
      let desc = ''
      for (let index = 0; index < array.length; index++) {
        const element = array[index]
        if (key.toString() == element.dictKey) {
          desc = element.dictValue
        }
      }
      return desc
    },
    setFormData(newFormData) {
      if (this.isEdit) {
        this.form = JSON.parse(JSON.stringify(newFormData))
        this.form.questionType = this.form.questionType.toString()
        this.defaultAnsList = this.form.answerList
      } else {
        this.resetForm()
      }
    },
    submitForm() {
      let flag = false
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          flag = true
        } else {
          flag = false
        }
      })
      return flag
    },
    modalOk() {
      let quesType = this.form.questionType
      let answerList = []
      let validOk = false
      switch (quesType) {
        case '0': // 单选
          this.submitForm()
          this.$refs.radioComponent.submitForm()
          validOk = this.submitForm() && this.$refs.radioComponent.submitForm()
          answerList = this.$refs.radioComponent.answerList
          break
        case '1': // 多选
          this.submitForm()
          this.$refs.multselectComponents.submitForm()
          validOk = this.submitForm() && this.$refs.multselectComponents.submitForm()
          answerList = this.$refs.multselectComponents.answerList
          break
        case '2': // 判断
          this.submitForm()
          this.$refs.JudgmentComponent.submitForm()
          validOk = this.submitForm() && this.$refs.JudgmentComponent.submitForm()
          answerList = this.$refs.JudgmentComponent.answerList
          break
        default:
          validOk = this.submitForm()
          answerList = []
          break
      }
      // 校验注意事项

      let okform = {
        ...this.form,
        answerList: answerList,
      }
      if (!this.verificationprecautions(answerList)) {
        let message = '注：单选题需勾选一个正确选项，多选题需要勾选两个以上正确选项，判断选对错。'
        this.$message.error(message)
        return false
      }

      if (validOk) {
        this.$emit('ok', okform)
      } else {
        return false
      }
    },
    verificationprecautions(answerList) {
      let quesType = this.form.questionType
      // 单选题需勾选一个正确选项，多选题需要勾选两个以上正确选项，判断选对错。
      let maxright = 0
      switch (quesType) {
        case '0': // 单选
          maxright = 1
          break
        case '1': // 多选
          maxright = 2
          break
        case '2': // 判断
          maxright = 1
          break
        default:
          break
      }
      let isRightArr = []
      answerList.forEach((element) => {
        let { isRight } = element
        if (isRight == 1) {
          isRightArr.push(isRight)
        }
      })
      if (isRightArr.length < maxright) {
        return false
      } else {
        return true
      }
    },
    modalCancel() {
      this.resetForm()
      this.$emit('cancel')
    },
    resetForm() {
      this.$refs.ruleForm && this.$refs.ruleForm.resetFields()
      this.form = {
        questionCategoryId: undefined,
        questionCategoryName: undefined,
        questionType: undefined,
        questionContent: undefined,
        analysis: '',
      }
      this.defaultAnsList = []
    },
  },
  beforeDestroy() {
    this.resetForm()
  },
}
</script>

<style lang="less" scoped>
/deep/.ant-input-number {
  width: 100% !important;
}
</style>