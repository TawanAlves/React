<template>
  <!-- 安全教育线上考试管理 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline" :label-col="{ span: 7 }" :wrapper-col="{ span: 15 }">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="考试名称">
                <a-input v-model="queryParam.examName" placeholder="考试名称" />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="状态">
                <a-select v-model="queryParam.status" placeholder="状态">
                  <a-select-option :key="1">未发布</a-select-option>
                  <a-select-option :key="0">已发布</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="考试日期">
                <a-range-picker
                  valueFormat="YYYY-MM-DD HH:mm:ss"
                  format="YYYY-MM-DD"
                  style="width: 100%; min-width: 110px"
                  v-model="queryParam.time"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button
            type="primary"
            icon="plus"
            @click="addRecord"
            v-if="permission.offline_exam_add"
          >新建</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :showIndexColumn="true"
        :scroll="{y: `calc(100vh - 432px)`, x: 1110}"
      >
        <span slot="action" slot-scope="text, record">
          <template>
            <a
              @click="publishRecord(record, 0)"
              v-if="record.status !== 0  && userInfo.id === record.gmtCreateId"
            >发布</a>
            <a @click="checkRecord(record)" v-if="record.status === 0">查看</a>
            <a-divider
              type="vertical"
              v-if="record.status !== 0  && userInfo.id === record.gmtCreateId"
            />
            <a
              @click="editRecord(record)"
              v-if=" record.status !== 0  && userInfo.id === record.gmtCreateId"
            >编辑</a>
            <a-divider
              type="vertical"
              v-if="record.status !== 0  && userInfo.id === record.gmtCreateId"
            />
            <a
              @click="removeRecord(record, 2)"
              v-if=" record.status !== 0  && userInfo.id === record.gmtCreateId"
            >删除</a>
          </template>
        </span>
      </s-table>
    </a-card>
    <offline-exam-modal
      :visible.sync="commonVisible"
      :disabled="commonDisabled"
      :model="commonData"
      :loading="confirmLoading"
      :modal-title="commonTitle"
      @ok="modalOk"
    />
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { OfflineExamColumns } from './columns'
import { mapGetters } from 'vuex'
import OfflineExamModal from './component/OfflineExamModal'
import URLS from '@/api/exam-url'
import moment from 'moment'
export default {
  components: {
    STable,
    OfflineExamModal
  },
  data() {
    return {
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
        isOnline: 1
      },
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        const params = {
          ...this.queryParam
        }
        if (params.time && params.time.length > 0) {
          params.examStartTime = params.time[0]
          params.examEndTime = params.time[1]
          delete params.time
        }
        return this.submitForm(URLS.examList, params, 'post', { params: requestParameters }).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      }
    }
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => OfflineExamColumns
  },
  methods: {
    initFormData() {
      this.commonData = {
        userList: [],
        userId: this.userInfo.id,
        gmtCreateId: this.userInfo.id,
        createName: this.userInfo.realName,
        deptName: this.userInfo.deptName,
        createTime: moment(new Date()).format('YYYY-MM-DD')
      }
    },
    commonInit() {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      this.initFormData()
    },
    searchReset() {
      this.queryParam = {
        isOnline: 1
      }
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    addRecord() {
      this.commonTitle = '新增数据'
      this.initFormData()
      this.commonVisible = true
      this.commonDisabled = false
    },
    checkRecord(record) {
      this.commonTitle = '查看数据'
      this.loadRecordData(record.id, () => {
        this.commonVisible = true
        this.commonDisabled = true
      })
    },
    editRecord(record) {
      this.commonTitle = '编辑数据'
      this.loadRecordData(record.id, () => {
        this.commonVisible = true
        this.commonDisabled = false
      })
    },
    loadRecordData(id, callback) {
      this.getById(URLS.examDetail, id).then(({ data, success }) => {
        if (success) {
          data.createTime = moment(data.createTime).format('YYYY-MM-DD')
          data.examStartTime = moment(data.examStartTime).format('YYYY-MM-DD')
          this.commonData = data
          callback && callback()
        }
      })
    },
    removeRecord(record, status) {
      this.showDeleteConfirm(record, status)
    },
    modalCancel() {
      this.commonInit()
    },
    modalOk({ formData }) {
      let url = ''
      if (this.isNotNullOrUndefined(this.commonData.id)) {
        formData.id = this.commonData.id
        formData.status = this.commonData.status
        url = URLS.examUpdate
      } else {
        formData.status = 1
        url = URLS.examAdd
      }
      const params = {
        ...formData,
        isOnline: 1,
        createTime: moment(formData.createTime).format('YYYY-MM-DD HH:mm:ss'),
        examStartTime: moment(formData.examStartTime).format('YYYY-MM-DD HH:mm:ss')
      }
      this.submitForm(url, params, 'post', {
        // headers: { 'Content-Type': 'multipart/form-data' }
      }).then(res => {
        this.$refs.table.refresh()
        this.$refs.table.clearSelected()
        this.commonInit()
      })
    },
    publishRecord(record, status) {
      const url = `${URLS.examStatus}?id=${record.id}&status=${status}`
      this.getList(url).then(({ success, msg }) => {
        if (success) {
          this.$message.success(`操作成功`)
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
        } else {
          this.$message.error(`${msg}`)
        }
      })
    },
    showDeleteConfirm(record, status) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.publishRecord(record, status)
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    },
    initSelect() {}
  },
  created() {
    this.initSelect()
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>
