<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :bodyStyle="{ paddingBottom: 0 }">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="名称">
                <a-input
                  v-model="queryParam.trainName"
                  @blur="() => {$refs.trainName.onFieldBlur();}"
                  placeholder="名称"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="状态">
                <a-select
                  show-search
                  v-model="queryParam.planStatus"
                  placeholder="状态"
                  style="width: 100%"
                >
                  <a-select-option
                    v-for="d in planStatusNameOptions"
                    :key="d.dictKey"
                  >{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="8" :md="8" :sm="12" :xs="24">
              <a-form-item label="创建日期">
                <a-range-picker
                  show-time
                  format="YYYY-MM-DD"
                  @change="onChange1"
                  v-model="queryParam.createTime1"
                  style="width: 100%;min-width: 110px;"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="4" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="card-right">
          <a-button
            type="primary"
            icon="plus"
            v-if="permission.orientationplan_add"
            @click="addRecord"
            style="float:right"
          >新建</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: `calc(100vh - 432px)`, x: 1440 }"
        :showIndexColumn="true"
      >
        <!-- 序号 -->
        <!-- <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>-->
        <!-- 序号 end -->
        <template slot="planStatus" slot-scope="text, record">
          <a-tag :color="record.planStatus | colorFilter" style="margin-right: 0 !important">
            {{
            record.planStatus | textFilter
            }}
          </a-tag>
        </template>
        <span slot="action" slot-scope="text, record">
          <template>
            <a
              @click="editRecord(record)"
              v-if=" record.planStatus === 0 && userInfo.id === record.gmtCreateId && permission.orientationplan_edit"
            >编辑</a>
            <a-divider
              type="vertical"
              v-if="record.planStatus === 0 && userInfo.id === record.gmtCreateId && permission.orientationplan_edit"
            />
            <a @click="checkRecord(record)">查看</a>
            <a-divider
              type="vertical"
              v-if="record.planStatus === 0 && userInfo.id === record.gmtCreateId"
            />
            <a
              @click="publishRecord(record, 1)"
              v-if="record.planStatus === 0 && userInfo.id === record.gmtCreateId && permission.orientationplan_publish"
            >提交</a>
            <a-divider
              type="vertical"
              v-if="record.planStatus === 0 && userInfo.id === record.gmtCreateId && permission.orientationplan_publish"
            />
            <a
              @click="removeRecord(record)"
              v-if=" record.planStatus === 0 && userInfo.id === record.gmtCreateId && permission.orientationplan_remove"
            >删除</a>
            <a-divider
              type="vertical"
              v-if="record.planStatus === 2 && userInfo.id === record.gmtCreateId && permission.orientationplan_remove"
            />
            <a
              @click="signInRecord(record)"
              v-if=" record.planStatus === 2 && userInfo.id === record.gmtCreateId"
            >签到</a>
          </template>
        </span>
      </s-table>
      <a-modal
        :title="commonTitle"
        :visible="commonVisible"
        :confirm-loading="confirmLoading"
        width="900px"
        height="600px"
        :ok-button-props="{ props: { disabled: commonDisabled } }"
        @ok="modalOk(commonData)"
        @cancel="handleCancel"
        :keyboard="false"
        :maskClosable="false"
      >
        <a-form-model
          ref="ruleForm"
          :model="commonData"
          :rules="rules"
          :label-col="labelCol"
          :wrapper-col="wrapperCol"
        >
          <div>
            <a-row :gutter="24">
              <a-col :span="24">
                <a-form-model-item
                  ref="trainName"
                  label="培训名称"
                  prop="trainName"
                  :label-col="{ span: 4 }"
                  :wrapper-col="{ span: 19 }"
                >
                  <a-input
                    placeholder="培训名称"
                    :max-length="32"
                    :disabled="commonDisabled"
                    v-model="commonData.trainName"
                    @blur="() => {$refs.trainName.onFieldBlur();}"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainTypeId" label="培训类型" prop="trainTypeId">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.trainTypeId"
                    placeholder="培训类型"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in trainTypeNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="orgUnitId" label="培训组织单位" prop="orgUnitId">
                  <a-tree-select
                    :disabled="commonDisabled"
                    v-model="commonData.orgUnitId"
                    show-search
                    style="width: 100%"
                    :dropdown-style="{ maxHeight: '400px', overflow: 'auto' }"
                    :tree-data="torgUnitNameOptions"
                    placeholder="培训组织单位"
                    allow-clear
                    tree-default-expand-all
                    @change="orgUnitIdChange"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainLevelId" label="培训级别" prop="trainLevelId">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.trainLevelId"
                    placeholder="培训级别"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in trainLeveNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainWay" label="培训形式" prop="trainWay">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.trainWay"
                    placeholder="培训形式"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in trainWayNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainPeriod" label="学时" prop="trainPeriod">
                  <a-input-number
                    placeholder="学时"
                    :disabled="commonDisabled"
                    min="0"
                    v-model="commonData.trainPeriod"
                    @blur="() => {$refs.trainPeriod.onFieldBlur();}"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="isExam" label="是否需要考试" prop="isExam">
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.isExam"
                    placeholder="是否需要考试"
                    style="width: 100%"
                  >
                    <a-select-option
                      v-for="d in isExamNameOptions"
                      :key="d.dictKey"
                    >{{ d.dictValue }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainStartDate" label="培训开始日期" prop="trainStartDate">
                  <a-date-picker
                    :disabled="commonDisabled"
                    v-model="commonData.trainStartDate"
                    format="YYYY-MM-DD"
                    @change="onChange2"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="12">
                <a-form-model-item ref="trainEndDate" label="培训结束日期" prop="trainEndDate">
                  <a-date-picker
                    :disabled="commonDisabled"
                    v-model="commonData.trainEndDate"
                    format="YYYY-MM-DD"
                    @change="onChange3"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="24">
                <a-form-model-item
                  ref="trainDesc"
                  label="培训介绍"
                  prop="trainDesc"
                  :label-col="{ span: 4 }"
                  :wrapper-col="{ span: 19 }"
                >
                  <a-textarea
                    :max-length="254"
                    :disabled="commonDisabled"
                    placeholder="培训介绍"
                    v-model="commonData.trainDesc"
                    :rows="4"
                  />
                </a-form-model-item>
              </a-col>
              <a-col :span="24">
                <a-form-model-item
                  ref="roleId"
                  label="审批人"
                  prop="roleId"
                  :label-col="{ span: 4 }"
                  :wrapper-col="{ span: 19 }"
                >
                  <a-select
                    :disabled="commonDisabled"
                    show-search
                    v-model="commonData.roleId"
                    placeholder="审批人"
                    style="width: 100%"
                    @change="changePeople"
                  >
                    <a-select-option v-for="d in postNameOptions" :key="d.id">{{ d.realName }}</a-select-option>
                  </a-select>
                </a-form-model-item>
              </a-col>
            </a-row>
            <a-row>
              <a-col :span="24" class>
                <div>
                  <span>培训内容</span>
                  <a-button
                    class="addBtn"
                    type="primary"
                    @click="addCourseware"
                    :disabled="commonDisabled"
                  >添加课件</a-button>
                </div>
                <a-table
                  :columns="coursewareColumns"
                  :pagination="false"
                  :data-source="coursewareList"
                >
                  <span slot="speakId" slot-scope="text, record" style="width:100%;">
                    <PersonListSelect
                      @change="personChange"
                      v-model="record.speakId"
                      :disabled="commonDisabled"
                    ></PersonListSelect>
                  </span>
                  <span slot="dateList" slot-scope="text, record">
                    <a-range-picker
                      show-time
                      :disabled="commonDisabled"
                      :disabled-date="disabledDate"
                      format="YYYY-MM-DD HH:mm:ss"
                      v-model="record.dateList"
                    />
                  </span>
                  <span slot="action" slot-scope="text, record">
                    <a @click="deleteCourseware(record)">删除</a>
                  </span>
                </a-table>
              </a-col>
              <a-col :span="24">
                <div>
                  <span>培训对象</span>
                  <a-button
                    class="addBtn"
                    type="primary"
                    @click="addPeople"
                    :disabled="commonDisabled"
                  >添加人员</a-button>
                </div>
                <a-table
                  :columns="userColumns"
                  :pagination="false"
                  :data-source="userList"
                  :scroll="{ y: `200px` }"
                >
                  <span slot="action" slot-scope="text, record">
                    <a @click="deletePeople(record)">删除</a>
                  </span>
                </a-table>
              </a-col>
            </a-row>
          </div>
        </a-form-model>
      </a-modal>
      <a-modal @cancel="handleCancel" width="500px" :visible="codeVisible" :footer="null">
        <div id="qrcode">
          <vue-qr ref="qr" :logoSrc="imageUrl" :text="qrText" :size="400"></vue-qr>
        </div>
        <div style="text-align:right;">
          <a-button type="primary" @click="saveCode(qrId)">保存到本地</a-button>
        </div>
      </a-modal>
      <CoursewareSelectModal
        :visible.sync="coursewareVisible"
        :loading="confirmLoadingCourseware"
        @ok="submitCourseware"
        title="添加课件"
        :dept-id="workUnitId"
        :multiple="true"
      />
      <person-select-modal
        :visible.sync="peopleVisible"
        :loading="confirmLoadingPeople"
        @ok="submitPeople"
        title="添加人员"
        :dept-id="workUnitId"
        :multiple="true"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { orientationplan } from '@/views/safety/table'
import ApiURLs from '@/api/urls'
import URLS from '@/api/exam-url'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'
import { getDict } from '@/api/system'
import { getPersonnelTree } from '@/api/safety'
import { getUsers } from '@/api/system'
import PersonSelectModal from '@/views/safety/task/component/PersonSelectModal'
import CoursewareSelectModal from '@/views/safety/task/component/CoursewareSelectModal'
import PersonListSelect from '@/views/safety/components/PersonListSelect'
import vueQr from 'vue-qr'
import moment from 'moment'

export default {
  name: 'orientationplan',
  components: {
    STable,
    PersonSelectModal,
    CoursewareSelectModal,
    PersonListSelect,
    vueQr
  },
  data() {
    return {
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },

      codeVisible: false,
      imageUrl: require('@/assets/tianyuan.png'),
      qrText: '',
      qrId: '',

      coursewareColumns: [
        {
          title: '课件名称',
          dataIndex: 'coursewareName',
          key: 'coursewareName',
          align: 'center'
        },
        {
          title: '授课人',
          dataIndex: 'speakId',
          key: 'speakId',
          scopedSlots: { customRender: 'speakId' },
          align: 'center',
          width: 200
        },
        {
          title: '培训时间',
          dataIndex: 'dateList',
          key: 'dateList',
          scopedSlots: { customRender: 'dateList' },
          align: 'center'
        },
        {
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        }
      ],
      userColumns: [
        {
          title: '姓名',
          dataIndex: 'userName',
          key: 'realName',
          align: 'center'
        },
        {
          title: '岗位',
          dataIndex: 'deptName',
          key: 'deptName',
          align: 'center'
        },
        {
          title: '部门',
          dataIndex: 'deptName',
          key: 'deptName',
          align: 'center'
        },
        {
          title: '签到时间',
          dataIndex: 'signTime',
          key: 'signTime',
          align: 'center'
        },
        {
          title: '是否参与',
          dataIndex: 'isJoin',
          key: 'isJoin',
          align: 'center',
          scopedSlots: {
            customRender: 'isJoin'
          },
          customRender: text => {
            if (text == 0) {
              return '否'
            }
            if (text == 1) {
              return '是'
            }
          }
        },
        {
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        }
      ],
      peopleVisible: false,
      confirmLoadingPeople: false,
      coursewareVisible: false,
      confirmLoadingCourseware: false,

      planStatusNameOptions: [
        {
          dictKey: 0,
          id: '',
          dictValue: '未提交'
        },
        {
          dictKey: 1,
          id: '',
          dictValue: '待审批'
        },
        {
          dictKey: 2,
          id: '',
          dictValue: '已审批'
        },
        {
          dictKey: 3,
          id: '',
          dictValue: '已驳回'
        }
      ],
      trainTypeNameOptions: [],
      torgUnitNameOptions: [],
      trainLeveNameOptions: [],
      trainWayNameOptions: [
        {
          dictKey: 0,
          id: '',
          dictValue: '线上培训'
        },
        {
          dictKey: 1,
          id: '',
          dictValue: '线下培训'
        }
      ],
      postNameOptions: [],
      isExamNameOptions: [
        {
          dictKey: 0,
          id: '',
          dictValue: '否'
        },
        {
          dictKey: 1,
          id: '',
          dictValue: '是'
        }
      ],

      labelCol: { span: 8 },
      wrapperCol: { span: 14 },
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonDisabled: false,
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      userInfo: getStore({ name: 'info' }),
      rules: {
        trainName: [{ required: true, message: '请填写培训名称', trigger: 'blur' }],
        trainTypeId: [{ required: true, message: '请选择培训类型', trigger: 'change' }],
        orgUnitId: [{ required: true, message: '请选择培训组织单位', trigger: 'change' }],
        trainLevelId: [{ required: true, message: '请选择培训级别', trigger: 'change' }],
        trainWay: [{ required: true, message: '请选择培训形式', trigger: 'change' }],
        trainPeriod: [{ required: false, message: '请填写学时', trigger: 'blur' }],
        isExam: [{ required: true, message: '请选择是否需要考试', trigger: 'change' }],
        trainStartDate: [{ required: true, message: '请选择培训开始日期', trigger: 'change' }],
        trainEndDate: [{ required: true, message: '请选择培训结束日期', trigger: 'change' }],
        roleId: [{ required: true, message: '请选择审批人', trigger: 'change' }]
      },
      coursewareList: [],
      userList: [],
      commonData: {
        roleId: '',
        roleName: '',
        coursewareList: [],
        gmtCreateId: '',
        createTime1: '',
        creditHour: '',
        examId: '',
        id: '',
        isExam: '',
        orgUnitId: '',
        orgUnitName: '',
        planStatus: '',
        status: '',
        trainDesc: '',
        trainEndDate: '',
        trainLevelId: '',
        trainLevelName: '',
        trainName: '',
        trainPeriod: '',
        trainStartDate: '',
        trainTypeId: '',
        trainTypeName: '',
        trainWay: '',
        updateBy: '',
        updateTime: '',
        userList: []
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        if (this.queryParam.createTime1) {
          // this.$delete(this.queryParam,'createTime1');
          ;(this.queryParam.trainStartDate = this.dayjs(this.queryParam.createTime1[0]).format('YYYY-MM-DD 00:00:00')),
            (this.queryParam.trainEndDate = this.dayjs(this.queryParam.createTime1[1]).format('YYYY-MM-DD 23:59:59'))
        }
        return this.submitForm(ApiURLs.orientationplanList, this.queryParam, 'post', {
          params: requestParameters
        }).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      }
    }
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => orientationplan,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['orange', 'orange', 'green', 'red']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['未提交', '待审批', '已审批', '已驳回']
      return textList[value]
    }
  },
  methods: {
    moment,
    //根据选择的培训开始时间/结束时间，动态渲染要禁用的培训时间
    disabledDate(current) {
      let trainEndDate = moment(this.commonData.trainEndDate, 'YYYY-MM-DD').valueOf()
      return (
        current < moment(new Date(this.commonData.trainStartDate), 'YYYY-MM-DD') ||
        current >= moment(new Date(trainEndDate + 86400000), 'YYYY-MM-DD')
      )
    },
    onChange2(date, dateString) {
      this.commonData.trainStartDate = dateString
      this.coursewareList.forEach(item => {
        item.dateList = []
      })
    },
    onChange3(date, dateString) {
      this.commonData.trainEndDate = dateString
      this.coursewareList.forEach(item => {
        item.dateList = []
      })
    },
    //签到
    signInRecord(data) {
      this.qrId = data.id
      this.qrText = process.env.VUE_APP_API_BASE_URL + '/spang-edu/admin/train/user/sign?trainId=' + data.id
      // this.qrText = 'http://172.17.30.61:9000/spang-edu/admin/train/user/sign?trainId=' + data.id
      this.axios
        .get('/spang-edu/admin/train/plan/checkSign', {
          params: {
            trainId: data.id
          }
        })
        .then(rs => {
          if (rs.code === 200) {
            this.codeVisible = true
          } else {
            this.$message.warning('您没有权限')
          }
        })
    },
    //保存二维码
    saveCode(data) {
      const fileName = data + 'png'
      let img = document.getElementById('qrcode').getElementsByTagName('img')[0].src

      let aLink = document.createElement('a')
      let blob = this.base64ToBlob(img)
      let evt = document.createEvent('HTMLEvents')
      evt.initEvent('click', true, true) // initEvent 不加后两个参数在FF下会报错  事件类型，是否冒泡，是否阻止浏览器的默认行为
      aLink.download = fileName
      aLink.href = URL.createObjectURL(blob)
      // aLink.dispatchEvent(evt);
      aLink.click()
    },
    //base64转blob
    base64ToBlob(code) {
      let parts = code.split(';base64,')
      let contentType = parts[0].split(':')[1]
      let raw = window.atob(parts[1])
      let rawLength = raw.length
      let uInt8Array = new Uint8Array(rawLength)
      for (let i = 0; i < rawLength; ++i) {
        uInt8Array[i] = raw.charCodeAt(i)
      }
      return new Blob([uInt8Array], { type: contentType })
    },
    //新建
    addRecord() {
      this.commonTitle = '新增数据'
      this.commonVisible = true
      this.commonDisabled = false
      this.commonData = {}
      this.coursewareList = []
      this.userList = []
      if (this.coursewareColumns.length === 3) {
        this.coursewareColumns.push({
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        })
      }
      if (this.userColumns.length === 5 || this.userColumns.length === 3) {
        this.userColumns.push({
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        })
      }
      this.userColumns = this.userColumns.filter(item => item.title !== '签到时间')
      this.userColumns = this.userColumns.filter(item => item.title !== '是否参与')
    },
    //保存
    modalOk(data) {
      this.commonData.coursewareList = this.coursewareList
      this.commonData.userList = this.userList
      this.trainTypeNameOptions.forEach(item => {
        if (this.commonData.trainTypeId === item.dictKey) {
          this.commonData.trainTypeName = item.dictValue
        }
      })
      this.trainLeveNameOptions.forEach(item => {
        if (this.commonData.trainLevelId === item.dictKey) {
          this.commonData.trainLevelName = item.dictValue
        }
      })
      this.postNameOptions.forEach(item => {
        if (this.commonData.roleId === item.id || this.commonData.roleId === item.realName) {
          this.commonData.roleName = item.realName
          this.commonData.roleId = item.id
        }
      })

      this.getTreeName(this.torgUnitNameOptions, this.commonData.orgUnitId)
      //删除某个元素
      this.commonData.userList.forEach(item => {
        this.$delete(item, 'deptId')
        this.$delete(item, 'postId')
      })

      this.$refs.ruleForm.validate(valid => {
        if (valid) {
          if (this.commonData.coursewareList.length === 0) {
            this.$message.warning('至少选择一个课件')
          } else if (this.commonData.userList.length === 0) {
            this.$message.warning('至少选择一个人员')
          } else {
            let url = data.id ? '/spang-edu/admin/train/plan/updateInfo' : '/spang-edu/admin/train/plan/insert'
            for (let item of this.commonData.coursewareList) {
              if (item.speakId === undefined) {
                this.$message.warning('请将授课人填写完整')
                continue
              } else if (item.dateList === undefined || item.dateList.length === 0) {
                this.$message.warning('请将培训时间填写完整')
                continue
              } else {
                this.commonData.coursewareList.forEach(item1 => {
                  item1.coursewareStartDate = this.dayjs(item1.dateList[0]).format('YYYY-MM-DD HH:mm:ss')
                  item1.coursewareEndDate = this.dayjs(item1.dateList[1]).format('YYYY-MM-DD HH:mm:ss')
                  item1.dateList = [item1.coursewareStartDate, item1.coursewareEndDate]
                })

                var commonData = {
                  ...this.commonData,
                  trainStartDate: this.commonData.trainStartDate + ' 00:00:00',
                  trainEndDate: this.commonData.trainEndDate + ' 23:59:59',
                  trainWay: this.commonData.trainWay === '线上培训' || this.commonData.trainWay == 0 ? 0 : 1
                }
                this.axios.post(url, commonData).then(rs => {
                  if (rs.code === 200) {
                    this.commonVisible = false
                    this.$refs.table.refresh()
                  }
                })
                break
              }
            }
          }
        } else {
          console.log('error submit!!')
          return false
        }
      })
    },
    personChange(data) {
      console.log(data)
    },
    //根据单位ID查询单位名称
    getTreeName(list, id) {
      let _this = this
      for (let i = 0; i < list.length; i++) {
        let a = list[i]
        if (a.id == id) {
          _this.commonData.orgUnitName = a.title
          // return a.title
        } else {
          if (a.children && a.children.length > 0) {
            let res = _this.getTreeName(a.children, id)
            if (res) {
              return res
            }
          }
        }
      }
    },
    //重置
    searchReset() {
      this.queryParam = {}
      this.$refs.table.refresh(true)
    },

    //点击添加人员
    addPeople() {
      this.peopleVisible = true
    },
    //添加人员确定
    submitPeople(data) {
      let arrs = [...data, ...this.userList]
      //根据id去重
      let map = new Map()
      for (let item of arrs) {
        if (!map.has(item.userId)) {
          map.set(item.userId, item)
        }
      }
      let newArr = [...map.values()]
      this.userList = newArr
    },

    //删除人员
    deletePeople(data) {
      var arr = []
      this.userList.forEach(item => {
        if (item.userId !== data.userId) {
          arr.push(item)
        }
      })
      this.userList = arr
    },

    //关闭弹框
    handleCancel() {
      this.commonVisible = false
      this.codeVisible = false
    },
    //人员选择弹框确定
    peopleModalOk() {},
    //关闭人员选择弹框
    closePeopleModel() {
      this.peopleVisible = false
    },
    //点击添加课件
    addCourseware() {
      this.coursewareVisible = true
    },
    //添加课件确定
    submitCourseware(data) {
      let arrs = [...data, ...this.coursewareList]
      //根据id去重
      let map = new Map()
      for (let item of arrs) {
        if (!map.has(item.id)) {
          map.set(item.id, item)
        }
      }
      let newArr = [...map.values()]
      this.coursewareList = newArr
    },
    //删除课件
    deleteCourseware(data) {
      var arr = []
      this.coursewareList.forEach(item => {
        if (item.id !== data.id) {
          arr.push(item)
        }
      })
      this.coursewareList = arr
    },

    //提交
    publishRecord(data) {
      var arr = []
      arr.push(data.id)
      this.axios
        .post('/spang-edu/admin/train/plan/updateStatus', arr, {
          params: {
            planStatus: 1
          }
        })
        .then(rs => {
          if (rs.code === 200) {
            this.$message.success('提交成功')
            this.$refs.table.refresh()
          }
        })
    },
    //删除
    removeRecord(data) {
      this.showDeleteConfirm(data)
    },
    showDeleteConfirm(data) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          var deleteData = []
          deleteData.push(data.id)
          _this.axios.post('/spang-edu/admin/train/plan/deleteStatus', deleteData).then(rs => {
            if (rs.code === 200) {
              _this.$message.success('删除成功')
              _this.selectedRows = []
              _this.selectedRowKeys = []
              _this.$refs.table.refresh()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    },
    //查看
    checkRecord(data) {
      this.commonTitle = '查看数据'
      this.commonDisabled = true
      this.getDetails(data)
      this.coursewareColumns = this.coursewareColumns.filter(item => item.title !== '操作')
      this.userColumns = this.userColumns.filter(item => item.title !== '操作')
      if (data.planStatus !== 2) {
        this.userColumns = this.userColumns.filter(item => item.title !== '签到时间')
        this.userColumns = this.userColumns.filter(item => item.title !== '是否参与')
      } else if (this.userColumns.length === 3) {
        this.userColumns.push(
          {
            title: '签到时间',
            dataIndex: 'signTime',
            key: 'signTime',
            align: 'center'
          },
          {
            title: '是否参与',
            dataIndex: 'isJoin',
            key: 'isJoin',
            align: 'center',
            scopedSlots: {
              customRender: 'isJoin'
            },
            customRender: text => {
              if (text == 0) {
                return '否'
              }
              if (text == 1) {
                return '是'
              }
            }
          }
        )
      }
    },
    //编辑
    editRecord(data) {
      this.commonTitle = '编辑数据'
      this.commonDisabled = false
      this.getDetails(data)
      if (this.coursewareColumns.length === 3) {
        this.coursewareColumns.push({
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        })
      }
      if (this.userColumns.length === 5 || this.userColumns.length === 3) {
        this.userColumns.push({
          title: '操作',
          key: 'action',
          scopedSlots: { customRender: 'action' }
        })
      }
      if (data.planStatus !== 2) {
        this.userColumns = this.userColumns.filter(item => item.title !== '签到时间')
        this.userColumns = this.userColumns.filter(item => item.title !== '是否参与')
      }
    },
    //详情
    getDetails(data) {
      this.commonVisible = true
      this.axios
        .get('/spang-edu/admin/train/plan/selectBase', {
          params: {
            id: data.id
          }
        })
        .then(rs => {
          if (rs.code === 200) {
            var data = {
              ...rs.data,
              roleId: rs.data.approveList[0].roleName
            }
            this.commonData = data
            this.getPersonnelList(this.commonData.orgUnitId)
            this.commonData.trainWay = this.commonData.trainWay == 0 ? '线上培训' : '线下培训'
            this.coursewareList = rs.data.coursewareList
            this.coursewareList.forEach(item => {
              item.dateList = item.dateList
            })
            this.userList = rs.data.trainUserList
          }
        })
    },
    // changePeople(data) {
    //   this.commonData.roleId = data
    // },
    //根据单位查询人员
    orgUnitIdChange(data) {
      this.$set(this.commonData, 'roleId', '')
      this.getPersonnelList(data)
    },
    getPersonnelList(data) {
      this.axios
        .get('/spang-system/getUserListWithBizCode', {
          params: {
            bizCode: 'TRAIN_PLAN_APPROVE',
            deptId: data
          }
        })
        .then(rs => {
          this.postNameOptions = rs.data
        })
    }
  },
  created() {
    //状态
    // this.getDict('plan_status').then(({ data, success }) => {
    //   if (success) {
    //     this.planStatusNameOptions = data
    //   }
    // })
    //培训类型
    this.getDict('train_type').then(({ data, success }) => {
      if (success) {
        this.trainTypeNameOptions = data
      }
    })
    //培训级别
    this.getDict('train_level').then(({ data, success }) => {
      if (success) {
        this.trainLeveNameOptions = data
      }
    })
    //培训形式
    // this.getDict('train_way').then(({ data, success }) => {
    //   if (success) {
    //     this.trainWayNameOptions = data;
    //   }
    // })
    //培训组织单位
    getPersonnelTree(0).then(res => {
      this.torgUnitNameOptions = res.data
    })
    //审批人
    // getUsers().then(res => {
    //   this.postNameOptions = res.data
    // })
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}
/deep/ .ant-calendar-picker {
  width: 100%;
}
/deep/.ant-btn-primary[disabled] {
  display: none !important;
}
/deep/ .ant-form-item-label {
  width: 138px;
}
/deep/ .ant-col-14 {
  width: calc(100% - 178px) !important;
}
.ant-input-number {
  width: 100%;
}
.card-title {
  display: flex;
  justify-content: space-between;
}
.quill-editor {
  height: 200px;
}
.ant-col-24 {
  > div {
    margin-top: 10px;
  }
  span {
    display: inline-block;
    margin-right: 10px;
  }
}
img {
  width: 100%;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
// .addBtn {
//   border-radius: 16px;
// }
</style>
