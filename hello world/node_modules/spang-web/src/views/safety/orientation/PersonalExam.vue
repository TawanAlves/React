<template>
  <!-- 安全教育个人考试 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline" :label-col="{ span: 7 }" :wrapper-col="{ span: 15 }">
          <a-row :gutter="24">
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="考试名称">
                <a-input v-model="queryParam.examName" placeholder="考试名称" />
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="状态">
                <a-select v-model="queryParam.examStatus" placeholder="状态">
                  <a-select-option v-for="val in statusOptions" :key="val.id">{{ val.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :bodyStyle="{paddingBottom: 0, paddingTop: '20px'}"
      class="table-card"
    >
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.examId"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :showIndexColumn="true"
        :scroll="{y: 'calc(100vh - 432px)',x: 1200}"
      >
        <span
          slot="examType"
          slot-scope="text, record"
        >{{ record.examType | examTypeFilter(examTypeOptions) }}</span>
        <span slot="viewRecord" slot-scope="text, record">
          <a @click="previewListPaper(record)" v-if="record.examResult != 0">查看阅卷</a>
        </span>
        <span slot="examResult" slot-scope="text, record">
          <template v-if="record.examResult === 0"></template>
          <template v-if="record.examResult === 1">
            <a-tag color="red">不及格</a-tag>
          </template>
          <template v-if="record.examResult === 2">
            <a-tag color="green">及格</a-tag>
          </template>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="enterExam(record)" v-if="canEnterExam(record)">进入考试</a>
          </template>
        </span>
      </s-table>
    </a-card>
    <a-modal
      :title="examTipModalContent.examName"
      :visible="examTipModalVisible"
      @cancel="examTipModalVisible = false"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-descriptions :column="2" :colon="true">
        <template v-if="examTipModalContent.canExam">
          <a-descriptions-item label="考试次数">第{{ examTipModalContent.examCount }}次</a-descriptions-item>
          <a-descriptions-item label="考试时长">{{ examTipModalContent.examDuration }}分钟</a-descriptions-item>
          <a-descriptions-item label="考试须知" :span="2">{{examTipModalContent.examExplain}}</a-descriptions-item>
        </template>
        <template v-else>
          <a-descriptions-item label="考试结果">
            <template v-if="examTipModalContent.examResult === 0">缺考</template>
            <template v-if="examTipModalContent.examResult === 1">未通过</template>
            <template v-if="examTipModalContent.examResult === 2">通过</template>
          </a-descriptions-item>
          <a-descriptions-item label="考试成绩">{{ examTipModalContent.examScore }}分</a-descriptions-item>
        </template>
      </a-descriptions>
      <h3 class="text-center" v-if="examTipModalContent.canExam">请确认是否开始考试</h3>
      <h3
        class="text-center"
        v-if="!examTipModalContent.canExam && examTipModalContent.tipStatus === 1"
      >已超过考试次数，不允许再次考试</h3>
      <h3
        class="text-center"
        v-if="!examTipModalContent.canExam && (examTipModalContent.tipStatus === 0 || examTipModalContent.tipStatus === 2)"
      >考试结束</h3>

      <template slot="footer">
        <a-button @click="examTipModalVisible = false">取消</a-button>
        <a-button type="primary" @click="gotoExamPage" v-if="examTipModalContent.canExam">开始考试</a-button>
      </template>
    </a-modal>
    <a-modal
      width="60%"
      :title="null"
      :visible="previewModalVisible"
      @cancel="previewModalVisible = false"
      :footer="null"
      :keyboard="false"
      :maskClosable="false"
      :centered="true"
      :bodyStyle="{maxHeight:'800px',overflow:'auto'}"
      destroyOnClose
    >
      <div class="paper-title">{{ examInfo.examName }}</div>
      <a-form layout="inline">
        <a-row :gutter="24">
          <a-col :span="4">
            <a-form-item label="考试次数">第{{ examInfo.examCount }}次</a-form-item>
          </a-col>
          <a-col :span="6">
            <a-form-item label="考试时间">{{ examInfo.examTime }}</a-form-item>
          </a-col>
        </a-row>
      </a-form>
      <paper-preview
        :disabled="true"
        :show-answer="true"
        :checkboxScore="examQuestions.checkboxScore"
        :raidoScore="examQuestions.raidoScore"
        :judgeScore="examQuestions.judgeScore"
        :radioQuestions="examQuestions.radioQuestions"
        :checkboxQuestions="examQuestions.checkboxQuestions"
        :judgeQuestions="examQuestions.judgeQuestions"
      />
    </a-modal>
    <a-modal
      width="60%"
      title="考试记录"
      :visible="previewListModalVisible"
      @cancel="previewListModalVisible = false"
      :footer="null"
      :keyboard="false"
      :maskClosable="false"
    >
      <a-table
        size="default"
        :rowKey="record => record.examId"
        :columns="previewListColumns"
        :dataSource="previewList"
        :alert="false"
        :scroll="{ y: 350 }"
        :pagination="false"
      >
        <span slot="viewRecord" slot-scope="text, record">
          <a @click="previewPaper(record)">查看阅卷</a>
        </span>
      </a-table>
    </a-modal>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { PersonalExamPlan, previewListColumns } from './columns'
import { mapGetters } from 'vuex'
import URLS from '@/api/exam-url'
import PaperPreview from './PaperPreview'
import { formatTimeBySeconds } from '@/utils/util'
const statusOptions = [
  {
    id: '4',
    dictValue: '待考试'
  },
  {
    id: '2',
    dictValue: '已考试'
  },
  {
    id: '3',
    dictValue: '已过期'
  }
]
export default {
  name: 'PersonalExam',
  components: {
    STable,
    PaperPreview
  },
  data() {
    return {
      previewList: [],
      previewListModalVisible: false,
      previewModalVisible: false,
      examQuestions: {},
      examInfo: {},
      examTipModalContent: {
        count: 0,
        examDuration: 0,
        examExplain: null,
        canExam: true,
        examName: null
      },
      examTipModalVisible: false,
      statusOptions: statusOptions,
      examTypeOptions: [],
      queryParam: { examStatus: '4' },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        return this.submitForm(URLS.personelExamList, this.queryParam, 'post', { params: requestParameters }).then(
          res => {
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          }
        )
      },
      optionPrefix: [
        'A',
        'B',
        'C',
        'D',
        'E',
        'F',
        'G',
        'H',
        'I',
        'J',
        'K',
        'L',
        'M',
        'N',
        'O',
        'P',
        'Q',
        'R',
        'S',
        'T',
        'U',
        'V',
        'W',
        'X',
        'Y',
        'Z'
      ]
    }
  },
  computed: {
    ...mapGetters(['permission', 'userInfo']),
    columns: () => PersonalExamPlan,
    previewListColumns: () => previewListColumns
  },
  filters: {
    examTypeFilter(value, examTypeOptions) {
      const result = examTypeOptions.find(item => item.id === value)
      if (result) {
        return result.dictValue
      }
      return ''
    }
  },
  methods: {
    searchReset() {
      this.queryParam = { examStatus: '4' }
      this.$refs.table.refresh(true)
    },
    initSelect() {
      this.examTypeOptions = [
        {
          id: '1',
          dictValue: '正式考试'
        },
        {
          id: '2',
          dictValue: '模拟考试'
        }
      ]
    },
    previewListPaper(record) {
      this.getList(URLS.previewList, { examId: record.examId }).then(({ data, success }) => {
        if (success) {
          this.previewListModalVisible = true
          this.previewList = data
        }
      })
    },
    transformToArray(item) {
      if (item && Array.isArray(item)) {
        return item
      } else if (item) {
        return item.split(',').map(item => item.trim())
      } else {
        return []
      }
    },
    getRightAnswer(questionObj) {
      return questionObj.answerList
        .map((item, index) => {
          if (questionObj.questionType !== 2) {
            return { ...item, label: this.optionPrefix[index] }
          } else {
            return { ...item, label: item.content }
          }
        })
        .filter(item => item.isRight)
        .map(item => item.label)
        .join(',')
    },
    getUserAnswer(questionObj) {
      return questionObj.answerList
        .map((item, index) => {
          if (questionObj.questionType !== 2) {
            return { ...item, label: this.optionPrefix[index] }
          } else {
            return { ...item, label: item.content }
          }
        })
        .filter(item => {
          if (questionObj.questionType === 1) {
            return questionObj.userAnswer.includes(item.id)
          } else {
            return questionObj.userAnswer === item.id
          }
        })
        .map(item => item.label)
        .join(',')
    },
    getIsRight(questionObj) {
      const rightAnswer = questionObj.answerList
        .filter(item => item.isRight)
        .map(item => item.id)
        .sort()
        .join(',')
      if (questionObj.questionType === 1) {
        return rightAnswer === questionObj.userAnswer.sort().join(',')
      } else {
        return rightAnswer === questionObj.userAnswer
      }
    },
    previewPaper(record) {
      const params = { examId: record.examId, examCount: record.examCount }
      this.getList(URLS.previewPaper, params).then(({ success, data }) => {
        if (success) {
          this.previewModalVisible = true
          this.examInfo = {
            examName: data.examName,
            examCount: record.examCount,
            examTime: formatTimeBySeconds(data.examTime)
          }
          const radioQuestions = []
          const checkboxQuestions = []
          const judgeQuestions = []
          data.questionAnswerVos.forEach(item => {
            if (item.questionType === 1) {
              const userAnswer = this.transformToArray(item.userAnswer)
              item.userAnswer = userAnswer
            }
            item.rightAnswer = this.getRightAnswer(item)
            item.isRight = this.getIsRight(item)
            item.userAnswerContent = this.getUserAnswer(item)
            if (item.questionType === 0) {
              radioQuestions.push(item)
            } else if (item.questionType === 1) {
              checkboxQuestions.push(item)
            } else if (item.questionType === 2) {
              judgeQuestions.push(item)
            }
          })
          this.examQuestions = {
            raidoScore: data.singleChoiceScore,
            checkboxScore: data.multipleChoiceScore,
            judgeScore: data.judgeNumberScore,
            radioQuestions: radioQuestions,
            checkboxQuestions: checkboxQuestions,
            judgeQuestions: judgeQuestions
          }
        }
      })
    },
    canEnterExam(record) {
      const now = new Date().getTime()
      const startTime = new Date(record.examStartDate).getTime()
      const endTime = new Date(record.examEndDate).getTime()

      if (now < startTime || now > endTime) {
        return false
      }
      if (record.examResult === 2) {
        return false
      }
      return true
    },
    enterExam(record) {
      this.getList(URLS.checkExam, { examId: record.examId }).then(({ data, success, code }) => {
        const canExam = code === 200
        this.examTipModalContent = {
          ...data,
          canExam: canExam,
          tipStatus: code,
          examId: record.examId
        }
        this.examTipModalVisible = true
      })
    },
    gotoExamPage() {
      this.examTipModalVisible = false
      this.$router.push('/safety/orientation/personalExam/exam/' + this.examTipModalContent.examId)
      this.examTipModalContent = {}
    }
  },
  created() {
    this.initSelect()
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
.paper-title {
  text-align: center;
  font-size: 30px;
  font-weight: bolder;
}
/deep/ .ant-descriptions-item-label {
  vertical-align: top;
}
/deep/ .ant-descriptions-item-content {
  width: calc(100% - 83px);
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>
