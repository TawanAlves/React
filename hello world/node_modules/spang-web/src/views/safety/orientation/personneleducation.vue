<template>
  <!-- 人员教育台账 -->
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="姓名">
                <a-input v-model="queryParam.realName" placeholder="姓名" :maxLength="32" />
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24">
              <a-form-item label="部门">
                <DepartmentSelect
                  @change="departChange"
                  :value="queryParam.deptId"
                  placeholder="部门"
                  :disabled="isCompanyAdmin"
                />
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24"  class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="personEduResearch">查询</a-button>
                <a-button type="second" @click="personEduRefresh">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none'}"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <s-table
        ref="personEduTable"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: `calc(100vh - 395px)`, x: 250 }"
        :showIndexColumn="true"
      >
        <span slot="serial" slot-scope="text, record, index">{{ index + 1 }}</span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="educationCheck(record)">查看</a>
          </template>
        </span>
      </s-table>
      <personedu-modal
        ref="personeduModal"
        :modal-title="title"
        :visible="visible"
        :formData="formData"
        @ok="viewOk"
        @cancel="viewCancel"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import PersonEduApi from '@/api/personEduaccount'
import { personEduColumns } from './personeducation/table'
import personeduModal from './personeducation/personeduModal.vue'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import { getStore } from '@/utils/store'

export default {
  components: {
    STable,
    personeduModal,
    DepartmentSelect
  },
  data() {
    return {
      queryParam: { realName: '', deptId: undefined },
      loadData: parameter => {
        let requesturl = PersonEduApi.personEduList
        let method = 'GET'
        let requestparams = {
          params: { current: parameter.pageNo, size: parameter.pageSize, ...this.queryParam },
          data: {}
        }
        let config = {
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;'
          }
        }
        return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
          let data = res.data
          return {
            totalCount: data.total,
            totalPage: data.pages,
            pageNo: data.current,
            pageSize: data.size,
            data: data.records
          }
        })
      },
      // modal
      visible: false,
      title: '',
      userInfo: getStore({ name: 'info' }),
      roleCode: 'EDU_COMP_USER_LEDGER_ADMIN' // 角色code 可以进行部门筛选查询
    }
  },
  computed: {
    columns: () => personEduColumns,
    isCompanyAdmin() {
      const userRoleList = this.userInfo.roleCode.split(',')
      return userRoleList.indexOf(this.roleCode) < 0
    }
  },
  mounted() {
    this.personEduRefresh()
  },
  methods: {
    departChange(val) {
      this.queryParam.deptId = val.id
    },

    personEduResearch() {
      this.$refs.personEduTable.refresh(true)
      this.$refs.personEduTable.clearSelected()
    },
    personEduRefresh() {
      this.queryParam = { realName: '', deptId: undefined }
      this.$refs.personEduTable.refresh(true)
      this.$refs.personEduTable.clearSelected()
    },
    educationCheck(record) {
      let requesturl = PersonEduApi.personEduDetail
      let method = 'get'
      let requestparams = {
        params: { id: record.id }
      }
      let config = {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;'
        }
      }
      return this.submitFormPost(requesturl, requestparams, method, config).then(res => {
        this.formData = JSON.parse(JSON.stringify(res.data))
        this.title = '查看数据'
        this.visible = true
      })
    },

    viewOk() {
      this.visible = false
    },
    viewCancel() {
      this.visible = false
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  //padding-top: 0;
  padding-bottom: 15px;
}
/deep/.ant-table-body-inner {
  overflow: unset;
}
</style>
