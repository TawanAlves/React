<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8">
              <a-form-item label="年度">
                <a-select
                  show-search
                  v-model="queryParam.year"
                  placeholder="年度"
                  style="width: 100%"
                >
                  <a-select-option v-for="d in templateYearNameOptions" :key="d">
                    {{
                    d
                    }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="16" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <div class="top">
      <div class="cardLeft">
        <a-card
          :bordered="false"
          style="margin: 15px"
          :headStyle="{ border: 'none', paddingBottom: 0 }"
          :bodyStyle="{ paddingBottom: 0 }"
          class="table-card"
        >
          <s-table
            ref="table"
            size="default"
            :rowKey="(record) => record.id"
            :columns="columns"
            :data="loadData"
            :alert="false"
            :pagination="false"
          >
            <!-- 序号 -->
            <span
              slot="number"
              slot-scope="text, record, index"
            >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
          </s-table>
        </a-card>
      </div>
      <div class="cardRight">
        <div class="gaugeChart">
          <div id="gaugeChart"></div>
        </div>
        <div class="conent">
          <div>
            全年安全费用
            <span>{{this.costStatisticData.totalCost}}</span>
          </div>
          <div>
            使用安全费用
            <span>{{this.costStatisticData.usedCost}}</span>
          </div>
          <p>{{this.costStatisticData.description}}</p>
        </div>
      </div>
      <div></div>
    </div>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <div class="table">
        <table>
          <tr>
            <th>使用项目</th>
            <th>1月</th>
            <th>2月</th>
            <th>3月</th>
            <th>4月</th>
            <th>5月</th>
            <th>6月</th>
            <th>7月</th>
            <th>8月</th>
            <th>9月</th>
            <th>10月</th>
            <th>11月</th>
            <th>12月</th>
          </tr>
          <tr>
            <td>安全防护设施费用</td>
            <td>{{this.costByMonthMap.value1[0]}}</td>
            <td>{{this.costByMonthMap.value1[1]}}</td>
            <td>{{this.costByMonthMap.value1[2]}}</td>
            <td>{{this.costByMonthMap.value1[3]}}</td>
            <td>{{this.costByMonthMap.value1[4]}}</td>
            <td>{{this.costByMonthMap.value1[5]}}</td>
            <td>{{this.costByMonthMap.value1[6]}}</td>
            <td>{{this.costByMonthMap.value1[7]}}</td>
            <td>{{this.costByMonthMap.value1[8]}}</td>
            <td>{{this.costByMonthMap.value1[9]}}</td>
            <td>{{this.costByMonthMap.value1[10]}}</td>
            <td>{{this.costByMonthMap.value1[11]}}</td>
          </tr>
          <tr>
            <td>安全培训宣传教育费用</td>
            <td>{{this.costByMonthMap.value2[0]}}</td>
            <td>{{this.costByMonthMap.value2[1]}}</td>
            <td>{{this.costByMonthMap.value2[2]}}</td>
            <td>{{this.costByMonthMap.value2[3]}}</td>
            <td>{{this.costByMonthMap.value2[4]}}</td>
            <td>{{this.costByMonthMap.value2[5]}}</td>
            <td>{{this.costByMonthMap.value2[6]}}</td>
            <td>{{this.costByMonthMap.value2[7]}}</td>
            <td>{{this.costByMonthMap.value2[8]}}</td>
            <td>{{this.costByMonthMap.value2[9]}}</td>
            <td>{{this.costByMonthMap.value2[10]}}</td>
            <td>{{this.costByMonthMap.value2[11]}}</td>
          </tr>
          <tr>
            <td>隐患治理、应急救援费用</td>
            <td>{{this.costByMonthMap.value3[0]}}</td>
            <td>{{this.costByMonthMap.value3[1]}}</td>
            <td>{{this.costByMonthMap.value3[2]}}</td>
            <td>{{this.costByMonthMap.value3[3]}}</td>
            <td>{{this.costByMonthMap.value3[4]}}</td>
            <td>{{this.costByMonthMap.value3[5]}}</td>
            <td>{{this.costByMonthMap.value3[6]}}</td>
            <td>{{this.costByMonthMap.value3[7]}}</td>
            <td>{{this.costByMonthMap.value3[8]}}</td>
            <td>{{this.costByMonthMap.value3[9]}}</td>
            <td>{{this.costByMonthMap.value3[10]}}</td>
            <td>{{this.costByMonthMap.value3[11]}}</td>
          </tr>
          <tr>
            <td>安全技术改造费用</td>
            <td>{{this.costByMonthMap.value4[0]}}</td>
            <td>{{this.costByMonthMap.value4[1]}}</td>
            <td>{{this.costByMonthMap.value4[2]}}</td>
            <td>{{this.costByMonthMap.value4[3]}}</td>
            <td>{{this.costByMonthMap.value4[4]}}</td>
            <td>{{this.costByMonthMap.value4[5]}}</td>
            <td>{{this.costByMonthMap.value4[6]}}</td>
            <td>{{this.costByMonthMap.value4[7]}}</td>
            <td>{{this.costByMonthMap.value4[8]}}</td>
            <td>{{this.costByMonthMap.value4[9]}}</td>
            <td>{{this.costByMonthMap.value4[10]}}</td>
            <td>{{this.costByMonthMap.value4[11]}}</td>
          </tr>
          <tr>
            <td>安全咨询、服务费用</td>
            <td>{{this.costByMonthMap.value5[0]}}</td>
            <td>{{this.costByMonthMap.value5[1]}}</td>
            <td>{{this.costByMonthMap.value5[2]}}</td>
            <td>{{this.costByMonthMap.value5[3]}}</td>
            <td>{{this.costByMonthMap.value5[4]}}</td>
            <td>{{this.costByMonthMap.value5[5]}}</td>
            <td>{{this.costByMonthMap.value5[6]}}</td>
            <td>{{this.costByMonthMap.value5[7]}}</td>
            <td>{{this.costByMonthMap.value5[8]}}</td>
            <td>{{this.costByMonthMap.value5[9]}}</td>
            <td>{{this.costByMonthMap.value5[10]}}</td>
            <td>{{this.costByMonthMap.value5[11]}}</td>
          </tr>
          <tr>
            <td>消措费用</td>
            <td>{{this.costByMonthMap.value6[0]}}</td>
            <td>{{this.costByMonthMap.value6[1]}}</td>
            <td>{{this.costByMonthMap.value6[2]}}</td>
            <td>{{this.costByMonthMap.value6[3]}}</td>
            <td>{{this.costByMonthMap.value6[4]}}</td>
            <td>{{this.costByMonthMap.value6[5]}}</td>
            <td>{{this.costByMonthMap.value6[6]}}</td>
            <td>{{this.costByMonthMap.value6[7]}}</td>
            <td>{{this.costByMonthMap.value6[8]}}</td>
            <td>{{this.costByMonthMap.value6[9]}}</td>
            <td>{{this.costByMonthMap.value6[10]}}</td>
            <td>{{this.costByMonthMap.value6[11]}}</td>
          </tr>
        </table>
      </div>
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { costStatisticColumns } from '@/views/safety/table'
import { costStatisticTableColumns } from '@/views/safety/table'
import ApiURLs from '@/api/urls'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import { getDict } from '@/api/system'
import { getPersonnelTree } from '@/api/safety'
import * as echarts from 'echarts'

export default {
  name: 'costStatistic',
  components: {
    STable,
    CommonFormModal
  },
  data() {
    return {
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      templateYearNameOptions: [],
      queryParam: { year: new Date().getFullYear() },
      costStatisticData: {},
      costByMonthMap: {
        value1: [],
        value2: [],
        value3: [],
        value4: [],
        value5: [],
        value6: []
      },
      loadData: parameter => {
        return this.getList(ApiURLs.costStatisticList, this.queryParam).then(res => {
          const data = {}
          data.data = res.data.costByTypeList
          this.getTableList()
          return data
        })
      }
    }
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => costStatisticColumns,
    columnsTable: () => costStatisticTableColumns
  },
  mounted() {},

  methods: {
    searchReset() {
      this.queryParam = { year: new Date().getFullYear() }
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    getTableList() {
      this.getList(ApiURLs.costStatisticList, this.queryParam).then(res => {
        const map = new Map(Object.entries(res.data.costByMonthMap))
        var arr = []
        for (let item of map.entries()) {
          arr.push({ key: item[0], value: item[1] })
        }
        arr.forEach(item1 => {
          if (item1.key === '安全防护设施费用') {
            this.costByMonthMap.value1 = item1.value
          }
          if (item1.key === '安全培训宣传教育费用') {
            this.costByMonthMap.value2 = item1.value
          }
          if (item1.key === '隐患治理、应急救援费用') {
            this.costByMonthMap.value3 = item1.value
          }
          if (item1.key === '安全技术改造费用') {
            this.costByMonthMap.value4 = item1.value
          }
          if (item1.key === '安全咨询、服务费用') {
            this.costByMonthMap.value5 = item1.value
          }
          if (item1.key === '消措费用') {
            this.costByMonthMap.value6 = item1.value
          }
        })
        this.costStatisticData = res.data
        this.getGaugeCharts()
      })
    },
    getGaugeCharts() {
      var chartDom = document.getElementById('gaugeChart')
      var usedPercent = this.costStatisticData.usedPercent
      let newPromise = new Promise(resolve => {
        resolve()
      })
      newPromise.then(() => {
        echarts.init(chartDom)
      })
      var myChart = echarts.init(chartDom)

      var option = {
        series: [
          {
            type: 'gauge',
            startAngle: 180,
            endAngle: 0,
            min: 0,
            max: 1,
            splitNumber: 8,
            axisLine: {
              lineStyle: {
                width: 6,
                color: [
                  [0.25, '#7CFFB2'],
                  [0.5, '#58D9F9'],
                  [0.75, '#FDDD60'],
                  [1, '#FF6E76']
                ]
              }
            },
            pointer: {
              icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',
              length: '12%',
              width: 20,
              offsetCenter: [0, '-60%'],
              itemStyle: {
                color: 'auto'
              }
            },
            axisTick: {
              length: 12,
              lineStyle: {
                color: 'auto',
                width: 2
              }
            },
            splitLine: {
              length: 20,
              lineStyle: {
                color: 'auto',
                width: 5
              }
            },
            axisLabel: {
              color: '#464646',
              fontSize: 20,
              distance: -60,
              formatter: function(value) {
                return ''
              }
            },
            title: {
              offsetCenter: [0, '-20%'],
              fontSize: 30
            },
            detail: {
              fontSize: 30,
              offsetCenter: [0, '0%'],
              valueAnimation: true,
              formatter: function(value) {
                return Math.round(value * 100) + '%'
              },
              color: 'auto'
            },
            data: [
              {
                value: usedPercent / 100,
                name: ''
              }
            ]
          }
        ]
      }
      option && myChart.setOption(option)
    }
  },
  created() {
    this.getTableList()
    //年度
    this.axios.get('/spang-safety/security/cost/years').then(rs => {
      this.templateYearNameOptions = rs.data
    })
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

/deep/ .ant-modal-body {
  span.ant-form-item-children {
    width: 100%;
    display: block;

    .ant-checkbox-group {
      width: 100%;
    }

    .ant-calendar-picker {
      display: block;
      width: 100%;
    }
  }
}

/deep/ .ant-table-body {
  // overflow-y: auto !important;
}
/deep/ .ant-table-thead > tr > th,
.ant-table-header {
  background: #fff;
}
/deep/ .ant-pagination {
  display: none;
}
/deep/ .ant-table-scroll {
  height: 100%;
}
/deep/ .ant-progress-inner {
  width: 150px !important;
  height: 150px !important;
}
.top {
  background: #fff;
  margin: 0 15px;
  height: 400px;
  padding: 24px;
  .cardLeft,
  .cardRight {
    display: inline-block;
    width: 49%;
    background: #eee;
    border-radius: 10px;
    height: 100%;
  }
  .cardLeft {
    float: left;
    .table-card {
      height: calc(100% - 30px);
      overflow: auto;
    }
  }

  @media screen and (min-width: 1570px) {
    .cardRight {
      float: right;
      padding-top: 63px;
      padding-left: 10px;
      div {
        display: inline-block;
      }
      .gaugeChart {
        width: 46%;
        float: left;
        text-align: center;
        #gaugeChart {
          width: 288px;
          height: 288px;
        }
      }
      .conent {
        width: 38%;
        padding-top: 27px;
        div {
          height: 30px;
          line-height: 30px;
          display: block;
          font-size: 18px;
          span {
            margin-left: 10px;
          }
        }
        p {
          margin-top: 40px;
        }
      }
    }
  }
  @media screen and (max-width: 1569px) {
    .cardRight {
      float: right;
      position: relative;
      .gaugeChart {
        text-align: center;
        #gaugeChart {
          width: 288px;
          height: 288px;
          margin: 0 auto;
        }
      }
      .conent {
        text-align: center;
        bottom: 30px;
        width: 100%;
        position: absolute;
        div {
          height: 30px;
          line-height: 30px;
          display: block;
          font-size: 18px;
          span {
            margin-left: 10px;
          }
        }
        p {
          margin-top: 40px;
        }
      }
    }
  }
}

.table {
  text-align: center;
  width: 100%;
  background: #eee;
  border-radius: 10px;
  padding: 15px;
  margin: 24px 0;
  table {
    background: #fff;
    width: 100%;
    tr {
      padding: 16px;
      height: 54px;
      line-height: 54px;
      th,
      td {
        border-bottom: 1px solid #eee;
      }
    }
  }
}
</style>
