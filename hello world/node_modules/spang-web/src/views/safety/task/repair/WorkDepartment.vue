<template>
  <div>
    <a-card title="人员指派" style="margin: 15px;">
      <a-form-model :model="form" ref="ruleForm" :label-col="{span: 7}" :wrapper-col="{span:10}">
        <a-form-model-item label="作业单位">
          <a-input
            v-model="form.workUnitName"
            disabled/>
        </a-form-model-item>
        <a-form-model-item label="作业负责人">
          <div class="flex-input-button">
            <a-input
              v-model="form.principal"
              style="margin-right: 10px;"
              disabled/>
            <a-button :disabled="!canChangePerson" @click="choosePrincipalPerson()">更换</a-button>
          </div>

        </a-form-model-item>
        <a-form-model-item label="作业人">
          <div
            v-for="(people, index) in form.workUserList"
            :key="people.userId">
            <div class="flex-input-button" :style="{marginBottom: index !== form.workUserList.length - 1? '10px': ''}">
              <a-input
                :value="people.userName"
                style="margin-right: 10px;"
                disabled>
                <a-icon slot="addonAfter":disabled="!canChangePerson" type="delete" @click="deleteHotPerson(index)"/>
              </a-input>
              <a-button :disabled="!canChangePerson" v-if="index === 0" @click="chooseWorkPerson">添加</a-button>
            </div>
          </div>
          <div class="flex-input-button" v-if="!form.workUserList || form.workUserList.length === 0">
            <a-input
              style="margin-right: 10px;"
              disabled/>
            <a-button :disabled="!canChangePerson" @click="chooseWorkPerson">添加</a-button>
          </div>
        </a-form-model-item>
      </a-form-model>
    </a-card>
    <person-history :history-datas="historyList" />
    <person-select-modal
      :visible.sync="personSelectModalVisible"
      :loading="confirmLoading"
      @ok="changeOtherPerson"
      :title="title"
      :dept-id="workUnitId"
      :multiple="multiple"
    />
  </div>

</template>

<script>
import { assignWorker, getDetail, getAssignWorker, loadHistory } from '@/api/high-work'
import { getUserAuth } from '@/api/system'
import { mapGetters } from 'vuex'
import PersonHistory from '../component/PersonHistory'
import PersonSelectModal from '../component/PersonSelectModal'
export default {
  name: 'WorkDepartment',
  components: { PersonSelectModal, PersonHistory },
  props: {
    ticketId: {
      type: String,
      default: '',
      required: true
    }
  },
  data () {
    return {
      form: {},
      personSelectModalVisible: false,
      confirmLoading: false,
      multiple: false,
      canSubmit: false,
      personType: 1,
      title: '',
      workUnitId: '',
      historyList: []
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    canChangePerson () { // 是否是作业分配角色
      return this.canSubmit && this.form.status !== 0
    }
  },
  methods: {
    async loadDetail () {
      this.getByIdRestful('/spang-safety/related-user', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          this.workUnitId = data.workUnitId;
          this.form = data;
        }
      })
    },
    getAuth () {
      getUserAuth({
          userId: this.userInfo.id,
          bizCode: 'WORK_TICKETS_ALLOT',
          deptId: this.userInfo.deptId
        }).then(({ data, code }) => {
          if (code === 200) {
            this.canSubmit = data
          }
        })
    },
    changeHotPerson (users) {
      users = users.map(item => ({
        userId: item.userId,
        userName: item.userName,
        code: item.certificateNumber
      }))
      const personList = [...this.form.workUserList, ...users]
      const obj = {}
      this.form.workUserList = personList.reduce((cur, next) => {
        obj[next.userId] ? '' : obj[next.userId] = true && cur.push(next)
        return cur
      }, [])

      this.submitChange()
    },
    deleteHotPerson (index) {
      if (!this.canChangePerson) {
        this.$notification['success']({
            message: '提示',
            description: '没有操作权限',
            duration: 8
          })
        return
      }
      this.form.workUserList.splice(index, 1)
      this.submitChange()
    },
    changeOtherPerson (users) {
      if (this.personType === 1) {
        if (this.form.principalId !== users[0].userId) {
        this.form.principalId = users[0].userId
        this.form.principal = users[0].userName

        this.submitChange()
      }
      } else {
        this.changeHotPerson(users)
      }
    },
    submitChange () {
      const params = { ...this.form, ticketId: this.ticketId }
      assignWorker(params, 'post').then(({ data, code }) => {
        if (code === 200) {
          this.$notification['success']({
            message: '提示',
            description: '更换成功',
            duration: 8
          })
          this.loadDetail()
          this.personSelectModalVisible = false
        }
      })
    },
    choosePrincipalPerson () {
      this.multiple = false
      this.personSelectModalVisible = true
      this.title = '作业负责人'
      this.personType = 1
    },
    chooseWorkPerson () {
      this.multiple = true
      this.personSelectModalVisible = true
      this.title = '作业人'
      this.personType = 2
    },
    getPersonList () {
      this.getById('/spang-safety/user-history', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          const map = { 0: '作业人', 1: '作业负责人', 2: '现场监护人' }
          data.forEach(item => {
            item.type = map[item.type] || ''
          })
          this.historyList = data
        }
      })
    }
  },
  created () {
    this.loadDetail()
    this.getPersonList()
    this.getAuth()
  }
}
</script>

<style scoped lang="less">
.flex-input-button {
  display: flex;
  justify-content: space-between;
}
/deep/ .ant-table {
  height: auto;
}
</style>
