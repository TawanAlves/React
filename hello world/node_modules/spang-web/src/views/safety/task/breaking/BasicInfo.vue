<template>
  <div>
    <a-card title="基本信息" style="margin: 15px;">
      <a-form class="ant-advanced-search-form">
        <a-row :gutter="24">
          <a-col :span="10" :offset="1">
            <a-form-item label="作业证编号">
              <a-input :value="formData.code" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="是否附图纸安全方案">
              <a-input :value="formData.haveOtherAssignments === 1 ? '是': '否'" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="单位类型">
              <a-input :value="formData.constructionUnitType === 0 ? '内部单位': '外来施工单位'" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="作业类型">
              <a-input :value="formData.workTypeNames" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="班组">
              <a-input :value="formData.workTeam" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="施工单位">
              <a-input :value="formData.field6" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="申请人">
              <a-input :value="formData.applicantUnitName" disabled/>
            </a-form-item>
          </a-col>

          <a-col :span="10" :offset="1">
            <a-form-item label="申请单位">
              <a-input :value="formData.applicantUnitName" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="断路作业负责人">
              <div class="flex-input-button">
                <a-input :value="formData.field3" disabled style="margin-right: 5px;"/>
                <a-button :disabled="!canChangeGuardian" @click="changePeron(1)">更换</a-button>
              </div>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="作业单位">
              <a-input :value="formData.workUnitName" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="计划作业起止时间">
              <a-input :value="formData.planStartTime + '至' + formData.planEndTime" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="断路原因">
              <a-input :value="formData.workContent" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="实际作业起止时间">
              <a-input :value="actualTime" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="作业位置">
              <a-input :value="formData.workAddress" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="作业人">
              <a-input :value="formData.workPersons" disabled/>
            </a-form-item>
          </a-col>
          <a-col :span="10" :offset="1">
            <a-form-item label="现场监护人">
              <div class="flex-input-button">
                <a-input :value="formData.localeGuardianName" disabled style="margin-right: 5px;"/>
                <a-button :disabled="!canChangeGuardian" @click="changePeron(0)">更换</a-button>
              </div>
            </a-form-item>
          </a-col>
        </a-row>
      </a-form>
      <a-divider style="margin: 0;"/>
      <a-row :gutter="24">
        <a-col :span="24">
          <div style="margin: 10px 0;">涉及其他特殊作业:</div>
        </a-col>
        <a-table
          ref="table"
          size="default"
          :rowKey="record => record.id"
          :columns="otherTaskColumns"
          :dataSource="formData.relatedWorks"
          :alert="false"
          :scroll="{ y: 350 }"
          :pagination="false"
        >
          <span slot="time" slot-scope="text, record">
            <template v-if="record.planStartTime && record.planEndTime">
              {{ record.planStartTime }}&nbsp;至&nbsp;{{ record.planEndTime }}
            </template>
          </span>
        </a-table>
      </a-row>
      <a-row :gutter="24">
        <a-col :span="24" v-if="false">
          <a-form-item label="断路作业示意图">
            <a-input :value="formData.sketch" disabled/>
          </a-form-item>
        </a-col>
      </a-row>
    </a-card>
    <person-history :history-datas="historyList" />
    <person-select-modal
      :visible.sync="personSelectModalVisible"
      :loading="confirmLoading"
      @ok="changeProctorHotPerson"
      title="选择人员"
      :dept-id="personType ? formData.workUnitId :formData.applicantUnitId"
      :multiple="false"
    />
  </div>
</template>

<script>
import { otherTaskColumns } from '@/views/safety/table'
import { mapGetters } from 'vuex'
import PersonHistory from '../component/PersonHistory'
import PersonSelectModal from '../component/PersonSelectModal'
export default {
  name: 'BasicInfo',
  components: { PersonHistory, PersonSelectModal },
  props: {
    ticketId: {
      type: String,
      default: '',
      required: true
    }
  },
  data () {
    return {
      otherTaskColumns,
      formData: {
      },
      historyList: [],
      personSelectModalVisible: false,
      confirmLoading: false,
      personType: null
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    actualTime () {
      if (this.formData.actualStartTime && this.formData.actualEndTime) {
        return this.formData.actualStartTime + '至' + this.formData.actualEndTime
      }
      return ''
    },
    canChangeGuardian () {
				if (this.formData.status == 1) return this.userInfo.id === this.formData.applicantId // 草稿： 创建人可编辑
          // 提交审核后只有负责人和监护人可以更换人员
				else if (this.formData.status >= 4) return (this.userInfo.id === this.formData.localeGuardianId || this.userInfo.id === this.formData.applicantId)
				else return false
    }
  },
  methods: {
    loadDetailInfo () {
      this.getByIdRestful('/spang-safety/basic-information', this.ticketId).then(async ({ data, code }) => {
        if (code === 200) {
          data.relatedWorks && data.workTicketRelatedWorkList.forEach(item => {
            item.place = item.workAddress
            item.ticketTypeName = item.workTypeName
          })
          data.workPersons = data.workTicketRelatedUserList.map(item => item.userName).join(';')
          let workTypeOptions = []
          const dictData = await this.getDict('WORK_TICKET_BREAK_ROAD_TYPE')
          if (dictData.success) {
            workTypeOptions = dictData.data
          }
          const workTypes = data.field1.split(',').map(item => {
            const workTypeObj = workTypeOptions.find(data => data.dictKey === item)
            return workTypeObj ? workTypeObj.dictValue : ''
          }).filter(item => item).join(';')
          data.workTypeNames = workTypes
          this.code = data.code
          this.formData = data
        }
      })
    },
    getPersonList () {
      this.getById('/spang-safety/user-history', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          this.historyList = data
        }
      })
    },
    changePeron (type) {
      this.personSelectModalVisible = true
      this.personType = type
    },
    changeProctorHotPerson (users) {
      if (this.personType === 0) {
        if (this.formData.localeGuardianId === users[0].userId) {
          return
        } else {
          this.formData.localeGuardianId = users[0].userId
          this.formData.localeGuardianName = users[0].userName
        }
      }
      if (this.personType === 1) {
        if (this.formData.field2 === users[0].userId) {
          return
        } else {
          this.formData.field2 = users[0].userId
          this.formData.field3 = users[0].userName
        }
      }
      const params = {
        ...this.formData,
        id: this.ticketId,
        saveOrSubmit: 0
      }
      this.submitForm('/spang-safety/basic-information', params, 'put').then(({ data, code }) => {
        if (code === 200) {
          this.$notification['success']({
            message: '提示',
            description: '更换成功',
            duration: 8
          })
          this.personSelectModalVisible = false
        } else {
          this.$notification['error']({
            message: '提示',
            description: data.msg,
            duration: 8
          })
        }
      })
    }
  },
  created () {
    this.loadDetailInfo()
    this.getPersonList()
  }
}
</script>

<style scoped lang="less">

/deep/ .ant-advanced-search-form .ant-form-item {
  display: flex;
}
/deep/ .ant-advanced-search-form .ant-form-item-label {
  width: 130px;
}

/deep/ .ant-advanced-search-form .ant-form-item-control-wrapper {
  flex: 1;
}
/deep/ .ant-table {
  height: auto;
}
.flex-input-button {
  display: flex;
  justify-content: space-between;
}
</style>
