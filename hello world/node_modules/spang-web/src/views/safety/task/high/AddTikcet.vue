<template>
  <a-card :bordered="false" style="margin: 15px;">
    <a-form-model :model="form" ref="ruleForm" :rules="rules" :label-col="{span: 7}" :wrapper-col="{span:10}">
      <a-row class="form-title">
        <h3 >{{ formTitle }}</h3>
      </a-row>
      <a-form-model-item label="作业证编号" v-if="id !== '-1'">
        <a-input
          v-model="form.code"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="申请单位">
        <a-input
          v-model="form.applicantUnitName"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="申请人">
        <a-input
          v-model="form.applicantName"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="现场监护人" prop="localeGuardianId">
        <a-select
          show-search
          v-model="form.localeGuardianId"
          placeholder="请选择现场监护人"
          style="width: 100%"
          :filter-option="filterOption"
          option-filter-prop="children"
          @change="proctorChange"
        >
          <a-select-option v-for="d in personList" :key="d.id">
            {{ d.realName }}
          </a-select-option>
        </a-select>
      </a-form-model-item>
      <a-form-model-item label="作业单位" prop="workUnitId">
        <a-tree-select
          v-model="form.workUnitId"
          style="width: 100%;"
          :dropdownStyle="{ maxHeight:'35vh', overflow: 'auto'}"
          :tree-data="applyUnitsData"
          allowClear
          placeholder="请选择作业单位"
          @change="workUnitChange"
        />
      </a-form-model-item>
      <a-form-model-item label="作业地点" prop="workAddress">
        <a-input
          placeholder="请输入作业地点"
          v-model="form.workAddress"
        />
      </a-form-model-item>
      <a-form-model-item label="作业内容" prop="workContent">
        <a-input
          placeholder="请输入作业内容"
          v-model="form.workContent"
        />
      </a-form-model-item>
      <a-form-model-item label="作业高度(米)" prop="field1">
        <a-input
          placeholder="请输入作业高度"
          type="number"
          v-model="form.field1"
        />
      </a-form-model-item>
      <a-form-model-item label="作业类别" prop="workCategory">
        <a-select
          placeholder="请选择作业类别"
          v-model="form.workCategory">
          <a-select-option
            v-for="item in categoryOptions"
            :key="item.dictKey">
            {{ item.dictValue }}
          </a-select-option>
        </a-select>
      </a-form-model-item>
      <a-form-model-item label="作业分级" prop="workLevel">
        <a-select
          placeholder="请选择作业分级"
          v-model="form.workLevel">
          <a-select-option
            v-for="item in levelOptions"
            :key="item.dictKey">
            {{ item.dictValue }}
          </a-select-option>
        </a-select>
      </a-form-model-item>

      <a-form-model-item label="安全方案或图纸" prop="haveScheme">
        <a-radio-group v-model="form.haveScheme">
          <a-radio :value="1">
            是
          </a-radio>
          <a-radio :value="0">
            否
          </a-radio>
        </a-radio-group>
      </a-form-model-item>
      <a-form-model-item label="作业起止时间" prop="planStartEndTime">
        <a-range-picker
          @change="onPlanTimeChange"
          v-model="form.planStartEndTime"
          valueFormat="YYYY-MM-DD HH:mm:ss"
          showTime
          style="width: 100%"
        />
      </a-form-model-item>
      <a-divider />
      <a-row>
        <a-col :span="8">
          <a-form-model-item label="涉及其他特殊作业">
            <a-radio-group v-model="form.haveOtherAssignments">
              <a-radio :value="1">
                是
              </a-radio>
              <a-radio :value="0">
                否
              </a-radio>
            </a-radio-group>
          </a-form-model-item>
        </a-col>
        <a-col :span="1" :offset="13" v-if="form.haveOtherAssignments">
          <a-button icon="plus" @click="otherTaskModalVisible = true" >添加其他特殊作业</a-button>
        </a-col>
      </a-row>
      <a-row v-if="form.haveOtherAssignments">
        <a-table
          ref="table"
          size="default"
          :rowKey="record => record.relatedTicketId"
          :columns="columns"
          :dataSource="form.workTicketRelatedWorkList"
          :alert="false"
          :scroll="{ y: 350 }"
          :pagination="false"
        >
          <span slot="time" slot-scope="text, record">
            <template v-if="record.planStartTime && record.planEndTime">
              {{ record.planStartTime }}&nbsp;至&nbsp;{{ record.planEndTime }}
            </template>
          </span>
          <span slot="operation" slot-scope="text, record, index">
            <a @click="removeOtherTask(index)">X</a>
          </span>
        </a-table>
      </a-row>
      <div style="text-align: center; margin-top: 10px;">
        <a-button type="primary" @click="submitForm" style="width: 122px;">提交</a-button>
        <a-button type="second" @click="goBack" style="width: 122px;margin-left: 20px">返回</a-button>
      </div>
    </a-form-model>
    <other-task-modal
      :visible.sync="otherTaskModalVisible"
      :loading="otherTaskConfirm"
      @ok="addOtherTask"
    >
    </other-task-modal>
  </a-card>
</template>

<script>
import { getPersonnelTree } from '@/api/safety'
import { getUsers, getDict } from '@/api/system'
import { mapGetters } from 'vuex'
import { simpleTaskColumns } from '@/views/safety/table'
import { saveForm, getDetail } from '@/api/high-work'
import OtherTaskModal from '../component/OtherTaskModal'
export default {
  name: 'AddTikcet',
  components: { OtherTaskModal },
  props: {
    id: {
      type: String,
      required: true,
      default: '-1'
    }
  },
  data () {
    return {
      applyUnitsData: [],
      otherTaskModalVisible: false,
      otherTaskConfirm: false,
      form: {
        haveScheme: 0,
        planStartTime: null,
        planEndTime: null,
        haveOtherAssignments: 0,
        planStartEndTime: null,
        workTicketRelatedWorkList: [],
        applicantName: null,
        applyPersonId: null,
        applyDeptId: null,
        applicantUnitName: null,
        workCategory: '',
        workLevel: '',
        workUnitName: null,
        localeGuardianId: null,
        localeGuardianName: null
      },
      levelOptions: [],
      categoryOptions: [],
      rules: {
        localeGuardianId: [
          { required: true, message: '请选择现场监护人', trigger: 'blur' }
        ],
        workUnitId: [{ required: true, message: '请选择作业单位', trigger: 'change' }],
        workLevel: [{ required: true, message: '请选择作业分级', trigger: 'blur' }],
        workCategory: [{ required: true, message: '请选择作业类别', trigger: 'blur' }],
        workAddress: [{ required: true, message: '请选择作业地点', trigger: 'blur' }],
        workContent: [
          { required: true, message: '请输入作业内容', trigger: 'blur' }
        ],
        field1: [
          { required: true, message: '请输入作业高度', trigger: 'blur' }
        ],
        planStartEndTime: [
          { required: true, message: '请选择作业起止时间', trigger: 'change' }
        ]
      },
      personList: []
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    formTitle () {
      if (this.id === '-1') {
        return '新建高处作业票'
      } else {
        return '修改高处作业票'
      }
    },
    columns () {
      return [...simpleTaskColumns, {
        title: '操作',
        dataIndex: 'operation',
        align: 'center',
        width: '100px',
        scopedSlots: { customRender: 'operation' }
      }]
    }
  },
  methods: {
    getApplyUnits () {
      getPersonnelTree(0).then(res => {
        this.applyUnitsData = res.data
      })
    },
    getUsers () {
      getUsers({ deptId: this.userInfo.deptId }).then(({ data }) => {
        this.personList = data
      })
    },
    onPlanTimeChange (date) {
      this.form.planStartTime = date[0]
      this.form.planEndTime = date[1]
      this.form.planStartEndTime = date
    },
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
    goBack () {
      this.$router.push('/safety/task/manage')
    },
    submitForm () {
      this.$refs.ruleForm.validate(valid => {
        if (valid) {
          const params = Object.assign({}, this.form)
          delete params.planStartEndTime
          if (this.form.haveOtherAssignments) {
            params.workTicketRelatedWorkList = this.form.workTicketRelatedWorkList.map(item => ({
              code: item.code,
              relatedTicketId: item.relatedTicketId,
              workType: item.workType,
              workTypeName: item.workTypeName,
            }))
          }
          params.status = 2;
          params.saveOrSubmit = 1;
          let method = 'post';
          if (this.id !== '-1') {
            method = 'put';
            params.saveOrSubmit = 0;
          }
          // params.workLevelName = this.levelOptions.find(item => item.dictKey == params.workLevel).dictValue;
          params.workCategory = Number(params.workCategory);
          params.workLevel = Number(params.workLevel);
          params.ticketType = '1';
          const url = `/spang-safety/basic-information`;
          this.submitFormApi(method,url, params).then(res=>{
            if(res.code === 200){
              this.$notification['success']({
                message: '提示',
                description: '提交成功',
                duration: 8
              })
              this.$router.push('/safety/task/manage');
            }
          })
        } else {
          console.error('error submit!!')
          return false
        }
      })
    },
    removeOtherTask (index) {
      this.form.workTicketRelatedWorkList.splice(index, 1)
    },
    addOtherTask (data) {
      data.forEach(d=>{
        d.workTypeName = d.ticketTypeName;
        d.relatedTicketId = d.id;
        d.workTypeName = d.ticketTypeName;
        d.workType = d.ticketType;
      })
      const ids = this.form.workTicketRelatedWorkList.map(item => item.relatedTicketId)
      const newTasks = data.filter(item => !ids.includes(item.relatedTicketId))
      this.form.workTicketRelatedWorkList = [...this.form.workTicketRelatedWorkList, ...newTasks]
      this.otherTaskModalVisible = false
    },
    loadFormData () {
      this.getList('/spang-safety/basic-information/' + this.id,{}).then(res => {
        if (res.code === 200) {
          this.form = Object.assign({ planStartEndTime: [res.data.planStartTime, res.data.planEndTime] ,workTicketRelatedWorkList: [] }, res.data)
          this.form.workCategory = res.data.workCategory + '';
          this.form.workLevel = res.data.workLevel + '';
          console.log(typeof this.form.workCategory,this.form)
        }
      })
    },
    loadSelectOption () {
      getDict('WORK_TICKET_HIGH_LEVEL').then(({ data }) => {
				this.levelOptions = data
			})
			getDict('WORK_TICKET_HIGH_TYPE').then(({ data }) => {
				this.categoryOptions = data
			})
    },
    proctorChange (value) {
      const person = this.personList.find(item => item.id === value)
        if (person) {
          this.form.localeGuardianName = person.realName
        } else {
          this.form.localeGuardianName = ''
        }
    },
    workUnitChange (value, label) {
      this.form.workUnitName = label[0]
    }

  },
  created () {
    this.getApplyUnits()
    this.getUsers()
    this.loadSelectOption()
    if (this.id !== '-1') {
      this.loadFormData()
    } else {
      this.form.applicantUnitName = this.userInfo.deptName
      this.form.applicantUnitId = this.userInfo.deptId
      this.form.applicantName = this.userInfo.realName
      this.form.applicantId = this.userInfo.id
    }
  }
}
</script>

<style scoped lang="less">
  /deep/ .ant-table {
    height: auto;
  }
</style>
