<template>
  <a-card :bordered="false" style="margin: 15px;">
    <a-form-model :model="form" ref="ruleForm" :rules="rules" :label-col="{span: 7}" :wrapper-col="{span:10}">
      <a-row class="form-title">
        <h3 >{{ formTitle }}</h3>
      </a-row>
      <a-form-model-item label="作业证编号" v-if="id !== '-1'">
        <a-input
          v-model="form.code"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="施工单位" prop="constructionUnitType">
        <a-radio-group v-model="form.constructionUnitType">
          <a-radio :value="0">
            厂内维修
          </a-radio>
          <a-radio :value="1">
            外来施工单位
          </a-radio>
        </a-radio-group>
      </a-form-model-item>
      <a-form-model-item label="申请单位">
        <a-input
          v-model="form.applicantUnitName"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="申请人">
        <a-input
          v-model="form.applicantName"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="吊装指挥人">
        <a-row :gutter="24">
          <a-col :span="10">
            <a-form-model-item prop="field4" style="margin-bottom: 0;">
              <a-input
                v-model="form.field4"
                placeholder="姓名"
                />
            </a-form-model-item>
          </a-col>
          <a-col :span="14">
            <a-form-item prop="field3" style="margin-bottom: 0;">
              <a-input
              v-model="form.field3"
              placeholder="证件编号"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-form-model-item>
      <a-form-model-item label="作业级别" prop="workLevel">
        <a-select
          placeholder="请选择作业级别"
          v-model="form.workLevel"
          @change="workLevelChanged"
        >
          <a-select-option
            v-for="item in levelOptions"
            :key="item.value">
            {{ item.label }}
          </a-select-option>
        </a-select>
      </a-form-model-item>
      <a-form-model-item label="项目名称" prop="field2">
        <a-input
          placeholder="请输入项目名称"
          v-model="form.field2"
        />
      </a-form-model-item>
      <a-form-model-item label="吊装内容" prop="workContent">
        <a-input
          placeholder="请输入吊装内容"
          v-model="form.workContent"
        />
      </a-form-model-item>
      <a-form-model-item label="起吊重物质量(kg)" prop="field1">
        <a-input
          type="number"
          min="0"
          placeholder="请输入起吊重物质量"
          v-model="form.field1"
        />
      </a-form-model-item>
      <a-form-model-item label="吊装工具名称" prop="field5">
        <a-input
          placeholder="请输入吊装工具名称"
          v-model="form.field5"
        />
      </a-form-model-item>
      <a-form-model-item label="吊装地点" prop="workAddress">
        <a-input
          placeholder="请输入吊装地点"
          v-model="form.workAddress"
        />
      </a-form-model-item>
      <a-form-model-item label="申请作业起止时间" prop="planStartEndTime">
        <a-range-picker
          @change="onPlanTimeChange"
          v-model="form.planStartEndTime"
          valueFormat="YYYY-MM-DD HH:mm:ss"
          showTime
          style="width: 100%"
          placeholder="请选择作业起止时间"
        />
      </a-form-model-item>
      <a-form-model-item label="是否附吊装方案" prop="haveScheme">
        <a-radio-group v-model="form.haveScheme">
          <a-radio :value="0">
            是
          </a-radio>
          <a-radio :value="1">
            否
          </a-radio>
        </a-radio-group>
      </a-form-model-item>
      <a-form-model-item label="作业单位" prop="workUnitId">
        <department-select v-model="form.workUnitId" placeholder="请选择作业单位" @change="workCompanyChange" />
      </a-form-model-item>

      <a-form-model-item label="起重机械操作人员" prop="workUsers">
        <div
          v-for="(people, index) in form.workTicketRelatedUserList"
          :key="people.userId">
          <div class="flex-input-button" :style="{marginBottom: index !== form.workTicketRelatedUserList.length - 1? '10px': ''}">
            <a-input
              :value="people.userName"
              style="margin-right: 10px;"
              disabled>
              <a-icon slot="addonAfter" type="delete" @click="deleteHotPerson(index, people)"/>
            </a-input>
            <a-button v-if="index === 0" @click="hotPersonSelectModalVisible = true">添加</a-button>
          </div>
        </div>
        <div class="flex-input-button" v-if="form.workTicketRelatedUserList && form.workTicketRelatedUserList.length === 0">
          <a-input
            style="margin-right: 10px;"
            placeholder="请选择起重机械操作人员"
            disabled/>
          <a-button @click="hotPersonSelectModalVisible = true">添加</a-button>
        </div>
      </a-form-model-item>
      <a-form-model-item label="施工方安全负责人" prop="field6">
        <a-input
          placeholder="请输入施工方安全负责人"
          v-model="form.field6"
        />
      </a-form-model-item>
      <a-form-model-item label="施工方项目总负责人" prop="field7">
        <a-input
          placeholder="请输入施工方项目总负责人"
          v-model="form.field7"
        />
      </a-form-model-item>
      <a-form-model-item label="施工方机械指挥人" prop="field8" v-if="form.workLevel === 3">
        <a-input
          placeholder="请输入施工方机械指挥人"
          v-model="form.field8"
        />
      </a-form-model-item>
      <a-form-model-item label="现场监护人" prop="localeGuardianId" v-if="form.workLevel === 3">
        <person-list-select
          v-model="form.localeGuardianId"
          @change="userChanged"
          :deptId="form.workApplyCompanyId"
          placeholder="请选择现场监护人"
        />
      </a-form-model-item>
      <div style="text-align: center; margin-top: 10px;">
        <a-button type="primary" @click="submitForm" style="width: 122px;">提交</a-button>
        <a-button type="second" @click="goBack" style="width: 122px;margin-left: 20px">返回</a-button>
      </div>
    </a-form-model>
    <person-select-modal
      :visible.sync="hotPersonSelectModalVisible"
      title="添加起重机械操作人员"
      @ok="changeHotPerson"
      :dept-id="form.workApplyCompanyId"
      :multiple="true"
    />
  </a-card>
</template>

<script>
import { mapGetters } from 'vuex'
import { saveForm, getDetail } from '@/api/hoisting-work'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonSelectModal from '../component/PersonSelectModal'
import PersonListSelect from '../../components/PersonListSelect'
const levelOptions = [{
    label: '一级',
    value: 6
  }, {
    label: '二级',
    value: 3
  }, {
    label: '三级',
    value: 2
  }, {
    label: '四级',
    value: 1
}]
export default {
  name: 'AddTikcet',
  components: { DepartmentSelect, PersonSelectModal, PersonListSelect },
  props: {
    id: {
      type: String,
      required: true,
      default: '-1'
    }
  },
  data () {
    return {
      levelOptions,
      hotPersonSelectModalVisible: false,
      form: {
        workLevelName: '一级',
        haveScheme: 1,
        workLevel: 6,
        planStartTime: null,
        planEndTime: null,
        planStartEndTime: null,
        workTicketRelatedUserList: [],
        constructionUnitType: 0,
        localeGuardianName: '',
        workUnitName: ''
      },
      rules: {
        field4: [{ required: true, message: '请输入吊装指挥人', trigger: 'blur' }],
        field3: [{ required: true, message: '请输入证书号', trigger: 'blur' }],
        field2: [{ required: true, message: '请输入项目名称', trigger: 'blur' }],
        workContent: [{ required: true, message: '请输入吊装内容', trigger: 'blur' }],
        field1: [{ required: true, message: '请输入起吊重物质量', trigger: 'blur' }],
        field5: [{ required: true, message: '请输入吊装工具名称', trigger: 'blur' }],
        workAddress: [{ required: true, message: '请输入吊装地点', trigger: 'blur' }],
        field7: [{ required: true, message: '请输入施工方项目总负责人', trigger: 'blur' }],
        workUnitId: [{ required: true, message: '请选择请选择作业单位', trigger: 'change' }],
        field6: [
          { required: true, message: '请输入施工方安全负责人', trigger: 'blur' }
        ],
        planStartEndTime: [
          { required: true, message: '请选择计划起止时间', trigger: 'change' }
        ],
        workTicketRelatedUserList: [
          {
            required: true,
            validator: (rule, value, callback) => {
              if (!value || value.length === 0) {
                callback(new Error('请选择起重机械操作人员'))
              } else {
                callback()
              }
            },
            trigger: 'change'
          }
        ],
        localeGuardianId: [
          {
            required: true,
            validator: (rule, value, callback) => {
              if (!value && this.form.workLevel === 3) {
                callback(new Error('请选择现场监护人'))
              } else {
                callback()
              }
            },
            trigger: 'blur'
          }
        ],
        field8: [
          {
            required: true,
            validator: (rule, value, callback) => {
              if (!value && this.form.workLevel === 3) {
                callback(new Error('请输入施工方机械指挥人'))
              } else {
                callback()
              }
            },
            trigger: 'blur'
          }
        ]
      }
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    formTitle () {
      if (this.id === '-1') {
        return '新建吊装作业票'
      } else {
        return '修改吊装作业票'
      }
    }
  },
  methods: {
    onPlanTimeChange (date) {
      this.form.planStartTime = date[0]
      this.form.planEndTime = date[1]
      this.form.planStartEndTime = date
    },
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
    changeHotPerson (users) {
      users.forEach(item => {
        item.isSign = 0
        item.certificateCode = item.code
      })
      const personList = [...this.form.workTicketRelatedUserList, ...users]
      const obj = {}
      this.form.workTicketRelatedUserList = personList.reduce((cur, next) => {
        obj[next.userId] ? '' : obj[next.userId] = true && cur.push(next)
        return cur
      }, [])
      this.hotPersonSelectModalVisible = false
    },
    deleteHotPerson (index) {
      this.form.workTicketRelatedUserList.splice(index, 1)
    },
    goBack () {
      this.$router.push('/safety/task/manage')
    },
    workLevelChanged (value) {
      this.form.workLevelName = this.levelOptions.find(item => item.value === value).label
    },
    submitForm () {
      this.$refs.ruleForm.validate(valid => {
        if (valid) {
          const params = Object.assign({}, this.form)
          delete params.planStartEndTime
          params.status = 2
          let method = 'post'
          if (this.id !== '-1') {
            method = 'put'
          }
          params.ticketType = '4';
          const url = `/spang-safety/basic-information`;
          this.submitFormApi(method,url, params).then(res=>{
            if(res.code === 200){
              this.$notification['success']({
                message: '提示',
                description: '提交成功',
                duration: 8
              })
              this.$router.push('/safety/task/manage');
            }
          })
        } else {
          console.error('error submit!!')
          return false
        }
      })
    },
    loadFormData () {
      this.getList('/spang-safety/basic-information/' + this.id,{}).then(res => {
        if (res.code === 200) {
          this.form = Object.assign({ planStartEndTime: [res.data.planStartTime, res.data.planEndTime], workUsers: [] }, res.data)
        }
      })
    },
    userChanged ({ id, person }) {
      this.form.localeGuardianName = person.realName
    },
    workCompanyChange  ({ id, label }) {
      this.form.workUnitName = label
    }

  },
  created () {
    if (this.id !== '-1') {
      this.loadFormData()
    } else {
      this.form.applicantUnitName = this.userInfo.deptName
      this.form.applicantUnitId = this.userInfo.deptId
      this.form.applicantName = this.userInfo.realName
      this.form.applicantId = this.userInfo.id
    }
  }
}
</script>

<style scoped lang="less">
  .flex-input-button {
    display: flex;
    justify-content: space-between;
  }
  .helper-text {
    color: rgba(0, 0, 0, 0.25);
  }
</style>
