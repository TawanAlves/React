<template>
  <a-card style="margin: 15px;">
    <a-tabs
      default-active-key="1"
      tab-position="left"
      @change="handleTabChange"
    >
      <a-tab-pane key="1" tab="风险辨识">
        <a-list
          class="demo-loadmore-list"
          item-layout="horizontal"
          :data-source="riskDatas"
        >
          <a-list-item slot="renderItem" slot-scope="item, index">
            <a slot="actions" v-if="false">查看图片</a>
            <a-list-item-meta>
              <div slot="description">
                <span
                  style="margin-right: 5px;"
                  :class="item.isTitle === 0 ? 'color-red' : 'color-green'">{{ item.isTitle === 0 ? '有' : '不涉及' }}</span>
                <template v-if="item.measureLabel !== 'false'">
                  <span>安全措施: </span>
                  <template v-if="!item.options">
                    <span>{{ item.measureLabel }}</span>
                  </template>
                  <template v-else>
                    <div class="measure-content-desc">
                      <template v-for="(option, index) in item.options">
                        <div class="measure-content-item" :key="index">
                          <a-checkbox :checked="item.measuresValue.includes(option.value)" disabled></a-checkbox>
                          <label-with-input :label="option.label" :label-values="option.textValues"/>
                        </div>
                      </template>
                    </div>
                  </template>
                </template>
                <template v-else>
                  <span>{{ item.measuresText }}</span>
                </template>
              </div>
              <div slot="title" class="font-weight-bold">
                {{ index + 1 }}.
                <label-with-input :label="item.label" :label-values="item.titleValue.split(',')"/>
              </div>
            </a-list-item-meta>

            <div class="list-content">
              <div class="list-content-item">

                <template v-if="item.workTicketHotWorkRiskFillinList && item.workTicketHotWorkRiskFillinList.length > 0">
                  <template v-for="(data, dataIndex) in item.workTicketHotWorkRiskFillinList">
                    <span style="width: 150px; display: inline-block">{{ data.signatureDate }}</span>
                    <sign-img
                      style="display: inline-block;"
                      :style="{marginRight: (dataIndex === item.workTicketHotWorkRiskFillinList.length - 1 ? '0px': '15px')}"
                      :src="data.signatureURL ? BASE_URL + '/spang-safety/file' + data.signatureURL: ''"
                      :key="data.id"
                    />
                  </template>
                </template>
                <template v-else>
                  <span style="width: 150px; display: inline-block">{{ item.signatureDate }}</span>
                  <sign-img style="margin-left: 15px; display: inline-block;" :src="item.signatureURL ? BASE_URL + '/spang-safety/file' + item.signatureURL: ''"></sign-img>
                </template>

              </div>

            </div>

          </a-list-item>
        </a-list>
      </a-tab-pane>
      <a-tab-pane key="2" tab="安全签字">
        <div class="measure-title">监护人签字</div>
        <signature-list :list-data="protoChargerSign"></signature-list>
        <a-divider class="measure-title-divider"/>
        <div class="measure-title">动火负责人签字</div>
        <signature-list :list-data="workChargerSign"></signature-list>
        <a-divider class="measure-title-divider"/>
        <div class="measure-title">动火人签字</div>
        <signature-list :list-data="workersSign"></signature-list>
        <a-divider class="measure-title-divider"/>
        <horizontal-list :list-data="ticketInfo"></horizontal-list>
        <template v-if="presentImages.length > 0">
          <a-divider class="measure-title-divider"/>
          <div class="measure-title">
            现场图片
            <viewer :images="presentImages" class="present-img-viewer">
              <img v-for="src in presentImages" :key="src" :src="src" class="present-img">
            </viewer>
          </div>
        </template>

      </a-tab-pane>
      <a-tab-pane key="3" tab="安全交底">
        <safety-disclosure :content-data="safetyForm"></safety-disclosure>
        <horizontal-list :list-data="safetyFormSign"></horizontal-list>
      </a-tab-pane>
    </a-tabs>
  </a-card>
</template>

<script>
import { hotWorkRiskFillinList } from './risks'
import LabelWithInput from '../../ticket/component/LabelWithInput'
import { mapGetters } from 'vuex'
import SignImg from '../component/SignImg'
import HorizontalList from '../component/HorizontalList'
import SignatureList from '../component/SignatureList'
import SafetyDisclosure from '../component/SafetyDisclosure'
export default {
  name: 'Confirmation',
  components: { LabelWithInput, SignImg, HorizontalList, SafetyDisclosure, SignatureList },
  props: {
    ticketId: {
      type: String,
      default: '',
      required: true
    }
  },
  data () {
    return {
      riskDatas: hotWorkRiskFillinList,
      ticketInfo: {
        title1: '作业单位安全教育人',
        title2: '所在单位安全教育人'
      },
      safetyForm: { riskType: [], measures: [] },
      safetyFormSign: {
        title1: '作业单位安全教育人',
        title2: '所在单位安全教育人'
      },
      presentImages: [],
      options: {
        navbar: false,
        fullscreen: false
      },
      protoChargerSign: [],
      workChargerSign: [],
      workersSign: []
    }
  },
  computed: {
     ...mapGetters(['userInfo'])
  },
  methods: {
    handleTabChange (tabIndex) {
      if (tabIndex === '1') {
        this.loadRiskDatas()
      } else if (tabIndex === '2') {
        this.loadTicketDetail()
        this.loadSafetyImages()
      } else if (tabIndex === '3') {
        this.loadSafefillin()
      }
    },
    loadRiskDatas () {
      this.getById('/spang-safety/workticket/hotwork/getFullByMainId', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          data = data.hotWorkRiskFillinListVOList
          if (data.length === 0) { return }
          hotWorkRiskFillinList.forEach((item, index) => {
            const riskItem = data.find(risk => risk.titleId === item.titleId)
            if (riskItem) {
              riskItem.measuresValue = riskItem.measuresValue.split(',').map(item => {
                if (item !== '') {
                  return parseInt(item)
                }
                return ''
              })
              if (riskItem.titleId === 9 && riskItem.measuresText !== '' && riskItem.measuresValue.length) {
                  const textValue = riskItem.measuresText.split(',')
                  const optionValue = riskItem.measuresValue
                  for (let j = 0, len = optionValue.length; j < len; j++) {
                    this.$set(item.options[optionValue[j]], 'textValues', [...item.options[optionValue[j]].textValues, textValue[j]])
                  }
                }
              this.$set(this.riskDatas[index], 'signDate', item.signDate)
              this.$set(this.riskDatas[index], 'workTicketHotWorkRiskFillinList', item.workTicketHotWorkRiskFillinList)
              this.riskDatas[index] = Object.assign({}, item, riskItem)
            }
          })
        }
      })
    },
    loadSafetyImages () {
      const params = {
        id: this.ticketId,
        bizType: 'hot_work_safety'
      }
      this.getList('/spang-safety/fileserver/getFilesByBizTypeAndId', params).then(({ data, code }) => {
        if (code === 200) {
          this.presentImages = data.map(item => (this.BASE_URL + '/spang-safety/file' + item.filePath))
        }
      })
    },
    loadTicketDetail () {
      this.getById('/spang-safety/workticket/hotwork/getSafeSignVO', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          this.ticketInfo = Object.assign({}, this.ticketInfo, {
            time1: data.inUserVO.signDate,
            sign1: data.inUserVO.signatureURL,
            time2: data.eduUserVO.signDate,
            sign2: data.eduUserVO.signatureURL
          })
          this.protoChargerSign = [
            {
              time: data.localeGuardianDate,
              person: data.localeGuardianName,
              sign: data.localeGuardianURL
            }
          ]
          this.workersSign = data.workUserList.map(item => ({
            time: item.signTime,
            person: item.userName,
            sign: item.signatureURL
          }))
          this.workChargerSign = [
            {
              time: data.field3Date,
              person: data.field3,
              sign: data.field3URL
            }
          ]
        }
      })
    },
    loadSafefillin () {
      this.getById('/spang-safety/workticket/hotwork/getLocalConfirmById', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          const content = data.content ? JSON.parse(data.content) : {}
          const contentData = { riskType: [], measures: [] }
          for (const key in contentData) {
          	Object.assign(contentData[key], content[key])
          }
          contentData.riskType.forEach(item => {
            Object.assign(item, { fillIn: item.factor })
          })

          contentData.measures.forEach(item => {
            Object.assign(item, { fillIn: item.factor })
          })
          this.safetyForm = contentData
          this.safetyFormSign = Object.assign({}, this.safetyFormSign, {
            title1: '作业单位安全教育人',
            time1: data.signEdu.signDate,
            sign1: data.signEdu.signatureURL,
            title2: '所在单位安全教育人',
            time2: data.signIn.signDate,
            sign2: data.signIn.signatureURL
          })
        }
      })
    }
  },
  created () {
    this.loadRiskDatas()
  }
}
</script>

<style scoped lang="less">
  .color-red {
    color: #F26161;
  }

  .color-green {
    color: #10B24C;
  }
  .font-weight-bold {
    font-size: 14px;
    font-weight: 600;
  }
  .flex-row {
    display: flex;
    .el-col {
      float: none;
    }
  }

  .measure-content-desc {
    display: inline-flex;
  }
  .measure-content-item {
    display: inline-block;
    margin-right: 10px;
    line-height: 1.4;
  }
  .present-img-viewer {
    text-align: center;
  }
  .present-img {
    width: 50px;
    height: 50px;
    margin: 10px;
    cursor: pointer;
  }
  .measure-title-divider {
    margin: 5px 0;
  }
</style>
