<template>
  <div>
    <a-card title="人员指派" style="margin: 15px;">
      <a-form-model :model="form" ref="ruleForm" :label-col="{span: 7}" :wrapper-col="{span:10}">
        <a-form-model-item label="动火单位">
          <a-input
            v-model="form.workUnitName"
            disabled/>
        </a-form-model-item>
        <a-form-model-item label="班组">
          <a-input
            v-model="form.workTeam"
            disabled/>
        </a-form-model-item>
        <a-form-model-item label="动火负责人">
          <div class="flex-input-button">
            <a-input
              v-model="form.field3"
              style="margin-right: 10px;"
              disabled/>
            <a-button :disabled="!canChangePerson" @click="chooseOtherPerson(1)">更换</a-button>
          </div>

        </a-form-model-item>
        <a-form-model-item label="动火人">
          <div
            v-for="(people, index) in form.workUserList"
            :key="people.id">
            <div class="flex-input-button" :style="{marginBottom: index !== form.workUserList.length - 1? '10px': ''}">
              <a-input
                :value="people.userName + ' ' + people.code"
                style="margin-right: 10px;"
                disabled>
                <a-icon slot="addonAfter" :disabled="!canChangePerson" type="delete" @click="deleteHotPerson(index, people)"/>
              </a-input>
              <a-button :disabled="!canChangePerson" v-if="index === 0" @click="hotPersonSelectModalVisible = true">添加</a-button>
            </div>
          </div>
          <div class="flex-input-button" v-if="form.workUserList && form.workUserList.length === 0">
            <a-input
              style="margin-right: 10px;"
              disabled/>
            <a-button :disabled="!canChangePerson" @click="hotPersonSelectModalVisible = true">添加</a-button>
          </div>
        </a-form-model-item>
        <a-form-model-item label="除动火人和作业负责人外的其他人员">
          <div
            v-for="(people, index) in form.otherUserList"
            :key="people.id">
            <div class="flex-input-button" :style="{marginBottom: index !== form.otherUserList.length - 1? '10px': ''}">
              <a-input
                :value="people.userName"
                style="margin-right: 10px;"
                disabled>
                <a-icon
                  slot="addonAfter"
                  type="delete"
                  :disabled="!canChangePerson"
                  @click="deleteOtherPerson(index)"/>
              </a-input>
              <a-button :disabled="!canChangePerson" @click="chooseOtherPerson(2)">添加</a-button>
            </div>
          </div>
          <div class="flex-input-button" v-if="form.otherUserList && form.otherUserList.length === 0">
            <a-input
              style="margin-right: 10px;"
              disabled/>
            <a-button :disabled="!canChangePerson" @click="chooseOtherPerson(2)">添加</a-button>
          </div>
        </a-form-model-item>
      </a-form-model>
    </a-card>
    <person-history :history-datas="historyList" />
    <certificate-person-select-modal
      :visible.sync="hotPersonSelectModalVisible"
      :loading="hotConfirmLoading"
      title="选择动火人"
      @ok="changeHotPerson"
      ticketType="0"
    />
    <person-select-modal
      :visible.sync="personSelectModalVisible"
      :loading="confirmLoading"
      @ok="changeOtherPerson"
      title="人员选择"
      :dept-id="form.workUnitId"
      :multiple="multiple"
    />
  </div>

</template>

<script>
import { getUserAuth } from '@/api/system'
import { mapGetters } from 'vuex'
import PersonHistory from '../component/PersonHistory'
import PersonSelectModal from '../component/PersonSelectModal'
import CertificatePersonSelectModal from '../component/CertificatePersonSelectModal'
export default {
  name: 'WorkDepartment',
  components: { PersonSelectModal, PersonHistory, CertificatePersonSelectModal },
  props: {
    ticketId: {
      type: String,
      default: '',
      required: true
    }
  },
  data () {
    return {
      form: {},
      isAddPerson: false, // 是否是作业分配角色
      personSelectModalVisible: false,
      confirmLoading: false,
      hotPersonSelectModalVisible: false,
      hotConfirmLoading: false,
      personType: 1,
      multiple: true,
      historyList: []
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    canChangePerson () { // 是否是作业分配角色
      return this.isAddPerson && this.form.status >= 2
    }
  },
  methods: {
    loadDetail () {
      return this.getById('/spang-safety/workticket/hotwork/getAssignPeopleVO', this.ticketId)
    },
    getAuth () {
      getUserAuth({
          userId: this.userInfo.id,
          bizCode: 'WORK_TICKETS_ALLOT',
          deptId: this.form.workUnitId
        }).then(res => {
          if (res.code === 200) {
            this.isAddPerson = res.data
          }
        })
    },
    changeHotPerson (users) {
      users.forEach(item => {
        item.isSign = 0
      })
      const personList = [...this.form.workUserList, ...users]
      const obj = {}
      this.form.workUserList = personList.reduce((cur, next) => {
        obj[next.userId] ? '' : obj[next.userId] = true && cur.push(next)
        return cur
      }, [])

      this.submitChange()
    },
    deleteHotPerson (index, people) {
      if (!this.isAddPerson) {
        this.$notification['success']({
            message: '提示',
            description: '没有操作权限',
            duration: 8
          })
        return
      }
      if (people.isSign === 1) {
        this.$notification['success']({
            message: '提示',
            description: '动火人已签字，不能删除',
            duration: 8
          })
        return
      }
      this.form.workUserList.splice(index, 1)
      this.submitChange()
    },
    changeOtherPerson (users) {
      users.forEach(item => item.isSign = 0)
      if (this.personType === 1) {
        this.form.field0 = users[0].userId
        this.form.field3 = users[0].userName
      } else {
        const personList = [...this.form.otherUserList, ...users]
        const obj = {}
        this.form.otherUserList = personList.reduce((cur, next) => {
          obj[next.userId] ? '' : obj[next.userId] = true && cur.push(next)
          return cur
        }, [])
      }

      this.submitChange()
    },
    deleteOtherPerson (index) {
      if (!this.isAddPerson) {
        this.$notification['success']({
            message: '提示',
            description: '没有操作权限',
            duration: 8
          })
        return
      }
      this.form.otherUserList.splice(index, 1)
      this.submitChange()
    },
    submitChange () {
      const params = { ...this.form, id: this.ticketId }
      delete params.status
      this.submitForm('/spang-safety/workticket/hotwork/submitAssignPeople', params, 'put').then(({ data, code }) => {
        if (code === 200) {
          this.$notification['success']({
            message: '提示',
            description: '更换成功',
            duration: 8
          })
          this.loadDetail()
          this.personSelectModalVisible = false
          this.hotPersonSelectModalVisible = false
        }
      }).catch(() => {
        this.$notification['error']({
            message: '提示',
            description: '提交失败',
            duration: 8
          })
        this.personSelectModalVisible = false
        this.hotPersonSelectModalVisible = false
        this.loadDetail()
      })
    },
    chooseOtherPerson (type) {
      if (type === 1) {
        this.multiple = false
      } else {
        this.multiple = true
      }
      this.personSelectModalVisible = true
      this.personType = type
    },
    getPersonList () {
      this.getById('/spang-safety/user-history', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          this.historyList = data
        }
      })
    }
  },
  async created () {
    const data = await this.loadDetail()
    if (data.code === 200) {
      this.form = data.data
      this.getPersonList()
      this.getAuth()
    }
  }
}
</script>

<style scoped lang="less">
.flex-input-button {
  display: flex;
  justify-content: space-between;
}
/deep/ .ant-table {
  height: auto;
}
</style>
