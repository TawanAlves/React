<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="12" :sm="12" :xs="24">
              <a-form-item label="作业类型">
                <a-select v-model="queryParam.type" placeholder="请选择作业类型">
                  <a-select-option
                    v-for="item in ticketTypes"
                    :key="item.dictKey"
                  >{{ item.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="12" :sm="12" :xs="24">
              <a-form-item label="申请单位">
                <a-tree-select
                  v-model="queryParam.applyUnitId"
                  style="width: 100%;"
                  :dropdownStyle="{ maxHeight:'35vh', overflow: 'auto'}"
                  :tree-data="applyUnitsData"
                  allowClear
                  placeholder="请选择单位"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="12" :sm="12" :xs="24">
              <a-form-item label="作业时间">
                <a-range-picker
                  valueFormat="YYYY-MM-DD HH:mm:ss"
                  v-model="queryParam.time"
                  showTime
                  style="width: 100%; min-width: 110px;"
                  placeholder="请选择作业时间"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="12" :sm="12" :xs="24">
              <a-form-item label="作业状态">
                <a-select v-model="queryParam.status" placeholder="请选择作业状态">
                  <a-select-option v-for="item in taskStatus" :key="item.value">{{ item.label }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <!--            <a-col :span="8">-->
            <!--              <a-form-item label="作业状态">-->
            <!--                <a-select v-model="queryParam.status" placeholder="请选择作业状态">-->
            <!--                  <a-select-option v-for="item in ticketStatus" :key="item.value">-->
            <!--                    {{ item.label }}-->
            <!--                  </a-select-option>-->
            <!--                </a-select>-->
            <!--              </a-form-item>-->
            <!--            </a-col>-->
            <a-col :lg="6" :md="12" :sm="12" :xs="24">
              <a-form-item label="作业票编号" style="margin-bottom: 0;">
                <a-input v-model="queryParam.code" placeholder="请输入作业票编号" />
              </a-form-item>
            </a-col>
            <a-col  :lg="18" :md="12" :sm="12" :xs="24"class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="researchRecord">查询</a-button>
                <a-button type="second" @click="resetRecord">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="card-title">
          <div>作业票列表</div>
          <a-button type="primary" icon="plus" @click="modalVisible = true" style="float:right">新建</a-button>
        </div>
      </template>
      <s-table
        ref="tableList"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{ y: 450, x: 1390 }"
        showPagination="true"
        :pageNum="pageNo"
        :pageSize="pageSize"
        :showIndexColumn="true"
      >
        <span slot="taskStatus" slot-scope="text, record, index">
          <template v-if="record.status === 0">已验收</template>
          <template v-else>{{ taskStatusFilter(record, record.status) }}</template>
        </span>
        <span slot="time" slot-scope="text, record">
          <template
            v-if="record.planStartTime && record.planEndTime"
          >{{ record.planStartTime }}&nbsp;至&nbsp;{{ record.planEndTime }}</template>
        </span>
        <span slot="processStatus" slot-scope="text, record">
          <a-tag :color="record.status===2 || record.status===5?'red':'green'">{{ text }}</a-tag>
        </span>
        <span slot="action" slot-scope="text, record, index">
          <a @click="operateTask(record, 'add')" :disabled="!judgeAuth(record)">编辑</a>
          <a-divider type="vertical" />
          <a @click="operateTask(record, 'detail')">查看</a>
          <template v-if="false">
            <a-divider type="vertical" />
            <a @click="taskCheck(record)">打印</a>
            <a-divider type="vertical" />
            <a @click="taskCheck(record)" class="text-danger">作废</a>
          </template>
        </span>
      </s-table>
    </a-card>
    <a-modal
      :bodyStyle="{maxHeight:'700px',overflow:'auto',paddingTop: '5px'}"
      :width="906"
      :visible="modalVisible"
      :closable="false"
      :footer="null"
      @cancel="() => { modalVisible = false }"
      wrapClassName="dialog-custom"
      :keyboard="false"
      :maskClosable="false"
    >
      <template #title>
        <div class="upper-title">请选择作业类型</div>
        <div class="bottom-title">PLEASE SELECT JOB TYPE</div>
      </template>
      <a-list
        :grid="{ gutter: 16, xs: 1, sm: 2, md: 4, lg: 4, xl: 6, xxl: 3 }"
        :data-source="tickets"
      >
        <a-list-item slot="renderItem" slot-scope="item, index">
          <div class="ticket-item" @click="addTicket(item)">
            <img :src="item.src" />
            <span>{{ item.title }}</span>
          </div>
        </a-list-item>
      </a-list>
    </a-modal>
  </page-container>
</template>

<script>
import { task, getPersonnelTree } from '@/api/safety'
import { ticketColumns, taskTypes } from '@/views/safety/table'
import { mapGetters } from 'vuex'
import { STable } from '@/components'
import OtherTaskModal from './component/OtherTaskModal'
import { getDict, getUserAuth } from '@/api/system'
import URLS from '@/api/exam-url'
import ApiURLs from '@/api/urls'
export default {
  name: 'Manage',
  components: { OtherTaskModal, STable },
  data() {
    this.columns = ticketColumns
    return {
      ticketStatusOption: [
        {
          label: '草稿',
          value: 1
        },
        {
          label: '已提交',
          value: 2
        },
        {
          label: '作业单位确认提交',
          value: 3
        },
        {
          label: '审核人提交',
          value: 4
        },
        {
          label: '审核通过',
          value: 5
        },
        {
          label: '验票',
          value: 6
        },
        {
          label: '最终验收',
          value: 0
        }
      ],
      pageNo: 1,
      pageSize: 10,
      editBtnAuth: false, // 编辑权限
      queryParam: {},
      applyUnitsData: [],
      modalVisible: false,
      ticketTypes: [],
      tickets: taskTypes,
      loadData: async parameter => {
        await this.getAuth()
        const requestParameters = {
          current: parameter.pageNo,
          size: parameter.pageSize,
          userId: this.userInfo.id
        }
        Object.assign(requestParameters, this.queryParam)
        if (this.queryParam.time) {
          Object.assign(requestParameters, {
            startTime: this.queryParam.time[0],
            endTime: this.queryParam.time[1]
          })
        }
        delete requestParameters.time;
        const url = `/spang-safety/basic-information/page`
        return this.getList(url,requestParameters).then(res => {
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      taskStatus: [
        {
          label: '草稿',
          value: 1
        },
        {
          label: '已验收',
          value: 0
        },
        {
          label: '作业中',
          value: 9
        }
      ]
    }
  },
  computed: {
    ...mapGetters(['userInfo'])
  },
  methods: {
    getApplyUnits() {
      getPersonnelTree(0).then(res => {
        this.applyUnitsData = res.data
      })
    },
    addTicket(item) {
      this.modalVisible = false
      this.$router.push('/safety/task/add/' + item.name + '/-1')
    },
    operateTask(item, operate) {
      const ticket = this.tickets.find(ticket => ticket.type === item.ticketType)
      if (!ticket) {
        return
      }
      this.$router.push(`/safety/task/${operate}/${ticket.name}/${item.id}`)
    },
    taskStatusFilter(record, status) {
      const statuses = this.ticketStatusOption
      if (record.ticketType === 0) {
        statuses[5].label = '班长验票'
      } else {
        statuses[5].label = '安全落实'
      }
      const result = statuses.find(item => item.value === status)
      if (result) {
        return result.label
      }
      return ''
    },
    researchRecord() {
      this.$refs.tableList.refresh(true)
      this.$refs.tableList.clearSelected()
    },
    resetRecord() {
      this.queryParam = {}
      this.$refs.tableList.refresh(true)
      this.$refs.tableList.clearSelected()
    },
    getDict() {
      getDict('WORK_TICKET_TYPE').then(({ data }) => {
        this.ticketTypes = data
      })
    },
    judgeAuth(values) {
      const formStatus = values.status
      const userInfo = this.userInfo
      if (formStatus === 0) {
        return false
      } else if (formStatus === 1) {
        // 编辑按钮 权限
        return values.applicantId === userInfo.id
      } else if (formStatus < 4) {
        return  values.applicantId === userInfo.id
        // return this.editBtnAuth
      } else {
        return false
      }
    },
    getAuth() {
      getUserAuth({
        userId: this.userInfo.id,
        deptId: this.userInfo.deptId,
        bizCode: 'WORK_TICKETS_TEAM'
      }).then(res => {
        if (res.code === 200) {
          this.editBtnAuth = res.data
        }
      })
    }
  },
  watch: {
    $route: {
      // 防止因为keep-alive缓存了页面新建作业后列表不刷新问题
      handler(to) {
        if (to.name === 'taskmanage') {
          console.log(to.name)
          this.resetRecord()
        }
      }
    }
  },
  created() {
    this.getApplyUnits()
    this.getDict()
  }
}
</script>

<style scoped lang="less">
.card-title {
  display: flex;
  justify-content: space-between;
}

.text-danger {
  color: #f26161;
}

.text-gray {
  color: #b7b7b7;
}

/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

/deep/ .dialog-custom {
  .ant-modal-content {
    border-radius: 6px;
  }

  .ant-modal-title {
    text-align: center;
    font-weight: 600;

    .upper-title::after {
      content: ' ';
      width: 55px;
      height: 9px;
      background: #2bba78;
      border-radius: 3px;
      display: block;
      margin: 0 auto;
      margin-top: -4px;
    }
    .bottom-title {
      color: rgba(0, 0, 0, 0.25);
      line-height: 17px;
    }
  }

  .ant-modal-header {
    border-bottom: none;
    margin: 3px;
  }
}

.ticket-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 187px;
  height: 127px;
  margin: 0 auto;
  border-radius: 6px;

  &:hover {
    background-color: #e0faea;
    cursor: pointer;
  }

  img {
    width: 70px;
    height: 72px;
  }
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 92px;
}
</style>
