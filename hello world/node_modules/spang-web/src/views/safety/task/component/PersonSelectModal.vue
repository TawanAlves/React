<template>
  <a-modal
    :title="title"
    :dept-id="deptId"
    :visible="visible"
    :confirmLoading="loading"
    :maskClosable="false"
    @ok="handleSubmit"
    @cancel="() => { $emit('cancel'); $emit('update:visible', false) }"
    ok-text="确定"
    cancel-text="取消"
    width="50%"
    :destroyOnClose="true"
  >
    <div class="table-page-search-wrapper" style="margin-bottom: 20px">
      <a-form layout="inline">
        <a-row :gutter="24">
          <a-col :span="8">
            <a-form-item label="单位">
              <a-tree-select
                v-model="queryParam.deptId"
                style="width: 100%;"
                :dropdownStyle="{ maxHeight:'35vh', overflow: 'auto'}"
                :tree-data="applyUnitsData"
                allowClear
                placeholder="请选择单位"
              />
            </a-form-item>
          </a-col>
          <a-col :span="8">
            <a-form-item label="姓名" style="margin-bottom: 0;">
              <a-input v-model="queryParam.realName" placeholder="请输入姓名" :max-length="32" />
            </a-form-item>
          </a-col>
          <a-col :span="6">
            <span class="table-page-search-submitButtons">
              <a-button type="primary" @click="researchRecord">查询</a-button>
              <a-button type="second" @click="resetRecord" style="margin-left: 10px">重置</a-button>
            </span>
          </a-col>
        </a-row>
      </a-form>
    </div>
    <a-table
      ref="table"
      size="default"
      :rowKey="record => record.id"
      :columns="columns"
      :dataSource="personList"
      :alert="false"
      :scroll="{ y: 350 }"
      :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
      :pagination="pagination"
      @change="handleTableChange"
    ></a-table>
  </a-modal>
</template>

<script>
import { getUsersWithPage } from '@/api/system'
import { getPersonnelTree } from '@/api/safety'
export default {
  name: 'PersonSelectModal',
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: false
    },
    multiple: {
      type: Boolean,
      default: false
    },
    deptId: {
      type: String,
      default: null
    },
    title: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      pagination: {
        pageSize: 10,
        current: 1,
        total: 0,
        showSizeChanger: true
      },
      applyUnitsData: [],
      selectedRowKeys: [],
      queryParam: {
        deptId: this.deptId
      },
      personList: [],
      columns: [
        {
          title: '姓名',
          dataIndex: 'realName',
          align: 'center'
        },
        {
          title: '工作单位',
          dataIndex: 'deptName',
          align: 'center'
        },
        {
          title: '性别',
          dataIndex: 'sex',
          align: 'center',
          customRender: (text, record) => {
            const map = { 2: '女', 1: '男' }
            return map[record.sex] || ''
          }
        },
        {
          title: '电话',
          dataIndex: 'phone',
          align: 'center'
        },
        {
          title: '邮箱',
          dataIndex: 'email',
          align: 'center'
        }
      ]
    }
  },
  watch: {
    deptId(value) {
      this.queryParam.deptId = value
      this.loadData()
    }
  },
  computed: {
    rowSelectMode() {
      if (this.multiple) {
        return 'checkbox'
      } else {
        return 'radio'
      }
    }
  },
  methods: {
    getApplyUnits() {
      getPersonnelTree(0).then(res => {
        this.applyUnitsData = res.data
      })
    },
    researchRecord() {
      this.pagination.current = 1
      this.loadData()
    },
    resetRecord() {
      this.queryParam = {}
      this.selectedRowKeys = []
      this.loadData()
    },
    loadData() {
      const params = { ...this.queryParam, current: this.pagination.current, size: this.pagination.pageSize }
      getUsersWithPage(params).then(({ data, code }) => {
        if (code === 200) {
          this.personList = data.records
          this.pagination.current = data.current
          this.pagination.total = data.total
        }
      })
    },
    handleSubmit() {
      if (this.selectedRowKeys.length === 0) {
        this.$message.warning('请至少选择一个人员')
      } else {
        const datas = this.personList
          .filter(item => this.selectedRowKeys.includes(item.id))
          .map(item => ({
            userName: item.realName,
            userId: item.id,
            code: item.code,
            deptId: item.deptId,
            deptName: item.deptName,
            postId: item.postId,
            postName: item.postName
          }))
        this.selectedRowKeys = []
        this.selectedRows = []
        this.$emit('ok', datas)
        this.$emit('update:visible', false)
      }
    },
    onSelectChange(selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys
    },
    handleTableChange(pagination) {
      const pager = { ...this.pagination }
      pager.current = pagination.current
      pager.pageSize = pagination.pageSize
      this.pagination = pager
      this.loadData()
    }
  },
  created() {
    this.loadData()
    this.getApplyUnits()
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-modal-title {
  font-size: 18px;
}
/deep/ .ant-card-head-title {
  font-weight: bolder;
  padding: 0 !important;
}

/deep/ .ant-table {
  height: auto;
}
</style>
