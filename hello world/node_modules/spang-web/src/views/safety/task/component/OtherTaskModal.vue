<template>
  <a-modal
    title="添加其他特殊作业"
    :visible="visible"
    :confirmLoading="loading"
    @ok="() => { $emit('ok', hasSelectedList) }"
    @cancel="() => { $emit('update:visible', false) }"
    ok-text="提交"
    cancel-text="返回"
    width="60%"
    destroyOnClose
    :keyboard="false"
    :maskClosable="false"
  >
    <div class="table-page-search-wrapper">
      <a-form layout="inline">
        <a-row :gutter="24">
          <a-col :md="8">
            <a-form-item label="作业类型">
              <a-select v-model="queryParam.type" placeholder="请选择作业类型">
                <a-select-option v-for="item in ticketTypes" :key="item.dictKey">
                  {{ item.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :md="8">
            <a-form-item label="申请单位">
              <a-tree-select
                v-model="queryParam.applyUnitId"
                style="width: 100%;"
                :dropdownStyle="{ maxHeight:'35vh', overflow: 'auto'}"
                :tree-data="applyUnitsData"
                allowClear
                placeholder="请选择单位"
              />
            </a-form-item>
          </a-col>
          <a-col :span="8">
            <a-form-item label="作业证编号" style="margin-bottom: 0;">
              <a-input v-model="queryParam.code" placeholder="请输入作业证编号"/>
            </a-form-item>
          </a-col>

        </a-row>
        <a-row :gutter="24" style="text-align: right">
          <span class="table-page-search-submitButtons">
            <a-button type="primary" @click="researchRecord">查询</a-button>
            <a-button type="second" @click="resetRecord" style="margin-left: 10px">重置</a-button>
          </span>
        </a-row>
      </a-form>
    </div>
    <a-table
      ref="table"
      size="default"
      :rowKey="record => record.id"
      :columns="columns"
      :dataSource="otherTaskList"
      :alert="false"
      :scroll="{ y: 350 }"
      :row-selection="{ selectedRowKeys: selectedRowKeys0, onSelect: onSelectChange, onSelectAll: onSelectAll }"
      :pagination="pagination"
      @change="handleTableChange"
    >
      <span slot="time" slot-scope="text, record">
        <template v-if="record.planStartTime && record.planEndTime">
          {{ record.planStartTime }}&nbsp;至&nbsp;{{ record.planEndTime }}
        </template>
      </span>
    </a-table>
    <div class="header-sm">已选</div>
    <a-divider />
    <a-table
      ref="table-selected"
      size="default"
      :rowKey="record => record.id"
      :columns="columns"
      :showHeader="false"
      :dataSource="hasSelectedList"
      :alert="false"
      :scroll="{ y: 350 }"
      :row-selection="{ selectedRowKeys: selectedRowKeys, onSelect: onHasSelectedChange}"
      :pagination="false"
    >
      <span slot="time" slot-scope="text, record">
        <template v-if="record.planStartTime && record.planEndTime">
          {{ record.planStartTime }}&nbsp;至&nbsp;{{ record.planEndTime }}
        </template>
      </span>
    </a-table>
  </a-modal>
</template>

<script>
import { getPersonnelTree, getOtherTaskList } from '@/api/safety'
import { otherTaskColumns } from '@/views/safety/table'
import { getDict } from '@/api/system'
import cloneDeep from 'lodash.clonedeep'
export default {
  name: 'OtherTaskModal',
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    }
  },
  data () {
    return {
      pagination: {
        pageSize: 10,
        current: 1
      },
      queryParam: {},
      columns: otherTaskColumns,
      otherTaskList: [],
      hasSelectedList: [],
      selectedRowKeys: [],
      selectedRowKeys0: [],
      ticketTypes: [],
      applyUnitsData: []
    }
  },
  computed: {},
  methods: {
    onSelectChange (record, selected) {
      if (selected) {
        const exist = this.hasSelectedList.find(item => item.id === record.id)
        if (!exist) {
          this.hasSelectedList.push(record)
          this.selectedRowKeys.push(record.id)
          this.selectedRowKeys0.push(record.id)
        }
      } else {
        this.selectedRowKeys0 = this.selectedRowKeys0.filter(item => item !== record.id)
      }
    },
    onSelectAll (selected) {
      if (selected) {
        this.selectedRowKeys0 = this.otherTaskList.map(item => (item.id))
        this.selectedRowKeys = this.selectedRowKeys0
        this.hasSelectedList = cloneDeep(this.otherTaskList)
      } else {
        this.selectedRowKeys0 = []
      }
    },
    onHasSelectedChange (record, selected) {
      if (!selected) {
        this.selectedRowKeys = this.selectedRowKeys.filter(item => item !== record.id)
        this.hasSelectedList = this.hasSelectedList.filter(item => item.id !== record.id)
        this.selectedRowKeys0 = this.selectedRowKeys0.filter(item => item !== record.id)
      }
    },
    loadData () {
      const params = {
        ...this.queryParam,
        size: this.pagination.pageSize,
        current: this.pagination.current
      }
      getOtherTaskList(params).then(({ data, code }) => {
        if (code === 200) {
          this.otherTaskList = data.records
          const pagination = { ...this.pagination }
          pagination.total = data.total
          this.pagination = pagination
        }
      })
    },
    resetRecord () {
      this.queryParam = {}
      this.loadData()
    },
    getDict () {
      getDict('WORK_TICKET_TYPE').then(({ data }) => {
		  	this.ticketTypes = data
		  })
      getPersonnelTree(0).then(res => {
          this.applyUnitsData = res.data
      })
    },
    handleTableChange (pagination) {
      const pager = { ...this.pagination }
      pager.current = pagination.current
      this.pagination = pager
      this.loadData()
    },
    researchRecord () {
      this.loadData()
    }
  },
  created () {
    this.getDict()
    this.loadData()
  }
}
</script>

<style scoped lang="less">
  /deep/ .ant-table {
    height: auto;
  }
  .table-page-search-submitButtons {
    float: right;
  }
  .header-sm {
    font-size: 14px;
    font-weight: 600;
    color: #000000;
    line-height: 20px;
  }
</style>
