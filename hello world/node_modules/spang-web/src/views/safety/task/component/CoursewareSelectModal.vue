<template>
  <a-modal
    :title="title"
    :dept-id="coursewareTypeId"
    :visible="visible"
    :confirmLoading="loading"
    @ok="handleSubmit"
    @cancel="cancel"
    ok-text="提交"
    cancel-text="返回"
    width="50%"
    :destroyOnClose="true"
    :keyboard="false"
    :maskClosable="false"
  >
    <div class="table-page-search-wrapper" style="margin-bottom: 20px">
      <a-form layout="inline">
        <a-row :gutter="24">
          <a-col :span="8">
            <a-form-item label="课件名称" style="margin-bottom: 0;">
              <a-input v-model="queryParam.coursewareName" placeholder="请输入课件名称" />
            </a-form-item>
          </a-col>
          <a-col :span="8">
            <a-form-item label="课件类型">
              <a-select
                show-search
                v-model="queryParam.coursewareTypeId"
                placeholder="课件类型"
                style="width: 100%"
              >
                <a-select-option v-for="d in coursewareOptions" :key="d.dictKey">{{ d.dictValue }}</a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :span="6">
            <span class="table-page-search-submitButtons">
              <a-button type="primary" @click="researchRecord">查询</a-button>
              <a-button type="second" @click="resetRecord" style="margin-left: 10px">重置</a-button>
            </span>
          </a-col>
        </a-row>
      </a-form>
    </div>
    <a-table
      ref="table"
      size="default"
      :rowKey="record => record.id"
      :columns="columns"
      :dataSource="personList"
      :alert="false"
      :scroll="{ y: 350 }"
      :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
      :pagination="pagination"
      @change="handleTableChange"
    ></a-table>
  </a-modal>
</template>

<script>
import { getCourseware } from '@/api/system'
import { getPersonnelTree } from '@/api/safety'
export default {
  name: 'CoursewareSelectModal',
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: false
    },
    multiple: {
      type: Boolean,
      default: false
    },
    coursewareTypeId: {
      type: String,
      default: ''
    },
    title: {
      type: String,
      default: ''
    }
  },
  data() {
    return {
      pagination: {
         pageSize: 10,
        current: 1,
        total: 0,
        showSizeChanger: true
      },
      applyUnitsData: [],
      selectedRowKeys: [],
      queryParam: {
        coursewareName: '',
        coursewareTypeId: '',
        status:0
      },
      personList: [],
      columns: [
        {
          title: '课件名称',
          dataIndex: 'coursewareName',
          align: 'center'
        },
        {
          title: '课件类型',
          dataIndex: 'coursewareTypeName',
          align: 'center'
        }
      ]
    }
  },
  watch: {
    coursewareTypeId(value) {
      this.queryParam.coursewareTypeId = value
      this.loadData()
    }
  },
  computed: {
    rowSelectMode() {
      if (this.multiple) {
        return 'checkbox'
      } else {
        return 'radio'
      }
    }
  },
  methods: {
    //查询
    researchRecord() {
      this.loadData()
    },
    //重置
    resetRecord() {
      this.queryParam = {
        coursewareName: '',
        coursewareTypeId: '',
        status:0
      }
      this.pagination.current = 1
      this.loadData()
    },
    loadData() {
      this.axios
        .post('/spang-edu/admin/coursewareInfo/plan/list', this.queryParam, {
          params: {
            size: this.pagination.pageSize,
            current: this.pagination.current,
          }
        })
        .then(rs => {
          if (rs.code === 200) {
            this.personList = rs.data.records
            this.pagination.current = rs.data.current
            this.pagination.total = rs.data.total
            console.log(this.pagination.total)
          }
        })
    },
    handleSubmit(data) {
      const datas = this.personList
        .filter(item => this.selectedRowKeys.includes(item.id))
        .map(item => ({
          coursewareDesc: item.coursewareDesc,
          coursewareName: item.coursewareName,
          coursewareTypeId: item.coursewareTypeId,
          coursewareTypeName: item.coursewareTypeName,
          gmtCreateId: item.gmtCreateId,
          createName: item.createName,
          createTime: item.createTime,
          id: item.id,
          publishRange: item.publishRange,
          resourceId: item.resourceId,
          status: item.status,
          updateBy: item.updateBy,
          updateTime: item.updateTime
        }))
      this.selectedRowKeys = []
      this.selectedRows = []
      this.$emit('ok', datas)
      this.$emit('update:visible', false)
      this.resetRecord()
    },
    cancel() {
      this.visible = false
      this.$emit('update:visible',false)
      this.resetRecord()
    },
    onSelectChange(selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys
    },
    handleTableChange(pagination) {
      const pager = { ...this.pagination }
      pager.current = pagination.current
      pager.pageSize = pagination.pageSize
      this.pagination = pager
      this.loadData()
    }
  },
  created() {
    this.loadData()
    //课件类型下拉框
    this.getDict('courseware_type').then(({ data, success }) => {
      if (success) {
        this.coursewareOptions = data
      }
    })
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-modal-title {
  font-size: 18px;
}
/deep/ .ant-card-head-title {
  font-weight: bolder;
  padding: 0 !important;
}

/deep/ .ant-table {
  height: auto;
}
</style>
