<template>
  <a-modal
    :title="title"
    :visible="visible"
    :confirmLoading="loading"
    @ok="handleSubmit"
    @cancel="() => { $emit('update:visible', false) }"
    ok-text="提交"
    cancel-text="返回"
    width="60%"
    :keyboard="false"
    :maskClosable="false"
  >
    <div class="table-page-search-wrapper">
      <a-form layout="inline">
        <a-row :gutter="24">
          <a-col :span="8">
            <a-form-item label="姓名" style="margin-bottom: 0;">
              <a-input v-model="queryParam.userName" placeholder="请输入姓名"/>
            </a-form-item>
          </a-col>

        </a-row>
        <a-row :gutter="24" style="text-align: right">
          <span class="table-page-search-submitButtons">
            <a-button type="primary" @click="researchRecord">查询</a-button>
            <a-button type="second" @click="resetRecord" style="margin-left: 10px">重置</a-button>
          </span>
        </a-row>
      </a-form>
    </div>
    <a-table
      ref="table"
      size="default"
      :rowKey="record => record.id"
      :columns="columns"
      :dataSource="personList"
      :alert="false"
      :scroll="{ y: 350 }"
      :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange }"
      :pagination="pagination"
      @change="handleTableChange"
    >
    </a-table>
  </a-modal>
</template>

<script>
import { getCertificateList } from '@/api/safety'
export default {
  name: 'CertificatePersonSelectModal',
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    title: {
      type: String,
      default: ''
    },
    ticketType: {
      type: String,
      default: ''
    }
  },
  data () {
    return {
      pagination: {
        pageSize: 10,
        current: 1
      },
      selectedRowKeys: [],
      queryParam: {},
      personList: [],
      columns: [
        {
          title: '姓名',
          dataIndex: 'userName',
          align: 'center'
        },
        {
          title: '证件编号',
          dataIndex: 'certificateCode',
          align: 'center'
        },
        {
          title: '证件名称',
          dataIndex: 'certificateName',
          align: 'center'
        },
        {
          title: '证件有效截止期',
          dataIndex: 'effectiveEndDate',
          align: 'center'
        }
      ]
    }
  },
  methods: {
    researchRecord () {
      this.loadData()
    },
    resetRecord () {
      this.queryParam = {}
    },
    loadData () {
      const params = {
        ...this.queryParam,
        size: this.pagination.pageSize,
        current: this.pagination.current,
        workTitcket: this.ticketType
      }
      getCertificateList(params).then(({ data, code }) => {
        if (code === 200) {
          this.personList = data.records
          const pagination = { ...this.pagination }
          pagination.total = data.total
          this.pagination = pagination
        }
      })
    },
    handleSubmit () {
      const datas = this.personList.filter(item => this.selectedRowKeys.includes(item.id))
      this.$emit('ok', datas)
    },
    onSelectChange (selectedRowKeys) {
      this.selectedRowKeys = selectedRowKeys
    },
    handleTableChange (pagination) {
      const pager = { ...this.pagination }
      pager.current = pagination.current
      this.pagination = pager
      this.loadData()
    }
  },
  created () {
    this.loadData()
  }
}
</script>

<style scoped lang="less">
  /deep/ .ant-table {
    height: auto;
  }
</style>
