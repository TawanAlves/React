<template>
  <a-card style="margin: 15px;">
    <a-tabs
      default-active-key="1"
      tab-position="left"
      @change="handleTabChange"
    >
      <a-tab-pane key="1" tab="风险辨识">
        <div class="risk-title">危害识别：（工艺设备、作业工具、作业地点是否存在下列危险）</div>
        <a-row :gutter="24">
          <template v-for="(item, index) in riskDatas.riskIdentify">
            <a-col :span="8" :key="index" class="line-height-md" v-if="!item.content">
              <a-checkbox v-model="item.checked" disabled></a-checkbox>
              <span class="mx-5">{{ item.label }}</span>
            </a-col>
            <a-col :span="24" :key="index" class="line-height-md" v-else>
              <a-checkbox v-model="item.checked" disabled></a-checkbox>
              <span class="mx-5">{{ item.label }}</span>
              <span>{{ item.content }}</span>
            </a-col>
          </template>

        </a-row>
        <div class="risk-title">安全技术要求</div>
        <a-row :gutter="24">
          <a-col :span="12" v-for="(item, index) in riskDatas.specification" :key="index" class="line-height-md">
            <a-checkbox v-model="item.checked" disabled></a-checkbox>
            <span class="mx-5">{{ item.label }}</span>
          </a-col>
        </a-row>
        <div class="risk-title">工作前安全措施</div>
        <a-row :gutter="24">
          <template v-for="(item, index) in riskDatas.measure">
            <a-col :span="8" :key="index" class="line-height-md" v-if="!item.content">
              <a-checkbox v-model="item.checked" disabled></a-checkbox>
              <span class="mx-5">{{ item.label }}</span>
            </a-col>
            <a-col :span="24" :key="index" class="line-height-md" v-else>
              <a-checkbox v-model="item.checked" disabled></a-checkbox>
              <span class="mx-5">{{ item.label }}</span>
              <span>{{ item.content }}</span>
            </a-col>
          </template>
        </a-row>
        <div class="risk-title">个人防护装备</div>
        <a-row :gutter="24">
          <template v-for="(item, index) in riskDatas.equipment">
            <a-col :span="8" :key="index" class="line-height-md" v-if="!item.content">
              <a-checkbox v-model="item.checked" disabled></a-checkbox>
              <span class="mx-5">{{ item.label }}</span>
            </a-col>
            <a-col :span="24" :key="index" class="line-height-md" v-else>
              <a-checkbox v-model="item.checked" disabled></a-checkbox>
              <span class="mx-5">{{ item.label }}</span>
              <span>{{ item.content }}</span>
            </a-col>
          </template>
        </a-row>
        <horizontal-list :list-data="riskFormSign"></horizontal-list>
      </a-tab-pane>
      <a-tab-pane key="2" tab="安全签字">
        <signature-list :list-data="signatureList"></signature-list>
        <template v-if="presentImages.length > 0">
          <a-divider/>
          <div class="measure-title">
            现场图片
            <viewer :images="presentImages" class="present-img-viewer">
              <img v-for="src in presentImages" :key="src" :src="src" class="present-img">
            </viewer>
          </div>
        </template>
      </a-tab-pane>
      <a-tab-pane key="3" tab="安全交底">
        <safety-disclosure :content-data="safetyForm"></safety-disclosure>
        <horizontal-list :list-data="safetyFormSign"></horizontal-list>
      </a-tab-pane>
    </a-tabs>
  </a-card>
</template>

<script>
import { hotWorkRiskFillinList } from './risks'
import { safetyForm } from '../component/risk'
import { mapGetters } from 'vuex'
import SignImg from '../component/SignImg'
import HorizontalList from '../component/HorizontalList'
import SafetyDisclosure from '../component/SafetyDisclosure'
import cloneDeep from 'lodash.clonedeep'
import SignatureList from '../component/SignatureList'
export default {
  name: 'Confirmation',
  components: { SignImg, HorizontalList, SafetyDisclosure, SignatureList },
  props: {
    ticketId: {
      type: String,
      default: '',
      required: true
    }
  },
  data () {
    return {
      riskDatas: cloneDeep(hotWorkRiskFillinList),
      safetyForm: cloneDeep(safetyForm),
      safetyFormSign: {
        title1: '作业单位安全教育人',
        title2: '所在单位安全教育人'
      },
      riskFormSign: {
        title1: '作业单位安全教育人',
        title2: '所在单位安全教育人'
      },
      signatureList: [
        {
          title: '作业单位安全教育人'
        },
        {
          title: '所在单位安全教育人'
        },
        {
          title: '安全措施落实人'
        }
      ],
      presentImages: [],
      options: {
        navbar: false,
        fullscreen: false
      }
    }
  },
  computed: {
     ...mapGetters(['userInfo'])
  },
  methods: {
    handleTabChange (tabIndex) {
      if (tabIndex === '1') {
        this.loadRiskDatas()
      } else if (tabIndex === '2') {
        this.loadTicketDetail()
      } else if (tabIndex === '3') {
        this.loadSafefillin()
      }
    },
    loadRiskDatas () {
      const params = {
        id: this.ticketId,
        type: 0
      }
      this.getList('/spang-safety/locale-confirm', params).then(({ data, code }) => {
        if (code === 200) {
					const content = data.content ? JSON.parse(data.content) : {}
          for (const riskType in this.riskDatas) {
            this.riskDatas[riskType] = this.riskDatas[riskType].map((item, index) => {
              return Object.assign({}, item, content[riskType][index])
            })
          }
          data.signUsers.forEach(item => {
              if (item.userType === 0) {
                this.riskFormSign = Object.assign({}, this.riskFormSign, {
                  // person1: item.userName,
                  time1: item.signDate,
                  sign1: item.signatureURL
                })
              }
              if (item.userType === 1) {
                this.riskFormSign = Object.assign({}, this.riskFormSign, {
                  // person2: item.userName,
                  time2: item.signDate,
                  sign2: item.signatureURL
                })
              }
					})
        }
      })
    },
    loadTicketDetail () {
      const params = {
        id: this.ticketId,
        type: 2
      }
      this.getList('/spang-safety/locale-confirm', params).then(({ data, code }) => {
          data.signUsers.forEach(item => {
              if (item.userType === 0) {
                this.$set(this.signatureList[0], 'time', item.signDate)
                this.$set(this.signatureList[0], 'sign', item.signatureURL)
              }
              if (item.userType === 1) {
                this.$set(this.signatureList[1], 'time', item.signDate)
                this.$set(this.signatureList[1], 'sign', item.signatureURL)
              }
					})
        this.presentImages = data.files.map(item => (this.BASE_URL + '/spang-safety/file' + item.filePath))
      })
      this.getById('/spang-safety/locale-confirm/sign', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          const signData = data['5'] && data['5'].length > 0 ? data['5'][0] : {}
          this.signatureList[2] = Object.assign({}, this.signatureList[2], {
            time: signData.signTime,
            sign: signData.signatureUrl
          })
        }
      })
    },
    loadSafefillin () {
      const params = {
        id: this.ticketId,
        type: 4
      }
      this.getList('/spang-safety/locale-confirm', params).then(({ data, code }) => {
        if (code === 200) {
          const content = data.content ? JSON.parse(data.content) : {}
          content.riskType.forEach((item, index) => {
            Object.assign(this.safetyForm.riskType[index], item, { fillIn: item.factor })
          })

          content.measures.forEach((item, index) => {
            Object.assign(this.safetyForm.measures[index], item, { fillIn: item.content, content: item.type })
          })
          const signData = {}
          data.signUsers.forEach(item => {
              if (item.userType === 0) {
                signData.time1 = item.signDate
                signData.sign1 = item.signatureURL
              }
              if (item.userType === 1) {
                signData.time2 = item.signDate
                signData.sign2 = item.signatureURL
              }
					})
          this.safetyFormSign = Object.assign({}, this.safetyFormSign, signData)
        }
      })
    }
  },
  created () {
    this.loadRiskDatas()
  }
}
</script>

<style scoped lang="less">
  .color-red {
    color: #F26161;
  }

  .color-green {
    color: #10B24C;
  }
  .font-weight-bold {
    font-size: 14px;
    font-weight: 600;
  }
  .flex-row {
    display: flex;
    .el-col {
      float: none;
    }
  }

  .measure-content-desc {
    display: inline-flex;
  }
  .measure-content-item {
    display: inline-block;
    margin-right: 10px;
    line-height: 1.4;
  }
  .risk-title {
    line-height: 22px;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
  }
  .mx-5 {
    margin-left: 5px;
    margin-right: 5px;
  }
  .line-height-md {
    line-height: 28px;
  }
  .present-img-viewer {
    text-align: center;
  }
  .present-img {
    width: 50px;
    height: 50px;
    margin: 10px;
    cursor: pointer;
  }
  .measure-title-divider {
    margin: 5px 0;
  }
</style>
