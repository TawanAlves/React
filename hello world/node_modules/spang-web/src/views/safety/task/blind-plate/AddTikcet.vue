<template>
  <a-card :bordered="false" style="margin: 15px;">
    <a-form-model :model="form" ref="ruleForm" :rules="rules" :label-col="{span: 7}" :wrapper-col="{span:10}">
      <a-row class="form-title">
        <h3 >{{ formTitle }}</h3>
      </a-row>
      <a-form-model-item label="作业证编号" v-if="id !== '-1'">
        <a-input
          v-model="form.code"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="申请单位">
        <a-input
          v-model="form.applicantUnitName"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="申请人">
        <a-input
          v-model="form.applicantName"
          disabled/>
      </a-form-model-item>
      <a-form-model-item label="作业单位" prop="workUnitId">
        <department-select v-model="form.workUnitId" @change="workUnitChange" placeholder="请选择作业单位"></department-select>
      </a-form-model-item>
      <a-form-model-item label="盲板作业性质" prop="workCategory">
        <a-radio-group v-model="form.workCategory">
          <a-radio :value="0">
            抽
          </a-radio>
          <a-radio :value="1">
            堵
          </a-radio>
        </a-radio-group>
      </a-form-model-item>
      <a-form-model-item label="盲板编号" prop="field1">
        <a-input
          placeholder="请输入盲板编号"
          v-model="form.field1"
        />
      </a-form-model-item>
      <a-form-model-item label="盲板具体位置" prop="workAddress">
        <a-input
          placeholder="请输入盲板具体位置"
          v-model="form.workAddress"
        />
      </a-form-model-item>
      <a-form-model-item label="管线输送介质" prop="field2">
        <a-input
          placeholder="请输入管线输送介质"
          v-model="form.field2"
        />
      </a-form-model-item>
      <a-form-model-item label="管线输送介质-温度" prop="field3">
        <a-input
          placeholder="请输入管线输送介质-温度"
          v-model="form.field3"
        />
      </a-form-model-item>
      <a-form-model-item label="管线输送介质-压力" prop="field4">
        <a-input
          placeholder="请输入管线输送介质-压力"
          v-model="form.field4"
        />
      </a-form-model-item>
      <a-form-model-item label="盲板规格-直径(mm)" prop="field5">
        <a-input
          placeholder="请输入盲板规格-直径"
          v-model="form.field5"
        />
      </a-form-model-item>
      <a-form-model-item label="盲板规格-材质" prop="field6">
        <a-input
          placeholder="请输入盲板规格-材质"
          v-model="form.field6"
        />
      </a-form-model-item>
      <a-form-model-item label="盲板规格-厚度(mm)" prop="field7">
        <a-input
          placeholder="请输入盲板规格-厚度"
          v-model="form.field7"
        />
      </a-form-model-item>
      <a-form-model-item label="作业内容" prop="workContent">
        <a-input
          placeholder="请输入作业内容"
          v-model="form.workContent"
        />
      </a-form-model-item>
      <a-form-model-item label="作业盲板" help="格式:jpg png 大小:不超过5M">
        <a-upload
          :action="action"
          list-type="picture-card"
          :file-list="form.fileList"
          @preview="handlePreview"
          @change="handleChange"
        >
          <div v-if="form.fileList.length < 8">
            <a-icon type="camera" />
            <div class="ant-upload-text">
              添加图片
            </div>
          </div>
        </a-upload>
        <a-modal
          :visible="previewVisible"
          :footer="null"
          @cancel="previewVisible = false"
          :keyboard="false"
          :maskClosable="false"
        >
          <img alt="example" style="width: 100%" :src="previewImage" />
        </a-modal>

      </a-form-model-item>
      <a-form-model-item label="申请作业起止时间" prop="planStartEndTime">
        <a-range-picker
          @change="onPlanTimeChange"
          v-model="form.planStartEndTime"
          valueFormat="YYYY-MM-DD HH:mm:ss"
          showTime
          style="width: 100%"
          placeholder="请选择作业起止时间"
        />
      </a-form-model-item>
      <a-form-model-item label="现场监护人" prop="localeGuardianId">
        <person-list-select
          v-model="form.localeGuardianId"
          @change="userChanged"
          :deptId="form.workApplyCompanyId"
          placeholder="请选择现场监护人"
        />
      </a-form-model-item>
      <div style="text-align: center; margin-top: 10px;">
        <a-button type="primary" @click="submitForm" style="width: 122px;">提交</a-button>
        <a-button type="second" @click="goBack" style="width: 122px;margin-left: 20px">返回</a-button>
      </div>
    </a-form-model>
  </a-card>
</template>

<script>
import { mapGetters } from 'vuex'
import { saveForm, getDetail } from '@/api/breaking-work'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import PersonListSelect from '../../components/PersonListSelect'
import { fileToBase64 } from '@/utils/util'

export default {
  name: 'AddTikcet',
  components: { DepartmentSelect, PersonListSelect },
  props: {
    id: {
      type: String,
      required: true,
      default: '-1'
    }
  },
  data () {
    return {
      previewVisible: false,
      previewImage: '',
      form: {
        workCategory: 1,
        workUnitName: '',
        localeGuardianName: '',
        field8:'',
        fileList: [],
        planStartTime: null,
        planEndTime: null,
        planStartEndTime: null
      },
      rules: {
        localeGuardianId: [{ required: true, message: '请选择现场监护人', trigger: 'change' }],
        workUnitId: [{ required: true, message: '请选择作业单位', trigger: 'change' }],
        workCategory: [{ required: true, message: '请输入盲板作业性质', trigger: 'blur' }],
        field1: [{ required: true, message: '请输入盲板编号', trigger: 'blur' }],
        workAddress: [{ required: true, message: '请输入盲板具体位置', trigger: 'blur' }],
        field2: [{ required: true, message: '请输入管线输送介质', trigger: 'blur' }],
        field3: [{ required: true, message: '请输入管线输送介质-温度', trigger: 'blur' }],
        field4: [{ required: true, message: '请输入管线输送介质-压力', trigger: 'blur' }],
        field5: [{ required: true, message: '请输入盲板规格-直径', trigger: 'blur' }],
        field6: [{ required: true, message: '请输入盲板规格-材质', trigger: 'blur' }],
        field7: [{ required: true, message: '请输入盲板规格-厚度', trigger: 'blur' }],
        workContent: [{ required: true, message: '请输入作业内容', trigger: 'blur' }],
        planStartEndTime: [
          { required: true, message: '请选择计划起止时间', trigger: 'change' }
        ]
      },
      action: this.BASE_URL + '/spang-safety/fileserver/filesUpload',
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    formTitle () {
      if (this.id === '-1') {
        return '新建盲板抽堵作业票'
      } else {
        return '修改盲板抽堵作业票'
      }
    }
  },
  methods: {
    onPlanTimeChange (date) {
      this.form.planStartTime = date[0]
      this.form.planEndTime = date[1]
      this.form.planStartEndTime = date
    },
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
    goBack () {
      this.$router.push('/safety/task/manage')
    },
    submitForm () {
      this.$refs.ruleForm.validate(valid => {
        if (valid) {
          const params = Object.assign({}, this.form)
          delete params.planStartEndTime
          params.status = 2
          let method = 'post';
          if (this.id !== '-1') {
            method = 'put';
          }
          params.ticketType = '6';
          const url = `/spang-safety/basic-information`;
          this.submitFormApi(method,url, params).then(res=>{
            if(res.code === 200){
              this.$notification['success']({
                message: '提示',
                description: '提交成功',
                duration: 8
              })
              this.$router.push('/safety/task/manage');
            }
          })
        } else {
          console.error('error submit!!')
          return false
        }
      })
    },
    loadFormData () {
      this.getList('/spang-safety/basic-information/' + this.id,{}).then(res => {
        if (res.code === 200) {
          this.form = Object.assign({ planStartEndTime: [res.data.planStartTime, res.data.planEndTime], relatedWorks: [], fileList: [] }, res.data)
          if(this.form.field8 !== ''){
            this.form.field8 = this.form.field8.split(',');
            this.form.field8.forEach((f,i)=>{
              this.form.fileList.push({uid: i + 1,url: this.BASE_URL + f,status:'done'})
            })
            this.form.field8 = this.form.field8.toString();
          }
        }
      })
    },
    workUnitChange ({ id, label }) {
      this.form.workUnitName = label
    },
    userChanged ({ id, person }) {
      this.form.localeGuardianName = person.realName
    },
    async handlePreview (file) {
      if (!file.url && !file.preview) {
        file.preview = await fileToBase64(file.originFileObj)
      }
      this.previewImage = file.url || file.preview
      this.previewVisible = true
    },
    handleChange ({ fileList }) {
      this.form.fileList = fileList;
      this.form.field8 = '';
      fileList.forEach((f,i)=>{
        let n = fileList.length - 1;
        if(n !== i){
          if(!this.form.field8 || this.form.field8 === ''){
            this.form.field8 = f.url.slice(4);
          }else{
            this.form.field8 += ',' + f.url.slice(4);
          }
        }else{
          if(!this.form.field8 || this.form.field8 === ''){
            if(f.response){
              this.form.field8 = '/spang-safety/file' + f.response.data[0].urlPath;
            }else{
              this.form.field8 = '/spang-safety/file' + f.url;
            }
          }else{
            if(f.response){
              this.form.field8 += ',' + '/spang-safety/file' + f.response.data[0].urlPath;
            }else{
              this.form.field8 += ',' + '/spang-safety/file' + f.url;
            }
          }
        }
        this.form.fileList = [...fileList]
      })
    }

  },
  created () {
    if (this.id !== '-1') {
      this.loadFormData()
    } else {
      this.form.applicantUnitName = this.userInfo.deptName
      this.form.applicantUnitId = this.userInfo.deptId
      this.form.applicantName = this.userInfo.realName
      this.form.applicantId = this.userInfo.id
    }
  }
}
</script>

<style scoped lang="less">
  .flex-input-button {
    display: flex;
    justify-content: space-between;
  }
  .helper-text {
    color: rgba(0, 0, 0, 0.25);
  }
</style>
