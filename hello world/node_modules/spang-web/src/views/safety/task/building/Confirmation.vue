<template>
  <a-card style="margin: 15px;">
    <a-tabs
      default-active-key="1"
      tab-position="left"
      @change="handleTabChange"
    >
      <a-tab-pane key="1" tab="风险辨识">
        <a-list
        >
          <a-list-item :key="index" v-for="(item, index) in contentData">
            <a-list-item-meta>
              <div slot="description">
                <span
                  v-if="item.value === 0"
                  style="margin-right: 5px;"
                  class="color-green">
                  不涉及
                </span>
                <span
                  v-else-if="item.value === 1"
                  style="margin-right: 5px;"
                  class="color-blue">
                  满足
                </span>
                <span
                  v-if="item.value === 0"
                  style="margin-right: 5px;"
                  class="color-orange">
                  不满足
                </span>
                <template v-if="item.type">
                  <span>安全措施:</span>
                  <span>{{ item.type }}</span>
                </template>
                <template v-else>
                  <span>{{ item.content }}</span>
                </template>
              </div>
              <div slot="title" class="font-weight-bold">
                <template v-if="item.type">
                  {{ parseInt(index) + 1 }}. {{ item.type }}
                </template>
                <template v-else>
                  {{ item.title }}
                </template>
              </div>
            </a-list-item-meta>
          </a-list-item>
        </a-list>
        <a-divider />
        <horizontal-list :list-data="signData"></horizontal-list>
      </a-tab-pane>
      <a-tab-pane key="2" tab="安全签字">
        <signature-list :list-data="signatureList"></signature-list>
        <template v-if="presentImages.length > 0">
          <a-divider/>
          <div class="measure-title">
            现场图片
            <viewer :images="presentImages" class="present-img-viewer">
              <img v-for="src in presentImages" :key="src" :src="src" class="present-img">
            </viewer>
          </div>
        </template>
      </a-tab-pane>
      <a-tab-pane key="3" tab="安全交底">
        <safety-disclosure :content-data="riskFormData"></safety-disclosure>
        <a-divider />
        <horizontal-list :list-data="signData"></horizontal-list>
      </a-tab-pane>
    </a-tabs>
  </a-card>
</template>

<script>
import { hotWorkRiskFillinList } from './risks'
import { getConfirmation, getDetail } from '@/api/building-work'
import { mapGetters } from 'vuex'
import HorizontalList from '../component/HorizontalList'
import SafetyDisclosure from '../component/SafetyDisclosure'
import cloneDeep from 'lodash.clonedeep'
import SignatureList from '@/views/safety/task/component/SignatureList'
export default {
  name: 'Confirmation',
  components: { SignatureList, HorizontalList, SafetyDisclosure },
  props: {
    ticketId: {
      type: String,
      default: '',
      required: true
    }
  },
  data () {
    return {
      contentData: Object.assign({}, hotWorkRiskFillinList),
      riskFormData: { riskType: [], measures: [] },
      ticketInfo: {},
      signData: {
        title1: '申请单位',
        title2: '作业单位'
      },
      signatureList: [
        { title: '作业单位安全教育人' },
        { title: '所在单位安全教育人' },
        { title: '作业单位安全措施落实' },
        { title: '所在单位安全措施落实' },
        { title: '监护人' },
        { title: '项目负责人' },
        { title: '技术部电气专业' },
        { title: '工艺专业' },
        { title: '仪表专业' },
        { title: '消防保卫部消防专业' },
        { title: '人资企管部计算机组' },
        { title: '给排水专业' },
      ],
      presentImages: [],
    }
  },
  computed: {
     ...mapGetters(['userInfo'])
  },
  methods: {
    handleTabChange (tabIndex) {
      if (tabIndex === '1') {
        this.contentData = Object.assign({}, hotWorkRiskFillinList)
        this.signData = {
          title1: '申请单位',
          title2: '作业单位'
        }
        this.loadRiskDatas()
      } else if (tabIndex === '2') {
        this.signData = {
          title1: '作业单位安全教育人',
          title2: '所在单位安全教育人'
        }
        this.loadTicketDetail()
      } else if (tabIndex === '3') {
        this.contentData = { riskType: [], measures: [] }
        this.signData = {
          title1: '作业单位安全教育人',
          title2: '所在单位安全教育人'
        }
        this.loadSafefillin()
      }
    },
    loadRiskDatas () {
      const params = {
        id: this.ticketId,
        type: 0
      }
      this.getConfirmation(params)
    },
    getConfirmation (params) {
      this.getList('/spang-safety/locale-confirm', params).then(({ data, code }) => {
        if (code === 200) {
          const content = data.content ? JSON.parse(data.content) : {}
          for (const key in this.contentData) {
            Object.assign(this.contentData[key], content[key])
          }
          this.signUsers = data.signUsers;
          data.signUsers.map(item => {
            if (item.userType === 0) {
              this.$set(this.signData, 'time1', item.signDate)
              this.$set(this.signData, 'person1', item.userName)
              this.$set(this.signData, 'sign1', item.signatureURL ? item.signatureURL : '')
            }
            if (item.userType === 1) {
              this.$set(this.signData, 'time2', item.signDate)
              this.$set(this.signData, 'person2', item.userName)
              this.$set(this.signData, 'sign2', item.signatureURL ? item.signatureURL : '')
            }
          })
        }
      })
    },
    loadTicketDetail () {
      const params = {
        id: this.ticketId,
        type: 2
      }
      this.getList('/spang-safety/locale-confirm', params).then(({ data, code }) => {
        data.signUsers.forEach(item => {
          if (item.userType === 0) {
            this.$set(this.signatureList[0], 'time', item.signDate)
            this.$set(this.signatureList[0], 'person', item.userName)
            this.$set(this.signatureList[0], 'sign', item.signatureURL ? item.signatureURL : '')
          }
          if (item.userType === 1) {
            this.$set(this.signatureList[1], 'time', item.signDate)
            this.$set(this.signatureList[1], 'person', item.userName)
            this.$set(this.signatureList[1], 'sign', item.signatureURL ? item.signatureURL : '')
          }
        })
        this.presentImages = data.files.map(item => (this.BASE_URL + '/spang-safety/file' + item.filePath))
      })
      this.getById('/spang-safety/locale-confirm/sign', this.ticketId).then(({ data, code }) => {
        if (code === 200) {
          const signData5 = data['5'] && data['5'].length > 0 ? data['5'][0] : {}
          this.$set(this.signatureList[2], 'time', signData5.signTime)
          this.$set(this.signatureList[2], 'person', signData5.userName)
          this.$set(this.signatureList[2], 'sign', signData5.signatureUrl ? signData5.signatureUrl : '')
          const signData6 = data['6'] && data['6'].length > 0 ? data['6'][0] : {}
          this.$set(this.signatureList[3], 'time', signData6.signTime)
          this.$set(this.signatureList[3], 'person', signData6.userName)
          this.$set(this.signatureList[3], 'sign', signData6.signatureUrl ?  signData6.signatureUrl : '')
          const signData2 = data['2'] && data['2'].length > 0 ? data['2'][0] : {}
          this.$set(this.signatureList[4], 'time', signData2.signTime)
          this.$set(this.signatureList[4], 'person', signData2.userName)
          this.$set(this.signatureList[4], 'sign', signData2.signatureUrl ? signData2.signatureUrl : '')
          const signData1 = data['1'] && data['1'].length > 0 ? data['1'][0] : {}
          this.$set(this.signatureList[5], 'time', signData1.signTime)
          this.$set(this.signatureList[5], 'person', signData1.userName)
          this.$set(this.signatureList[5], 'sign', signData1.signatureUrl ? signData1.signatureUrl : '')
          const signData7 = data['7'] && data['7'].length > 0 ? data['7'][0] : {}
          this.$set(this.signatureList[6], 'time', signData7.signTime)
          this.$set(this.signatureList[6], 'person', signData7.userName)
          this.$set(this.signatureList[6], 'sign', signData7.signatureUrl ? signData7.signatureUrl : '')
          const signData8 = data['8'] && data['8'].length > 0 ? data['8'][0] : {}
          this.$set(this.signatureList[7], 'time', signData8.signTime)
          this.$set(this.signatureList[7], 'person', signData8.userName)
          this.$set(this.signatureList[7], 'sign', signData8.signatureUrl ? signData8.signatureUrl : '')
          const signData9 = data['9'] && data['9'].length > 0 ? data['9'][0] : {}
          this.$set(this.signatureList[8], 'time', signData9.signTime)
          this.$set(this.signatureList[8], 'person', signData9.userName)
          this.$set(this.signatureList[8], 'sign', signData9.signatureUrl ? signData9.signatureUrl : '')
          const signData10 = data['10'] && data['10'].length > 0 ? data['10'][0] : {}
          this.$set(this.signatureList[9], 'time', signData10.signTime)
          this.$set(this.signatureList[9], 'person', signData10.userName)
          this.$set(this.signatureList[9], 'sign', signData10.signatureUrl ? signData10.signatureUrl : '')
          const signData11 = data['11'] && data['11'].length > 0 ? data['11'][0] : {}
          this.$set(this.signatureList[10], 'time', signData11.signTime)
          this.$set(this.signatureList[10], 'person', signData11.userName)
          this.$set(this.signatureList[10], 'sign', signData11.signatureUrl ? signData11.signatureUrl : '')
          const signData12 = data['12'] && data['12'].length > 0 ? data['12'][0] : {}
          this.$set(this.signatureList[11], 'time', signData12.signTime)
          this.$set(this.signatureList[11], 'person', signData12.userName)
          this.$set(this.signatureList[11], 'sign', signData12.signatureUrl ? signData12.signatureUrl : '')
        }
      })
    },
    loadSafefillin () {
      const params = {
        id: this.ticketId,
        type: 4
      }
      this.getList('/spang-safety/locale-confirm', params).then(({ data, code }) => {
        this.contentData.riskType.forEach(item => {
          Object.assign(item, { fillIn: item.factor })
        })

        this.contentData.measures.forEach(item => {
          Object.assign(item, { fillIn: item.content, content: item.type })
        })
        this.riskFormData = cloneDeep(this.contentData)
        data.signUsers.forEach(item => {
          if (item.userType === 0) {
            this.$set(this.signData, 'time1', item.signDate)
            this.$set(this.signData, 'person1', item.userName)
            this.$set(this.signData, 'sign1', item.signatureURL ? item.signatureURL : '')
          }
          if (item.userType === 1) {
            this.$set(this.signData, 'time2', item.signDate)
            this.$set(this.signData, 'person2', item.userName)
            this.$set(this.signData, 'sign2', item.signatureURL ? item.signatureURL : '')
          }
        })
      })
    }
  },
  created () {
    this.loadRiskDatas()
  }
}
</script>

<style scoped lang="less">
  .color-orange {
    color: #F27F06;
  }

  .color-green {
    color: #10B24C;
  }
  .line-height-md {
    line-height: 28px;
  }
  .color-blue {
    color: #1F9AFC;
  }
  .risk-title {
    line-height: 22px;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 5px;
  }
  .mx-5 {
    margin-left: 5px;
    margin-right: 5px;
  }
  .font-weight-bold {
    font-size: 14px;
    font-weight: 600;
  }
  .flex-row {
    display: flex;
    .el-col {
      float: none;
    }
  }

  .measure-content-desc {
    display: inline-flex;
  }
  .measure-content-item {
    display: inline-block;
    margin-right: 10px;
    line-height: 1.4;
  }

</style>
