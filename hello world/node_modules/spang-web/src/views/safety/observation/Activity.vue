<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col  :md="6" :sm="12" :xs="24">
              <a-form-item label="活动名称">
                <a-input v-model="queryParam.activityName" placeholder="活动名称"/>
              </a-form-item>
            </a-col>
            <a-col  :md="6" :sm="12" :xs="24">
              <a-form-item label="活动类型">
                <a-select
                  show-search
                  v-model="queryParam.activityTypeId"
                  placeholder="活动类型"
                  style="width: 100%"
                >
                  <a-select-option v-for="d in activityTypeOptions" :key="d.id">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col  :md="6" :sm="12" :xs="24">
              <a-form-item label="组织单位">
                <department-select v-model="queryParam.deptId" placeholder="组织单位"></department-select>
              </a-form-item>
            </a-col>
            <a-col  :md="6" :sm="12" :xs="24">
              <a-form-item label="状态">
                <a-select
                  show-search
                  v-model="queryParam.status"
                  placeholder="状态"
                  style="width: 100%"
                >
                  <a-select-option v-for="d in statusOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
             <a-col  :md="24" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-space :size="8">
            <a-button type="primary" icon="plus" @click="addRecord" v-if="permission.activity_add">
              新建
            </a-button>
            <a-button @click="approveRecord">
              审批
            </a-button>
          </a-space>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :rowSelection="rowSelection"
        :scroll="{y: `calc(100vh - 500px)`, x: 1360}"
        :showIndexColumn="true"
      >

        <span slot="status" slot-scope="text, record">
          <a-tag v-if="record.status === 0" color="orange">未提交</a-tag>
          <a-tag v-else-if="record.status === 1" color="green">待审批</a-tag>
          <a-tag v-else-if="record.status === 2">审批同意</a-tag>
          <a-tag v-else-if="record.status === 3" color="red">审批拒绝</a-tag>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="checkRecord(record)">查看</a>
            <a-divider type="vertical" v-if="record.status === 0 && userInfo.id === record.gmtCreateId"/>
            <a @click="editRecord(record)" v-if="record.status === 0 && userInfo.id === record.gmtCreateId">编辑</a>
            <a-divider type="vertical" v-if="record.status === 0 && userInfo.id === record.gmtCreateId"/>
            <a @click="publishRecord(record, 1)" v-if="record.status === 0 && userInfo.id === record.gmtCreateId">提交</a>
            <a-divider type="vertical" v-if="record.status === 0 && userInfo.id === record.gmtCreateId"/>
            <a @click="removeRecord(record)" v-if="record.status === 0 && userInfo.id === record.gmtCreateId">删除</a>
          </template>
        </span>
      </s-table>
      <common-form-modal
        ref="modal"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        width="700px"
        @ok="modalOk"
        :customFooter="selectedRows.length > 0"
      >
        <template slot="footer">
          <a-textarea placeholder="审批意见" :rows="4" v-model="commonData.approveRemark"/>
          <a-space style="margin-top: 5px;">
            <a-button type="primary" @click="approve(2)">审批通过</a-button>
            <a-button @click="approve(3)">审批拒绝</a-button>
          </a-space>

        </template>
      </common-form-modal>
    </a-card>
  </page-container>
</template>
<script>
  import { STable } from '@/components'
  import { activityColumns } from '@/views/safety/table'
  import ApiURLs from '@/api/urls'
  import { mapGetters } from 'vuex'
  import { getStore } from '@/utils/store'
  import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
  import DepartmentSelect from '../components/DepartmentSelect'
  import moment from 'moment'
  const statusOption = [
    {
      dictKey: 0,
      dictValue: '未提交'
    },
    {
      dictKey: 1,
      dictValue: '待审批'
    },
    {
      dictKey: 2,
      dictValue: '审批同意'
    },
    {
      dictKey: 3,
      dictValue: '审批拒绝'
    }
  ]
  export default {
    name: 'Activity',
    components: {
      DepartmentSelect,
      STable,
      CommonFormModal
    },
    data () {
      return {
        status: 0,
        statusOptions: Object.freeze(statusOption),
        activityTypeOptions: [],
        confirmLoading: false,
        commonTitle: '',
        commonVisible: false,
        commonData: {},
        commonDisabled: false,
        queryParam: {
          activityName: '',
          deptId: undefined,
          activityTypeId: undefined,
          status: undefined
        },
        selectedRowKeys: [],
        selectedRows: [],
        loadData: parameter => {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          Object.assign(requestParameters, this.queryParam)
          return this.getList(ApiURLs.activityList, requestParameters).then(res => {
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          })
        },
        userInfo: getStore({ name: 'info' }),
        rules: [
          {
            type: 'input',
            title: '活动名称',
            field: 'activityName',
            props: {
              type: 'text',
              placeholder: '请输入活动名称',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入活动名称',
              trigger: 'blur'
            }]
          },
          {
            type: 'select',
            field: 'activityTypeId',
            title: '活动类型',
            options: [],
            validate: [{
              required: true,
              message: '请选择活动类型',
              trigger: 'blur'
            }],
            props: {
              placeholder: '请选择活动类型'
            },
            on: {
              change: (id) => {
                const options = this.$refs.modal.fApi.getRule('activityTypeId').options
                this.$set(this.commonData, 'activityTypeName', options.find(item => item.value === id).label)
              }
            }
          },
          {
            type: 'PersonListSelect',
            title: '负责人',
            field: 'managerId',
            props: {
              placeholder: '请选择负责人'
            },
            on: {
              change: ({ person }) => {
                this.commonData.managerName = person.realName
              }
            },
            validate: [{
              required: true,
              message: '请选择负责人',
              trigger: 'blur'
            }]
          },
          {
            type: 'DepartmentSelect',
            title: '组织单位',
            field: 'deptId',
            props: {
              placeholder: '请选择组织单位'
            },
            on: {
              change: ({ label }) => {
                this.commonData.deptName = label
              }
            },
            validate: [{
              required: true,
              message: '请选择组织单位',
              trigger: 'blur'
            }]
          },
          {
            type: 'RangePicker',
            title: '计划时间',
            field: 'activityTime',
            props: {
              showTime: true,
              format: 'YYYY-MM-DD HH:mm:ss',
              placeholder: '开始日期~结束日期'
            },
            style: {
              width: '100%'
            },
            validate: [{
              required: true,
              message: '请选择计划时间',
              trigger: 'blur'
            }, {
              validator: (rule, value, callback) => {
                if (new Date(value[0]).getTime() < new Date().getTime()) {
                  callback(new Error('开始时间不能早于当前时间'))
                } else {
                  callback()
                }
              },
              trigger: 'changed'
            }],
            on: {
              change: (dates, dateStrings) => {
                this.commonData.planBgTime = dateStrings[0]
                this.commonData.planEndTime = dateStrings[1]
              }
            }
          },
          {
            type: 'input',
            title: '活动内容',
            field: 'activityDetails',
            props: {
              type: 'textarea',
              autoSize: { minRows: 3, maxRows: 5 },
              placeholder: '请输入活动内容',
              maxLength: 256
            },
            validate: [{
              required: true,
              message: '请输入活动内容',
              trigger: 'blur'
            }]
          },
          {
            type: 'UploadFile',
            field: 'files',
            title: '附件',
            props: {
              fileList: []
            }
          },
          {
            type: 'PersonListSelect',
            title: '审批人',
            field: 'approveId',
            props: {
              placeholder: '请选择审批人'
            },
            on: {
              change: ({ person }) => {
                this.commonData.approveName = person.realName
              }
            },
            validate: [{
              validator: (rule, value, callback) => {
                if (this.status === 1 && !value) {
                  callback(new Error('请选择审批人'))
                } else {
                  callback()
                }
              },
              trigger: 'changed'
            }]
          },
          {
            type: 'input',
            title: '审批意见',
            field: 'approveRemark',
            display: 'false',
            props: {
              type: 'textarea',
              autoSize: { minRows: 3, maxRows: 5 },
              placeholder: '请输入审批意见',
              maxLength: 256
            }
          }
        ]
      }
    },
    computed: {
      ...mapGetters(['permission']),
      columns: () => activityColumns,
      hasSelected () {
        return this.selectedRowKeys.length > 0
      },
      rowSelection () {
        return {
          type: 'radio',
          selectedRowKeys: this.selectedRowKeys,
          onChange: this.onSelectChange
        }
      }
    },
    methods: {
      initFormData () {
        this.commonData = {
          activityDetails: null,
          activityName: null,
          activityTypeId: undefined,
          activityTypeName: null,
          approveId: undefined,
          approveName: null,
          deptId: undefined,
          deptName: null,
          managerId: undefined,
          managerName: null,
          files: [],
          planBgTime: moment(new Date()).format('YYYY-MM-DD HH:mm:ss'),
          planEndTime: moment(new Date()).format('YYYY-MM-DD HH:mm:ss'),
          status: 0
        }
        this.updateRule([], [this.commonData.planBgTime, this.commonData.planEndTime])
      },
      updateRule (fileList, dates) {
        if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
          this.$refs.modal.fApi.getRule('files').props.fileList = fileList
          this.$refs.modal.fApi.setValue('activityTime', dates)
          if (this.commonData.status && this.commonData.status > 1) {
            this.$refs.modal.fApi.display(true, 'approveRemark')
          } else {
            this.$refs.modal.fApi.display(false, 'approveRemark')
          }
        } else {
          this.rules[6].props.fileList = fileList
          this.rules[4].value = dates
          this.rules[8].display = this.commonData.status > 1
        }
      },
      commonInit () {
        this.commonVisible = false
        this.commonDisabled = false
        this.commonTitle = ''
        this.confirmLoading = false
        this.initFormData()
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      searchReset () {
        this.queryParam = {
          activityTypeId: '',
          activityName: '',
          deptId: '',
          status: ''
        }
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      addRecord () {
        this.commonTitle = '新增数据'
        this.initFormData()
        this.commonVisible = true
        this.commonDisabled = false
        this.$refs.table.clearSelected()
      },
      removeRecords () {
        const ids = this.selectedRows.map(item => (item.id))
        this.showDeleteConfirm(ids)
      },
      checkRecord (record) {
        this.getById(ApiURLs.activity, record.id).then(({ data, success }) => {
          if (success) {
            this.getRecord(record.id, () => {
              this.$refs.table.clearSelected()
              this.commonTitle = '查看数据'
              this.commonVisible = true
              this.commonDisabled = true
            })
          }
        })
      },
      getRecord (id, callback) {
          this.getById(ApiURLs.activity, id).then(({ data, success }) => {
          if (success) {
            if (data.approveId === -1) {
              data.approveId = undefined
            }
            this.commonData = data
            const files = data.files.map(item => ({
              uid: item.id,
              name: item.fileName,
              status: 'done',
              id: item.id,
              filePath: item.fileUrlPath
            }))
            this.updateRule(files, [data.planBgTime, data.planEndTime])
            callback()
          }
        })
      },
      editRecord (record, status) {
        this.$refs.table.clearSelected()
        this.commonTitle = '编辑数据'
        if (status) {
          this.status = status
        } else {
          this.status = record.status
        }
        this.getRecord(record.id, () => {
          this.commonVisible = true
          this.commonDisabled = false
        })
      },
      removeRecord (record) {
        this.showDeleteConfirm([record.id])
      },
      modalOk ({ formData }) {
        let method = ''
        if (this.isNotNullOrUndefined(this.commonData.id)) {
          method = 'put'
          formData.id = this.commonData.id
          formData.status = this.status
        } else {
          method = 'post'
          formData.status = 0
        }
        const params = {
          ...formData,
          activityTypeName: this.commonData.activityTypeName,
          managerName: this.commonData.managerName,
          approveName: this.commonData.approveName,
          deptName: this.commonData.deptName,
          planBgTime: this.commonData.planBgTime,
          planEndTime: this.commonData.planEndTime,
          files: this.$refs.modal.fApi.getRule('files').props.fileList.map(item => ({
            id: item.id,
            fileUrlPath: item.filePath,
            originalFileName: item.name
          }))
        }
        this.submitForm(ApiURLs.activity, params, method, {
          // headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
          this.commonInit()
        })
      },
      publishRecord (record, status) {
        if (status === 1 && (!record.approveId || record.approveId == -1)) {
          this.$message.error(`请先选择审批人后在进行提交`)
          return
        }
        const url = `${ApiURLs.activityStatusUpdate}`
        this.submitForm(url, { id: record.id, status }, 'put').then(res => {
          this.$message.success(`操作成功`)
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
        })
      },
      showDeleteConfirm (params) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            _this.deleteByIds(ApiURLs.activity, params).then(res => {
              if (res.code === 200) {
                _this.$message.success('删除成功')
                _this.selectedRows = []
                _this.selectedRowKeys = []
                _this.$refs.table.refresh()
              } else {
                _this.$message.error('删除失败')
              }
            })
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      },
      onTimeChange (value, dateString) {
        this.queryParam.startTime = dateString[0]
        this.queryParam.endTime = dateString[1]
      },
      approveRecord () {
        if (this.selectedRows.length === 0) {
          this.$message.error('请先选择一条数据再进行审批')
          return
        }
        if (this.selectedRows[0].status !== 1) {
          this.$message.error('请选择待审批的数据进行审批')
          return
        }
        if (this.selectedRows[0].approveId !== this.userInfo.id) {
          this.$message.error('你没有权限审批当前数据')
          return
        }
        this.getRecord(this.selectedRows[0].id, () => {
          this.commonTitle = '审批数据'
          this.commonVisible = true
          this.commonDisabled = true
        })
      },
      approve (status) {
        const params = {
          ...this.commonData,
          files: this.commonData.files.map(item => ({
            id: item.id,
            fileUrlPath: item.filePath,
            originalFileName: item.fileName
          })),
          status: status
        }
        this.submitForm(ApiURLs.activity, params, 'put').then(res => {
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
          this.commonVisible = false
        })
      }
    },
    created () {
      this.getDict('ACTIVITY_TYPE').then(({ data, success }) => {
        if (success) {
          this.activityTypeOptions = data
          this.rules[1].options = this.activityTypeOptions.map(item => ({
            label: item.dictValue,
            value: item.id
          }))
        }
      })
    }
  }
</script>
<style lang="less" scoped>
  /deep/ .ant-table {
    height: auto;
    .ant-tag {
      margin-right: 0px;
    }
  }

  /deep/ .table-card .ant-card-body {
    padding-top: 0;
    padding-bottom: 15px;
  }

  .card-title {
    display: flex;
    justify-content: space-between;
  }
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 77px;
}
</style>
