<template>
  <a-modal
    :title="modalTitle"
    :visible="visible"
    :confirmLoading="loading"
    @ok="() => { $emit('ok') }"
    @cancel="() => { $emit('cancel') }"
    ok-text="确定"
    cancel-text="取消"
    width="50%"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form :form="form">
        <a-row :gutter="24">
          <a-col :md="24">
            <a-form-item label="变更名称">
              <a-input v-decorator="['name',{ rules:[{ required: true, message: '请输入事故名称' }]}]" :disabled="disabled"/>
            </a-form-item>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <a-col :md="12">
            <department-select decorator-name="changeUnitId" labelName="变更单位" :disabled="disabled"/>
          </a-col>
          <a-col :md="12">
            <area-select decorator-name="areaId" labelName="变更区域" :disabled="disabled"/>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <a-col :md="12">
            <a-form-item label="变更类型">
              <a-select v-decorator="['type',{ rules:[{ required: true, message: '请选择变更类别' }]}]" :disabled="disabled">
                <a-select-option v-for="d in typeOptions" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :md="12">
            <a-form-item label="变更级别">
              <a-select v-decorator="['level',{ rules:[{ required: true, message: '请选择变更级别' }]}]" :disabled="disabled">
                <a-select-option v-for="d in levelOptions" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <a-col :md="12">
            <a-form-item label="变更内容">
              <a-textarea placeholder="" :rows="4" v-decorator="['content',{ rules:[{ required: true, message: '请输入变更内容' }]}]" :disabled="disabled"/>
            </a-form-item>
          </a-col>
          <a-col :md="12">
            <a-form-item label="变更原因和目的">
              <a-textarea placeholder="" :rows="4" v-decorator="['reason',{ rules:[{ required: true, message: '请输入变更原因和目的' }]}]" :disabled="disabled"/>
            </a-form-item>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <a-col :md="12">
            <a-form-item label="起始时间">
              <a-date-picker show-time v-decorator="['startTime',{ rules:[{ required: true, message: '请输入起始时间' }]}]" :disabled="disabled" valueFormat="YYYY-MM-DD HH:mm:ss"/>
            </a-form-item>
          </a-col>
          <a-col :md="12">
            <a-form-item label="截止时间">
              <a-date-picker show-time v-decorator="['endTime',{ rules:[{ required: true, message: '请输入截止时间' }]}]" :disabled="disabled" valueFormat="YYYY-MM-DD HH:mm:ss"/>
            </a-form-item>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <a-col :md="12">
            <department-select decorator-name="checkUnitId" labelName="验收主管单位" :disabled="disabled"/>
          </a-col>
          <a-col :md="12">
            <person-select decorator-name="checkChargerId" labelName="验收责任人" :disabled="disabled"/>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <a-col :md="12">
            <file-upload
              docName="fileName"
              docUrl="docUrl"
              labelName="附件"
              :form="form"
              required
              :disabled="disabled"
              :visible="visible"/>
          </a-col>
        </a-row>
      </a-form>
    </a-spin>
  </a-modal>
</template>

<script>
import pick from 'lodash.pick'
import { alterationColumns } from '@/views/safety/table'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import AreaSelect from '@/views/safety/components/AreaSelect'
import PersonSelect from '@/views/safety/components/PersonSelect'
import FileUpload from '@/views/safety/components/FileUpload'

const fields = alterationColumns.map(res => {
  return res.dataIndex
})
fields.push('type', 'level', 'changeUnitId', 'areaId', 'docUrl')

const areaOptions = [
  {
    text: '聚丙烯装置区',
    value: 0
  },
  {
    text: '生产装置区域',
    value: 1
  },
  {
    text: '气化装置区',
    value: 2
  }
]
export default {
  name: 'AlterationModal',
  components: {
    DepartmentSelect,
    AreaSelect,
    PersonSelect,
    FileUpload
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    model: {
      type: Object,
      default: () => null
    },
    typeOptions: {
      type: Object,
      default: () => null
    },
    levelOptions: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
        headers: {
          authorization: 'authorization-text'
      },
      form: this.$form.createForm(this),
      searchResult: []
    }
  },
  created () {
    // 防止表单未注册
    fields.forEach(v => this.form.getFieldDecorator(v))
    // 当 model 发生改变时，为表单设置值
    this.$watch('model', () => {
      if (this.model && (typeof this.model.type) !== 'string') {
          this.model.type = String(this.model.type)
          this.model.level = String(this.model.level)
          this.model.changeUnitId = String(this.model.changeUnitId)
          this.model.areaId = String(this.model.areaId)
      }
      this.previewImage = this.model.logo
      this.model && this.form.setFieldsValue(pick(this.model, fields))
    })
  },
  computed: {
    areaOptions: () => areaOptions
  },
  methods: {
    previewFile (file) {
      console.log('Your upload file:', file)
      // Your process logic. Here we just mock to the same file
      return fetch('https://next.json-generator.com/api/json/get/4ytyBoLK8', {
        method: 'POST',
        body: file
      })
        .then(res => res.json())
        .then(({ thumbnail }) => thumbnail)
    },
      handleChange (info) {
      if (info.file.status !== 'uploading') {
        console.log(info.file, info.fileList)
      }
      if (info.file.status === 'done') {
        this.$message.success(`${info.file.name} file uploaded successfully`)
      } else if (info.file.status === 'error') {
        this.$message.error(`${info.file.name} file upload failed.`)
      }
    }
  }
}
</script>
