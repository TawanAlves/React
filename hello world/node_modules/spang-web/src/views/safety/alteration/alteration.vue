<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col  :lg="8" :md="8" :sm="12" :xs="24">
              <a-form-item label="变更名称">
                <a-input v-model="queryParam.name" placeholder="变更名称" />
              </a-form-item>
            </a-col>
            <a-col :lg="8" :md="8" :sm="12" :xs="24">
              <a-form-item label="类型">
                <a-select
                  show-search
                  v-model="queryParam.type"
                  style="width: 100%"
                  :filter-option="filterOption"
                  option-filter-prop="children"
                  placeholder="类型"
                >
                  <a-select-option v-for="d in alterationTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="8" :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #extra>
        <a-button type="primary" icon="plus" @click="addRecord" v-if="permission.alteration_add">
          新建
        </a-button>
      </template>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 432px)`, x: 1060}"
        showPagination="true"
      >
        <span slot="number" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <template slot="action" slot-scope="text, record">
          <template v-if="record.status === 0 && record.gmtCreateId === userInfo.id">
            <a @click="editRecord(record)">编辑</a>
            <a-divider type="vertical"/>
            <a @click="publishRecord(record)">发布</a>
            <a-divider type="vertical"/>
            <a @click="removeRecord(record)">删除</a>
          </template>
          <template v-if="record.status === 1">
            <a @click="viewRecord(record)">查看</a>
          </template>
        </template>
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0!important;">{{record.status | textFilter}}</a-tag>
        </template>
      </s-table>
    </a-card>
    <common-form-modal
      ref="modal"
      :visible.sync="commonVisible"
      :loading="confirmLoading"
      :model="commonData"
      :modal-title="commonTitle"
      :disabled="commonDisabled"
      :rule="rules"
      width="700px"
      @ok="modalOk"
    />
  </page-container>
</template>

<script>
import { STable } from '@/components'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import { getStore } from '@/utils/store'
import { getDict } from '@/api/system'
import AlterationApi from '@/api/alteration'
import { mapGetters } from 'vuex'

export default {
  name: 'alteration',
  components: {
    STable,
    CommonFormModal
  },
  data () {
    return {
      queryParam: {},
      userInfo: getStore({ name: 'info'}),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true,
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(AlterationApi.alterationList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true,
          }
          return data
        })
      },
      columns: [
        {
          title: '序号',
          dataIndex: 'number',
          width: '60px',
          align: 'center',
          scopedSlots: { customRender: 'number' }
        },
        {
          title: '变更名称',
          dataIndex: 'name',
          width: '200px',
          align: 'center'
        },
        {
          title: '变更类型',
          dataIndex: 'typeName',
          width: '150px',
          align: 'center'
        },
        {
          title: '变更级别',
          dataIndex: 'levelName',
          width: '150px',
          align: 'center'
        },
        {
          title: '变更单位',
          dataIndex: 'changeUnitName',
          width: '180px',
          align: 'center',
          ellipsis: true
        },
        {
          title: '状态',
          dataIndex: 'status',
          width: '120px',
          align: 'center',
          scopedSlots: { customRender: 'status' }
        },
        {
          title: '操作',
          dataIndex: 'action',
          width: '200px',
          align: 'center',
          // fixed: 'right',
          scopedSlots: { customRender: 'action' }
        }
      ],
      alterationTypeOptions: [],
      alterationLevelOptions: [],
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      rules: [
        {
          type: 'input',
          field: 'name',
          title: '变更名称',
          props: {
            placeholder: '请输入变更名称'
          },
          validate: {
            required: true,
            message: '请输入变更名称'
          }
        },
        {
          type: 'DepartmentSelect',
          field: 'changeUnitId',
          title: '变更单位',
          props: {
            placeholder: '请选择变更单位'
          },
          on: {
            change: ({ label }) => {
              this.commonData.changeUnitName	 = label
            }
          },
          validate: {
            required: true,
            message: '请选择变更单位'
          }
        },
        {
          type: 'PersonListSelect',
          field: 'changePrincipalId',
          title: '变更负责人',
          props: {
            placeholder: '请选择变更负责人'
          },
          on: {
            change: ({ id, person }) => {
              this.commonData.changePrincipalName = person.realName
            }
          },
          validate: {
            required: true,
            message: '请选择变更负责人'
          }
        },
        {
          type: 'select',
          field: 'type',
          title: '变更类型',
          props: {
            placeholder: '请输入变更类型'
          },
          validate: {
            required: true,
            message: '请输入变更类型'
          }
        },
        {
          type: 'select',
          field: 'level',
          title: '变更级别',
          props: {
            placeholder: '请输入变更级别'
          },
          options: [],
          validate: {
            required: true,
            message: '请输入变更级别'
          }
        },
        {
          type: 'input',
          field: 'reason',
          title: '变更原因和目的',
          props: {
            type: 'textarea',
            autoSize: {
              minRows: 4,
              maxRows: 6
            },
            maxLength: 128,
            placeholder: '请输入变更原因和目的'
          },
          validate: {
            required: true,
            message: '请输入变更原因和目的'
          }
        },
        {
          type: 'input',
          field: 'content',
          title: '变更内容',
          props: {
            type: 'textarea',
            autoSize: {
              minRows: 4,
              maxRows: 6
            },
            maxLength: 128,
            placeholder: '请输入变更内容'
          },
          validate: {
            required: true,
            message: '请输入变更内容'
          }
        },
        {
          type: 'RangePicker',
          title: '起始截止日期',
          field: 'alterationDate',
          props: {
            showTime: true,
            valueFormat: 'YYYY-MM-DD HH:mm:ss',
            placeholder: '起始截止日期'
          },
          on: {
            change: (e) => {
              this.commonData.startTime = e[0]
              this.commonData.endTime = e[1]
            }
          },
          validate: [{
            required: true,
            message: '请选择起始截止日期'
          }]
        },
        {
          type: 'DepartmentSelect',
          field: 'acceptUnitId',
          title: '验收单位',
          props: {
            placeholder: '请选择验收单位'
          },
          on: {
            change: ({ label }) => {
              this.commonData.acceptUnitName = label
            }
          },
          validate: {
            required: true,
            message: '请选择验验收单位'
          }
        },
        {
          type: 'PersonListSelect',
          field: 'acceptPrincipalId',
          title: '验收责任人',
          props: {
            placeholder: '请选择验收责任人'
          },
          on: {
            change: ({ id, person }) => {
              this.commonData.acceptPrincipalName = person.realName
            }
          },
          validate: {
            required: true,
            message: '请选择验收责任人'
          }
        },
        {
          type: 'UploadFile',
          field: 'files',
          title: '附件',
          props: {
            fileList: []
          },
        }
      ]
    }
  },
  created () {
    getDict('CHANGE_TYPE').then(({ data, success}) => {
      if(success) {
        this.alterationTypeOptions = data
        this.rules[3].options = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
      }
    })
    getDict('CHANGE_LEVEL').then(({ data, success}) => {
      if(success) {
        this.alterationLevelOptions = data
        this.rules[4].options = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
      }
    })
  },
  computed: {
    ...mapGetters(['permission'])
  },
  filters: {
    colorFilter: function (value) {
      const colorList = ['orange', 'green']
      return colorList[value]
    },
    textFilter: function (value) {
      const textList = ['未发布', '已发布']
      return textList[value]
    },
  },
  methods: {
    search () {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset () {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam () {
      this.queryParam = {
        name: '',
        type: ''
      }
    },
    commonInit () {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      this.initFormData()
    },
    initFormData () {
      this.commonData = {
        name: null,
        changeUnitId: undefined,
        changePrincipalId: undefined,
        type: undefined,
        level: undefined,
        reason: null,
        content: null,
        alterationDate: null,
        acceptUnitId: undefined,
        acceptPrincipalId: undefined,
        files: []
      }
      this.setFileList([])
    },
    setFileList (fileList) {
      if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
        this.$refs.modal.fApi.getRule('files').props.fileList = fileList
      } else {
        this.rules[10].props.fileList = fileList
      }
    },
    addRecord () {
      this.commonTitle = '新增数据'
      this.initFormData()
      this.commonVisible = true
      this.commonDisabled = false
    },
    editRecord (record) {
      this.commonTitle = '编辑数据'
      this.getById(AlterationApi.alteration,record.id).then(({ data, success }) => {
        if(success) {
          data.type = data.type + ''
          data.level = data.level + ''
          delete data.status
          this.commonData = data
          this.commonData.alterationDate = [data.startTime, data.endTime]
          const files = data.files.map(item => ({
            uid: item.id,
            name: item.fileName,
            status: 'done',
            id: item.id,
            filePath: item.fileUrlPath
          }))
          this.setFileList(files)
          this.commonVisible = true
          this.commonDisabled = false
        }
      })
    },
    publishRecord (record) {
      const params = {
        status: 1,
        id: record.id
      }
      this.submitForm(AlterationApi.alteration, params, 'put').then(({ data, success }) => {
        if(success) {
          this.$message.success('操作成功')
          this.searchReset()
        } else {
          this.$message.error('操作异常')
          this.searchReset()
        }
      })
    },
    removeRecord (record) {
      this.showDeleteConfirm(record.id)
    },
    showDeleteConfirm (params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk () {
          _this.deleteByIds(AlterationApi.alteration + `?id=${params}`, null).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.searchReset()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel () {
          console.log('Cancel')
        }
      })
    },
    viewRecord (record) {
      this.commonTitle = '查看数据'
      this.getById(AlterationApi.alteration,record.id).then(({ data, success}) => {
        if(success) {
          data.type = data.type + ''
          data.level = data.level + ''
          this.commonData = data
          this.commonData.alterationDate = [data.startTime, data.endTime]
          const files = data.files.map(item => ({
            uid: item.id,
            name: item.fileName,
            status: 'done',
            id: item.id,
            filePath: item.fileUrlPath
          }))
          this.setFileList(files)
          this.commonVisible = true
          this.commonDisabled = true
        }
      })
    },
    modalOk({ formData }) {
      console.log(formData)
      let method = ''
      if (this.isNotNullOrUndefined(this.commonData.id)) {
        method = 'put'
        formData.id = this.commonData.id
      } else {
        method = 'post'
      }
      const params = {
        ...this.commonData,
        ...formData,
        files: this.$refs.modal.fApi.getRule('files').props.fileList.map(item => ({
          id: item.id,
          fileUrlPath: item.filePath,
          originalFileName: item.name
        }))
      }
      console.log(params)
      this.submitForm(AlterationApi.alteration, params, method).then(({ success }) => {
        if(success) {
          this.$message.success('操作成功')
          this.commonInit()
          this.searchReset()
        }
      })
    },
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}

/deep/.ant-calendar-picker {
  width: 100%!important;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 77px;
}
</style>