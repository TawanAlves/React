<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8">
              <a-form-item label="物资名称">
                <a-input v-model="queryParam.name" maxlength="32"  placeholder="物资名称"/>
              </a-form-item>
            </a-col>
            <a-col :md="16" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #extra>
        <a-button
          type="primary"
          icon="plus"
          @click="addRecord"
          v-if="permission.health_material_add"
        >新建</a-button>
      </template>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 432px)`, x: 920}"
        showPagination="true"
      >
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <template slot="action" slot-scope="text, record">
          <a @click="removeRecord(record)" v-if="permission.health_material_delete">删除</a>
        </template>
      </s-table>
    </a-card>
    <common-form-modal
      ref="modal"
      :visible.sync="commonVisible"
      :model="commonData"
      modal-title="新增数据"
      :disabled="commonDisabled"
      :rule="rules"
      width="700px"
      @ok="modalOk"
    />
  </page-container>
</template>

<script>
import { STable } from '@/components'
import { materialInfoColumns } from '@/views/safety/health/columns'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import HealthApi from '@/api/health'
import { mapGetters } from 'vuex'

export default {
  name: 'materialInfo',
  components: {
    STable,
    CommonFormModal
  },
  data() {
    return {
      queryParam: {},
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(HealthApi.materialInfoList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      measureUnitOptions: [],
      commonVisible: false,
      commonDisabled: false,
      commonData: {},
      rules: [
        {
          type: 'input',
          field: 'number',
          title: '代码',
          props: {
            maxLength: 32,
            placeholder: '请输入代码'
          },
          validate: {
            required: true,
            message: '请输入代码'
          },
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          field: 'name',
          title: '名称',
          props: {
            maxLength: 32,
            placeholder: '请输入名称'
          },
          validate: {
            required: true,
            message: '请输入名称'
          },
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'select',
          field: 'unit',
          title: '计量单位',
          options: [],
          on: {
            change: e => {
              this.commonData.measurementUnit = this.measureUnitOptions[e - 1].dictValue
            }
          },
          validate: {
            required: true,
            message: '请选择计量单位'
          },
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        },
        {
          type: 'input',
          field: 'remark',
          title: '备注',
          props: {
            type: 'textarea',
            autoSize: {
              minRows: 4,
              maxRows: 8
            },
            maxLength: 255,
            placeholder: ''
          },
          validate: {
            required: false,
            message: '请输入备注'
          },
          wrap: {
            labelCol: { span: 4 },
            wrapperCol: { span: 19 }
          }
        }
      ]
    }
  },
  created() {
    this.getDict('HEALTH_MEASURE').then(({ data, success }) => {
      if (success) {
        this.measureUnitOptions = data
        this.rules[2].options = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
      }
    })
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => materialInfoColumns
  },
  methods: {
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam() {
      this.queryParam = {}
    },
    initFormData() {
      this.commonData = {
        unit: undefined,
        name: null,
        number: null,
        remark: null
      }
    },
    removeRecord(record) {
      this.showDeleteConfirm(record.id)
    },
    showDeleteConfirm(params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.deleteByIds(HealthApi.materialInfo + `?id=${params}`, null).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.table.refresh(true)
              _this.$refs.table.clearSelected()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    },
    addRecord() {
      this.initFormData()
      this.commonVisible = true
    },
    modalOk({ formData }) {
      let method = 'post'
      const params = {
        ...this.commonData,
        ...formData
      }
      this.submitForm(HealthApi.materialInfo, params, method).then(({ success }) => {
        if (success) {
          this.$message.success('操作成功')
          this.searchReset()
          this.commonVisible = false
          this.initFormData()
        }
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
</style>