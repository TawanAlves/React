<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="车间">
                <department-select v-model="queryParam.workshopId"></department-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="领用人">
                <person-list-select v-model="queryParam.recipientId"></person-list-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="领用日期">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
              <a-col  :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #extra>
        <a-button type="primary" icon="plus" @click="addRecord">
          新建
        </a-button>
      </template>
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 432px)`, x: 1320}"
        showPagination="true"
      >
        <span slot="number" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <template slot="status" slot-scope="text, record, index">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0">{{record.status | textFilter}}</a-tag>
        </template>
        <template slot="action" slot-scope="text, record">
          <template v-if="record.status === 0">
            <a @click="editRecord(record)">编辑</a>
            <a-divider type="vertical"/>
            <a @click="updateRecord(record,1)">提交</a>
            <a-divider type="vertical"/>
            <a @click="removeRecord(record)">删除</a>
          </template>
          <template v-else>
            <a @click="viewRecord(record)">查看</a>
            <a-divider type="vertical"/>
            <a @click="updateRecord(record, 0)">撤回</a>
          </template>
        </template>
      </s-table>
    </a-card>
    <a-modal
      ref="modal"
      :title="modalTitle"
      ok-text="保存"
      cancel-text="取消"
      width="50%"
      :keyboard="false"
      :maskClosable='false'
      :destroyOnClose="true"
      :body-style="{maxHeight: '700px', overflowY: 'auto'}"
      :visible="visible"
      @cancel="() => {this.visible = false}"
    >
      <template slot="footer">
        <a-button @click="() => {this.visible = false}">取消</a-button>
        <a-button type="primary" @click="submitLabour(0)" v-if="!disabled">暂存</a-button>
        <a-button type="primary" @click="submitLabour(1)" v-if="!disabled">提交</a-button>
      </template>
      <div class="header-title">
        <span>基本信息</span>
      </div>
      <a-divider/>
      <a-card :bordered="false" :body-style="{'padding-bottom': '0px'}" :head-style="{}">
        <form-create
          ref="basicInfo"
          v-model="fApi"
          :rule="rules"
          :option="option"
          :value="form"
        />
      </a-card>
      <div class="header-title">
        <span>物资信息</span>
        <a-button type="primary" size="small" style="margin-left: 10px" @click="addMaterialInfo()" v-if="!disabled">添加</a-button>
      </div>
      <a-divider/>
      <a-card :bordered="false" :body-style="{'padding-bottom': '0px','padding-top': '0px'}" :head-style="{}">
        <a-table
          :bordered="false"
          :pagination="false"
          size="small"
          :data-source="materialInfo"
          :columns="materialColumns">
          <template slot="number" slot-scope="text, record, index">
            <a-input-number
              style="margin: -5px 0"
              min="0"
              v-model="record.number"
              v-if="!disabled"
            />
            <span v-else>{{text}}</span>
          </template>
          <template slot="action" slot-scope="text, record, index">
            <a @click="removeInfo(record,index)">删除</a>
          </template>
        </a-table>
      </a-card>
    </a-modal>
    <material-select :visible.sync="materialVisible" @ok="submitMaterialInfo"></material-select>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import { labourColumns, labourMaterialColumns } from '@/views/safety/health/columns'
import HealthApi from '@/api/health'
import MaterialSelect from '@/views/safety/health/MaterialSelect'
import cloneDeep from 'lodash.clonedeep'
import { getStore } from '@/utils/store'

export default {
  name: 'labour',
  components: {
    STable,
    MaterialSelect
  },
  data () {
    return {
      queryParam: {},
      searchTime: '',
      userInfo: getStore({ name: 'info'}),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true,
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(HealthApi.labourList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true,
          }
          return data
        })
      },
      fApi: {},
      option: {
        submitBtn: false,
        resetBtn: false,
        wrap: {
          labelCol: { span: 5 },
          wrapperCol: { span: 10 }
        },
        mounted: () => {
          this.form = cloneDeep(this.basicInfo)
          this.fApi.disabled(this.disabled)
        }
      },
      basicInfo: {}, // 基本信息
      visible: false,
      disabled: false,
      rules: [
        {
          type: 'DepartmentSelect',
          field: 'workshopId',
          title: '车间',
          props: {
            placeholder: '请选择车间'
          },
          on: {
            change: ({ label }) => {
              this.basicInfo.workshopName = label
            }
          },
          validate: {
            required: true,
            message: '请选择车间'
          },
          col: {
            span: 8
          },
          wrap: {
            labelCol: { span: 6 },
            wrapperCol: { span: 18 }
          }
        },
        {
          type: 'PersonListSelect',
          field: 'recipientId',
          title: '领用人',
          props: {
            placeholder: '请选择领用人'
          },
          on: {
            change: ({ person }) => {
              this.basicInfo.recipientName = person.realName
            }
          },
          validate: {
            required: true,
            message: '请选择领用人'
          },
          col: {
            span: 8
          },
          wrap: {
            labelCol: { span: 6 },
            wrapperCol: { span: 18 }
          }
        },
        {
          type: 'DatePicker',
          field: 'acceptTime',
          title: '领用日期',
          props: {
            format: 'YYYY-MM-DD HH:mm:ss',
            placeholder: '请选择领用日期'
          },
          validate: {
            required: true,
            message: '请选择领用日期'
          },
          col: {
            span: 8
          },
          wrap: {
            labelCol: { span: 7 },
            wrapperCol: { span: 17 }
          }
        },
        {
          type: 'input',
          field: 'remark',
          title: '备注',
          props: {
            type: 'textarea',
            autoSize: {
              minRows: 4,
              maxRows: 8
            },
            maxLength: 255,
            disabled:  false,
          },
          validate: {
            required: false,
            message: '请选择领用日期'
          },
          wrap: {
            labelCol: { span: 2 },
            wrapperCol: { span: 22 }
          }
        }
      ],
      materialInfo: [], // 物资信息
      materialVisible: false,
      form: {},
      modalTitle: ''
    }
  },
  computed: {
    materialColumns () {
      if(this.disabled) {
        if (labourMaterialColumns.length === 5) {
          labourMaterialColumns.pop()
        }
      } else {
        if(labourMaterialColumns.length !== 5) {
          labourMaterialColumns.push({
            title: '操作',
            dataIndex: 'action',
            width: '180px',
            align: 'center',
            fixed: 'right',
            scopedSlots: { customRender: 'action' }
          })
        }
      }
      return labourMaterialColumns
    },
    columns: () => labourColumns
  },
  filters: {
    colorFilter: function (value) {
      const colorList = ['orange', 'green']
      return colorList[value]
    },
    textFilter: function (value) {
      const textList = ['待提交', '已提交']
      return textList[value]
    }
  },
  methods: {
    search () {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset () {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam () {
      this.queryParam = {
      }
      this.searchTime = ''
    },
    initBasicInfo () {
      this.basicInfo = {
        workshopId: undefined,
        recipientId: undefined,
        acceptTime: null,
        remark: null
      }
      console.log(this.basicInfo)
    },
    onTimeChange (value, dateString) {
      this.queryParam.startTime = dateString[0]
      this.queryParam.endTime = dateString[1]
    },
    addRecord () {
      this.initBasicInfo()
      this.materialInfo = []
      this.modalTitle = '新增数据'
      this.disabled = false
      this.visible = true
      this.fApi.resetFields()
    },
    submitLabour (status) {
      this.fApi.submit((formData, fApi) => {
        if(!this.materialInfo.length) {
          this.$message.error('请添加物资信息后提交')
          return
        }
        const params = {
          ...this.basicInfo,
          ...formData,
          list: this.materialInfo,
          status: status
        }
        const method = this.isNotNullOrUndefined(params.id)? 'put' : 'post'
        this.submitForm(HealthApi.labour, params, method).then(({ data, success}) => {
          if(success) {
            this.$message.success('操作成功')
            this.visible = false
            this.searchReset()
          }
        })
      })
    },
    removeRecord (record) {
      this.showDeleteConfirm(record.id)
    },
    showDeleteConfirm (params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk () {
          _this.deleteByIds(HealthApi.labour + `?id=${params}`, null).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.$refs.table.refresh(true)
              _this.$refs.table.clearSelected()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel () {
          console.log('Cancel')
        }
      })
    },
    editRecord (record) {
      this.getById(HealthApi.labour + `?id=${record.id}`, null).then(({ data, success }) => {
        if(success) {
          this.materialInfo = data.list
          delete data.list
          this.basicInfo = data
          this.modalTitle = '编辑数据'
          this.visible = true
          this.disabled = false
        }
      })
    },
    viewRecord (record) {
      this.getById(HealthApi.labour + `?id=${record.id}`, null).then(({ data, success }) => {
        if(success) {
          this.materialInfo = data.list
          delete data.list
          this.basicInfo = data
          this.modalTitle = '查看数据'
          this.visible = true
          this.disabled = true
        }
      })
    },
    updateRecord (record, status) {
      this.getById(HealthApi.labour + `?id=${record.id}`, null).then(({ data, success }) => {
        if(success) {
          const params = {
            ...data,
            status: status
          }
          this.submitForm(HealthApi.labour, params, 'put').then(({ success }) => {
            if(success) {
              this.$message.success('操作成功')
              this.searchReset()
            }
          })
        }
      })
    },
    removeInfo (record,index) {
      this.materialInfo.splice(index,1)
    },
    addMaterialInfo () {
      this.materialVisible = true
    },
    submitMaterialInfo ({ values }) {
      const ids = this.materialInfo.map(item => {
        return item.goodsId
      })
      const list = []
      values.forEach(item => {
        if(ids.indexOf(item.id) < 0)
        list.push({
          goodsId: item.id,
          name: item.name,
          number: 0,
          unit: item.measurementUnit
        })
      })
      this.materialInfo = [ ...this.materialInfo, ...list]
      this.materialVisible = false
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.header-title {
  font-size: 16px;
  color: blue;

  span {
    margin-right: 10px;
  }
}
/deep/ .ant-divider-horizontal {
  margin: 7px 0;
}
/deep/.ant-calendar-picker {
  width: 100%;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 77px;
}
</style>