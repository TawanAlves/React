<template>
  <a-modal
    :title="modalTitle"
    :visible="visible"
    :confirmLoading="loading"
    @cancel="() => { $emit('update:visible', false) }"
    :maskClosable="false"
    :keyboard="false"
  >
    <a-spin :spinning="loading">
      <a-form-model :model="form" ref="ruleForm" :rules="rules" :label-col="{span: 6}" :wrapper-col="{span:17}">
        <div class="header-title">违规信息</div>
        <a-divider/>
        <a-row :gutter="24">
          <a-col :md="24">
            <a-form-model-item label="承包商名称" prop="contractorId">
              <a-select
                show-search
                v-model="form.contractorId"
                placeholder="请选择承包商"
                style="width: 100%"
                :filter-option="filterOption"
                option-filter-prop="children"
                @change="handleContractChange"
                :disabled="disabled"
              >
                <a-select-option v-for="d in contractors" :key="d.id">
                  {{ d.name }}
                </a-select-option>
              </a-select>
            </a-form-model-item>
          </a-col>
          <a-col :md="24">
            <a-form-model-item label="违规人" prop="illegalPersonId">
              <a-select
                show-search
                v-model="form.illegalPersonId"
                placeholder="请选择违规人"
                style="width: 100%"
                :filter-option="filterOption"
                option-filter-prop="children"
                @change="illegalPersonChange"
                :disabled="disabled"
                allowClear
              >
                <a-select-option v-for="d in illegalPersonList" :key="d.id">
                  {{ d.name }}
                </a-select-option>
              </a-select>
            </a-form-model-item>
          </a-col>
          <a-col :md="24">
            <a-form-model-item label="违规日期" prop="illegalDate">
              <a-date-picker
                v-model="form.illegalDate"
                style="width: 100%"
                show-time
                valueFormat="YYYY-MM-DD HH:mm:ss"
                placeholder="请选择违规日期"
                :disabled="disabled"
              />
            </a-form-model-item>
          </a-col>
          <a-col :md="24">
            <a-form-model-item label="违规类型" prop="type">
              <a-select
                show-search
                v-model="form.type"
                placeholder="请选择违规类型"
                style="width: 100%"
                :filter-option="filterOption"
                option-filter-prop="children"
                :disabled="disabled"
              >
                <a-select-option v-for="d in selectOptions" :key="d.dictKey">
                  {{ d.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-model-item>
          </a-col>
          <a-col :md="24">
            <a-form-model-item label="违规描述" prop="description">
              <a-textarea
                v-model="form.description"
                placeholder="请输入违规描述"
                :auto-size="{ minRows: 3, maxRows: 5 }"
                :disabled="disabled"
                :max-length="256"
              />
            </a-form-model-item>
          </a-col>
          <a-col :md="24">
            <a-form-model-item label="现场照片">
              <upload-file
                accept=".jpg, .jpeg, .png"
                :fileList="localePhotos"
                :upload-result="(fileJson, resp) => handleUpload(fileJson, resp, 'localePhotos')"
                :removePro="(file) => removeFile(file, 'localePhotos')"
                listType="picture-card"
                :disabled="disabled"
                :previewEnabled="true"
              />
            </a-form-model-item>
          </a-col>
        </a-row>
        <div class="header-title">处理信息</div>
        <a-divider />
        <a-row :gutter="24">
          <a-col :md="24">
            <a-form-model-item label="处理结果" prop="contactWay">
              <a-row type="flex">
                <a-col :flex="1">
                  <a-select
                    style="width: 100%;padding-right: 5px;"
                    show-search
                    v-model="form.resultType"
                    placeholder="处理结果"
                    :filter-option="filterOption"
                    option-filter-prop="children"
                    :disabled="disabled"
                  >
                    <a-select-option v-for="d in resultTypeOptions" :key="d.dictKey">
                      {{ d.dictValue }}
                    </a-select-option>
                  </a-select>
                </a-col>
                <a-col flex="150px">
                  <a-input v-model="form.forfeit" placeholder="请输入金额" :disabled="disabled" suffix="元" :max-length="32"/>
                </a-col>
              </a-row>

            </a-form-model-item>

          </a-col>
          <a-col :md="24">
            <a-form-model-item label="处理结果说明" prop="resultExplain">
              <a-textarea
                v-model="form.resultExplain"
                placeholder="请输入处理结果说明"
                :auto-size="{ minRows: 3, maxRows: 5 }"
                :disabled="disabled"
                :max-length="256"
              />
            </a-form-model-item>
          </a-col>
        </a-row>
      </a-form-model>
    </a-spin>
    <template slot="footer">
      <a-button key="back" @click="() => { $emit('update:visible', false) }">
        取消
      </a-button>
      <a-button key="submit" type="primary" @click="saveForm" v-if="!disabled">
        确定
      </a-button>
    </template>
  </a-modal>
</template>

<script>
import UploadFile from '@/components/UploadFile'
import { getContractorListNoPage } from '@/api/safety'
import PersonListSelect from '../components/PersonListSelect'
import cloneDeep from 'lodash.clonedeep'
import URLS from '@/api/urls'
export default {
  name: 'LawlessRecordModal',
  components: {
    UploadFile,
    PersonListSelect
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    model: {
      type: Object,
      default: () => null
    },
    selectOptions: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      illegalPersonList: [],
      localePhotos: [],
      contractors: [],
      form: cloneDeep(this.model),
      rules: {
        contractorId: [
          { required: true, message: '请选择承包商', trigger: 'blur' }
        ],
        illegalPersonId: [
          { required: true, message: '请选择违规人', trigger: 'blur' }
        ],
        illegalDate: [
          { required: true, message: '请选择违规日期', trigger: 'blur' },
          {
            validator: (rule, value, callback) => {
              if (new Date(value).getTime() >= new Date().getTime()) {
                callback(new Error('违规时间不能晚于当前时间'))
              } else {
                callback()
              }
            },
            trigger: 'changed'
          }
        ],
        type: [
          { required: true, message: '请选择违规类型', trigger: 'blur' }
        ],
        description: [
          { required: true, message: '请输入违规描述', trigger: 'blur' }
        ]
      }
    }
  },
  watch: {
    model: function (val) {
      this.form = Object.assign({ illegalPersonId: undefined }, cloneDeep(val))
      this.localePhotos = this.form.localePhotos.map(item => ({
        uid: item.id,
        name: item.fileName,
        status: 'done',
        id: item.id,
        url: this.BASE_URL + '/spang-safety/file' + item.filePath
      }))
    }
  },
  created () {
    getContractorListNoPage().then(res => {
      this.contractors = res.data
    })
    this.getDict('PROCESS_RESULT').then(({ data, success }) => {
      if (success) {
        this.resultTypeOptions = data.map(item => ({
          ...item,
          dictKey: parseInt(item.dictKey)
        }))
      }
    })
  },
  methods: {
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
    saveForm () {
      this.$refs.ruleForm.validate((valid, errorProp) => {
        if (valid) {
          const patten = /^[+-]?(0|([1-9]\d*))(\.\d+)?$/g
          if (this.form.forfeit && !patten.test(this.form.forfeit)) {
            this.$message.error('请输入正确的金额')
          }
          this.$emit('ok', { formData: this.form })
        } else {
          console.error(errorProp)
          this.$message.error('操作失败，请重新检查表单')
          return false
        }
      })
    },
    handleContractChange (id) {
      this.form.contractorName = this.contractors.find(item => item.id === id).name
      this.form.illegalPersonId = undefined
      this.getList(URLS.illegalPersons, {
        contractorId: id
      }).then(({ data, success }) => {
        if (success) {
          this.illegalPersonList = data
        }
      })
    },
    illegalPersonChange (value) {
      this.form.illegalPersonName = this.illegalPersonList.find(item => item.id === value).name
    },
    handleUpload (fileJson, resp, field) {
       if (fileJson.status === 'done' && resp.success) {
          this.form[field].push({
            originalFileName: resp.data.originalFileName,
            fileUrlPath: resp.data.urlPath,
            id: resp.data.id
          })
       }
    },
    removeFile (file, field) {
      const index = this.form[field].findIndex(item => item.id === file.id)
      if (index > -1) {
        this.form[field].splice(index, 1)
      }
      const fileIndex = this.localePhotos.findIndex(item => item.uid === file.uid)
      if (fileIndex > -1) {
        this.localePhotos.splice(fileIndex, 1)
      }
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
}
/deep/ .ant-divider-horizontal {
  margin: 7px 0;
}
.header-title {
    font-size: 16px;
    color: blue;

    span {
      margin-right: 10px;
    }
  }

</style>
