<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8">
              <a-form-item label="承包商名称">
                <a-input v-model="queryParam.contractorName" placeholder="承包商名称"/>
              </a-form-item>
            </a-col>
            <a-col :md="16" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button type="primary" icon="plus" @click="addRecord" v-if="permission.contractor_add">
            新建
          </a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{y: `calc(100vh - 432px)`, x: 1210}"
        :pagination="pagination"
      >
        <span slot="serial" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <span slot="status" slot-scope="text, record">
          <a-tag :color="record.status ?'green':'orange'">{{ record.status ? '已发布' : '未发布' }}</a-tag>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="publishRecord(record, 1)" v-if="record.status !== 1 && permission.contractor_publish">发布</a>
            <a @click="publishRecord(record, 0)" v-if="record.status === 1 && permission.contractor_recall">撤回</a>
            <a-divider type="vertical" v-if="record.status === 1 && permission.contractor_recall"/>
            <a @click="checkRecord(record)" v-if="record.status === 1">查看</a>
            <a-divider type="vertical" v-if="record.status !== 1 && permission.contractor_edit"/>
            <a @click="editRecord(record)" v-if="permission.contractor_edit && record.status !== 1">编辑</a>
            <a-divider type="vertical" v-if="record.status !== 1 && permission.contractor_delete"/>
            <a @click="removeRecord(record)" v-if="permission.contractor_delete && record.status !== 1">删除</a>
          </template>
        </span>
      </s-table>
      <common-form-modal
        ref="modal"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        @ok="modalOk"
      />
    </a-card>
  </page-container>
</template>
<script>
  import { STable } from '@/components'
  import { contractorColumns } from '@/views/safety/table'
  import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
  import { getContractorList, submitContractorItem, deleteContractor } from '@/api/safety'
  import { mapGetters } from 'vuex'
  import { isvalidatemobile } from '@/utils/validate'

  export default {
    name: 'Contractor',
    components: {
      STable,
      CommonFormModal
    },
    data () {
      return {
        pagination: {
          pageSize: 10,
          current: 1,
          showSizeChanger: true
        },
        natureOptions: [],
        confirmLoading: false,
        commonTitle: '',
        commonVisible: false,
        commonData: {},
        commonDisabled: false,
        queryParam: {},
        selectedRowKeys: [],
        selectedRows: [],
        loadData: parameter => {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          Object.assign(requestParameters, this.queryParam)
          return getContractorList(requestParameters).then(res => {
            this.pagination = { ...this.pagination, pageSize: res.data.size, current: res.data.current }
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          })
        },
        rules: [
          {
            type: 'input',
            title: '承包商名称',
            field: 'name',
            props: {
              type: 'text',
              placeholder: '请输入承包商名称',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入承包商名称',
              trigger: 'blur'
            }]
          },
          {
            type: 'select',
            field: 'nature',
            title: '承包商性质',
            options: [],
            validate: [{
              required: true,
              message: '请选择承包商性质',
              trigger: 'blur'
            }],
            props: {
              placeholder: '请选择承包商性质'
            }
          },
          {
            type: 'input',
            title: '法人',
            field: 'legalPerson',
            props: {
              type: 'text',
              placeholder: '请输入法人',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入法人',
              trigger: 'blur'
            }]
          },
          {
            type: 'input',
            title: '联系方式',
            field: 'contactWay',
            props: {
              type: 'text',
              placeholder: '请输入联系方式',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入联系方式',
              trigger: 'blur'
            }, {
              validator: (rule, value, callback) => {
                const isValid = isvalidatemobile(value)
                if (!isValid[0]) {
                  callback()
                } else {
                  callback(new Error(isValid[1]))
                }
              },
              trigger: 'change'
            }]
          },
          {
            type: 'input',
            title: '地址',
            field: 'address',
            props: {
              type: 'text',
              placeholder: '请输入地址',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入地址',
              trigger: 'blur'
            }]
          },
          {
            type: 'radio',
            title: '是否在合作期内',
            field: 'isCooperationPeriod',
            value: 1,
            options: [
              { value: 0, label: '是' },
              { value: 1, label: '否' }
            ],
            props: {
              disabled: false
            }
          },
          {
            type: 'input',
            title: '相关介绍',
            field: 'description',
            props: {
              type: 'textarea',
              placeholder: '请输入相关介绍',
              rows: 4,
              autoSize: { minRows: 3, maxRows: 5 },
              maxLength: 256
            }
          },
          {
            type: 'UploadFile',
            field: 'license',
            title: '营业执照',
            props: {
              fileList: [],
              accept: '.jpg, .jpeg, .png'
            },
            validate: [{
              required: true,
              validator: (rule, value, callback) => {
                const files = this.$refs.modal.fApi.getRule('license').props.fileList
                console.log(files)
                if (!files || files.length < 1) {
                  callback(new Error('请选择营业执照'))
                } else {
                  callback()
                }
              },
              trigger: 'change'
            }]
          },
          {
            type: 'UploadFile',
            field: 'qualification',
            title: '施工资质',
            props: {
              fileList: [],
              accept: '.jpg, .jpeg, .png'
            }
          }
        ]
      }
    },
    computed: {
      ...mapGetters(['permission']),
      columns: () => contractorColumns,
      hasSelected () {
        return this.selectedRowKeys.length > 0
      },
      rowSelection () {
        return {
          selectedRowKeys: this.selectedRowKeys,
          onChange: this.onSelectChange
        }
    }
    },
    methods: {
      setFileList (fileList7, fileList8) {
        if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
          this.$refs.modal.fApi.getRule('license').props.fileList = fileList7
          this.$refs.modal.fApi.getRule('qualification').props.fileList = fileList8
        } else {
          this.rules[7].props.fileList = fileList7
          this.rules[8].props.fileList = fileList8
        }
      },
      initFormData () {
        this.commonData = {
          license: [],
          qualification: [],
          isCooperationPeriod: 1,
          name: null,
          nature: undefined,
          legalPerson: null,
          contactWay: null,
          address: null,
          description: null
        }
        this.setFileList([], [])
      },
      commonInit () {
        this.commonVisible = false
        this.commonDisabled = false
        this.commonTitle = ''
        this.confirmLoading = false
        this.initFormData()
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      searchReset () {
        this.queryParam = {}
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      addRecord () {
        this.commonTitle = '新增数据'
        this.initFormData()
        this.commonVisible = true
        this.commonDisabled = false
      },
      removeRecords () {
        var ids = ''
        this.selectedRows.forEach((item, index) => {
          ids = ids + item.id + ','
        })
        this.showDeleteConfirm(ids)
      },
      setRecord (record) {
        this.commonData = { ...record }
        const fileList7 = record.license.map(item => ({
          uid: item.id,
          name: item.fileName,
          status: 'done',
          id: item.id,
          filePath: item.filePath
        }))
        const fileList8 = record.qualification.map(item => ({
          uid: item.id,
          name: item.fileName,
          status: 'done',
          id: item.id,
          filePath: item.filePath
        }))
        this.setFileList(fileList7, fileList8)
      },
      checkRecord (record) {
        this.commonTitle = '查看数据'
        this.setRecord(record)
        this.commonVisible = true
        this.commonDisabled = true
      },
      editRecord (record) {
        this.commonTitle = '编辑数据'
        this.setRecord(record)
        this.commonVisible = true
        this.commonDisabled = false
      },
      removeRecord (record) {
        this.showDeleteConfirm(record.id)
      },
      modalOk ({ formData }) {
        let method = ''
        if (this.isNotNullOrUndefined(this.commonData.id)) {
          method = 'put'
          formData.id = this.commonData.id
          formData.status = this.commonData.status
        } else {
          method = 'post'
          formData.status = 0
        }
        const params = {
          ...formData,
          license: this.$refs.modal.fApi.getRule('license').props.fileList.map(item => ({
            id: item.id,
            fileUrlPath: item.filePath,
            originalFileName: item.name
          })),
          qualification: this.$refs.modal.fApi.getRule('qualification').props.fileList.map(item => ({
            id: item.id,
            fileUrlPath: item.filePath,
            originalFileName: item.name
          }))
        }
        submitContractorItem(params, method, {
          // headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
          this.commonInit()
        })
      },
      publishRecord (record, status) {
        const params = {
          ...record,
          status
        }
        submitContractorItem(params, 'put').then(res => {
          this.$message.success(`操作成功`)
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
        })
      },
      showDeleteConfirm (params) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            deleteContractor(params).then(res => {
              if (res.code === 200) {
                _this.$message.success('删除成功')
                _this.selectedRows = []
                _this.selectedRowKeys = []
                _this.$refs.table.refresh()
              } else {
                _this.$message.error('删除失败')
              }
            })
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      }
    },
    created () {
      this.getDict('ENTERPRISE_PROPERTY').then(res => {
        this.natureOptions = res.data
        this.rules[1].options = this.natureOptions.map(item => ({
          label: item.dictValue,
          value: item.dictKey
        }))
      })
    }
  }
</script>
<style lang="less" scoped>
  /deep/ .ant-table {
    height: auto;
  }

  /deep/ .table-card .ant-card-body {
    padding-top: 0;
    padding-bottom: 15px;
  }

  .card-title {
    display: flex;
    justify-content: space-between;
  }

</style>
