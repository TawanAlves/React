<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px;" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="8" :sm="12" :xs="24">
              <a-form-item label="承包商名称">
                <a-input v-model="queryParam.contractorName" placeholder="承包商名称"/>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="12" :xs="24">
              <a-form-item label="人员姓名">
                <a-input v-model="queryParam.userName" placeholder="人员姓名"/>
              </a-form-item>
            </a-col>
            <a-col :md="8" :sm="24" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button type="primary" icon="plus" @click="addRecord" v-if="permission.contractor_person_add">
            新建
          </a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{y: `calc(100vh - 432px)`, x: 1310}"
        :pagination="pagination"
      >
        <span slot="serial" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
        <span slot="viewAction" slot-scope="text, record">
          <template>
            <a @click="preview(record)">查看</a>
          </template>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="editRecord(record)">编辑</a>
            <a-divider type="vertical"/>
            <a @click="checkRecord(record)">查看</a>
            <a-divider type="vertical"/>
            <a @click="removeRecord(record)">删除</a>
          </template>
        </span>
      </s-table>
      <common-form-modal
        ref="modal"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        @ok="modalOk"
      />
      <a-modal
        title="查看图片"
        :visible="previewVisible"
        :footer="null"
        @cancel="previewVisible = false"
        :keyboard="false"
        :maskClosable="false"
        :bodyStyle="{minHeight: '400px',display: 'flex', justifyContent: 'center', alignItems: 'center'}"
      >
        <vue-viewer
          multiple
          list-ul-class="image-list"
          v-if="imageList.length > 0"
          :thumb="imageList"
          :full="imageList">
        </vue-viewer>
        <div v-else>
          <a-empty />
        </div>
      </a-modal>
    </a-card>
  </page-container>
</template>
<script>
  import { STable } from '@/components'
  import { contractorPersonColumns } from '@/views/safety/table'
  import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
  import {
    getContractorPersonList,
    submitContractorPerson,
    deleteContractorPerson,
    getContractorListNoPage,
    getContractorPersonById
  } from '@/api/safety'
  import { mapGetters } from 'vuex'
  import { cardid, isvalidatemobile } from '@/utils/validate'

  // eslint-disable-next-line no-undef
  formCreate.register({
    name: 'contractorOptions',
    init ({ val }, rule) {
      getContractorListNoPage().then(({ data, success }) => {
        if (success) {
          rule.options = data.map(row => {
            return {
              label: row.name,
              value: row.id
            }
          })
        }
      })
    }
  })
  export default {
    name: 'ContractorPerson',
    components: {
      STable,
      CommonFormModal
    },
    data () {
      return {
        pagination: {
          pageSize: 10,
          current: 1,
          showSizeChanger: true
        },
        imageList: [],
        previewVisible: false,
        confirmLoading: false,
        commonTitle: '',
        commonVisible: false,
        commonData: {
          contractorId: undefined,
          contractorName: null,
          name: null,
          idCard: null,
          contactWay: null,
          post: null,
          remark: null,
          qualification: []
        },
        commonDisabled: false,
        selectOptions: [],
        queryParam: {},
        selectedRowKeys: [],
        selectedRows: [],
        loadData: parameter => {
          const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
          Object.assign(requestParameters, this.queryParam)
          return getContractorPersonList(requestParameters).then(res => {
            this.pagination = { ...this.pagination, pageSize: res.data.size, current: res.data.current }
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          })
        },
        rules: [
          {
            type: 'select',
            field: 'contractorId',
            title: '所属承包商',
            options: [],
            effect: {
              contractorOptions: ''
            },
            validate: [{
              required: true,
              message: '请选择承包商',
              trigger: 'blur'
            }],
            props: {
              placeholder: '请选择承包商'
            },
            on: {
              change: (id) => {
                const contractors = this.$refs.modal.fApi.getRule('contractorId').options
                this.$set(this.commonData, 'contractorName', contractors.find(item => item.value === id).label)
              }
            }
          },
          {
            type: 'input',
            title: '姓名',
            field: 'name',
            props: {
              type: 'text',
              placeholder: '请输入姓名',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入姓名',
              trigger: 'blur'
            }]
          },
          {
            type: 'input',
            title: '身份证',
            field: 'idCard',
            props: {
              type: 'text',
              placeholder: '请输入身份证',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入身份证',
              trigger: 'blur'

            }, {
              validator: (rule, value, callback) => {
                const isValid = cardid(value)
                if (!isValid[0]) {
                  callback()
                } else {
                  callback(new Error(isValid[1]))
                }
              },
              trigger: 'change'
            }]
          },
          {
            type: 'input',
            title: '联系方式',
            field: 'contactWay',
            props: {
              type: 'text',
              placeholder: '请输入联系方式',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入联系方式',
              trigger: 'blur'
            }, {
              validator: (rule, value, callback) => {
                const isValid = isvalidatemobile(value)
                if (!isValid[0]) {
                  callback()
                } else {
                  callback(new Error(isValid[1]))
                }
              },
              trigger: 'change'
            }]
          },
          {
            type: 'input',
            title: '岗位角色',
            field: 'post',
            props: {
              type: 'text',
              placeholder: '请输入岗位角色',
              maxLength: 32
            },
            validate: [{
              required: true,
              message: '请输入岗位角色',
              trigger: 'blur'
            }]
          },
          {
            type: 'input',
            title: '备注',
            field: 'remark',
            props: {
              type: 'textarea',
              placeholder: '请输入备注',
              rows: 4,
              autoSize: { minRows: 3, maxRows: 5 },
              maxLength: 256
            },
            validate: [{
              required: true,
              message: '请输入备注',
              trigger: 'blur'
            }]
          },
          {
            type: 'UploadFile',
            field: 'qualification',
            title: '资质证书',
            props: {
              fileList: [],
              accept: '.jpg, .jpeg, .png'
            }
          }
        ]
      }
    },
    computed: {
      ...mapGetters(['permission']),
      columns: () => contractorPersonColumns,
      hasSelected () {
        return this.selectedRowKeys.length > 0
      },
      rowSelection () {
        return {
          selectedRowKeys: this.selectedRowKeys,
          onChange: this.onSelectChange
        }
      }
    },
    methods: {
      setFileList (fileList) {
        if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
          this.$refs.modal.fApi.getRule('qualification').props.fileList = fileList
        } else {
          this.rules[6].props.fileList = fileList
        }
      },
      initFormData () {
        this.commonData = {
          contractorId: undefined,
          contractorName: null,
          name: null,
          idCard: null,
          contactWay: null,
          post: null,
          remark: null,
          qualification: []
        }
        this.setFileList([])
      },
      commonInit () {
        this.commonVisible = false
        this.commonDisabled = false
        this.commonTitle = ''
        this.confirmLoading = false
        this.initFormData()
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      searchReset () {
        this.queryParam = {}
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      addRecord () {
        this.commonTitle = '新增数据'
        this.initFormData()
        this.commonVisible = true
        this.commonDisabled = false
      },
      removeRecords () {
        var ids = ''
        this.selectedRows.forEach((item, index) => {
          ids = ids + item.id + ','
        })
        this.showDeleteConfirm(ids)
      },
      setRecord (record) {
        this.commonData = { ...record }
        const files = record.qualification.map(item => ({
          uid: item.id,
          name: item.fileName,
          status: 'done',
          id: item.id,
          filePath: item.filePath
        }))
        this.setFileList(files)
      },
      setEditRecord (record) {
        getContractorPersonById(record.id).then(({ success, data }) => {
          if (success) {
            this.commonData = { ...data }
            const files = data.qualification.map(item => ({
              uid: item.id,
              name: item.fileName,
              status: 'done',
              id: item.id,
              filePath: item.filePath
            }))
            this.setFileList(files)
          }
        })
      },
      checkRecord (record) {
        this.commonTitle = '查看数据'
        this.setRecord(record)
        this.commonVisible = true
        this.commonDisabled = true
      },
      editRecord (record) {
        this.commonTitle = '编辑数据'
        this.setEditRecord(record)
        this.commonVisible = true
        this.commonDisabled = false
      },
      removeRecord (record) {
        this.showDeleteConfirm(record.id)
      },
      modalOk ({ formData }) {
        const method = this.isNotNullOrUndefined(this.commonData.id) ? 'put' : 'post'
        const params = Object.assign({ id: this.commonData.id }, formData, {
          qualification: this.$refs.modal.fApi.getRule('qualification').props.fileList.map(item => ({
            id: item.id,
            fileUrlPath: item.filePath,
            originalFileName: item.name
          })),
          contractorName: this.commonData.contractorName
        })
        submitContractorPerson(params, method, {
          // headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
          this.commonInit()
        })
      },
      publishRecord (record, status) {
        const params = {
          id: record.id,
          status: status
        }
        submitContractorPerson(params, 'put').then(res => {
          this.$message.success(`操作成功`)
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
        })
      },
      showDeleteConfirm (params) {
        const _this = this
        this.$confirm({
          title: '确定执行删除操作?',
          content: ' ',
          okText: '是',
          okType: 'danger',
          cancelText: '否',
          onOk () {
            deleteContractorPerson(params).then(res => {
              if (res.code === 200) {
                _this.$message.success('删除成功')
                _this.selectedRows = []
                _this.selectedRowKeys = []
                _this.$refs.table.refresh()
              } else {
                _this.$message.error('删除失败')
              }
            })
          },
          onCancel () {
            console.log('Cancel')
          }
        })
      },
      preview (record) {
        this.imageList = record.qualification.map(item => (this.BASE_URL + '/spang-safety/file' + item.filePath))
        this.previewVisible = true
      }
    }
  }
</script>
<style lang="less" scoped>
  /deep/ .ant-table {
    height: auto;
  }

  /deep/ .table-card .ant-card-body {
    padding-top: 0;
    padding-bottom: 15px;
  }

  .card-title {
    display: flex;
    justify-content: space-between;
  }

 /deep/ .image-list{
  margin: 0; padding: 0
}
  /deep/  .image-list li {
    display: inline-block;
    margin: 10px;
    list-style: none;
    position: relative;
  }
  /deep/  .image-list li img {
    box-shadow: 0 0 5px #333;
  }
  /deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
    width: 92px;
  }
</style>
