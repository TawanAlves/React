<template>
  <a-modal
    :title="modalTitle"
    :visible="visible"
    :confirmLoading="loading"
    @ok="() => { $emit('ok') }"
    @cancel="() => { $emit('cancel') }"
    ok-text="提交"
    cancel-text="取消"
    width="60%"
    :keyboard="false"
    :maskClosable="false"
  >
    <a-spin :spinning="loading">
      <a-form :form="form" :label-col="{span:9}" :wrapper-col="{span:14}">
        <a-row class="form-title">
          <h4 class="text-primary">基础信息</h4>
          <a-divider />
        </a-row>
        <a-row :gutter="24">
          <!--基础信息-->
          <a-col :md="12">
            <a-form-item label="作业票种类">
              <a-select
                v-decorator="['ticketType',{ rules:[{ required: true, message: '请选择作业票类型'}]}]"
                :disabled="disabled"
                @change="(value) => {this.ticketType =value}">
                <a-select-option v-for="item in ticketTypeOptions" :key="item.dictKey">
                  {{ item.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
          </a-col>
        </a-row>
        <a-row :gutter="24">
          <!--动火作业-->
          <div v-if="ticketType ==='0'">
            <a-col :md="12">
              <a-form-item label="动火级别">
                <a-select
                  v-decorator="['taskHotWorkTicketDTO.hotWorkLevel',{ rules:[{ required: true, message: '请选择动火作业级别' }]}]"
                  :disabled="disabled">
                  <a-select-option v-for="item in hotLevel" :key="item.dictKey">
                    {{ item.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
              <a-form-item label="动火地点">
                <a-input
                  v-decorator="['taskHotWorkTicketDTO.location',{ rules:[{ required: false, message: '请输入动火地点' }]}]"
                  :disabled="disabled"/>
              </a-form-item>
              <person-select label-name="监火人" required decorator-name="taskHotWorkTicketDTO.charger" :disabled="disabled"/>
              <a-form-item label="动火开始时间">
                <a-date-picker
                  show-time
                  v-decorator="['startTime',{ rules:[{ required: true, message: '请输选择动火开始时间' }]}]"
                  :disabled="disabled"
                  valueFormat="YYYY-MM-DD HH:mm:ss"/>
              </a-form-item>
              <a-form-item label="动火结束时间">
                <a-date-picker
                  show-time
                  v-decorator="['endTime',{ rules:[{ required: true, message: '请选择动火结束时间' }]}]"
                  :disabled="disabled"
                  valueFormat="YYYY-MM-DD HH:mm:ss"/>
              </a-form-item>
            </a-col>
            <a-col :md="12">
              <a-form-item label="动火申请单位">
                <a-input
                  v-decorator="['taskHotWorkTicketDTO.location',{ rules:[{ required: false, message: '请输入动火申请单位' }]}]"
                  disabled/>
              </a-form-item>
              <a-form-item label="申请人">
                <a-input :value="userInfo.name" disabled/>
              </a-form-item>
              <a-form-item label="作业方式">
                <a-select
                  v-decorator="['taskHotWorkTicketDTO.mode']"
                  mode="multiple"
                  style="width: 100%"
                  placeholder="请选择作业方式"
                >
                  <a-select-option v-for="item in taskModes" :key="item.label">
                    {{ item.label }}
                  </a-select-option>
                </a-select>
              </a-form-item>
              <a-form-item label="作业内容">
                <a-input
                  v-decorator="['taskHotWorkTicketDTO.taskContent',{ rules:[{ required: false, message: '请输入作业内容' }]}]"
                  :disabled="disabled"/>
              </a-form-item>
              <a-form-item label="是否附安全工作方案或图纸">
                <a-radio-group v-decorator="['taskHotWorkTicketDTO.workplan']">
                  <a-radio :value="0">
                    是
                  </a-radio>
                  <a-radio :value="1">
                    否
                  </a-radio>
                </a-radio-group>
              </a-form-item>
            </a-col>
            <a-col :md="24">
              <div class="table-title text-primary">
                <span>涉及的其他特殊作业</span>
                <a-button type="primary" @click="drawerVisible=true; loadData()" style="margin-left: 15px">添加</a-button>
              </div>
              <a-divider />
              <a-table
                ref="table-other-task"
                size="default"
                :columns="otherTaskColumns"
                :data-source="otherTaskData"
                :pagination="false"
                rowKey="id"
              >
                <template slot="operation" slot-scope="text, record, index">
                  <a-button type="primary" @click="deleteOtherTask(index)" style="margin-left: 15px">删除</a-button>
                </template>
              </a-table>
              <a-drawer
                :width="720"
                :closable="false"
                :visible="drawerVisible"
                @close="drawerVisible = false"
              >
                <a-table
                  ref="table-other-task-add"
                  size="default"
                  :columns="otherTaskAddedColumns"
                  :data-source="otherTaskAddedData"
                  :pagination="false"
                  rowKey="id"
                >
                  <template slot="operation" slot-scope="text, record, index">
                    <a-button type="primary" @click="addOtherTask(record)">添加</a-button>
                  </template>
                </a-table>
              </a-drawer>
            </a-col>
          </div>
          <!--受限空间作业票-->
          <div v-if="ticketType ==='1'">
            <department-select
              label-name="受限空间所属单位"
              decorator-name="taskConfinedSpaceTicketDTO.unitId"
              :disabled="disabled"/>
            <a-form-item label="受限空间名称">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.confinedSpaceName',{ rules:[{ required: true, message: '请输入受限空间名称' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="空间内原有介质">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.sourceMedium',{ rules:[{ required: true, message: '请输入空间内原有介质' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="作业单位负责人">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.charger',{ rules:[{ required: true, message: '请输入作业单位负责人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="监护人"
              decorator-name="taskConfinedSpaceTicketDTO.guardianId"
              :disabled="disabled"/>
            <a-form-item label="作业人">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.workPerson',{ rules:[{ required: true, message: '请输入监护人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="有毒有害介质">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.harmMedium',{ rules:[{ required: true, message: '请输入有毒有害介质' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="可燃气">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.combustibleGas',{ rules:[{ required: true, message: '请输入可燃气' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="氧含量">
              <a-input
                v-decorator="['taskConfinedSpaceTicketDTO.oxygenContent',{ rules:[{ required: true, message: '请输入氧含量' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="生产单位负责人"
              decorator-name="taskConfinedSpaceTicketDTO.productionChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="安环负责人"
              decorator-name="taskConfinedSpaceTicketDTO.envChargerId"
              :disabled="disabled"/>
            <a-form-item v-show="false">
              <a-textarea v-decorator="['taskConfinedSpaceTicketDTO.docName',{ rules:[{ required: false}]}]"/>
            </a-form-item>
            <a-form-item v-show="false">
              <a-textarea v-decorator="['taskConfinedSpaceTicketDTO.docUrl',{ rules:[{ required: false}]}]"/>
            </a-form-item>
          </div>
          <!--盲板抽堵作业票-->
          <div v-if="ticketType ==='2'">
            <a-form-item label="设备管道名称">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.pipeName',{ rules:[{ required: true, message: '请输入设备管道名称' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="介质">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.medium',{ rules:[{ required: true, message: '请输入介质' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="温度">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.temperature',{ rules:[{ required: true, message: '请输入温度' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="压力">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.pressure',{ rules:[{ required: true, message: '请输入压力' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="盲板材质">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.materialOfBlindPlate',{ rules:[{ required: true, message: '请输入盲板材质' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="盲板规格">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.blindPlateSpecification',{ rules:[{ required: true, message: '请输入盲板规格' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="盲板编号">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.blindCode',{ rules:[{ required: true, message: '请输入盲板编号' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="抽堵类型">
              <a-select
                v-decorator="['taskBlindWorkTicketDTO.type',{ rules:[{ required: true, message: '请选选择抽堵类型' }]}]"
                :disabled="disabled">
                <a-select-option v-for="item in blindType" :key="item.dictKey">
                  {{ item.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <person-select label-name="监护人" decorator-name="taskBlindWorkTicketDTO.guardianId" :disabled="disabled"/>
            <a-form-item label="作业人">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.workPerson',{ rules:[{ required: true, message: '请输入作业人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="生产单位作业指挥"
              decorator-name="taskBlindWorkTicketDTO.productionGuideId"
              :disabled="disabled"/>
            <a-form-item label="作业单位负责人">
              <a-input
                v-decorator="['taskBlindWorkTicketDTO.workUnitCharger',{ rules:[{ required: true, message: '请输入作业单位负责人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <file-upload
              label="盲板位置图"
              doc-url="taskBlindWorkTicketDTO.blindImgUrl"
              doc-name="taskBlindWorkTicketDTO.blindImgName"
              :form="form"
              :visible="visible"/>
            <person-select
              label-name="生产单位负责人"
              decorator-name="taskBlindWorkTicketDTO.productionChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="设备部负责人"
              decorator-name="taskBlindWorkTicketDTO.facilityChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="安环负责人"
              decorator-name="taskBlindWorkTicketDTO.envChargerId"
              :disabled="disabled"/>
            <file-upload
              label="附件"
              doc-url="taskBlindWorkTicketDTO.docUrl"
              doc-name="taskBlindWorkTicketDTO.docName"
              :form="form"
              :visible="visible"/>
          </div>
          <!--高处作业票-->
          <div v-if="ticketType ==='3'">
            <a-form-item label="作业高度">
              <a-input
                v-decorator="['taskHighWorkTicketDTO.hight',{ rules:[{ required: true, message: '请输入作业高度' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="作业类别">
              <a-select
                v-decorator="['taskHighWorkTicketDTO.type',{ rules:[{ required: true, message: '请选择作业类别' }]}]"
                :disabled="disabled">
                <a-select-option v-for="item in hignCategory" :key="item.dictKey">
                  {{ item.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item label="作业地点">
              <a-input
                v-decorator="['taskHighWorkTicketDTO.location',{ rules:[{ required: true, message: '请输入作业地点' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="作业内容">
              <a-input
                v-decorator="['taskHighWorkTicketDTO.content',{ rules:[{ required: true, message: '请输入作业内容' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <department-select label-name="作业单位" decorator-name="taskHighWorkTicketDTO.unitId" :disabled="disabled"/>
            <person-select label-name="现场监护人" decorator-name="taskHighWorkTicketDTO.chargerId" :disabled="disabled"/>
            <a-form-item label="作业分级">
              <a-select
                v-decorator="['taskHighWorkTicketDTO.level',{ rules:[{ required: true, message: '请选择作业分级' }]}]"
                :disabled="disabled">
                <a-select-option v-for="item in highWorkLevel" :key="item.dictKey">
                  {{ item.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item label="是否附安全工作方案或图纸">
              <a-radio-group v-decorator="['taskHighWorkTicketDTO.workplan']">
                <a-radio :value="0">
                  是
                </a-radio>
                <a-radio :value="1">
                  否
                </a-radio>
              </a-radio-group>
            </a-form-item>
            <a-form-item label="作业开始时间">
              <a-date-picker
                show-time
                v-decorator="['startTime',{ rules:[{ required: true, message: '请输选择作业开始时间' }]}]"
                :disabled="disabled"
                valueFormat="YYYY-MM-DD HH:mm:ss"/>
            </a-form-item>
            <a-form-item label="作业结束时间">
              <a-date-picker
                show-time
                v-decorator="['endTime',{ rules:[{ required: true, message: '请选择作业结束时间' }]}]"
                :disabled="disabled"
                valueFormat="YYYY-MM-DD HH:mm:ss"/>
            </a-form-item>
          </div>
          <!--吊装作业票-->
          <div v-if="ticketType ==='4'">
            <a-form-item label="吊装作业级别">
              <a-select
                v-decorator="['taskHoistingWorkTicketDTO.hoistingLevel',{ rules:[{ required: true, message: '请选择吊装作业级别' }]}]"
                :disabled="disabled">
                <a-select-option v-for="item in hoistingLevel" :key="item.dictKey">
                  {{ item.dictValue }}
                </a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item label="吊装工具名称">
              <a-input
                v-decorator="['taskHoistingWorkTicketDTO.hoistingFacilityName',{ rules:[{ required: true, message: '请输入吊装工具名称' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="吊装人员及特殊工种作业证号">
              <a-input
                v-decorator="['taskHoistingWorkTicketDTO.specialCertificateCode',{ rules:[{ required: true, message: '请输入吊装人员及特殊工种作业证号' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="吊装指挥及特殊工种作业证号">
              <a-input
                v-decorator="['taskHoistingWorkTicketDTO.guideCertificateCode',{ rules:[{ required: true, message: '请输入吊装指挥及特殊工种作业证号' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="生产单位负责人"
              decorator-name="taskHoistingWorkTicketDTO.productionChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="设备部负责人"
              decorator-name="taskHoistingWorkTicketDTO.facilityChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="安环负责人"
              decorator-name="taskHoistingWorkTicketDTO.envChargerId"
              :disabled="disabled"/>
            <file-upload
              label="附件"
              doc-url="taskHoistingWorkTicketDTO.docUrl"
              doc-name="taskHoistingWorkTicketDTO.docName"
              :form="form"
              :visible="visible"/>
          </div>
          <!--临时用电作业票-->
          <div v-if="ticketType ==='5'">
            <a-form-item label="电源接入点">
              <a-input
                v-decorator="['taskElectricityTicketDTO.powerAccessPoint',{ rules:[{ required: true, message: '请输入电源接入点' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="工作电压">
              <a-input
                v-decorator="['taskElectricityTicketDTO.voltage',{ rules:[{ required: true, message: '请输入工作电压' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="用电设备及功率">
              <a-input
                v-decorator="['taskElectricityTicketDTO.facilityAndPower',{ rules:[{ required: true, message: '请输入用电设备及功率' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="作业人">
              <a-input
                v-decorator="['taskElectricityTicketDTO.workPerson',{ rules:[{ required: true, message: '请输入作业人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="电工证号">
              <a-input
                v-decorator="['taskElectricityTicketDTO.electricianCertificateCode',{ rules:[{ required: true, message: '请输入电工证号' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="生产单位负责人"
              decorator-name="taskElectricityTicketDTO.productionChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="设备部负责人"
              decorator-name="taskElectricityTicketDTO.facilityChargerId"
              :disabled="disabled"/>
            <file-upload
              label="附件"
              doc-url="taskElectricityTicketDTO.docUrl"
              doc-name="taskElectricityTicketDTO.docName"
              :form="form"
              :visible="visible"/>
          </div>
          <!--动土作业票-->
          <div v-if="ticketType ==='6'">
            <person-select label-name="监护人" decorator-name="taskSoilWorkTicketDTO.guardianId" :disabled="disabled"/>
            <a-form-item label="作业范围，内容">
              <a-textarea
                :rows="4"
                v-decorator="['taskSoilWorkTicketDTO.description',{ rules:[{ required: true, message: '请输入作业范围，内容' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <file-upload
              label="作业范围附件"
              doc-url="taskSoilWorkTicketDTO.workImgUrl"
              doc-name="taskSoilWorkTicketDTO.workImgName"
              :form="form"
              :visible="visible"/>
            <a-form-item label="编制人">
              <a-input
                v-decorator="['taskSoilWorkTicketDTO.editer',{ rules:[{ required: true, message: '请输入编制人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="生产单位负责人"
              decorator-name="taskSoilWorkTicketDTO.productionChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="设备部负责人"
              decorator-name="taskSoilWorkTicketDTO.facilityChargerId"
              :disabled="disabled"/>
            <person-select label-name="安环负责人" decorator-name="taskSoilWorkTicketDTO.envChargerId" :disabled="disabled"/>
            <file-upload
              label="附件"
              doc-url="taskSoilWorkTicketDTO.docUrl"
              doc-name="taskSoilWorkTicketDTO.docName"
              :form="form"
              :visible="visible"/>
          </div>
          <!--断路作业票-->
          <div v-if="ticketType ==='7'">
            <a-form-item label="涉及相关单位">
              <a-input
                v-decorator="['taskOpenCircuitTicketDTO.relatedUnits',{ rules:[{ required: true, message: '请输入涉及相关单位' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="断路原因">
              <a-input
                v-decorator="['taskOpenCircuitTicketDTO.openCircuitReason',{ rules:[{ required: true, message: '请输入断路原因' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <a-form-item label="断路地段示意图及相关说明">
              <a-textarea
                :rows="4"
                v-decorator="['taskOpenCircuitTicketDTO.description',{ rules:[{ required: true, message: '请输入断路地段示意图及相关说明' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <file-upload
              label="断路地段示意图附件"
              doc-url="taskOpenCircuitTicketDTO.workImgUrl"
              doc-name="taskOpenCircuitTicketDTO.workImgName"
              :form="form"
              :visible="visible"/>
            <a-form-item label="编制人">
              <a-input
                v-decorator="['taskOpenCircuitTicketDTO.editer',{ rules:[{ required: true, message: '请输入编制人' }]}]"
                :disabled="disabled"/>
            </a-form-item>
            <person-select
              label-name="生产单位负责人"
              decorator-name="taskOpenCircuitTicketDTO.productionChargerId"
              :disabled="disabled"/>
            <person-select
              label-name="设备部负责人"
              decorator-name="taskOpenCircuitTicketDTO.facilityChargerId"
              :disabled="disabled"/>
            <file-upload
              label="附件"
              doc-url="taskOpenCircuitTicketDTO.docUrl"
              doc-name="taskOpenCircuitTicketDTO.docName"
              :form="form"
              :visible="visible"/>
          </div>
        </a-row>
      </a-form>
    </a-spin>
  </a-modal>
</template>

<script>
import pick from 'lodash.pick'
import PersonSelect from '@/views/safety/components/PersonSelect'
import AreaSelect from '@/views/safety/components/AreaSelect'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'
import { taskForm, fileUpLoad, task } from '@/api/safety'
import FileUpload from '@/views/safety/components/FileUpload'
import { mapGetters } from 'vuex'
import { STable } from '@/components'
import { otherTaskColumns } from '@/views/safety/table'

const fieldsDict = {
  8: ['ticketType', 'taskContent', 'taskArea', 'lng', 'lat', 'startTime', 'endTime', 'relatedTasks', 'harmIdentification', 'approverId'],
  0: ['ticketCode', 'hotWorkLevel', 'location', 'mode', 'fireStartTime', 'fireEndTime', 'charger', 'firePerson', 'areaChargerId', 'envChargerId'],
  1: ['ticketCode', 'unitId', 'confinedSpaceName', 'sourceMedium', 'charger', 'guardianId', 'workPerson', 'harmMedium', 'combustibleGas', 'oxygenContent', 'productionChargerId', 'envChargerId'],
  2: ['ticketCode', 'pipeName', 'medium', 'temperature', 'pressure', 'materialOfBlindPlate', 'blindPlateSpecification', 'blindCode', 'type', 'workPerson', 'guardianId', 'productionGuideId', 'workUnitCharger', 'blindImgUrl', 'productionChargerId', 'envChargerId', 'facilityChargerId'],
  3: ['ticketCode', 'taskStartTime', 'taskEndTime', 'hight', 'type', 'unitId', 'workPerson', 'guardianId', 'productionChargerId', 'facilityChargerId', 'envChargerId'],
  4: ['ticketCode', 'hoistingLevel', 'hoistingFacilityName', 'specialCertificateCode', 'guideCertificateCode', 'productionChargerId', 'facilityChargerId', 'envChargerId'],
  5: ['ticketCode', 'workPerson', 'voltage', 'powerAccessPoint', 'electricianCertificateCode', 'facilityAndPower', 'productionChargerId', 'facilityChargerId'],
  6: ['ticketCode', 'guardianId', 'description', 'workImgUrl', 'editer', 'productionChargerId', 'facilityChargerId', 'envChargerId'],
  7: ['ticketCode', 'relatedUnits', 'openCircuitReason', 'description', 'workImgUrl', 'editer', 'productionChargerId', 'facilityChargerId']
}
const fields = fieldsDict[8]
const ticketDict = {
  0: 'taskHotWorkTicketDTO',
  1: 'taskConfinedSpaceTicketDTO',
  2: 'taskBlindWorkTicketDTO',
  3: 'taskHighWorkTicketDTO',
  4: 'taskHoistingWorkTicketDTO',
  5: 'taskElectricityTicketDTO',
  6: 'taskSoilWorkTicketDTO',
  7: 'taskOpenCircuitTicketDTO'
}

export default {
  name: 'TicketModal',
  components: {
    AreaSelect,
    PersonSelect,
    DepartmentSelect,
    FileUpload,
    STable
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    loading: {
      type: Boolean,
      default: () => false
    },
    model: {
      type: Object,
      default: {}
    },
    ticketTypeOptions: {
      type: Object,
      default: () => null
    },
    modalTitle: {
      type: String,
      default: '操作'
    },
    disabled: {
      type: Boolean,
      default: false
    },
    mode: {
      type: Boolean,
      default: true
    }
  },
  data () {
    return {
      headers: {
        authorization: 'authorization-text'
      },
      fields: [],
      form: this.$form.createForm(this),
      ticketType: '0',
      dateFormat: 'YYYY-MM-DD HH:mm:ss',
      hotLevel: [], // 动火
      blindType: [], // 盲板
      hignCategory: [], // 高处作业
      hoistingLevel: [], // 吊装作业
      highWorkLevel: [
        {
          dictKey: '一级',
          dictValue: '一级'
        },
        {
          dictKey: '二级',
          dictValue: '二级'
        },
        {
          dictKey: '三级',
          dictValue: '三级'
        },
        {
          dictKey: '特级',
          dictValue: '特级'
        }
      ], // 高处作业分级
      docName: '',
      docUrl: '',
      drawerVisible: false,
      taskModes: [ { label: '焊接' }, { label: '气割' }, { label: '切削、研磨' }, { label: '明火' }, { label: '钻孔' }, { label: '其它' }],
      otherTaskColumns: otherTaskColumns,
      otherTaskData: [],
      otherTaskAddedData: []
    }
  },
  computed: {
    ...mapGetters(['userInfo']),
    otherTaskAddedColumns () {
      const columns = Object.assign([], otherTaskColumns)
       columns.splice(2, 0, {
        title: '作业内容',
        dataIndex: 'taskContent',
        align: 'center'
      })
      return columns
    }
  },
  created () {
    this.selectOptionsInit()
    // 防止表单未注ce
    fields.forEach(v => this.form.getFieldDecorator(v))
    this.form.setFieldsValue({ ticketType: '0' })
    // 当 model 发生改变时，为表单设置值
    this.$watch('model', () => {
      console.log('model changed!', this.model)
      if (Object.keys(this.model).length > 0) {
        const tickTypeId = this.model.taskTicketBaseDetailVO.ticketType
        const basicInfo = {
          approverId: this.model.approverId,
          ...this.model.taskTicketBaseDetailVO
        }
        const ticketInfo = {}
        this.ticketType = String(tickTypeId)
        for (const item of Object.keys(this.model.taskTicketVO)) {
          ticketInfo[ticketDict[tickTypeId] + '.' + item] = this.model.taskTicketVO[item]
        }
        const editData = Object.assign(basicInfo, ticketInfo)
        editData.ticketType = String(editData.ticketType)
        const ticketFields = fieldsDict[this.ticketType].map(item => {
          return ticketDict[tickTypeId] + '.' + item
        })
        this.fields = ticketFields.concat(fieldsDict[8])
        this.fields.forEach(v => this.form.getFieldDecorator(v)) // 表单不固定  动态注册
        this.form.setFieldsValue(pick(editData, this.fields))
      } else {
        this.ticketType = '0'
        this.form.setFieldsValue({ ticketType: this.ticketType })
      }
    })
  },
  methods: {
    selectOptionsInit () {
      taskForm.getTaskHotLevel().then(res => {
        this.hotLevel = res.data
      })
      taskForm.getTaskBlindType().then(res => {
        this.blindType = res.data
      })
      taskForm.getTaskHignCategory().then(res => {
        this.hignCategory = res.data
      })
      taskForm.getTaskHoistingLevel().then(res => {
        this.hoistingLevel = res.data
      })
    },
    previewFile (file) {
      // console.log('Your upload file:', file)
      // Your process logic. Here we just mock to the same file
      return fetch('https://next.json-generator.com/api/json/get/4ytyBoLK8', {
        method: 'POST',
        body: file
      })
        .then(res => res.json())
        .then(({ thumbnail }) => thumbnail)
    },
    handleChange (info) {
      // console.log(info)
      if (info.file.status !== 'uploading') {
        // console.log(info.file, info.fileList)
      }
      if (info.file.status === 'done') {
        this.$message.success(`${info.file.name} file uploaded successfully`)
      } else if (info.file.status === 'error') {
        this.$message.error(`${info.file.name} file upload failed.`)
      }
    },
    ticketFileUpLoad (data) {
      const formData = new FormData()
      formData.append('file', data.file)
      fileUpLoad(formData).then(res => {
        let fileName, fileUrl
        // 盲板
        if (this.ticketType === '2') {
          fileName = ticketDict[this.ticketType] + '.' + 'blindImgName'
          fileUrl = ticketDict[this.ticketType] + '.' + 'blindImgUrl'
        }
        // 动土
        if (this.ticketType === '6') {
          fileName = ticketDict[this.ticketType] + '.' + 'workImgName'
          fileUrl = ticketDict[this.ticketType] + '.' + 'workImgUrl'
        }
        // 断路
        if (this.ticketType === '7') {
          fileName = ticketDict[this.ticketType] + '.' + 'workImgName'
          fileUrl = ticketDict[this.ticketType] + '.' + 'workImgUrl'
        }
        console.log('上传文件返回信息', res.data, fileName, fileName)
        this.form.setFieldsValue({ [fileName]: res.data.originalName, [fileUrl]: res.data.link })
        data.onProgress({ percent: 100 })
        data.onSuccess({ success: true })
      })
    },
    fileUpLoad (data) {
      const formData = new FormData()
      formData.append('file', data.file)
      fileUpLoad(formData).then(res => {
        const fileInfo = {}
        fileInfo[ticketDict[this.ticketType] + '.' + 'docName'] = res.data.originalName
        fileInfo[ticketDict[this.ticketType] + '.' + 'docUrl'] = res.data.link
        this.form.setFieldsValue(fileInfo)
        data.onProgress({ percent: 100 })
        data.onSuccess({ success: true })
      })
    },
    deleteOtherTask (index) {
      this.otherTaskData.splice(index, 1)
    },
    loadData () {
      task.getTaskList({}).then(res => {
        this.otherTaskAddedData = res.data.records
        })
    },
    addOtherTask (item) {
      this.otherTaskData.push(item)
    }
  }
}
</script>
<style lang="less" scoped>
  /deep/ .ant-modal-body {
    height: 700px;
    overflow-y: auto;
    padding-right: 50px;

    .ant-form-item-required {
      word-wrap: break-word;
      word-break: normal;
    }

    span.ant-form-item-children {
      width: 100%;
      display: block;

      .ant-checkbox-group {
        width: 100%;
      }

      .ant-calendar-picker {
        display: block;
        width: 100%;
      }
    }
    .ant-divider-horizontal {
      margin: 3px 0;
    }
    .ant-table {
      height: auto;
    }
  }
</style>
