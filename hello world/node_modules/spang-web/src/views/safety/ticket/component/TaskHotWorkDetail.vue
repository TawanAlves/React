<template>
  <div>
    <div class="text-primary">
      <span>基础信息</span>
      <span class="ticket-no-label">作业票编号: {{ ticketInfo.taskNo || '-' }}</span>
    </div>
    <a-divider/>
    <a-descriptions :column="2" :colon="true">
      <a-descriptions-item label="作业票种类">
        {{ ticketInfo.ticketTypeName || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="动火级别">
        {{ ticketInfo.hotWorkLevel || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="申请人">
        {{ ticketInfo.applyPerson || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="动火地点">
        {{ ticketInfo.location || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="作业方式">
        {{ ticketInfo.mode || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="监火人">
        {{ ticketInfo.charger || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="作业内容">
        {{ ticketInfo.taskContent || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="动火开始时间">
        {{ ticketInfo.startTime || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="是否附安全工作方案或图纸">
        {{ ticketInfo.workplan || '-' }}
      </a-descriptions-item>
      <a-descriptions-item label="动火结束时间">
        {{ ticketInfo.endTime || '-' }}
      </a-descriptions-item>
    </a-descriptions>
    <div class="text-normal">
      <span>涉及的其他特殊行业</span>
    </div>
    <a-table
      ref="table-other-task"
      size="default"
      :columns="otherTaskColumns"
      :data-source="ticketInfo.otherTaskData"
      :pagination="false"
      rowKey="id"
      :scroll="{y:`360px`}"
    >
    </a-table>
    <template v-if="ticketInfo.level >=2">
      <div class="text-primary">
        <span>作业单位</span>
      </div>
      <a-divider/>
      <a-descriptions :column="2" :colon="true">
        <a-descriptions-item label="动火作业单位">
          {{ ticketInfo.applyUnit || '-' }}
        </a-descriptions-item>
        <a-descriptions-item label="动火负责人">
          <person-select
            :decorator-name="ticketInfo.chargePerson"
            :disabled="ticketInfo.level != 2"
            @change="handleChargerChange"
            style="width: 300px;margin-bottom: 0px;"
          />
        </a-descriptions-item>
      </a-descriptions>
      <div class="text-normal">
        <span>动火人</span>
        <a-button type="primary" @click="loadPersonDrawer('hot')" class="ml-10px" v-if="ticketInfo.level === 2">添加</a-button>
      </div>
      <a-table
        ref="hot-person-table"
        size="default"
        :columns="personTableColumns"
        :data-source="ticketInfo.hotPersons"
        :pagination="false"
        rowKey="id"
        :scroll="{y:`360px`}"
      >
        <template slot="operation" slot-scope="text, record, index">
          <a-button type="primary" @click="deletePerson(index, record, 'hot')" style="margin-left: 15px">删除</a-button>
        </template>
      </a-table>
      <div style="margin-top: 10px" class="text-normal">
        <span>其他人员</span>
        <a-button type="primary" @click="loadPersonDrawer('other')" class="ml-10px" v-if="ticketInfo.level === 2">添加</a-button>
      </div>
      <a-table
        ref="hot-person-table"
        size="default"
        :columns="personTableColumns"
        :data-source="ticketInfo.otherPersons"
        :pagination="false"
        rowKey="id"
        :scroll="{y:`360px`}"
      >
        <template slot="operation" slot-scope="text, record, index">
          <a-button type="primary" @click="deletePerson(index, record, 'other')" style="margin-left: 15px">删除</a-button>
        </template>
      </a-table>
      <a-drawer
        :width="720"
        :closable="false"
        :visible="drawerVisible"
        @close="drawerVisible = false"
      >
        <a-form layout="inline" :model="formInline" @submit="handleSearch" @submit.native.prevent>
          <a-form-item>
            <a-input v-model="formInline.name" placeholder="姓名">
            </a-input>
          </a-form-item>
          <a-form-item>
            <a-select v-model="formInline.unit" placeholder="预处理车间" style="width: 100px">
              <a-select-option v-for="item in unitOptions" :key="item.id" :value="item.id">
                {{ item.label }}
              </a-select-option>
            </a-select>
          </a-form-item>
          <a-form-item>
            <a-button
              type="primary"
              html-type="submit"
            >
              查询
            </a-button>
            <a-button type="success" @click="resetQuery" style="margin-left: 10px;">重置</a-button>
          </a-form-item>
        </a-form>
        <a-table
          ref="table-other-task-add"
          size="default"
          :columns="personTableColumns"
          :data-source="personDatas"
          :pagination="false"
          rowKey="id"
        >
          <template slot="operation" slot-scope="text, record, index">
            <a-button type="primary" @click="addPerson(record)">添加</a-button>
          </template>
        </a-table>
      </a-drawer>
    </template>
    <template v-if="ticketInfo.level >=3">
      <div class="text-primary">
        <span>现场信息详情</span>
      </div>
      <a-divider/>
      <div class="evenly-btn-group">
        <a-button type="primary" @click="showDetail('RiskDetail')">风险辨识详情</a-button>
        <a-button type="primary" @click="showDetail('LaboratoryAnalysisDetail')">化验分析详情</a-button>
        <a-button type="primary" @click="showDetail('SafetyClarificaitonDetail')">安全交底详情</a-button>
      </div>
      <a-drawer
        :width="720"
        :closable="false"
        :visible="detailDrawerVisible"
        @close="detailDrawerVisible = false"
      >
        <component :is="detailComponent" :ticket-no="ticketInfo.taskNo"></component>
      </a-drawer>
    </template>
    <template v-if="ticketInfo.level >=4">
      <div class="text-primary">
        <span>作业信息</span>
      </div>
      <a-divider/>
      <a-descriptions :column="2" :colon="true" class=" mt-10px">
        <a-descriptions-item label="作业开始时间">
          {{ ticketInfo.startTime || '-' }}
        </a-descriptions-item>
        <a-descriptions-item label="所在单位监护人">
          {{ ticketInfo.guardian || '-' }}
        </a-descriptions-item>
        <a-descriptions-item label="验票人">
          {{ ticketInfo.ticketChecker || '-' }}
        </a-descriptions-item>
        <a-descriptions-item label="作业单位负责人">
          {{ ticketInfo.charger || '-' }}
        </a-descriptions-item>
      </a-descriptions>
    </template>
  </div>

</template>

<script>
import { otherTaskColumns, personTableColumns } from '@/views/safety/table'
import PersonSelect from '@/views/safety/components/PersonSelect'
import { changeTaskCharger, getTaskPersons, addTaskPerson, deleteTaskPerson, getUnits } from '@/api/safety'
import RiskDetail from './RiskDetail'
import SafetyClarificaitonDetail from './SafetyClarificaitonDetail'
import LaboratoryAnalysisDetail from './LaboratoryAnalysisDetail'
export default {
  name: 'TaskHotWorkDetail',
  components: { PersonSelect, RiskDetail, SafetyClarificaitonDetail, LaboratoryAnalysisDetail },
  props: {
    ticketInfo: {
      type: Object,
      default: () => {
      }
    }
  },
  data () {
    return {
      drawerVisible: false,
      personSelectMode: 'hot',
      personDatas: [],
      detailDrawerVisible: false, // 现场信息详情右抽屉
      detailComponent: null,
      formInline: {
        name: null,
        unit: null
      },
      unitOptions: []
    }
  },
  computed: {
    otherTaskColumns () {
      return otherTaskColumns.slice(0, otherTaskColumns.length - 1)
    },
    personTableColumns () {
      if (this.ticketInfo.level !== 2) {
        return personTableColumns.slice(0, personTableColumns.length - 1)
      }
      return personTableColumns
    }
  },
  methods: {
    handleChargerChange (personId) {
      // TODO 待前后端联调
      const params = {
        personId,
        ticketNO: this.ticketInfo.taskNo
      }
      changeTaskCharger(params).then(() => {
        this.$notification.info({
          message: '提示',
          description: '修改成功'
        })
      })
    },
    getPersonDrawerData () {
      const params = {
        mode: this.personSelectMode,
        ...this.formInline
      }
      getTaskPersons(params).then(({ data }) => {
        // TODO 测试数据 待删除
        data = [
          {
            personName: '朱炜',
            deptName: '什么部门',
            certificateNumber: 'DH-ZQ-20210603-001',
            validTime: '2021.02.02 10:20~2021.02.02 11:30',
            id: '1'
          }
        ]
        // 测试数据结束
        this.personDatas = data
      })
    },
    loadPersonDrawer (mode) {
      this.personSelectMode = mode
      this.drawerVisible = true
      this.getPersonDrawerData()
    },
    addPerson (person) {
      if (this.personSelectMode === 'hot') {
        if (!this.ticketInfo.hotPersons) {
          this.$set(this.ticketInfo, 'hotPersons', [])
        }
        this.ticketInfo.hotPersons.push(person)
      } else {
        if (!this.ticketInfo.otherPersons) {
          this.$set(this.ticketInfo, 'otherPersons', [])
        }
        this.ticketInfo.otherPersons.push(person)
      }
      const params = { mode: this.personSelectMode, ...person }
      addTaskPerson(params).then(() => {
      })
    },
    deletePerson (index, record, mode) {
      if (mode === 'hot') {
        this.ticketInfo.hotPersons.splice(index, 1)
      } else {
        this.ticketInfo.otherPersons.splice(index, 1)
      }
      const params = { mode: this.personSelectMode, personId: record.id, ticketNO: this.ticketInfo.taskNo }
      deleteTaskPerson(params).then(() => {
        this.$notification.info({
            message: '提示',
            description: '删除成功'
          })
      })
    },
    showDetail (type) {
      this.detailDrawerVisible = true
      this.detailComponent = type
    },
    getUnitOptions () {
      getUnits().then(({ data }) => {
        // TODO 测试数据
        data = [
          {
            id: '1',
            value: 1,
            label: '制氢车间'
          },
          {
            id: '2',
            value: 2,
            label: '公用车间'
          }
        ]
        // 测试数据
        this.unitOptions = data
      })
    },
    handleSearch () {
      this.getPersonDrawerData()
    },
    resetQuery () {
      this.formInline = {
        name: null,
        unit: null
      }
    }

  },
  created () {
    this.getUnitOptions()
  }
}
</script>

<style lang="less" scoped>
  /deep/ .ant-divider-horizontal {
    margin: 3px 0;
  }

  /deep/ .ant-descriptions {
    .ant-descriptions-item-label {
      font-size: 14px;
    }

    .ant-descriptions-item-content {
      font-size: 14px;
      font-weight: normal;
    }
  }

  .ticket-no-label {
    display: inline-block;
    float: right;
  }

  .text-primary {
    margin-top: 0.5em;

    span {
      margin-bottom: 0.5em;
      font-weight: 500;

      &.ticket-no-label {
        color: rgba(0, 0, 0, 0.85);
      }
    }
  }

  /deep/ .ant-table {
    height: auto;
    margin-top: 10px;

    .ant-empty-normal {
      margin: 2px 0;
    }
  }

  .ml-10px {
    margin-left: 10px;
  }

  .text-normal {
    color: rgba(0, 0, 0, 0.85);
    font-size: 14px;
  }
  .evenly-btn-group {
    justify-content: space-evenly;
    display: flex;
    margin-top: 10px;
  }
  .mt-10px {
    margin-top: 10px;
  }
</style>
