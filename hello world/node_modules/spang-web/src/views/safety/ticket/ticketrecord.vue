<template>
  <page-container :title="false">
    <a-card :bordered="false">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :md="6">
              <person-select label-name="申请人" decorator-name="applyPersonId"/>
            </a-col>
            <a-col :md="5">
              <a-form-item label="申请单位">
                <a-tree-select
                  v-model="queryParam.applyUnitId"
                  style="width: 100%;"
                  :dropdownStyle="{ maxHeight:'35vh', overflow: 'auto'}"
                  :tree-data="treeData"
                  placeholder="请选择单位"
                />
              </a-form-item>
              <!--              <department-select label-name="申请单位" v-model="queryParam.applyUnitId"/>-->
            </a-col>
            <a-col :md="4">
              <a-form-item label="作业类别">
                <a-select v-model="queryParam.ticketType">
                  <a-select-option v-for="d in ticketTypeOptions" :key="d.dictKey">
                    {{ d.dictValue }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :md="6">
              <a-form-item label="作业时间">
                <a-range-picker v-model="queryParam.time" valueFormat="YYYY-MM-DD HH:mm:ss"/>
              </a-form-item>
            </a-col>
            <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="ticketRecordResearch">查询</a-button>
                <a-button type="second" @click="ticketRecordRefresh" style="margin-left: 10px">重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <div class="table-operator" v-if="false">
        <a-button type="primary" icon="plus" @click="ticketRecordAdd">新增</a-button>
        <a-button icon="delete" :disabled="!hasSelected" @click="ticketRecordRemove">删除</a-button>
      </div>
      <s-table
        ref="ticketRecordTable"
        size="default"
        :scroll="{x:1000, y: `calc(100vh - 360px)`}"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="false"
        showPagination="true"
      >
        <span slot="serial" slot-scope="text, record, index">
          {{ index + 1 }}
        </span>
        <span slot="processStatus" slot-scope="text, record">
          <a-tag color="green">{{ text }}</a-tag>
        </span>
        <span slot="time" slot-scope="text, record">
          {{ record.startTime }}&nbsp;至&nbsp;{{ record.endTime }}
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="ticketRecordCheck(record)">查看</a>
            <!--            <a-config-provider :auto-insert-space-in-button="false" style="margin-left: 4px;margin-right: 4px">-->
            <!--              <a-button type="primary" size="small" @click="ticketRecordCheck(record)"><a-icon type="file-search"/> 查看</a-button>-->
            <!--            </a-config-provider>-->
          </template>
        </span>
      </s-table>
      <detail-modal
        ref="detailModal"
        :visible="detailVisible"
        :basic-info="detailBasicInfo"
        :ticket-info="detailTicketInfo"
        @cancel="detailCancel"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { ticketRecordColumns } from '@/views/safety/table'
import DetailModal from '@/views/safety/ticket/component/DetailModal'
import { getTaskRecordList, detailTaskList, getTaskType, getPersonnelTree } from '@/api/safety'
import PersonSelect from '@/views/safety/components/PersonSelect'
import DepartmentSelect from '@/views/safety/components/DepartmentSelect'

export default {
  components: {
    STable,
    DetailModal,
    PersonSelect,
    DepartmentSelect
  },
  data () {
    return {
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return getTaskRecordList(requestParameters).then(res => {
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      // select options
      ticketTypeOptions: [],
      treeData: [],
      // detail modal
      detailVisible: false,
      detailBasicInfo: {},
      detailTicketInfo: {}
    }
  },
  created () {
    this.getSelectOptions()
  },
  computed: {
    columns: () => ticketRecordColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    getSelectOptions () {
      getTaskType().then(res => {
        this.ticketTypeOptions = res.data
      })
      getPersonnelTree(0).then(res => {
        this.treeData = res.data
      })
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    ticketRecordResearch () {
      this.$refs.ticketRecordTable.refresh(true)
      this.$refs.ticketRecordTable.clearSelected()
    },
    ticketRecordRefresh () {
      this.queryParam = {}
      this.$refs.ticketRecordTable.refresh(true)
      this.$refs.ticketRecordTable.clearSelected()
    },
    ticketRecordAdd () {
      this.$message.success('新增')
    },
    ticketRecordRemove () {
      this.$message.success('删除')
    },
    ticketRecordCheck (record) {
      const requestParams = {
        id: record.id,
        type: record.ticketTypeNum,
        taskId: record.taskId || ''
      }
      detailTaskList(requestParams).then(res => {
        this.detailBasicInfo = { ...res.data.taskTicketBaseDetailVO }
        this.detailTicketInfo = { ...res.data.taskTicketVO }
        this.detailVisible = true
      })
    },
    ticketRecordEdit (record) {
      this.$message.success('编辑')
    },
    fileDownload () {
      this.$message.success('导出当前文件')
    },
    filesDownload () {
      this.$message.success('导出所有文件')
    },
    fileUpload () {
      this.$message.success('上传文件')
    },
    detailCancel () {
      this.detailVisible = false
      this.detailBasicInfo = {}
      this.detailTicketInfo = {}
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: calc(100vh - 240px);
}
/deep/ .ant-card-body {
  .ant-table-wrapper {
    min-height: calc(100vh - 175px)
  }
}
</style>
