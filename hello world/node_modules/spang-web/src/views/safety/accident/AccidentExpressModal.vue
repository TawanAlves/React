<template xmlns:a-col="http://www.w3.org/1999/html">
  <a-modal
    :maskClosable="false"
    :title="modalTitle"
    :visible="visible"
    :confirmLoading="loading"
    :body-style="{'padding-bottom': '0','padding-top': '0'}"
    :footer="null"
    @ok="() => { $emit('ok') }"
    @cancel="() => { $emit('update:visible', false) }"
    ok-text="确定"
    cancel-text="取消"
    width="50%"
    :keyboard="false"
  >
    <a-spin :spinning="loading">
      <a-row :gutter="24">
        <a-col :span="8">
          <div class="flowchart">
            <a-card :bordered="false" size="small" class="left-card">
              <template slot="title">
                <a-tag color="#108ee9" style="font-size: 15px;border-radius: 16px;padding:2px 12px">
                  事故快报
                </a-tag>
              </template>
              <template slot="extra">
                <a-button type="primary" shape="round" size="small" @click="addExpress">追加快报</a-button>
              </template>
              <a-timeline :reverse="false">
                <a-timeline-item v-for="(item,index) in timelineData" :key="index">
<!--                  <a-icon slot="dot" type="clock-circle-o" style="font-size: 20px;" />-->
                  <div style="margin-left: 10px;" @click="viewDetail(item, index)" class="timeline-item" :class="index === itemIndex?'timeline-item-checked': ''">
                    <a-row :gutter="24">
                      <a-col>
                        <span style="font-size: 16px;line-height: 16px">{{ item.title }}</span>
                      </a-col>
                    </a-row>
                    <a-row :gutter="24">
                      <a-col>
                        <span>{{ item.currentPollTime }}</span>
                      </a-col>
                    </a-row>
                  </div>
                </a-timeline-item>
              </a-timeline>
            </a-card>
          </div>
        </a-col>
        <a-col :span="16">
          <a-card :bordered="false" :body-style="{'padding-left': '0px'}">
            <div v-if="isAdd">
              <a-form :form="form" :label-col="{ span: 4 }" :wrapper-col="{ span: 20 }">
                <a-form-item label="标题">
                  <a-input
                    v-decorator="['title',{ rules:[{ required: true, message: '请输入标题' }]}]"
                    maxLength="32"
                  />
                </a-form-item>
                <div style="margin-bottom: 10px;margin-right: 10px">
                  <a-row type="flex" justify="end" :gutter="[8,32]">
                    <a-col style="text-align: right;padding: 0">
                      <span>{{expressTitle}}</span>
                    </a-col>
                  </a-row>
                </div>
                <div style="margin-bottom: 10px">
                  <a-row type="flex" justify="end" :gutter="[8,32]">
                    <a-col style="text-align: right">
                      <span>{{userName}}</span>
                    </a-col>
                    <a-col  style="text-align: right;">
                      <span>{{publishTime}}</span>
                    </a-col>
                  </a-row>
                </div>
                <a-form-item label="追加内容">
                  <a-textarea
                    :autoSize="{minRows: 10}"
                    maxLength="256"
                    v-decorator="['appendedContent',{ rules:[{ required: true, message: '请输入追加内容' }]}]"
                  ></a-textarea>
                </a-form-item>
                <div>
                  <a-row type="flex" justify="end" :gutter="[24,40]">
                    <a-col>
                      <a-button type="primary" shape="round"  @click="publishExpress">发布</a-button>
                    </a-col>
                  </a-row>
                </div>
              </a-form>
            </div>
            <div v-if="!isAdd">
              <a-form :form="form" :label-col="{ span: 4 }" :wrapper-col="{ span: 20 }">
                <a-form-item label="标题">
                  <a-input
                    :disabled="true"
                    v-model="publishTitle"
                  />
                </a-form-item>
                <div style="margin-bottom: 10px;margin-right: 10px">
                  <a-row type="flex" justify="end" :gutter="[8,32]">
                    <a-col style="text-align: right;padding: 0">
                      <span>{{expressTitle}}</span>
                    </a-col>
                  </a-row>
                </div>
                <div style="margin-bottom: 10px">
                  <a-row type="flex" justify="end" :gutter="[8,32]">
                    <a-col style="text-align: right">
                      <span>{{userName}}</span>
                    </a-col>
                    <a-col  style="text-align: right;">
                      <span>{{publishTime}}</span>
                    </a-col>
                  </a-row>
                </div>
                <a-form-item label="追加内容">
                  <a-textarea
                    :disabled="true"
                    v-model="publishContent"
                  ></a-textarea>
                </a-form-item>
              </a-form>
            </div>
          </a-card>
        </a-col>
      </a-row>
    </a-spin>
  </a-modal>
</template>

<script>
import { dateUtil } from '@/utils/dateUtil'
import { getStore } from '@/utils/store'
import AccidentApi from '@/api/accident'

export default {
  name: 'AccidentExpressModal',
  data () {
    return {
      timelineData: [],
      isAdd: true,
      userName: '',
      publishTime: '',
      publishTitle: '',
      publishContent: '',
      userInfo: getStore({ name: 'info' }),
      detailData: {},
      itemIndex: 0,
      loading: false,
      form: this.$form.createForm(this)
    }
  },
  props: {
    visible: {
      type: Boolean,
      required: true
    },
    modalTitle: {
      type: String,
      default: '快报跟踪'
    },
    mainId: {
      type: String,
      required: true
    },
    expressTitle: {
      type: String,
      required: true
    }
  },
  created () {
  },
  watch: {
    visible: {
      handler:function (val) {
        if(val) {
          this.initData()
          this.loadTimelineData()
        }
      },
    }
  },
  methods: {
    initData() {
      this.publishTitle = ''
      this.publishContent = ''
      this.itemIndex = 0
      this.isAdd = true
      this.detailData = {}
      const time = new Date().getTime()
      this.publishTime = dateUtil.formatDateTime(time, true)
      this.userName = this.userInfo.realName
    },
    addExpress() {
      this.isAdd = true
      if(this.isAdd) {
        this.itemIndex = -1
        this.publishTitle = ''
        this.publishContent = ''
        const time = new Date().getTime()
        this.publishTime = dateUtil.formatDateTime(time, true)
        this.userName = this.userInfo.realName
      } else {
        this.itemIndex = 0
        this.loadItemData(this.timelineData[this.itemIndex].id)
      }
    },
    publishExpress() {
      this.form.validateFields((errors, values) => {
        if(!errors) {
          const params = {
            // appendedContent: this.publishContent,
            currentPollTime: this.publishTime,
            currentUserId: this.userInfo.id,
            currentUserName: this.userName,
            // title: this.publishTitle,
            mainId: this.mainId,
            originalTitle: this.expressTitle,
            ...values
          }
          this.submitForm(AccidentApi.accidentExpressDetail, params, 'post').then(({ success }) => {
            if(success) {
              this.loadTimelineData()
              this.itemIndex = 0
              this.isAdd = false
              this.$message.success('操作成功')
            }
          })
        }
      })
    },
    viewDetail (item, index) {
      this.itemIndex = index
      this.loadItemData(item.id)
    },
    loadTimelineData () {
      this.getList(AccidentApi.accidentExpressDetailList,{mainId:this.mainId}).then(res => {
        this.timelineData = res.data
        if(this.timelineData.length) {
          this.loadItemData(this.timelineData[0].id)
        }
      })
    },
    loadItemData (id) {
      this.loading = true
      this.getById(AccidentApi.accidentExpressDetail,id).then(({ data }) => {
        this.detailData = data
        this.expressTitle = data.originalTitle
        this.publishTitle = data.title
        this.publishTime = data.currentPollTime
        this.publishContent = data.appendedContent
        this.userName = data.currentUserName
        this.isAdd = false
        this.loading = false
      })
    }
  }
}
</script>

<style lang="less" scoped>
.flowchart {
  //overflow-y: auto;
  //height: 500px;
  padding-top: 10px;
  border-right: 1px solid #e8e8e8;
  padding-right: 20px;
  .timeline {
    margin-top: 60px;
    margin-left: 50%;

    .chartCard {
      width: 200px;
      border-color: #0BB7AF;
      border-radius: 5px;
    }
  }
}

.left-card {
  /deep/.ant-card-head {
   border-bottom: none!important;
  }
  /deep/.ant-card-body {
    height: 500px;
    margin-top: 10px!important;
    overflow-y: auto;
    &::-webkit-scrollbar{
      width: 8px;
      height: 1px;
    }
    &::-webkit-scrollbar-thumb {
      border-radius: 5px;
      //background: @primary-color;
      background-color: #d0d0d0;
    }
    &::-webkit-scrollbar-track {
      -webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0);
      border-radius: 3px;
      //background: @primary-3;
      //background-color: #001529;
    }
  }
}

.timeline-item {
  padding-left: 10px;
  &:hover {
    cursor: pointer;
    //border-right: 4px solid #00A0E9;
    //background-color: #00a8ff;
    //color: #FFFFFF;
    //border-radius: 5px;
  }
  &:checked {
    background-color: #00a8ff;
    color: #FFFFFF;
    border-radius: 5px;
  }
}
.timeline-item-checked {
  //background-color: #00a8ff;
  //color: #FFFFFF;
  //border-radius: 5px;
  //border-left: 4px solid #00A0E9;
  font-weight: bold;
}
</style>