<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="事故名称">
                <a-input v-model="queryParam.accidentName" placeholder="事故名称"/>
              </a-form-item>
            </a-col>
            <a-col  :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="发生时间">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
            <a-col  :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="状态">
                <a-select
                  show-search
                  v-model="queryParam.isProcess"
                  style="width: 100%"
                  :filter-option="filterOption"
                  option-filter-prop="children"
                  placeholder="状态"
                >
                  <a-select-option v-for="d in eventTypeOptions" :key="d.dictKey">{{ d.dictValue }}</a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 395px)`, x: 1450}"
        showPagination="true"
      >
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="addRecord(record)" v-if="record.isProcess === 1">处理</a>
            <!--            <a-divider type="vertical" v-if="record.status !== 0"/>-->
            <a @click="viewRecord(record)" v-if="record.isProcess === 0">处理结果</a>
          </template>
        </span>
        <template slot="isProcess" slot-scope="text, record">
          <a-tag
            :color="record.isProcess | colorFilter"
            style="margin-right: 0!important;"
          >{{record.isProcess | textFilter}}</a-tag>
        </template>
        <template slot="viewAccident" slot-scope="text, record">
          <a @click="viewAccident(record)">查看事故</a>
        </template>
      </s-table>
      <common-form-modal
        ref="modal"
        :customFooter="true"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        width="750px"
      >
        <template slot="footer">
          <a-button type="second" @click="() => {this.commonVisible = false}">取消</a-button>
          <a-button type="primary" @click="modalOk(1)" v-if="!commonDisabled">暂存</a-button>
          <a-button type="primary" @click="modalOk(0)" v-if="!commonDisabled">处理</a-button>
        </template>
      </common-form-modal>
      <accident-archive-detail-modal
        :records="detailData"
        :visible="modalVisible"
        @cancel="()=>{this.modalVisible = false}"
      />
    </a-card>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import DescriptionsModal from '@/views/safety/components/DescriptionsModal'
import AccidentApi from '@/api/accident'
import { accidentProcessColumns } from '@/views/safety/accident/columns'
import { getStore } from '@/utils/store'
import { getDict } from '@/api/system'
import AccidentArchiveDetailModal from '@/views/safety/accident/AccidentArchiveDetailModal'

export default {
  name: 'accidentProcess',
  components: {
    STable,
    CommonFormModal,
    DescriptionsModal,
    AccidentArchiveDetailModal
  },
  data() {
    return {
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      isApprove: false,
      currentRecordId: null,
      queryParam: {
        accidentName: '',
        status: '',
        occurrenceBgTime: '',
        occurrenceEndTime: ''
      },
      searchTime: '',
      selectedRowKeys: [],
      selectedRows: [],
      eventTypeOptions: [
        {
          dictKey: 0,
          dictValue: '已处理'
        },
        {
          dictKey: 1,
          dictValue: '待处理'
        }
      ],
      accidentTypeOptions: [],
      accidentLevelOptions: [],
      userInfo: getStore({ name: 'info' }),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(AccidentApi.accidentProcessList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      rules: [
        {
          type: 'select',
          title: '事故级别',
          field: 'accidentLevelId',
          props: {
            placeholder: '请选择事故级别'
          },
          options: [],
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          on: {
            change: e => {
              this.commonData.accidentLevelName = this.accidentLevelOptions[e - 1].label
            }
          },
          validate: {
            required: true,
            message: '请选择事故级别'
          }
        },
        {
          type: 'input',
          title: '事故损失',
          field: 'accidentLoss',
          props: {
            type: '',
            maxLength: 32,
            placeholder: '请输入事故损失'
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: {
            required: true,
            message: '请输入事故损失'
          }
        },
        {
          type: 'input',
          title: '人员损伤情况',
          field: 'peopleDamage',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          options: [],
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: {
            required: true,
            message: '请输入人员损伤情况'
          }
        },
        {
          type: 'input',
          title: '直接原因',
          field: 'directCause',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: [
            {
              required: true,
              message: '请输入直接原因',
              trigger: true
            }
          ]
        },
        {
          type: 'input',
          title: '间接原因',
          field: 'indirectCause',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: [
            {
              required: true,
              message: '请输入间接原因',
              trigger: true
            }
          ]
        },
        {
          type: 'input',
          title: '事故责任分析',
          field: 'accidentAnalysis',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: [
            {
              required: true,
              message: '请输入事故责任分析',
              trigger: true
            }
          ]
        },
        {
          type: 'input',
          title: '事故处理情况',
          field: 'accidentProcess',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: [
            {
              required: true,
              message: '请输入事故处理情况',
              trigger: true
            }
          ]
        },
        {
          type: 'input',
          title: '职工受教育情况',
          field: 'staffEducation',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: [
            {
              required: true,
              message: '请输入职工受教育情况',
              trigger: true
            }
          ]
        },
        {
          type: 'input',
          title: '事故教训及防范措施',
          field: 'preventiveMeasures',
          props: {
            maxLength: 256,
            type: 'textarea',
            autoSize: { minRows: 4, maxRows: 6 }
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 19, offset: 0 }
          },
          validate: [
            {
              required: true,
              message: '请输入事故教训及防范措施',
              trigger: true
            }
          ]
        },
        {
          type: 'UploadFile',
          field: 'files',
          title: '事故报告',
          props: {
            fileNumber: 1,
            fileList: [],
            fileNumberError: '已超过文件上传限制，最多可上传一个文件'
          },
          wrap: {
            labelCol: { span: 5 },
            wrapperCol: { span: 18 }
          }
        }
      ],
      detailData: {},
      modalVisible: false
    }
  },
  created() {
    getDict('ACCIDENTS_RANK').then(({ data, success }) => {
      if (success) {
        this.accidentLevelOptions = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
        this.rules[0].options = this.accidentLevelOptions
      }
    })
    getDict('ACCIDENTS_TYPE').then(({ data, success }) => {
      if (success) {
        this.accidentTypeOptions = data.map(item => {
          return {
            value: item.dictKey,
            label: item.dictValue
          }
        })
      }
    })
  },
  computed: {
    columns: () => accidentProcessColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['green', 'orange']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['已处理', '待处理']
      return textList[value]
    }
  },
  methods: {
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    onTimeChange(value, dateString) {
      this.queryParam.occurrenceBgTime = dateString[0]
      this.queryParam.occurrenceEndTime = dateString[1]
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam() {
      this.queryParam = {
        accidentName: '',
        isProcess: '',
        occurrenceBgTime: '',
        occurrenceEndTime: ''
      }
      this.searchTime = ''
    },
    commonInit() {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      this.initFormData()
    },
    initFormData() {
      this.commonData = {
        accidentLevelId: undefined,
        accidentAnalysis: null,
        files: [],
        accidentLoss: null,
        accidentProcess: null,
        directCause: null,
        indirectCause: null,
        peopleDamage: null,
        preventiveMeasures: null,
        staffEducation: null
      }
      this.setFileList([])
    },
    addRecord(record) {
      this.commonTitle = '事故处理'
      this.currentRecordId = record.id
      // this.initFormData()
      // this.commonDisabled = false
      // this.commonVisible = true
      this.getById(AccidentApi.accidentProcess, record.id).then(({ data, success }) => {
        if (success) {
          if (data.id === -1) {
            this.initFormData()
          } else {
            data.accidentLevelId = data.accidentLevelId + ''
            this.commonData = data
            const files = data.files.map(item => ({
              uid: item.id,
              name: item.fileName,
              status: 'done',
              id: item.id,
              filePath: item.fileUrlPath
            }))
            this.setFileList(files)
          }
          this.commonDisabled = false
          this.commonVisible = true
        }
      })
    },
    modalOk(status) {
      console.log(this.$refs.modal.fApi)
      this.$refs.modal.fApi.submit((formData, fApi) => {
        let method = ''
        if (this.isNotNullOrUndefined(this.commonData.id)) {
          method = 'put'
          formData.id = this.commonData.id
        } else {
          method = 'post'
        }
        const params = {
          ...this.commonData,
          ...formData,
          status: status,
          mainId: this.currentRecordId,
          files: this.$refs.modal.fApi.getRule('files').props.fileList.map(item => ({
            id: item.id,
            fileUrlPath: item.filePath,
            originalFileName: item.name
          }))
        }
        this.submitForm(AccidentApi.accidentProcess, params, method).then(({ success }) => {
          if (success) {
            this.$message.success('操作成功')
            this.initQueryParam()
            this.commonInit()
            this.$refs.table.refresh()
            this.$refs.table.clearSelected()
          }
        })
      })
    },
    setFileList(fileList) {
      if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
        this.$refs.modal.fApi.getRule('files').props.fileList = fileList
      } else {
        this.rules[9].props.fileList = fileList
      }
    },
    viewRecord(record) {
      this.commonTitle = '处理结果'
      this.commonDisabled = true
      this.getById(AccidentApi.accidentProcess, record.id).then(({ data, success }) => {
        if (success) {
          data.accidentLevelId = data.accidentLevelId + ''
          this.commonData = data
          const files = data.files.map(item => ({
            uid: item.id,
            name: item.fileName,
            status: 'done',
            id: item.id,
            filePath: item.fileUrlPath
          }))
          this.setFileList(files)
          this.commonVisible = true
        }
      })
    },
    viewAccident(record) {
      this.getById(AccidentApi.accidentReport, record.id).then(({ data, success }) => {
        if (success) {
          this.detailData = {
            accidentReportVO: data
          }
          this.modalVisible = true
        }
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  //padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 77px;
}
</style>
