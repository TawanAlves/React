<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="事故名称">
                <a-input v-model="queryParam.accidentName" maxlength="32" placeholder="事故名称"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="发生时间">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="发生地点">
                <a-input v-model="queryParam.occurrenceAddress" maxlength="32" placeholder="发生地点"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <span>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <template #extra>
        <a-button
          type="primary"
          icon="plus"
          @click="addRecord"
          v-if="permission.accident_express_add"
        >新建</a-button>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 432px)`, x: 1410}"
        showPagination="true"
      >
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <span slot="action" slot-scope="text, record">
          <template v-if="record.status !== 1">
            <a
              @click="editRecord(record)"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_edit"
            >编辑</a>
            <a-divider
              type="vertical"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_edit"
            />
            <a
              @click="publishRecord(record, 1)"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_publish"
            >发布</a>
            <a-divider
              type="vertical"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_publish"
            />
            <a
              @click="removeRecord(record)"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_delete"
            >删除</a>
          </template>
          <template v-if="record.status === 1">
            <a @click="viewRecord(record)">查看</a>
            <a-divider
              type="vertical"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_follow"
            />
            <a
              @click="followRecord(record)"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_follow"
            >快报跟踪</a>
            <a-divider
              type="vertical"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_delete"
            />
            <a
              @click="removeRecord(record)"
              v-if="userInfo.id === record.gmtCreateId || permission.accident_express_delete"
            >删除</a>
          </template>
        </span>
        <template slot="status" slot-scope="text, record">
          <a-tag
            :color="record.status?'green':'orange'"
            style="margin-right: 0!important;"
          >{{record.status?'已发布':'未发布'}}</a-tag>
        </template>
      </s-table>
      <common-form-modal
        ref="modal"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        width="700px"
        @ok="modalOk"
      />
      <descriptions-modal :visible.sync="detailVisible" :records="detailDatas" title="事故快报" />
      <accident-express-modal
        :visible.sync="followVisible"
        :main-id="followItemId"
        :express-title="title"
      />
    </a-card>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import DescriptionsModal from '@/views/safety/components/DescriptionsModal'
import AccidentExpressModal from '@/views/safety/accident/AccidentExpressModal'
import AccidentApi from '@/api/accident'
import { accidentExpressColumns } from '@/views/safety/accident/columns'
import { getStore } from '@/utils/store'
import { mapGetters } from 'vuex'

export default {
  name: 'accidentReport',
  components: {
    STable,
    CommonFormModal,
    DescriptionsModal,
    AccidentExpressModal
  },
  data() {
    return {
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {
        accident: '',
        occurrenceAddress: '',
        occurrenceBgTime: '',
        occurrenceEndTime: ''
      },
      selectedRowKeys: [],
      selectedRows: [],
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(AccidentApi.accidentExpressList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      detailVisible: false,
      detailDatas: [],
      rules: [
        {
          type: 'input',
          title: '事故名称',
          field: 'accidentName',
          props: {
            maxLength: '32',
            type: 'text',
            placeholder: '请输入事故名称'
          },
          validate: [
            {
              required: true,
              message: '请输入事故名称',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 3 },
            wrapperCol: { span: 21 }
          }
        },
        {
          type: 'DatePicker',
          title: '发生时间',
          field: 'occurrenceTime',
          props: {
            showTime: true,
            format: 'YYYY-MM-DD HH:mm:ss',
            placeholder: '发生时间'
          },
          col: {
            span: 12
          },
          validate: [
            {
              required: true,
              message: '请选择事故发生时间'
            }
          ]
        },
        {
          type: 'input',
          title: '发生地点',
          field: 'occurrenceAddress',
          props: {
            maxLength: '32',
            type: 'text',
            placeholder: '请选择发生地点'
          },
          col: {
            span: 12
          },
          validate: [
            {
              required: true,
              message: '请选择发生地点',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 6 },
            wrapperCol: { span: 18 }
          }
        },
        {
          type: 'textarea',
          title: '事故简报',
          field: 'accidentReport',
          props: {
            placeholder: '请输入事故简述',
            maxLength: '256',
            autoSize: {
              minRows: 4,
              maxRows: 7
            }
            // rows: 4
          },
          validate: [
            {
              required: true,
              message: '请输入事故简述',
              trigger: 'blur'
            }
          ],
          wrap: {
            labelCol: { span: 3 },
            wrapperCol: { span: 21 }
          }
        }
      ],
      userInfo: getStore({ name: 'info' }),
      followVisible: false,
      followItemId: '',
      searchTime: '',
      title: ''
    }
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => accidentExpressColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    onTimeChange(value, dateString) {
      this.queryParam.occurrenceBgTime = dateString[0]
      this.queryParam.occurrenceEndTime = dateString[1]
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam() {
      this.queryParam = {
        accident: '',
        occurrenceAddress: '',
        occurrenceBgTime: '',
        occurrenceEndTime: ''
      }
      this.searchTime = ''
    },
    commonInit() {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      this.initFormData()
    },
    initFormData() {
      this.commonData = {
        accidentName: null,
        occurrenceTime: null,
        occurrenceAddress: null,
        accidentReport: null
      }
    },
    addRecord() {
      this.commonTitle = '新增数据'
      this.initFormData()
      this.commonDisabled = false
      this.commonVisible = true
    },
    modalOk({ formData }) {
      let method = ''
      if (this.isNotNullOrUndefined(this.commonData.id)) {
        method = 'put'
        formData.id = this.commonData.id
        formData.status = this.commonData.status
      } else {
        method = 'post'
        formData.status = 0
      }
      const params = {
        ...formData,
        reportUserId: this.userInfo.id,
        reportUserName: this.userInfo.realName,
        reportTime: new Date().getTime()
      }
      this.submitForm(AccidentApi.accidentExpress, params, method).then(res => {
        this.initQueryParam()
        this.commonInit()
        this.$refs.table.refresh()
        this.$refs.table.clearSelected()
      })
    },
    publishRecord(record, status) {
      const url = `${AccidentApi.accidentExpressUpdate}?id=${record.id}&status=${status}`
      this.submitForm(url, null, 'put').then(res => {
        this.$message.success(`操作成功`)
        this.$refs.table.refresh()
        this.$refs.table.clearSelected()
      })
    },
    editRecord(record) {
      this.commonTitle = '编辑数据'
      this.getById(AccidentApi.accidentExpress, record.id).then(({ data, success }) => {
        if (success) {
          this.commonData = data
          this.commonDisabled = false
          this.commonVisible = true
        }
      })
    },
    viewRecord(record) {
      this.getById(AccidentApi.accidentExpress, record.id).then(({ data, success }) => {
        if (success) {
          this.detailDatas = [
            {
              label: '事故名称',
              value: data.accidentName
            },
            {
              label: '发生时间',
              value: data.occurrenceTime
            },
            {
              label: '发生地点',
              value: data.occurrenceAddress
            },
            {
              label: '事故简述',
              value: data.accidentReport
            },
            {
              label: '上报人',
              value: data.reportUserName
            },
            {
              label: '上报时间',
              value: data.reportTime
            }
          ]
          this.commonData = data
          this.commonTitle = '查看数据'
          this.commonDisabled = true
          this.commonVisible = true
          // this.detailVisible = true
        }
      })
    },
    followRecord(record) {
      this.followItemId = record.id
      this.title = record.accidentName
      this.followVisible = true
    },
    removeRecord(record) {
      this.showDeleteConfirm([record.id])
    },
    showDeleteConfirm(params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.deleteByIds(AccidentApi.accidentExpress, params).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.selectedRows = []
              _this.selectedRowKeys = []
              _this.$refs.table.refresh()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}

/deep/.ant-calendar-picker {
  width: 100%;
}
</style>