<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px" :body-style="{'padding-bottom': '0px'}">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="事故名称">
                <a-input v-model="queryParam.accidentName" placeholder="事故名称" />
              </a-form-item>
            </a-col>
            <a-col  :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="发生时间">
                <a-range-picker
                  style="width: 100%; min-width: 110px;"
                  :show-time="{ format: 'HH:mm:ss' }"
                  format="YYYY-MM-DD HH:mm:ss"
                  :placeholder="['开始时间', '结束时间']"
                  v-model="searchTime"
                  @change="onTimeChange"
                />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="发生地点">
                <a-input v-model="queryParam.occurrenceAddress"  placeholder="发生地点"/>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="search">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px;"
      :headStyle="{border: 'none', paddingBottom: 0}"
      :bodyStyle="{paddingBottom: 0}"
      class="table-card"
    >
      <s-table
        ref="table"
        size="default"
        :filterMultiple="false"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :scroll="{y:`calc(100vh - 395px)`, x: 1130}"
        showPagination="true"
      >
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="downloadRecord(record)">下载</a>
            <a-divider type="vertical" />
            <a @click="viewRecord(record)">查看</a>
          </template>
        </span>
        <template slot="isProcess" slot-scope="text, record">
          <a-tag
            :color="record.isProcess | colorFilter"
            style="margin-right: 0!important;"
          >{{record.isProcess | textFilter}}</a-tag>
        </template>
        <template slot="files" slot-scope="text, record">
          <a @click="downloadFile(record)">下载报告</a>
        </template>
      </s-table>
      <accident-archive-detail-modal
        :records="detailData"
        :visible="modalVisible"
        title="查看数据"
        @cancel="()=>{this.modalVisible = false}"
      />
    </a-card>
  </page-container>
</template>

<script>
import { STable } from '@/components'
import AccidentApi from '@/api/accident'
import { accidentArchiveColumns } from '@/views/safety/accident/columns'
import { getStore } from '@/utils/store'
import AccidentArchiveDetailModal from '@/views/safety/accident/AccidentArchiveDetailModal'
import { downloadFile } from '@/api/common'

export default {
  name: 'accidentArchive',
  components: {
    STable,
    AccidentArchiveDetailModal
  },
  data() {
    return {
      currentRecordId: null,
      queryParam: {
        accidentName: '',
        occurrenceAddress: '',
        occurrenceBgTime: '',
        occurrenceEndTime: ''
      },
      searchTime: '',
      selectedRowKeys: [],
      selectedRows: [],
      userInfo: getStore({ name: 'info' }),
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(AccidentApi.accidentArchiveList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      rules: [],
      detailData: [],
      modalVisible: false
    }
  },
  computed: {
    columns: () => accidentArchiveColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['green', 'orange']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['已处理', '待处理']
      return textList[value]
    }
  },
  methods: {
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    onTimeChange(value, dateString) {
      this.queryParam.occurrenceBgTime = dateString[0]
      this.queryParam.occurrenceEndTime = dateString[1]
    },
    search() {
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    searchReset() {
      this.initQueryParam()
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    initQueryParam() {
      this.queryParam = {
        accidentName: '',
        status: '',
        occurrenceBgTime: '',
        occurrenceEndTime: ''
      }
      this.searchTime = ''
    },
    viewRecord(record) {
      this.getById(AccidentApi.accidentArchive, record.id).then(({ data, success }) => {
        if (success) {
          this.detailData = data
          this.modalVisible = true
        }
      })
    },
    downloadRecord(record) {
      this.getById(AccidentApi.accidentArchive, record.id).then(({ data, success }) => {
        if (success) {
          const files = data.accidentProcessVO.files
          if (files.length === 0) {
            this.$message.success('暂无上传事故报告')
          } else {
            const file = files[0]
            downloadFile(file.id, file.fileName)
          }
        }
      })
    }
  }
}
</script>

<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  //padding-top: 0;
  padding-bottom: 15px;
}

.card-title {
  display: flex;
  justify-content: space-between;
}

/deep/.ant-calendar-picker {
  width: 100%;
}
</style>
