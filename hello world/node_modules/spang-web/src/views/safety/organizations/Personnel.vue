<template>
  <div>
    <a-row :gutter="12" style="margin-top: 2px">
      <a-col :span="4" style="padding-right: 1px!important;">
        <a-card
          :bordered="false"
          :body-style="{'padding-bottom': '0px', paddingTop: 0, 'border-right': '1px solid #e8e8e8'}"
        >
          <a-tree
            class="left-tree"
            :expandAction="dblclick"
            :tree-data="treeData"
            :expanded-keys="expandedKeys"
            :auto-expand-parent="autoExpandParent"
            @expand="onExpand"
            @select="OnSelect"
          />
        </a-card>
      </a-col>
      <a-col :span="20" style="padding-left: 1px!important;">
        <a-card :bordered="false" :body-style="{'padding-bottom': '0px', paddingTop: 0}">
          <div class="table-page-search-wrapper" style="margin-bottom: 10px;">
            <a-form layout="inline">
              <a-row :gutter="24">
                <a-col :md="12" :sm="24" :xs="24">
                  <a-form-item label="姓名">
                    <a-input v-model="queryParam.realName" placeholder="姓名"/>
                  </a-form-item>
                </a-col>
                <a-col :md="12" :sm="24" :xs="24" class="table-page-search-submitButtons">
                  <a-space>
                    <a-button
                      type="primary"
                      style="margin-right: 4px;"
                      @click="personnelResearch()"
                    >查询</a-button>
                    <a-button @click="personnelRefresh()">重置</a-button>
                  </a-space>
                </a-col>
              </a-row>
            </a-form>
          </div>
          <s-table
            ref="personnelTable"
            size="default"
            :scroll="{y:`calc(100vh - 390px)`, x: 1070}"
            :rowKey="record => record.id"
            :columns="columns"
            :data="loadData"
            :alert="false"
            :rowSelection="false"
            showPagination="true"
            :pagination="pagination"
          >
            <span
              slot="serial"
              slot-scope="text, record, index"
            >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
            <span slot="action" slot-scope="text, record">
              <template>
                <a @click="personnelCheck(record)" disabled="false">详情</a>
              </template>
            </span>
          </s-table>
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script>
import { STable } from '@/components'
import { personnelColumns } from '@/views/safety/table'
import STree from '@/components/Tree/Tree'
import { getPersonnelTree, getPersonnelUser } from '@/api/safety'

export default {
  name: 'Personnel',
  components: {
    STable,
    STree
  },
  data() {
    return {
      pagination: {
        pageSize: 10,
        current: 1,
        showSizeChanger: true
      },
      treeData: [],
      expandedKeys: [],
      autoExpandParent: true,
      queryParam: {},
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return getPersonnelUser(requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = { ...this.pagination, pageSize: data.pageSize, current: data.pageNo }
          return data
        })
      },
      selectedRowKeys: [],
      selectedRows: []
    }
  },
  created() {
    this.getTreeData()
  },
  computed: {
    columns: () => personnelColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    onLoadData(treeNode) {
      return new Promise(resolve => {
        console.log(treeNode)
        getPersonnelTree(treeNode.value).then(res => {
          console.log(res)
          if (treeNode.dataRef.children) {
            resolve()
            return
          }
          const children = res.data.map(item => {
            return {
              ...item,
              isLeaf: !item.hasChildren
            }
          })
          treeNode.dataRef.children = children
          this.treeData = [...this.treeData]
        })
        resolve()
      })
    },
    OnSelect(selectedKeys, info) {
      this.queryParam.deptId = selectedKeys[0]
      this.$refs.personnelTable.refresh(true)
    },
    getTreeData() {
      getPersonnelTree(0).then(res => {
        this.treeData = res.data
        this.expandedKeys.push(this.treeData[0].key)
      })
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    personnelCheck(record) {},
    personnelResearch() {
      this.$refs.personnelTable.refresh(true)
    },
    personnelRefresh() {
      this.queryParam = {}
      this.$refs.personnelTable.refresh(true)
    },
    onExpand(expandedKeys) {
      console.log('onExpand', expandedKeys)
      // if not set autoExpandParent to false, if children expanded, parent can not collapse.
      // or, you can remove all expanded children keys.
      this.expandedKeys = expandedKeys
      this.autoExpandParent = false
    }
  }
}
</script>
<style lang="less" scoped>
.right-header {
  font-size: 16px;
  font-weight: 550;
}

.table-header {
  font-size: 20px;
  font-weight: 550;
  //line-height: 30px;
  //margin-bottom: 10px;
}

.ant-table-thead > tr > th {
  //color: #00A0E9;
  font-size: 16px;
  font-weight: bold;
  //align-items: center;
  //background-color: #e6f7ff;
}
</style>
<style lang="less" scoped>
/deep/.ant-table {
  height: auto;
}

.left-tree {
  height: calc(100vh - 214px);
  overflow-y: auto;
  &::-webkit-scrollbar {
    width: 5px;
    height: 1px;
  }
  &::-webkit-scrollbar-thumb {
    border-radius: 3px;
    //background: @primary-color;
    background-color: #fff;
  }
  &::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 1px rgba(0, 0, 0, 0);
    border-radius: 3px;
    //background: @primary-3;
    //background-color: #077ae8;
  }
}
</style>
