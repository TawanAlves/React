<template>
  <div>
    <a-row :gutter="12" style="margin-top:2px">
      <a-col :span="4" style="padding-right: 1px!important;">
        <a-card :bordered="false" :body-style="{paddingRight: '5px'}">
          <a-tree
            class="left-tree"
            :tree-data="treeData"
            :replaceFields="{children:'childDirectory', title:'areaName', key:'id', value: 'id' }"
            :expanded-keys="expandedKeys"
            :auto-expand-parent="autoExpandParent"
            @expand="onExpand"
            @select="OnSelect"/>
        </a-card>
      </a-col>
      <a-col :span="20" style="padding-left: 1px!important;">
        <a-card :bordered="false">
          <!-- <a-card
          :bordered="false"
          :tab-list="tabList"
          :active-tab-key="tabKey"
          @tabChange="key => tabChange(key, 'tabKey')"
          style="min-height: 980px"> -->
          <!-- <div v-if="tabKey === 'dangerResource'"> -->
          <div class="table-operator">
            <a-form layout="inline">
              <a-row >
                <!-- <a-col> -->
                <!-- <a-row type="flex" justify="center"> -->
                <a-col :span="5">
                  <a-form-item label="关键字">
                    <a-input v-model="queryParam.dangsrcName"/>
                  </a-form-item>
                </a-col>
                <a-col :span="4">
                  <a-button type="primary" style="margin-top: 3px" @click="$refs.table.refresh(true)">查询</a-button>
                  <a-button type="second" style="margin-left: 10px" @click="searchReset">重置</a-button>
                </a-col>
                <!-- </a-row> -->
                <!-- </a-col> -->
                <a-col :offset="18">
                  <a-button type="primary" icon="plus" @click="addRecord">添加危险源</a-button>
                  <!--            <a-button type="primary" icon="edit" @click="dangerEdits">编辑</a-button>-->
                  <!--            <a-button type="primary" icon="unordered-list" :disabled="!hasSelected">批量操作</a-button>-->
                  <a-button type="second" icon="delete" :disabled="!hasSelected" @click="removeRecord">删除</a-button>
                  <!-- <a-button type="primary" icon="download" @click="filesDownload">导出</a-button>
                    <a-button type="primary" icon="upload" @click="fileUpload">导入</a-button> -->
                </a-col>
              </a-row>
            </a-form>
          </div>
          <s-table
            ref="table"
            size="middle"
            rowKey="id"
            :scroll="{ x: 860, y: 'calc(100vh - 360px)' }"
            :columns="columns"
            :data="loadData"
            :alert="false"
            :rowSelection="rowSelection"
            showPagination="true"
          >
            <span slot="customTitle">R值
              <a-popover placement="bottomLeft">
                <img alt="" slot="content" src="../../../../static/rValue.svg" width="650" height="300"/>
                <a-icon size="small" type="question-circle" style="font-size: 12px"/>
              </a-popover>
            </span>
            <span slot="action" slot-scope="text, record">
              <template>
                <a @click="dangerCheck(record)">查看</a>
                <a-divider type="vertical"/>
                <a @click="editRecord(record)">编辑</a>
              </template>
            </span>
          </s-table>
          <danger-modal
            ref="modal"
            :visible="commonVisible"
            :loading="confirmLoading"
            :model="commonData"
            :modal-title="commonTitle"
            :disabled="commonDisabled"
            @cancel="modalCancel"
            @ok="modalOk"
          />
          <!-- </div>
          <div v-else-if="tabKey ==='person'">人员管理</div> -->
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script>
import { STable } from '@/components'
import { dangerColumns } from '@/views/safety/table'
import DangerModal from '@/views/safety/organizations/component/DangerModal'
import { getDangerList, getRegionTree, getRegionTreeChild } from '@/api/safety'

export default {
  name: 'DangerSource',
  components: {
    STable,
    DangerModal
  },
  data () {
    return {
      // modal props
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      confirmLoading: false,
      selectedRowKeys: [],
      selectedRows: [],
      queryParam: {},
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return getDangerList(requestParameters).then(res => {
          console.log(res.data)
          return {
            totalCount: res.data.total,
            totalPage: res.data.pages,
            pageNo: res.data.current,
            pageSize: res.data.size,
            data: res.data.records
          }
        })
      },
      treeData: [],
      expandedKeys: [],
      autoExpandParent: true,
      tabList: [
        {
          key: 'dangerResource',
          tab: '危险源管理'
        },
        {
          key: 'person',
          tab: '人员管理'
        }
      ],
      tabKey: 'dangerResource'
    }
  },
  created () {
    this.treeOptionsInit()
  },
  computed: {
    columns: () => dangerColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    treeOptionsInit () {
      getRegionTree().then(res => {
        this.treeData = res.data
        this.expandedKeys = this.treeData.map(item => {
          return item.id
        })
        // const result = res.data
        // this.treeData = result.map(item => {
        //   return {
        //     id: item.id,
        //     title: item.areaName,
        //     key: item.id,
        //     hasChildren: item.hasChild,
        //     value: item.id
        //   }
        // })
        // console.log(this.treeData)
      })
    },
    onLoadData (treeNode) {
      return new Promise(resolve => {
        console.log(treeNode)
        getRegionTreeChild({ pid: treeNode.value }).then(res => {
          if (treeNode.dataRef.children) {
            resolve()
            return
          }
          const children = res.data.map(item => {
            return ({
              id: item.id,
              title: item.areaName,
              key: item.id,
              hasChildren: item.hasChild,
              value: item.id,
              isLeaf: !item.hasChild
            })
          })
          treeNode.dataRef.children = children
          this.treeData = [...this.treeData]
        })
        resolve()
      })
    },
    OnSelect (selectedKeys, info) {
      console.log(selectedKeys[0])
      this.queryParam.areaId = selectedKeys[0]
      this.$refs.table.refresh(true)
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    commonInit () {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.commonMode = true
      this.confirmLoading = false
      const form = this.$refs.modal.form
      form.resetFields()
    },
    searchReset () {
      this.queryParam = {}
      this.$refs.table.refresh(true)
    },
    addRecord () {
      // this.$message.success('新增')
      this.commonTitle = '新增数据'
      this.commonVisible = true
    },
    removeRecord () {
      this.$message.success('删除')
    },
    filesDownload () {
      this.$message.success('导出文件')
    },
    fileUpload () {
      this.$message.success('上传文件')
    },
    dangerCheck (record) {
      // this.$message.success('查看')
      this.commonTitle = '查看数据'
      this.commonData = { ...record }
      this.commonVisible = true
      this.commonDisabled = true
    },
    editRecord (record) {
      // this.$message.success('编辑')
      this.commonTitle = '编辑数据'
      this.commonData = { ...record }
      console.log(this.commonData)
      this.commonVisible = true
    },
    modalCancel () {
      this.commonInit()
    },
    modalOk () {
      this.confirmLoading = true
      setTimeout(() => {
        this.commonInit()
      }, 2000)
    },
    tabChange (key, type) {
      // this.$message.success(`${ type }`)
      this[type] = key
    },
    onExpand (expandedKeys) {
      console.log('onExpand', expandedKeys)
      // if not set autoExpandParent to false, if children expanded, parent can not collapse.
      // or, you can remove all expanded children keys.
      this.expandedKeys = expandedKeys
      this.autoExpandParent = false
    }
  }
}
</script>
<style lang="less" scoped>
.ant-input[disabled] {
  color: #333333;
}
.ant-input-number-input[disabled] {
  color: #333333;
}
.ant-select-disabled {
  color: #333333;
}

/deep/.ant-table {
  height: calc(100vh - 290px)!important;
}
/deep/ .ant-tree {
  height: calc(100vh - 175px) !important;
}
/deep/ .ant-card-body {
  min-height: calc(100vh - 125px)
}
.left-tree {
  height: calc(100vh - 175px);
  overflow-y: auto;
  &::-webkit-scrollbar{
    width: 5px;
    height: 1px;
  }
  &::-webkit-scrollbar-thumb {
    border-radius: 3px;
    //background: @primary-color;
    background-color: #dddee0;
  }
  &::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0);
    border-radius: 3px;
    //background: @primary-3;
    //background-color: #077ae8;
  }
}
</style>
