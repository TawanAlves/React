<template>
  <div>
    <a-row :gutter="12" style="margin-top:2px">
      <a-col :span="4">
        <a-card style="height: 800px" :bordered="false">
          <a-tree
            :load-data="onLoadData"
            :tree-data="treeData"
            @select="OnSelect"/>
        </a-card>
      </a-col>
      <a-col :span="20">
        <a-card :bordered="false" style="min-height: 800px">
          <div class="table-operator">
            <a-form layout="inline">
              <a-row type="flex" justify="space-between">
                <a-col>
                  <a-row type="flex" justify="center">
                    <a-col :span="20">
                      <a-form-item label="名称">
                        <a-input/>
                      </a-form-item>
                    </a-col>
                    <a-col :span="2">
                      <a-button type="primary" style="margin-top: 3px">搜索</a-button>
                    </a-col>
                  </a-row>
                </a-col>
                <a-col>
                  <a-button type="primary" icon="plus" @click="regionAdd">添加机构信息</a-button>
                  <!--            <a-button type="primary" icon="edit" @click="regionEdits">编辑</a-button>-->
                  <!--                  <a-button type="primary" icon="unordered-list" :disabled="!hasSelected">批量操作</a-button>-->
                  <!--                  <a-button type="primary" icon="download" @click="filesDownload">导出</a-button>-->
                  <!--                  <a-button type="primary" icon="upload" @click="fileUpload">导入</a-button>-->
                </a-col>
              </a-row>
            </a-form>
          </div>
          <s-table
            ref="regionTable"
            size="default"
            rowKey="rowKey"
            :columns="columns"
            :data="loadData"
            :alert="false"
            :rowSelection="rowSelection"
            showPagination="auto"
          >
            <span slot="action" slot-scope="text, record">
              <template>
                <a @click="regionCheck(record)" disabled="true">详情</a>
              </template>
            </span>
          </s-table>
        </a-card>
      </a-col>
    </a-row>
  </div>
</template>

<script>
import { STable } from '@/components'
import { regionColumns } from '@/views/safety/table'
import { getRegionTree, getRegionTreeChild, getRegionList } from '@/api/safety'

export default {
  name: 'Region',
  components: {
    STable
  },
  data () {
    return {
      treeData: [],
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return getRegionList(requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          return data
        })
      },
      queryParam: {}
    }
  },
  created () {
    this.treeOptionsInit()
  },
  computed: {
    columns: () => regionColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    treeOptionsInit () {
      getRegionTree().then(res => {
        const result = res.data
        this.treeData = result.map(item => {
          return {
            id: item.id,
            title: item.areaName,
            key: item.id,
            hasChildren: item.hasChild,
            value: item.id
          }
        })
        console.log(this.treeData)
      })
    },
    onLoadData (treeNode) {
      return new Promise(resolve => {
        console.log(treeNode)
        getRegionTreeChild({ pid: treeNode.value }).then(res => {
          if (treeNode.dataRef.children) {
            resolve()
            return
          }
          const children = res.data.map(item => {
            return ({
              id: item.id,
              title: item.areaName,
              key: item.id,
              hasChildren: item.hasChild,
              value: item.id,
              isLeaf: !item.hasChild
            })
          })
          treeNode.dataRef.children = children
          this.treeData = [...this.treeData]
        })
        resolve()
      })
    },
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    OnSelect (selectedKeys, info) {
      console.log(selectedKeys[0])
      this.queryParam.id = selectedKeys[0]
      this.$refs.regionTable.refresh(true)
    },
    regionAdd () {
      this.$message.success('新增')
    },
    regionEdits () {
      this.$message.success('编辑')
    },
    regionCheck (record) {
      this.$message.success('查看')
    }
  }
}
</script>
