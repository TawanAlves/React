<template>
  <page-container :title="false">
    <a-card :bordered="false" style="margin: 15px"  :bodyStyle="{ paddingBottom: 0 }">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="文件有效性">
                <a-select
                  show-search
                  v-model="queryParam.documentValidId"
                  placeholder="文件有效性"
                  style="width: 100%"
                >
                  <a-select-option v-for="d in documentValidNameOptions" :key="d.dictKey">
                    {{
                    d.dictValue
                    }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="文件名称">
                <a-input v-model="queryParam.documentName" placeholder="文件名称" />
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="8" :sm="12" :xs="24">
              <a-form-item label="文件类别">
                <a-select
                  show-search
                  v-model="queryParam.documentTypeId"
                  placeholder="文件类别"
                  style="width: 100%"
                >
                  <a-select-option v-for="d in documentTypeNameOptions" :key="d.dictKey">
                    {{
                    d.dictValue
                    }}
                  </a-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :lg="6" :md="24" :sm="12" :xs="24" class="table-page-search-submitButtons">
              <a-space>
                <a-button type="primary" @click="$refs.table.refresh(true)">查询</a-button>
                <a-button type="second" @click="searchReset">重置</a-button>
              </a-space>
            </a-col>
          </a-row>
        </a-form>
      </div>
    </a-card>
    <a-card
      :bordered="false"
      style="margin: 15px"
      :headStyle="{ border: 'none', paddingBottom: 0 }"
      :bodyStyle="{ paddingBottom: 0 }"
      class="table-card"
    >
      <template #title>
        <div class="text-right">
          <a-button
            type="primary"
            icon="plus"
            v-if="permission.rules_add"
            @click="addRecord"
            style="float: right"
          >新建</a-button>
        </div>
      </template>
      <s-table
        ref="table"
        size="default"
        :rowKey="(record) => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        showPagination="true"
        :scroll="{ y: `calc(100vh - 432px)`, x: 1410 }"
      >
        <!-- 序号 -->
        <span
          slot="number"
          slot-scope="text, record, index"
        >{{ pagination.pageSize * (pagination.current - 1) + index + 1 }}</span>
        <!-- 序号 end -->
        <template slot="status" slot-scope="text, record">
          <a-tag :color="record.status | colorFilter" style="margin-right: 0 !important">
            {{
            record.status | textFilter
            }}
          </a-tag>
        </template>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="editRecord(record)" v-if="record.status !== 1  && permission.rules_edit">编辑</a>
            <a-divider type="vertical" v-if="record.status !== 1  && permission.rules_edit" />
            <a
              @click="publishRecord(record, 1)"
              v-if="record.status !== 1  && permission.rules_publish"
            >发布</a>
            <a-divider type="vertical" v-if="record.status !== 1  && permission.rules_publish" />
            <a @click="viewRecord(record)" v-if="record.status === 1">查看</a>
            <a-divider type="vertical" v-if="record.status !== 0" />
            <a @click="downLoad(record.id)" v-if="permission.rules_down">下载</a>
            <a-divider type="vertical" v-if="permission.rules_down" />
            <a
              @click="publishRecord(record, 0)"
              v-if="record.status === 1  && permission.rules_recall"
            >撤回</a>
            <a
              @click="removeRecord(record)"
              v-if="record.status !== 1  && permission.rules_remove"
            >删除</a>
          </template>
        </span>
      </s-table>
      <common-form-modal
        ref="modal"
        :visible.sync="commonVisible"
        :loading="confirmLoading"
        :model="commonData"
        :modal-title="commonTitle"
        :disabled="commonDisabled"
        :rule="rules"
        width="900px"
        @ok="modalOk"
      />
    </a-card>
  </page-container>
</template>
<script>
import { STable } from '@/components'
import { rulesColumns } from '@/views/safety/table'
import ApiURLs from '@/api/urls'
import { mapGetters } from 'vuex'
import { getStore } from '@/utils/store'
import CommonFormModal from '@/components/CommonFormModal/CommonFormModal'
import { getDict } from '@/api/system'

export default {
  name: 'rules',
  components: {
    STable,
    CommonFormModal
  },
  data() {
    return {
      pagination: {
        current: 1,
        pageSize: 10,
        showSizeChanger: true
      },
      documentValidNameOptions: [],
      documentTypeNameOptions: [],
      confirmLoading: false,
      commonTitle: '',
      commonVisible: false,
      commonData: {},
      commonDisabled: false,
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        const requestParameters = { current: parameter.pageNo, size: parameter.pageSize }
        Object.assign(requestParameters, this.queryParam)
        return this.getList(ApiURLs.rulesList, requestParameters).then(res => {
          const data = {}
          data.totalCount = res.data.total
          data.totalPage = res.data.pages
          data.pageNo = res.data.current
          data.pageSize = res.data.size
          data.data = res.data.records
          this.pagination = {
            current: data.pageNo,
            pageSize: data.pageSize,
            showSizeChanger: true
          }
          return data
        })
      },
      userInfo: getStore({ name: 'info' }),
      rules: [
        {
          type: 'a-row',
          native: true,
          children: [
            {
              type: 'a-col',
              props: {
                span: 24
              },
              children: [
                {
                  type: 'input',
                  title: '文件编号',
                  field: 'documentCode',
                  props: {
                    maxLength: '32',
                    type: 'text',
                    placeholder: '请输入文件编号'
                  },
                  validate: [
                    {
                      required: true,
                      message: '请输入文件编号',
                      trigger: 'blur'
                    }
                  ],
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  }
                },
                {
                  type: 'input',
                  title: '文件名称',
                  field: 'documentName',
                  props: {
                    maxLength: '32',
                    type: 'text',
                    placeholder: '请输入文件名称'
                  },
                  validate: [
                    {
                      required: true,
                      message: '请输入文件名称',
                      trigger: 'blur'
                    }
                  ],
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  }
                },
                {
                  type: 'select',
                  field: 'documentTypeId',
                  title: '文件类别',
                  options: [],
                  validate: [
                    {
                      required: true,
                      message: '请选择文件类别',
                      trigger: 'blur'
                    }
                  ],
                  props: {
                    placeholder: '请选择文件类别'
                  },
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  },
                  on: {
                    change: id => {
                      const options = this.$refs.modal.fApi.getRule('documentTypeId').options
                      this.$set(this.commonData, 'documentTypeName', options.find(item => item.value === id).label)
                    }
                  }
                },
                {
                  type: 'input',
                  title: '发布机构',
                  field: 'releaseOrgName',
                  props: {
                    maxLength: '32',
                    type: 'text',
                    placeholder: '请输入发布机构'
                  },
                  validate: [
                    {
                      required: true,
                      message: '请输入发布机构',
                      trigger: 'blur'
                    }
                  ],
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  }
                },
                {
                  type: 'DatePicker',
                  title: '发布日期',
                  field: 'releaseDate',
                  props: {
                    showTime: true,
                    format: 'YYYY-MM-DD',
                    placeholder: '发布日期'
                  },

                  validate: [
                    {
                      required: true,
                      message: '请选择发布日期',
                      trigger: 'blur'
                    }
                    // {
                    //   validator: (rule, value, callback) => {
                    //     if (new Date(value).getTime() > new Date().getTime()) {
                    //       callback(new Error('颁布日期不能晚于当前时间'))
                    //     } else {
                    //       callback()
                    //     }
                    //   },
                    //   trigger: 'changed'
                    // }
                  ],
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  }
                },
                {
                  type: 'select',
                  field: 'documentValidId',
                  title: '文件有效性',
                  options: [],
                  validate: [
                    {
                      required: true,
                      message: '请选择文件有效性',
                      trigger: 'blur'
                    }
                  ],
                  props: {
                    placeholder: '请选择文件有效性'
                  },
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  },
                  on: {
                    change: id => {
                      const options = this.$refs.modal.fApi.getRule('documentValidId').options
                      this.$set(this.commonData, 'documentValidType', options.find(item => item.value === id).label)
                    }
                  }
                },
                {
                  type: 'input',
                  title: '标签',
                  field: 'notes',
                  props: {
                    maxLength: '32',
                    type: 'text',
                    placeholder: '请输入标签'
                  },
                  validate: [
                    {
                      required: true,
                      message: '请输入标签',
                      trigger: 'blur'
                    }
                  ],
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  }
                },
                {
                  type: 'UploadFile',
                  field: 'files',
                  title: '附件',
                  props: {
                    fileList: []
                  },
                  wrap: {
                    labelCol: { span: 4 },
                    wrapperCol: { span: 18 }
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  },
  computed: {
    ...mapGetters(['permission']),
    columns: () => rulesColumns,
    hasSelected() {
      return this.selectedRowKeys.length > 0
    },
    rowSelection() {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  filters: {
    colorFilter: function(value) {
      const colorList = ['orange', 'green']
      return colorList[value]
    },
    textFilter: function(value) {
      const textList = ['未发布', '已发布']
      return textList[value]
    }
  },
  methods: {
    initFormData() {
      this.commonData = {
        documentCode: '',
        documentName: '',
        documentTypeId: '',
        documentTypeName: '',
        documentValidId: '',
        documentValidType: '',
        files: [],
        id: '',
        notes: '',
        releaseDate: '',
        releaseOrgId: this.userInfo.deptId,
        releaseOrgName: this.userInfo.deptName,
        status: ''
      }
      this.setFileList([])
    },
    setFileList(fileList) {
      if (this.$refs.modal && this.$refs.modal.fApi.getRule) {
        this.$refs.modal.fApi.getRule('files').props.fileList = fileList
      } else {
        this.rules[0].children[0].children[7].props.fileList = fileList
      }
      console.log(this.rules[0].children[0].children[7])
    },
    commonInit() {
      this.commonVisible = false
      this.commonDisabled = false
      this.commonTitle = ''
      this.confirmLoading = false
      this.initFormData()
    },
    onSelectChange(selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    searchReset() {
      this.queryParam = {}
      this.$refs.table.refresh(true)
      this.$refs.table.clearSelected()
    },
    addRecord() {
      this.commonTitle = '新增数据'
      this.initFormData()
      this.commonVisible = true
      this.commonDisabled = false
    },
    removeRecords() {
      const ids = this.selectedRows.map(item => item.id)
      this.showDeleteConfirm(ids)
    },
    getRecord(id, callback) {
      this.getById(ApiURLs.rules, id).then(({ data, success }) => {
        if (success) {
          data.documentTypeId = data.documentTypeName
          data.documentValidId = data.documentValidType
          this.commonData = data
          const files = data.files.map(item => ({
            uid: item.id,
            name: item.fileName,
            status: 'done',
            id: item.id,
            filePath: item.fileUrlPath
          }))
          this.setFileList(files)
          callback()
        }
      })
    },
    //下载
    downLoad(id) {
      this.getById(ApiURLs.rules, id).then(({ data, success }) => {
        if (success) {
          var url = data.files[0].id
          let params = {
            id: url
          }
          this.axios
            .get('/spang-safety/fileserver/downLoadFileById', {
              params: params,
              responseType: 'blob'
            })
            .then(res => {
              let blob = new Blob([res], { type: 'application/octet-stream' })
              let url = window.URL.createObjectURL(res)
              let a = document.createElement('a')
              document.body.appendChild(a)
              a.href = url
              a.download = data.files[0].fileName
              a.click()
              window.URL.revokeObjectURL(url)
            })
        }
      })
    },
    viewRecord(record) {
      this.commonTitle = '查看数据'
      this.initFormData()
      this.getRecord(record.id, () => {
        this.commonDisabled = true
        this.commonVisible = true
      })
    },
    editRecord(record) {
      this.commonTitle = '编辑数据'
      this.initFormData()

      this.getRecord(record.id, () => {
        this.commonDisabled = false
        this.commonVisible = true
      })
    },
    removeRecord(record) {
      this.showDeleteConfirm([record.id])
    },
    modalCancel() {
      this.commonInit()
    },
    modalOk({ formData }) {
      let method = ''
      if (this.isNotNullOrUndefined(this.commonData.id)) {
        method = 'put'
        formData.id = this.commonData.id
        formData.status = this.commonData.status
      } else {
        method = 'post'
        formData.status = 0
      }

      this.documentValidNameOptions.forEach(item => {
        if (this.commonData.documentValidId === item.dictValue) {
          formData.documentValidId = item.dictKey
        }
      })
      this.documentTypeNameOptions.forEach(item => {
        if (this.commonData.documentTypeId === item.dictValue) {
          formData.documentTypeId = item.dictKey
        }
      })
      const params = {
        ...formData,
        documentTypeName: this.commonData.documentTypeName,
        documentTypeId: formData.documentTypeId,
        documentValidType: this.commonData.documentValidType,
        documentValidId: formData.documentValidId,
        files: this.$refs.modal.fApi.getRule('files').props.fileList.map(item => ({
          id: item.id,
          fileUrlPath: item.filePath,
          originalFileName: item.name
        }))
      }
      if (params.files.length === 0) {
        this.$message.warning('请上传附件')
      } else if (params.files.length > 1) {
        this.$message.warning('最多只能上传一个附件')
      } else {
        this.submitForm(ApiURLs.rules, params, method, {
          // headers: { 'Content-Type': 'multipart/form-data' }
        }).then(res => {
          this.$refs.table.refresh()
          this.$refs.table.clearSelected()
          this.commonInit()
        })
      }
    },
    publishRecord(record, status) {
      const url = `${ApiURLs.rulesStatusUpdate}?id=${record.id}&status=${status}`
      this.submitForm(url, null, 'put').then(res => {
        this.$message.success(`操作成功`)
        this.$refs.table.refresh()
        this.$refs.table.clearSelected()
      })
    },
    showDeleteConfirm(params) {
      const _this = this
      this.$confirm({
        title: '确定执行删除操作?',
        content: ' ',
        okText: '是',
        okType: 'danger',
        cancelText: '否',
        onOk() {
          _this.deleteByIds(ApiURLs.rules, params).then(res => {
            if (res.code === 200) {
              _this.$message.success('删除成功')
              _this.selectedRows = []
              _this.selectedRowKeys = []
              _this.$refs.table.refresh()
            } else {
              _this.$message.error('删除失败')
            }
          })
        },
        onCancel() {
          console.log('Cancel')
        }
      })
    },
    onTimeChange(value, dateString) {}
  },
  created() {
    //下拉框数据的获取
    this.getDict('DOC_VALID').then(({ data, success }) => {
      if (success) {
        this.documentValidNameOptions = data
        this.rules[0].children[0].children[5].options = this.documentValidNameOptions.map(item => ({
          label: item.dictValue,
          value: item.dictKey
        }))
      }
    })
    //文件类别
    this.getDict('DOC_TYPE').then(({ data, success }) => {
      if (success) {
        this.documentTypeNameOptions = data
        this.rules[0].children[0].children[2].options = this.documentTypeNameOptions.map(item => ({
          label: item.dictValue,
          value: item.dictKey
        }))
      }
    })
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-table {
  height: auto;
}

/deep/ .table-card .ant-card-body {
  padding-top: 0;
  padding-bottom: 15px;
}

/deep/ .ant-modal-body {
  span.ant-form-item-children {
    width: 100%;
    display: block;

    .ant-checkbox-group {
      width: 100%;
    }

    .ant-calendar-picker {
      display: block;
      width: 100%;
    }
  }
}

/deep/ .ant-table-body {
  overflow-y: auto !important;
}
/deep/ .table-page-search-wrapper .ant-form-inline .ant-form-item > .ant-form-item-label {
  width: 100px;
}
</style>
