<template>
  <a-select
    show-search
    v-model="personId"
    :placeholder="placeholder"
    style="width: 100%"
    :filter-option="filterOption"
    option-filter-prop="children"
    @change="userChanged"
    :disabled="disabled"
    :deptId="deptId"
    :mode="multiple"
    allowClear
  >
    <a-select-option v-for="d in personList" :key="d.id">
      <template v-if="showDept">
        {{ d.deptName + '-' + d.realName }}
      </template>
      <template v-else>
        {{ d.realName }}
      </template>
    </a-select-option>
  </a-select>
</template>

<script>
import { getUsers } from '@/api/system'
export default {
  name: 'PersonListSelect',
  props: {
    value: {
      type: String,
      default: undefined
    },
    disabled: {
      type: Boolean,
      default: false
    },
    placeholder: {
      type: String,
      default: '请选择姓名'
    },
    deptId: {
      type: String,
      default: null
    },
    multiple: {
      type: String,
      default: 'default'
    },
    showDept: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      personList: [],
      personId: this.value
    }
  },
  watch: {
    value: function (val) {
      this.personId = val
    },
    deptId: function () {
      this.getPersonList()
    }
  },
  methods: {
    filterOption (input, option) {
      return (
        option.componentOptions.children[0].text.toLowerCase().indexOf(input.toLowerCase()) >= 0
      )
    },
    userChanged (id) {
      if(this.multiple !== 'multiple') {
        const person = this.personList.find(item => item.id === id)
        this.$emit('input', id)
        this.$emit('change', { id, person })
      } else {
        this.$emit('input', id)
        const person = this.personList.filter(item => id.includes(item.id))
        this.$emit('change', { id, person })
      }

    },
    getPersonList () {
      getUsers({ deptId: this.deptId }).then(({ data }) => {
        this.personList = data
      })
    }
  },
  created () {
     this.getPersonList()
  }
}
</script>

<style scoped>

</style>
