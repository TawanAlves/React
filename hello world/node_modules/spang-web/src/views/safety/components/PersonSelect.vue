<template>
  <a-form-item :label="labelName">
    <a-select
      show-search
      placeholder="请输入责任人"
      style="width: 100%"
      :default-active-first-option="false"
      :show-arrow="false"
      :filter-option="false"
      :not-found-content="fetching ? undefined : '暂无数据'"
      @search="handleSearch"
      @change="handleSelect"
      v-decorator="[decoratorName,{ rules:[{ required: required, message: '请输入责任人' }]}]"
      :disabled="disabled"
    >
      <a-spin v-if="fetching" slot="notFoundContent" size="small"/>
      <a-select-option v-for="d in searchResult" :key="d.id">
        {{ d.deptName!=undefined?d.name + '--' + d.deptName: d.name }}
      </a-select-option>
    </a-select>
  </a-form-item>
</template>

<script>
import { searchUser } from '@/api/safety'

export default {
  name: 'PersonSelect',
  props: {
    initialModel: {
      type: Object,
      default: () => null
    },
    decoratorName: {
      type: String,
      default: ''
    },
    labelName: {
      type: String,
      default: ''
    },
    disabled: {
      type: Boolean,
      default: false
    },
    required: {
      type: Boolean,
      default: false
    }
  },
  data () {
    this.lastFetchId = 0
    return {
      fetching: false,
      searchResult: []
    }
  },
  mounted () {
        console.log('select mounted+++++++')
    },
    updated () {
        console.log('select updated+++++++')
    },
  created () {
    console.log('select created+++++++')
    // 直接编辑不会触发watch方法，赋值确保组件选中
    if (this.initialModel) {
      this.searchResult.push(this.initialModel)
    }
    this.$watch('initialModel', () => {
      if (this.initialModel) {
        this.searchResult = []
        this.searchResult.push(this.initialModel)
      }
    })
  },
  methods: {
    handleSearch (value) {
      if (value === '') {
        this.searchResult = []
      } else {
        this.lastFetchId += 1
        const fetchId = this.lastFetchId
        this.searchResult = []
        this.fetching = true
        searchUser({ 'realName': value }).then(res => {
          if (fetchId !== this.lastFetchId) {
            // for fetch callback order
            return
          }
          this.searchResult = res.data
          this.fetching = false
        })
      }
    },
    handleSelect (value) {
      console.log('handleChange++++++++' + value)
      Object.assign(this, {
        // value,
        // searchResult: [],
        fetching: false
      })
      this.$emit('change', value)
    }
  }
}
</script>
