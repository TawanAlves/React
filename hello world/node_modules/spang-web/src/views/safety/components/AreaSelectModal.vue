<template>
  <a-modal
    :title="title"
    :width="1000"
    :visible="visible"
    :confirmLoading="loading"
    @ok="confirmSubmit"
    @cancel="closeModal"
    ok-text="确定"
    cancel-text="取消"
    :maskClosable="false"
    :keyboard="false"
  >
    <a-spin :spinning="loading">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :span="8">
              <a-form-item label="单位/部门">
                <department-select v-model="queryParam.deptId" placeholder="单位/部门"></department-select>
              </a-form-item>
            </a-col>
            <a-col :span="8">
              <a-form-item label="区域/位置名称">
                <a-input v-model="queryParam.areaLocation" placeholder="区域/位置名称"  :max-length="32"/>
              </a-form-item>
            </a-col>
            <a-col :md="2">
              <span class="table-page-search-submitButtons">
                <a-button type="primary" @click="researchRecord">查询</a-button>
                <a-button type="second" @click="resetRecord" style="margin-left: 10px">重置</a-button>
              </span>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <s-table
        ref="table"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :row-selection="{ selectedRowKeys: selectedRowKeys, onChange: onSelectChange, type: rowSelectMode }"
        style="margin-top: 10px;"
        showPagination="true"
        :scroll="{ y: 350 }"
        :pagination="pagination"
      >
        <span slot="serial" slot-scope="text, record, index">
          {{ pagination.pageSize * (pagination.current - 1) + index + 1 }}
        </span>
      </s-table>
    </a-spin>
  </a-modal>
</template>

<script>
  import { areaColumns } from '@/views/safety/table'
  import ApiURLs from '@/api/urls'
  import { STable } from '@/components'

  export default {
    name: 'AreaSelectModal',
    components: {
      STable
    },
    props: {
      visible: {
        type: Boolean,
        required: true
      },
      loading: {
        type: Boolean,
        default: () => false
      },
      model: {
        type: Object,
        default: () => null
      },
      title: {
        type: String,
        default: '操作'
      },
      disabled: {
        type: Boolean,
        default: false
      },
      defaultSelect: {
        type: Array,
        default: () => []
      }
    },
    data () {
      return {
        pagination: {
          pageSize: 10,
          current: 1,
          showSizeChanger: true
        },
        rowSelectMode: 'radio',
        typeOptions: [],
        selectedRowKeys: [],
        selectedRows: [],
        queryParam: {
        },
        loadData: (parameter) => {
          const requestParameters = { ...this.queryParam, current: parameter.pageNo, size: parameter.pageSize }
          return this.getList(ApiURLs.areaPageList, requestParameters).then((res) => {
            this.pagination = { ...this.pagination, pageSize: res.data.size, current: res.data.current }
            const data = {}
            data.totalCount = res.data.total
            data.totalPage = res.data.pages
            data.pageNo = res.data.current
            data.pageSize = res.data.size
            data.data = res.data.records
            return data
          })
        }
      }
    },
    watch: {
      defaultSelect: {
        handler: function (val) {
          this.selectedRowKeys = val
        }
      }
    },
    computed: {
      columns: () => (areaColumns.slice(0, areaColumns.length - 2))
    },
    methods: {
      initSelect () {
      },
      onSelectChange (selectedRowKeys, selectedRows) {
        this.selectedRowKeys = selectedRowKeys
        this.selectedRows = selectedRows
      },
      resetRecord () {
        this.queryParam = { }
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      confirmSubmit () {
        this.$emit('ok', this.selectedRows[0])
        this.$emit('update:visible', false)
        this.resetRecord()
      },
      researchRecord () {
        this.$refs.table.refresh(true)
        this.$refs.table.clearSelected()
      },
      closeModal () {
        this.$emit('update:visible', false)
        this.resetRecord()
      }
    },
    created () {
      this.initSelect()
    }
  }
</script>

<style scoped lang="less">
    /deep/ .ant-table {
    height: auto;
  }
</style>
