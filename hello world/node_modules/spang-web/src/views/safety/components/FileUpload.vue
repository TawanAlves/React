<template>
  <div :key="key">
    <a-form-item :label="label">
      <a-upload
        :customRequest="fileUpLoad"
        @change="handleChange">
        <a-button>
          <a-icon type="upload"/>
          点击上传
        </a-button>
      </a-upload>
    </a-form-item>
    <a-form-item v-show="false">
      <a-textarea v-decorator="[docName,{ rules:[{ required: false }]}]"/>
    </a-form-item>
    <a-form-item v-show="false">
      <a-textarea v-decorator="[docUrl,{ rules:[{ required: false }]}]"/>
    </a-form-item>
  </div>
</template>

<script>
import { fileUpLoad } from '@/api/safety'

export default {
  name: 'FileUpload',
  props: {
    label: {
      type: String,
      default: '附件'
    },
    form: {
      type: Object,
      default: null
    },
    docName: {
      type: String,
      default: 'docName'
    },
    docUrl: {
      type: String,
      default: 'docUrl'
    },
    visible: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      key: ''
    }
  },
  watch: {
    visible: {
      handler (val) {
        this.key = val ? Math.random() : ''
      }
    }
  },
  methods: {
    handleChange (info) {
      if (info.file.status !== 'uploading') {
      }
      if (info.file.status === 'done') {
        this.$message.success(`${info.file.name} file uploaded successfully`)
      } else if (info.file.status === 'error') {
        this.$message.error(`${info.file.name} file upload failed.`)
      }
    },
    fileUpLoad (data) {
      const formData = new FormData()
      formData.append('file', data.file)
      fileUpLoad(formData).then(res => {
        const fileInfo = {}
        fileInfo[this.docName] = res.data.originalName
        fileInfo[this.docUrl] = res.data.link
        this.form.setFieldsValue(fileInfo)
        data.onProgress({ percent: 100 })
        data.onSuccess({ success: true })
      })
    }
  }
}
</script>
