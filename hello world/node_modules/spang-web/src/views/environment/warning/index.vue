<template>
  <page-container :title="false">
    <a-card :bordered="false" v-show="!detailKey">
      <div class="table-page-search-wrapper">
        <a-form layout="inline">
          <a-row :gutter="24">
            <a-col :span="4">
              <a-form-item label="所属企业">
                <a-input placeholder="请填写"/>
              </a-form-item>
            </a-col>
            <a-col :span="3">
              <a-form-item label="报警级别">
                <a-select>
                  <tag-select-option v-for="d in selectOptions" :key="d.value">
                    {{ d.text }}
                  </tag-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="3">
              <a-form-item label="报警类型">
                <a-select>
                  <tag-select-option v-for="d in selectOptions" :key="d.value">
                    {{ d.text }}
                  </tag-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="3">
              <a-form-item label="报警子类型">
                <a-select>
                  <tag-select-option v-for="d in selectOptions" :key="d.value">
                    {{ d.text }}
                  </tag-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="3">
              <a-form-item label="处理状态">
                <a-select>
                  <tag-select-option v-for="d in selectOptions" :key="d.value">
                    {{ d.text }}
                  </tag-select-option>
                </a-select>
              </a-form-item>
            </a-col>
            <a-col :span="1">
              <a-button type="link" @click="show">{{ hasShow ? '收起' : '展开' }} </a-button>
            </a-col>
            <a-col :span="1">
              <a-button type="primary" @click="warningResearch">搜索</a-button>
            </a-col>
            <a-col :span="1">
              <a-button type="primary" @click="exportWarning">导出</a-button>
            </a-col>
          </a-row>
          <a-row :gutter="24" v-show="hasShow">
            <a-col :span="6">
              <a-form-item label="选项1">
                <a-input/>
              </a-form-item>
            </a-col>
            <a-col :span="6">
              <a-form-item label="选项2">
                <a-input/>
              </a-form-item>
            </a-col>
          </a-row>
          <a-row>
            <a-col>
              <a-form-item label="批量修改是否有效">
                <a-button-group>
                  <a-button @click="positive" :disabled="!hasSelected">有效</a-button>
                  <a-button @click="negative" :disabled="!hasSelected">无效</a-button>
                </a-button-group>
              </a-form-item>
            </a-col>
          </a-row>
        </a-form>
      </div>
      <s-table
        ref="warningTable"
        size="default"
        :rowKey="record => record.id"
        :columns="columns"
        :data="loadData"
        :alert="false"
        :rowSelection="rowSelection"
        showPagination="false"
      >
        <span slot="effective" slot-scope="text, record">
          <a-switch checked-children="是" un-checked-children="否" :default-checked="text" @change="effectiveChange(record)"/>
        </span>
        <span slot="action" slot-scope="text, record">
          <template>
            <a @click="warningDetail(record)">详情</a>
            <!-- <a-divider type="vertical"/>
            <a @click="warningHistory(record)">历史记录</a> -->
          </template>
        </span>
      </s-table>
      <div>
        <a-row type="flex" justify="center">
          <a-button style="margin-right: 10px" @click="recordAdd">添加沟通记录</a-button>
          <a-button style="margin-right: 10px" @click="eventLoop">事件闭环</a-button>
        </a-row>
      </div>
    </a-card>
    <a-card :bordered="false" v-show="detailKey">
      <a-row type="flex" justify="space-between">
        <a-col :span="1">
          <a-button @click="detailKey = false" size="large" shape="circle" icon="left"></a-button>
        </a-col>
        <a-col :span="22">
          <a-form layout="inline" style="font-weight: bold">
            <a-row>
              <a-col>
                <a-form-item label="">
                  <p style="font-size: 20px;font-weight: bold">{{ detailForm.stype }}
                    <a-tag color="#f50">D级</a-tag>
                    <a-tag color="#108ee9">{{ detailForm.status }}</a-tag></p>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row :gutter="24">
              <a-col :span="6">
                <a-form-item label="报警时间">
                  <p>{{ detailForm.time }}</p>
                </a-form-item>
              </a-col>
              <a-col :span="6">
                <a-form-item label="报警类型">
                  <p>{{ detailForm.type }}</p>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row :gutter="24">
              <a-col :span="6">
                <a-form-item label="报警点位">
                  <p>{{ detailForm.point }}</p>
                </a-form-item>
              </a-col>
              <a-col :span="6">
                <a-form-item label="报警子类型">
                  <p>{{ detailForm.stype }}</p>
                </a-form-item>
              </a-col>
            </a-row>
            <a-row :gutter="24">
              <a-col :span="12">
                <a-form-item label="报警描述">
                  <p>{{ detailForm.description }}</p>
                </a-form-item>
              </a-col>
            </a-row>
            <div v-show="mark">
              <a-row>
                <p>消息推送列表:</p>
              </a-row>
              <a-row v-show="false">
                <s-table
                  ref="warningTable"
                  size="default"
                  :rowKey="record => record.id"
                  :columns="columns"
                  :data="loadData"
                  :alert="false"
                  :rowSelection="rowSelection"
                  showPagination="false"
                >
                  <span slot="effective" slot-scope="text, record">
                    <a-switch checked-children="是" un-checked-children="否" :default-checked="text" @change="effectiveChange(record)"/>
                  </span>
                  <span slot="action" slot-scope="text, record">
                    <template>
                      <a @click="warningDetail(record)">详情</a>
                      <a-divider type="vertical"/>
                      <a @click="warningHistory(record)">历史记录</a>
                    </template>
                  </span>
                </s-table>
              </a-row>
              <a-row>
                <div style="width: 80%">
                  <a-descriptions
                    title=""
                    bordered
                    size="middle"
                    layout="vertical"
                    :column="{ xxl: 6}"
                  >
                    <a-descriptions-item label="类型" :span="1">
                      {{ detailForm.type }}
                    </a-descriptions-item>
                    <a-descriptions-item label="内容" :span="1">
                      {{ detailForm.description }}
                    </a-descriptions-item>
                    <a-descriptions-item label="时间" :span="1">
                      {{ detailForm.time }}
                    </a-descriptions-item>
                    <a-descriptions-item label="人员" :span="1">
                      Data disk type: MongoDB
                      <br />
                      Database version: 3.4
                      <br />
                      Package: dds.mongo.mid
                      <br />
                      Storage space: 10 GB
                      <br />
                      Replication factor: 3
                      <br />
                      Region: East China 1
                    </a-descriptions-item>
                  </a-descriptions>
                </div>
              </a-row>
              <a-row>
                <a-col>
                  <a-form-item label="历史报警">
                    <p>累计报警15次。。。。。。。。。。。。。。。。。。。。。。。。。</p>
                  </a-form-item>
                </a-col>
              </a-row>
            </div>
          </a-form>
        </a-col>
        <a-col>
          <a-button @click="mark=!mark" size="large" shape="circle" :icon="mark?'up':'down'"></a-button>
        </a-col>
      </a-row>
    </a-card>
  </page-container>
</template>

<script>
import TagSelectOption from '@/components/TagSelect/TagSelectOption'
import { STable } from '@/components'
import { warningColumns } from '@/views/environment/table'

const selectOptions = [
  {
    text: 'A级告警',
    value: 'A级告警'
  },
  {
    text: 'B级告警',
    value: 'B级告警'
  },
  {
    text: 'C级告警',
    value: 'C级告警'
  },
  {
    text: 'D级告警',
    value: 'D级告警'
  }
]
const mockData = {
  data: [
    {
      id: '0',
      description: '000000000000000000000000000',
      level: 'C级告警',
      type: '机械故障0',
      stype: '传感器故障0',
      time: '2010-10-21 16:38:00',
      effective: true,
      point: 'spang',
      status: '未处理',
      threshold: '高高报',
      monitor: '20.0'
    },
    {
      id: '1',
      description: '1111111111111111111111111',
      level: 'A级告警',
      type: '机械故障1',
      stype: '传感器故障1',
      time: '2010-10-03 16:38:00',
      effective: true,
      point: 'spang',
      status: '未处理',
      threshold: '高高报',
      monitor: '20.0'
    },
    {
      id: '2',
      description: '2222222222222222222',
      level: 'B级告警',
      type: '机械故障2',
      stype: '传感器故障2',
      time: '2010-10-03 06:38:00',
      effective: true,
      point: 'spang',
      status: '未处理',
      threshold: '高高报',
      monitor: '20.0'
    },
    {
      id: '3',
      description: '333333333333333333333',
      level: 'D级告警',
      type: '机械故障3',
      stype: '传感器故障3',
      time: '2010-10-22 14:18:11',
      effective: true,
      point: 'spang',
      status: '未处理',
      threshold: '高高报',
      monitor: '20.0'
    }
  ]
}

export default {
  name: 'Index',
  components: {
    TagSelectOption,
    STable
  },
  data () {
    return {
      mark: false,
      detailKey: false,
      hasShow: false,
      queryParam: {},
      selectedRowKeys: [],
      selectedRows: [],
      loadData: parameter => {
        return new Promise(resolve => {
          this.$message.success('表格刷新')
          console.log(this.data1)
          resolve(this.data1)
        })
      },
      detailForm: {}
    }
  },
  computed: {
    data1: () => mockData,
    selectOptions: () => selectOptions,
    columns: () => warningColumns,
    hasSelected () {
      return this.selectedRowKeys.length > 0
    },
    rowSelection () {
      return {
        selectedRowKeys: this.selectedRowKeys,
        onChange: this.onSelectChange
      }
    }
  },
  methods: {
    onSelectChange (selectedRowKeys, selectedRows) {
      this.selectedRowKeys = selectedRowKeys
      this.selectedRows = selectedRows
    },
    show () {
      this.hasShow = !this.hasShow
    },
    positive () {
      this.$message.success('有效')
      const ids = this.selectedRows.map((row) => {
        return row.id
      })
      for (const val of mockData.data) {
        if (ids.includes(val.id)) {
          val.effective = false
        }
      }
      this.$refs.warningTable.refresh(true)
    },
    negative () {
      this.$message.success('无效')
    },
    effectiveChange (record) {
      mockData.data[record.id].effective = !mockData.data[record.id].effective
      this.$message.success('状态值为' + `${ record.effective }`)
    },
    warningDetail (record) {
      this.detailKey = true
      this.$message.success('查看详情')
      this.detailForm = { ...record }
    },
    warningHistory (record) {
      this.$message.success('历史记录')
    },
    warningResearch () {
      this.$message.success('查询')
      this.$refs.warningTable.refresh(true)
      this.$refs.warningTable.clearSelected()
    },
    recordAdd () {
      this.$message.success('添加沟通记录')
    },
    eventLoop () {
      this.$message.success('事件闭环')
    }
 }
}
</script>
