<template>
  <div class="main">
    <div class="form-header">
      <!-- <img src="../../../public/icon.png" /> -->
      <span>智慧安监管理平台</span>
    </div>
    <div class="form-body">
      <a-form-model :model="loginForm" ref="ruleForm" :rules="validatorRules" class="form-inline">
        <div class="form-inline-item">
          <div class="form-inline-item-lebel">账号</div>
          <a-form-model-item prop="username">
            <a-input v-model="loginForm.username" placeholder="账号" />
          </a-form-model-item>
        </div>
        <div class="form-inline-item">
          <div class="form-inline-item-lebel">密码</div>
          <a-form-model-item prop="password">
            <a-input type="password" v-model="loginForm.password" placeholder="密码" />
          </a-form-model-item>
        </div>

        <div style="display: flex">
          <div class="form-inline-item">
            <div class="form-inline-item-lebel">验证码</div>
            <a-form-model-item prop="code" style="width: 60%">
              <a-input v-model="loginForm.code" placeholder="验证码" @keyup.enter.native="handleLogin" />
            </a-form-model-item>
            <img :src="loginForm.image" class="login-code-img" @click="refreshCode" />
          </div>
        </div>
      </a-form-model>
      <a-button class="login-button" @click="handleLogin">登录</a-button>
    </div>
  </div>
</template>

<script>
import { mapActions } from 'vuex'
import { timeFix } from '@/utils/util'
import { getImgCaptcha } from '@/api/login'
import md5 from 'md5'


export default {
  data() {
    return {
      loginForm: {
        // 租户ID
        tenantId: '428835',
        // 用户名
        username: '',
        // 密码
        password: '',
        // 验证码的值
        code: '',
        // 验证码的索引
        key: '',
        // 预加载白色背景
        image: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
      },
      validatorRules: {
        username: [{ required: true, message: '请输入账号', trigger: 'blur' }],
        password: [{ required: true, message: '请输入密码', trigger: 'blur' }],
        code: [{ required: true, message: '请输入验证码', trigger: 'blur' }],
      },
    }
  },
  created() {
    this.refreshCode()
  },
  methods: {
    ...mapActions(['LoginByUsername', 'GetInfo']),
    refreshCode() {
      getImgCaptcha().then((res) => {
        this.loginForm.key = res.key
        this.loginForm.image = res.image
      })
    },
    handleLogin() {
      this.$refs.ruleForm.validate((valid) => {
        if (valid) {
          const params = {
            ...this.loginForm,
            password: md5(this.loginForm.password)
          }
          this.LoginByUsername(params)
            .then((res) => this.loginSuccess())
            .catch((err) => this.requestFailed(err))
        } else {
          this.$notification['error']({
            message: '提示',
            description: '请检查输入是否正确',
            duration: 8,
          })
          return false
        }
      })
    },
    loginSuccess(res) {
      this.GetInfo().then(() => {
        this.$router.push({ name: 'index' }, () => {
          this.$notification.success({
            message: '欢迎',
            description: `${timeFix()}，欢迎回来`,
          })
        })
      })
    },
    requestFailed(err) {
      console.log(err)
      this.$notification['error']({
        message: '错误',
        description: ((err.response || {}).data || {}).error_description || '请求出现错误，请稍后再试',
        duration: 4,
      })
      this.refreshCode()
    },
  },
}
</script>

<style lang="less" scoped>
.main {
  width: 100%;
  height: 100%;

  display: flex;
  flex-direction: column;
}
.form-header {
  text-align: center;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 111px;
  margin: 5px 0;
  img {
    width: 31px;
    height: 29px;
    margin-right: 10px;
  }
  span {
    font-size: 24px;
    font-weight: 600;
    color: rgba(0, 0, 0, 0.85);
    line-height: 33px;
    letter-spacing: 1px;
  }
}
.login-code-img {
  margin-left: 18px;
  cursor: pointer;
  width: 99px;
  height: 40px;
  background: #fcfefd;
  border-radius: 2px;
  border: 1px solid #e5e6e6;
}
.form-inline {
  margin: 0 auto;
}
/deep/ .login-button {
  width: 368px;
  height: 40px;
  background: #268de0;
  border-radius: 4px;

  border-radius: 4px;
  border-color: transparent;
  span {
    width: 35px;
    height: 22px;
    font-size: 16px;
    font-weight: 500;
    color: #ffffff;
    line-height: 22px;
    letter-spacing: 1px;
  }
}
.form-body {
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  .form-inline-item {
    display: flex;
    flex-direction: row;
    width: 368px;

    .form-inline-item-lebel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 40px;
      width: 70px;
      background: #ffffff;

      font-size: 16px;
      font-family: PingFang SC;
      font-weight: 400;
      color: #000000;
    }
    .ant-form-item {
      flex: 1;
      .ant-input {
        padding: 0;
        height: 100%;
        font-size: 16px;
        background: transparent; //背景透明
        -webkit-tap-highlight-color: transparent;
      }
      .ant-input:-webkit-autofill,
      .ant-input:-webkit-autofill:hover,
      .ant-input:-webkit-autofill:focus,
      .ant-input:-webkit-autofill:active {
        -webkit-transition-delay: 99999s;
        -webkit-transition: color 99999s ease-out, background-color 99999s ease-out;
      }
    }
  }
  /deep/.ant-form-explain,
  /deep/.ant-form-extra {
    text-align: left;
    margin: 0;
  }
}
/deep/ .ant-input {
  border: none;
  &:focus {
    border: none;
    box-shadow: none;
  }
}
/deep/ .ant-form-item-control {
  /*width: 350px;*/
  height: 40px;
  background: #ffffff;
}
/deep/ .ant-form-item,
/deep/ .ant-form-item-with-help {
  margin-bottom: 32px;
}
</style>
