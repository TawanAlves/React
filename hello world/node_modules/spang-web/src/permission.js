// import { router, createrRouter } from './router'
import router from '@/router'
import store from '@/store'
import NProgress from 'nprogress' // progress bar
import '@/components/NProgress/nprogress.less' // progress bar custom style
import { setDocumentTitle, domTitle } from '@/utils/domUtil'
import { i18nRender } from '@/locales'
import { getToken } from '@/utils/auth'
import { getStore } from '@/utils/store'
import { getInfo } from '@/api/login'
import website from '@/config/website'

NProgress.configure({ showSpinner: false }) // NProgress Configuration
const allowList = ['login'] // no redirect allowList
const defaultRoutePath = '/safety'
const loginRoutePath = '/user/login'
const blankPath = '/blank'
// const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0ZW5hbnRfaWQiOiIyNjUyMDkiLCJ1c2VyX25hbWUiOiJzcGFuZyIsInJlYWxfbmFtZSI6InRlc3QiLCJhdmF0YXIiOiIiLCJhdXRob3JpdGllcyI6WyJhZG1pbiJdLCJjbGllbnRfaWQiOiJzYWJlciIsInJvbGVfbmFtZSI6ImFkbWluIiwibGljZW5zZSI6InBvd2VyZWQgYnkgU1BBTkciLCJwb3N0X2lkIjoiMTMyMTc3Mjc1MzU1NjcwOTM3OCIsInVzZXJfaWQiOiIxMzIxNzc4MTMxNjI3NTE1OTA1Iiwicm9sZV9pZCI6IjEzMjE3NzI2NzkxMzI5NzkyMDEiLCJzY29wZSI6WyJhbGwiXSwibmlja19uYW1lIjoidGVzdCIsIm9hdXRoX2lkIjoiIiwiZXhwIjoxNjA0NjU4NDk2LCJkZXB0X2lkIjoiMTMyMTc3Mjc1MzI3OTg4NTMxNCIsImp0aSI6Ijc3MzI1OWYxLTM4OTYtNDhjMi04OWExLTI0ZTQ5NTE2NGU0ZSIsImFjY291bnQiOiJzcGFuZyJ9.hTy5ZmxhaRTOWdTSaYnep_vtAEvS5aK8f5DDus9d2b8'

router.beforeEach((to, from, next) => {
  NProgress.start() // start progress ba
  // 正则匹配 /safety
  const res = to.path.match(/\/\w*/)
  if (Object.keys(to.query).length > 0 && res[0] === '/safety') {
    if (to.query.access_token !== null) {
      store.commit('SET_TOKEN', to.query.access_token)
      store.commit('SET_MENUID', '1322850060090322946')
      getInfo().then(res => {
        store.commit('SET_INFO', res.data)
      })
    }
    // store.commit('SET_MENUID',from.query.id)
  }
  // console.log('路由拦截', to, to.path)
  // store.commit('SET_TOKEN', mockToken)
  // store.commit('SET_MENUID','1322850060090322946')
  // store.commit('SET_MENUID','1') // mock

  to.meta && (typeof to.meta.title !== 'undefined' && setDocumentTitle(`${i18nRender(to.meta.title)} - ${domTitle}`))

  if (getToken()) {
    if (to.path === loginRoutePath) {
      next({ path: defaultRoutePath })
    } else {
      // store.commit('SET_MENUID', '1322850060090322946')
      // console.log(from, to)
      if (Object.keys(store.getters.addRouters).length === 0) {
        console.log('加载路由')
        const menuId = getStore({ name: 'menuId' })
        store.dispatch('GetInfo').then(() => {
          store.dispatch('GenerateRoutes', { menuId }).then(() => {
            const addRouters = store.getters.addRouters
            router.addRoutes(addRouters)
            store.dispatch('setMenu', { routers: addRouters })
            if (addRouters.find(item => item.path === defaultRoutePath)) {
              const redirect = decodeURIComponent(from.query.redirect || to.path)
              if (to.path === redirect) {
                // set the replace: true so the navigation will not leave a history record
                next({ path: to.path, replace: true })
              } else {
                // 跳转到目的路由
                next({ path: redirect })
              }
            } else { // 没有菜单权限
              next({ path: blankPath, replace: true })
            }
          })
        })
      } else {
        // 跳转到目的路由
        next()
      }
    }
  } else {
    if (allowList.includes(to.name)) {
      // 在免登录名单，直接进入
      next()
    } else {
      next({ path: loginRoutePath })
      NProgress.done()
    }
  }
})

router.afterEach(() => {
  NProgress.done() // finish progress bar
})
