<template>
  <div class="upload-custom">
    <a-button :type="variant" :class="customClass" @click="click">
      <slot name="default"></slot>
    </a-button>
    <input
      class="uploader-file"
      type="file"
      ref="input"
      :name="name"
      :multiple="multiple"
      :accept="accept"
      @change="handleChange"/>
    <ul>
      <li v-for="(item, index) in postFiles" :key="item.filePath ? item.filePath + index : item.name + index">
        <a @click="handleDownload(item)">{{ item.name || item.fileName }}</a>
      </li>
    </ul>

  </div>
</template>

<script>
  import { downloadFile } from '@/api/safety'
  export default {
    name: 'UploadButton',
    props: {
      variant: {
        type: String,
        default: 'default',
        required: false
      },
      accept: {
        type: String,
        default: '',
        required: false
      },
      multiple: {
        type: Boolean,
        default: false,
        required: false
      },
      customClass: {
        type: String,
        default: '',
        required: false
      },
      name: {
        type: String,
        default: '',
        required: false
      },
      limit: {
        type: Number,
        required: false,
        default: 100
      },
      initFiles: {
        type: Array,
        default: () => [],
        required: true
      }
    },
    data () {
      return {
        postFiles: this.initFiles
      }
    },
    watch: {
      initFiles: function (val) {
        this.postFiles = val
      }
    },
    methods: {
      handleChange (event) {
        const files = event.target.files
        if (!files) return
        let postFiles = Array.prototype.slice.call(files)
        if (this.limit && files.length > this.limit) {
          postFiles = postFiles.slice(0, this.limit)
        }

        this.postFiles = [...this.postFiles, ...postFiles]
        if (postFiles.length === 0) { return }
        this.$emit('upload', this.postFiles)
      },
      click () {
        this.$refs.input.value = ''
        this.$refs.input.click()
      },
      handleDownload (item) {
        if (item.filePath) {
          downloadFile(item.filePath, item.fileName)
        } else {
          const aLink = document.createElement('a')
          const fileName = item.name
          aLink.href = URL.createObjectURL(item)
          aLink.setAttribute('download', fileName) // 设置下载文件名称
          document.body.appendChild(aLink)
          aLink.click()
          URL.revokeObjectURL(aLink.href)
          document.body.removeChild(aLink)
        }
      }
    }
  }
</script>

<style scoped lang="less">
.upload-custom {
  display: inline-block;
  text-align: center;
  cursor: pointer;
  outline: none;
  .uploader-file {
    width: auto;
    display: none;
  }
}

</style>
