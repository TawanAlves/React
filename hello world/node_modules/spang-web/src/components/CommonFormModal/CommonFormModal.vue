<template>
  <a-modal
    :title="modalTitle"
    :visible="visible"
    :confirmLoading="loading"
    :maskClosable="false"
    @ok="saveForm"
    @cancel="closeForm"
    ok-text="确定"
    cancel-text="取消"
    :width="width"
    :keyboard="false"
    :destroyOnClose="destroyOnClose"
  >
    <a-spin :spinning="loading">
      <form-create v-model="fApi" :rule="rule" :option="option" :value="form" />
    </a-spin>
    <template slot="footer">
      <slot name="footer" v-if="customFooter"></slot>
      <a-button @click="closeForm" v-if="disabled && !customFooter">取消</a-button>
    </template>
  </a-modal>
</template>

<script>
import cloneDeep from 'lodash.clonedeep'
export default {
  name: 'ContractorModalNew',
  props: {
    /**
     * 模态框默认是否显示
     */
    visible: {
      type: Boolean,
      required: true
    },
    /**
     * 模态框内容加载状态
     */
    loading: {
      type: Boolean,
      default: () => false
    },
    /**
     * 模态框标题
     */
    modalTitle: {
      type: String,
      default: '操作'
    },
    /**
     * 模态框宽度
     */
    width: {
      type: String,
      default: '520px'
    },
    /**
     * 表单配置规则
     */
    rule: {
      type: Array,
      required: true,
      default: () => []
    },
    /**
     * 表单默认值
     */
    model: {
      type: Object,
      default: () => null
    },
    /**
     * 表单禁用状态
     */
    disabled: {
      type: Boolean,
      default: false
    },
    /**
     * 全局配置组件布局
     */
    wrap: {
      type: Object,
      default: () => {
        return {
          labelCol: { span: 6 },
          wrapperCol: { span: 17 }
        }
      }
    },
    /**
     * 是否自定义footer
     */
    customFooter: {
      type: Boolean,
      default: false
    },
    /**
     * 自定义表单创建成功后的回调事件
     */
    customCallback: {
      type: Function,
      default: () => null
    },
    /**
     * 关闭modal是否销毁子元素
     */
    destroyOnClose: {
      type: Boolean,
      default: false
    }
  },
  data () {
    return {
      fApi: {},
      option: {
        submitBtn: false,
        resetBtn: false,
        wrap: this.wrap,
        mounted: () => {
          this.fApi.disabled(this.disabled)
          this.fApi.clearValidateState()
          this.form = cloneDeep(this.model)
          this.customCallback && this.customCallback(this.fApi)
        }
      },
      form: cloneDeep(this.model)
    }
  },
  watch: {
    model: function (val) {
      this.form = cloneDeep(val)
      if (this.fApi.clearValidateState) {
        this.fApi.clearValidateState()
      }
    },
    disabled: function (disabled) {
      if (this.fApi.disabled) {
        this.fApi.disabled(disabled)
        this.customCallback && this.customCallback(this.fApi)
      }
    },
    rule: {
      handler: function (rules) {
        if (this.fApi.updateRule) {
          this.fApi.updateRule(rules)
        }
      },
      deep: true
    }
  },
  methods: {
    saveForm () {
      this.fApi.submit((formData, fApi) => {
        this.$emit('ok', { formData: formData })
      })
    },
    closeForm () {
      this.fApi.resetFields()
      this.$emit('update:visible', false)
    }
  }
}
</script>
<style lang="less" scoped>
/deep/ .ant-modal-body {
  max-height: 600px;
  overflow-y: auto;
}
</style>
