<template>
  <div>
    <a-dropdown v-if="currentUser && currentUser.name" placement="bottomRight">
      <span class="ant-pro-account-avatar">
        <a-avatar
          size="small"
          src="https://gw.alipayobjects.com/zos/antfincdn/XAosXuNZyF/BiazfanxmamNRoxxVxka.png"
          class="antd-pro-global-header-index-avatar"
        />
        <span>{{ currentUser.name }}</span>
      </span>
      <template v-slot:overlay>
        <a-menu class="ant-pro-drop-down menu" :selected-keys="[]">
          <a-menu-item key="center" @click="handleToCenter">
            <a-icon type="user" />个人中心
          </a-menu-item>
          <a-menu-item key="settings" @click="handleToSettings">
            <a-icon type="lock" />密码修改
          </a-menu-item>
          <a-menu-divider/>
          <template v-if="userInfo.roleCode.split(',').indexOf('administrator') > -1">
            <a-menu-item key="logout" @click="handleToManageSystem">
              <a-icon type="setting" />权限设置
            </a-menu-item>
            <a-menu-divider/>
          </template>
          <a-menu-item key="logout" @click="handleLogout">
            <a-icon type="logout" />退出登录
          </a-menu-item>
        </a-menu>
      </template>
    </a-dropdown>
    <span v-else>
      <a-spin size="small" :style="{ marginLeft: 8, marginRight: 8 }" />
    </span>
    <a-modal v-model="visibleUser" title="密码修改" width="900px" @ok="handleOk(form)">
      <a-form-model
        :model="form"
        ref="ruleForm"
        :rules="validatorRules"
        :label-col="labelCol"
        :wrapper-col="wrapperCol"
      >
        <a-form-model-item label="登录账号">
          <a-input v-model="form.user" disabled="true" />
        </a-form-model-item>
        <a-form-model-item label="请录入原始密码" ref="oldPassword" prop="oldPassword">
          <a-input
            v-model="form.oldPassword"
            type="password"
            placeholder="请录入原始密码"
            @blur="
              () => {
                $refs.oldPassword.onFieldBlur();
              }
            "
          >
            <a-icon slot="prefix" type="lock" style="color:rgba(0,0,0,.25)" />
          </a-input>
        </a-form-model-item>
        <!-- <a-form-model-item label="请输入验证码">
          <a-input v-model="form.name" placeholder='请输入验证码'/>
          <img :src="form.image" class="login-code-img" @click="refreshCode" />
        </a-form-model-item>-->
        <a-form-model-item label="请录入新密码" ref="newPassword" prop="newPassword">
          <a-input
            v-model="form.newPassword"
            type="password"
            placeholder="请录入新密码"
            @blur="
              () => {
                $refs.newPassword.onFieldBlur();
              }
            "
          >
            <a-icon slot="prefix" type="lock" style="color:rgba(0,0,0,.25)" />
          </a-input>
        </a-form-model-item>
        <a-form-model-item label="请再次录入新密码" ref="newPassword1" prop="newPassword1">
          <a-input
            v-model="form.newPassword1"
            type="password"
            placeholder="请再次录入新密码"
            @blur="
              () => {
                $refs.newPassword1.onFieldBlur();
              }
            "
          >
            <a-icon slot="prefix" type="lock" style="color:rgba(0,0,0,.25)" />
          </a-input>
        </a-form-model-item>
        <div style="color:red;margin-top:20px;">
          <span>新录入的密码必须至少8位，至少包含大写字母、小写字母、数字、特殊字符</span>
        </div>
      </a-form-model>
    </a-modal>
  </div>
</template>

<script>
import { Modal } from 'ant-design-vue'
import { getStore } from '@/utils/store'
// import { getImgCaptcha } from '@/api/login'
import md5 from 'md5'
import { getToken } from '@/utils/auth'

export default {
  name: 'AvatarDropdown',
  props: {
    currentUser: {
      type: Object,
      default: () => null
    },
    menu: {
      type: Boolean,
      default: true
    }
  },
  data() {
    let checkNewPassword = (rule, value, callback) => {
      var pwdRegex = new RegExp('(?=.*[0-9])(?=.*[A-Z])(?=.*[a-z])(?=.*[^a-zA-Z0-9]).{8,32}')
      if (value === '') {
        callback(new Error('请录入新密码'))
      }
      else if (value.length < 8) {
        callback(new Error('密码至少8位'))
      } else if (!pwdRegex.test(value)) {
        callback(new Error('您的密码复杂度太低（密码中必须包含大小写字母、数字、特殊字符）！'))
      } else if (value.length > 32) {
        callback(new Error('密码至多32位'))
      }
      else {
        callback()
      }
    }
    let checkNewPassword1 = (rule, value, callback) => {
      if (value === '') {
        callback(new Error('请再次录入新密码'))
      } else if (value !== this.form.newPassword) {
        callback(new Error('两次密码输入的不一致'))
      } else {
        callback()
      }
    }
    return {
      userInfo: getStore({ name: 'info' }),
      visibleUser: false,
      labelCol: { span: 4 },
      wrapperCol: { span: 14 },
      form: {
        user: '',
        oldPassword: '',
        newPassword: '',
        newPassword1: ''
      },
      validatorRules: {
        oldPassword: [{ required: true, message: '请录入原始密码', trigger: 'blur' }],
        newPassword: [{ required: true, validator: checkNewPassword, trigger: 'blur' }],
        newPassword1: [{ required: true, validator: checkNewPassword1, trigger: 'blur' }]
      }
    }
  },
  created() {},
  mounted() {},
  watch: {
    // 去掉表单验证信息二次打开残留
    visibleUser(val, newVal) {
      if (val) {
        try {
          this.$refs['ruleForm'].resetFields() // 重置编辑表单
        } catch (e) {}
      }
    }
  },
  methods: {
    // refreshCode() {
    //   getImgCaptcha().then(res => {
    //     this.form.image = res.image
    //   })
    // },
    handleToCenter() {
      this.$router.push({ path: '' })
    },
    handleToSettings() {
      this.visibleUser = true
      this.form = {
        user: this.userInfo.account,
        oldPassword: '',
        newPassword: '',
        newPassword1: ''
      }
      console.log(this.form)
    },
    handleOk(data) {
      this.$refs.ruleForm.validate(valid => {
        if (valid) {
          this.axios
            .post(
              '/spang-system/update-password?oldPassword=' +
                md5(this.form.oldPassword) +
                '&newPassword=' +
                md5(this.form.newPassword) +
                '&newPassword1=' +
                md5(this.form.newPassword1)
            )
            .then(rs => {
              if (rs.code === 200) {
                this.$message.success('密码修改成功')
                this.visibleUser = false
              }
            })
            .catch(err => {
              this.$message.error('原密码不正确')
            })
        } else {
          return false
        }
      })
    },
    handleLogout(e) {
      Modal.confirm({
        // title: this.$t('layouts.usermenu.dialog.title'),
        // content: this.$t('layouts.usermenu.dialog.content'),
        content: '是否退出当前账户？',
        okText: '确定',
        okType: 'danger',
        cancelText: '取消',
        onOk: () => {
          // return new Promise((resolve, reject) => {
          //   setTimeout(Math.random() > 0.5 ? resolve : reject, 1500)
          // }).catch(() => console.log('Oops errors!'))
          return this.$store
            .dispatch('Logout')
            .then(res => {
              console.log('==================账号注销成功======================', res)
              // window.location.href = website.loginPath
              // this.$router.replace({ path: '/user/login' })
              window.location.reload()
            })
            .catch(() => {
              console.log('==================注销账号异常======================')
            })
        },
        onCancel() {}
      })
    },
    handleToManageSystem () {
      window.location.href = `http://${location.hostname}:${process.env.VUE_APP_PLATFORM_PORT}?access_token=${getToken()}`
    }
  }
}
</script>

<style lang="less" scoped>
.ant-pro-drop-down {
  /deep/ .action {
    margin-right: 108px;
  }
  /deep/ .ant-dropdown-menu-item {
    min-width: 120px;
  }
}
/deep/.ant-dropdown {
  top: 64px!important;
  color: #f5222d;
}
</style>
